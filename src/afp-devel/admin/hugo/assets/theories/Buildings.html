<div id="Prelim">
<div class="head">
<h1>Theory Prelim</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Preliminaries›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we establish some basic facts about natural numbers, logic, sets, functions and
  relations, lists, and orderings and posets, that are either not available in the HOL library or
  are in a form not suitable for our purposes.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Prelim
<span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Set_Algebras.html">HOL-Library.Set_Algebras</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">declare</span></span> image_cong_simp <span class="main">[</span><span class="operator">cong</span> <span class="quasi_keyword">del</span><span class="main">]</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Natural numbers›</span></span>

<span class="keyword1" id="Prelim-nat_cases_2Suc"><span class="command">lemma</span></span> nat_cases_2Suc <span class="main">[</span><span class="operator">case_names</span> 0 1 SucSuc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>      0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>          1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     SucSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> 1 SucSuc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 0<span class="main">)</span>

<span class="keyword1" id="Prelim-nat_even_induct"><span class="command">lemma</span></span> nat_even_induct <span class="main">[</span><span class="operator">case_names</span> _ 0 SucSuc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   even<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>          0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     SucSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> even <span class="bound">m</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> evenE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Prelim-nat_induct_step2"><span class="command">lemma</span></span> nat_induct_step2 <span class="main">[</span><span class="operator">case_names</span> 0 1 SucSuc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>      0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>          1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     SucSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="free">P</span> <span class="bound">m</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> evenE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 0 SucSuc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> oddE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">k</span><span class="main">+</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> 1 SucSuc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Logic›</span></span>

<span class="keyword1" id="Prelim-ex1_unique"><span class="command">lemma</span></span> ex1_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">=</span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Prelim-not_the1"><span class="command">lemma</span></span> not_the1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> the1_equality<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Prelim-two_cases"><span class="command">lemma</span></span> two_cases <span class="main">[</span><span class="operator">case_names</span> both one other neither<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> both   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     one    <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     other  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     neither<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span><span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sets›</span></span>

<span class="keyword1" id="Prelim-bex1_equality"><span class="command">lemma</span></span> bex1_equality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∃!</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="free">x</span><span class="main">;</span> <span class="free">y</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">P</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Prelim-prod_ballI"><span class="command">lemma</span></span> prod_ballI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> seteqI <span class="main">=</span> set_eqI<span class="main">[</span><span class="operator">OF</span> iffI<span class="main">]</span>

<span class="keyword1" id="Prelim-set_decomp_subset"><span class="command">lemma</span></span> set_decomp_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">U</span> <span class="main">=</span> <span class="free">A</span><span class="main">∪</span><span class="free">B</span><span class="main">;</span> <span class="free">A</span><span class="main">⊆</span><span class="free">X</span><span class="main">;</span> <span class="free">B</span><span class="main">⊆</span><span class="free">Y</span><span class="main">;</span> <span class="free">X</span><span class="main">⊆</span><span class="free">U</span><span class="main">;</span> <span class="free">X</span><span class="main">∩</span><span class="free">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-insert_subset_equality"><span class="command">lemma</span></span> insert_subset_equality<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">∉</span><span class="free">A</span><span class="main">;</span> <span class="free">a</span><span class="main">∉</span><span class="free">B</span><span class="main">;</span> insert <span class="free">a</span> <span class="free">A</span> <span class="main">=</span> insert <span class="free">a</span> <span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-insert_compare_element"><span class="command">lemma</span></span> insert_compare_element<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∉</span><span class="free">A</span> <span class="main">⟹</span> insert <span class="free">b</span> <span class="free">A</span> <span class="main">=</span> insert <span class="free">a</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">=</span><span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-card1"><span class="command">lemma</span></span> card1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">A</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_ge_0_finite<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> card_subset_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-singleton_pow"><span class="command">lemma</span></span> singleton_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">∈</span>Pow <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Pow_mono Pow_top <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">separated_by</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">separated_by</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">A</span> <span class="bound">B</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">=</span><span class="main">{</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∈</span><span class="bound">A</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">∈</span><span class="bound">B</span>"</span></span>

<span class="keyword1" id="Prelim-separated_byI"><span class="command">lemma</span></span> separated_byI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟹</span> separated_by <span class="main">{</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">}</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-separated_by_disjoint"><span class="command">lemma</span></span> separated_by_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> separated_by <span class="main">{</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">}</span> <span class="free">x</span> <span class="free">y</span><span class="main">;</span> <span class="free">A</span><span class="main">∩</span><span class="free">B</span><span class="main">=</span><span class="main">{}</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-separated_by_in_other"><span class="command">lemma</span></span> separated_by_in_other<span class="main">:</span> <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">}</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∉</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">B</span> <span class="main">∧</span> <span class="free">y</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-separated_by_not_empty"><span class="command">lemma</span></span> separated_by_not_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"separated_by <span class="free">w</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-not_self_separated_by_disjoint"><span class="command">lemma</span></span> not_self_separated_by_disjoint<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∩</span><span class="free">B</span><span class="main">=</span><span class="main">{}</span> <span class="main">⟹</span> <span class="main">¬</span> separated_by <span class="main">{</span><span class="free">A</span><span class="main">,</span><span class="free">B</span><span class="main">}</span> <span class="free">x</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functions and relations›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous›</span></span>

<span class="keyword1" id="Prelim-cong_let"><span class="command">lemma</span></span> cong_let<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">y</span> <span class="keyword1">in</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-sym_sym"><span class="command">lemma</span></span> sym_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span><span class="free">A</span><span class="main">×</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI<span class="main">)</span>

<span class="keyword1" id="Prelim-trans_sym"><span class="command">lemma</span></span> trans_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span><span class="free">A</span><span class="main">×</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> transI<span class="main">)</span>

<span class="keyword1" id="Prelim-map_prod_sym"><span class="command">lemma</span></span> map_prod_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="free">A</span> <span class="main">⟹</span> sym <span class="main">(</span>map_prod <span class="free">f</span> <span class="free">f</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> symD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> map_prod_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> symI<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">restrict1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict1</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-restrict1_image"><span class="command">lemma</span></span> restrict1_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">⊆</span><span class="free">A</span> <span class="main">⟹</span> restrict1 <span class="free">f</span> <span class="free">A</span> <span class="main">`</span> <span class="free">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Equality of functions restricted to a set›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">fun_eq_on</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">a</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-fun_eq_onI"><span class="command">lemma</span></span> fun_eq_onI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">=</span> <span class="free">g</span> <span class="bound">a</span><span class="main">)</span> <span class="main">⟹</span> fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-fun_eq_onD"><span class="command">lemma</span></span> fun_eq_onD<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="main">=</span> <span class="free">g</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-fun_eq_on_UNIV"><span class="command">lemma</span></span> fun_eq_on_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fun_eq_on <span class="free">f</span> <span class="free">g</span> UNIV<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span><span class="main">=</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-fun_eq_on_subset"><span class="command">lemma</span></span> fun_eq_on_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">⊆</span><span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-fun_eq_on_sym"><span class="command">lemma</span></span> fun_eq_on_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">g</span> <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_onD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_onI<span class="main">)</span>

<span class="keyword1" id="Prelim-fun_eq_on_trans"><span class="command">lemma</span></span> fun_eq_on_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">g</span> <span class="free">h</span> <span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">f</span> <span class="free">h</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_onD fun_eq_onD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_onI<span class="main">)</span>

<span class="keyword1" id="Prelim-fun_eq_on_cong"><span class="command">lemma</span></span> fun_eq_on_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">h</span> <span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">g</span> <span class="free">h</span> <span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_trans fun_eq_on_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-fun_eq_on_im"><span class="command">lemma</span></span> fun_eq_on_im <span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">⊆</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">B</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_onD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Prelim-fun_eq_on_subset_and_diff_imp_eq_on"><span class="command">lemma</span></span> fun_eq_on_subset_and_diff_imp_eq_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">⊆</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="free">B</span><span class="main">-</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fun_eq_onD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> fun_eq_onD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>    
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-fun_eq_on_set_and_comp_imp_eq"><span class="command">lemma</span></span> fun_eq_on_set_and_comp_imp_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="main">-</span><span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_subset_and_diff_imp_eq_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted">UNIV</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Compl_eq_Diff_UNIV fun_eq_on_UNIV<span class="main">)</span>

<span class="keyword1" id="Prelim-fun_eq_on_bij_betw"><span class="command">lemma</span></span> fun_eq_on_bij_betw<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span> <span class="main">=</span> bij_betw <span class="free">g</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_cong <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-fun_eq_on_restrict1"><span class="command">lemma</span></span> fun_eq_on_restrict1<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_onI<span class="main">)</span> 

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fixespointwise</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> fun_eq_on <span class="free"><span class="bound"><span class="entity">f</span></span></span> id <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> fixespointwiseI           <span class="main">=</span> fun_eq_onI       <span class="main">[</span><span class="operator">of</span>   <span class="main">_</span> <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fixespointwiseD           <span class="main">=</span> fun_eq_onD       <span class="main">[</span><span class="operator">of</span>     <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fixespointwise_cong       <span class="main">=</span> fun_eq_on_trans  <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fixespointwise_subset     <span class="main">=</span> fun_eq_on_subset <span class="main">[</span><span class="operator">of</span>     <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> fixespointwise2_imp_eq_on <span class="main">=</span> fun_eq_on_cong   <span class="main">[</span><span class="operator">of</span>     <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> fixespointwise_subset_and_diff_imp_eq_on <span class="main">=</span>
  fun_eq_on_subset_and_diff_imp_eq_on<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">id</span><span class="main">]</span>

<span class="keyword1" id="Prelim-id_fixespointwise"><span class="command">lemma</span></span> id_fixespointwise<span class="main">:</span> <span class="quoted"><span class="quoted">"fixespointwise id <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-fixespointwise_im"><span class="command">lemma</span></span> fixespointwise_im<span class="main">:</span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">B</span><span class="main">⊆</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_on_im<span class="main">)</span>

<span class="keyword1" id="Prelim-fixespointwise_comp"><span class="command">lemma</span></span> fixespointwise_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> fixespointwise <span class="free">g</span> <span class="free">A</span> <span class="main">⟹</span> fixespointwise <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> fun_eq_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-fixespointwise_insert"><span class="command">lemma</span></span> fixespointwise_insert<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> insert <span class="free">a</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="main">(</span>insert <span class="free">a</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>2<span class="main">)</span> insert_compare_element<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">a</span>"</span></span><span class="main">]</span>
          fixespointwiseD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> fixespointwise_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">A</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>

<span class="keyword1" id="Prelim-fixespointwise_restrict1"><span class="command">lemma</span></span> fixespointwise_restrict1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> fixespointwise <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">B</span><span class="main">)</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fixespointwiseD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>

<span class="keyword1" id="Prelim-fold_fixespointwise"><span class="command">lemma</span></span> fold_fixespointwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> fixespointwise <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="free">A</span> <span class="main">⟹</span> fixespointwise <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> id_fixespointwise subst<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="free">A</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> fixespointwise_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"fold <span class="free">f</span> <span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="free">f</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> fixespointwise <span class="bound">f</span> <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-funpower_fixespointwise"><span class="command">lemma</span></span> funpower_fixespointwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="free">n</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> id_fixespointwise subst<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fixespointwise_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">∘</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">^^</span><span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subst<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> fixespointwise <span class="bound">f</span> <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Injectivity, surjectivity, bijectivity, and inverses›</span></span>

<span class="keyword1" id="Prelim-inj_on_to_singleton"><span class="command">lemma</span></span> inj_on_to_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">.</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> inj_inj_on <span class="main">=</span> subset_inj_on<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">UNIV</span><span class="main">,</span> <span class="operator">OF</span> _ subset_UNIV<span class="main">]</span>

<span class="keyword1" id="Prelim-inj_on_eq_image'"><span class="command">lemma</span></span> inj_on_eq_image'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inj_on <span class="free">f</span> <span class="free">A</span><span class="main">;</span> <span class="free">X</span><span class="main">⊆</span><span class="free">A</span><span class="main">;</span> <span class="free">Y</span><span class="main">⊆</span><span class="free">A</span><span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="free">X</span><span class="main">⊆</span><span class="free">f</span><span class="main">`</span><span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span><span class="main">⊆</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-inj_on_eq_image"><span class="command">lemma</span></span> inj_on_eq_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> inj_on <span class="free">f</span> <span class="free">A</span><span class="main">;</span> <span class="free">X</span><span class="main">⊆</span><span class="free">A</span><span class="main">;</span> <span class="free">Y</span><span class="main">⊆</span><span class="free">A</span><span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="free">X</span><span class="main">=</span><span class="free">f</span><span class="main">`</span><span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span><span class="main">=</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_eq_image'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span> inj_on_eq_image'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> inj_eq_image <span class="main">=</span> inj_on_eq_image<span class="main">[</span><span class="operator">OF</span> _ subset_UNIV subset_UNIV<span class="main">]</span>

<span class="keyword1" id="Prelim-induced_pow_fun_inj_on"><span class="command">lemma</span></span> induced_pow_fun_inj_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   inj_onD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> inj_onI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">blast</span>

<span class="keyword1" id="Prelim-inj_on_minus_set"><span class="command">lemma</span></span> inj_on_minus_set<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(-)</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onI<span class="main">)</span>

<span class="keyword1" id="Prelim-induced_pow_fun_surj"><span class="command">lemma</span></span> induced_pow_fun_surj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">=</span> Pow <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">X</span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> Pow <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∈</span> <span class="skolem">Y</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span><span class="main">∈</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-bij_betw_f_the_inv_into_f"><span class="command">lemma</span></span> bij_betw_f_the_inv_into_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
<span class="comment1">― ‹an equivalent lemma appears in the HOL library, but this version avoids the double
  <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> bij_betw<span class="antiquote">}</span></span> premises›</span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> f_the_inv_into_f<span class="main">)</span>

<span class="keyword1" id="Prelim-bij_betw_the_inv_into_onto"><span class="command">lemma</span></span> bij_betw_the_inv_into_onto<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span> <span class="main">⟹</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">`</span> <span class="free">B</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Prelim-bij_betw_imp_bij_betw_Pow"><span class="command">lemma</span></span> bij_betw_imp_bij_betw_Pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">x</span><span class="main">∈</span>Pow <span class="free">A</span><span class="main">;</span> <span class="bound">y</span><span class="main">∈</span>Pow <span class="free">A</span><span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="bound">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="bound">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">=</span><span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> bij_betw_imp_inj_on<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> Pow <span class="free">A</span> <span class="main">=</span> Pow <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> Pow <span class="free">A</span> <span class="main">⊆</span> Pow <span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_surj_on<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> Pow <span class="free">A</span> <span class="main">⊇</span> Pow <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>Pow <span class="free">B</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bij_betw_f_the_inv_into_f<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">y</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> bij_betw_the_inv_into_onto <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> Pow <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-comps_fixpointwise_imp_bij_betw"><span class="command">lemma</span></span> comps_fixpointwise_imp_bij_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">X</span><span class="main">⊆</span><span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">Y</span><span class="main">⊆</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">f</span><span class="main">∘</span><span class="free">g</span><span class="main">)</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">X</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">x</span><span class="main">∈</span><span class="free">X</span><span class="main">;</span> <span class="skolem">y</span><span class="main">∈</span><span class="free">X</span><span class="main">;</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fixespointwiseD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> fixespointwiseD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fixespointwiseD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-set_permutation_bij_restrict1"><span class="command">lemma</span></span> set_permutation_bij_restrict1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bijI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bij_f<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">A</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> iffD1<span class="main">[</span><span class="operator">OF</span> bij_betw_def<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict1 <span class="free">f</span> <span class="free">A</span> <span class="skolem">x</span> <span class="main">=</span> restrict1 <span class="free">f</span> <span class="free">A</span> <span class="skolem">y</span> <span class="main">⟹</span> <span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD bij_f <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> surjI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≡</span> restrict1 <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"restrict1 <span class="free">f</span> <span class="free">A</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_inv_into_into<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> bij_f f_the_inv_into_f<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-set_permutation_the_inv_restrict1"><span class="command">lemma</span></span> set_permutation_the_inv_restrict1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_inv <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">=</span> restrict1 <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> the_inv_into_f_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>restrict1 <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_is_inj set_permutation_bij_restrict1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"restrict1 <span class="free">f</span> <span class="free">A</span> <span class="main">(</span>restrict1 <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">A</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> the_inv_into_into f_the_inv_into_f<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-the_inv_into_the_inv_into"><span class="command">lemma</span></span> the_inv_into_the_inv_into<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> the_inv_into <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">A</span><span class="main">)</span> <span class="main">(</span>the_inv_into <span class="free">A</span> <span class="free">f</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_the_inv_into <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_inv_into_f_eq imageI<span class="main">)</span>

<span class="keyword1" id="Prelim-the_inv_into_f_im_f_im"><span class="command">lemma</span></span> the_inv_into_f_im_f_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⊆</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>2<span class="main">)</span> the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">force</span>

<span class="keyword1" id="Prelim-f_im_the_inv_into_f_im"><span class="command">lemma</span></span> f_im_the_inv_into_f_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">⊆</span><span class="free">f</span><span class="main">`</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> the_inv_into <span class="free">A</span> <span class="free">f</span> <span class="main">`</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>2<span class="main">)</span> f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">force</span>

<span class="keyword1" id="Prelim-the_inv_leftinv"><span class="command">lemma</span></span> the_inv_leftinv<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span> <span class="main">⟹</span> the_inv <span class="free">f</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> the_inv_f_f <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Induced functions on sets of sets and lists of sets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we create convenience abbreviations for distributing a function over a set of sets and over
  a list of sets.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">setsetmapim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'b</span> set set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊢</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⊢</span></span><span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">(`)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">setlistmapim</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'b</span> set list"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊨</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main"><span class="free">⊨</span></span><span class="free"><span class="bound"><span class="entity">Xs</span></span></span> <span class="main">≡</span> map <span class="main">(</span><span class="main">(`)</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Xs</span></span></span>"</span></span>

<span class="keyword1" id="Prelim-setsetmapim_comp"><span class="command">lemma</span></span> setsetmapim_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">∘</span><span class="free">g</span><span class="main">)</span><span class="main">⊢</span><span class="free">A</span> <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span><span class="main">(</span><span class="free">g</span><span class="main">⊢</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>

<span class="keyword1" id="Prelim-setlistmapim_comp"><span class="command">lemma</span></span> setlistmapim_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">∘</span><span class="free">g</span><span class="main">)</span><span class="main">⊨</span><span class="free">xs</span> <span class="main">=</span> <span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="free">g</span><span class="main">⊨</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-setsetmapim_cong_subset"><span class="command">lemma</span></span> setsetmapim_cong_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">g</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">⊆</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">⊢</span><span class="free">B</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span><span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span><span class="free">B</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fun_eq_on_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-setsetmapim_cong"><span class="command">lemma</span></span> setsetmapim_cong<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">g</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">⊆</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">⊢</span><span class="free">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   setsetmapim_cong_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
          setsetmapim_cong_subset<span class="main">[</span><span class="operator">OF</span> fun_eq_on_sym<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fast</span>

<span class="keyword1" id="Prelim-setsetmapim_restrict1"><span class="command">lemma</span></span> setsetmapim_restrict1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">⊆</span><span class="free">A</span> <span class="main">⟹</span> restrict1 <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> setsetmapim_cong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> fun_eq_on_restrict1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-setsetmapim_the_inv_into"><span class="command">lemma</span></span> setsetmapim_the_inv_into<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> y<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y<span class="main">(</span>2<span class="main">)</span> the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊢</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Induced functions on quotients›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we construct the induced function on a quotient for an inducing function that respects the
  relation that defines the quotient.
›</span></span>

<span class="keyword1" id="Prelim-respects_imp_unique_image_rel"><span class="command">lemma</span></span> respects_imp_unique_image_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">respects</span> <span class="free">r</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="free">r</span><span class="main">``</span><span class="main">{</span><span class="free">a</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> congruentD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-ex1_class_image"><span class="command">lemma</span></span> ex1_class_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"refl_on <span class="free">A</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">respects</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span><span class="free">A</span><span class="main">//</span><span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">r</span><span class="main">``</span><span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> quotientE<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> refl_onD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> ex1I<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span>"</span></span><span class="main">]</span>
          respects_imp_unique_image_rel<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quotientfun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">quotientfun</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">b</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-quotientfun_equality"><span class="command">lemma</span></span> quotientfun_equality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"refl_on <span class="free">A</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="keyword1">respects</span> <span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span><span class="free">A</span><span class="main">//</span><span class="free">r</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"quotientfun <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> quotientfun_def
  <span class="keyword1"><span class="command">using</span></span>     assms<span class="main">(</span>4<span class="main">)</span> ex1_class_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the1_equality<span class="main">)</span>

<span class="keyword1" id="Prelim-quotientfun_classrep_equality"><span class="command">lemma</span></span> quotientfun_classrep_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> refl_on <span class="free">A</span> <span class="free">r</span><span class="main">;</span> <span class="free">f</span> <span class="keyword1">respects</span> <span class="free">r</span><span class="main">;</span> <span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> quotientfun <span class="free">f</span> <span class="main">(</span><span class="free">r</span><span class="main">``</span><span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl_onD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> quotientfun_equality quotientI<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Support of a function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">supp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">supp</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">≠</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Prelim-suppI_contra"><span class="command">lemma</span></span> suppI_contra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> supp <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-suppD_contra"><span class="command">lemma</span></span> suppD_contra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> supp <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> supp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">restrict0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">restrict0</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-supp_restrict0"><span class="command">lemma</span></span> supp_restrict0 <span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>restrict0 <span class="free">f</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∉</span> supp <span class="main">(</span>restrict0 <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> suppD_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"restrict0 <span class="free">f</span> <span class="free">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lists›</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous facts›</span></span>

<span class="keyword1" id="Prelim-snoc_conv_cons"><span class="command">lemma</span></span> snoc_conv_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> <span class="bound">x</span><span class="main">#</span><span class="bound">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-cons_conv_snoc"><span class="command">lemma</span></span> cons_conv_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span> <span class="bound">y</span><span class="main">.</span> <span class="free">x</span><span class="main">#</span><span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-same_length_eq_append"><span class="command">lemma</span></span> same_length_eq_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span> <span class="main">⟹</span> <span class="free">as</span><span class="main">@</span><span class="free">cs</span> <span class="main">=</span> <span class="free">bs</span><span class="main">@</span><span class="free">ds</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-count_list_append"><span class="command">lemma</span></span> count_list_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_list <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="free">a</span> <span class="main">=</span> count_list <span class="free">xs</span> <span class="free">a</span> <span class="main">+</span> count_list <span class="free">ys</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-count_list_snoc"><span class="command">lemma</span></span> count_list_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"count_list <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span><span class="main">=</span><span class="free">x</span> <span class="keyword1">then</span> Suc <span class="main">(</span>count_list <span class="free">xs</span> <span class="free">y</span><span class="main">)</span> <span class="keyword1">else</span> count_list <span class="free">xs</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-distinct_count_list"><span class="command">lemma</span></span> distinct_count_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span> <span class="main">⟹</span> count_list <span class="free">xs</span> <span class="free">a</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">a</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-map_fst_map_const_snd"><span class="command">lemma</span></span> map_fst_map_const_snd<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-inj_on_distinct_setlistmapim"><span class="command">lemma</span></span> inj_on_distinct_setlistmapim<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>set <span class="free">Xs</span><span class="main">.</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> distinct <span class="free">Xs</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">Xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">X</span> <span class="skolem">Xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">X</span> <span class="main">∈</span> set <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="skolem">Xs</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span><span class="main">∈</span>set <span class="skolem">Xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">X</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms Y<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_on_eq_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Cases›</span></span>

<span class="keyword1" id="Prelim-list_cases_Cons_snoc"><span class="command">lemma</span></span> list_cases_Cons_snoc <span class="main">[</span><span class="operator">case_names</span> Nil Single Cons_snoc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>       Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>        Single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Cons_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">ys</span> <span class="bound">y</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Nil<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Single Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-two_lists_cases_Cons_Cons"><span class="command">lemma</span></span> two_lists_cases_Cons_Cons <span class="main">[</span><span class="operator">case_names</span> Nil1 Nil2 ConsCons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>     Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>         Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     ConsCons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">xs</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil1<span class="main">)</span>

<span class="keyword1" id="Prelim-two_lists_cases_snoc_Cons"><span class="command">lemma</span></span> two_lists_cases_snoc_Cons <span class="main">[</span><span class="operator">case_names</span> Nil1 Nil2 snoc_Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>      Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>          Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword1"><span class="command">with</span></span> Nil2 snoc_Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Nil1<span class="main">)</span>

<span class="keyword1" id="Prelim-two_lists_cases_snoc_Cons'"><span class="command">lemma</span></span> two_lists_cases_snoc_Cons' <span class="main">[</span><span class="operator">case_names</span> both_Nil Nil1 Nil2 snoc_Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>  both_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>          Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">y</span><span class="main">#</span><span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>          Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil1 <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil2 <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> snoc_Cons<span class="main">)</span>

<span class="keyword1" id="Prelim-two_prod_lists_cases_snoc_Cons"><span class="command">lemma</span></span> two_prod_lists_cases_snoc_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">aa</span> <span class="bound">ba</span> <span class="bound">ab</span> <span class="bound">bb</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="bound">aa</span><span class="main">,</span> <span class="bound">ba</span><span class="main">)</span><span class="main">]</span> <span class="main">∧</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="bound">ab</span><span class="main">,</span> <span class="bound">bb</span><span class="main">)</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> two_lists_cases_snoc_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-three_lists_cases_snoc_mid_Cons"><span class="command">lemma</span></span> three_lists_cases_snoc_mid_Cons
      <span class="main">[</span><span class="operator">case_names</span> Nil1 Nil2 Nil3 snoc_single_Cons snoc_mid_Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>             Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>                 Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>                 Nil3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc_single_Cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>        snoc_mid_Cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">w</span> <span class="bound">ys</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">as</span> <span class="main">=</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">=</span> <span class="bound">w</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">⟹</span>
      <span class="free">cs</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil1 <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Nil2 <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> snoc_Cons
  <span class="keyword1"><span class="command">with</span></span> Nil2 snoc_single_Cons snoc_mid_Cons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Induction›</span></span>

<span class="keyword1" id="Prelim-list_induct_CCons"><span class="command">lemma</span></span> list_induct_CCons <span class="main">[</span><span class="operator">case_names</span> Nil Single CCons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nil   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     CCons <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">xs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">x</span> <span class="main">#</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Single CCons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> Nil<span class="main">)</span>

<span class="keyword1" id="Prelim-list_induct_ssnoc"><span class="command">lemma</span></span> list_induct_ssnoc <span class="main">[</span><span class="operator">case_names</span> Nil Single ssnoc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nil   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Single<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     ssnoc <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Single ssnoc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> Nil<span class="main">)</span>

<span class="keyword1" id="Prelim-list_induct2_snoc"><span class="command">lemma</span></span> list_induct2_snoc <span class="main">[</span><span class="operator">case_names</span> Nil1 Nil2 snoc<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nil1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Nil2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">ys</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Nil1<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-list_induct2_snoc_Cons"><span class="command">lemma</span></span> list_induct2_snoc_Cons <span class="main">[</span><span class="operator">case_names</span> Nil1 Nil2 snoc_Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nil1     <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Nil2     <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Nil2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> Nil1 snoc_Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-prod_list_induct3_snoc_Conssnoc_Cons_pairwise"><span class="command">lemma</span></span> prod_list_induct3_snoc_Conssnoc_Cons_pairwise<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span><span class="bound">ys</span><span class="main">,</span><span class="bound">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="main">[]</span><span class="main">,</span><span class="bound">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">,</span><span class="main">[]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span><span class="main">[</span><span class="bound">y</span><span class="main">]</span><span class="main">,</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     step<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span> <span class="bound">w</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">,</span><span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">w</span><span class="main">]</span><span class="main">,</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">,</span><span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">,</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">w</span><span class="main">]</span><span class="main">,</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">induct</span>  <span class="quoted"><span class="free">t</span></span>
  <span class="quasi_keyword">taking</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">,</span><span class="bound">zs</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">+</span> length <span class="bound">ys</span> <span class="main">+</span> length <span class="bound">zs</span>"</span></span>
  <span class="quasi_keyword">rule</span>  <span class="main"><span class="main">:</span></span> measure_induct_rule
<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>fields <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span><span class="main">)</span> <span class="keyword1"><span class="command">from</span></span> assms less fields <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> three_lists_cases_snoc_mid_Cons<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-list_induct3_snoc_Conssnoc_Cons_pairwise"><span class="command">lemma</span></span> list_induct3_snoc_Conssnoc_Cons_pairwise
      <span class="main">[</span><span class="operator">case_names</span> Nil1 Nil2 Nil3 snoc_single_Cons snoc_Conssnoc_Cons<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Nil1              <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">P</span> <span class="main">[]</span> <span class="bound">ys</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Nil2              <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">[]</span> <span class="bound">zs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     Nil3              <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc_single_Cons  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">(</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     snoc_Conssnoc_Cons<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">ys</span> <span class="bound">w</span> <span class="bound">z</span> <span class="bound">zs</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">xs</span> <span class="main">(</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">w</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">)</span> <span class="bound">zs</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">y</span><span class="main">#</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="bound">w</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="bound">z</span><span class="main">#</span><span class="bound">zs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">xs</span> <span class="free">ys</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms
          prod_list_induct3_snoc_Conssnoc_Cons_pairwise<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">,</span><span class="bound">zs</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">xs</span> <span class="bound">ys</span> <span class="bound">zs</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Alternating lists›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">alternating_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alternating_list</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
      <span class="main">|</span> Suc <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">alternating_list</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
                <span class="free">alternating_list</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="keyword1">if</span> even <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span>"</span></span>
<span class="comment1">― ‹could be defined using Cons, but we want the alternating list to always start with the same
letter as it grows, and it's easier to do that via append›</span>

<span class="keyword1" id="Prelim-alternating_list2"><span class="command">lemma</span></span> alternating_list2<span class="main">:</span> <span class="quoted"><span class="quoted">"alternating_list <span class="numeral">2</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> Suc_1<span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> alternating_list <span class="bound">n</span> <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-length_alternating_list"><span class="command">lemma</span></span> length_alternating_list<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-alternating_list_Suc_Cons"><span class="command">lemma</span></span> alternating_list_Suc_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alternating_list <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">#</span> alternating_list <span class="free">k</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-alternating_list_SucSuc_ConsCons"><span class="command">lemma</span></span> alternating_list_SucSuc_ConsCons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alternating_list <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="free">s</span> <span class="main">#</span> <span class="free">t</span> <span class="main">#</span> alternating_list <span class="free">k</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="free">k</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Prelim-alternating_list_alternates"><span class="command">lemma</span></span> alternating_list_alternates<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">=</span><span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> prevcase<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span><span class="main">.</span> alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">]</span> <span class="main">@</span> <span class="bound">xs</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
    <span class="quoted"><span class="quoted">"alternating_list <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">,</span><span class="free">c</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> prevcase<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> prevcase<span class="main">(</span>2<span class="main">)</span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ds</span> <span class="skolem">d</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> prevcase <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>      
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-alternating_list_split"><span class="command">lemma</span></span> alternating_list_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"alternating_list <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> alternating_list <span class="free">m</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span>
    <span class="main">(</span><span class="keyword1">if</span> even <span class="free">m</span> <span class="keyword1">then</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="keyword1">else</span> alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alternating_list_SucSuc_ConsCons<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_induct_step2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-alternating_list_append"><span class="command">lemma</span></span> alternating_list_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"even <span class="free">m</span> <span class="main">⟹</span>
    alternating_list <span class="free">m</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> alternating_list <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="quoted"><span class="quoted">"odd <span class="free">m</span> <span class="main">⟹</span>
    alternating_list <span class="free">m</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span> <span class="main">=</span> alternating_list <span class="main">(</span><span class="free">m</span><span class="main">+</span><span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alternating_list_split<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-rev_alternating_list"><span class="command">lemma</span></span> rev_alternating_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rev <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> even <span class="free">n</span> <span class="keyword1">then</span> alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span> <span class="keyword1">else</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alternating_list_SucSuc_ConsCons<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_induct_step2<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-set_alternating_list"><span class="command">lemma</span></span> set_alternating_list<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-set_alternating_list1"><span class="command">lemma</span></span> set_alternating_list1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-set_alternating_list2"><span class="command">lemma</span></span> set_alternating_list2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> set <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_induct_step2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SucSuc <span class="skolem">m</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> set_alternating_list alternating_list_SucSuc_ConsCons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-alternating_list_in_lists"><span class="command">lemma</span></span> alternating_list_in_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> alternating_list <span class="free">n</span> <span class="free">a</span> <span class="free">b</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Binary relation chains›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we consider lists where each pair of adjacent elements satisfy a given relation.›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">binrelchain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">binrelchain</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[]</span>  <span class="main">=</span> True"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">binrelchain</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> True"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">binrelchain</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free">binrelchain</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-binrelchain_Cons_reduce"><span class="command">lemma</span></span> binrelchain_Cons_reduce<span class="main">:</span> <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-binrelchain_append_reduce1"><span class="command">lemma</span></span> binrelchain_append_reduce1<span class="main">:</span> <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> binrelchain_Cons_reduce <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-binrelchain_append_reduce2"><span class="command">lemma</span></span> binrelchain_append_reduce2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> binrelchain_Cons_reduce <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-binrelchain_Conssnoc_reduce"><span class="command">lemma</span></span> binrelchain_Conssnoc_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce1 binrelchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-binrelchain_overlap_join"><span class="command">lemma</span></span> binrelchain_overlap_join<span class="main">:</span>
  <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-binrelchain_join"><span class="command">lemma</span></span> binrelchain_join<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span><span class="main">;</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span>
    binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_overlap_join <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-binrelchain_snoc"><span class="command">lemma</span></span> binrelchain_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_join <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-binrelchain_sym_rev"><span class="command">lemma</span></span> binrelchain_sym_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> binrelchain_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-binrelchain_remdup_adj"><span class="command">lemma</span></span> binrelchain_remdup_adj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">proper_binrelchain</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> binrelchain <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> distinct <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1" id="Prelim-binrelchain_obtain_proper"><span class="command">lemma</span></span> binrelchain_obtain_proper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> set <span class="bound">zs</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> length <span class="bound">zs</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">∧</span> proper_binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">zs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">w</span> <span class="skolem">ws</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="free">y</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> one
    <span class="keyword1"><span class="command">from</span></span> one<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ws</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> set <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">≤</span> length <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"proper_binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> other
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proper_binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[]</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[]</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> neither<span class="main">(</span>2<span class="main">)</span> Cons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zs</span></span> 
      <span class="keyword2"><span class="keyword">where</span></span> zs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">zs</span> <span class="main">⊆</span> set <span class="skolem">ws</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span> <span class="main">≤</span> length <span class="skolem">ws</span>"</span></span>
                <span class="quoted"><span class="quoted">"proper_binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set <span class="skolem">zs</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> asbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zs</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">bs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_set_conv_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> zs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proper_binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">#</span><span class="skolem">as</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> zs<span class="main">(</span>1<span class="main">)</span> asbs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">bs</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> asbs zs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">bs</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> zs<span class="main">(</span>3<span class="main">)</span> neither<span class="main">(</span>1<span class="main">)</span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"proper_binrelchain <span class="free">P</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> zs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> zs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">zs</span><span class="main">)</span> <span class="main">≤</span> length <span class="main">(</span><span class="skolem">w</span><span class="main">#</span><span class="skolem">ws</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-binrelchain_trans_Cons_snoc"><span class="command">lemma</span></span> binrelchain_trans_Cons_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-binrelchain_cong"><span class="command">lemma</span></span> binrelchain_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="free">xs</span> <span class="main">⟹</span> binrelchain <span class="free">Q</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms binrelchain_Cons_reduce
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-binrelchain_funcong_Cons_snoc"><span class="command">lemma</span></span> binrelchain_funcong_Cons_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="quoted">"binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms binrelchain_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
          binrelchain_trans_Cons_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Prelim-binrelchain_funcong_extra_condition_Cons_snoc"><span class="command">lemma</span></span> binrelchain_funcong_extra_condition_Cons_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">zs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">#</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1" id="Prelim-binrelchain_setfuncong_Cons_snoc"><span class="command">lemma</span></span> binrelchain_setfuncong_Cons_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="bound">y</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span>
      binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">zs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_funcong_extra_condition_Cons_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Prelim-binrelchain_propcong_Cons_snoc"><span class="command">lemma</span></span> binrelchain_propcong_Cons_snoc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> binrelchain <span class="free">P</span> <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Cons <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set of subseqs›</span></span>

<span class="keyword1" id="Prelim-subseqs_Cons"><span class="command">lemma</span></span> subseqs_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"subseqs <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>Cons <span class="free">x</span><span class="main">)</span> <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>subseqs <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cong_let<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"subseqs <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xss</span><span class="main">.</span> map <span class="main">(</span>Cons <span class="free">x</span><span class="main">)</span> <span class="bound">xss</span> <span class="main">@</span> <span class="bound">xss</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ssubseqs</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> set <span class="main">(</span>subseqs <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-nil_ssubseqs"><span class="command">lemma</span></span> nil_ssubseqs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∈</span> ssubseqs <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> subseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-ssubseqs_Cons"><span class="command">lemma</span></span> ssubseqs_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"ssubseqs <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>Cons <span class="free">x</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>ssubseqs <span class="free">xs</span><span class="main">)</span> <span class="main">∪</span> ssubseqs <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-ssubseqs_refl"><span class="command">lemma</span></span> ssubseqs_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> ssubseqs <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssubseqs_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> nil_ssubseqs<span class="main">)</span>

<span class="keyword1" id="Prelim-ssubseqs_subset"><span class="command">lemma</span></span> ssubseqs_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> ssubseqs <span class="free">bs</span> <span class="main">⟹</span> ssubseqs <span class="free">as</span> <span class="main">⊆</span> ssubseqs <span class="free">bs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> set <span class="main">(</span>subseqs <span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssubseqs_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> nil_ssubseqs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">#</span><span class="skolem">bs</span>"</span></span><span class="main">]</span> ssubseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"hd <span class="skolem">as</span>"</span></span><span class="main">]</span> ssubseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-ssubseqs_lists"><span class="command">lemma</span></span> ssubseqs_lists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">∈</span> ssubseqs <span class="free">as</span> <span class="main">⟹</span> <span class="free">bs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssubseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-delete1_ssubseqs"><span class="command">lemma</span></span> delete1_ssubseqs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="free">bs</span> <span class="main">∈</span> ssubseqs <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssubseqs_refl ssubseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssubseqs_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-delete2_ssubseqs"><span class="command">lemma</span></span> delete2_ssubseqs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="free">cs</span> <span class="main">∈</span> ssubseqs <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="main">[</span><span class="free">b</span><span class="main">]</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> delete1_ssubseqs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span>"</span></span><span class="main">]</span> delete1_ssubseqs ssubseqs_subset
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Orders and posets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have chosen to work with the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ordering<span class="antiquote"><span class="antiquote">}</span></span></span></span> locale instead of the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> order<span class="antiquote"><span class="antiquote">}</span></span></span></span> class to
  more easily facilitate simultaneously working with both an order and its dual.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Morphisms of posets›</span></span>

<span class="keyword1"><span class="command">locale</span></span> OrderingSetMap <span class="main">=</span>
  domain  <span class="main">:</span> ordering <span class="quoted"><span class="free">less_eq</span></span> <span class="quoted"><span class="free">less</span></span>
<span class="main">+</span> codomain<span class="main">:</span> ordering <span class="quoted"><span class="free">less_eq'</span></span> <span class="quoted"><span class="free">less'</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">less_eq</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b></span>"</span>  50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b></span>"</span>  50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less_eq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b>*</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less'</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b>*</span>"</span> 50<span class="main">)</span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ordsetmap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b>*</span></span> <span class="free">f</span> <span class="free">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Prelim-comp"><span class="command">lemma</span></span> comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"OrderingSetMap <span class="free">less_eq'</span> <span class="free">less'</span> <span class="free">less_eq''</span> <span class="free">less''</span> <span class="free">Q</span> <span class="free">g</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OrderingSetMap <span class="free">less_eq</span> <span class="free">less</span> <span class="free">less_eq''</span> <span class="free">less''</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">interpret</span></span> I<span class="main">:</span> OrderingSetMap <span class="quoted"><span class="free">less_eq'</span></span> <span class="quoted"><span class="free">less'</span></span> <span class="quoted"><span class="free">less_eq''</span></span> <span class="quoted"><span class="free">less''</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">g</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">use</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> <span class="quoted">‹<span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main">:</span> ordsetmap I.ordsetmap›</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-subset"><span class="command">lemma</span></span> subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Q</span><span class="main">⊆</span><span class="free">P</span> <span class="main">⟹</span> OrderingSetMap <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>*)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>*)</span></span> <span class="free">Q</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ordsetmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OrderingSetMap *)</span>

<span class="keyword1"><span class="command">locale</span></span> OrderingSetIso <span class="main">=</span> OrderingSetMap <span class="quoted"><span class="free">less_eq</span></span> <span class="quoted"><span class="free">less</span></span> <span class="quoted"><span class="free">less_eq'</span></span> <span class="quoted"><span class="free">less'</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">less_eq</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b></span>"</span>  50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b></span>"</span>  50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less_eq'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b>*</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less'</span>    <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b>*</span>"</span> 50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> inj               <span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     rev_OrderingSetMap<span class="main">:</span>
    <span class="quoted"><span class="quoted">"OrderingSetMap <span class="free">less_eq'</span> <span class="free">less'</span> <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span>the_inv_into <span class="free">P</span> <span class="free">f</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">subset_ordering_iso</span> <span class="main">≡</span> OrderingSetIso <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetMap<span class="main">)</span> isoI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="bound">b</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b>*</span></span> <span class="free">f</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="bound">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="free">less_eq'</span> <span class="free">less'</span> <span class="free">P</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-OrderingSetIsoI_orders_greater2less"><span class="command">lemma</span></span> OrderingSetIsoI_orders_greater2less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>order"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">≤</span><span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main">(</span>greater_eq<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool<span class="main">)</span> <span class="main">(</span>greater<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool<span class="main">)</span>
            <span class="main">(</span>less_eq<span class="main">::</span><span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span>bool<span class="main">)</span> <span class="main">(</span>less<span class="main">::</span><span class="tfree">'b</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">⇒</span>bool<span class="main">)</span> <span class="free">P</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">b</span><span class="main">≤</span><span class="bound">a</span> <span class="main">⟹</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">P</span> <span class="main">⟹</span> <span class="bound">b</span><span class="main">≤</span><span class="bound">a</span> <span class="main">⟹</span>
            the_inv_into <span class="free">P</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">≤</span> the_inv_into <span class="free">P</span> <span class="free">f</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>


<span class="keyword1"><span class="command">context</span></span> OrderingSetIso
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> ordsetmap <span class="main">=</span> ordsetmap

<span class="keyword1" id="Prelim-ordsetmap_strict"><span class="command">lemma</span></span> ordsetmap_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span><span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b>*</span></span> <span class="free">f</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domain.strict_iff_order codomain.strict_iff_order ordsetmap inj
        inj_on_contraD
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_ordsetmap <span class="main">=</span> OrderingSetMap.ordsetmap<span class="main">[</span><span class="operator">OF</span> rev_OrderingSetMap<span class="main">]</span>

<span class="keyword1" id="Prelim-rev_ordsetmap"><span class="command">lemma</span></span> rev_ordsetmap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">f</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b>*</span></span> <span class="free">f</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv_ordsetmap the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-inv_iso"><span class="command">lemma</span></span> inv_iso<span class="main">:</span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq'</span> <span class="free">less'</span> <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span>the_inv_into <span class="free">P</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv_ordsetmap inj_on_the_inv_into<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> the_inv_into_onto<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span>
        ordsetmap the_inv_into_the_inv_into<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_ordsetmap_strict <span class="main">=</span> OrderingSetIso.ordsetmap_strict<span class="main">[</span><span class="operator">OF</span> inv_iso<span class="main">]</span>

<span class="keyword1" id="Prelim-rev_ordsetmap_strict"><span class="command">lemma</span></span> rev_ordsetmap_strict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">f</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b>*</span></span> <span class="free">f</span> <span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inv_ordsetmap_strict the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-iso_comp"><span class="command">lemma</span></span> iso_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq'</span> <span class="free">less'</span> <span class="free">less_eq''</span> <span class="free">less''</span> <span class="free">Q</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">P</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="free">less_eq''</span> <span class="free">less''</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> OrderingSetMap.isoI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"OrderingSetMap <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="free">less_eq''</span> <span class="free">less''</span> <span class="free">P</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OrderingSetIso.axioms<span class="main">(</span>1<span class="main">)</span> comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OrderingSetIso.inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          comp_inj_on<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">OF</span> subset_inj_on<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">a</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="skolem">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">less_eq''</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OrderingSetIso.rev_ordsetmap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> rev_ordsetmap <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-iso_subset"><span class="command">lemma</span></span> iso_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">Q</span><span class="main">⊆</span><span class="free">P</span> <span class="main">⟹</span> OrderingSetIso <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>*)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>*)</span></span> <span class="free">Q</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Q</span></span><span class="main">]</span> subset_inj_on<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> rev_ordsetmap
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OrderingSetMap.isoI<span class="main">)</span>

<span class="keyword1" id="Prelim-iso_dual"><span class="command">lemma</span></span> iso_dual<span class="main">:</span>
  <span class="quoted"><span class="quoted">‹OrderingSetIso <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">less_eq</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">less</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">less_eq'</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="free">less'</span> <span class="bound">b</span> <span class="bound">a</span><span class="main">)</span> <span class="free">P</span> <span class="free">f</span>›</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> OrderingSetMap.isoI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
  <span class="keyword1"><span class="command">using</span></span> inj
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> domain.refl codomain.refl
              domain.irrefl codomain.irrefl
              domain.order_iff_strict codomain.order_iff_strict
              ordsetmap_strict rev_ordsetmap_strict inj_onD
              <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domain.trans codomain.trans
              domain.strict_trans codomain.strict_trans
              domain.antisym codomain.antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OrderingSetIso *)</span>

<span class="keyword1" id="Prelim-induced_pow_fun_subset_ordering_iso"><span class="command">lemma</span></span> induced_pow_fun_subset_ordering_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"subset_ordering_iso <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> Pow <span class="free">A</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> Pow <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_pow_fun_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> Pow <span class="free">A</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">(`)</span> <span class="free">f</span> <span class="main">`</span> Pow <span class="free">A</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="bound">b</span>
        <span class="main">⟹</span> the_inv_into <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⊆</span> the_inv_into <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y1</span> <span class="skolem">Y2</span>
    <span class="keyword3"><span class="command">assume</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">∈</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">⊆</span> <span class="skolem">Y2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Y<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span><span class="main">⊆</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span><span class="main">⊆</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y1</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">X1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y2</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">X2</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms Y<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">Y1</span> <span class="main">⊆</span> the_inv_into <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="skolem">Y2</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">X1</span></span><span class="main">]</span>
            the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">X2</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹More <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> arg_min<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1" id="Prelim-is_arg_minI"><span class="command">lemma</span></span> is_arg_minI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">x</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">m</span> <span class="bound">y</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_arg_min_def<span class="main">)</span>

<span class="keyword1" id="Prelim-is_arg_min_linorderI"><span class="command">lemma</span></span> is_arg_min_linorderI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">P</span> <span class="free">x</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">m</span> <span class="bound">y</span><span class="main">::</span><span class="main">_</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_arg_min_linorder<span class="main">)</span>

<span class="keyword1" id="Prelim-is_arg_min_eq"><span class="command">lemma</span></span> is_arg_min_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span><span class="main">;</span> <span class="free">P</span> <span class="free">z</span><span class="main">;</span> <span class="free">m</span> <span class="free">z</span> <span class="main">=</span> <span class="free">m</span> <span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> is_arg_min_def<span class="main">)</span>

<span class="keyword1" id="Prelim-is_arg_minD1"><span class="command">lemma</span></span> is_arg_minD1<span class="main">:</span> <span class="quoted"><span class="quoted">"is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_arg_min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-is_arg_minD2"><span class="command">lemma</span></span> is_arg_minD2<span class="main">:</span> <span class="quoted"><span class="quoted">"is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">m</span> <span class="free">y</span> <span class="main">&lt;</span> <span class="free">m</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> is_arg_min_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-is_arg_min_size"><span class="command">lemma</span></span> is_arg_min_size<span class="main">:</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">m</span> <span class="free">x</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>arg_min <span class="free">m</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> arg_min_equality is_arg_min_linorder<span class="main">)</span>

<span class="keyword1" id="Prelim-is_arg_min_size_subprop"><span class="command">lemma</span></span> is_arg_min_size_subprop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">m</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>linorder"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">(</span>arg_min <span class="free">m</span> <span class="free">Q</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span> <span class="main">(</span>arg_min <span class="free">m</span> <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_arg_min <span class="free">m</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">¬</span> is_arg_min <span class="free">m</span> <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> is_arg_min <span class="free">m</span> <span class="free">Q</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> contrapos_nn<span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">OF</span> is_arg_minI<span class="main">]</span> is_arg_minD2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> is_arg_min_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> is_arg_min_size<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Bottom of a set›</span></span>

<span class="keyword1"><span class="command">context</span></span> ordering
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">has_bottom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">has_bottom</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">z</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="bound">z</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="bound">x</span>"</span></span>

<span class="keyword1" id="Prelim-has_bottomI"><span class="command">lemma</span></span> has_bottomI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> has_bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_bottom_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-has_uniq_bottom"><span class="command">lemma</span></span> has_uniq_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound"><span class="bound">z</span></span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="bound">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_bottom_def antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bottom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">bottom</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="bound">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-bottomD"><span class="command">lemma</span></span> bottomD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"bottom <span class="free">P</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> bottom <span class="free">P</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms has_uniq_bottom theI'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="bound">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> bottom_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1" id="Prelim-bottomI"><span class="command">lemma</span></span> bottomI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     has_bottomI has_uniq_bottom
            the1_equality<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> <span class="bound">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="bound">x</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> bottom_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ordering *)</span>

<span class="keyword1" id="Prelim-has_bottom_pow"><span class="command">lemma</span></span> has_bottom_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"order.has_bottom <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.has_bottomI<span class="main">)</span>

<span class="keyword1" id="Prelim-bottom_pow"><span class="command">lemma</span></span> bottom_pow<span class="main">:</span> <span class="quoted"><span class="quoted">"order.bottom <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order.bottomI<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> OrderingSetMap
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">dombot</span> <span class="main">≡</span> domain.bottom <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">codbot</span> <span class="main">≡</span> codomain.bottom <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-im_has_bottom"><span class="command">lemma</span></span> im_has_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.has_bottom <span class="free">P</span> <span class="main">⟹</span> codomain.has_bottom <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domain.bottomD ordsetmap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> codomain.has_bottomI<span class="main">)</span>

<span class="keyword1" id="Prelim-im_bottom"><span class="command">lemma</span></span> im_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.has_bottom <span class="free">P</span> <span class="main">⟹</span> <span class="free">f</span> dombot <span class="main">=</span> codbot"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domain.bottomD ordsetmap <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> codomain.bottomI<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OrderingSetMap *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetIso<span class="main">)</span> pullback_has_bottom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"codomain.has_bottom <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"domain.has_bottom <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> domain.has_bottomI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="free">P</span> <span class="free">f</span> codbot <span class="main">∈</span> <span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> codomain.bottomD<span class="main">(</span>1<span class="main">)</span> the_inv_into_into<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> the_inv_into <span class="free">P</span> <span class="free">f</span> codbot <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> codomain.bottomD inv_ordsetmap<span class="main">[</span><span class="operator">of</span> <span class="quoted">codbot</span><span class="main">]</span> the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetIso<span class="main">)</span> pullback_bottom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> domain.has_bottom <span class="free">P</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> codomain.bottom <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">x</span> <span class="main">=</span> domain.bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> im_has_bottom codomain.bottomD<span class="main">(</span>2<span class="main">)</span> rev_ordsetmap
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domain.bottomI<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Minimal and pseudominimal elements in sets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We will call an element of a poset pseudominimal if the only element below it is the bottom of
  the poset.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ordering
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minimal_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">minimal_in</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">¬</span> <span class="bound">z</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pseudominimal_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pseudominimal_in</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> minimal_in <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">-</span> <span class="main">{</span>bottom <span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">}</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="comment1">― ‹only makes sense for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"has_bottom <span class="free">P</span>"</span><span class="antiquote">}</span></span>›</span>

<span class="keyword1" id="Prelim-minimal_inD1"><span class="command">lemma</span></span> minimal_inD1<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_in <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> minimal_in_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-minimal_inD2"><span class="command">lemma</span></span> minimal_inD2<span class="main">:</span> <span class="quoted"><span class="quoted">"minimal_in <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="main">¬</span> <span class="free">z</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> minimal_in_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudominimal_inD1"><span class="command">lemma</span></span> pseudominimal_inD1<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pseudominimal_in_def minimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudominimal_inD2"><span class="command">lemma</span></span> pseudominimal_inD2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pseudominimal_in <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span><span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pseudominimal_in_def minimal_inD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudominimal_inI"><span class="command">lemma</span></span> pseudominimal_inI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> bottom <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="bound">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span><span class="free">x</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">=</span> bottom <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"pseudominimal_in <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms
  <span class="keyword1"><span class="command">unfolding</span></span> pseudominimal_in_def minimal_in_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudominimal_ne_bottom"><span class="command">lemma</span></span> pseudominimal_ne_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pseudominimal_in_def minimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudominimal_comp"><span class="command">lemma</span></span> pseudominimal_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> pseudominimal_in <span class="free">P</span> <span class="free">x</span><span class="main">;</span> pseudominimal_in <span class="free">P</span> <span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pseudominimal_inD1 pseudominimal_inD2 pseudominimal_ne_bottom
        strict_iff_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ordering *)</span>

<span class="keyword1" id="Prelim-pseudominimal_in_pow"><span class="command">lemma</span></span> pseudominimal_in_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"order.pseudominimal_in <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> order.pseudominimal_ne_bottom bottom_pow<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> order.pseudominimal_inD1 order.pseudominimal_inD2<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">}</span>"</span></span><span class="main">]</span>
          bottom_pow
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-pseudominimal_in_pow_singleton"><span class="command">lemma</span></span> pseudominimal_in_pow_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟹</span> order.pseudominimal_in <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> singleton_pow bottom_pow <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.pseudominimal_inI<span class="main">)</span>

<span class="keyword1" id="Prelim-no_pseudominimal_in_pow_is_empty"><span class="command">lemma</span></span> no_pseudominimal_in_pow_is_empty<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> order.pseudominimal_in <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pseudominimal_in_pow_singleton <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equals0I<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetIso<span class="main">)</span> pseudominimal_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"domain.has_bottom <span class="free">P</span> <span class="main">⟹</span> domain.pseudominimal_in <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span>
    codomain.pseudominimal_in <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domain.pseudominimal_inD1 pullback_bottom
        domain.pseudominimal_ne_bottom rev_ordsetmap_strict
        domain.pseudominimal_inD2 im_bottom
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> codomain.pseudominimal_inI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetIso<span class="main">)</span> pullback_pseudominimal_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> domain.has_bottom <span class="free">P</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> codomain.pseudominimal_in <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
      domain.pseudominimal_in <span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> im_bottom codomain.pseudominimal_ne_bottom ordsetmap_strict
        codomain.pseudominimal_inD2 pullback_bottom
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domain.pseudominimal_inI<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Set of elements below another›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ordering<span class="main">)</span> <span class="entity">below_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">.<span class="hidden">❙</span><b>≤</b></span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">.<span class="hidden">❙</span><b>≤</b></span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="bound">y</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ord<span class="main">)</span> <span class="entity">below_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">.≤</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">.≤</span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="bound">y</span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> ordering
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Prelim-below_in_refl"><span class="command">lemma</span></span> below_in_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-below_in_singleton"><span class="command">lemma</span></span> below_in_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">y</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> below_in_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-bottom_in_below_in"><span class="command">lemma</span></span> bottom_in_below_in<span class="main">:</span> <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> bottom <span class="free">P</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bottomD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-below_in_singleton_is_bottom"><span class="command">lemma</span></span> below_in_singleton_is_bottom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> has_bottom <span class="free">P</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bottom_in_below_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-bottom_below_in"><span class="command">lemma</span></span> bottom_below_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bottom_in_below_in <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bottomI<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Prelim-bottom_below_in_relative"><span class="command">lemma</span></span> bottom_below_in_relative<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> has_bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">y</span><span class="main">)</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">x</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bottomD trans <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bottomI<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Prelim-has_bottom_pseudominimal_in_below_inI"><span class="command">lemma</span></span> has_bottom_pseudominimal_in_below_inI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="free">P</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> pseudominimal_inD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          pseudominimal_inD2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          bottom_below_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> pseudominimal_ne_bottom
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pseudominimal_inI<span class="main">)</span>

<span class="keyword1" id="Prelim-has_bottom_pseudominimal_in_below_in"><span class="command">lemma</span></span> has_bottom_pseudominimal_in_below_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pseudominimal_in <span class="free">P</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   pseudominimal_inD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          pseudominimal_inD2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          pseudominimal_ne_bottom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          bottom_below_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          strict_implies_order<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pseudominimal_inI<span class="main">)</span>

<span class="keyword1" id="Prelim-pseudominimal_in_below_in"><span class="command">lemma</span></span> pseudominimal_in_below_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"has_bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">y</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms<span class="main">(</span>3<span class="main">)</span> trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> trans<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> strict_iff_order
            pseudominimal_inD1<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
            pseudominimal_inD2<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
            pseudominimal_ne_bottom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
            bottom_below_in_relative<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pseudominimal_inI<span class="main">)</span>

<span class="keyword1" id="Prelim-collect_pseudominimals_below_in_less_eq_top"><span class="command">lemma</span></span> collect_pseudominimals_below_in_less_eq_top<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≡</span> the_inv_into <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pseudominimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> OrderingSetIso.inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> the_inv_into_into<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-collect_pseudominimals_below_in_poset"><span class="command">lemma</span></span> collect_pseudominimals_below_in_poset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> Pow <span class="free">A</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≡</span> the_inv_into <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms<span class="main">(</span>2-4<span class="main">)</span> OrderingSetIso.inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> pseudominimal_inD1
            the_inv_into_into<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">force</span>

<span class="keyword1" id="Prelim-collect_pseudominimals_below_in_eq"><span class="command">lemma</span></span> collect_pseudominimals_below_in_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≡</span> the_inv_into <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> has_bot_ltx<span class="main">:</span> <span class="quoted"><span class="quoted">"has_bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> has_bottom_pow OrderingSetIso.pullback_has_bottom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Un_fa<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pseudominimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> w_le_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> w_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> collect_pseudominimals_below_in_less_eq_top
          collect_pseudominimals_below_in_poset
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">a</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> CollectI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> pseudominimal_inI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> CollectI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> y assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y_le_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pseudominimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> y w <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">w</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> y_le_x Un_fa OrderingSetIso.inv_ordsetmap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
              the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> OrderingSetIso.inj<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> y assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> w_P w_le_x has_bot_ltx bottom_below_in_relative
              pseudominimal_ne_bottom
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main"><span class="free"><span class="hidden">❙</span><b>&lt;</b></span></span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> y assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> w_le_x trans pseudominimal_inD2<span class="main">[</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="main">=</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> has_bot_ltx w_P w_le_x bottom_below_in_relative <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> bottom <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">⊇</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">w</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> v_pm_ltx<span class="main">:</span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> has_bot_ltx w_P w_le_x pseudominimal_in_below_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">≤</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w pseudominimal_inD1<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> pseudominimal_inD1<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span> w_le_x w_P
            OrderingSetIso.ordsetmap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> Un_fa
            OrderingSetIso.inj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            f_the_inv_into_f
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">⊆</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v_pm_ltx has_bot_ltx pseudominimal_in_pow
            OrderingSetIso.pseudominimal_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">a</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> v_pm_ltx pseudominimal_inD1 pseudominimal_comp<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
            OrderingSetIso.rev_ordsetmap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ordering *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lower bounds›</span></span>

<span class="keyword1"><span class="command">context</span></span> ordering
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lbound_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lbound_of</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Prelim-lbound_ofI"><span class="command">lemma</span></span> lbound_ofI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">x</span> <span class="main">⟹</span> <span class="free">b</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">y</span> <span class="main">⟹</span> lbound_of <span class="free">x</span> <span class="free">y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lbound_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-lbound_ofD1"><span class="command">lemma</span></span> lbound_ofD1<span class="main">:</span> <span class="quoted"><span class="quoted">"lbound_of <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lbound_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-lbound_ofD2"><span class="command">lemma</span></span> lbound_ofD2<span class="main">:</span> <span class="quoted"><span class="quoted">"lbound_of <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lbound_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">glbound_in_of</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">glbound_in_of</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≡</span>
          <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span> lbound_of <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> lbound_of <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="bound">a</span> <span class="main">⟶</span> <span class="bound">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-glbound_in_ofI"><span class="command">lemma</span></span> glbound_in_ofI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> lbound_of <span class="free">x</span> <span class="free">y</span> <span class="free">b</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> lbound_of <span class="free">x</span> <span class="free">y</span> <span class="bound">a</span> <span class="main">⟹</span> <span class="bound">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span>
    glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> glbound_in_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-glbound_in_ofD_in"><span class="command">lemma</span></span> glbound_in_ofD_in<span class="main">:</span> <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> glbound_in_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-glbound_in_ofD_lbound"><span class="command">lemma</span></span> glbound_in_ofD_lbound<span class="main">:</span> <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> lbound_of <span class="free">x</span> <span class="free">y</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> glbound_in_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-glbound_in_ofD_glbound"><span class="command">lemma</span></span> glbound_in_ofD_glbound<span class="main">:</span>
  <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> lbound_of <span class="free">x</span> <span class="free">y</span> <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> glbound_in_of_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-glbound_in_of_less_eq1"><span class="command">lemma</span></span> glbound_in_of_less_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> glbound_in_ofD_lbound lbound_ofD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-glbound_in_of_less_eq2"><span class="command">lemma</span></span> glbound_in_of_less_eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> glbound_in_ofD_lbound lbound_ofD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudominimal_in_below_in_less_eq_glbound"><span class="command">lemma</span></span> pseudominimal_in_below_in_less_eq_glbound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">y</span><span class="main">)</span> <span class="free">w</span>"</span></span>
          <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms lbound_ofI glbound_in_ofD_glbound
        pseudominimal_inD1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span><span class="main">]</span> pseudominimal_inD1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">y</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ordering *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Simplex-like posets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Define a poset to be simplex-like if it is isomorphic to the power set of some set.›</span></span>

<span class="keyword1"><span class="command">context</span></span> ordering
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">simplex_like</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">simplex_like</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> finite <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∃</span><span class="bound">f</span> <span class="bound">A</span><span class="main">::</span>nat set<span class="main">.</span>
            OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">f</span> <span class="main">∧</span> <span class="bound">f</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">=</span> Pow <span class="bound">A</span>
          <span class="main">)</span>"</span></span>

<span class="keyword1" id="Prelim-simplex_likeI"><span class="command">lemma</span></span> simplex_likeI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> Pow <span class="main">(</span><span class="free">A</span><span class="main">::</span>nat set<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"simplex_like <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms simplex_like_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Prelim-simplex_likeD_finite"><span class="command">lemma</span></span> simplex_likeD_finite<span class="main">:</span> <span class="quoted"><span class="quoted">"simplex_like <span class="free">P</span> <span class="main">⟹</span> finite <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_like_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-simplex_likeD_iso"><span class="command">lemma</span></span> simplex_likeD_iso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"simplex_like <span class="free">P</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">f</span> <span class="bound">A</span><span class="main">::</span>nat set<span class="main">.</span> OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="bound">f</span> <span class="main">∧</span> <span class="bound">f</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> Pow <span class="bound">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_like_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Prelim-simplex_like_has_bottom"><span class="command">lemma</span></span> simplex_like_has_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"simplex_like <span class="free">P</span> <span class="main">⟹</span> has_bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_likeD_iso has_bottom_pow OrderingSetIso.pullback_has_bottom
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-simplex_like_no_pseudominimal_imp_singleton"><span class="command">lemma</span></span> simplex_like_no_pseudominimal_imp_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"simplex_like <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> pseudominimal_in <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">p</span><span class="main">.</span> <span class="free">P</span> <span class="main">=</span> <span class="main">{</span><span class="bound">p</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fA<span class="main">:</span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> Pow <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_likeD_iso<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≡</span> <span class="main">{}</span><span class="main">::</span> nat set"</span></span>
  <span class="keyword1"><span class="command">with</span></span> fA<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">`</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Pow_bottom <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">∈</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> order.pseudominimal_in <span class="main">(</span>Pow <span class="skolem">A</span><span class="main">)</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted">nat</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"order.pseudominimal_in <span class="main">(</span>Pow <span class="skolem">A</span><span class="main">)</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> fA<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">x</span><span class="main">}</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">`</span><span class="free">P</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.pseudominimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> assms fA simplex_like_has_bottom
            OrderingSetIso.pullback_pseudominimal_in
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> e fA<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> no_pseudominimal_in_pow_is_empty
          inj_on_to_singleton<span class="main">[</span><span class="operator">OF</span> OrderingSetIso.inj<span class="main">,</span> <span class="operator">OF</span> fA<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-simplex_like_no_pseudominimal_in_below_in_imp_singleton"><span class="command">lemma</span></span> simplex_like_no_pseudominimal_in_below_in_imp_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> simplex_like <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span><span class="main">;</span> <span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">¬</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="bound">z</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span> <span class="main">=</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_like_no_pseudominimal_imp_singleton below_in_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Prelim-pseudo_simplex_like_has_bottom"><span class="command">lemma</span></span> pseudo_simplex_like_has_bottom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> Pow <span class="free">A</span> <span class="main">⟹</span>
    has_bottom <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> has_bottom_pow OrderingSetIso.pullback_has_bottom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Prelim-pseudo_simplex_like_above_pseudominimal_is_top"><span class="command">lemma</span></span> pseudo_simplex_like_above_pseudominimal_is_top<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">P</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> pseudominimal_in <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">t</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">t</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">f</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">a</span><span class="main">}</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">f</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms pseudominimal_in_pow_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
            pseudo_simplex_like_has_bottom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
            OrderingSetIso.pullback_pseudominimal_in<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
            OrderingSetIso.ordsetmap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-pseudo_simplex_like_below_in_above_pseudominimal_is_top"><span class="command">lemma</span></span> pseudo_simplex_like_below_in_above_pseudominimal_is_top<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> Pow <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>1<span class="main">,</span>3-5<span class="main">)</span>
          pseudo_simplex_like_above_pseudominimal_is_top<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          below_in_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span> OrderingSetIso.ordsetmap<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
          inj_onD<span class="main">[</span><span class="operator">OF</span> OrderingSetIso.inj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Prelim-simplex_like_below_in_above_pseudominimal_is_top"><span class="command">lemma</span></span> simplex_like_below_in_above_pseudominimal_is_top<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"simplex_like <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms simplex_likeD_iso
        pseudo_simplex_like_below_in_above_pseudominimal_is_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">P</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ordering *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetIso<span class="main">)</span> simplex_like_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.simplex_like <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"codomain.simplex_like <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> gA<span class="main">:</span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">`</span><span class="free">P</span> <span class="main">=</span> Pow <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.simplex_likeD_iso<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> gA<span class="main">(</span>1<span class="main">)</span> inj
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>*)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>*)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>
            <span class="main">(</span><span class="skolem">g</span> <span class="main">∘</span> <span class="main">(</span>the_inv_into <span class="free">P</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OrderingSetIso.iso_comp<span class="main">[</span><span class="operator">OF</span> inv_iso<span class="main">]</span> the_inv_into_onto
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> gA<span class="main">(</span>2<span class="main">)</span> inj <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">g</span> <span class="main">∘</span> <span class="main">(</span>the_inv_into <span class="free">P</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> Pow <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_inv_into_onto <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.simplex_likeD_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> codomain.simplex_likeI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> OrderingSetIso<span class="main">)</span> pullback_simplex_like<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"codomain.simplex_like <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"domain.simplex_like <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'b</span> <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> gA<span class="main">:</span>  <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>*)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>*)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
               <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">`</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> Pow <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> codomain.simplex_likeD_iso<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> gA<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> iso_comp<span class="main">[</span><span class="operator">OF</span> gA<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> domain.simplex_likeI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Prelim-simplex_like_pow"><span class="command">lemma</span></span> simplex_like_pow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"order.simplex_like <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span>nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="skolem">f</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_imp_inj_to_nat_seg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"subset_ordering_iso <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="skolem">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_pow_fun_subset_ordering_iso <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> induced_pow_fun_surj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.simplex_likeI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The superset ordering›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supset_has_bottom</span>       <span class="main">≡</span> ordering.has_bottom       <span class="main">(⊇)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supset_bottom</span>           <span class="main">≡</span> ordering.bottom           <span class="main">(⊇)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supset_lbound_of</span>        <span class="main">≡</span> ordering.lbound_of        <span class="main">(⊇)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supset_glbound_in_of</span>    <span class="main">≡</span> ordering.glbound_in_of    <span class="main">(⊇)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supset_simplex_like</span>     <span class="main">≡</span> ordering.simplex_like     <span class="main">(⊇)</span> <span class="main">(⊃)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supset_pseudominimal_in</span> <span class="main">≡</span>
                ordering.pseudominimal_in <span class="main">(⊇)</span> <span class="main">(⊃)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">supset_below_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">.⊇</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main"><span class="free">.⊇</span></span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> ordering.below_in <span class="main">(⊇)</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Prelim-supset_poset"><span class="command">lemma</span></span> supset_poset<span class="main">:</span> <span class="quoted"><span class="quoted">"ordering <span class="main">(⊇)</span> <span class="main">(⊃)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> supset_bottomI            <span class="main">=</span> ordering.bottomI            <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_pseudominimal_inI  <span class="main">=</span> ordering.pseudominimal_inI  <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_pseudominimal_inD1 <span class="main">=</span> ordering.pseudominimal_inD1 <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_pseudominimal_inD2 <span class="main">=</span> ordering.pseudominimal_inD2 <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_lbound_ofI         <span class="main">=</span> ordering.lbound_ofI         <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_lbound_of_def      <span class="main">=</span> ordering.lbound_of_def      <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_glbound_in_ofI     <span class="main">=</span> ordering.glbound_in_ofI     <span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_pseudominimal_ne_bottom <span class="main">=</span>
  ordering.pseudominimal_ne_bottom<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_has_bottom_pseudominimal_in_below_inI <span class="main">=</span>
  ordering.has_bottom_pseudominimal_in_below_inI<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> supset_has_bottom_pseudominimal_in_below_in <span class="main">=</span>
  ordering.has_bottom_pseudominimal_in_below_in<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">]</span>

<span class="keyword1" id="Prelim-OrderingSetIso_pow_complement"><span class="command">lemma</span></span> OrderingSetIso_pow_complement<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main">(⊇)</span> <span class="main">(⊃)</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">(-)</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_minus_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OrderingSetIsoI_orders_greater2less<span class="main">)</span>

<span class="keyword1" id="Prelim-simplex_like_pow_above_in"><span class="command">lemma</span></span> simplex_like_pow_above_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">⊆</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"supset_simplex_like <span class="main">(</span><span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">.⊇</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> OrderingSetIso.pullback_simplex_like<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> OrderingSetIso.iso_subset<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> OrderingSetIso_pow_complement
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">.⊇</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>Pow <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(-)</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">.⊇</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> Pow <span class="main">(</span><span class="free">A</span><span class="main">-</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ordering.simplex_like <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span> <span class="main">(</span><span class="main">(-)</span> <span class="free">A</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">(</span>Pow <span class="free">A</span><span class="main">)</span><span class="main">.⊇</span><span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_like_pow
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Algebra">
<div class="head">
<h1>Theory Algebra</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section, we develop the necessary algebra for developing the theory of Coxeter systems,
  including groups, quotient groups, free groups, group presentations, and words in a group over a
  set of generators.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Algebra
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Prelim">Prelim</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Miscellaneous algebra facts›</span></span>

<span class="keyword1" id="Algebra-times2_conv_add"><span class="command">lemma</span></span> times2_conv_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">j</span><span class="main">::</span>nat<span class="main">)</span> <span class="main">+</span> <span class="free">j</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">*</span><span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> comm_semiring_1<span class="main">)</span> odd_n0<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">m</span> <span class="main">⟹</span> <span class="free">m</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> dvd_0_right <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> semigroup_add<span class="main">)</span> add_assoc4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">+</span> <span class="free">d</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span> <span class="main">+</span> <span class="free">c</span> <span class="main">+</span> <span class="free">d</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monoid_add<span class="main">)</span> sum_list_map_cong <span class="main">=</span>
  arg_cong<span class="main">[</span><span class="operator">OF</span> map_cong<span class="main">,</span> <span class="operator">OF</span> refl<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">sum_list</span><span class="main">]</span>

<span class="keyword1"><span class="command">context</span></span> group_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-map_uminus_order2"><span class="command">lemma</span></span> map_uminus_order2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">ss</span><span class="main">.</span> <span class="bound">s</span><span class="main">+</span><span class="bound">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> map <span class="main">(</span>uminus<span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_unique<span class="main">)</span>

<span class="keyword1" id="Algebra-uminus_sum_list"><span class="command">lemma</span></span> uminus_sum_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> sum_list <span class="free">as</span> <span class="main">=</span> sum_list <span class="main">(</span>map uminus <span class="main">(</span>rev <span class="free">as</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_add<span class="main">)</span>

<span class="keyword1" id="Algebra-uminus_sum_list_order2"><span class="command">lemma</span></span> uminus_sum_list_order2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">ss</span><span class="main">.</span> <span class="bound">s</span><span class="main">+</span><span class="bound">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="main">-</span> sum_list <span class="free">ss</span> <span class="main">=</span> sum_list <span class="main">(</span>rev <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_sum_list map_uminus_order2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context group_add *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The type of permutations of a type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we construct a type consisting of all bijective functions on a type. This is the
  prototypical example of a group, where the group operation is composition, and every group can
  be embedded into such a type. It is for this purpose that we construct this type, so that we may
  confer upon suitable subsets of types that are not of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> the properties of
  that class, via a suitable injective correspondence to this permutation type.
›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> permutation <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">.</span> bij <span class="bound">f</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> permutation Abs_permutation
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_permutation

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">permutation_apply</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> "</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 90<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> permutation <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">permutation_image</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">`→</span>"</span> 90<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main"><span class="free">`→</span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> permutation <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span>"</span></span>

<span class="keyword1" id="Algebra-permutation_eq_image"><span class="command">lemma</span></span> permutation_eq_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">`→</span> <span class="free">A</span> <span class="main">=</span> <span class="free">a</span> <span class="main">`→</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">=</span><span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> permutation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> inj_eq_image<span class="main">[</span><span class="operator">OF</span> bij_is_inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instantiation</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_permutation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"id<span class="main">::</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_permutation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span>    <span class="quoted"><span class="quoted">"comp"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_comp
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Algebra-plus_permutation_abs_eq"><span class="command">lemma</span></span> plus_permutation_abs_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">f</span> <span class="main">⟹</span> bij <span class="free">g</span> <span class="main">⟹</span>
    Abs_permutation <span class="free">f</span> <span class="main">+</span> Abs_permutation <span class="free">g</span> <span class="main">=</span> Abs_permutation <span class="main">(</span><span class="free">f</span><span class="main">∘</span><span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_permutation.abs_eq eq_onp_same_args<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">semigroup_add</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp_assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"permutation <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"permutation <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"permutation <span class="skolem">c</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">monoid_add</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">uminus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_permutation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span>    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> the_inv <span class="bound">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_the_inv_into
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_permutation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span>    <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∘</span> <span class="main">(</span>the_inv <span class="bound">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_the_inv_into bij_comp
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Algebra-minus_permutation_abs_eq"><span class="command">lemma</span></span> minus_permutation_abs_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij <span class="free">f</span> <span class="main">⟹</span> bij <span class="free">g</span> <span class="main">⟹</span>
    Abs_permutation <span class="free">f</span> <span class="main">-</span> Abs_permutation <span class="free">g</span> <span class="main">=</span> Abs_permutation <span class="main">(</span><span class="free">f</span> <span class="main">∘</span> the_inv <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_permutation.abs_eq eq_onp_same_args<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> permutation <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">group_add</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> the_inv_leftinv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"permutation <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">-</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">-</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Natural action of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">nat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on types of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> monoid_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Translation from class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> power<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we translate the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> power<span class="antiquote"><span class="antiquote">}</span></span></span></span> class to apply to types of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> monoid_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> nataction<span class="main">:</span> power <span class="quoted"><span class="main">0</span></span> <span class="quoted">plus</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">sublocale</span></span> add_mult_translate<span class="main">:</span> monoid_mult <span class="quoted"><span class="main">0</span></span> <span class="quoted">plus</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nataction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">+^</span>"</span> 80<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main"><span class="free">+^</span></span><span class="free"><span class="bound"><span class="entity">n</span></span></span>  <span class="main">≡</span> nataction.power <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> nataction_2    <span class="main">=</span> add_mult_translate.power2_eq_square
<span class="keyword1"><span class="command">lemmas</span></span> nataction_Suc2 <span class="main">=</span> add_mult_translate.power_Suc2

<span class="keyword1" id="Algebra-alternating_sum_list_conv_nataction"><span class="command">lemma</span></span> alternating_sum_list_conv_nataction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>alternating_list <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span><span class="main">+^</span><span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nataction_Suc2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-nataction_add_flip"><span class="command">lemma</span></span> nataction_add_flip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span><span class="main">+^</span><span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">a</span> <span class="main">+</span> <span class="main">(</span><span class="free">b</span><span class="main">+</span><span class="free">a</span><span class="main">)</span><span class="main">+^</span><span class="free">n</span> <span class="main">+</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nataction_Suc2 add.assoc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context monoid_add *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_add<span class="main">)</span> nataction_add_eq0_flip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span><span class="main">+^</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">b</span><span class="main">+</span><span class="free">a</span><span class="main">)</span><span class="main">+^</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nataction_add_flip add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">+</span><span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">+</span><span class="free">b</span><span class="main">)</span><span class="main">+^</span><span class="skolem">k</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Additive order of an element›</span></span>

<span class="keyword1"><span class="command">context</span></span> monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">add_order</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">add_order</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span>
          <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>

<span class="keyword1" id="Algebra-add_order"><span class="command">lemma</span></span> add_order<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">+^</span><span class="main">(</span>add_order <span class="free">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">]</span> add_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-add_order_least"><span class="command">lemma</span></span> add_order_least<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">+^</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> add_order <span class="free">a</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">]</span> add_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-add_order_equality"><span class="command">lemma</span></span> add_order_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">n</span><span class="main">&gt;</span><span class="main">0</span><span class="main">;</span> <span class="free">a</span><span class="main">+^</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">;</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">m</span><span class="main">.</span> <span class="bound">m</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">+^</span><span class="bound">m</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">≤</span><span class="bound">m</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    add_order <span class="free">a</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Least_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">]</span> add_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-add_order0"><span class="command">lemma</span></span> add_order0<span class="main">:</span> <span class="quoted"><span class="quoted">"add_order <span class="main">0</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order_equality <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-add_order_gt0"><span class="command">lemma</span></span> add_order_gt0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>add_order <span class="free">a</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">]</span> add_order_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-add_order_eq0"><span class="command">lemma</span></span> add_order_eq0<span class="main">:</span> <span class="quoted"><span class="quoted">"add_order <span class="free">a</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">+^</span><span class="free">n</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order_gt0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Algebra-less_add_order_eq_0"><span class="command">lemma</span></span> less_add_order_eq_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">+^</span><span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> add_order <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">n</span></span><span class="main">&gt;</span><span class="main">0</span><span class="main">.</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms add_order_def not_less_Least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">∧</span> <span class="free">a</span><span class="main">+^</span><span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-less_add_order_eq_0_contra"><span class="command">lemma</span></span> less_add_order_eq_0_contra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&gt;</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">&lt;</span> add_order <span class="free">a</span> <span class="main">⟹</span> <span class="free">a</span><span class="main">+^</span><span class="free">k</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> less_add_order_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-add_order_relator"><span class="command">lemma</span></span> add_order_relator<span class="main">:</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">a</span><span class="main">+^</span><span class="main">(</span>add_order <span class="free">a</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_order_equality<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pair_relator_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair_relator_list</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> alternating_list <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>add_order <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pair_relator_halflist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair_relator_halflist</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> alternating_list <span class="main">(</span>add_order <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pair_relator_halflist2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair_relator_halflist2</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span>
    <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>add_order <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> pair_relator_halflist <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">else</span>
      pair_relator_halflist <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-sum_list_pair_relator_list"><span class="command">lemma</span></span> sum_list_pair_relator_list<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>pair_relator_list <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_order alternating_sum_list_conv_nataction<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context monoid_add *)</span>

<span class="keyword1"><span class="command">context</span></span> group_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-add_order_add_eq1"><span class="command">lemma</span></span> add_order_add_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="main">-</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_unique<span class="main">)</span>

<span class="keyword1" id="Algebra-add_order_add_sym"><span class="command">lemma</span></span> add_order_add_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">t</span><span class="main">+</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">t</span><span class="main">+</span><span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> one <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order nataction_add_eq0_flip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> add_order_eq0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> other <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order nataction_add_eq0_flip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> add_order_eq0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> neither <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">t</span>"</span></span><span class="main">]</span> add_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">+</span><span class="free">s</span>"</span></span><span class="main">]</span>
          nataction_add_eq0_flip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> nataction_add_eq0_flip<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
          add_order_least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span>"</span></span><span class="main">]</span> add_order_least<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">t</span><span class="main">+</span><span class="free">s</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-pair_relator_halflist_append"><span class="command">lemma</span></span> pair_relator_halflist_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pair_relator_halflist <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> pair_relator_halflist2 <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> pair_relator_list <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> alternating_list_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times2_conv_add add_order_add_sym<span class="main">)</span>

<span class="keyword1" id="Algebra-rev_pair_relator_list"><span class="command">lemma</span></span> rev_pair_relator_list<span class="main">:</span> <span class="quoted"><span class="quoted">"rev <span class="main">(</span>pair_relator_list <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> pair_relator_list <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>rev_alternating_list add_order_add_sym<span class="main">)</span>

<span class="keyword1" id="Algebra-pair_relator_halflist2_conv_rev_pair_relator_halflist"><span class="command">lemma</span></span> pair_relator_halflist2_conv_rev_pair_relator_halflist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pair_relator_halflist2 <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> rev <span class="main">(</span>pair_relator_halflist <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_order_add_sym rev_alternating_list<span class="main">)</span>
 
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context group_add *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial sums of a list›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we construct a list that collects the results of adding the elements of a given list
  together one-by-one.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sums</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">sums</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sums</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> map <span class="main">(</span><span class="main">(+)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">sums</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-length_sums"><span class="command">lemma</span></span> length_sums<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>sums <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-sums_snoc"><span class="command">lemma</span></span> sums_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"sums <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sums <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>sum_list <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="Algebra-sums_append2"><span class="command">lemma</span></span> sums_append2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sums <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> butlast <span class="main">(</span>sums <span class="free">xs</span><span class="main">)</span> <span class="main">@</span> map <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>sum_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sums_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">@</span><span class="skolem">ys</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-sums_Cons_conv_append_tl"><span class="command">lemma</span></span> sums_Cons_conv_append_tl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sums <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">#</span> <span class="free">x</span> <span class="main">#</span> map <span class="main">(</span><span class="main">(+)</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">(</span>sums <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-pullback_sums_map_middle2"><span class="command">lemma</span></span> pullback_sums_map_middle2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">,</span><span class="free">e</span><span class="main">]</span><span class="main">@</span><span class="free">es</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">as</span> <span class="bound">a</span> <span class="bound">bs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span> <span class="main">∧</span> map <span class="free">F</span> <span class="main">(</span>sums <span class="bound">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span> <span class="main">∧</span>
      <span class="free">d</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span> <span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil2 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> Nil2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">with</span></span> Nil2<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> ys y <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">@</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">zs</span> <span class="skolem">z</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="skolem">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>1<span class="main">)</span> ys y snoc <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">@</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="main">(</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">z</span><span class="main">]</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-pullback_sums_map_middle3"><span class="command">lemma</span></span> pullback_sums_map_middle3<span class="main">:</span>
  <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">,</span><span class="free">e</span><span class="main">,</span><span class="free">f</span><span class="main">]</span><span class="main">@</span><span class="free">fs</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">as</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">bs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
      <span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">fs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil2 <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> Nil2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Nil2 <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">,</span><span class="free">e</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> y<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> asabs<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="skolem">as</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">]</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">d</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="skolem">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pullback_sums_map_middle2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="free">ds</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> y<span class="main">(</span>1<span class="main">)</span> asabs<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_append2 map_butlast length_sums<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> snoc asabs<span class="main">(</span>1<span class="main">)</span> y<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">y</span><span class="main">]</span><span class="main">@</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> asabs<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> snoc <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-pullback_sums_map_double_middle2"><span class="command">lemma</span></span> pullback_sums_map_double_middle2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">,</span><span class="free">e</span><span class="main">]</span><span class="main">@</span><span class="free">es</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">]</span><span class="main">@</span><span class="free">gs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">as</span> <span class="bound">a</span> <span class="bound">bs</span> <span class="bound">b</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">@</span><span class="bound">cs</span> <span class="main">∧</span> <span class="free">d</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="bound">as</span><span class="main">)</span> <span class="main">∧</span>
            <span class="free">e</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">f</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
            <span class="free">g</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Asbcs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">F</span> <span class="main">(</span>sums <span class="skolem">As</span><span class="main">)</span> <span class="main">=</span> <span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">,</span><span class="free">e</span><span class="main">]</span><span class="main">@</span><span class="free">es</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">]</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="skolem">As</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">=</span> <span class="free">F</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pullback_sums_map_middle2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"<span class="free">ds</span><span class="main">@</span><span class="main">[</span><span class="free">d</span><span class="main">,</span><span class="free">e</span><span class="main">]</span><span class="main">@</span><span class="free">es</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> Asbcs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pullback_sums_map_middle2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="skolem">As</span></span> <span class="quoted"><span class="free">ds</span></span> <span class="quoted"><span class="free">d</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="quoted">"<span class="free">es</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context monoid_add *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Sums of alternating lists›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> group_add<span class="main">)</span> uminus_sum_list_alternating_order2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="main">-</span> sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
    sum_list <span class="main">(</span><span class="keyword1">if</span> even <span class="free">n</span> <span class="keyword1">then</span> alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span> <span class="keyword1">else</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_sum_list_order2 set_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> rev_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">context</span></span> monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-alternating_order2_cancel_1left"><span class="command">lemma</span></span> alternating_order2_cancel_1left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span>
    sum_list <span class="main">(</span><span class="free">s</span> <span class="main">#</span> <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-alternating_order2_cancel_2left"><span class="command">lemma</span></span> alternating_order2_cancel_2left<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span>
    sum_list <span class="main">(</span><span class="free">t</span> <span class="main">#</span> <span class="free">s</span> <span class="main">#</span> <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_order2_cancel_1left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">n</span>"</span></span><span class="main">]</span>
          alternating_order2_cancel_1left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Algebra-alternating_order2_even_cancel_right"><span class="command">lemma</span></span> alternating_order2_even_cancel_right<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st    <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     even_n<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">m</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> alternating_list <span class="free">m</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span>
            sum_list <span class="main">(</span>alternating_list <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_even_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> even_n<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SucSuc <span class="skolem">k</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> st <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_order2_cancel_2left<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_cases_2Suc<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context monoid_add *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Conjugation in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Abbreviations and basic facts›</span></span>

<span class="keyword1"><span class="command">context</span></span> group_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">lconjby</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lconjby</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">rconjby</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rconjby</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">-</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">+</span><span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Algebra-lconjby_add"><span class="command">lemma</span></span> lconjby_add<span class="main">:</span> <span class="quoted"><span class="quoted">"lconjby <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> lconjby <span class="free">x</span> <span class="main">(</span>lconjby <span class="free">y</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-rconjby_add"><span class="command">lemma</span></span> rconjby_add<span class="main">:</span> <span class="quoted"><span class="quoted">"rconjby <span class="main">(</span><span class="free">x</span><span class="main">+</span><span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> rconjby <span class="free">y</span> <span class="main">(</span>rconjby <span class="free">x</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_add add.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-add_rconjby"><span class="command">lemma</span></span> add_rconjby<span class="main">:</span> <span class="quoted"><span class="quoted">"rconjby <span class="free">x</span> <span class="free">y</span> <span class="main">+</span> rconjby <span class="free">x</span> <span class="free">z</span> <span class="main">=</span> rconjby <span class="free">x</span> <span class="main">(</span><span class="free">y</span><span class="main">+</span><span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>

<span class="keyword1" id="Algebra-lconjby_uminus"><span class="command">lemma</span></span> lconjby_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"lconjby <span class="free">x</span> <span class="main">(</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> lconjby <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> minus_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lconjby <span class="free">x</span> <span class="free">y</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-rconjby_uminus"><span class="command">lemma</span></span> rconjby_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"rconjby <span class="free">x</span> <span class="main">(</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> rconjby <span class="free">x</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> minus_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rconjby <span class="free">x</span> <span class="free">y</span>"</span></span><span class="main">]</span> add_assoc4<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rconjby <span class="free">x</span> <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-lconjby_rconjby"><span class="command">lemma</span></span> lconjby_rconjby<span class="main">:</span> <span class="quoted"><span class="quoted">"lconjby <span class="free">x</span> <span class="main">(</span>rconjby <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-rconjby_lconjby"><span class="command">lemma</span></span> rconjby_lconjby<span class="main">:</span> <span class="quoted"><span class="quoted">"rconjby <span class="free">x</span> <span class="main">(</span>lconjby <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-lconjby_inj"><span class="command">lemma</span></span> lconjby_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>lconjby <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rconjby_lconjby <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_inverseI<span class="main">)</span>

<span class="keyword1" id="Algebra-rconjby_inj"><span class="command">lemma</span></span> rconjby_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>rconjby <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lconjby_rconjby <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_inverseI<span class="main">)</span>

<span class="keyword1" id="Algebra-lconjby_surj"><span class="command">lemma</span></span> lconjby_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span>lconjby <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lconjby_rconjby surjI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lconjby <span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-lconjby_bij"><span class="command">lemma</span></span> lconjby_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>lconjby <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_def <span class="keyword1"><span class="command">using</span></span> lconjby_inj lconjby_surj <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-the_inv_lconjby"><span class="command">lemma</span></span> the_inv_lconjby<span class="main">:</span> <span class="quoted"><span class="quoted">"the_inv <span class="main">(</span>lconjby <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rconjby <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> lconjby_bij<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> lconjby_rconjby
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> lconjby_inj<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-lconjby_eq_conv_rconjby_eq"><span class="command">lemma</span></span> lconjby_eq_conv_rconjby_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> lconjby <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> rconjby <span class="free">x</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the_inv_lconjby the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> lconjby_inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Algebra-rconjby_order2"><span class="command">lemma</span></span> rconjby_order2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> rconjby <span class="free">x</span> <span class="free">s</span> <span class="main">+</span> rconjby <span class="free">x</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_rconjby<span class="main">)</span>

<span class="keyword1" id="Algebra-rconjby_order2_eq_lconjby"><span class="command">lemma</span></span> rconjby_order2_eq_lconjby<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"rconjby <span class="free">s</span> <span class="main">=</span> lconjby <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rconjby <span class="free">s</span> <span class="main">=</span> lconjby <span class="main">(</span><span class="main">-</span><span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> minus_unique <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-lconjby_alternating_list_order2"><span class="command">lemma</span></span> lconjby_alternating_list_order2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lconjby <span class="main">(</span>sum_list <span class="main">(</span>alternating_list <span class="free">k</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
            sum_list <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">k</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_induct_step2<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SucSuc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lconjby <span class="main">(</span>sum_list <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>
          <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">s</span> <span class="main">+</span> <span class="free">t</span> <span class="main">+</span>
          lconjby <span class="main">(</span>sum_list <span class="main">(</span>alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">m</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">t</span><span class="main">)</span> <span class="main">-</span> <span class="free">t</span> <span class="main">-</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_list_SucSuc_ConsCons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> assms SucSuc
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sum_list <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_list_SucSuc_ConsCons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
          sum_list.append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"alternating_list <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context group_add *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The conjugation sequence›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Given a list in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>, we create a new list by conjugating each term by all the
  previous terms. This sequence arises in Coxeter systems.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> group_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">lconjseq</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">lconjseq</span> <span class="main">[]</span>     <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">lconjseq</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span>map <span class="main">(</span>lconjby <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">lconjseq</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-length_lconjseq"><span class="command">lemma</span></span> length_lconjseq<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>lconjseq <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-lconjseq_snoc"><span class="command">lemma</span></span> lconjseq_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"lconjseq <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> lconjseq <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span>lconjby <span class="main">(</span>sum_list <span class="free">xs</span><span class="main">)</span> <span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjby_add<span class="main">)</span>

<span class="keyword1" id="Algebra-lconjseq_append"><span class="command">lemma</span></span> lconjseq_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"lconjseq <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> lconjseq <span class="free">xs</span> <span class="main">@</span> <span class="main">(</span>map <span class="main">(</span>lconjby <span class="main">(</span>sum_list <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>lconjseq <span class="free">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lconjseq_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">@</span><span class="skolem">ys</span>"</span></span><span class="main">]</span> lconjseq_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjby_add<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-lconjseq_alternating_order2_repeats'"><span class="command">lemma</span></span> lconjseq_alternating_order2_repeats'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">s</span> <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> altst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">altst</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> alternating_list <span class="bound">n</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     altts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">altts</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> alternating_list <span class="bound">n</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span><span class="main">+^</span><span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"map <span class="main">(</span>lconjby <span class="main">(</span>sum_list <span class="main">(</span><span class="free">altst</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>lconjseq <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">altst</span> <span class="free">m</span> <span class="keyword1">else</span> <span class="free">altts</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lconjseq <span class="main">(</span><span class="free">altst</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> altst altts
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"map <span class="main">(</span>lconjby <span class="main">(</span>sum_list <span class="main">(</span><span class="free">altst</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>lconjseq <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">altst</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">altts</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            lconjseq <span class="main">(</span><span class="free">altst</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">@</span>
            <span class="main">[</span>lconjby <span class="main">(</span>sum_list <span class="main">(</span><span class="free">altst</span> <span class="free">k</span> <span class="main">@</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">altst</span> <span class="skolem">j</span> <span class="keyword1">else</span> <span class="free">altts</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">j</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">t</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">j</span> <span class="keyword1">then</span> <span class="free">t</span> <span class="keyword1">else</span> <span class="free">s</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjseq_snoc lconjby_add<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> altst altts st<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> lconjseq <span class="main">(</span><span class="free">altst</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>sum_list <span class="main">(</span><span class="free">altst</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="main">(</span><span class="free">k</span><span class="main">+</span><span class="skolem">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lconjby_alternating_list_order2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">+</span><span class="skolem">j</span>"</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">k</span>"</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alternating_list_append<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> altst st
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            alternating_list_append<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
            alternating_sum_list_conv_nataction
            lconjby_alternating_list_order2 lconjseq_snoc
          <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> altst altts<span class="main">)</span>

<span class="keyword1" id="Algebra-lconjseq_alternating_order2_repeats"><span class="command">lemma</span></span> lconjseq_alternating_order2_repeats<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">s</span> <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">k</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">defines</span></span> altst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">altst</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> alternating_list <span class="bound">n</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     altts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">altts</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">n</span><span class="main">.</span> alternating_list <span class="bound">n</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span><span class="main">+^</span><span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"lconjseq <span class="main">(</span><span class="free">altst</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lconjseq <span class="main">(</span><span class="free">altst</span> <span class="free">k</span><span class="main">)</span> <span class="main">@</span> lconjseq <span class="main">(</span><span class="free">altst</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> altst altts
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lconjseq <span class="main">(</span><span class="free">altst</span> <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> lconjseq <span class="main">(</span><span class="free">altst</span> <span class="free">k</span><span class="main">)</span> <span class="main">@</span>
            map <span class="main">(</span>lconjby <span class="main">(</span>sum_list <span class="main">(</span><span class="free">altst</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
              <span class="main">(</span>lconjseq <span class="main">(</span><span class="keyword1">if</span> even <span class="free">k</span> <span class="keyword1">then</span> <span class="free">altst</span> <span class="free">k</span> <span class="keyword1">else</span> <span class="free">altts</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_list_append<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">s</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">t</span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times2_conv_add lconjseq_append<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> altst altts st <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> lconjseq_alternating_order2_repeats'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-even_count_lconjseq_alternating_order2"><span class="command">lemma</span></span> even_count_lconjseq_alternating_order2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">s</span> <span class="free">t</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">+</span><span class="free">t</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span><span class="main">+^</span><span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"even <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="main">(</span>alternating_list <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≡</span> lconjseq <span class="main">(</span>alternating_list <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">k</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="skolem">as</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lconjseq_alternating_order2_repeats <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count_list <span class="skolem">xs</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="main">(</span>count_list <span class="skolem">as</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_list_append times2_conv_add<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> xs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-order2_hd_in_lconjseq_deletion"><span class="command">lemma</span></span> order2_hd_in_lconjseq_deletion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">∈</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>
            <span class="main">⟹</span> <span class="main">∃</span><span class="bound">as</span> <span class="bound">b</span> <span class="bound">bs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span> <span class="main">∧</span> sum_list <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="bound">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">t</span> <span class="skolem">ts</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> set <span class="main">(</span>lconjseq <span class="skolem">ts</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> snoc<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">bs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span>   asbbs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> asbbs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">(</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list.append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span><span class="main">]</span> sum_list.append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> asbbs<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> snoc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> lconjby <span class="main">(</span>sum_list <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjseq_snoc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">+</span><span class="skolem">t</span><span class="main">=</span><span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lconjby_eq_conv_rconjby_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            rconjby_order2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ts</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> s <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="skolem">ts</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">+</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ts</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">-</span> sum_list <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ts</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context group_add *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The action on signed <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> elements›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we construct an action of a group on itself by conjugation, where group elements are
  endowed with an auxiliary sign by pairing with a boolean element. In multiple applications of
  this action, the auxiliary sign helps keep track of how many times the elements conjugating and
  being conjugated are the same. This action arises in exploring reduced expressions of group
  elements as words in a set of generators of order two (in particular, in a Coxeter group).
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> signed <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">×</span>bool"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">signed_funaction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'a</span> signed"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">signed_funaction</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> map_prod <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">≠</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="comment1">― ‹so the sign of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">x</span></span><span class="antiquote">}</span></span> is flipped precisely when its first component is equal to
<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">s</span></span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">context</span></span> group_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">signed_lconjaction</span> <span class="main">≡</span> signed_funaction lconjby"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">signed_rconjaction</span> <span class="main">≡</span> signed_funaction rconjby"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> signed_lconjactionD <span class="main">=</span> signed_funaction_def<span class="main">[</span><span class="operator">of</span> <span class="quoted">lconjby</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> signed_rconjactionD <span class="main">=</span> signed_funaction_def<span class="main">[</span><span class="operator">of</span> <span class="quoted">rconjby</span><span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">signed_lconjpermutation</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> signed permutation"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">signed_lconjpermutation</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Abs_permutation <span class="main">(</span>signed_lconjaction <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">signed_list_lconjaction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'a</span> signed"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">signed_list_lconjaction</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">≡</span> foldr signed_lconjaction <span class="free"><span class="bound"><span class="entity">ss</span></span></span>"</span></span>

<span class="keyword1" id="Algebra-signed_lconjaction_fst"><span class="command">lemma</span></span> signed_lconjaction_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>signed_lconjaction <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> lconjby <span class="free">s</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> signed_lconjactionD <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-signed_lconjaction_rconjaction"><span class="command">lemma</span></span> signed_lconjaction_rconjaction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"signed_lconjaction <span class="free">s</span> <span class="main">(</span>signed_rconjaction <span class="free">s</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span><span class="main">::</span><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">b</span></span><span class="main">::</span><span class="quoted">bool</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> signed_lconjactionD signed_rconjactionD injD<span class="main">[</span><span class="operator">OF</span> rconjby_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
          lconjby_rconjby<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-signed_rconjaction_by_order2_eq_lconjaction"><span class="command">lemma</span></span> signed_rconjaction_by_order2_eq_lconjaction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> signed_rconjaction <span class="free">s</span> <span class="main">=</span> signed_lconjaction <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> signed_funaction_def<span class="main">[</span><span class="operator">of</span> <span class="quoted">lconjby</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> signed_funaction_def<span class="main">[</span><span class="operator">of</span> <span class="quoted">rconjby</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        rconjby_order2_eq_lconjby<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Algebra-inj_signed_lconjaction"><span class="command">lemma</span></span> inj_signed_lconjaction<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span>signed_lconjaction <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"signed_lconjaction <span class="free">s</span> <span class="skolem">x</span> <span class="main">=</span> signed_lconjaction <span class="free">s</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">b1</span></span> <span class="skolem"><span class="skolem">b2</span></span> <span class="main">::</span> <span class="quoted">bool</span>
    <span class="keyword2"><span class="keyword">where</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a1</span><span class="main">,</span><span class="skolem">b1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a2</span><span class="main">,</span><span class="skolem">b2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> injD<span class="main">[</span><span class="operator">OF</span> lconjby_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">a1</span></span> <span class="quoted"><span class="skolem">a2</span></span><span class="main">]</span> signed_lconjactionD 
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span><span class="main">=</span><span class="free">s</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-surj_signed_lconjaction"><span class="command">lemma</span></span> surj_signed_lconjaction<span class="main">:</span> <span class="quoted"><span class="quoted">"surj <span class="main">(</span>signed_lconjaction <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> signed_lconjaction_rconjaction<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-bij_signed_lconjaction"><span class="command">lemma</span></span> bij_signed_lconjaction<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="main">(</span>signed_lconjaction <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_signed_lconjaction surj_signed_lconjaction <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bijI<span class="main">)</span>

<span class="keyword1" id="Algebra-the_inv_signed_lconjaction"><span class="command">lemma</span></span> the_inv_signed_lconjaction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"the_inv <span class="main">(</span>signed_lconjaction <span class="free">s</span><span class="main">)</span> <span class="main">=</span> signed_rconjaction <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the_inv <span class="main">(</span>signed_lconjaction <span class="free">s</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> signed_rconjaction <span class="free">s</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_inv_into_f_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_signed_lconjaction<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"signed_lconjaction <span class="free">s</span> <span class="main">(</span>signed_rconjaction <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> signed_lconjaction_rconjaction <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> surj_signed_lconjaction<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-the_inv_signed_lconjaction_by_order2"><span class="command">lemma</span></span> the_inv_signed_lconjaction_by_order2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> the_inv <span class="main">(</span>signed_lconjaction <span class="free">s</span><span class="main">)</span> <span class="main">=</span> signed_lconjaction <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the_inv_signed_lconjaction signed_rconjaction_by_order2_eq_lconjaction
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Algebra-signed_list_lconjaction_fst"><span class="command">lemma</span></span> signed_list_lconjaction_fst<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>signed_list_lconjaction <span class="free">ss</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> lconjby <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> signed_lconjaction_fst lconjby_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-signed_list_lconjaction_snd"><span class="command">lemma</span></span> signed_list_lconjaction_snd<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">ss</span><span class="main">.</span> <span class="bound">s</span><span class="main">+</span><span class="bound">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> snd <span class="main">(</span>signed_list_lconjaction <span class="free">ss</span> <span class="free">x</span><span class="main">)</span>
          <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> snd <span class="free">x</span> <span class="keyword1">else</span> <span class="main">¬</span>snd <span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword1"><span class="command">hence</span></span> prevcase<span class="main">:</span>
    <span class="quoted"><span class="quoted">"snd <span class="main">(</span>signed_list_lconjaction <span class="skolem">ss</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> snd <span class="free">x</span> <span class="keyword1">else</span> <span class="main">¬</span> snd <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>signed_list_lconjaction <span class="main">(</span><span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
            snd <span class="main">(</span>signed_lconjaction <span class="skolem">s</span> <span class="main">(</span>signed_list_lconjaction <span class="skolem">ss</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>signed_list_lconjaction <span class="skolem">ss</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 1 prevcase
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>signed_list_lconjaction <span class="main">(</span><span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">¬</span> snd <span class="free">x</span> <span class="keyword1">else</span> snd <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> signed_lconjactionD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
              signed_list_lconjaction_fst lconjby_eq_conv_rconjby_eq
              uminus_sum_list_order2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> lconjseq_snoc count_list_snoc
            <span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rconjby <span class="main">(</span>sum_list <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>lconjby <span class="main">(</span>sum_list <span class="skolem">ss</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span>
            rconjby <span class="main">(</span>sum_list <span class="skolem">ss</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> signed_list_lconjaction_fst<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
              count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
              rconjby_lconjby uminus_sum_list_order2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
              lconjseq_snoc count_list_snoc
            <span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False 1 prevcase
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>signed_list_lconjaction <span class="main">(</span><span class="skolem">s</span> <span class="main">#</span> <span class="skolem">ss</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
              <span class="main">(</span><span class="keyword1">if</span> even <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span> snd <span class="free">x</span> <span class="keyword1">else</span> <span class="main">¬</span> snd <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> signed_lconjactionD<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context group_add *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cosets›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Basic facts›</span></span>

<span class="keyword1" id="Algebra-set_zero_plus'"><span class="command">lemma</span></span> set_zero_plus' <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> <span class="keyword1">+o</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="comment1">― ‹lemma <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"Set_Algebras.set_zero_plus"</span><span class="antiquote">}</span></span> is restricted to types of class
<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">class</span> comm_monoid_add<span class="antiquote">}</span></span>; here is a version in <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">class</span> monoid_add<span class="antiquote">}</span></span>.›</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elt_set_plus_def<span class="main">)</span>

<span class="keyword1" id="Algebra-lcoset_0"><span class="command">lemma</span></span> lcoset_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> <span class="keyword1">+o</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-lcoset_refl"><span class="command">lemma</span></span> lcoset_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>monoid_add<span class="main">)</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Algebra-lcoset_eq_reps_subset"><span class="command">lemma</span></span> lcoset_eq_reps_subset<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>group_add<span class="main">)</span> <span class="keyword1">+o</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-lcoset_eq_reps"><span class="command">lemma</span></span> lcoset_eq_reps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>group_add<span class="main">)</span> <span class="keyword1">+o</span> <span class="free">A</span> <span class="main">=</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">B</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_eq_reps_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> lcoset_eq_reps_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-lcoset_inj_on"><span class="command">lemma</span></span> lcoset_inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj <span class="main">(</span><span class="keyword1">(+o)</span> <span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>group_add<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_eq_reps inj_onI<span class="main">[</span><span class="operator">of</span> <span class="quoted">UNIV</span> <span class="quoted"><span class="quoted">"<span class="keyword1">(+o)</span> <span class="free">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-lcoset_conv_set"><span class="command">lemma</span></span> lcoset_conv_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">::</span><span class="tfree">'g</span><span class="main">::</span>group_add<span class="main">)</span> <span class="main">∈</span> <span class="free">b</span> <span class="keyword1">+o</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">-</span><span class="free">b</span> <span class="main">+</span> <span class="free">a</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> elt_set_plus_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The supset order on cosets›</span></span>

<span class="keyword1" id="Algebra-supset_lbound_lcoset_shift"><span class="command">lemma</span></span> supset_lbound_lcoset_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"supset_lbound_of <span class="free">X</span> <span class="free">Y</span> <span class="free">B</span> <span class="main">⟹</span>
    ordering.lbound_of <span class="main">(⊇)</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">+o</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">+o</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">+o</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ordering.lbound_of_def<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ordering.lbound_ofI supset_poset<span class="main">)</span>

<span class="keyword1" id="Algebra-supset_glbound_in_of_lcoset_shift"><span class="command">lemma</span></span> supset_glbound_in_of_lcoset_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>group_add set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supset_glbound_in_of <span class="free">P</span> <span class="free">X</span> <span class="free">Y</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"supset_glbound_in_of <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">a</span> <span class="main">`</span> <span class="free">P</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">+o</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">+o</span> <span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="keyword1">+o</span> <span class="free">B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   ordering.glbound_in_ofD_in<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
          ordering.glbound_in_ofD_lbound<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
          supset_lbound_lcoset_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
          supset_lbound_lcoset_shift<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">+o</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">+o</span> <span class="free">Y</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span>"</span></span><span class="main">]</span>
          ordering.glbound_in_ofD_glbound<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">,</span> <span class="operator">OF</span> assms<span class="main">]</span>
          ordering.glbound_in_ofI<span class="main">[</span>
            <span class="operator">OF</span> supset_poset<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">+o</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(+o)</span> <span class="free">a</span> <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">+o</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">+o</span> <span class="free">Y</span>"</span></span>
          <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_plus_rearrange2<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The afforded partition›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lcoset_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>uminus<span class="main">,</span>plus<span class="main">}</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">lcoset_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">-</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Algebra-lcoset_relI"><span class="command">lemma</span></span> lcoset_relI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">x</span><span class="main">+</span><span class="free">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Groups›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We consider groups as closed sets in a type of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span>    Group <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">::</span>group_add set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     diff_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">h</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">-</span> <span class="bound">h</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Subgroup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Subgroup</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> Group <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>

<span class="keyword1" id="Algebra-SubgroupD1"><span class="command">lemma</span></span> SubgroupD1<span class="main">:</span> <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span> <span class="main">⟹</span> Group <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-zero_closed"><span class="command">lemma</span></span> zero_closed <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">-</span> <span class="skolem">g</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-uminus_closed"><span class="command">lemma</span></span> uminus_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="main">-</span><span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_closed diff_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-add_closed"><span class="command">lemma</span></span> add_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">g</span><span class="main">+</span><span class="free">h</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> diff_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">h</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-uminus_add_closed"><span class="command">lemma</span></span> uminus_add_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">-</span><span class="free">g</span> <span class="main">+</span> <span class="free">h</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_closed add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-lconjby_closed"><span class="command">lemma</span></span> lconjby_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> lconjby <span class="free">g</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_closed diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-lconjby_set_closed"><span class="command">lemma</span></span> lconjby_set_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">⊆</span><span class="free">G</span> <span class="main">⟹</span> lconjby <span class="free">g</span> <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lconjby_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-set_lconjby_subset_closed"><span class="command">lemma</span></span> set_lconjby_subset_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">⊆</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">⊆</span><span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">h</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> lconjby <span class="bound">h</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lconjby_set_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-sum_list_map_closed"><span class="command">lemma</span></span> sum_list_map_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span><span class="free">as</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_closed add_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-sum_list_closed"><span class="command">lemma</span></span> sum_list_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">as</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> sum_list <span class="free">as</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_map_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Group *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Sets with a suitable binary operation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We have chosen to only consider groups in types of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> so that we can take
  advantage of all the algebra lemmas already proven in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="../../HOL/HOL/Groups.html"></a><a href="../../HOL/HOL/Groups.html">HOL.Groups</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>, as well as
  constructs like <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sum_list<span class="antiquote"><span class="antiquote">}</span></span></span></span>. The following locale builds a bridge between this restricted
  view of groups and the usual notion of a binary operation on a set satisfying the group axioms,
  by constructing an injective map into type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> permutation<span class="antiquote"><span class="antiquote">}</span></span></span></span> (which is of class
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> with respect to the composition operation) that respects the group operation.
  This bridge will be necessary to define quotient groups, in particular.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> BinOpSetGroup <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">G</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">binop</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">e</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> closed  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">binop</span> <span class="free">g</span> <span class="free">h</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     assoc   <span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">g</span><span class="main">∈</span><span class="free">G</span><span class="main">;</span> <span class="free">h</span><span class="main">∈</span><span class="free">G</span><span class="main">;</span> <span class="free">k</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">binop</span> <span class="main">(</span><span class="free">binop</span> <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> <span class="free">binop</span> <span class="free">g</span> <span class="main">(</span><span class="free">binop</span> <span class="free">h</span> <span class="free">k</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     identity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">binop</span> <span class="free">g</span> <span class="free">e</span> <span class="main">=</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">binop</span> <span class="free">e</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     inverses<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">binop</span> <span class="free">g</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">binop</span> <span class="bound">h</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-unique_identity1"><span class="command">lemma</span></span> unique_identity1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">binop</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> identity<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-unique_inverse"><span class="command">lemma</span></span> unique_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">∧</span> <span class="free">binop</span> <span class="free">g</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">binop</span> <span class="bound">h</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">.</span> <span class="bound">h</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">∧</span> <span class="free">binop</span> <span class="free">g</span> <span class="bound">h</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">binop</span> <span class="bound">h</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inverses <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">∧</span> <span class="free">binop</span> <span class="free">g</span> <span class="skolem">h</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">binop</span> <span class="skolem">h</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">∈</span><span class="free">G</span> <span class="main">∧</span>
            <span class="free">binop</span> <span class="free">g</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">binop</span> <span class="skolem">k</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="skolem">h</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="skolem">h</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="skolem">k</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="skolem">k</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms h<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> k<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">=</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> identity<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">G_perm</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> restrict1 <span class="main">(</span><span class="free">binop</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span> <span class="free">G</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Abs_G_perm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Abs_G_perm</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> Abs_permutation <span class="main">(</span>G_perm <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔭</span> <span class="main">≡</span> Abs_G_perm"</span></span> <span class="comment1">― ‹the injection into type <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type</span> permutation<span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔦𝔭</span> <span class="main">≡</span> the_inv_into <span class="free">G</span> 𝔭"</span></span> <span class="comment1">― ‹the reverse correspondence›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pG</span> <span class="main">≡</span> 𝔭<span class="main">`</span><span class="free">G</span>"</span></span> <span class="comment1">― ‹the resulting <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> Group<span class="antiquote">}</span></span> of type <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">type</span> permutation<span class="antiquote">}</span></span>›</span>

<span class="keyword1" id="Algebra-G_perm_comp"><span class="command">lemma</span></span> G_perm_comp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> G_perm <span class="free">g</span> <span class="main">∘</span> G_perm <span class="free">h</span> <span class="main">=</span> G_perm <span class="main">(</span><span class="free">binop</span> <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assoc<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_inverse</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_inverse</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">∧</span> <span class="free">binop</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">h</span> <span class="main">=</span> <span class="free">e</span> <span class="main">∧</span> <span class="free">binop</span> <span class="bound">h</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="free">e</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝔦</span> <span class="main">≡</span> the_inverse"</span></span>

<span class="keyword1" id="Algebra-the_inverseD"><span class="command">lemma</span></span> the_inverseD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"𝔦 <span class="free">g</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="free">e</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">g</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms theI'<span class="main">[</span><span class="operator">OF</span> unique_inverse<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_inverse_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1" id="Algebra-binop_G_comp_binop_𝔦G"><span class="command">lemma</span></span> binop_G_comp_binop_𝔦G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">binop</span> <span class="free">g</span> <span class="main">(</span><span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the_inverseD<span class="main">(</span>1<span class="main">)</span> assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"𝔦 <span class="free">g</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> identity<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> the_inverseD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-bij_betw_binop_G"><span class="command">lemma</span></span> bij_betw_binop_G<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="free">binop</span> <span class="free">g</span><span class="main">)</span> <span class="free">G</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="free">binop</span> <span class="free">g</span><span class="main">)</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">k</span> <span class="keyword3"><span class="command">assume</span></span> hk<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="skolem">h</span> <span class="main">=</span> <span class="free">binop</span> <span class="free">g</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="main">(</span><span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">h</span> <span class="main">=</span> <span class="free">binop</span> <span class="main">(</span><span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_inverseD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms hk<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">=</span><span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> the_inverseD<span class="main">(</span>3<span class="main">)</span> identity <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="main">`</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="main">`</span> <span class="free">G</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="main">`</span> <span class="free">G</span> <span class="main">⊇</span> <span class="free">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> binop_G_comp_binop_𝔦G<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> the_inverseD<span class="main">(</span>1<span class="main">)</span> closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-the_inv_into_G_binop_G"><span class="command">lemma</span></span> the_inv_into_G_binop_G<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_inv_into <span class="free">G</span> <span class="main">(</span><span class="free">binop</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> the_inv_into_f_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="free">binop</span> <span class="free">g</span><span class="main">)</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">OF</span> bij_betw_binop_G<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="free">g</span> <span class="main">(</span><span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> binop_G_comp_binop_𝔦G <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> closed the_inverseD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-restrict1_the_inv_into_G_binop_G"><span class="command">lemma</span></span> restrict1_the_inv_into_G_binop_G<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> restrict1 <span class="main">(</span>the_inv_into <span class="free">G</span> <span class="main">(</span><span class="free">binop</span> <span class="free">g</span><span class="main">)</span><span class="main">)</span> <span class="free">G</span> <span class="main">=</span> G_perm <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the_inv_into_G_binop_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-bij_G_perm"><span class="command">lemma</span></span> bij_G_perm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> bij <span class="main">(</span>G_perm <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_permutation_bij_restrict1 bij_betw_binop_G <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-G_perm_apply"><span class="command">lemma</span></span> G_perm_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> 𝔭 <span class="free">g</span> <span class="main">→</span> <span class="free">x</span> <span class="main">=</span> <span class="free">binop</span> <span class="free">g</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_G_perm_def Abs_permutation_inverse bij_G_perm <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-G_perm_apply_identity"><span class="command">lemma</span></span> G_perm_apply_identity<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> 𝔭 <span class="free">g</span> <span class="main">→</span> <span class="free">e</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> G_perm_apply identity<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-the_inv_G_perm"><span class="command">lemma</span></span> the_inv_G_perm<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> the_inv <span class="main">(</span>G_perm <span class="free">g</span><span class="main">)</span> <span class="main">=</span> G_perm <span class="main">(</span>𝔦 <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_permutation_the_inv_restrict1 bij_betw_binop_G
        restrict1_the_inv_into_G_binop_G
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-Abs_G_perm_diff"><span class="command">lemma</span></span> Abs_G_perm_diff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> 𝔭 <span class="free">g</span> <span class="main">-</span> 𝔭 <span class="free">h</span> <span class="main">=</span> 𝔭 <span class="main">(</span><span class="free">binop</span> <span class="free">g</span> <span class="main">(</span>𝔦 <span class="free">h</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_G_perm_def minus_permutation_abs_eq<span class="main">[</span><span class="operator">OF</span> bij_G_perm bij_G_perm<span class="main">]</span>
        the_inv_G_perm G_perm_comp the_inverseD<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Algebra-Group"><span class="command">lemma</span></span> Group<span class="main">:</span> <span class="quoted"><span class="quoted">"Group pG"</span></span>
  <span class="keyword1"><span class="command">using</span></span> identity<span class="main">(</span>1<span class="main">)</span> Abs_G_perm_diff the_inverseD<span class="main">(</span>1<span class="main">)</span> closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-inj_on_𝔭_G"><span class="command">lemma</span></span> inj_on_𝔭_G<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on 𝔭 <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"𝔭 <span class="skolem">x</span> <span class="main">=</span> 𝔭 <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_permutation <span class="main">(</span>G_perm <span class="main">(</span><span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Abs_permutation id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_G_perm_diff Abs_G_perm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> xy<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_id closed the_inverseD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"G_perm <span class="main">(</span><span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_permutation_inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"G_perm <span class="main">(</span><span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span> bij_G_perm bij_id
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">binop</span> <span class="main">(</span><span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">∈</span><span class="free">G</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="main">(</span><span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fun_cong<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> xy<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="skolem">x</span> <span class="main">(</span><span class="free">binop</span> <span class="main">(</span>𝔦 <span class="skolem">y</span><span class="main">)</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unique_identity1<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> the_inverseD<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> xy<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> the_inverseD<span class="main">(</span>3<span class="main">)</span> identity<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-homs"><span class="command">lemma</span></span> homs<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="bound">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> 𝔭 <span class="main">(</span><span class="free">binop</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> 𝔭 <span class="bound">g</span> <span class="main">+</span> 𝔭 <span class="bound">h</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>pG <span class="main">⟹</span> <span class="bound">y</span><span class="main">∈</span>pG <span class="main">⟹</span> <span class="free">binop</span> <span class="main">(</span>𝔦𝔭 <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>𝔦𝔭 <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> 𝔦𝔭 <span class="main">(</span><span class="bound">x</span><span class="main">+</span><span class="bound">y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">h</span><span class="main">.</span> <span class="bound">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="bound">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> 𝔭 <span class="main">(</span><span class="free">binop</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> 𝔭 <span class="bound">g</span> <span class="main">+</span> 𝔭 <span class="bound">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_G_perm_def G_perm_comp
          plus_permutation_abs_eq<span class="main">[</span><span class="operator">OF</span> bij_G_perm bij_G_perm<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>pG <span class="main">⟹</span> <span class="bound">y</span><span class="main">∈</span>pG <span class="main">⟹</span> <span class="free">binop</span> <span class="main">(</span>𝔦𝔭 <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>𝔦𝔭 <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> 𝔦𝔭 <span class="main">(</span><span class="bound">x</span><span class="main">+</span><span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>pG"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>pG"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"𝔦𝔭 <span class="main">(</span>𝔭 <span class="main">(</span><span class="free">binop</span> <span class="main">(</span>𝔦𝔭 <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>𝔦𝔭 <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> 𝔦𝔭 <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 the_inv_into_into<span class="main">[</span><span class="operator">OF</span> inj_on_𝔭_G<span class="main">]</span> f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> inj_on_𝔭_G<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">binop</span> <span class="main">(</span>𝔦𝔭 <span class="skolem">x</span><span class="main">)</span> <span class="main">(</span>𝔦𝔭 <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> 𝔦𝔭 <span class="main">(</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> the_inv_into_into<span class="main">[</span><span class="operator">OF</span> inj_on_𝔭_G<span class="main">]</span> closed the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> inj_on_𝔭_G<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_correspondence_into <span class="main">=</span>
  the_inv_into_into<span class="main">[</span><span class="operator">OF</span> inj_on_𝔭_G<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">G</span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword1" id="Algebra-inv_correspondence_conv_apply"><span class="command">lemma</span></span> inv_correspondence_conv_apply<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> pG <span class="main">⟹</span> 𝔦𝔭 <span class="free">x</span> <span class="main">=</span> <span class="free">x</span><span class="main">→</span><span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> G_perm_apply_identity inj_on_𝔭_G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_inv_into_f_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context BinOpSetGroup *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Cosets of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Group<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">context</span></span> Group
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-lcoset_refl"><span class="command">lemma</span></span> lcoset_refl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_refl zero_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-lcoset_el_reduce"><span class="command">lemma</span></span> lcoset_el_reduce<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="keyword1">+o</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">a</span><span class="main">+</span><span class="skolem">g</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_closed<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_add_closed<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-lcoset_el_reduce0"><span class="command">lemma</span></span> lcoset_el_reduce0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">G</span> <span class="main">=</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> minus_unique uminus_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">a</span>"</span></span><span class="main">]</span>
        lcoset_el_reduce
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-lcoset_subgroup_imp_eq_reps"><span class="command">lemma</span></span> lcoset_subgroup_imp_eq_reps<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Group <span class="free">H</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="free">H</span> <span class="main">⊆</span> <span class="free">w'</span> <span class="keyword1">+o</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">w'</span> <span class="keyword1">+o</span> <span class="free">G</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Group.lcoset_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> lcoset_conv_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> lcoset_el_reduce
        set_plus_rearrange2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w'</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">w'</span><span class="main">+</span><span class="free">w</span>"</span></span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Algebra-lcoset_closed"><span class="command">lemma</span></span> lcoset_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">A</span><span class="main">⊆</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">a</span> <span class="keyword1">+o</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-lcoset_rel_sym"><span class="command">lemma</span></span> lcoset_rel_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>lcoset_rel <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> symI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uminus_closed minus_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">a</span>"</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> lcoset_rel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-lcoset_rel_trans"><span class="command">lemma</span></span> lcoset_rel_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"trans <span class="main">(</span>lcoset_rel <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> transI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">G</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">g'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">y</span><span class="main">+</span><span class="skolem">z</span> <span class="main">=</span> <span class="skolem">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lcoset_rel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">G</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> add_closed lcoset_rel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">LCoset_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'g</span><span class="main">×</span><span class="tfree">'g</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">LCoset_rel</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> lcoset_rel <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-refl_on_LCoset_rel"><span class="command">lemma</span></span> refl_on_LCoset_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span><span class="free">H</span> <span class="main">⟹</span> refl_on <span class="free">G</span> <span class="main">(</span>LCoset_rel <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> refl_onI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> subgroup_refl_on_LCoset_rel <span class="main">=</span>
  refl_on_LCoset_rel<span class="main">[</span><span class="operator">OF</span> Group.zero_closed<span class="main">,</span> <span class="operator">OF</span> SubgroupD1<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> LCoset_rel_quotientI        <span class="main">=</span> quotientI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="main">_</span>"</span></span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> LCoset_rel_quotientE        <span class="main">=</span> quotientE<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="main">_</span>"</span></span><span class="main">]</span>

<span class="keyword1" id="Algebra-lcoset_subgroup_rel_equiv"><span class="command">lemma</span></span> lcoset_subgroup_rel_equiv<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span> <span class="main">⟹</span> equiv <span class="free">G</span> <span class="main">(</span>LCoset_rel <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Group.lcoset_rel_sym sym_sym sym_Int Group.lcoset_rel_trans trans_sym
        trans_Int subgroup_refl_on_LCoset_rel
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> equivI<span class="main">)</span>

<span class="keyword1" id="Algebra-trivial_LCoset"><span class="command">lemma</span></span> trivial_LCoset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">⊆</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">H</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_closed <span class="keyword1"><span class="command">unfolding</span></span> lcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Group *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Group<span class="antiquote"><span class="antiquote">}</span></span></span></span> generated by a set›</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">genby</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>group_add set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⟨</span>_<span class="keyword1">⟩</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
      genby_0_closed     <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span><span class="main"><span class="free">⟨</span></span><span class="free">S</span><span class="main"><span class="free">⟩</span></span>"</span></span>  <span class="comment1">― ‹just in case <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">S</span></span><span class="antiquote">}</span></span> is empty›</span>
    <span class="main">|</span> genby_genset_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∈</span><span class="main"><span class="free">⟨</span></span><span class="free">S</span><span class="main"><span class="free">⟩</span></span>"</span></span>
    <span class="main">|</span> genby_diff_closed  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">∈</span><span class="main"><span class="free">⟨</span></span><span class="free">S</span><span class="main"><span class="free">⟩</span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span><span class="main">∈</span><span class="main"><span class="free">⟨</span></span><span class="free">S</span><span class="main"><span class="free">⟩</span></span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">w'</span></span></span> <span class="main">∈</span> <span class="main"><span class="free">⟨</span></span><span class="free">S</span><span class="main"><span class="free">⟩</span></span>"</span></span>

<span class="keyword1" id="Algebra-genby_Group"><span class="command">lemma</span></span> genby_Group<span class="main">:</span> <span class="quoted"><span class="quoted">"Group <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_0_closed genby_diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> genby_uminus_closed             <span class="main">=</span> Group.uminus_closed     <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_add_closed                <span class="main">=</span> Group.add_closed        <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_uminus_add_closed         <span class="main">=</span> Group.uminus_add_closed <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_lcoset_refl               <span class="main">=</span> Group.lcoset_refl       <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_lcoset_el_reduce          <span class="main">=</span> Group.lcoset_el_reduce  <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_lcoset_el_reduce0         <span class="main">=</span> Group.lcoset_el_reduce0 <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_lcoset_closed             <span class="main">=</span> Group.lcoset_closed     <span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> genby_lcoset_subgroup_imp_eq_reps <span class="main">=</span>
  Group.lcoset_subgroup_imp_eq_reps<span class="main">[</span><span class="operator">OF</span> genby_Group<span class="main">,</span> <span class="operator">OF</span> genby_Group<span class="main">]</span>

<span class="keyword1" id="Algebra-genby_genset_subset"><span class="command">lemma</span></span> genby_genset_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_genset_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-genby_uminus_genset_subset"><span class="command">lemma</span></span> genby_uminus_genset_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_genset_subset genby_uminus_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-genby_in_sum_list_lists"><span class="command">lemma</span></span> genby_in_sum_list_lists<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">S</span>
  <span class="keyword2"><span class="keyword">defines</span></span> S_sum_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S_sum_lists</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ss</span><span class="main">∈</span>lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span>sum_list <span class="bound">ss</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">S_sum_lists</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> sum_list <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> S_sum_lists <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="free">S_sum_lists</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="free">S_sum_lists</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_sum_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">S_sum_lists</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">∈</span> <span class="free">S_sum_lists</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> S_sum_lists <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">ts</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> sum_list <span class="skolem">ss</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> sum_list <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> ss<span class="main">(</span>2<span class="main">)</span> ts<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">-</span><span class="skolem">w'</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">ss</span> <span class="main">@</span> map uminus <span class="main">(</span>rev <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_conv_add_uminus uminus_sum_list<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ss<span class="main">(</span>1<span class="main">)</span> ts<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">@</span> map uminus <span class="main">(</span>rev <span class="skolem">ts</span><span class="main">)</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span> <span class="main">∈</span> <span class="free">S_sum_lists</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_sum_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-sum_list_lists_in_genby"><span class="command">lemma</span></span> sum_list_lists_in_genby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> sum_list <span class="free">ss</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_genset_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> genby_uminus_genset_subset
          genby_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-sum_list_lists_in_genby_sym"><span class="command">lemma</span></span> sum_list_lists_in_genby_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> sum_list <span class="free">ss</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_list_lists_in_genby <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-genby_eq_sum_lists"><span class="command">lemma</span></span> genby_eq_sum_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ss</span><span class="main">∈</span>lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span>sum_list <span class="bound">ss</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_in_sum_list_lists sum_list_lists_in_genby <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-genby_mono"><span class="command">lemma</span></span> genby_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_eq_sum_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> genby_eq_sum_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Group<span class="main">)</span> genby_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> zero_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="bound">s</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">w</span> <span class="bound">w'</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="bound">w'</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="bound">w</span><span class="main">-</span><span class="bound">w'</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Group<span class="main">)</span> genby_subgroup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> Subgroup <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_closed genby_Group <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-genby_sym_eq_sum_lists"><span class="command">lemma</span></span> genby_sym_eq_sum_lists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">ss</span><span class="main">∈</span>lists <span class="free">S</span><span class="main">.</span> <span class="main">{</span>sum_list <span class="bound">ss</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lists_mono genby_eq_sum_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Algebra-genby_empty'"><span class="command">lemma</span></span> genby_empty'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{}</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main">)</span> <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-genby_order2'"><span class="command">lemma</span></span> genby_order2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">w</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">w</span> <span class="main">=</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_unique<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-genby_order2"><span class="command">lemma</span></span> genby_order2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_order2'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> genby_0_closed genby_genset_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-genby_empty"><span class="command">lemma</span></span> genby_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">{}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_empty' genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-genby_lcoset_order2"><span class="command">lemma</span></span> genby_lcoset_order2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">s</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="free">w</span><span class="main">,</span><span class="free">w</span><span class="main">+</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genby_order2<span class="main">)</span>

<span class="keyword1" id="Algebra-genby_lcoset_empty"><span class="command">lemma</span></span> genby_lcoset_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>group_add<span class="main">)</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="main">{}</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">⟩</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span> set<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> genby_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> lcoset_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Group<span class="main">)</span> genby_set_lconjby_set_lconjby_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span> <span class="main">⟹</span> lconjby <span class="free">g</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lconjby <span class="free">g</span> <span class="main">0</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> lconjby <span class="free">g</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_closed genby_genset_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjby_add<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span>
  <span class="keyword3"><span class="command">assume</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"lconjby <span class="free">g</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"lconjby <span class="free">g</span> <span class="skolem">w'</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lconjby <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> lconjby <span class="free">g</span> <span class="skolem">w</span> <span class="main">+</span> lconjby <span class="free">g</span> <span class="main">(</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ww' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lconjby <span class="free">g</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lconjby_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> diff_conv_add_uminus<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"lconjby <span class="free">g</span> <span class="skolem">w'</span>"</span></span><span class="main">]</span>
          genby_diff_closed
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Group<span class="main">)</span> genby_set_lconjby_set_rconjby_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"rconjby <span class="free">g</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms uminus_closed genby_set_lconjby_set_lconjby_closed
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Homomorphisms and isomorphisms›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GroupHom <span class="main">=</span> Group <span class="quoted"><span class="free">G</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>   <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">::</span>group_add set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> <span class="main">⇒</span> <span class="tfree">'h</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> hom <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">(</span><span class="free">g</span> <span class="main">+</span> <span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="free">g</span> <span class="main">+</span> <span class="free">T</span> <span class="free">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     supp<span class="main">:</span> <span class="quoted"><span class="quoted">"supp <span class="free">T</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span> 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-im_zero"><span class="command">lemma</span></span> im_zero<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> zero_closed hom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> add_diff_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">0</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-im_uminus"><span class="command">lemma</span></span> im_uminus<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="main">-</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">T</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> im_zero hom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">g</span>"</span></span><span class="main">]</span> uminus_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> minus_unique<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="free">g</span>"</span></span><span class="main">]</span>
        uminus_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span><span class="main">]</span> supp suppI_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
        suppI_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-im_uminus_add"><span class="command">lemma</span></span> im_uminus_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span> <span class="main">+</span> <span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">T</span> <span class="free">g</span> <span class="main">+</span> <span class="free">T</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_closed hom im_uminus<span class="main">)</span>

<span class="keyword1" id="Algebra-im_diff"><span class="command">lemma</span></span> im_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">g'</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">(</span><span class="free">g</span> <span class="main">-</span> <span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="free">g</span> <span class="main">-</span> <span class="free">T</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hom uminus_closed hom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g'</span>"</span></span><span class="main">]</span> im_uminus <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-im_lconjby"><span class="command">lemma</span></span> im_lconjby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">(</span>lconjby <span class="free">x</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> lconjby <span class="main">(</span><span class="free">T</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> im_diff hom<span class="main">)</span>

<span class="keyword1" id="Algebra-im_sum_list_map"><span class="command">lemma</span></span> im_sum_list_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="free">f</span> <span class="free">as</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span> <span class="main">⟹</span> <span class="free">T</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span><span class="free">as</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span><span class="free">as</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hom im_zero sum_list_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">as</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-comp"><span class="command">lemma</span></span> comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GroupHom <span class="free">H</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">`</span><span class="free">G</span> <span class="main">⊆</span> <span class="free">H</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GroupHom <span class="free">G</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="skolem">g'</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∈</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g'</span> <span class="main">∈</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> hom assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="skolem">g</span> <span class="main">+</span> <span class="skolem">g'</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">T</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">+</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">T</span><span class="main">)</span> <span class="skolem">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> GroupHom.hom<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> supp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∉</span> <span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">T</span><span class="main">)</span> <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> suppI_contra GroupHom.im_zero<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span><span class="free">S</span> <span class="main">∘</span> <span class="free">T</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> suppD_contra <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GroupHom *)</span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ker</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>zero<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ker</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">a</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">a</span> <span class="main">=</span> <span class="main">0</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Algebra-ker_subset_ker_restrict0"><span class="command">lemma</span></span> ker_subset_ker_restrict0<span class="main">:</span> <span class="quoted"><span class="quoted">"ker <span class="free">f</span> <span class="main">⊆</span> ker <span class="main">(</span>restrict0 <span class="free">f</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ker_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> GroupHom
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Ker</span> <span class="main">≡</span> ker <span class="free">T</span> <span class="main">∩</span> <span class="free">G</span>"</span></span>

<span class="keyword1" id="Algebra-uminus_add_in_Ker_eq_eq_im"><span class="command">lemma</span></span> uminus_add_in_Ker_eq_eq_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">h</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">-</span><span class="free">g</span> <span class="main">+</span> <span class="free">h</span> <span class="main">∈</span> Ker<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span> <span class="free">g</span> <span class="main">=</span> <span class="free">T</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> neg_equal_iff_equal
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_add_closed ker_def im_uminus_add eq_neg_iff_add_eq_0<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GroupHom *)</span>

<span class="keyword1"><span class="command">locale</span></span> UGroupHom <span class="main">=</span> GroupHom <span class="quoted">UNIV</span> <span class="quoted"><span class="free">T</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">::</span>group_add <span class="main">⇒</span> <span class="tfree">'h</span><span class="main">::</span>group_add"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> im_zero       <span class="main">=</span> im_zero
<span class="keyword1"><span class="command">lemmas</span></span> im_uminus     <span class="main">=</span> im_uminus

<span class="keyword1" id="Algebra-hom"><span class="command">lemma</span></span> hom<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="free">g</span><span class="main">+</span><span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="free">g</span> <span class="main">+</span> <span class="free">T</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hom <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-im_diff"><span class="command">lemma</span></span> im_diff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="free">g</span> <span class="main">-</span> <span class="free">g'</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="free">g</span> <span class="main">-</span> <span class="free">T</span> <span class="free">g'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> im_diff <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-im_lconjby"><span class="command">lemma</span></span> im_lconjby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span>lconjby <span class="free">x</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> lconjby <span class="main">(</span><span class="free">T</span> <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="free">T</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> im_lconjby <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-restrict0"><span class="command">lemma</span></span> restrict0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Group <span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GroupHom <span class="free">G</span> <span class="main">(</span>restrict0 <span class="free">T</span> <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> hom 
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">g'</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span> <span class="bound">g'</span> <span class="main">∈</span> <span class="free">G</span> <span class="main">⟹</span>
            restrict0 <span class="free">T</span> <span class="free">G</span> <span class="main">(</span><span class="bound">g</span> <span class="main">+</span> <span class="bound">g'</span><span class="main">)</span> <span class="main">=</span> restrict0 <span class="free">T</span> <span class="free">G</span> <span class="bound">g</span> <span class="main">+</span> restrict0 <span class="free">T</span> <span class="free">G</span> <span class="bound">g'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group.add_closed<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supp <span class="main">(</span>restrict0 <span class="free">T</span> <span class="free">G</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">G</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> supp_restrict0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context UGroupHom *)</span>

<span class="keyword1" id="Algebra-UGroupHomI"><span class="command">lemma</span></span> UGroupHomI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span> <span class="bound">g'</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="bound">g</span> <span class="main">+</span> <span class="bound">g'</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="bound">g</span> <span class="main">+</span> <span class="free">T</span> <span class="bound">g'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"UGroupHom <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">locale</span></span> GroupIso <span class="main">=</span> GroupHom <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">T</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>   <span class="free">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">::</span>group_add set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> <span class="main">⇒</span> <span class="tfree">'h</span><span class="main">::</span>group_add"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">T</span> <span class="free">G</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> GroupHom<span class="main">)</span> isoI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟹</span> <span class="free">T</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">k</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GroupIso <span class="free">G</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">x</span><span class="main">∈</span><span class="free">G</span><span class="main">;</span> <span class="skolem">y</span><span class="main">∈</span><span class="free">G</span><span class="main">;</span> <span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">T</span> <span class="skolem">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> im_diff diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> BinOpSetGroup<span class="antiquote"><span class="antiquote">}</span></span></span></span>, any map from the set into a type of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> that respects the
  binary operation induces a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> GroupHom<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> BinOpSetGroup<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">lift_hom</span> <span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">≡</span> restrict0 <span class="main">(</span><span class="free"><span class="bound"><span class="entity">T</span></span></span> <span class="main">∘</span> 𝔦𝔭<span class="main">)</span> pG"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> BinOpSetGroup<span class="main">)</span> lift_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">T</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="free">binop</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="bound">g</span> <span class="main">+</span> <span class="free">T</span> <span class="bound">h</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GroupHom pG <span class="main">(</span>lift_hom <span class="free">T</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Group<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>pG <span class="main">⟹</span> <span class="bound">y</span><span class="main">∈</span>pG <span class="main">⟹</span>
            lift_hom <span class="free">T</span> <span class="main">(</span><span class="bound">x</span><span class="main">+</span><span class="bound">y</span><span class="main">)</span> <span class="main">=</span> lift_hom <span class="free">T</span> <span class="bound">x</span> <span class="main">+</span> lift_hom <span class="free">T</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group.add_closed<span class="main">[</span><span class="operator">OF</span> Group<span class="main">]</span> inv_correspondence_into
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> homs<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> supp_restrict0<span class="main">)</span>




<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Normal subgroups›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rcoset_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span><span class="main">{</span>minus<span class="main">,</span>plus<span class="main">}</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">rcoset_rel</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span><span class="main">-</span><span class="bound">y</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> Group
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-rcoset_rel_conv_lcoset_rel"><span class="command">lemma</span></span> rcoset_rel_conv_lcoset_rel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"rcoset_rel <span class="free">G</span> <span class="main">=</span> map_prod uminus uminus <span class="main">`</span> <span class="main">(</span>lcoset_rel <span class="free">G</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">×</span><span class="tfree">'g</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> rcoset_rel <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">-</span><span class="skolem">b</span> <span class="main">∈</span> <span class="free">G</span><span class="main">)</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> rcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span> <span class="main">(</span><span class="main">-</span><span class="skolem">b</span><span class="main">,</span><span class="main">-</span><span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> lcoset_rel <span class="free">G</span> <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uminus_closed lcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">finally</span></span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> rcoset_rel <span class="free">G</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">∈</span> map_prod uminus uminus <span class="main">`</span> <span class="main">(</span>lcoset_rel <span class="free">G</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ab symD<span class="main">[</span><span class="operator">OF</span> lcoset_rel_sym<span class="main">]</span> map_prod_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-rcoset_rel_sym"><span class="command">lemma</span></span> rcoset_rel_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"sym <span class="main">(</span>rcoset_rel <span class="free">G</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rcoset_rel_conv_lcoset_rel map_prod_sym lcoset_rel_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">RCoset_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'g</span><span class="main">×</span><span class="tfree">'g</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">RCoset_rel</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> rcoset_rel <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">∩</span> <span class="main">(</span><span class="free">G</span><span class="main">×</span><span class="free">G</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">normal</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> LCoset_rel <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">g</span><span class="main">}</span> <span class="main">=</span> RCoset_rel <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="bound">g</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-normalI"><span class="command">lemma</span></span> normalI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"Group <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> <span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> <span class="bound">g</span><span class="main">+</span><span class="bound">h</span> <span class="main">=</span> <span class="bound">h'</span><span class="main">+</span><span class="bound">g</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> <span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="free">H</span><span class="main">.</span> <span class="bound">h</span><span class="main">+</span><span class="bound">g</span> <span class="main">=</span> <span class="bound">g</span><span class="main">+</span><span class="bound">h'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"normal <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> normal_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">g</span> <span class="keyword3"><span class="command">assume</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span> <span class="main">=</span> RCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> g <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">g</span><span class="main">+</span><span class="skolem">x</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> lcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> g x<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">∈</span><span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">-</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">h</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>   <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> g x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> RCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Group.uminus_closed <span class="keyword1"><span class="command">unfolding</span></span> rcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> RCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> g <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">-</span><span class="skolem">x</span> <span class="main">∈</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">∈</span><span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">g</span><span class="main">+</span><span class="skolem">x</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">h</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> minus_add<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> g x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">g</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Group.uminus_closed <span class="keyword1"><span class="command">unfolding</span></span> lcoset_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-normal_lconjby_closed"><span class="command">lemma</span></span> normal_lconjby_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subgroup <span class="free">H</span><span class="main">;</span> normal <span class="free">H</span><span class="main">;</span> <span class="free">g</span><span class="main">∈</span><span class="free">G</span><span class="main">;</span> <span class="free">h</span><span class="main">∈</span><span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> lconjby <span class="free">g</span> <span class="free">h</span> <span class="main">∈</span> <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_relI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">+</span><span class="free">h</span>"</span></span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span> add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> normal_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
        symD<span class="main">[</span><span class="operator">OF</span> Group.rcoset_rel_sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">+</span><span class="free">h</span>"</span></span><span class="main">]</span> rcoset_rel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Algebra-normal_rconjby_closed"><span class="command">lemma</span></span> normal_rconjby_closed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subgroup <span class="free">H</span><span class="main">;</span> normal <span class="free">H</span><span class="main">;</span> <span class="free">g</span><span class="main">∈</span><span class="free">G</span><span class="main">;</span> <span class="free">h</span><span class="main">∈</span><span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> rconjby <span class="free">g</span> <span class="free">h</span> <span class="main">∈</span> <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> normal_lconjby_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span> uminus_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">normal_closure</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">≡</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">⟩</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> Group<span class="main">)</span> normal_closure<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">⊆</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"normal <span class="main">(</span>normal_closure <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> normalI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> genby_Group<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span>
        <span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">h</span> <span class="main">=</span> <span class="bound">h'</span> <span class="main">+</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span>
          <span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h</span> <span class="main">=</span> <span class="bound">h'</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> genby.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="bound">h</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ga<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> lconjby <span class="skolem">g</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">from</span></span> ga<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">s</span> <span class="main">=</span> lconjby <span class="skolem">x</span> <span class="main">(</span>lconjby <span class="skolem">g</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">s</span> <span class="main">=</span> lconjby <span class="main">(</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">g</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjby_add<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> x ga<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">s</span> <span class="main">=</span> <span class="bound">h</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> add_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> genby_genset_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span>
      <span class="keyword3"><span class="command">assume</span></span> w <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span> <span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">w</span>  <span class="main">=</span> <span class="bound">h</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>  w'<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="bound">h'</span><span class="main">+</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> w<span class="main">(</span>2<span class="main">)</span> w'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">h'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> h <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">w</span>  <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span><span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="skolem">h'</span><span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">w</span> <span class="main">-</span> <span class="main">(</span><span class="main">-</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">w'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> h<span class="main">(</span>2<span class="main">)</span> h'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="main">(</span><span class="skolem">h'</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">-</span><span class="skolem">h'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_add add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">w</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">h</span> <span class="main">-</span> <span class="skolem">h'</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span><span class="main">+</span><span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">h'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> h<span class="main">(</span>1<span class="main">)</span> h'<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> <span class="bound">h</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> genby_diff_closed
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> <span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span>
        <span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="bound">h</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">+</span> <span class="bound">h'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">G</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span>
            <span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="bound">h</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> genby.induct<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="main">0</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> ga<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> lconjby <span class="skolem">g</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">from</span></span> ga<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span><span class="skolem">g</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="skolem">x</span> <span class="main">+</span> <span class="skolem">g</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">-</span><span class="skolem">g</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> lconjby <span class="main">(</span><span class="main">-</span><span class="skolem">x</span><span class="main">+</span><span class="skolem">g</span><span class="main">)</span> <span class="skolem">a</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span> lconjby_add<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> x ga<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> uminus_add_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> genby_genset_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span>
      <span class="keyword3"><span class="command">assume</span></span> w <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span> <span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">w</span>  <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>  w'<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span>
                  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h'</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">w'</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h'</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> w<span class="main">(</span>2<span class="main">)</span> w'<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="skolem"><span class="skolem">h'</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> h <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">h</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span>   h'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h'</span><span class="main">∈</span> <span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">h'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="skolem">x</span> <span class="main">+</span> <span class="main">-</span><span class="skolem">w'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> h<span class="main">(</span>2<span class="main">)</span> h'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">h</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span><span class="skolem">h'</span><span class="main">+</span><span class="main">-</span><span class="skolem">x</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> minus_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w'</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> minus_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">h'</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">-</span> <span class="skolem">h'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> h<span class="main">(</span>1<span class="main">)</span> h'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">h</span><span class="main">∈</span><span class="main">⟨</span><span class="main">⋃</span><span class="bound">g</span><span class="main">∈</span><span class="free">G</span><span class="main">.</span> lconjby <span class="bound">g</span> <span class="main">`</span> <span class="free">A</span><span class="main">⟩</span><span class="main">.</span> <span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">h</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> genby_diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Group *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Quotient groups›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we use the bridge built by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> BinOpSetGroup<span class="antiquote"><span class="antiquote">}</span></span></span></span> to make the quotient of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Group<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  by a normal subgroup into a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Group<span class="antiquote"><span class="antiquote">}</span></span></span></span> itself.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> Group
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-normal_quotient_add_well_defined"><span class="command">lemma</span></span> normal_quotient_add_well_defined<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"normal <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span><span class="main">∈</span><span class="free">G</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span> <span class="main">+</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g'</span><span class="main">}</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span><span class="main">+</span><span class="free">g'</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span> <span class="main">+</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">z</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>     <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span><span class="main">+</span><span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> set_plus_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span> <span class="main">+</span> <span class="free">g'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lcoset_rel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span> normal_lconjby_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g'</span><span class="main">+</span><span class="skolem">z</span>"</span></span><span class="main">]</span>
          Group.add_closed
          normal_rconjby_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="free">g'</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">-</span> <span class="free">g'</span><span class="main">)</span>"</span></span><span class="main">]</span>
          add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span><span class="main">]</span>
          add_closed lcoset_relI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">+</span><span class="free">g'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">+</span><span class="skolem">z</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc minus_add<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span> <span class="main">+</span> <span class="free">g'</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≡</span> <span class="main">-</span><span class="main">(</span><span class="free">g</span><span class="main">+</span><span class="free">g'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="main">+</span> <span class="main">(</span><span class="free">g'</span> <span class="main">+</span> <span class="skolem">h</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">g</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc minus_add<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span> <span class="main">+</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> lcoset_rel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span> add_closed
          refl_onD<span class="main">[</span><span class="operator">OF</span> subgroup_refl_on_LCoset_rel<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">quotient_set</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> <span class="free">G</span> <span class="main">//</span> LCoset_rel <span class="free"><span class="bound"><span class="entity">H</span></span></span>"</span></span>

<span class="keyword1" id="Algebra-BinOpSetGroup_normal_quotient"><span class="command">lemma</span></span> BinOpSetGroup_normal_quotient<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"normal <span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"BinOpSetGroup <span class="main">(</span>quotient_set <span class="free">H</span><span class="main">)</span> <span class="main">(+)</span> <span class="free">H</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> H0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trivial_LCoset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">∈</span> quotient_set <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H0 zero_closed LCoset_rel_quotientI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> quotient_set <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gx</span></span> <span class="keyword2"><span class="keyword">where</span></span> gx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gx</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">gx</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">+</span><span class="free">H</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">+</span><span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normal_quotient_add_well_defined<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="skolem">gx</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
          normal_quotient_add_well_defined<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">gx</span></span><span class="main">]</span>
          H0 zero_closed
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> gx<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="main">-</span><span class="skolem">gx</span><span class="main">}</span> <span class="main">∈</span> quotient_set <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uminus_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> gx
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">+</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="main">-</span><span class="skolem">gx</span><span class="main">}</span> <span class="main">=</span> <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="main">-</span><span class="skolem">gx</span><span class="main">}</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H0 uminus_closed normal_quotient_add_well_defined
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x'</span><span class="main">∈</span>quotient_set <span class="free">H</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">+</span> <span class="bound">x'</span> <span class="main">=</span> <span class="free">H</span> <span class="main">∧</span> <span class="bound">x'</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> quotient_set <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">gy</span></span> <span class="keyword2"><span class="keyword">where</span></span> gy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">gy</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">gy</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms gx <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">+</span><span class="skolem">y</span> <span class="main">∈</span> quotient_set <span class="free">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_closed normal_quotient_add_well_defined
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientI<span class="main">)</span>

<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> add.assoc<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">abs_lcoset_perm</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span>
                BinOpSetGroup.Abs_G_perm <span class="main">(</span>quotient_set <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">(+)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">abs_lcoset_perm_lift</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> abs_lcoset_perm <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">(</span>LCoset_rel <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">``</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">abs_lcoset_perm_lift_arg_permutation</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> abs_lcoset_perm_lift <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">notation</span></span> abs_lcoset_perm_lift_arg_permutation <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">|</span>_<span class="keyword1">⌉</span>"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Group *)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Group_abs_lcoset_perm_lift_arg_permutation</span> <span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span>
  Group.abs_lcoset_perm_lift_arg_permutation <span class="free"><span class="bound"><span class="entity">G'</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">H</span></span></span>"</span></span>
<span class="keyword1"><span class="command">notation</span></span> Group_abs_lcoset_perm_lift_arg_permutation <span class="main">(</span><span class="quoted">"<span class="keyword1">⌈</span>_<span class="keyword1">|</span>_<span class="keyword1">|</span>_<span class="keyword1">⌉</span>"</span> <span class="main">[</span>51<span class="main">,</span>51<span class="main">,</span>51<span class="main">]</span> 50<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> Group
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> lcoset_perm_def <span class="main">=</span>
  BinOpSetGroup.Abs_G_perm_def<span class="main">[</span><span class="operator">OF</span> BinOpSetGroup_normal_quotient<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> lcoset_perm_comp <span class="main">=</span>
  BinOpSetGroup.G_perm_comp<span class="main">[</span><span class="operator">OF</span> BinOpSetGroup_normal_quotient<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> bij_lcoset_perm <span class="main">=</span>
  BinOpSetGroup.bij_G_perm<span class="main">[</span><span class="operator">OF</span> BinOpSetGroup_normal_quotient<span class="main">]</span>

<span class="keyword1" id="Algebra-trivial_lcoset_perm"><span class="command">lemma</span></span> trivial_lcoset_perm<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"normal <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">∈</span><span class="free">H</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"restrict1 <span class="main">(</span><span class="main">(+)</span> <span class="main">(</span>LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">h</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>quotient_set <span class="free">H</span><span class="main">)</span> <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ext<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> quotient_set <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span><span class="main">∈</span><span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientE<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">h</span><span class="main">}</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">h</span><span class="main">+</span><span class="skolem">k</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms normal_quotient_add_well_defined <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms k <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">h</span><span class="main">}</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">h</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> lcoset_relI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">+</span><span class="skolem">k</span>"</span></span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
          normal_rconjby_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span> <span class="quoted"><span class="skolem">k</span></span> <span class="quoted"><span class="free">h</span></span><span class="main">]</span>
          eq_equiv_class_iff<span class="main">[</span><span class="operator">OF</span> lcoset_subgroup_rel_equiv<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">quotient_group</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> set <span class="main">⇒</span> <span class="tfree">'g</span> set permutation set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">quotient_group</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> BinOpSetGroup.pG <span class="main">(</span>quotient_set <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">(+)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">natural_quotient_hom</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span> restrict0 <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">⌈</span><span class="bound">g</span><span class="main">|</span><span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">⌉</span><span class="main">)</span> <span class="free">G</span>"</span></span>

<span class="keyword1"><span class="command">theorem</span></span> quotient_group<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span> <span class="main">⟹</span> normal <span class="free">H</span> <span class="main">⟹</span> Group <span class="main">(</span>quotient_group <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> quotient_group_def
  <span class="keyword1"><span class="command">using</span></span>     BinOpSetGroup.Group<span class="main">[</span><span class="operator">OF</span> BinOpSetGroup_normal_quotient<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1" id="Algebra-natural_quotient_hom"><span class="command">lemma</span></span> natural_quotient_hom<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span> <span class="main">⟹</span> normal <span class="free">H</span> <span class="main">⟹</span> GroupHom <span class="free">G</span> <span class="main">(</span>natural_quotient_hom <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_closed bij_lcoset_perm lcoset_perm_def supp_restrict0
        normal_quotient_add_well_defined<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
        LCoset_rel_quotientI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span>
        <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lcoset_perm_comp plus_permutation_abs_eq<span class="main">)</span>

<span class="keyword1" id="Algebra-natural_quotient_hom_image"><span class="command">lemma</span></span> natural_quotient_hom_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"natural_quotient_hom <span class="free">H</span> <span class="main">`</span> <span class="free">G</span> <span class="main">=</span> quotient_group <span class="free">H</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> quotient_group_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientE <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientI<span class="main">)</span> 

<span class="keyword1" id="Algebra-quotient_group_UN"><span class="command">lemma</span></span> quotient_group_UN<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_group <span class="free">H</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">g</span><span class="main">.</span> <span class="main">⌈</span><span class="bound">g</span><span class="main">|</span><span class="free">H</span><span class="main">⌉</span><span class="main">)</span> <span class="main">`</span> <span class="free">G</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> natural_quotient_hom_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-quotient_identity_rule"><span class="command">lemma</span></span> quotient_identity_rule<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subgroup <span class="free">H</span><span class="main">;</span> normal <span class="free">H</span><span class="main">;</span> <span class="free">h</span><span class="main">∈</span><span class="free">H</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">⌈</span><span class="free">h</span><span class="main">|</span><span class="free">H</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lcoset_perm_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> trivial_lcoset_perm zero_permutation.abs_eq<span class="main">)</span>
  
<span class="keyword1" id="Algebra-quotient_group_lift_to_quotient_set"><span class="command">lemma</span></span> quotient_group_lift_to_quotient_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subgroup <span class="free">H</span><span class="main">;</span> normal <span class="free">H</span><span class="main">;</span> <span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⌈</span><span class="free">g</span><span class="main">|</span><span class="free">H</span><span class="main">⌉</span><span class="main">)</span> <span class="main">→</span> <span class="free">H</span> <span class="main">=</span> LCoset_rel <span class="free">H</span> <span class="main">``</span> <span class="main">{</span><span class="free">g</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> LCoset_rel_quotientI
        BinOpSetGroup.G_perm_apply_identity<span class="main">[</span>
          <span class="operator">OF</span> BinOpSetGroup_normal_quotient
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Group *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The induced homomorphism on a quotient group›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A normal subgroup contained in the kernel of a homomorphism gives rise to a homomorphism on the
  quotient group by that subgroup. When the subgroup is the kernel itself (which is always normal),
  we obtain an isomorphism on the quotient.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> GroupHom
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Algebra-respects_Ker_lcosets"><span class="command">lemma</span></span> respects_Ker_lcosets<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> Ker <span class="main">⟹</span> <span class="free">T</span> <span class="keyword1">respects</span> <span class="main">(</span>LCoset_rel <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     uminus_add_in_Ker_eq_eq_im
  <span class="keyword1"><span class="command">unfolding</span></span> lcoset_rel_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> congruentI<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">quotient_hom</span> <span class="free"><span class="bound"><span class="entity">H</span></span></span> <span class="main">≡</span>
  BinOpSetGroup.lift_hom <span class="main">(</span>quotient_set <span class="free"><span class="bound"><span class="entity">H</span></span></span><span class="main">)</span> <span class="main">(+)</span> <span class="main">(</span>quotientfun <span class="free">T</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> normal_subgroup_quotientfun_classrep_equality <span class="main">=</span>
  quotientfun_classrep_equality<span class="main">[</span>
    <span class="operator">OF</span> subgroup_refl_on_LCoset_rel<span class="main">,</span> <span class="operator">OF</span> _ respects_Ker_lcosets
  <span class="main">]</span>

<span class="keyword1" id="Algebra-quotient_hom_im"><span class="command">lemma</span></span> quotient_hom_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subgroup <span class="free">H</span><span class="main">;</span> normal <span class="free">H</span><span class="main">;</span> <span class="free">H</span> <span class="main">⊆</span> Ker<span class="main">;</span> <span class="free">g</span><span class="main">∈</span><span class="free">G</span> <span class="main">⟧</span> <span class="main">⟹</span> quotient_hom <span class="free">H</span> <span class="main">(</span><span class="main">⌈</span><span class="free">g</span><span class="main">|</span><span class="free">H</span><span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="free">T</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> quotient_group_def quotient_group_UN quotient_group_lift_to_quotient_set
        BinOpSetGroup.inv_correspondence_conv_apply<span class="main">[</span>
          <span class="operator">OF</span> BinOpSetGroup_normal_quotient
        <span class="main">]</span>
        normal_subgroup_quotientfun_classrep_equality
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Algebra-quotient_hom"><span class="command">lemma</span></span> quotient_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Subgroup <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"normal <span class="free">H</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">⊆</span> Ker"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"GroupHom <span class="main">(</span>quotient_group <span class="free">H</span><span class="main">)</span> <span class="main">(</span>quotient_hom <span class="free">H</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> quotient_group_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> BinOpSetGroup.lift_hom<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> BinOpSetGroup_normal_quotient<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> quotient_set <span class="free">H</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> quotient_set <span class="free">H</span><span class="main">.</span>
            quotientfun <span class="free">T</span> <span class="main">(</span><span class="bound">x</span> <span class="main">+</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> quotientfun <span class="free">T</span> <span class="bound">x</span> <span class="main">+</span> quotientfun <span class="free">T</span> <span class="bound">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> normal_quotient_add_well_defined normal_subgroup_quotientfun_classrep_equality
          add_closed hom
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> LCoset_rel_quotientE<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GroupHom *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Free groups›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Words in letters of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> signed<span class="antiquote"><span class="antiquote">}</span></span></span></span> type›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Definitions and basic fact›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We pair elements of some type with type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">bool</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, where the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">bool</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> part of the pair
  indicates inversion.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pairtrue</span>  <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span>True<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pairfalse</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span>False<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">flip_signed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'a</span> signed"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">flip_signed</span> <span class="main">≡</span> apsnd <span class="main">(</span><span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span><span class="bound">b</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">nflipped_signed</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'a</span> signed <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">nflipped_signed</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≠</span> flip_signed <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Algebra-flip_signed_order2"><span class="command">lemma</span></span> flip_signed_order2<span class="main">:</span> <span class="quoted"><span class="quoted">"flip_signed <span class="main">(</span>flip_signed <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apsnd_conv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="main">¬</span><span class="bound">b</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="free">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">charpair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>uminus set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> signed"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">charpair</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>True<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span>False<span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-map_charpair_uniform"><span class="command">lemma</span></span> map_charpair_uniform<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟹</span> map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="free">ss</span> <span class="main">=</span> map pairtrue <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-fst_set_map_charpair_un_uminus"><span class="command">lemma</span></span> fst_set_map_charpair_un_uminus<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>group_add list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="main">(</span>map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">apply_sign</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>uminus<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">apply_sign</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">if</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A word in such pairs will be considered proper if it does not contain consecutive letters that
  have opposite signs (and so are considered inverse), since such consecutive letters would be
  cancelled in a group.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">proper_signed_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">proper_signed_list</span> <span class="main">≡</span> binrelchain nflipped_signed"</span></span>

<span class="keyword1" id="Algebra-proper_map_flip_signed"><span class="command">lemma</span></span> proper_map_flip_signed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> proper_signed_list <span class="main">(</span>map flip_signed <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-proper_rev_map_flip_signed"><span class="command">lemma</span></span> proper_rev_map_flip_signed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> proper_signed_list <span class="main">(</span>rev <span class="main">(</span>map flip_signed <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_map_flip_signed binrelchain_sym_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-uniform_snd_imp_proper_signed_list"><span class="command">lemma</span></span> uniform_snd_imp_proper_signed_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">⟹</span> proper_signed_list <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> CCons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-proper_signed_list_map_uniform_snd"><span class="command">lemma</span></span> proper_signed_list_map_uniform_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uniform_snd_imp_proper_signed_list<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Algebra›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Addition is performed by appending words and recursively removing any newly created adjacent
  pairs of inverse letters. Since we will only ever be adding proper words, we only need to care
  about newly created adjacent inverse pairs in the middle.
›</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">prappend_signed_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed list <span class="main">⇒</span> <span class="tfree">'a</span> signed list <span class="main">⇒</span> <span class="tfree">'a</span> signed list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">prappend_signed_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prappend_signed_list</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>"</span></span>
      <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">prappend_signed_list</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> flip_signed <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="free">prappend_signed_list</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span>
        <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span> <span class="main">(</span><span class="operator">rule</span> two_prod_lists_cases_snoc_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">xs</span><span class="main">,</span><span class="bound">ys</span><span class="main">)</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">+</span> length <span class="bound">ys</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-proper_prappend_signed_list"><span class="command">lemma</span></span> proper_prappend_signed_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> proper_signed_list <span class="free">ys</span>
    <span class="main">⟹</span> proper_signed_list <span class="main">(</span>prappend_signed_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2_snoc_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_Cons <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> flip_signed <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> snoc_Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span><span class="main">]</span>
            binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> snoc_Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> binrelchain_join<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-fully_prappend_signed_list"><span class="command">lemma</span></span> fully_prappend_signed_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prappend_signed_list <span class="main">(</span>rev <span class="main">(</span>map flip_signed <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-prappend_signed_list_single_Cons"><span class="command">lemma</span></span> prappend_signed_list_single_Cons<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prappend_signed_list <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">y</span> <span class="main">=</span> flip_signed <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ys</span> <span class="keyword1">else</span> <span class="free">x</span><span class="main">#</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-prappend_signed_list_map_uniform_snd"><span class="command">lemma</span></span> prappend_signed_list_map_uniform_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prappend_signed_list <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span>
    map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="main">@</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-prappend_signed_list_assoc_conv_snoc2Cons"><span class="command">lemma</span></span> prappend_signed_list_assoc_conv_snoc2Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"prappend_signed_list <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="free">ys</span> <span class="main">=</span> prappend_signed_list <span class="free">xs</span> <span class="main">(</span><span class="free">y</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil1 <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prappend_signed_list_single_Cons<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Nil2 <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_Cons <span class="skolem">as</span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
    <span class="keyword1"><span class="command">using</span></span> prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">]</span>
          binrelchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">,</span><span class="free">y</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-prappend_signed_list_assoc"><span class="command">lemma</span></span> prappend_signed_list_assoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> proper_signed_list <span class="free">xs</span><span class="main">;</span> proper_signed_list <span class="free">ys</span><span class="main">;</span> proper_signed_list <span class="free">zs</span> <span class="main">⟧</span> <span class="main">⟹</span>
    prappend_signed_list <span class="main">(</span>prappend_signed_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="free">zs</span> <span class="main">=</span>
      prappend_signed_list <span class="free">xs</span> <span class="main">(</span>prappend_signed_list <span class="free">ys</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct3_snoc_Conssnoc_Cons_pairwise<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_single_Cons <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
          prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> flip_signed <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> flip_signed <span class="skolem">y</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            flip_signed_order2 prappend_signed_list_assoc_conv_snoc2Cons
          <span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_Conssnoc_Cons <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">w</span> <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="skolem">w</span><span class="main">]</span>"</span></span><span class="main">]</span>
          binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span>
          binrelchain_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
          binrelchain_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span>"</span></span><span class="main">]</span>
          binrelchain_Conssnoc_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span>
          prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span>"</span></span><span class="main">]</span>
          prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span><span class="main">@</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> flip_signed <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> flip_signed <span class="skolem">w</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-fst_set_prappend_signed_list"><span class="command">lemma</span></span> fst_set_prappend_signed_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>prappend_signed_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="free">xs</span> <span class="main">∪</span> set <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2_snoc_Cons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-collapse_flipped_signed"><span class="command">lemma</span></span> collapse_flipped_signed<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prappend_signed_list <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">¬</span><span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prappend_signed_list.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>



<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The collection of proper signed lists as a type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we create a type out of the collection of proper signed lists. This type will be of class
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>, with the empty list as zero, the modified append operation
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> prappend_signed_list<span class="antiquote"><span class="antiquote">}</span></span></span></span> as addition, and inversion performed by flipping the signs of the
  elements in the list and then reversing the order.
›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Type definition, instantiations, and instances›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we define the type and instantiate it with respect to various type classes.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> freeword <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">as</span><span class="main">::</span><span class="tfree">'a</span> signed list<span class="main">.</span> proper_signed_list <span class="bound">as</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">morphisms</span></span> freeword Abs_freeword
  <span class="keyword1"><span class="command">using</span></span> binrelchain.simps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  These two functions act as the natural injections of letters and words in the letter type into
  the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span> type.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Abs_freeletter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Abs_freeletter</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> Abs_freeword <span class="main">[</span>pairtrue <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Abs_freelist</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Abs_freelist</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> Abs_freeword <span class="main">(</span>map pairtrue <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Abs_freelistfst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed list <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Abs_freelistfst</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> Abs_freelist <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_freeword

<span class="keyword1"><span class="command">instantiation</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">zero</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">zero_freeword</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span><span class="main">::</span><span class="tfree">'a</span> signed list"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">plus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">plus_freeword</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span>    <span class="quoted"><span class="quoted">"prappend_signed_list"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_prappend_signed_list
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">uminus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">uminus_freeword</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> rev <span class="main">(</span>map flip_signed <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> proper_rev_map_flip_signed<span class="main">)</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">minus</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">minus_freeword</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> prappend_signed_list <span class="bound">xs</span> <span class="main">(</span>rev <span class="main">(</span>map flip_signed <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_rev_map_flip_signed proper_prappend_signed_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instance</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">semigroup_add</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword"</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">b</span> <span class="main">+</span> <span class="skolem">c</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prappend_signed_list_assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">c</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">monoid_add</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="skolem">c</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">0</span> <span class="main">=</span> <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instance</span></span> freeword <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">group_add</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="skolem">a</span> <span class="main">+</span> <span class="skolem">a</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fully_prappend_signed_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">+</span> <span class="main">-</span> <span class="skolem">b</span> <span class="main">=</span> <span class="skolem">a</span> <span class="main">-</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Basic algebra and transfer facts in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span> type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we record basic algebraic manipulations for the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span> type as well as various
  transfer facts for dealing with representations of elements of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span> type as lists of
  signed letters.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Abs_freeletter_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> freeword"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">[+]</span>"</span> 65<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main"><span class="free">[+]</span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> Abs_freeletter <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">+</span> Abs_freeletter <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span>

<span class="keyword1" id="Algebra-Abs_freeword_Cons"><span class="command">lemma</span></span> Abs_freeword_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">+</span> Abs_freeword <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> add_0_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span> 
  <span class="keyword1"><span class="command">with</span></span> assms
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"freeword <span class="main">(</span>Abs_freeword <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            freeword <span class="main">(</span>Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">+</span> Abs_freeword <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            plus_freeword.rep_eq Abs_freeword_inverse
            prappend_signed_list_single_Cons
          <span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> freeword_inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-Abs_freelist_Cons"><span class="command">lemma</span></span> Abs_freelist_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">=</span> Abs_freeletter <span class="free">x</span> <span class="main">+</span> Abs_freelist <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted">True</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="free">xs</span>"</span></span><span class="main">]</span> Abs_freeword_Cons
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Algebra-plus_freeword_abs_eq"><span class="command">lemma</span></span> plus_freeword_abs_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> proper_signed_list <span class="free">ys</span> <span class="main">⟹</span>
    Abs_freeword <span class="free">xs</span> <span class="main">+</span> Abs_freeword <span class="free">ys</span> <span class="main">=</span> Abs_freeword <span class="main">(</span>prappend_signed_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> plus_freeword.abs_eq <span class="keyword1"><span class="command">unfolding</span></span> eq_onp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-Abs_freeletter_add"><span class="command">lemma</span></span> Abs_freeletter_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">[+]</span> <span class="free">t</span> <span class="main">=</span> Abs_freelist <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freelist_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">t</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-uminus_freeword_Abs_eq"><span class="command">lemma</span></span> uminus_freeword_Abs_eq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span>
    <span class="main">-</span> Abs_freeword <span class="free">xs</span> <span class="main">=</span> Abs_freeword <span class="main">(</span>rev <span class="main">(</span>map flip_signed <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_freeword.abs_eq <span class="keyword1"><span class="command">unfolding</span></span> eq_onp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-uminus_Abs_freeword_singleton"><span class="command">lemma</span></span> uminus_Abs_freeword_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">-</span> Abs_freeword <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> Abs_freeword <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="main">¬</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> uminus_freeword_Abs_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-Abs_freeword_append_uniform_snd"><span class="command">lemma</span></span> Abs_freeword_append_uniform_snd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    Abs_freeword <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span> Abs_freeword <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span>
        proper_signed_list_map_uniform_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
        plus_freeword_abs_eq prappend_signed_list_map_uniform_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1"><span class="command">lemmas</span></span> Abs_freelist_append <span class="main">=</span> Abs_freeword_append_uniform_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted">True</span><span class="main">]</span>

<span class="keyword1" id="Algebra-Abs_freelist_append_append"><span class="command">lemma</span></span> Abs_freelist_append_append<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_freelist <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">@</span><span class="free">zs</span><span class="main">)</span> <span class="main">=</span> Abs_freelist <span class="free">xs</span> <span class="main">+</span> Abs_freelist <span class="free">ys</span> <span class="main">+</span> Abs_freelist <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freelist_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">@</span><span class="free">ys</span>"</span></span><span class="main">]</span> Abs_freelist_append <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-Abs_freelist_inverse"><span class="command">lemma</span></span> Abs_freelist_inverse<span class="main">:</span> <span class="quoted"><span class="quoted">"freeword <span class="main">(</span>Abs_freelist <span class="free">as</span><span class="main">)</span> <span class="main">=</span> map pairtrue <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd Abs_freeword_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-Abs_freeword_singleton_conv_apply_sign_freeletter"><span class="command">lemma</span></span> Abs_freeword_singleton_conv_apply_sign_freeletter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span> <span class="main">=</span> apply_sign Abs_freeletter <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_Abs_freeword_singleton<span class="main">)</span>

<span class="keyword1" id="Algebra-Abs_freeword_conv_freeletter_sum_list"><span class="command">lemma</span></span> Abs_freeword_conv_freeletter_sum_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span>
    Abs_freeword <span class="free">xs</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> apply_sign Abs_freeletter <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freeword_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_freeword_singleton_conv_apply_sign_freeletter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main">)</span>

<span class="keyword1" id="Algebra-freeword_conv_freeletter_sum_list"><span class="command">lemma</span></span> freeword_conv_freeletter_sum_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span>freeword <span class="free">x</span><span class="main">.</span> apply_sign Abs_freeletter <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freeword_conv_freeletter_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"freeword <span class="free">x</span>"</span></span><span class="main">]</span> freeword
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freeword_inverse<span class="main">)</span>

<span class="keyword1" id="Algebra-Abs_freeletter_prod_conv_Abs_freeword"><span class="command">lemma</span></span> Abs_freeletter_prod_conv_Abs_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"snd <span class="free">x</span> <span class="main">⟹</span> Abs_freeletter <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">=</span> Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> prod_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"pairtrue <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lifts of functions on the letter type›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we lift functions on the letter type to type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span>. In particular, we are
  interested in the case where the function being lifted has codomain of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹The universal property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The universal property for free groups says that every function from the letter type to some
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> type gives rise to a unique homomorphism.
›</span></span>

<span class="keyword1" id="Algebra-extend_map_to_freeword_hom'"><span class="command">lemma</span></span> extend_map_to_freeword_hom'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">::</span><span class="tfree">'a</span> signed list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="free">h</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>prappend_signed_list <span class="free">xs</span> <span class="free">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="free">xs</span> <span class="main">+</span> <span class="free">g</span> <span class="free">ys</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2_snoc_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_Cons <span class="skolem">xs</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> flip_signed <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> h <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">-</span> <span class="free">h</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> split_beta'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">b</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> g <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span> <span class="free">g</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">xs</span> <span class="main">+</span> <span class="free">g</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> True snoc_Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> g <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list.append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="free">h</span> <span class="main">(</span><span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"map <span class="free">h</span> <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> h g<span class="main">)</span>

<span class="keyword1" id="Algebra-extend_map_to_freeword_hom1"><span class="command">lemma</span></span> extend_map_to_freeword_hom1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">::</span><span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span>freeword <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span>Abs_freeletter <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_freeword_inverse<span class="main">)</span>

<span class="keyword1" id="Algebra-extend_map_to_freeword_hom2"><span class="command">lemma</span></span> extend_map_to_freeword_hom2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">::</span><span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span>freeword <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"UGroupHom <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span>
            <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> UGroupHomI
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_freeword.rep_eq extend_map_to_freeword_hom'
          <span class="main">)</span>

<span class="keyword1" id="Algebra-uniqueness_of_extended_map_to_freeword_hom'"><span class="command">lemma</span></span> uniqueness_of_extended_map_to_freeword_hom'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">::</span><span class="tfree">'a</span> signed list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">xs</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="free">h</span> <span class="bound">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> singles<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">k</span> <span class="main">[</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span>True<span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     adds   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> proper_signed_list <span class="bound">xs</span> <span class="main">⟹</span> proper_signed_list <span class="bound">ys</span>
            <span class="main">⟹</span> <span class="free">k</span> <span class="main">(</span>prappend_signed_list <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="bound">xs</span> <span class="main">+</span> <span class="free">k</span> <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">g</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> knil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> adds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">k</span> <span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> ksingle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">k</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">g</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> adds x singles
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">(</span>prappend_signed_list <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span>True<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">s</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prappend_signed_list <span class="main">[</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span>False<span class="main">)</span><span class="main">]</span> <span class="main">[</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span>True<span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> collapse_flipped_signed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">False</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">f</span> <span class="skolem">s</span> <span class="main">=</span> <span class="free">k</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">+</span> <span class="free">f</span> <span class="skolem">s</span> <span class="main">+</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x False knil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> x False g h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="free">g</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> x g h singles<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> <span class="free">k</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">g</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> g h <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> adds<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">#</span><span class="skolem">xs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
              prappend_signed_list_single_Cons
              ksingle extend_map_to_freeword_hom'
            <span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> g h knil ksingle<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-uniqueness_of_extended_map_to_freeword_hom"><span class="command">lemma</span></span> uniqueness_of_extended_map_to_freeword_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">h</span><span class="main">::</span><span class="tfree">'a</span> signed <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">::</span><span class="tfree">'a</span> freeword <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="free">h</span> <span class="main">(</span>freeword <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">∘</span> Abs_freeletter <span class="main">=</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"UGroupHom <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> k'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≡</span> <span class="free">k</span> <span class="main">∘</span> Abs_freeword"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">(</span>freeword <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> h_def g_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> uniqueness_of_extended_map_to_freeword_hom'<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> k' k<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">k'</span> <span class="main">[</span>pairtrue <span class="bound">s</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">ys</span><span class="main">.</span> proper_signed_list <span class="bound">xs</span> <span class="main">⟹</span> proper_signed_list <span class="bound">ys</span>
            <span class="main">⟹</span> <span class="skolem">k'</span> <span class="main">(</span>prappend_signed_list <span class="bound">xs</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="bound">xs</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed list"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> xsys<span class="main">:</span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> k'
        <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">(</span>prappend_signed_list <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">k'</span> <span class="skolem">xs</span> <span class="main">+</span> <span class="skolem">k'</span> <span class="skolem">ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> UGroupHom.hom<span class="main">[</span><span class="operator">OF</span> k<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="skolem">ys</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_freeword_abs_eq<span class="main">)</span>      
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span>freeword <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> freeword <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> k' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> freeword_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> universal_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">g</span><span class="main">::</span><span class="tfree">'a</span> freeword<span class="main">⇒</span><span class="tfree">'b</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> Abs_freeletter <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> UGroupHom <span class="bound">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">h</span></span> <span class="keyword2"><span class="keyword">where</span></span> h<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="bound">s</span> <span class="keyword1">else</span> <span class="main">-</span> <span class="main">(</span><span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">x</span><span class="main">.</span> sum_list <span class="main">(</span>map <span class="skolem">h</span> <span class="main">(</span>freeword <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> g h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">∘</span> Abs_freeletter <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> UGroupHom <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> extend_map_to_freeword_hom1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> extend_map_to_freeword_hom2
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> g h <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∘</span> Abs_freeletter <span class="main">=</span> <span class="free">f</span> <span class="main">∧</span> UGroupHom <span class="bound">k</span> <span class="main">⟹</span> <span class="bound">k</span> <span class="main">=</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uniqueness_of_extended_map_to_freeword_hom <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Properties of homomorphisms afforded by the universal property›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The lift of a function on the letter set is the unique additive function on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span>
  that agrees with the original function on letters.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">freeword_funlift</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> freeword<span class="main">⇒</span><span class="tfree">'b</span><span class="main">::</span>group_add<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">freeword_funlift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∘</span> Abs_freeletter <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> UGroupHom <span class="bound">g</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-additive_freeword_funlift"><span class="command">lemma</span></span> additive_freeword_funlift<span class="main">:</span> <span class="quoted"><span class="quoted">"UGroupHom <span class="main">(</span>freeword_funlift <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> universal_property<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> freeword_funlift_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-freeword_funlift_Abs_freeletter"><span class="command">lemma</span></span> freeword_funlift_Abs_freeletter<span class="main">:</span> <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeletter <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     theI'<span class="main">[</span><span class="operator">OF</span> universal_property<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
            comp_apply<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span>"</span></span> <span class="quoted">Abs_freeletter</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> freeword_funlift_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> freeword_funlift_add         <span class="main">=</span> UGroupHom.hom        <span class="main">[</span><span class="operator">OF</span> additive_freeword_funlift<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> freeword_funlift_0           <span class="main">=</span> UGroupHom.im_zero    <span class="main">[</span><span class="operator">OF</span> additive_freeword_funlift<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> freeword_funlift_uminus      <span class="main">=</span> UGroupHom.im_uminus  <span class="main">[</span><span class="operator">OF</span> additive_freeword_funlift<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> freeword_funlift_diff        <span class="main">=</span> UGroupHom.im_diff    <span class="main">[</span><span class="operator">OF</span> additive_freeword_funlift<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> freeword_funlift_lconjby     <span class="main">=</span> UGroupHom.im_lconjby <span class="main">[</span><span class="operator">OF</span> additive_freeword_funlift<span class="main">]</span>

<span class="keyword1" id="Algebra-freeword_funlift_uminus_Abs_freeletter"><span class="command">lemma</span></span> freeword_funlift_uminus_Abs_freeletter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span>False<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> freeword_funlift_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span>False<span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
        uminus_freeword_Abs_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="main">(</span><span class="free">s</span><span class="main">,</span>False<span class="main">)</span><span class="main">]</span>"</span></span><span class="main">]</span>
        freeword_funlift_Abs_freeletter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Algebra-freeword_funlift_Abs_freeword_singleton"><span class="command">lemma</span></span> freeword_funlift_Abs_freeword_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> apply_sign <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_Abs_freeletter freeword_funlift_uminus_Abs_freeletter
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-freeword_funlift_Abs_freeword_Cons"><span class="command">lemma</span></span> freeword_funlift_Abs_freeword_Cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            apply_sign <span class="free">f</span> <span class="free">x</span> <span class="main">+</span> freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="main">+</span>
            freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freeword_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">xs</span></span><span class="main">]</span> freeword_funlift_add <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_Abs_freeword_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-freeword_funlift_Abs_freeword"><span class="command">lemma</span></span> freeword_funlift_Abs_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> apply_sign <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_Abs_freeword_Cons<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
          binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> freeword_funlift_0<span class="main">)</span>

<span class="keyword1" id="Algebra-freeword_funlift_Abs_freelist"><span class="command">lemma</span></span> freeword_funlift_Abs_freelist<span class="main">:</span>
  <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freelist <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freelist_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freeword_funlift_add freeword_funlift_Abs_freeletter<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> freeword_funlift_0<span class="main">)</span>

<span class="keyword1" id="Algebra-freeword_funlift_im'"><span class="command">lemma</span></span> freeword_funlift_im'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span>
    freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">(</span><span class="main">[]</span><span class="main">::</span><span class="tfree">'a</span> signed list<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span> freeword<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zero_freeword.abs_eq<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">(</span><span class="main">[]</span><span class="main">::</span><span class="tfree">'a</span> signed list<span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≡</span> apply_sign <span class="free">f</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≡</span> freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="skolem">xs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> z Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> binrelchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> y Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">+</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_genset_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">S</span>"</span></span><span class="main">]</span>
          genby_uminus_closed genby_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> y z <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_Abs_freeword_Cons
          subst<span class="main">[</span>
            <span class="operator">OF</span>  sym<span class="main">,</span>
            <span class="operator">of</span>  <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">+</span><span class="skolem">z</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span><span class="main">∈</span><span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Free groups on a set›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now take the free group on a set to be the set in the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">type</span></span> freeword<span class="antiquote"><span class="antiquote">}</span></span></span></span> type with letters
  restricted to the given set.
›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Definition and basic facts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we define the set of elements of the free group over a set of letters, and record basic
  facts about that set.
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">FreeGroup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> freeword set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">FreeGroup</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="main">`</span> set <span class="main">(</span>freeword <span class="bound">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Algebra-FreeGroupI_transfer"><span class="command">lemma</span></span> FreeGroupI_transfer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> Abs_freeword <span class="free">xs</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freeword_inverse <span class="keyword1"><span class="command">unfolding</span></span> FreeGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-FreeGroupD"><span class="command">lemma</span></span> FreeGroupD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="main">(</span>freeword <span class="free">x</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> FreeGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-FreeGroupD_transfer"><span class="command">lemma</span></span> FreeGroupD_transfer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> Abs_freeword <span class="free">xs</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freeword_inverse <span class="keyword1"><span class="command">unfolding</span></span> FreeGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-FreeGroupD_transfer'"><span class="command">lemma</span></span> FreeGroupD_transfer'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_freelist <span class="free">xs</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd FreeGroupD_transfer <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-FreeGroup_0_closed"><span class="command">lemma</span></span> FreeGroup_0_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'a</span> freeword<span class="main">)</span> <span class="main">=</span> Abs_freeword <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_freeword.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">[]</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FreeGroupI_transfer<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-FreeGroup_diff_closed"><span class="command">lemma</span></span> FreeGroup_diff_closed<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">-</span><span class="free">y</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≡</span> freeword <span class="free">x</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">≡</span> freeword <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"freeword <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span>
        prappend_signed_list <span class="main">(</span>freeword <span class="free">x</span><span class="main">)</span> <span class="main">(</span>rev <span class="main">(</span>map flip_signed <span class="main">(</span>freeword <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="main">(</span>freeword <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fst <span class="main">`</span> <span class="main">(</span>set <span class="main">(</span>freeword <span class="free">x</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>freeword <span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_set_prappend_signed_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> FreeGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-FreeGroup_Group"><span class="command">lemma</span></span> FreeGroup_Group<span class="main">:</span> <span class="quoted"><span class="quoted">"Group <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> FreeGroup_0_closed FreeGroup_diff_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> FreeGroup_add_closed    <span class="main">=</span> Group.add_closed    <span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> FreeGroup_uminus_closed <span class="main">=</span> Group.uminus_closed <span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> FreeGroup_genby_set_lconjby_set_rconjby_closed <span class="main">=</span>
  Group.genby_set_lconjby_set_rconjby_closed<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">]</span>

<span class="keyword1" id="Algebra-Abs_freelist_in_FreeGroup"><span class="command">lemma</span></span> Abs_freelist_in_FreeGroup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> Abs_freelist <span class="free">ss</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FreeGroupI_transfer<span class="main">)</span>

<span class="keyword1" id="Algebra-Abs_freeletter_in_FreeGroup_iff"><span class="command">lemma</span></span> Abs_freeletter_in_FreeGroup_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Abs_freeletter <span class="free">s</span> <span class="main">∈</span> FreeGroup <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">s</span><span class="main">∈</span><span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freeword_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span>pairtrue <span class="free">s</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> FreeGroup_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Lifts of functions from the letter set to some type of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We again obtain a universal property for functions from the (restricted) letter set to some type
  of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">res_freeword_funlift</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span>
                restrict0 <span class="main">(</span>freeword_funlift <span class="free"><span class="bound"><span class="entity">f</span></span></span><span class="main">)</span> <span class="main">(</span>FreeGroup <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-freeword_funlift_im"><span class="command">lemma</span></span> freeword_funlift_im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> freeword_funlift <span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">f</span> <span class="main">`</span> <span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     freeword<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> freeword_funlift_im'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"freeword <span class="free">x</span>"</span></span><span class="main">]</span>
            freeword_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> FreeGroup_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1" id="Algebra-freeword_funlift_surj'"><span class="command">lemma</span></span> freeword_funlift_surj'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span> <span class="main">∪</span> uminus<span class="main">`</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span> <span class="main">⟹</span> sum_list <span class="free">ys</span> <span class="main">∈</span> freeword_funlift <span class="free">f</span> <span class="main">`</span> FreeGroup <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ys</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> FreeGroup_0_closed freeword_funlift_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ys</span> <span class="main">=</span> freeword_funlift <span class="free">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span> <span class="main">∈</span> freeword_funlift <span class="free">f</span> <span class="main">`</span> FreeGroup <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>1<span class="main">)</span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_freeletter <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> FreeGroupI_transfer<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> FreeGroup_add_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>2<span class="main">)</span> x<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeletter <span class="skolem">s</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> freeword_funlift_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> freeword_funlift_Abs_freeletter
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">-</span> <span class="free">f</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>1<span class="main">)</span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">[</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span>False<span class="main">)</span><span class="main">]</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> FreeGroupI_transfer<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> FreeGroup_add_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>2<span class="main">)</span> x<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="main">[</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span>False<span class="main">)</span><span class="main">]</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> freeword_funlift_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> freeword_funlift_uminus_Abs_freeletter
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-freeword_funlift_surj"><span class="command">lemma</span></span> freeword_funlift_surj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"freeword_funlift <span class="free">f</span> <span class="main">`</span> FreeGroup <span class="free">S</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> freeword_funlift <span class="free">f</span> <span class="main">`</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_im <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">S</span> <span class="main">∪</span> uminus<span class="main">`</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> sum_list <span class="skolem">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_eq_sum_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> freeword_funlift <span class="free">f</span> <span class="main">`</span> FreeGroup <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> freeword_funlift_surj' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-hom_restrict0_freeword_funlift"><span class="command">lemma</span></span> hom_restrict0_freeword_funlift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GroupHom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> <span class="main">(</span>res_freeword_funlift <span class="free">f</span> <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> UGroupHom.restrict0 additive_freeword_funlift FreeGroup_Group
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Algebra-uniqueness_of_restricted_lift"><span class="command">lemma</span></span> uniqueness_of_restricted_lift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GroupHom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span>Abs_freeletter <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> res_freeword_funlift <span class="free">f</span> <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">≡</span> res_freeword_funlift <span class="free">f</span> <span class="free">S</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u_Abs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u_Abs</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">a</span><span class="main">::</span><span class="tfree">'a</span> signed<span class="main">.</span> apply_sign Abs_freeletter <span class="bound">a</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">F</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>map <span class="skolem">u_Abs</span> <span class="main">(</span>freeword <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> FreeGroup <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> u_Abs_def FreeGroupD<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
            Abs_freeletter_in_FreeGroup_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
            FreeGroup_uminus_closed
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> u_Abs_def <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span>freeword <span class="skolem">x</span><span class="main">.</span> <span class="skolem">u_Abs</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> freeword_conv_freeletter_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span>freeword <span class="skolem">x</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">a</span><span class="main">←</span>freeword <span class="skolem">x</span><span class="main">.</span> <span class="skolem">F</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F_def
            GroupHom.im_sum_list_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">u_Abs</span></span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">x</span>"</span></span><span class="main">]</span>
            GroupHom.im_sum_list_map<span class="main">[</span>
              <span class="operator">OF</span> hom_restrict0_freeword_funlift<span class="main">,</span>
              <span class="operator">of</span> <span class="quoted"><span class="skolem">u_Abs</span></span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">f</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span>freeword <span class="skolem">x</span><span class="main">)</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="bound">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">F</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> set <span class="main">(</span>freeword <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">≡</span> Abs_freeletter <span class="main">(</span>fst <span class="skolem">a</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">F</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="skolem">a</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F_def u_Abs_def True assms<span class="main">(</span>2<span class="main">)</span> FreeGroupD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
              GroupHom.im_uminus<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> 
              Abs_freeletter_in_FreeGroup_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
              GroupHom.im_uminus<span class="main">[</span><span class="operator">OF</span> hom_restrict0_freeword_funlift<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
              freeword_funlift_Abs_freeletter<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> F_def
            sum_list_map_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"freeword <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="bound">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="skolem">F</span> <span class="main">(</span><span class="skolem">u_Abs</span> <span class="bound">s</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> F_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> hom_restrict0_freeword_funlift GroupHom.supp suppI_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
            suppI_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> FreeGroup_universal_property<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">T</span><span class="main">::</span><span class="tfree">'a</span> freeword<span class="main">⇒</span><span class="tfree">'b</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">T</span> <span class="main">(</span>Abs_freeletter <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
          GroupHom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> <span class="bound">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> res_freeword_funlift <span class="free">f</span> <span class="free">S</span> <span class="main">(</span>Abs_freeletter <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freeletter_in_FreeGroup_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> freeword_funlift_Abs_freeletter
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">T</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">T</span> <span class="main">(</span>Abs_freeletter <span class="bound">s</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span>
          GroupHom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> <span class="bound">T</span> <span class="main">⟹</span>
          <span class="bound">T</span> <span class="main">=</span> restrict0 <span class="main">(</span>freeword_funlift <span class="free">f</span><span class="main">)</span> <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> uniqueness_of_restricted_lift <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> hom_restrict0_freeword_funlift<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Group presentations›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now define a group presentation to be the quotient of a free group by the subgroup generated by
  all conjugates of a set of relators. We are most concerned with lifting functions on the letter
  set to the free group and with the associated induced homomorphisms on the quotient.
›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹A first group presentation locale and basic facts›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we define a locale that provides a way to construct a group by providing sets of generators
  and relator words.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GroupByPresentation <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>  <span class="comment1">― ‹the set of generators›</span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed list set"</span></span> <span class="comment1">― ‹the set of relator words›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> P_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">ps</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     proper_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> proper_signed_list <span class="free">ps</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≡</span> Abs_freeword <span class="main">`</span> <span class="free">P</span>"</span></span> <span class="comment1">― ‹the set of relators›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≡</span> Group.normal_closure <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> P'"</span></span>
<span class="comment1">― ‹the normal subgroup generated by relators inside the free group›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> Group.quotient_group <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> Q"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> G_UN <span class="main">=</span> Group.quotient_group_UN<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted">Q</span><span class="main">]</span>

<span class="keyword1" id="Algebra-P'_FreeS"><span class="command">lemma</span></span> P'_FreeS<span class="main">:</span> <span class="quoted"><span class="quoted">"P' <span class="main">⊆</span> FreeGroup <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> P_S proper_P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FreeGroupI_transfer<span class="main">)</span>

<span class="keyword1" id="Algebra-relators"><span class="command">lemma</span></span> relators<span class="main">:</span> <span class="quoted"><span class="quoted">"P' <span class="main">⊆</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> FreeGroup_0_closed genby_genset_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> lconjby_P'_FreeS <span class="main">=</span>
  Group.set_lconjby_subset_closed<span class="main">[</span>
    <span class="operator">OF</span> FreeGroup_Group _ P'_FreeS<span class="main">,</span> <span class="operator">OF</span> basic_monos<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
  <span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> Q_FreeS <span class="main">=</span>
  Group.genby_closed<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group lconjby_P'_FreeS<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> Q_subgroup_FreeS <span class="main">=</span>
  Group.genby_subgroup<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group lconjby_P'_FreeS<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> normal_Q <span class="main">=</span> Group.normal_closure<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">,</span> <span class="operator">OF</span> P'_FreeS<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> natural_hom <span class="main">=</span>
  Group.natural_quotient_hom<span class="main">[</span>
    <span class="operator">OF</span> FreeGroup_Group Q_subgroup_FreeS normal_Q
  <span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> natural_hom_image <span class="main">=</span>
  Group.natural_quotient_hom_image<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted">Q</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GroupByPresentation *)</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Functions on the quotient induced from lifted functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A function on the generator set into a type of class <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> lifts to a unique
  homomorphism on the free group. If this lift is trivial on relators, then it factors to a
  homomorphism of the group described by the generators and relators.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GroupByPresentationInducedFun <span class="main">=</span> GroupByPresentation <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">P</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>     <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> signed list set"</span></span> <span class="comment1">― ‹the set of relator words›</span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>group_add"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lift_f_trivial_P<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">ps</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> freeword_funlift <span class="free">f</span> <span class="main">(</span>Abs_freeword <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_f</span> <span class="main">≡</span> freeword_funlift <span class="free">f</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">induced_hom</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword set permutation <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_hom</span> <span class="main">≡</span> GroupHom.quotient_hom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span>
          <span class="main">(</span>restrict0 lift_f <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span><span class="main">)</span> Q"</span></span>
  <span class="comment1">― ‹the <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> restrict0<span class="antiquote">}</span></span> operation is really only necessary to make
<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> GroupByPresentationInducedFun.induced_hom<span class="antiquote">}</span></span> a <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">const</span> GroupHom<span class="antiquote">}</span></span>›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">≡</span> induced_hom"</span></span>

<span class="keyword1" id="Algebra-lift_f_trivial_P'"><span class="command">lemma</span></span> lift_f_trivial_P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span>P' <span class="main">⟹</span> lift_f <span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_f_trivial_P <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-lift_f_trivial_lconjby_P'"><span class="command">lemma</span></span> lift_f_trivial_lconjby_P'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span><span class="main">∈</span>P' <span class="main">⟹</span> lift_f <span class="main">(</span>lconjby <span class="free">w</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> freeword_funlift_lconjby<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> lift_f_trivial_P' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-lift_f_trivial_Q"><span class="command">lemma</span></span> lift_f_trivial_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">q</span><span class="main">∈</span>Q <span class="main">⟹</span> lift_f <span class="free">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> freeword_funlift_0<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span> <span class="main">∈</span> FreeGroup <span class="free">S</span><span class="main">.</span> lconjby <span class="bound">w</span> <span class="main">`</span> P'<span class="main">)</span> <span class="main">⟹</span> lift_f <span class="bound">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lift_f_trivial_lconjby_P' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> freeword"</span></span> <span class="keyword3"><span class="command">assume</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"lift_f <span class="skolem">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"lift_f <span class="skolem">w'</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"lift_f <span class="main">(</span><span class="skolem">w</span> <span class="main">-</span> <span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> lift_f <span class="skolem">w</span> <span class="main">-</span> lift_f <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> freeword_funlift_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ww' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift_f <span class="main">(</span><span class="skolem">w</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-lift_f_ker_Q"><span class="command">lemma</span></span> lift_f_ker_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"Q <span class="main">⊆</span> ker lift_f"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_f_trivial_Q <span class="keyword1"><span class="command">unfolding</span></span> ker_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Algebra-lift_f_Ker_Q"><span class="command">lemma</span></span> lift_f_Ker_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"Q <span class="main">⊆</span> GroupHom.Ker <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> lift_f"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_f_ker_Q Q_FreeS <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-restrict0_lift_f_Ker_Q"><span class="command">lemma</span></span> restrict0_lift_f_Ker_Q<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Q <span class="main">⊆</span> GroupHom.Ker <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> <span class="main">(</span>restrict0 lift_f <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> lift_f_Ker_Q ker_subset_ker_restrict0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-induced_hom_equality"><span class="command">lemma</span></span> induced_hom_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> F <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span><span class="free">w</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> lift_f <span class="free">w</span>"</span></span>
<span class="comment1">― ‹algebraic properties of the induced homomorphism could be proved using its properties as a group
  homomorphism, but it's generally easier to prove them using the algebraic properties of the lift
  via this lemma›</span>
  <span class="keyword1"><span class="command">unfolding</span></span> induced_hom_def
  <span class="keyword1"><span class="command">using</span></span>     GroupHom.quotient_hom_im hom_restrict0_freeword_funlift
            Q_subgroup_FreeS normal_Q restrict0_lift_f_Ker_Q
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-hom_induced_hom"><span class="command">lemma</span></span> hom_induced_hom<span class="main">:</span> <span class="quoted"><span class="quoted">"GroupHom G F"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> induced_hom_def
  <span class="keyword1"><span class="command">using</span></span>     GroupHom.quotient_hom hom_restrict0_freeword_funlift
            Q_subgroup_FreeS normal_Q restrict0_lift_f_Ker_Q
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Algebra-induced_hom_Abs_freeletter_equality"><span class="command">lemma</span></span> induced_hom_Abs_freeletter_equality<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> F <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freeletter <span class="free">s</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freeletter_in_FreeGroup_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>        
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> induced_hom_equality freeword_funlift_Abs_freeletter<span class="main">)</span>

<span class="keyword1" id="Algebra-uniqueness_of_induced_hom'"><span class="command">lemma</span></span> uniqueness_of_induced_hom'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">q</span> <span class="main">≡</span> Group.natural_quotient_hom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> Q"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GroupHom G <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freeletter <span class="bound">s</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∘</span> <span class="free">q</span> <span class="main">=</span> F <span class="main">∘</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∘</span><span class="free">q</span> <span class="main">=</span> res_freeword_funlift <span class="free">f</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> natural_hom natural_hom_image Abs_freeletter_in_FreeGroup_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> uniqueness_of_restricted_lift GroupHom.comp<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"F <span class="main">∘</span> <span class="free">q</span> <span class="main">=</span> res_freeword_funlift <span class="free">f</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_hom_equality GroupHom.im_zero<span class="main">[</span><span class="operator">OF</span> hom_induced_hom<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>  
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-uniqueness_of_induced_hom"><span class="command">lemma</span></span> uniqueness_of_induced_hom<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"GroupHom G <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">T</span> <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freeletter <span class="bound">s</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">=</span> F"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> F <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>G"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≡</span> Group.natural_quotient_hom <span class="main">(</span>FreeGroup <span class="free">S</span><span class="main">)</span> Q"</span></span>
    <span class="keyword1"><span class="command">from</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span><span class="skolem">w</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G_UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> q_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">T</span><span class="main">∘</span><span class="skolem">q</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"F <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span>F<span class="main">∘</span><span class="skolem">q</span><span class="main">)</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms q_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> uniqueness_of_induced_hom' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> hom_induced_hom GroupHom.supp suppI_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
            suppI_contra<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted">F</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> induced_hom_universal_property<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">F</span><span class="main">.</span> GroupHom G <span class="bound">F</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="bound">F</span> <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freeletter <span class="bound">s</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> hom_induced_hom induced_hom_Abs_freeletter_equality
        uniqueness_of_induced_hom
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>

<span class="keyword1" id="Algebra-induced_hom_Abs_freelist_conv_sum_list"><span class="command">lemma</span></span> induced_hom_Abs_freelist_conv_sum_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟹</span> F <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freelist <span class="free">ss</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∑</span><span class="bound">s</span><span class="main">←</span><span class="free">ss</span><span class="main">.</span> <span class="free">f</span> <span class="bound">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        Abs_freelist_in_FreeGroup induced_hom_equality freeword_funlift_Abs_freelist
      <span class="main">)</span>

<span class="keyword1" id="Algebra-induced_hom_surj"><span class="command">lemma</span></span> induced_hom_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"F<span class="main">`</span>G <span class="main">=</span> <span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span>F<span class="main">`</span>G <span class="main">⟹</span> <span class="bound">x</span><span class="main">∈</span><span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G_UN induced_hom_equality freeword_funlift_surj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="main">⟨</span><span class="free">f</span><span class="main">`</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> lift_f <span class="main">`</span> FreeGroup <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> freeword_funlift_surj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> F<span class="main">`</span>G"</span></span> <span class="keyword1"><span class="command">using</span></span> induced_hom_equality G_UN <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GroupByPresentationInducedFun *)</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Groups affording a presentation›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> GroupByPresentation<span class="antiquote"><span class="antiquote">}</span></span></span></span> allows the construction of a <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Group<span class="antiquote"><span class="antiquote">}</span></span></span></span> out of any
  type from a set of generating letters and a set of relator words in (signed) letters. The
  following locale concerns the question of when the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> Group<span class="antiquote"><span class="antiquote">}</span></span></span></span> generated by a set in class
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">class</span></span> group_add<span class="antiquote"><span class="antiquote">}</span></span></span></span> is isomorphic to a group presentation.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> GroupWithGeneratorsRelators <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">::</span>group_add set"</span></span> <span class="comment1">― ‹the set of generators›</span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> list set"</span></span> <span class="comment1">― ‹the set of relator words›</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> relators<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> <span class="free">rs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> sum_list <span class="free">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> proper_signed_list <span class="main">(</span>map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="free">rs</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="main">`</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≡</span> GroupByPresentation.P' P"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≡</span> GroupByPresentation.Q <span class="free">S</span> P"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> GroupByPresentation.G <span class="free">S</span> P"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">relator_freeword</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span> <span class="main">≡</span> Abs_freeword <span class="main">(</span>map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rs</span></span></span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹this maps R onto P'›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">freeliftid</span> <span class="main">≡</span> freeword_funlift id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">induced_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> freeword set permutation <span class="main">⇒</span> <span class="tfree">'g</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_id</span> <span class="main">≡</span> GroupByPresentationInducedFun.induced_hom <span class="free">S</span> P id"</span></span>

<span class="keyword1" id="Algebra-GroupByPresentation_S_P"><span class="command">lemma</span></span> GroupByPresentation_S_P<span class="main">:</span> <span class="quoted"><span class="quoted">"GroupByPresentation <span class="free">S</span> P"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">∈</span> P <span class="main">⟹</span> fst <span class="main">`</span> set <span class="bound">ps</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fst_set_map_charpair_un_uminus relators<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ps</span><span class="main">.</span> <span class="bound">ps</span> <span class="main">∈</span> P <span class="main">⟹</span> proper_signed_list <span class="bound">ps</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> relators<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> G_UN     <span class="main">=</span> GroupByPresentation.G_UN<span class="main">[</span><span class="operator">OF</span> GroupByPresentation_S_P<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> P'_FreeS <span class="main">=</span> GroupByPresentation.P'_FreeS<span class="main">[</span><span class="operator">OF</span> GroupByPresentation_S_P<span class="main">]</span>

<span class="keyword1" id="Algebra-freeliftid_trivial_relator_freeword_R"><span class="command">lemma</span></span> freeliftid_trivial_relator_freeword_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">∈</span><span class="free">R</span> <span class="main">⟹</span> freeliftid <span class="main">(</span>relator_freeword <span class="free">rs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> relators<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> freeword_funlift_Abs_freeword<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="free">rs</span>"</span></span> <span class="quoted">id</span><span class="main">]</span>
        sum_list_map_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>apply_sign id<span class="main">)</span> <span class="main">∘</span> <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span>"</span></span> <span class="quoted">id</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Algebra-freeliftid_trivial_P"><span class="command">lemma</span></span> freeliftid_trivial_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ps</span><span class="main">∈</span>P <span class="main">⟹</span> freeliftid <span class="main">(</span>Abs_freeword <span class="free">ps</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> freeliftid_trivial_relator_freeword_R <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-GroupByPresentationInducedFun_S_P_id"><span class="command">lemma</span></span> GroupByPresentationInducedFun_S_P_id<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GroupByPresentationInducedFun <span class="free">S</span> P id"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span>
        <span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> GroupByPresentation_S_P<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> freeliftid_trivial_P
      <span class="main">)</span>

<span class="keyword1" id="Algebra-induced_id_Abs_freelist_conv_sum_list"><span class="command">lemma</span></span> induced_id_Abs_freelist_conv_sum_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟹</span> induced_id <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freelist <span class="free">ss</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        GroupByPresentationInducedFun.induced_hom_Abs_freelist_conv_sum_list<span class="main"><span class="main">[</span></span>
          <span class="operator">OF</span> GroupByPresentationInducedFun_S_P_id
        <span class="main"><span class="main">]</span></span>
      <span class="main">)</span>

<span class="keyword1" id="Algebra-lconj_relator_freeword_R"><span class="command">lemma</span></span> lconj_relator_freeword_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">rs</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> proper_signed_list <span class="free">xs</span><span class="main">;</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span>
    lconjby <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>relator_freeword <span class="free">rs</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> genby_genset_closed FreeGroupI_transfer<span class="main">)</span>

<span class="keyword1" id="Algebra-rconj_relator_freeword"><span class="command">lemma</span></span> rconj_relator_freeword<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">rs</span><span class="main">∈</span><span class="free">R</span>"</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"rconjby <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>relator_freeword <span class="free">rs</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> genby_genset_closed<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> UN_I<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> Abs_freeword <span class="free">xs</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FreeGroupI_transfer<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> FreeGroup_uminus_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"rconjby <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>relator_freeword <span class="free">rs</span><span class="main">)</span> <span class="main">∈</span>
            lconjby <span class="main">(</span><span class="main">-</span> Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">`</span> Abs_freeword <span class="main">`</span> P"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-lconjby_Abs_freelist_relator_freeword"><span class="command">lemma</span></span> lconjby_Abs_freelist_relator_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">rs</span><span class="main">∈</span><span class="free">R</span><span class="main">;</span> <span class="free">xs</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span> lconjby <span class="main">(</span>Abs_freelist <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>relator_freeword <span class="free">rs</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lconj_relator_freeword_R<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we record that the lift of the identity map to the free group on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> induces a
  homomorphic surjection onto the group generated by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> from the group presentation on
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, subject to the same relations as the elements of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> induced_id_hom_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"GroupHom G induced_id"</span></span> <span class="quoted"><span class="quoted">"induced_id <span class="main">`</span> G <span class="main">=</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> GroupByPresentationInducedFun.hom_induced_hom<span class="main">[</span>
          <span class="operator">OF</span> GroupByPresentationInducedFun_S_P_id
        <span class="main">]</span>
        GroupByPresentationInducedFun.induced_hom_surj<span class="main">[</span>
          <span class="operator">OF</span> GroupByPresentationInducedFun_S_P_id
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context GroupWithGeneratorsRelators *)</span>

<span class="keyword1"><span class="command">locale</span></span> GroupPresentation <span class="main">=</span> GroupWithGeneratorsRelators <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">R</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span><span class="main">::</span>group_add set"</span></span> <span class="comment1">― ‹the set of generators›</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'g</span> list set"</span></span> <span class="comment1">― ‹the set of relator words›</span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> induced_id_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on induced_id G"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_induced_id</span> <span class="main">≡</span> the_inv_into G induced_id"</span></span>

<span class="keyword1" id="Algebra-inv_induced_id_sum_list_S"><span class="command">lemma</span></span> inv_induced_id_sum_list_S<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> inv_induced_id <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span>Abs_freelist <span class="free">ss</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> G_UN induced_id_inj induced_id_Abs_freelist_conv_sum_list
        Abs_freelist_in_FreeGroup
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the_inv_into_f_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* GroupPresentation *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Words over a generating set›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we gather the necessary constructions and facts for studying a group generated by some set
  in terms of words in the generators.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> monoid_add
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">word_for</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">∈</span> lists <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">∧</span> sum_list <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">reduced_word_for</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduced_word_for</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> is_arg_min length <span class="main">(</span>word_for <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduced_word</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">as</span></span></span> <span class="main">≡</span> reduced_word_for <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span>sum_list <span class="free"><span class="bound"><span class="entity">as</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">as</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduced_words_for</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> Collect <span class="main">(</span>reduced_word_for <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">reduced_letter_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">reduced_letter_set</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">(</span> set <span class="main">`</span> <span class="main">(</span>reduced_words_for <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main">)</span>"</span></span>
  <span class="comment1">― ‹will be empty if <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">a</span></span><span class="antiquote">}</span></span> is not in the set generated by <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">A</span></span><span class="antiquote">}</span></span>›</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">word_length</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">word_length</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">≡</span> length <span class="main">(</span>arg_min length <span class="main">(</span>word_for <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algebra-reduced_word_forI"><span class="command">lemma</span></span> reduced_word_forI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">bs</span><span class="main">.</span> <span class="bound">bs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> sum_list <span class="bound">bs</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> length <span class="free">as</span> <span class="main">≤</span> length <span class="bound">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms 
  <span class="keyword1"><span class="command">unfolding</span></span> reduced_word_for_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> is_arg_minI<span class="main">)</span>

<span class="keyword1" id="Algebra-reduced_word_forI_compare"><span class="command">lemma</span></span> reduced_word_forI_compare<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span><span class="main">;</span> <span class="free">bs</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">;</span> sum_list <span class="free">bs</span> <span class="main">=</span> <span class="free">a</span><span class="main">;</span> length <span class="free">bs</span> <span class="main">=</span> length <span class="free">as</span> <span class="main">⟧</span>
    <span class="main">⟹</span> reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_def is_arg_min_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-reduced_word_for_lists"><span class="command">lemma</span></span> reduced_word_for_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_def is_arg_minD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-reduced_word_for_sum_list"><span class="command">lemma</span></span> reduced_word_for_sum_list<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span> <span class="main">⟹</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_def is_arg_minD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-reduced_word_for_minimal"><span class="command">lemma</span></span> reduced_word_for_minimal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span><span class="main">;</span> <span class="free">bs</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">;</span> sum_list <span class="free">bs</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span>
    length <span class="free">as</span> <span class="main">≤</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_def is_arg_minD2<span class="main">[</span><span class="operator">of</span> <span class="quoted">length</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-reduced_word_for_length"><span class="command">lemma</span></span> reduced_word_for_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span> <span class="main">⟹</span> length <span class="free">as</span> <span class="main">=</span> word_length <span class="free">A</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> word_length_def reduced_word_for_def is_arg_min_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_min_equality<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Algebra-reduced_word_for_eq_length"><span class="command">lemma</span></span> reduced_word_for_eq_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span> <span class="main">⟹</span> reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">bs</span> <span class="main">⟹</span> length <span class="free">as</span> <span class="main">=</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-reduced_word_for_arg_min"><span class="command">lemma</span></span> reduced_word_for_arg_min<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span>
    reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>arg_min length <span class="main">(</span>word_for <span class="free">A</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     is_arg_min_arg_min_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"word_for <span class="free">A</span> <span class="free">a</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduced_word_for_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Algebra-nil_reduced_word_for_0"><span class="command">lemma</span></span> nil_reduced_word_for_0<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="main">0</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduced_word_forI<span class="main">)</span>

<span class="keyword1" id="Algebra-reduced_word_for_0_imp_nil"><span class="command">lemma</span></span> reduced_word_for_0_imp_nil<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="main">0</span> <span class="free">as</span> <span class="main">⟹</span> <span class="free">as</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     nil_reduced_word_for_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> reduced_word_for_def is_arg_min_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> length_0_conv length_greater_0_conv<span class="main">)</span>

<span class="keyword1" id="Algebra-not_reduced_word_for"><span class="command">lemma</span></span> not_reduced_word_for<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">bs</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">;</span> sum_list <span class="free">bs</span> <span class="main">=</span> <span class="free">a</span><span class="main">;</span> length <span class="free">bs</span> <span class="main">&lt;</span> length <span class="free">as</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">¬</span> reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_minimal <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-reduced_word_for_imp_reduced_word"><span class="command">lemma</span></span> reduced_word_for_imp_reduced_word<span class="main">:</span>
  <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span> <span class="main">⟹</span> reduced_word <span class="free">A</span> <span class="free">as</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> reduced_word_for_def is_arg_min_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduced_word_forI<span class="main">)</span>

<span class="keyword1" id="Algebra-sum_list_zero_nreduced"><span class="command">lemma</span></span> sum_list_zero_nreduced<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word <span class="free">A</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_reduced_word_for<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-order2_nreduced"><span class="command">lemma</span></span> order2_nreduced<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">+</span><span class="free">a</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word <span class="free">A</span> <span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> sum_list_zero_nreduced <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-reduced_word_append_reduce_contra1"><span class="command">lemma</span></span> reduced_word_append_reduce_contra1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word <span class="free">A</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word <span class="free">A</span> <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> both
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">≡</span> <span class="keyword1">ARG_MIN</span> length <span class="bound">cs</span><span class="main">.</span> <span class="bound">cs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">∧</span> sum_list <span class="bound">cs</span> <span class="main">=</span> sum_list <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> both<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="main">(</span>sum_list <span class="free">as</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_def is_arg_min_arg_min_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"word_for <span class="free">A</span> <span class="main">(</span>sum_list <span class="free">as</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms both <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists reduced_word_for_sum_list
          reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span>"</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
          reduced_word_forI_compare<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span>"</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
          not_reduced_word_for<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span><span class="main">@</span><span class="free">bs</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> one <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> other <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> neither <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-reduced_word_append_reduce_contra2"><span class="command">lemma</span></span> reduced_word_append_reduce_contra2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word <span class="free">A</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word <span class="free">A</span> <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> both
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">≡</span> <span class="keyword1">ARG_MIN</span> length <span class="bound">cs</span><span class="main">.</span> <span class="bound">cs</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">∧</span> sum_list <span class="bound">cs</span> <span class="main">=</span> sum_list <span class="free">bs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> both<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="main">(</span>sum_list <span class="free">bs</span><span class="main">)</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_def is_arg_min_arg_min_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"word_for <span class="free">A</span> <span class="main">(</span>sum_list <span class="free">bs</span><span class="main">)</span>"</span></span> <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms both <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists reduced_word_for_sum_list
          reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">bs</span>"</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">]</span>
          reduced_word_forI_compare<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">bs</span>"</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">]</span>
          not_reduced_word_for<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> one <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> other <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> neither <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-contains_nreduced_imp_nreduced"><span class="command">lemma</span></span> contains_nreduced_imp_nreduced<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word <span class="free">A</span> <span class="free">bs</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word <span class="free">A</span> <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_append_reduce_contra1 reduced_word_append_reduce_contra2
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Algebra-contains_order2_nreduced"><span class="command">lemma</span></span> contains_order2_nreduced<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">+</span><span class="free">a</span><span class="main">=</span><span class="main">0</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word <span class="free">A</span> <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">a</span><span class="main">,</span><span class="free">a</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> order2_nreduced contains_nreduced_imp_nreduced <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-reduced_word_Cons_reduce_contra"><span class="command">lemma</span></span> reduced_word_Cons_reduce_contra<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word <span class="free">A</span> <span class="free">as</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word <span class="free">A</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_append_reduce_contra2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-reduced_word_Cons_reduce"><span class="command">lemma</span></span> reduced_word_Cons_reduce<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word <span class="free">A</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">⟹</span> reduced_word <span class="free">A</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_Cons_reduce_contra <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-reduced_word_singleton"><span class="command">lemma</span></span> reduced_word_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"reduced_word <span class="free">A</span> <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> reduced_word_forI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">bs</span> <span class="keyword3"><span class="command">assume</span></span> bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">bs</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="free">a</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">[</span><span class="free">a</span><span class="main">]</span> <span class="main">≤</span> length <span class="skolem">bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-el_reduced"><span class="command">lemma</span></span> el_reduced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word <span class="free">A</span> <span class="free">as</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≡</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">∈</span>lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">=</span> sum_list <span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> n assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">≤</span><span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span><span class="main">&gt;</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="main">_</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> n <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-reduced_letter_set_0"><span class="command">lemma</span></span> reduced_letter_set_0<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_letter_set <span class="free">A</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_0_imp_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algebra-reduced_letter_set_subset"><span class="command">lemma</span></span> reduced_letter_set_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_letter_set <span class="free">A</span> <span class="free">a</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Algebra-reduced_word_forI_length"><span class="command">lemma</span></span> reduced_word_forI_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">;</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span><span class="main">;</span> length <span class="free">as</span> <span class="main">=</span> word_length <span class="free">A</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span>
    reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_arg_min reduced_word_for_length
        reduced_word_forI_compare<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">a</span></span> <span class="main">_</span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-word_length_le"><span class="command">lemma</span></span> word_length_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> word_length <span class="free">A</span> <span class="free">a</span> <span class="main">≤</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_arg_min reduced_word_for_length
        reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-reduced_word_forI_length'"><span class="command">lemma</span></span> reduced_word_forI_length'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span><span class="main">;</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span><span class="main">;</span> length <span class="free">as</span> <span class="main">≤</span> word_length <span class="free">A</span> <span class="free">a</span> <span class="main">⟧</span> <span class="main">⟹</span>
    reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> word_length_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> reduced_word_forI_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Algebra-word_length_lt"><span class="command">lemma</span></span> word_length_lt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span> <span class="main">⟹</span> sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="free">as</span> <span class="main">⟹</span>
    word_length <span class="free">A</span> <span class="free">a</span> <span class="main">&lt;</span> length <span class="free">as</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_forI_length' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context monoid_add *)</span>

<span class="keyword1" id="Algebra-in_genby_reduced_letter_set"><span class="command">lemma</span></span> in_genby_reduced_letter_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">⟨</span>reduced_letter_set <span class="free">A</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≡</span> arg_min length <span class="main">(</span>word_for <span class="free">A</span> <span class="free">a</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="main">(</span>reduced_letter_set <span class="free">A</span> <span class="free">a</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">xs</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_arg_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> reduced_word_for_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> genby_eq_sum_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-reduced_word_for_genby_arg_min"><span class="command">lemma</span></span> reduced_word_for_genby_arg_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>group_add set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> <span class="free">A</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">B</span> <span class="free">a</span> <span class="main">(</span>arg_min length <span class="main">(</span>word_for <span class="free">B</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms genby_eq_sum_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> reduced_word_for_arg_min<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Algebra-reduced_word_for_genby_sym_arg_min"><span class="command">lemma</span></span> reduced_word_for_genby_sym_arg_min<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">A</span> <span class="free">a</span> <span class="main">(</span>arg_min length <span class="main">(</span>word_for <span class="free">A</span> <span class="free">a</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_genby_arg_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algebra-in_genby_imp_in_reduced_letter_set"><span class="command">lemma</span></span> in_genby_imp_in_reduced_letter_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">A</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>group_add set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">≡</span> <span class="free">A</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">∈</span> <span class="main">⟨</span>reduced_letter_set <span class="free">B</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms genby_eq_sum_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> in_genby_reduced_letter_set<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Algebra-in_genby_sym_imp_in_reduced_letter_set"><span class="command">lemma</span></span> in_genby_sym_imp_in_reduced_letter_set<span class="main">:</span>
  <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">A</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">a</span> <span class="main">∈</span> <span class="main">⟨</span>reduced_letter_set <span class="free">A</span> <span class="free">a</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_genby_imp_in_reduced_letter_set <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Un_absorb2<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Simplicial">
<div class="head">
<h1>Theory Simplicial</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Simplicial complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we develop the basic theory of abstract simplicial complexes as a collection of
  finite sets, where the power set of each member set is contained in the collection. Note that in
  this development we allow the empty simplex, since allowing it or not seemed of no logical
  consequence, but of some small practical consequence. 
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Simplicial
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Prelim">Prelim</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Geometric notions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The geometric notions attached to a simplicial complex of main interest to us are those of facets
  (subsets of codimension one), adjacency (sharing a facet in common), and chains of adjacent
  simplices.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Facets›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">facetrel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⊲</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> insert <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Simplicial-facetrelI"><span class="command">lemma</span></span> facetrelI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> insert <span class="free">v</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-facetrelI_card"><span class="command">lemma</span></span> facetrelI_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊆</span> <span class="free">x</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">-</span><span class="free">y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> facetrelI<span class="main">)</span>

<span class="keyword1" id="Simplicial-facetrel_complement_vertex"><span class="command">lemma</span></span> facetrel_complement_vertex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">⊲</span><span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> insert <span class="free">v</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">v</span><span class="main">∉</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facetrel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-facetrel_diff_vertex"><span class="command">lemma</span></span> facetrel_diff_vertex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">-</span><span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">⊲</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> facetrelI<span class="main">)</span>

<span class="keyword1" id="Simplicial-facetrel_conv_insert"><span class="command">lemma</span></span> facetrel_conv_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> insert <span class="free">v</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-facetrel_psubset"><span class="command">lemma</span></span> facetrel_psubset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊂</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-facetrel_subset"><span class="command">lemma</span></span> facetrel_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊆</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facetrel_psubset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-facetrel_card"><span class="command">lemma</span></span> facetrel_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> insert_Diff_if<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-finite_facetrel_card"><span class="command">lemma</span></span> finite_facetrel_card<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">⊲</span><span class="free">x</span> <span class="main">⟹</span> card <span class="free">x</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facetrel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> card_insert_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-facetrelI_cardSuc"><span class="command">lemma</span></span> facetrelI_cardSuc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">x</span> <span class="main">⟹</span> card <span class="free">x</span> <span class="main">=</span> Suc <span class="main">(</span>card <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> card_ge_0_finite finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> card_Diff_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> facetrelI_card<span class="main">)</span>

<span class="keyword1" id="Simplicial-facet2_subset"><span class="command">lemma</span></span> facet2_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">z</span><span class="main">⊲</span><span class="free">x</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main">∩</span><span class="free">y</span> <span class="main">-</span> <span class="free">z</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊆</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Simplicial-inj_on_pullback_facet"><span class="command">lemma</span></span> inj_on_pullback_facet<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="free">y</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊲</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∉</span><span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> facetrel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">≡</span> the_inv_into <span class="free">x</span> <span class="free">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">v</span></span><span class="main">∈</span><span class="free">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms<span class="main">(</span>2<span class="main">)</span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> insert <span class="skolem">u</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_eq<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> the_inv_into_into<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊲</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> v f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> facetrelI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> y assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">y</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> facetrel_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Adjacency›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adjacent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">∼</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">∼</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">⊲</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">z</span><span class="main">⊲</span><span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1" id="Simplicial-adjacentI"><span class="command">lemma</span></span> adjacentI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∼</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-empty_not_adjacent"><span class="command">lemma</span></span> empty_not_adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">{}</span> <span class="main">∼</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adjacent_sym"><span class="command">lemma</span></span> adjacent_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∼</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adjacent_refl"><span class="command">lemma</span></span> adjacent_refl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> facetrelI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-common_facet"><span class="command">lemma</span></span> common_facet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">z</span><span class="main">⊲</span><span class="free">x</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">y</span><span class="main">;</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∩</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facetrel_subset facet2_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adjacent_int_facet1"><span class="command">lemma</span></span> adjacent_int_facet1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∩</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> common_facet <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adjacent_int_facet2"><span class="command">lemma</span></span> adjacent_int_facet2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">∩</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_sym adjacent_int_facet1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>

<span class="keyword1" id="Simplicial-adjacent_conv_insert"><span class="command">lemma</span></span> adjacent_conv_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">x</span> <span class="main">-</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> insert <span class="free">v</span> <span class="main">(</span><span class="free">x</span><span class="main">∩</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_int_facet1 facetrel_conv_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adjacent_int_decomp"><span class="command">lemma</span></span> adjacent_int_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∉</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> insert <span class="bound">v</span> <span class="main">(</span><span class="free">x</span><span class="main">∩</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_int_facet1 <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adj_antivertex"><span class="command">lemma</span></span> adj_antivertex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∼</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="free">x</span><span class="main">-</span><span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∉</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> insert <span class="skolem">w</span> <span class="main">(</span><span class="free">x</span><span class="main">∩</span><span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="free">x</span><span class="main">-</span><span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="free">x</span><span class="main">-</span><span class="free">y</span> <span class="main">⟹</span> <span class="bound">v</span><span class="main">=</span><span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span> <span class="bound">v'</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="free">x</span><span class="main">-</span><span class="free">y</span> <span class="main">⟹</span> <span class="bound">v'</span><span class="main">∈</span><span class="free">x</span><span class="main">-</span><span class="free">y</span> <span class="main">⟹</span> <span class="bound">v</span><span class="main">=</span><span class="bound">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-adjacent_card"><span class="command">lemma</span></span> adjacent_card<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∼</span> <span class="free">y</span> <span class="main">⟹</span> card <span class="free">x</span> <span class="main">=</span> card <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> adjacent_def facetrel_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"finite <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">=</span><span class="free">y</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-adjacent_to_adjacent_int_subset"><span class="command">lemma</span></span> adjacent_to_adjacent_int_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> insert <span class="skolem">w</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">∩</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> w <span class="keyword1"><span class="command">have</span></span> w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> v assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fv_w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> adjacent_conv_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> a1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">∈</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   a2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a2</span> <span class="main">∈</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">a2</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> v a1 a2<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">∉</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">f</span> <span class="skolem">a2</span> <span class="main">=</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fv_w <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> a2<span class="main">(</span>1<span class="main">)</span> w' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a1</span> <span class="main">∈</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> a1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-adjacent_to_adjacent_int"><span class="command">lemma</span></span> adjacent_to_adjacent_int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">∼</span> <span class="free">D</span><span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_to_adjacent_int_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Chains of adjacent sets›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">adjacentchain</span>  <span class="main">≡</span> binrelchain adjacent"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">padjacentchain</span> <span class="main">≡</span> proper_binrelchain adjacent"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> adjacentchain_Cons_reduce   <span class="main">=</span> binrelchain_Cons_reduce   <span class="main">[</span><span class="operator">of</span> <span class="quoted">adjacent</span><span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> adjacentchain_obtain_proper <span class="main">=</span> binrelchain_obtain_proper <span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">adjacent</span><span class="main">]</span>

<span class="keyword1" id="Simplicial-adjacentchain_card"><span class="command">lemma</span></span> adjacentchain_card<span class="main">:</span> <span class="quoted"><span class="quoted">"adjacentchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> card <span class="free">x</span> <span class="main">=</span> card <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_card <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locale and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> SimplicialComplex <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> finite_simplices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> finite <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     faces           <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">⊆</span><span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">X</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> SimplicialComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Subcomplex</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∧</span> SimplicialComplex <span class="free"><span class="bound"><span class="entity">Y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">maxsimp</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∈</span><span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">⊆</span><span class="bound">z</span> <span class="main">⟶</span> <span class="bound">z</span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adjacentset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">adjacentset</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">y</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∼</span><span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Simplicial-finite_simplex"><span class="command">lemma</span></span> finite_simplex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> finite <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_simplices <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Simplicial-singleton_simplex"><span class="command">lemma</span></span> singleton_simplex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> faces <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpI"><span class="command">lemma</span></span> maxsimpI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">⊆</span><span class="bound">z</span> <span class="main">⟹</span> <span class="bound">z</span><span class="main">=</span><span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> maxsimp <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpD_simplex"><span class="command">lemma</span></span> maxsimpD_simplex<span class="main">:</span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-maxsimpD_maximal"><span class="command">lemma</span></span> maxsimpD_maximal<span class="main">:</span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">⊆</span><span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">=</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> finite_maxsimp <span class="main">=</span> finite_simplex<span class="main">[</span><span class="operator">OF</span> maxsimpD_simplex<span class="main">]</span>

<span class="keyword1" id="Simplicial-maxsimp_nempty"><span class="command">lemma</span></span> maxsimp_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span> <span class="main">⟹</span> maxsimp <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> maxsimp_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span> 

<span class="keyword1" id="Simplicial-maxsimp_vertices"><span class="command">lemma</span></span> maxsimp_vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">⊆</span><span class="main">⋃</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpD_simplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-adjacentsetD_adj"><span class="command">lemma</span></span> adjacentsetD_adj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> adjacentset <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∼</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacentset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-max_in_subcomplex"><span class="command">lemma</span></span> max_in_subcomplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subcomplex <span class="free">Y</span><span class="main">;</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">;</span> maxsimp <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> SimplicialComplex.maxsimp <span class="free">Y</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpD_maximal <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> SimplicialComplex.maxsimpI<span class="main">)</span>

<span class="keyword1" id="Simplicial-face_im"><span class="command">lemma</span></span> face_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span><span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">w</span><span class="main">.</span> <span class="free">f</span> <span class="bound">a</span> <span class="main">∈</span> <span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">u</span></span><span class="main">]</span> image_eqI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="free">u</span></span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-im_faces"><span class="command">lemma</span></span> im_faces<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">⊢</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">⊆</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">⊢</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> faces face_im<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-map_is_simplicial_morph"><span class="command">lemma</span></span> map_is_simplicial_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"SimplicialComplex <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">.</span> finite <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_simplices <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span> <span class="bound">y</span><span class="main">⊆</span><span class="bound">x</span> <span class="main">⟹</span> <span class="bound">y</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> im_faces <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-vertex_set_int"><span class="command">lemma</span></span> vertex_set_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="free">Y</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span><span class="free">Y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">⋃</span><span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span><span class="free">Y</span> <span class="main">⟹</span> <span class="bound">v</span><span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> faces SimplicialComplex.faces<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">X</span><span class="main">∩</span><span class="free">Y</span><span class="main">)</span> <span class="main">⊇</span> <span class="main">⋃</span><span class="free">X</span> <span class="main">∩</span> <span class="main">⋃</span><span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context SimplicialComplex *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Chains of maximal simplices›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Chains of maximal simplices (with respect to adjacency) will allow us to walk through chamber
  complexes. But there is much we can say about them in simplicial complexes. We will call a chain
  of maximal simplices proper (using the prefix <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p›</span></span></span></span> as a naming convention to denote proper)
  if no maximal simplex appears more than once in the chain. (Some sources elect to call improper
  chains prechains, and reserve the name chain to describe a proper chain. And usually a slightly
  weaker notion of proper is used, requiring only that no maximal simplex appear twice in succession. But
  it essentially makes no difference, and we found it easier to use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> distinct<span class="antiquote"><span class="antiquote">}</span></span></span></span> rather than
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"binrelchain not_equal"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.)
›</span></span>

<span class="keyword1"><span class="command">context</span></span> SimplicialComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">maxsimpchain</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span>  <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> maxsimp <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> adjacentchain <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">pmaxsimpchain</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> maxsimp <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> padjacentchain <span class="free"><span class="bound"><span class="entity">xs</span></span></span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">min_maxsimpchain</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">min_maxsimpchain</span> <span class="main">[]</span> <span class="main">=</span> True"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_maxsimpchain</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span> <span class="main">=</span> maxsimp <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">min_maxsimpchain</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">≠</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> is_arg_min length <span class="main">(</span><span class="main">λ</span><span class="bound">zs</span><span class="main">.</span> maxsimpchain <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">#</span><span class="bound">zs</span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure length"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpchain_snocI"><span class="command">lemma</span></span> maxsimpchain_snocI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> maxsimp <span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main">∼</span><span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def binrelchain_snoc maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpchainD_maxsimp"><span class="command">lemma</span></span> maxsimpchainD_maxsimp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> maxsimp <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-maxsimpchainD_adj"><span class="command">lemma</span></span> maxsimpchainD_adj<span class="main">:</span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="free">xs</span> <span class="main">⟹</span> adjacentchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-maxsimpchain_CConsI"><span class="command">lemma</span></span> maxsimpchain_CConsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maxsimp <span class="free">w</span><span class="main">;</span> maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">w</span><span class="main">∼</span><span class="free">x</span> <span class="main">⟧</span> <span class="main">⟹</span> maxsimpchain <span class="main">(</span><span class="free">w</span><span class="main">#</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpchain_Cons_reduce"><span class="command">lemma</span></span> maxsimpchain_Cons_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> maxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     adjacentchain_Cons_reduce maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-maxsimpchain_append_reduce1"><span class="command">lemma</span></span> maxsimpchain_append_reduce1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> maxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce1 maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpchain_append_reduce2"><span class="command">lemma</span></span> maxsimpchain_append_reduce2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> maxsimpchain <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_append_reduce2 maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpchain_remdup_adj"><span class="command">lemma</span></span> maxsimpchain_remdup_adj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def binrelchain_remdup_adj <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-maxsimpchain_rev"><span class="command">lemma</span></span> maxsimpchain_rev<span class="main">:</span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="free">xs</span> <span class="main">⟹</span> maxsimpchain <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     maxsimpchainD_maxsimp adjacent_sym
            binrelchain_sym_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted">adjacent</span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> maxsimpchain_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-maxsimpchain_overlap_join"><span class="command">lemma</span></span> maxsimpchain_overlap_join<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> maxsimpchain <span class="main">(</span><span class="free">w</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span>
    maxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">w</span><span class="main">#</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> binrelchain_overlap_join maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-pmaxsimpchain"><span class="command">lemma</span></span> pmaxsimpchain<span class="main">:</span> <span class="quoted"><span class="quoted">"pmaxsimpchain <span class="free">xs</span> <span class="main">⟹</span> maxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def pmaxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-pmaxsimpchainI_maxsimpchain"><span class="command">lemma</span></span> pmaxsimpchainI_maxsimpchain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimpchain <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span> <span class="main">⟹</span> pmaxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def pmaxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-pmaxsimpchain_CConsI"><span class="command">lemma</span></span> pmaxsimpchain_CConsI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maxsimp <span class="free">w</span><span class="main">;</span> pmaxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span><span class="main">;</span> <span class="free">w</span><span class="main">∼</span><span class="free">x</span><span class="main">;</span> <span class="free">w</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    pmaxsimpchain <span class="main">(</span><span class="free">w</span><span class="main">#</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pmaxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> pmaxsimpchainD_maxsimp <span class="main">=</span>
  maxsimpchainD_maxsimp<span class="main">[</span><span class="operator">OF</span> pmaxsimpchain<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> pmaxsimpchainD_adj <span class="main">=</span>
  maxsimpchainD_adj <span class="main">[</span><span class="operator">OF</span> pmaxsimpchain<span class="main">]</span>

<span class="keyword1" id="Simplicial-pmaxsimpchainD_distinct"><span class="command">lemma</span></span> pmaxsimpchainD_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"pmaxsimpchain <span class="free">xs</span> <span class="main">⟹</span> distinct <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pmaxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Simplicial-pmaxsimpchain_Cons_reduce"><span class="command">lemma</span></span> pmaxsimpchain_Cons_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pmaxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">)</span> <span class="main">⟹</span> pmaxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_Cons_reduce pmaxsimpchain pmaxsimpchainD_distinct
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmaxsimpchainI_maxsimpchain<span class="main">)</span>

<span class="keyword1" id="Simplicial-pmaxsimpchain_append_reduce1"><span class="command">lemma</span></span> pmaxsimpchain_append_reduce1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pmaxsimpchain <span class="main">(</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span> <span class="main">⟹</span> pmaxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_append_reduce1 pmaxsimpchain pmaxsimpchainD_distinct
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pmaxsimpchainI_maxsimpchain<span class="main">)</span>

<span class="keyword1" id="Simplicial-maxsimpchain_obtain_pmaxsimpchain"><span class="command">lemma</span></span> maxsimpchain_obtain_pmaxsimpchain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ys</span><span class="main">.</span> set <span class="bound">ys</span> <span class="main">⊆</span> set <span class="free">xs</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">∧</span>
            pmaxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ys</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ys</span> <span class="main">⊆</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ys</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"padjacentchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> maxsimpchainD_adj<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          adjacentchain_obtain_proper<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ys<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span>set <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> maxsimp <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> maxsimpchainD_maxsimp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ys <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> pmaxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-min_maxsimpchainD_maxsimpchain"><span class="command">lemma</span></span> min_maxsimpchainD_maxsimpchain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"maxsimpchain <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Single <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Cons_snoc <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> is_arg_minD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-min_maxsimpchainD_min_betw"><span class="command">lemma</span></span> min_maxsimpchainD_min_betw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
    length <span class="free">ys</span> <span class="main">≥</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> is_arg_minD2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-min_maxsimpchainI_betw"><span class="command">lemma</span></span> min_maxsimpchainI_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ys</span><span class="main">.</span> maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> length <span class="free">xs</span> <span class="main">≤</span> length <span class="bound">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> is_arg_min_linorderI<span class="main">)</span>

<span class="keyword1" id="Simplicial-min_maxsimpchainI_betw_compare"><span class="command">lemma</span></span> min_maxsimpchainI_betw_compare<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms min_maxsimpchainD_min_betw min_maxsimpchainI_betw
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-min_maxsimpchain_pmaxsimpchain"><span class="command">lemma</span></span> min_maxsimpchain_pmaxsimpchain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pmaxsimpchain <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> pmaxsimpchainI_maxsimpchain<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> min_maxsimpchainD_maxsimpchain<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc
<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">x</span> <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">ys</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> False"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>set <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>set <span class="skolem">ys</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> both
    <span class="keyword1"><span class="command">from</span></span> both<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
            maxsimpchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">as</span>"</span></span><span class="main">]</span>
            min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> one
    <span class="keyword1"><span class="command">from</span></span> one<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
            maxsimpchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">as</span>"</span></span><span class="main">]</span>
            min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> other
    <span class="keyword1"><span class="command">from</span></span> other<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_conv_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
            maxsimpchain_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span>
            min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ys</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms Cons_snoc not_distinct_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ys</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
            maxsimpchain_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span>"</span></span><span class="main">]</span>
            maxsimpchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">#</span><span class="skolem">cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span>
            maxsimpchain_overlap_join<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">as</span>"</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span><span class="main">]</span>
            min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">a</span><span class="main">#</span><span class="skolem">cs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"distinct <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-min_maxsimpchain_rev"><span class="command">lemma</span></span> min_maxsimpchain_rev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="free">xs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span>rev <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Single <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain maxsimpchainD_maxsimp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">x</span> <span class="skolem">ys</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> rev <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> min_maxsimpchainI_betw<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons_snoc assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">≠</span><span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_maxsimpchain_pmaxsimpchain pmaxsimpchainD_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Cons_snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> rev <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> maxsimpchain_rev
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> Cons_snoc assms
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">zs</span><span class="main">.</span> maxsimpchain <span class="main">(</span><span class="skolem">y</span><span class="main">#</span><span class="bound">zs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> length <span class="main">(</span>rev <span class="skolem">ys</span><span class="main">)</span> <span class="main">≤</span> length <span class="bound">zs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> maxsimpchain_rev min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">ys</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Simplicial-min_maxsimpchain_adj"><span class="command">lemma</span></span> min_maxsimpchain_adj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maxsimp <span class="free">x</span><span class="main">;</span> maxsimp <span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main">∼</span><span class="free">y</span><span class="main">;</span> <span class="free">x</span><span class="main">≠</span><span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> min_maxsimpchain <span class="main">[</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def min_maxsimpchainI_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Simplicial-min_maxsimpchain_betw_CCons_reduce"><span class="command">lemma</span></span> min_maxsimpchain_betw_CCons_reduce<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">w</span><span class="main">#</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> min_maxsimpchainI_betw<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_maxsimpchain_pmaxsimpchain pmaxsimpchainD_distinct
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
          maxsimpchain_Cons_reduce
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
 <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">zs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"maxsimpchain <span class="main">(</span><span class="free">w</span><span class="main">#</span><span class="free">x</span><span class="main">#</span><span class="skolem">zs</span><span class="main">@</span><span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> maxsimpchain_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">ys</span> <span class="main">≤</span> length <span class="skolem">zs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="free">ys</span>"</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">#</span><span class="skolem">zs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-min_maxsimpchain_betw_uniform_length"><span class="command">lemma</span></span> min_maxsimpchain_betw_uniform_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          min_maxsimpchainD_min_betw<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          min_maxsimpchainD_maxsimpchain<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-not_min_maxsimpchainI_betw"><span class="command">lemma</span></span> not_min_maxsimpchainI_betw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">ys</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span><span class="main">;</span> length <span class="free">ys</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">¬</span> min_maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> min_maxsimpchainD_min_betw not_less <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Simplicial-maxsimpchain_in_subcomplex"><span class="command">lemma</span></span> maxsimpchain_in_subcomplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Subcomplex <span class="free">Y</span><span class="main">;</span> set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">;</span> maxsimpchain <span class="free">ys</span> <span class="main">⟧</span> <span class="main">⟹</span>
    SimplicialComplex.maxsimpchain <span class="free">Y</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpchain_def max_in_subcomplex
        SimplicialComplex.maxsimpchain_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context SimplicialComplex *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Isomorphisms of simplicial complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we develop the concept of isomorphism of simplicial complexes. Note that we have not
  bothered to first develop the concept of morphism of simplicial complexes, since every function
  on the vertex set of a simplicial complex can be considered a morphism of complexes (see lemma
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>map_is_simplicial_morph›</span></span></span></span> above).
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> SimplicialComplexIsomorphism <span class="main">=</span> SimplicialComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> morph <span class="main">=</span> map_is_simplicial_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>

<span class="keyword1" id="Simplicial-iso_codim_map"><span class="command">lemma</span></span> iso_codim_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">x</span><span class="main">-</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj inj_on_image_set_diff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> finite_simplex subset_inj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">-</span><span class="free">y</span>"</span></span><span class="main">]</span>
        inj_on_iff_eq_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">-</span><span class="free">y</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-maxsimp_im_max"><span class="command">lemma</span></span> maxsimp_im_max<span class="main">:</span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span> <span class="main">⟹</span> <span class="free">w</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span><span class="free">w</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">w</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpD_simplex inj_onD<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> maxsimpD_maximal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Simplicial-maxsimp_map"><span class="command">lemma</span></span> maxsimp_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span> <span class="main">⟹</span> SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimpD_simplex maxsimp_im_max morph
        SimplicialComplex.maxsimpI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Simplicial-iso_adj_int_im"><span class="command">lemma</span></span> iso_adj_int_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∼</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> facetrelI_card<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">x</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">`</span> <span class="free">y</span> <span class="main">=</span> <span class="free">f</span> <span class="main">`</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> maxsimp_map SimplicialComplex.maxsimpD_simplex<span class="main">[</span><span class="operator">OF</span> morph<span class="main">]</span>
          SimplicialComplex.maxsimpD_maximal<span class="main">[</span><span class="operator">OF</span> morph<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">x</span><span class="main">∩</span><span class="free">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_maxsimp card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">x</span><span class="main">∩</span><span class="free">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">x</span><span class="main">∩</span><span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> maxsimpD_simplex faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> maxsimpD_simplex
          iso_codim_map adjacent_int_facet1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> facetrel_card
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 maxsimpD_simplex finite_maxsimp
          inj_onD<span class="main">[</span><span class="operator">OF</span> induced_pow_fun_inj_on<span class="main">,</span> <span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-iso_adj_map"><span class="command">lemma</span></span> iso_adj_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"maxsimp <span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∼</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">≠</span><span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> iso_adj_int_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> adjacent_sym
        iso_adj_int_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adjacentI<span class="main">)</span>

<span class="keyword1" id="Simplicial-pmaxsimpchain_map"><span class="command">lemma</span></span> pmaxsimpchain_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pmaxsimpchain <span class="free">xs</span> <span class="main">⟹</span> SimplicialComplex.pmaxsimpchain <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> map_is_simplicial_morph SimplicialComplex.pmaxsimpchain_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">x</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> map_is_simplicial_morph pmaxsimpchainD_maxsimp maxsimp_map
          SimplicialComplex.pmaxsimpchain_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.pmaxsimpchain <span class="main">(</span><span class="free">f</span> <span class="main">⊢</span> <span class="free">X</span><span class="main">)</span> <span class="main">(</span> <span class="free">f</span><span class="main">`</span><span class="skolem">x</span> <span class="main">#</span> <span class="free">f</span><span class="main">`</span><span class="skolem">y</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
    <span class="operator">rule</span> SimplicialComplex.pmaxsimpchain_CConsI<span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> map_is_simplicial_morph
  <span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pmaxsimpchainD_maxsimp maxsimp_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> CCons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.pmaxsimpchain <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">y</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pmaxsimpchain_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">x</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pmaxsimpchain_def iso_adj_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> inj CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">y</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>     maxsimpD_simplex inj_on_distinct_setlistmapim
      <span class="keyword1"><span class="command">unfolding</span></span> pmaxsimpchain_def
      <span class="keyword1"><span class="command">by</span></span>        <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">y</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context SimplicialComplexIsomorphism *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The complex associated to a poset›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A simplicial complex is naturally a poset under the subset relation. The following develops the
  reverse direction: constructing a simplicial complex from a suitable poset.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ordering
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">PosetComplex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">PosetComplex</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.</span> <span class="main">{</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="bound">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span> <span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Simplicial-poset_is_SimplicialComplex"><span class="command">lemma</span></span> poset_is_SimplicialComplex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">P</span><span class="main">.</span> simplex_like <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SimplicialComplex <span class="main">(</span>PosetComplex <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SimplicialComplex.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> PosetComplex <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> PosetComplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pseudominimal_inD1 simplex_likeD_finite finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> ab<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> PosetComplex <span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">⊆</span><span class="skolem">a</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ab<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> PosetComplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fA<span class="main">:</span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="free">less_eq</span> <span class="free">less</span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span><span class="main">)</span> <span class="skolem">f</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> Pow <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_likeD_iso<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x'</span></span> <span class="keyword2"><span class="keyword">where</span></span> x'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span> <span class="main">≡</span> the_inv_into <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span><span class="main">)</span> <span class="skolem">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">f</span><span class="main">`</span><span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fA x<span class="main">(</span>2<span class="main">)</span> ab<span class="main">(</span>2<span class="main">)</span> x' <span class="keyword1"><span class="command">have</span></span> x'_P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x'</span><span class="main">∈</span><span class="free">P</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> collect_pseudominimals_below_in_poset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x fA ab<span class="main">(</span>2<span class="main">)</span> x' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x'</span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> collect_pseudominimals_below_in_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> PosetComplex <span class="free">P</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> PosetComplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">poset_simplex_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">poset_simplex_map</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> pseudominimal_in <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="bound">y</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Simplicial-poset_to_PosetComplex_OrderingSetMap"><span class="command">lemma</span></span> poset_to_PosetComplex_OrderingSetMap<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> simplex_like <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OrderingSetMap <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> <span class="main">(</span>poset_simplex_map <span class="free">P</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="main">⟦</span> <span class="bound">a</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="bound">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="bound">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="bound">b</span> <span class="main">⟧</span> <span class="main">⟹</span>
            poset_simplex_map <span class="free">P</span> <span class="bound">a</span> <span class="main">⊆</span> poset_simplex_map <span class="free">P</span> <span class="bound">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>     simplex_like_has_bottom pseudominimal_in_below_in
    <span class="keyword1"><span class="command">unfolding</span></span> poset_simplex_map_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ordering *)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  When a poset affords a simplicial complex, there is a natural morphism of posets from the
  source poset into the poset of sets in the complex, as above. However, some further assumptions
  are necessary to ensure that this morphism is an isomorphism. These conditions are collected in
  the following locale.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ComplexLikePoset <span class="main">=</span> ordering <span class="quoted"><span class="free">less_eq</span></span> <span class="quoted"><span class="free">less</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">less_eq</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>≤</b></span>"</span>  50<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">less</span>     <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">⇒</span>bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1"><span class="hidden">❙</span><b>&lt;</b></span>"</span>  50<span class="main">)</span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">P</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> below_in_P_simplex_like<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> simplex_like <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     P_has_bottom           <span class="main">:</span> <span class="quoted"><span class="quoted">"has_bottom <span class="free">P</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     P_has_glbs             <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">y</span><span class="main">∈</span><span class="free">P</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">b</span><span class="main">.</span> glbound_in_of <span class="free">P</span> <span class="free">x</span> <span class="free">y</span> <span class="bound">b</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">smap</span> <span class="main">≡</span> poset_simplex_map <span class="free">P</span>"</span></span>

<span class="keyword1" id="Simplicial-smap_onto_PosetComplex"><span class="command">lemma</span></span> smap_onto_PosetComplex<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">`</span> <span class="free">P</span> <span class="main">=</span> PosetComplex <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> poset_simplex_map_def PosetComplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Simplicial-ordsetmap_smap"><span class="command">lemma</span></span> ordsetmap_smap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">a</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">b</span><span class="main">∈</span><span class="free">P</span><span class="main">;</span> <span class="free">a</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="free">b</span> <span class="main">⟧</span> <span class="main">⟹</span> smap <span class="free">a</span> <span class="main">⊆</span> smap <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> OrderingSetMap.ordsetmap<span class="main">[</span>
          <span class="operator">OF</span> poset_to_PosetComplex_OrderingSetMap<span class="main">,</span> <span class="operator">OF</span> below_in_P_simplex_like
        <span class="main">]</span>
        poset_simplex_map_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Simplicial-inj_on_smap"><span class="command">lemma</span></span> inj_on_smap<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on smap <span class="free">P</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">x</span> <span class="main">=</span> smap <span class="skolem">y</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"smap <span class="skolem">x</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> xy <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> poset_simplex_map_def below_in_P_simplex_like P_has_bottom
            simplex_like_no_pseudominimal_in_below_in_imp_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
            simplex_like_no_pseudominimal_in_below_in_imp_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
            below_in_singleton_is_bottom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> below_in_singleton_is_bottom<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> smap <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> xy<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> z1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pseudominimal_inD1 poset_simplex_map_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"lbound_of <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> lbound_ofI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> z1<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"glbound_in_of <span class="free">P</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xy<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> P_has_glbs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> glbound_in_ofD_in<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> glbound_in_of_less_eq1<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span>
            glbound_in_of_less_eq2<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span>     xy below_in_P_simplex_like 
                pseudominimal_in_below_in_less_eq_glbound<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
                simplex_like_below_in_above_pseudominimal_is_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
                simplex_like_below_in_above_pseudominimal_is_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">P</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> poset_simplex_map_def
      <span class="keyword1"><span class="command">by</span></span>        <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Simplicial-OrderingSetIso_smap"><span class="command">lemma</span></span> OrderingSetIso_smap<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> smap"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> OrderingSetMap.isoI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"OrderingSetMap <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="free">P</span> smap"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poset_simplex_map_def below_in_P_simplex_like
          poset_to_PosetComplex_OrderingSetMap
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">P</span>"</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">x</span> <span class="main">⊆</span> smap <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> xy<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"simplex_like <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> below_in_P_simplex_like <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">A</span></span><span class="main">::</span><span class="quoted"><span class="quoted">"nat set"</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main"><span class="free">(<span class="hidden">❙</span><b>≤</b>)</span></span> <span class="main"><span class="free">(<span class="hidden">❙</span><b>&lt;</b>)</span></span> <span class="main">(⊆)</span> <span class="main">(⊂)</span> <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span><span class="main">)</span> <span class="skolem">g</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">`</span><span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> Pow <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_likeD_iso<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> xy <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main"><span class="free"><span class="hidden">❙</span><b>≤</b></span></span><span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> poset_simplex_map_def collect_pseudominimals_below_in_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
          collect_pseudominimals_below_in_poset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span>
          inj_onD<span class="main">[</span><span class="operator">OF</span> inj_on_smap<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span><span class="free">P</span><span class="main">.<span class="hidden">❙</span><b>≤</b></span><span class="skolem">y</span><span class="main">)</span> <span class="skolem">g</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">g</span> <span class="main">`</span> smap <span class="skolem">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
          collect_pseudominimals_below_in_less_eq_top<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">P</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> inj_on_smap<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> rev_ordsetmap_smap <span class="main">=</span>
  OrderingSetIso.rev_ordsetmap<span class="main">[</span><span class="operator">OF</span> OrderingSetIso_smap<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ComplexLikePoset *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Chamber">
<div class="head">
<h1>Theory Chamber</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Chamber complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Now we develop the basic theory of chamber complexes, including both thin and thick complexes.
  Some terminology: a maximal simplex is now called a chamber, and a chain (with respect to
  adjacency) of chambers is now called a gallery. A gallery in which no chamber appears more than
  once is called proper, and we use the prefix p as a naming convention to denote proper.
  Again, we remind the reader that some sources reserve the name gallery for (a slightly weaker
  notion of) what we are calling a proper gallery, using pregallery to denote an improper gallery.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Chamber
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Algebra">Algebra</a> <a href="#Simplicial">Simplicial</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplex <span class="main">=</span> SimplicialComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> simplex_in_max <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> maxsimp <span class="bound">x</span> <span class="main">∧</span> <span class="free">y</span><span class="main">⊆</span><span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     maxsimp_connect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">;</span> maxsimp <span class="free">x</span><span class="main">;</span> maxsimp <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> 
                            <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> maxsimpchain <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">chamber</span>      <span class="main">≡</span> maxsimp"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gallery</span>      <span class="main">≡</span> maxsimpchain"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">pgallery</span>     <span class="main">≡</span> pmaxsimpchain"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_gallery</span>  <span class="main">≡</span> min_maxsimpchain"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supchamber</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">C</span><span class="main">.</span> chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">∈</span><span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> faces                     <span class="main">=</span> faces
<span class="keyword1"><span class="command">lemmas</span></span> singleton_simplex         <span class="main">=</span> singleton_simplex
<span class="keyword1"><span class="command">lemmas</span></span> chamberI                  <span class="main">=</span> maxsimpI
<span class="keyword1"><span class="command">lemmas</span></span> chamberD_simplex          <span class="main">=</span> maxsimpD_simplex
<span class="keyword1"><span class="command">lemmas</span></span> chamberD_maximal          <span class="main">=</span> maxsimpD_maximal
<span class="keyword1"><span class="command">lemmas</span></span> finite_chamber            <span class="main">=</span> finite_maxsimp
<span class="keyword1"><span class="command">lemmas</span></span> chamber_nempty            <span class="main">=</span> maxsimp_nempty
<span class="keyword1"><span class="command">lemmas</span></span> chamber_vertices          <span class="main">=</span> maxsimp_vertices
<span class="keyword1"><span class="command">lemmas</span></span> gallery_def               <span class="main">=</span> maxsimpchain_def
<span class="keyword1"><span class="command">lemmas</span></span> gallery_snocI             <span class="main">=</span> maxsimpchain_snocI
<span class="keyword1"><span class="command">lemmas</span></span> galleryD_chamber          <span class="main">=</span> maxsimpchainD_maxsimp
<span class="keyword1"><span class="command">lemmas</span></span> galleryD_adj              <span class="main">=</span> maxsimpchainD_adj
<span class="keyword1"><span class="command">lemmas</span></span> gallery_CConsI            <span class="main">=</span> maxsimpchain_CConsI
<span class="keyword1"><span class="command">lemmas</span></span> gallery_Cons_reduce       <span class="main">=</span> maxsimpchain_Cons_reduce
<span class="keyword1"><span class="command">lemmas</span></span> gallery_append_reduce1    <span class="main">=</span> maxsimpchain_append_reduce1
<span class="keyword1"><span class="command">lemmas</span></span> gallery_append_reduce2    <span class="main">=</span> maxsimpchain_append_reduce2
<span class="keyword1"><span class="command">lemmas</span></span> gallery_remdup_adj        <span class="main">=</span> maxsimpchain_remdup_adj
<span class="keyword1"><span class="command">lemmas</span></span> gallery_obtain_pgallery   <span class="main">=</span> maxsimpchain_obtain_pmaxsimpchain
<span class="keyword1"><span class="command">lemmas</span></span> pgallery_def              <span class="main">=</span> pmaxsimpchain_def
<span class="keyword1"><span class="command">lemmas</span></span> pgalleryI_gallery         <span class="main">=</span> pmaxsimpchainI_maxsimpchain
<span class="keyword1"><span class="command">lemmas</span></span> pgalleryD_chamber         <span class="main">=</span> pmaxsimpchainD_maxsimp
<span class="keyword1"><span class="command">lemmas</span></span> pgalleryD_adj             <span class="main">=</span> pmaxsimpchainD_adj
<span class="keyword1"><span class="command">lemmas</span></span> pgalleryD_distinct        <span class="main">=</span> pmaxsimpchainD_distinct
<span class="keyword1"><span class="command">lemmas</span></span> pgallery_Cons_reduce      <span class="main">=</span> pmaxsimpchain_Cons_reduce
<span class="keyword1"><span class="command">lemmas</span></span> pgallery_append_reduce1   <span class="main">=</span> pmaxsimpchain_append_reduce1
<span class="keyword1"><span class="command">lemmas</span></span> pgallery                  <span class="main">=</span> pmaxsimpchain
<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_simps         <span class="main">=</span> min_maxsimpchain.simps
<span class="keyword1"><span class="command">lemmas</span></span> min_galleryI_betw         <span class="main">=</span> min_maxsimpchainI_betw
<span class="keyword1"><span class="command">lemmas</span></span> min_galleryI_betw_compare <span class="main">=</span> min_maxsimpchainI_betw_compare
<span class="keyword1"><span class="command">lemmas</span></span> min_galleryD_min_betw     <span class="main">=</span> min_maxsimpchainD_min_betw
<span class="keyword1"><span class="command">lemmas</span></span> min_galleryD_gallery      <span class="main">=</span> min_maxsimpchainD_maxsimpchain
<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_pgallery      <span class="main">=</span> min_maxsimpchain_pmaxsimpchain
<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_rev           <span class="main">=</span> min_maxsimpchain_rev
<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_adj           <span class="main">=</span> min_maxsimpchain_adj
<span class="keyword1"><span class="command">lemmas</span></span> not_min_galleryI_betw     <span class="main">=</span> not_min_maxsimpchainI_betw

<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_betw_CCons_reduce <span class="main">=</span>
  min_maxsimpchain_betw_CCons_reduce
<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_betw_uniform_length <span class="main">=</span>
  min_maxsimpchain_betw_uniform_length
<span class="keyword1"><span class="command">lemmas</span></span> vertex_set_int <span class="main">=</span> vertex_set_int<span class="main">[</span><span class="operator">OF</span> ChamberComplex.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>

<span class="keyword1" id="Chamber-chamber_pconnect"><span class="command">lemma</span></span> chamber_pconnect<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span> <span class="main">≠</span> <span class="free">y</span><span class="main">;</span> chamber <span class="free">x</span><span class="main">;</span> chamber <span class="free">y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> pgallery <span class="main">(</span><span class="free">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="free">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> gallery_obtain_pgallery<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-supchamberD"><span class="command">lemma</span></span> supchamberD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≡</span> supchamber <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms simplex_in_max someI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">C</span><span class="main">.</span> chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free">v</span><span class="main">∈</span><span class="bound">C</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ChamberSubcomplex</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">⊆</span> <span class="free">X</span> <span class="main">∧</span> ChamberComplex <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">C</span><span class="main">.</span> ChamberComplex.chamber <span class="free"><span class="bound"><span class="entity">Y</span></span></span> <span class="bound">C</span> <span class="main">⟶</span> chamber <span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Chamber-ChamberSubcomplexI"><span class="command">lemma</span></span> ChamberSubcomplexI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span><span class="main">⊆</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="free">Y</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> ChamberComplex.chamber <span class="free">Y</span> <span class="bound">y</span> <span class="main">⟹</span> chamber <span class="bound">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms ChamberSubcomplex_def
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fast</span>

<span class="keyword1" id="Chamber-ChamberSubcomplexD_sub"><span class="command">lemma</span></span> ChamberSubcomplexD_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span> <span class="main">⟹</span> <span class="free">Y</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberSubcomplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-ChamberSubcomplexD_complex"><span class="command">lemma</span></span> ChamberSubcomplexD_complex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span> <span class="main">⟹</span> ChamberComplex <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ChamberSubcomplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-chambersub_imp_sub"><span class="command">lemma</span></span> chambersub_imp_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span> <span class="main">⟹</span> Subcomplex <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberSubcomplex_def ChamberComplex.axioms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-chamber_in_subcomplex"><span class="command">lemma</span></span> chamber_in_subcomplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ChamberSubcomplex <span class="free">Y</span><span class="main">;</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">;</span> chamber <span class="free">C</span> <span class="main">⟧</span> <span class="main">⟹</span>
    ChamberComplex.chamber <span class="free">Y</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambersub_imp_sub max_in_subcomplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-subcomplex_chamber"><span class="command">lemma</span></span> subcomplex_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span> <span class="main">⟹</span> ChamberComplex.chamber <span class="free">Y</span> <span class="free">C</span> <span class="main">⟹</span> chamber <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> ChamberSubcomplex_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-gallery_in_subcomplex"><span class="command">lemma</span></span> gallery_in_subcomplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ChamberSubcomplex <span class="free">Y</span><span class="main">;</span> set <span class="free">ys</span> <span class="main">⊆</span> <span class="free">Y</span><span class="main">;</span> gallery <span class="free">ys</span> <span class="main">⟧</span> <span class="main">⟹</span>
    ChamberComplex.gallery <span class="free">Y</span> <span class="free">ys</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambersub_imp_sub maxsimpchain_in_subcomplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-subcomplex_gallery"><span class="command">lemma</span></span> subcomplex_gallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span> <span class="main">⟹</span> ChamberComplex.gallery <span class="free">Y</span> <span class="free">Cs</span> <span class="main">⟹</span> gallery <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberSubcomplex_def gallery_def ChamberComplex.gallery_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-subcomplex_pgallery"><span class="command">lemma</span></span> subcomplex_pgallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span> <span class="main">⟹</span> ChamberComplex.pgallery <span class="free">Y</span> <span class="free">Cs</span> <span class="main">⟹</span> pgallery <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberSubcomplex_def pgallery_def ChamberComplex.pgallery_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-min_gallery_in_subcomplex"><span class="command">lemma</span></span> min_gallery_in_subcomplex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">Y</span> <span class="free">Cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberSubcomplexD_complex ChamberComplex.min_gallery_simps<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Single <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> min_galleryD_gallery galleryD_chamber chamber_in_subcomplex
          ChamberComplex.min_gallery_simps<span class="main">(</span>2<span class="main">)</span> ChamberSubcomplexD_complex
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">C</span> <span class="skolem">Ds</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberSubcomplexD_complex min_gallery_pgallery
          pgalleryD_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span>"</span></span><span class="main">]</span> pgallery
          gallery_in_subcomplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span> subcomplex_gallery
          min_galleryD_min_betw
          ChamberComplex.min_galleryI_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_card"><span class="command">lemma</span></span> chamber_card<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> chamber <span class="free">D</span> <span class="main">⟹</span> card <span class="free">C</span> <span class="main">=</span> card <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> galleryD_adj adjacentchain_card
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-chamber_facet_is_chamber_facet"><span class="command">lemma</span></span> chamber_facet_is_chamber_facet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">C</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span><span class="main">;</span> <span class="free">z</span><span class="main">⊆</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> finite_chamber finite_facetrel_card chamber_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> facetrelI_cardSuc<span class="main">)</span>

<span class="keyword1" id="Chamber-chamber_adj"><span class="command">lemma</span></span> chamber_adj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">⊆</span><span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> adjacent_card finite_chamber card_subset_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chambers_share_facet"><span class="command">lemma</span></span> chambers_share_facet<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>insert <span class="free">v</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span>insert <span class="free">v</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> facetrelI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∉</span><span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> finite_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> finite_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"insert <span class="free">v</span> <span class="free">z</span>"</span></span><span class="main">]</span> card_insert_if<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> finite_facetrel_card chamber_card<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-adjacentset_chamber"><span class="command">lemma</span></span> adjacentset_chamber<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">D</span><span class="main">∈</span>adjacentset <span class="free">C</span> <span class="main">⟹</span> chamber <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacentset_def chamber_adj <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-chamber_shared_facet"><span class="command">lemma</span></span> chamber_shared_facet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span><span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">X</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> chamber <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chamber_adj adjacentI<span class="main">)</span>

<span class="keyword1" id="Chamber-adjacentset_conv_facetchambersets"><span class="command">lemma</span></span> adjacentset_conv_facetchambersets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">≠</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"adjacentset <span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> adjacentset <span class="free">C</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">=</span><span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_nempty chamberD_simplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> True assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> facetrel_diff_vertex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> D <span class="keyword1"><span class="command">have</span></span> D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> adjacentsetD_adj <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> False <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∉</span><span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="skolem">D</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="main">=</span> <span class="free">C</span><span class="main">∩</span><span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> D' False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span> <span class="main">⊲</span> <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> adjacent_int_facet2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> D v<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> adjacentset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">E</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">E</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="bound">D</span> <span class="main">∈</span> adjacentset <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>     facetrel_diff_vertex adjacentI
    <span class="keyword1"><span class="command">unfolding</span></span> adjacentset_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplex *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The system of chambers and distance between chambers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now examine the system of all chambers in more detail, and explore the distance function on
  this system provided by lengths of minimal galleries.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chamber_system</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">chamber_system</span> <span class="main">≡</span> <span class="main">{</span><span class="bound">C</span><span class="main">.</span> chamber <span class="bound">C</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒞</span> <span class="main">≡</span> chamber_system"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">chamber_distance</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">chamber_distance</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">=</span><span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span>
            Suc <span class="main">(</span>length <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">closest_supchamber</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">closest_supchamber</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">=</span>
          <span class="main">(</span><span class="keyword1">ARG_MIN</span> <span class="main">(</span><span class="main">λ</span><span class="bound">C</span><span class="main">.</span> chamber_distance <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="bound">C</span><span class="main">.</span>
            chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span><span class="main">⊆</span><span class="bound">C</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">face_distance</span> <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> chamber_distance <span class="main">(</span>closest_supchamber <span class="free"><span class="bound"><span class="entity">F</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span>"</span></span>

<span class="keyword1" id="Chamber-chamber_system_simplices"><span class="command">lemma</span></span> chamber_system_simplices<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒞 <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamberD_simplex <span class="keyword1"><span class="command">unfolding</span></span> chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-gallery_chamber_system"><span class="command">lemma</span></span> gallery_chamber_system<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="free">Cs</span> <span class="main">⟹</span> set <span class="free">Cs</span> <span class="main">⊆</span> 𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> galleryD_chamber chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> pgallery_chamber_system <span class="main">=</span> gallery_chamber_system<span class="main">[</span><span class="operator">OF</span> pgallery<span class="main">]</span>

<span class="keyword1" id="Chamber-chamber_distance_le"><span class="command">lemma</span></span> chamber_distance_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> chamber_distance <span class="free">C</span> <span class="free">D</span> <span class="main">≤</span> Suc <span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_distance_def
        arg_min_nat_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">_</span> <span class="quoted">length</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-min_gallery_betw_chamber_distance"><span class="command">lemma</span></span> min_gallery_betw_chamber_distance<span class="main">:</span>
  <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> chamber_distance <span class="free">C</span> <span class="free">D</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_distance_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> is_arg_min_size<span class="main">[</span><span class="operator">of</span> <span class="quoted">length</span> <span class="main">_</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-min_galleryI_chamber_distance_betw"><span class="command">lemma</span></span> min_galleryI_chamber_distance_betw<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> Suc <span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span>
    min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_distance_def chamber_distance_le min_galleryI_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-gallery_least_length"><span class="command">lemma</span></span> gallery_least_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="main">≡</span> <span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> arg_min_natI
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fast</span>
  
<span class="keyword1" id="Chamber-min_gallery_least_length"><span class="command">lemma</span></span> min_gallery_least_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="main">≡</span> <span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Cs_def
  <span class="keyword1"><span class="command">using</span></span>     assms gallery_least_length
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_galleryI_betw arg_min_nat_le<span class="main">)</span>

<span class="keyword1" id="Chamber-pgallery_least_length"><span class="command">lemma</span></span> pgallery_least_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="main">≡</span> <span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms min_gallery_least_length min_gallery_pgallery
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fast</span>

<span class="keyword1" id="Chamber-closest_supchamberD"><span class="command">lemma</span></span> closest_supchamberD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>closest_supchamber <span class="free">F</span> <span class="free">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">⊆</span> closest_supchamber <span class="free">F</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms arg_min_natI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">C</span><span class="main">.</span> chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free">F</span><span class="main">⊆</span><span class="bound">C</span>"</span></span> <span class="main">]</span> simplex_in_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> closest_supchamber_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1" id="Chamber-closest_supchamber_closest"><span class="command">lemma</span></span> closest_supchamber_closest<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">F</span><span class="main">⊆</span><span class="free">C</span> <span class="main">⟹</span>
    chamber_distance <span class="main">(</span>closest_supchamber <span class="free">F</span> <span class="free">D</span><span class="main">)</span> <span class="free">D</span> <span class="main">≤</span> chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> arg_min_nat_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">C</span><span class="main">.</span> chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free">F</span><span class="main">⊆</span><span class="bound">C</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> closest_supchamber_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-face_distance_le"><span class="command">lemma</span></span> face_distance_le<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">F</span><span class="main">⊆</span><span class="free">C</span> <span class="main">⟹</span> face_distance <span class="free">F</span> <span class="free">D</span> <span class="main">≤</span> chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> face_distance_def closest_supchamber_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_min_nat_le<span class="main">)</span>

<span class="keyword1" id="Chamber-face_distance_eq_0"><span class="command">lemma</span></span> face_distance_eq_0<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">F</span><span class="main">⊆</span><span class="free">C</span> <span class="main">⟹</span> face_distance <span class="free">F</span> <span class="free">C</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_distance_def closest_supchamber_def face_distance_def
        arg_min_equality<span class="main">[</span>
          <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">C</span><span class="main">.</span> chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free">F</span><span class="main">⊆</span><span class="bound">C</span>"</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">D</span><span class="main">.</span> chamber_distance <span class="bound">D</span> <span class="free">C</span>"</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplex *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Labelling a chamber complex›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A labelling of a chamber complex is a function on the vertex set so that each chamber is in
  bijective correspondence with the label set (chambers all have the same number of vertices).
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">label_wrt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">label_wrt</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>𝒞<span class="main">.</span> bij_betw <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">C</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Chamber-label_wrtD"><span class="command">lemma</span></span> label_wrtD<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">∈</span>𝒞 <span class="main">⟹</span> bij_betw <span class="free">f</span> <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> label_wrt_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-label_wrtD'"><span class="command">lemma</span></span> label_wrtD'<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">f</span> <span class="main">⟹</span> chamber <span class="free">C</span> <span class="main">⟹</span> bij_betw <span class="free">f</span> <span class="free">C</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> label_wrt_def chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-label_wrt_adjacent"><span class="command">lemma</span></span> label_wrt_adjacent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C</span><span class="main">-</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="free">D</span><span class="main">-</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_conv_insert<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> label_wrtD'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          label_wrtD'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          bij_betw_imp_surj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_sym<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> adjacent_conv_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          inj_on_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∩</span><span class="free">D</span>"</span></span><span class="main">]</span>
          bij_betw_imp_inj_on<span class="main">[</span><span class="operator">OF</span> label_wrtD'<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-label_wrt_adjacent_shared_facet"><span class="command">lemma</span></span> label_wrt_adjacent_shared_facet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> label_wrt <span class="free">B</span> <span class="free">f</span><span class="main">;</span> chamber <span class="main">(</span>insert <span class="free">v</span> <span class="free">z</span><span class="main">)</span><span class="main">;</span> chamber <span class="main">(</span>insert <span class="free">w</span> <span class="free">z</span><span class="main">)</span><span class="main">;</span> <span class="free">v</span><span class="main">∉</span><span class="free">z</span><span class="main">;</span> <span class="free">w</span><span class="main">∉</span><span class="free">z</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">f</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> label_wrt_adjacent adjacentI facetrelI<span class="main">)</span>

<span class="keyword1" id="Chamber-label_wrt_elt_image"><span class="command">lemma</span></span> label_wrt_elt_image<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">f</span> <span class="main">⟹</span> <span class="free">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_in_max label_wrtD' bij_betw_imp_surj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplex *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Morphisms of chamber complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  While any function on the vertex set of a simplicial complex can be considered a morphism of
  simplicial complexes onto its image, for chamber complexes we require the function send chambers
  onto chambers of the same cardinality in some chamber complex of the codomain.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Morphism locale and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexMorphism <span class="main">=</span> domain<span class="main">:</span> ChamberComplex <span class="quoted"><span class="free">X</span></span> <span class="main">+</span> codomain<span class="main">:</span> ChamberComplex <span class="quoted"><span class="free">Y</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>     <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> chamber_map<span class="main">:</span>  <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span> <span class="main">⟹</span> codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     dim_map    <span class="main">:</span>  <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> card <span class="free">C</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplex<span class="main">)</span> trivial_morphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">X</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplex<span class="main">)</span> inclusion_morphism<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">Y</span> <span class="free">X</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span>
            <span class="operator">rule</span> ChamberComplexMorphism.intro<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> ChamberSubcomplexD_complex<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span>
          <span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subcomplex_chamber<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexMorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> domain_complex <span class="main">=</span> domain.ChamberComplex_axioms
<span class="keyword1"><span class="command">lemmas</span></span> codomain_complex <span class="main">=</span> codomain.ChamberComplex_axioms

<span class="keyword1"><span class="command">lemmas</span></span> simplicialcomplex_image <span class="main">=</span> domain.map_is_simplicial_morph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>

<span class="keyword1" id="Chamber-cong"><span class="command">lemma</span></span> cong<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">g</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⟹</span> ChamberComplexMorphism <span class="free">X</span> <span class="free">Y</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_map domain.chamber_vertices fun_eq_on_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> dim_map
        domain.chamber_vertices
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-comp"><span class="command">lemma</span></span> comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">Y</span> <span class="free">Z</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">Z</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexMorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> domain_complex<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> ChamberComplexMorphism.axioms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span>
<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.chamber <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="free">Z</span> <span class="main">(</span><span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_map ChamberComplexMorphism.chamber_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_map dim_map ChamberComplexMorphism.dim_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-restrict_domain"><span class="command">lemma</span></span> restrict_domain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.ChamberSubcomplex <span class="free">W</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">Y</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexMorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> domain.ChamberSubcomplexD_complex<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> codomain_complex<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span>
<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.subcomplex_chamber chamber_map dim_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-restrict_codomain"><span class="command">lemma</span></span> restrict_codomain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"codomain.ChamberSubcomplex <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⊆</span> <span class="free">Z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">Z</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexMorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> domain_complex<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> codomain.ChamberSubcomplexD_complex<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span>
<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="free">Z</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> chamber_map
          codomain.chamber_in_subcomplex dim_map
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-inj_on_chamber"><span class="command">lemma</span></span> inj_on_chamber<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span> <span class="main">⟹</span> inj_on <span class="free">f</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domain.finite_chamber dim_map <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> eq_card_imp_inj_on<span class="main">)</span>

<span class="keyword1" id="Chamber-bij_betw_chambers"><span class="command">lemma</span></span> bij_betw_chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span> <span class="main">⟹</span> bij_betw <span class="free">f</span> <span class="free">C</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_chamber <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_imageI<span class="main">)</span>

<span class="keyword1" id="Chamber-card_map"><span class="command">lemma</span></span> card_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span><span class="main">)</span> <span class="main">=</span> card <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> domain.simplex_in_max subset_inj_on<span class="main">[</span><span class="operator">OF</span> inj_on_chamber<span class="main">]</span>
        domain.finite_simplex inj_on_iff_eq_card
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>

<span class="keyword1" id="Chamber-codim_map"><span class="command">lemma</span></span> codim_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">⊆</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">y</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="free">C</span><span class="main">-</span><span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms dim_map domain.chamberD_simplex domain.faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
          domain.finite_simplex card_Diff_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span>
          card_map card_Diff_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Chamber-simplex_map"><span class="command">lemma</span></span> simplex_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span><span class="main">∈</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_map domain.simplex_in_max codomain.chamberD_simplex
        codomain.faces<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Chamber-simplices_map"><span class="command">lemma</span></span> simplices_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-vertex_map"><span class="command">lemma</span></span> vertex_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">⋃</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-facet_map"><span class="command">lemma</span></span> facet_map<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">z</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facetrel_subset facetrel_card codim_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> facetrelI_card<span class="main">)</span>

<span class="keyword1" id="Chamber-adj_int_im"><span class="command">lemma</span></span> adj_int_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> facetrelI_card<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chamber_map <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> codomain.chamberD_simplex codomain.chamberD_maximal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">C</span> <span class="main">∩</span> <span class="free">f</span> <span class="main">`</span> <span class="free">D</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.finite_chamber
          card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> codim_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∩</span><span class="free">D</span>"</span></span><span class="main">]</span> adjacent_int_facet1 facetrel_card
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">≤</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 1 assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.finite_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-adj_map'"><span class="command">lemma</span></span> adj_map'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> adj_int_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> adjacent_sym
          adj_int_im<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adjacentI<span class="main">)</span>

<span class="keyword1" id="Chamber-adj_map"><span class="command">lemma</span></span> adj_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> domain.chamber <span class="free">C</span><span class="main">;</span> domain.chamber <span class="free">D</span><span class="main">;</span> <span class="free">C</span> <span class="main">∼</span> <span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span> adj_map' empty_not_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-chamber_vertex_outside_facet_image"><span class="command">lemma</span></span> chamber_vertex_outside_facet_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∉</span><span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="main">(</span>insert <span class="free">v</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="free">v</span> <span class="free">z</span> <span class="main">-</span> <span class="free">z</span> <span class="main">=</span> <span class="main">{</span><span class="free">v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> codim_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-expand_codomain"><span class="command">lemma</span></span> expand_codomain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="free">Z</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.ChamberSubcomplex <span class="free">Z</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">Z</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexMorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> domain_complex<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">unfold_locales</span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> domain.chamber <span class="bound">x</span> <span class="main">⟹</span> SimplicialComplex.maxsimp <span class="free">Z</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_map ChamberComplex.subcomplex_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> dim_map<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexMorphism *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Action on pregalleries and galleries›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexMorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-gallery_map"><span class="command">lemma</span></span> gallery_map<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.gallery <span class="free">Cs</span> <span class="main">⟹</span> codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">C</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.galleryD_chamber chamber_map codomain.gallery_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">#</span> <span class="free">f</span><span class="main">`</span><span class="skolem">C</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> codomain.gallery_CConsI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domain.galleryD_chamber chamber_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> CCons <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">C</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domain.gallery_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">∼</span>  <span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domain.gallery_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span><span class="main">]</span> domain.galleryD_adj
            domain.galleryD_chamber adj_map
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> codomain.maxsimpchain_def<span class="main">)</span>

<span class="keyword1" id="Chamber-gallery_betw_map"><span class="command">lemma</span></span> gallery_betw_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"domain.gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gallery_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexMorphism *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of the image›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexMorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-subcomplex_image"><span class="command">lemma</span></span> subcomplex_image<span class="main">:</span> <span class="quoted"><span class="quoted">"codomain.Subcomplex <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplicialcomplex_image simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> chamber_in_image <span class="main">=</span> codomain.max_in_subcomplex<span class="main">[</span><span class="operator">OF</span> subcomplex_image<span class="main">]</span>

<span class="keyword1" id="Chamber-maxsimp_map_into_image"><span class="command">lemma</span></span> maxsimp_map_into_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> SimplicialComplex.maxsimpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> simplicialcomplex_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> imageI<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> domain.chamberD_simplex<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">⊆</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> simplex_map codomain.chamberD_maximal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-maxsimp_preimage"><span class="command">lemma</span></span> maxsimp_preimage<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.chamber <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">⊆</span><span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> card_subset_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> D<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> domain.finite_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms D <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">C</span> <span class="main">=</span> card <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> domain.chamberD_simplex simplicialcomplex_image
            SimplicialComplex.maxsimpD_maximal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">D</span>"</span></span><span class="main">]</span>
            card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> domain.finite_simplex card_image_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> dim_map
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> D<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> D<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_preimage"><span class="command">lemma</span></span> chamber_preimage<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">X</span> <span class="main">⟹</span> codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">⟹</span> domain.chamber <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_in_image maxsimp_preimage <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-chambercomplex_image"><span class="command">lemma</span></span> chambercomplex_image<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> simplicialcomplex_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊆</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.simplex_in_max maxsimp_map_into_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≠</span><span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
              <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> xy<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zx</span></span> <span class="skolem"><span class="skolem">zy</span></span> <span class="keyword2"><span class="keyword">where</span></span> zxy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">zx</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">zx</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zy</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">zy</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> SimplicialComplex.maxsimpD_simplex<span class="main">[</span><span class="operator">OF</span> simplicialcomplex_image<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
          SimplicialComplex.maxsimpD_simplex<span class="main">[</span><span class="operator">OF</span> simplicialcomplex_image<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> xy <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> ws<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.gallery <span class="main">(</span><span class="skolem">zx</span><span class="main">#</span><span class="skolem">ws</span><span class="main">@</span><span class="main">[</span><span class="skolem">zy</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> maxsimp_preimage domain.maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">zx</span></span> <span class="quoted"><span class="skolem">zy</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ws zxy<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimpchain <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="skolem">ws</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">zx</span><span class="main">#</span><span class="skolem">ws</span><span class="main">@</span><span class="main">[</span><span class="skolem">zy</span><span class="main">]</span>"</span></span><span class="main">]</span> domain.galleryD_chamber
          domain.chamberD_simplex codomain.galleryD_chamber
          codomain.max_in_subcomplex<span class="main">[</span><span class="operator">OF</span> subcomplex_image<span class="main">]</span>
          codomain.galleryD_adj
          SimplicialComplex.maxsimpchain_def<span class="main">[</span><span class="operator">OF</span> simplicialcomplex_image<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> SimplicialComplex.maxsimpchain <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="bound">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chambersubcomplex_image"><span class="command">lemma</span></span> chambersubcomplex_image<span class="main">:</span> <span class="quoted"><span class="quoted">"codomain.ChamberSubcomplex <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplices_map chambercomplex_image ChamberComplex.chamberD_simplex
        chambercomplex_image maxsimp_preimage chamber_map
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> codomain.ChamberSubcomplexI<span class="main">)</span>

<span class="keyword1" id="Chamber-restrict_codomain_to_image"><span class="command">lemma</span></span> restrict_codomain_to_image<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> restrict_codomain chambersubcomplex_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexMorphism *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Action on the chamber system›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexMorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-chamber_system_into"><span class="command">lemma</span></span> chamber_system_into<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>domain.𝒞 <span class="main">⊆</span> codomain.𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_map domain.chamber_system_def codomain.chamber_system_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-chamber_system_image"><span class="command">lemma</span></span> chamber_system_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>domain.𝒞 <span class="main">=</span> codomain.𝒞 <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>domain.𝒞 <span class="main">⊆</span> codomain.𝒞 <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_into domain.chamber_system_simplices <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>domain.𝒞 <span class="main">⊇</span> codomain.𝒞 <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> codomain.𝒞 <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">.</span> domain.chamber <span class="bound">C</span> <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="bound">C</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> codomain.chamber_system_def chamber_preimage <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>domain.𝒞"</span></span> <span class="keyword1"><span class="command">using</span></span> domain.chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-image_chamber_system"><span class="command">lemma</span></span> image_chamber_system<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.𝒞 <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⊢</span> domain.𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplex.chamber_system_def codomain.subcomplex_chamber
        ChamberComplex.chamberD_simplex chambercomplex_image
        chambersubcomplex_image chamber_system_image
        codomain.chamber_in_subcomplex codomain.chamber_system_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-image_chamber_system_image"><span class="command">lemma</span></span> image_chamber_system_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplex.𝒞 <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> codomain.𝒞 <span class="main">∩</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> image_chamber_system chamber_system_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-face_distance_eq_chamber_distance_map"><span class="command">lemma</span></span> face_distance_eq_chamber_distance_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">C</span>"</span></span>
          <span class="quoted"><span class="quoted">"codomain.face_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> domain.face_distance <span class="free">z</span> <span class="free">D</span>"</span></span>
          <span class="quoted"><span class="quoted">"domain.face_distance <span class="free">z</span> <span class="free">D</span> <span class="main">=</span> domain.chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"codomain.face_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span>
            codomain.chamber_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms codomain.face_distance_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">]</span> chamber_map
          codomain.chamber_distance_le
          gallery_betw_map<span class="main">[</span><span class="operator">OF</span> domain.gallery_least_length<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          domain.chamber_distance_def
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">force</span>

<span class="keyword1" id="Chamber-face_distance_eq_chamber_distance_min_gallery_betw_map"><span class="command">lemma</span></span> face_distance_eq_chamber_distance_min_gallery_betw_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">C</span>"</span></span>
          <span class="quoted"><span class="quoted">"codomain.face_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">z</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span> domain.face_distance <span class="free">z</span> <span class="free">D</span>"</span></span>
          <span class="quoted"><span class="quoted">"domain.face_distance <span class="free">z</span> <span class="free">D</span> <span class="main">=</span> domain.chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
          <span class="quoted"><span class="quoted">"domain.min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"codomain.min_gallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms face_distance_eq_chamber_distance_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
          gallery_map<span class="main">[</span><span class="operator">OF</span> domain.min_galleryD_gallery<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span>
          domain.min_gallery_betw_chamber_distance<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">]</span> 
          codomain.min_galleryI_chamber_distance_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexMorphism *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Isomorphisms›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexIsomorphism <span class="main">=</span> ChamberComplexMorphism <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Y</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'b</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> bij_betw_vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     surj_simplex_map <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplexIsomorphism<span class="main">)</span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_vertices bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">sublocale</span></span> ChamberComplexIsomorphism <span class="main">&lt;</span> SimplicialComplexIsomorphism
  <span class="keyword1"><span class="command">using</span></span> inj <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main">)</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplex<span class="main">)</span> trivial_isomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">X</span> <span class="free">X</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trivial_morphism bij_betw_id
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ChamberComplexIsomorphism.intro<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplexMorphism<span class="main">)</span> isoI_inverse<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">Y</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
          <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">f</span><span class="main">∘</span><span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexIsomorphism.intro<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism_axioms <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vertex_map ChamberComplexMorphism.vertex_map
            comps_fixpointwise_imp_bij_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">Y</span>"</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> order.antisym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> simplices_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">Y</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">∘</span><span class="free">g</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> 
        <span class="keyword1"><span class="command">using</span></span> fixespointwise_subset<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> fixespointwise_im <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexIsomorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> domain_complex   <span class="main">=</span> domain_complex
<span class="keyword1"><span class="command">lemmas</span></span> chamber_map      <span class="main">=</span> chamber_map
<span class="keyword1"><span class="command">lemmas</span></span> dim_map          <span class="main">=</span> dim_map
<span class="keyword1"><span class="command">lemmas</span></span> gallery_map      <span class="main">=</span> gallery_map
<span class="keyword1"><span class="command">lemmas</span></span> simplex_map      <span class="main">=</span> simplex_map
<span class="keyword1"><span class="command">lemmas</span></span> chamber_preimage <span class="main">=</span> chamber_preimage

<span class="keyword1" id="Chamber-chamber_morphism"><span class="command">lemma</span></span> chamber_morphism<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">Y</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Chamber-pgallery_map"><span class="command">lemma</span></span> pgallery_map<span class="main">:</span> <span class="quoted"><span class="quoted">"domain.pgallery <span class="free">Cs</span> <span class="main">⟹</span> codomain.pgallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pmaxsimpchain_map surj_simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-iso_cong"><span class="command">lemma</span></span> iso_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">g</span> <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">X</span> <span class="free">Y</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexIsomorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">unfold_locales</span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">g</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_vertices fun_eq_on_bij_betw <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">⊢</span> <span class="free">X</span> <span class="main">=</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> setsetmapim_cong<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> surj_simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-iso_comp"><span class="command">lemma</span></span> iso_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">Y</span> <span class="free">Z</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">X</span> <span class="free">Z</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span>
            <span class="operator">rule</span> ChamberComplexIsomorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> comp<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> ChamberComplexIsomorphism.axioms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> assms<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bij_betw_trans<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> bij_betw_vertices<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> ChamberComplexIsomorphism.bij_betw_vertices<span class="main"><span class="keyword3">,</span></span>
            <span class="operator">rule</span> assms
          <span class="main">)</span>
          <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            setsetmapim_comp surj_simplex_map assms
            ChamberComplexIsomorphism.surj_simplex_map
          <span class="main">)</span>

<span class="keyword1" id="Chamber-inj_on_chamber_system"><span class="command">lemma</span></span> inj_on_chamber_system<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> domain.𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">D</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">C</span> <span class="main">∈</span> domain.𝒞<span class="main">;</span> <span class="skolem">D</span> <span class="main">∈</span> domain.𝒞<span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="skolem">C</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="skolem">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">C</span><span class="main">=</span><span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.chamber_system_def domain.chamber_pconnect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
          pgallery_map codomain.pgalleryD_distinct
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-inv"><span class="command">lemma</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">Y</span> <span class="free">X</span> <span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_vertices bij_betw_the_inv_into <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> 4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">OF</span> bij_betw_vertices<span class="main">]</span> surj_simplex_map
          setsetmapim_the_inv_into
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="skolem">C</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> codomain.chamberD_simplex surj_simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> domain.chamberI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> C' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">∈</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">⊆</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">z</span> <span class="main">=</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C' f_im_the_inv_into_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> surj_simplex_map
            codomain.chamberD_maximal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">z</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C' codomain.finite_chamber
          subset_inj_on<span class="main">[</span><span class="operator">OF</span> inj_on_the_inv_into<span class="main">,</span> <span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_iff_eq_card<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_distance_map"><span class="command">lemma</span></span> chamber_distance_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"codomain.chamber_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span> <span class="main">=</span>
            domain.chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">=</span><span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> inj_on_chamber_system<span class="main">]</span> domain.chamber_system_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.chamber_distance_def codomain.chamber_distance_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> domain.gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ds</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Ds</span><span class="main">.</span> codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">#</span> <span class="bound">Ds</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms False Cs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">Cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gallery_map domain.maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          arg_min_natI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Cs</span><span class="main">.</span> domain.gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms Cs_def
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Es</span><span class="main">.</span> codomain.gallery <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">#</span> <span class="bound">Es</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
            length <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="skolem">Cs</span><span class="main">)</span> <span class="main">≤</span> length <span class="bound">Es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexIsomorphism.gallery_map<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
          the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          domain.chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> domain.chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          domain.maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          arg_min_nat_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Cs</span><span class="main">.</span> domain.gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="main">_</span> <span class="quoted">length</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ds</span> <span class="main">=</span> length <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> Ds_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_min_equality<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> False Cs_def Ds_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.chamber_distance_def codomain.chamber_distance_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-face_distance_map"><span class="command">lemma</span></span> face_distance_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">∈</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"codomain.face_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> domain.face_distance <span class="free">F</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">invf</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> domain.closest_supchamber <span class="free">F</span> <span class="free">C</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> codomain.closest_supchamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">F</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">invf</span> <span class="main">=</span> the_inv_into <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms D_def D'_def invf_def <span class="keyword1"><span class="command">have</span></span> chambers<span class="main">:</span>
    <span class="quoted"><span class="quoted">"codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="skolem">D'</span>"</span></span>
    <span class="quoted"><span class="quoted">"codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="main">(</span><span class="skolem">invf</span><span class="main">`</span><span class="skolem">D'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.closest_supchamberD<span class="main">(</span>1<span class="main">)</span> simplex_map
          codomain.closest_supchamberD<span class="main">(</span>1<span class="main">)</span> chamber_map
          ChamberComplexIsomorphism.chamber_map<span class="main">[</span><span class="operator">OF</span> inv<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"codomain.chamber_distance <span class="skolem">D'</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">≤</span> domain.chamber_distance <span class="skolem">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms D_def D'_def
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"codomain.chamber_distance <span class="skolem">D'</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">≤</span>
              codomain.chamber_distance <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">D</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>4<span class="main">)</span> domain.closest_supchamberD<span class="main">(</span>2<span class="main">)</span>
            codomain.closest_supchamber_def
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_min_nat_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms D_def D'_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>2<span class="main">)</span> chamber_distance_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domain.chamber_distance <span class="skolem">D</span> <span class="free">C</span> <span class="main">≤</span> codomain.chamber_distance <span class="skolem">D'</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms D'_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">invf</span><span class="main">`</span><span class="free">f</span><span class="main">`</span><span class="free">F</span> <span class="main">⊆</span> <span class="skolem">invf</span><span class="main">`</span><span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">)</span> simplex_map codomain.closest_supchamberD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> invf_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">⊆</span> <span class="skolem">invf</span><span class="main">`</span><span class="skolem">D'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_im_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> D_def
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"domain.chamber_distance <span class="skolem">D</span> <span class="free">C</span> <span class="main">≤</span>
              domain.chamber_distance <span class="main">(</span><span class="skolem">invf</span> <span class="main">`</span> <span class="skolem">D'</span><span class="main">)</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>5<span class="main">)</span> domain.closest_supchamber_def
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> arg_min_nat_le<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> invf_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>3<span class="main">,</span>5<span class="main">)</span> surj_simplex_map codomain.chamberD_simplex
            f_im_the_inv_into_f_im<span class="main">[</span><span class="operator">OF</span> inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">D'</span></span><span class="main">]</span>
            chamber_distance_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">invf</span><span class="main">`</span><span class="skolem">D'</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> D_def D'_def domain.face_distance_def codomain.face_distance_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexIsomorphism *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Endomorphisms›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexEndomorphism <span class="main">=</span> ChamberComplexMorphism <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> trivial_outside <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∉</span><span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="comment1">― ‹to facilitate uniqueness arguments›</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplex<span class="main">)</span> trivial_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span>
        <span class="operator">rule</span> ChamberComplexEndomorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> trivial_morphism<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold_locales</span>
      <span class="main">)</span>
      <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexEndomorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ChamberSubcomplex</span> <span class="main">≡</span> domain.ChamberSubcomplex"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Subcomplex</span> <span class="main">≡</span> domain.Subcomplex"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">chamber</span> <span class="main">≡</span> domain.chamber"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gallery</span> <span class="main">≡</span> domain.gallery"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒞</span> <span class="main">≡</span> domain.chamber_system"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">label_wrt</span> <span class="main">≡</span> domain.label_wrt"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> dim_map                 <span class="main">=</span> dim_map
<span class="keyword1"><span class="command">lemmas</span></span> simplex_map             <span class="main">=</span> simplex_map
<span class="keyword1"><span class="command">lemmas</span></span> vertex_map              <span class="main">=</span> vertex_map
<span class="keyword1"><span class="command">lemmas</span></span> chamber_map             <span class="main">=</span> chamber_map
<span class="keyword1"><span class="command">lemmas</span></span> adj_map                 <span class="main">=</span> adj_map
<span class="keyword1"><span class="command">lemmas</span></span> facet_map               <span class="main">=</span> facet_map
<span class="keyword1"><span class="command">lemmas</span></span> bij_betw_chambers       <span class="main">=</span> bij_betw_chambers
<span class="keyword1"><span class="command">lemmas</span></span> chamber_system_into     <span class="main">=</span> chamber_system_into
<span class="keyword1"><span class="command">lemmas</span></span> chamber_system_image    <span class="main">=</span> chamber_system_image
<span class="keyword1"><span class="command">lemmas</span></span> image_chamber_system    <span class="main">=</span> image_chamber_system
<span class="keyword1"><span class="command">lemmas</span></span> chambercomplex_image    <span class="main">=</span> chambercomplex_image
<span class="keyword1"><span class="command">lemmas</span></span> chambersubcomplex_image <span class="main">=</span> chambersubcomplex_image

<span class="keyword1"><span class="command">lemmas</span></span> face_distance_eq_chamber_distance_map <span class="main">=</span>
  face_distance_eq_chamber_distance_map
<span class="keyword1"><span class="command">lemmas</span></span> face_distance_eq_chamber_distance_min_gallery_betw_map <span class="main">=</span>
  face_distance_eq_chamber_distance_min_gallery_betw_map
<span class="keyword1"><span class="command">lemmas</span></span> facedist_chdist_mingal_btwmap <span class="main">=</span>
  face_distance_eq_chamber_distance_min_gallery_betw_map

<span class="keyword1"><span class="command">lemmas</span></span> trivial_endomorphism     <span class="main">=</span> domain.trivial_endomorphism
<span class="keyword1"><span class="command">lemmas</span></span> finite_simplices         <span class="main">=</span> domain.finite_simplices
<span class="keyword1"><span class="command">lemmas</span></span> faces                    <span class="main">=</span> domain.faces
<span class="keyword1"><span class="command">lemmas</span></span> maxsimp_connect          <span class="main">=</span> domain.maxsimp_connect
<span class="keyword1"><span class="command">lemmas</span></span> simplex_in_max           <span class="main">=</span> domain.simplex_in_max
<span class="keyword1"><span class="command">lemmas</span></span> chamberD_simplex         <span class="main">=</span> domain.chamberD_simplex
<span class="keyword1"><span class="command">lemmas</span></span> chamber_system_def       <span class="main">=</span> domain.chamber_system_def
<span class="keyword1"><span class="command">lemmas</span></span> chamber_system_simplices <span class="main">=</span> domain.chamber_system_simplices
<span class="keyword1"><span class="command">lemmas</span></span> galleryD_chamber         <span class="main">=</span> domain.galleryD_chamber
<span class="keyword1"><span class="command">lemmas</span></span> galleryD_adj             <span class="main">=</span> domain.galleryD_adj
<span class="keyword1"><span class="command">lemmas</span></span> gallery_append_reduce1   <span class="main">=</span> domain.gallery_append_reduce1
<span class="keyword1"><span class="command">lemmas</span></span> gallery_Cons_reduce      <span class="main">=</span> domain.gallery_Cons_reduce
<span class="keyword1"><span class="command">lemmas</span></span> gallery_chamber_system   <span class="main">=</span> domain.gallery_chamber_system
<span class="keyword1"><span class="command">lemmas</span></span> label_wrtD               <span class="main">=</span> domain.label_wrtD
<span class="keyword1"><span class="command">lemmas</span></span> label_wrt_adjacent       <span class="main">=</span> domain.label_wrt_adjacent

<span class="keyword1" id="Chamber-endo_comp"><span class="command">lemma</span></span> endo_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexEndomorphism.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">X</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> comp ChamberComplexEndomorphism.axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism_axioms <span class="free">X</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trivial_outside ChamberComplexEndomorphism.trivial_outside
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-restrict_endo"><span class="command">lemma</span></span> restrict_endo<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberSubcomplex <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">Y</span> <span class="main">⊆</span> <span class="free">Y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">Y</span> <span class="main">(</span>restrict1 <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexEndomorphism.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">Y</span> <span class="free">Y</span> <span class="main">(</span>restrict1 <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Y</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main">]</span>
          ChamberComplexMorphism.restrict_codomain
          restrict_domain fun_eq_on_restrict1
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism_axioms <span class="free">Y</span> <span class="main">(</span>restrict1 <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">Y</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-funpower_endomorphism"><span class="command">lemma</span></span> funpower_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trivial_endomorphism subst<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span><span class="free">f</span><span class="main">^^</span><span class="skolem">m</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> endo_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">^^</span><span class="skolem">m</span> <span class="main">∘</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span><span class="main">^^</span><span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> funpow_Suc_right<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subst<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> ChamberComplexEndomorphism <span class="free">X</span> <span class="bound">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexEndomorphism *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplex<span class="main">)</span> fold_chamber_complex_endomorph_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
    ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>fold <span class="free">f</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> trivial_endomorphism subst<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>fold <span class="free">f</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="free">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexEndomorphism.endo_comp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold <span class="free">f</span> <span class="skolem">xs</span> <span class="main">∘</span> <span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> fold <span class="free">f</span> <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> subst<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> ChamberComplexEndomorphism <span class="free">X</span> <span class="bound">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexEndomorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-split_gallery"><span class="command">lemma</span></span> split_gallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">As</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Bs</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">B</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="bound">A</span><span class="main">#</span><span class="bound">B</span><span class="main">#</span><span class="bound">Bs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="skolem">C</span><span class="main">#</span><span class="free">D</span><span class="main">#</span><span class="skolem">As</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Nil<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">E</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="main">(</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">As</span><span class="main">)</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword1"><span class="command">using</span></span> gallery_chamber_system<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="main">(</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="main">(</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-respects_labels_adjacent"><span class="command">lemma</span></span> respects_labels_adjacent<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">have</span></span> CD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∉</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="skolem">w</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">w</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_vertex_outside_facet_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∩</span><span class="free">D</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">D</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">C</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> v <span class="keyword1"><span class="command">have</span></span> fD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">D</span><span class="main">∩</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">D</span><span class="main">∩</span><span class="free">C</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> adjacent_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> adjacent_conv_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
              chamber_vertex_outside_facet_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∩</span><span class="free">C</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">=</span><span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> fC fD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fCfD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">∼</span><span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chamber_map adj_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> fC fCfD False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">w</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> adjacent_to_adjacent_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> fD fCfD False adjacent_sym
                adjacent_to_adjacent_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
                label_wrt_adjacent<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span>"</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> False v w assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> label_wrt_adjacent<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-4<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Chamber-respects_labels_gallery"><span class="command">lemma</span></span> respects_labels_gallery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">D</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> galleryD_chamber galleryD_adj
          respects_labels_adjacent<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> gallery_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span>"</span></span><span class="main">]</span> galleryD_chamber galleryD_adj
          binrelchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted">adjacent</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="skolem">Es</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">E</span><span class="main">,</span><span class="skolem">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
          respects_labels_adjacent<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-respect_label_fix_chamber_imp_fun_eq_on"><span class="command">lemma</span></span> respect_label_fix_chamber_imp_fun_eq_on<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> label  <span class="main">:</span>  <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chamber<span class="main">:</span>  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     respect<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="free">φ</span> <span class="main">(</span><span class="free">g</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> respect <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">v</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label chamber chamber_map chamber_system_def label_wrtD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span>
          bij_betw_imp_inj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span><span class="main">]</span> inj_onD
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> respects_label_fixes_chamber_imp_fixespointwise <span class="main">=</span>
  respect_label_fix_chamber_imp_fun_eq_on<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted">id</span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexEndomorphism *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Automorphisms›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexAutomorphism <span class="main">=</span> ChamberComplexIsomorphism <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> trivial_outside <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∉</span><span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="comment1">― ‹to facilitate uniqueness arguments›</span>

<span class="keyword1"><span class="command">sublocale</span></span> ChamberComplexAutomorphism <span class="main">&lt;</span> ChamberComplexEndomorphism
  <span class="keyword1"><span class="command">using</span></span> trivial_outside <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplex<span class="main">)</span> trivial_automorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span> trivial_isomorphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ChamberComplexAutomorphism.intro<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexAutomorphism
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> facet_map         <span class="main">=</span> facet_map
<span class="keyword1"><span class="command">lemmas</span></span> chamber_map       <span class="main">=</span> chamber_map
<span class="keyword1"><span class="command">lemmas</span></span> chamber_morphism  <span class="main">=</span> chamber_morphism
<span class="keyword1"><span class="command">lemmas</span></span> bij_betw_vertices <span class="main">=</span> bij_betw_vertices
<span class="keyword1"><span class="command">lemmas</span></span> surj_simplex_map  <span class="main">=</span> surj_simplex_map

<span class="keyword1" id="Chamber-bij"><span class="command">lemma</span></span> bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bijI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> injI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">y</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">OF</span> bij_betw_vertices<span class="main">]</span> inj_onD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
            vertex_map trivial_outside
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"surj <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> surj_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_surj_on<span class="main">[</span><span class="operator">OF</span> bij_betw_vertices<span class="main">]</span>
            trivial_outside<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-comp"><span class="command">lemma</span></span> comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexAutomorphism.intro<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> ChamberComplexIsomorphism.intro<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> ChamberComplexMorphism.comp
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">X</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexAutomorphism.chamber_morphism <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism_axioms <span class="free">X</span> <span class="free">X</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_betw_vertices ChamberComplexAutomorphism.bij_betw_vertices
            bij_betw_trans
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> surj_simplex_map ChamberComplexAutomorphism.surj_simplex_map 
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> setsetmapim_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism_axioms <span class="free">X</span> <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trivial_outside ChamberComplexAutomorphism.trivial_outside<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">unfold_locales</span>

<span class="keyword1" id="Chamber-equality"><span class="command">lemma</span></span> equality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> <span class="free">g</span>"</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">=</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> trivial_outside fun_eq_onD<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
          ChamberComplexAutomorphism.trivial_outside<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexAutomorphism *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Retractions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A retraction of a chamber complex is an endomorphism that is the identity on its image.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexRetraction <span class="main">=</span> ChamberComplexEndomorphism <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> retraction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">v</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> simplex_map <span class="main">=</span> simplex_map
<span class="keyword1"><span class="command">lemmas</span></span> chamber_map <span class="main">=</span> chamber_map
<span class="keyword1"><span class="command">lemmas</span></span> gallery_map <span class="main">=</span> gallery_map

<span class="keyword1" id="Chamber-vertex_retraction"><span class="command">lemma</span></span> vertex_retraction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> retraction <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-simplex_retraction1"><span class="command">lemma</span></span> simplex_retraction1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span> fixespointwise <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> retraction fixespointwiseI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-simplex_retraction2"><span class="command">lemma</span></span> simplex_retraction2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> retraction retraction<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Chamber-chamber_retraction1"><span class="command">lemma</span></span> chamber_retraction1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> fixespointwise <span class="free">f</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices simplex_retraction1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-chamber_retraction2"><span class="command">lemma</span></span> chamber_retraction2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices simplex_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-respects_labels"><span class="command">lemma</span></span> respects_labels<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_retraction1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> chamber_system_def chamber_map
          maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> chamber_retraction1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span><span class="main">]</span>
          respects_labels_gallery<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixespointwiseD<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexRetraction *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Foldings of chamber complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A folding of a chamber complex is a retraction that literally folds the complex in half, in that
  each chamber in the image is the image of precisely two chambers: itself (since a folding is a
  retraction) and a unique chamber outside the image.
›</span></span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Locale definition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we define the locale and collect some lemmas inherited from the
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ChamberComplexRetraction<span class="antiquote"><span class="antiquote">}</span></span></span></span> locale.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexFolding <span class="main">=</span> ChamberComplexRetraction <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> folding<span class="main">:</span>
    <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span>
      <span class="main">∃!</span><span class="bound">D</span><span class="main">.</span> chamber <span class="bound">D</span> <span class="main">∧</span> <span class="bound">D</span><span class="main">∉</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="bound">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> folding_ex          <span class="main">=</span> ex1_implies_ex<span class="main">[</span><span class="operator">OF</span> folding<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> chamber_system_into <span class="main">=</span> chamber_system_into
<span class="keyword1"><span class="command">lemmas</span></span> gallery_map         <span class="main">=</span> gallery_map
<span class="keyword1"><span class="command">lemmas</span></span> chamber_retraction1 <span class="main">=</span> chamber_retraction1
<span class="keyword1"><span class="command">lemmas</span></span> chamber_retraction2 <span class="main">=</span> chamber_retraction2

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexFolding *)</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Decomposition into half chamber systems and half apartments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we describe how a folding splits the chamber system of the complex into its image and the
  complement of its image. The chamber subcomplex consisting of all simplices contained in a
  chamber of a given half of the chamber system is called a half-apartment.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexFolding
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">opp_half_apartment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">opp_half_apartment</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="main">∃</span><span class="bound">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">.</span> <span class="bound">x</span><span class="main">⊆</span><span class="bound">C</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≡</span> opp_half_apartment"</span></span>

<span class="keyword1" id="Chamber-opp_half_apartment_subset_complex"><span class="command">lemma</span></span> opp_half_apartment_subset_complex<span class="main">:</span> <span class="quoted"><span class="quoted">"Y<span class="main">⊆</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> opp_half_apartment_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-simplicialcomplex_opp_half_apartment"><span class="command">lemma</span></span> simplicialcomplex_opp_half_apartment<span class="main">:</span> <span class="quoted"><span class="quoted">"SimplicialComplex Y"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>Y<span class="main">.</span> finite <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> opp_half_apartment_subset_complex finite_simplices <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>Y"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">⊆</span><span class="skolem">x</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>Y"</span></span>
    <span class="keyword1"><span class="command">using</span></span>     opp_half_apartment_subset_complex faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> opp_half_apartment_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-subcomplex_opp_half_apartment"><span class="command">lemma</span></span> subcomplex_opp_half_apartment<span class="main">:</span> <span class="quoted"><span class="quoted">"Subcomplex Y"</span></span>
  <span class="keyword1"><span class="command">using</span></span> opp_half_apartment_subset_complex simplicialcomplex_opp_half_apartment
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Chamber-opp_half_apartmentI"><span class="command">lemma</span></span> opp_half_apartmentI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">x</span><span class="main">∈</span><span class="free">X</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">x</span><span class="main">⊆</span><span class="free">C</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">x</span><span class="main">∈</span>Y"</span></span>
  <span class="keyword1"><span class="command">using</span></span> opp_half_apartment_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-opp_chambers_subset_opp_half_apartment"><span class="command">lemma</span></span> opp_chambers_subset_opp_half_apartment<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⊆</span> Y"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> Y"</span></span> <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices opp_half_apartmentI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-maxsimp_in_opp_half_apartment"><span class="command">lemma</span></span> maxsimp_in_opp_half_apartment<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp Y <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">⊆</span><span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SimplicialComplex.maxsimpD_simplex<span class="main">[</span>
            <span class="operator">OF</span> simplicialcomplex_opp_half_apartment<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span>
          <span class="main">]</span>
          opp_half_apartment_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> opp_chambers_subset_opp_half_apartment 
          SimplicialComplex.maxsimpD_maximal<span class="main">[</span>
            <span class="operator">OF</span> simplicialcomplex_opp_half_apartment
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_in_opp_half_apartment"><span class="command">lemma</span></span> chamber_in_opp_half_apartment<span class="main">:</span>
  <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp Y <span class="free">C</span> <span class="main">⟹</span> chamber <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_in_opp_half_apartment chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexFolding *)</span>

<span class="keyword1"><span class="command">paragraph</span></span> <span class="quoted"><span class="plain_text">‹Mapping between half chamber systems for foldings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since each chamber in the image of the folding is the image of a unique chamber in the complement
  of the image, we obtain well-defined functions from one half chamber system to the other.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexFolding
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">opp_chamber</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">D</span><span class="main">.</span> <span class="bound">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="bound">D</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flop</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞 <span class="keyword1">then</span> opp_chamber <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="keyword1">else</span> <span class="free">f</span><span class="main">`</span><span class="free"><span class="bound"><span class="entity">C</span></span></span>"</span></span>

<span class="keyword1" id="Chamber-inj_on_opp_chambers'"><span class="command">lemma</span></span> inj_on_opp_chambers'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∉</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∉</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> folding <span class="keyword1"><span class="command">have</span></span> ex1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">B</span><span class="main">.</span> chamber <span class="bound">B</span> <span class="main">∧</span> <span class="bound">B</span><span class="main">∉</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="bound">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamberD_simplex chamber_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ex1_unique<span class="main">[</span><span class="operator">OF</span> ex1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>  

<span class="keyword1" id="Chamber-inj_on_opp_chambers''"><span class="command">lemma</span></span> inj_on_opp_chambers''<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_def chamber_system_image inj_on_opp_chambers' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-inj_on_opp_chambers"><span class="command">lemma</span></span> inj_on_opp_chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_opp_chambers'' inj_onI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-opp_chambers_surj"><span class="command">lemma</span></span> opp_chambers_surj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="main">(</span>𝒞<span class="main">-</span><span class="main">(</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∉</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">=</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def chamber_map chamberD_simplex folding_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span><span class="main">(</span>𝒞 <span class="main">-</span> <span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_image chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-opp_chambers_bij"><span class="command">lemma</span></span> opp_chambers_bij<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>𝒞<span class="main">-</span><span class="main">(</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inj_on_opp_chambers opp_chambers_surj bij_betw_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> <span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-folding'"><span class="command">lemma</span></span> folding'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">.</span> <span class="free">f</span><span class="main">`</span><span class="bound">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="bound">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_image chamber_system_def folding_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="skolem">D</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">f</span><span class="main">`</span><span class="skolem">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">=</span><span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def chamber_system_image chamber_map
          chamberD_simplex ex1_unique<span class="main">[</span><span class="operator">OF</span> folding<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-opp_chambers_distinct_map"><span class="command">lemma</span></span> opp_chambers_distinct_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> distinct <span class="free">Cs</span> <span class="main">⟹</span> distinct <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> distinct_map subset_inj_on<span class="main">[</span><span class="operator">OF</span> inj_on_opp_chambers<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-opp_chamberD1"><span class="command">lemma</span></span> opp_chamberD1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> opp_chamber <span class="free">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> folding'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-opp_chamberD2"><span class="command">lemma</span></span> opp_chamberD2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span>opp_chamber <span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> folding'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-opp_chamber_reverse"><span class="command">lemma</span></span> opp_chamber_reverse<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> opp_chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the1_equality<span class="main">[</span><span class="operator">OF</span> folding'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-f_opp_chamber_list"><span class="command">lemma</span></span> f_opp_chamber_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">f</span><span class="main">⊨</span><span class="main">(</span>map opp_chamber <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> opp_chamberD2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-flop_chamber"><span class="command">lemma</span></span> flop_chamber<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> chamber <span class="main">(</span>flop <span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_map opp_chamberD1 chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexFolding *)</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Thin chamber complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A thin chamber complex is one in which every facet is a facet in exactly two chambers. Slightly
  more generally, we first consider the case of a chamber complex in which every facet is a facet
  of at most two chambers. One of the main results obtained at this point is the so-called standard
  uniqueness argument, which essentially states that two morphisms on a thin chamber complex that
  agree on a particular chamber must in fact agree on the entire complex. Following that, foldings
  of thin chamber complexes are investigated. In particular, we are interested in pairs of opposed
  foldings.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locales and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ThinishChamberComplex <span class="main">=</span> ChamberComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> thinish<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span><span class="main">;</span> <span class="main">∃</span><span class="bound">D</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">.</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">D</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">.</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">D</span>"</span></span>
  <span class="comment1">― ‹being adjacent to a chamber, such a <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">D</span></span><span class="antiquote">}</span></span> would also be a chamber (see lemma
<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">text</span> <span class="raw_text">"chamber_adj"</span><span class="antiquote">}</span></span>)›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-facet_unique_other_chamber"><span class="command">lemma</span></span> facet_unique_other_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">B</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">B</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">z</span><span class="main">⊲</span><span class="free">D</span><span class="main">;</span> <span class="free">C</span><span class="main">≠</span><span class="free">B</span><span class="main">;</span> <span class="free">D</span><span class="main">≠</span><span class="free">B</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamberD_simplex bex1_equality<span class="main">[</span><span class="operator">OF</span> thinish<span class="main">,</span> <span class="operator">OF</span> _ _ bexI<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-finite_adjacentset"><span class="command">lemma</span></span> finite_adjacentset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"finite <span class="main">(</span>adjacentset <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> adjacentset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">⋃</span><span class="bound">v</span><span class="main">∈</span><span class="free">C</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="bound">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> Cv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chamberD_simplex facetrel_diff_vertex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chamberD_simplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">C</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> ssubst<span class="main">[</span><span class="operator">OF</span> 1<span class="main">,</span> <span class="operator">of</span> <span class="quoted">finite</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">C</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">⊲</span><span class="bound">D</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">C</span><span class="main">,</span><span class="skolem">D</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cv chamber_shared_facet<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms adjacentset_conv_facetchambersets <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-label_wrt_eq_on_adjacent_vertex"><span class="command">lemma</span></span> label_wrt_eq_on_adjacent_vertex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">v</span> <span class="free">v'</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="free">z</span> <span class="free">z'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> D <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">≡</span> insert <span class="free">v</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     D'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≡</span> insert <span class="free">v'</span> <span class="free">z'</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> label   <span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">f</span> <span class="free">v'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z'</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">≠</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D'</span><span class="main">≠</span><span class="free">C</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="free">D'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> facet_unique_other_chamber<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> D D' chambers<span class="main">(</span>1-5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> z'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z'</span><span class="main">⊲</span><span class="free">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chambers_share_facet <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>

  <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> w <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">z</span> "</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="skolem">w</span>  <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   w'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">∉</span> <span class="free">z'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="skolem">w'</span> <span class="free">z'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> facetrel_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> w' D' chambers<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">z'</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span> <span class="free">v'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> z' label_wrtD'<span class="main">[</span><span class="operator">OF</span> label<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          facetrel_complement_vertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z'</span></span><span class="main">]</span>
          label_wrt_adjacent_shared_facet<span class="main">[</span><span class="operator">OF</span> label<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v'</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> w D chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">z</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">-</span> <span class="main">{</span><span class="free">f</span> <span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> z label_wrtD'<span class="main">[</span><span class="operator">OF</span> label<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          facetrel_complement_vertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
          label_wrt_adjacent_shared_facet<span class="main">[</span><span class="operator">OF</span> label<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> z' chambers<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> label<span class="main">(</span>2<span class="main">)</span> facetrel_subset
          label_wrtD'<span class="main">[</span><span class="operator">OF</span> label<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          bij_betw_imp_inj_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> inj_on_eq_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Chamber-face_distance_eq_chamber_distance_compare_other_chamber"><span class="command">lemma</span></span> face_distance_eq_chamber_distance_compare_other_chamber<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span>
            <span class="quoted"><span class="quoted">"chamber_distance <span class="free">C</span> <span class="free">E</span> <span class="main">≤</span> chamber_distance <span class="free">D</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="free">E</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> face_distance_def closest_supchamber_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> arg_min_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> facetrel_subset<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">B</span><span class="main">.</span> chamber <span class="bound">B</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">⊆</span> <span class="bound">B</span> <span class="main">⟹</span>
            chamber_distance <span class="free">C</span> <span class="free">E</span> <span class="main">≤</span> chamber_distance <span class="bound">B</span> <span class="free">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_facet_is_chamber_facet facet_unique_other_chamber
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinishChamberComplex *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplexIsomorphism<span class="main">)</span> thinish_image_shared_facet<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> dom<span class="main">:</span>  <span class="quoted"><span class="quoted">"domain.chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"domain.chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     cod<span class="main">:</span>  <span class="quoted"><span class="quoted">"ThinishChamberComplex <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="free">D'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">z</span> <span class="main">⊲</span> <span class="free">D'</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="free">D'</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">D'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ThinishChamberComplex.facet_unique_other_chamber<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cod<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> dom<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"codomain.chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dom <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">z</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">z</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> facet_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> dom <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"domain.pgallery <span class="main">[</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> domain.pgallery_def adjacentI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"codomain.pgallery <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">,</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pgallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> codomain.pgalleryD_distinct <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> cod<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cod<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> cod<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> ThinChamberComplex <span class="main">=</span> ChamberComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> thin<span class="main">:</span>  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="main">∃!</span><span class="bound"><span class="bound">D</span></span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">}</span><span class="main">.</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">D</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ThinChamberComplex <span class="main">&lt;</span> ThinishChamberComplex
  <span class="keyword1"><span class="command">using</span></span> thin <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-thinish"><span class="command">lemma</span></span> thinish<span class="main">:</span> <span class="quoted"><span class="quoted">"ThinishChamberComplex <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> face_distance_eq_chamber_distance_compare_other_chamber <span class="main">=</span>
  face_distance_eq_chamber_distance_compare_other_chamber

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_adj_chamber</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> <span class="keyword1">THE</span> <span class="bound">D</span><span class="main">.</span> <span class="bound">D</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">⊲</span> <span class="bound">D</span>"</span></span>

<span class="keyword1" id="Chamber-the_adj_chamber_simplex"><span class="command">lemma</span></span> the_adj_chamber_simplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊲</span> <span class="free">C</span> <span class="main">⟹</span> the_adj_chamber <span class="free">C</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> thin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-the_adj_chamber_facet"><span class="command">lemma</span></span> the_adj_chamber_facet<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊲</span> the_adj_chamber <span class="free">C</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> thin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-the_adj_chamber_is_adjacent"><span class="command">lemma</span></span> the_adj_chamber_is_adjacent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∼</span> the_adj_chamber <span class="free">C</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the_adj_chamber_facet <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adjacentI<span class="main">)</span>
  
<span class="keyword1" id="Chamber-the_adj_chamber"><span class="command">lemma</span></span> the_adj_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊲</span> <span class="free">C</span> <span class="main">⟹</span> chamber <span class="main">(</span>the_adj_chamber <span class="free">C</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> the_adj_chamber_simplex the_adj_chamber_is_adjacent
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chamber_adj<span class="main">)</span>

<span class="keyword1" id="Chamber-the_adj_chamber_neq"><span class="command">lemma</span></span> the_adj_chamber_neq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊲</span> <span class="free">C</span> <span class="main">⟹</span> the_adj_chamber <span class="free">C</span> <span class="free">z</span> <span class="main">≠</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> theI'<span class="main">[</span><span class="operator">OF</span> thin<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-the_adj_chamber_adjacentset"><span class="command">lemma</span></span> the_adj_chamber_adjacentset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> the_adj_chamber <span class="free">C</span> <span class="free">z</span> <span class="main">∈</span> adjacentset <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacentset_def the_adj_chamber_simplex the_adj_chamber_is_adjacent
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplex *)</span>

<span class="keyword1"><span class="command">lemmas</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ChamberComplexIsomorphism<span class="main">)</span> thin_image_shared_facet <span class="main">=</span>
  thinish_image_shared_facet<span class="main">[</span><span class="operator">OF</span> _ _ _ _ _ ThinChamberComplex.thinish<span class="main">]</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The standard uniqueness argument for chamber morphisms of thin chamber complexes›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinishChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-standard_uniqueness_dbl"><span class="command">lemma</span></span> standard_uniqueness_dbl<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> morph   <span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
                    <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="free">C</span>"</span></span>
                    <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="free">D</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">D</span> <span class="main">≠</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">g</span><span class="main">`</span><span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     funeq   <span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">D</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> funeq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fun_eq_onD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="main">∩</span> <span class="free">g</span><span class="main">`</span><span class="free">D</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> morph<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.adj_map' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> F_def chambers<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> F_facet<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">⊲</span><span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">⊲</span><span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_int_facet1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span> adjacent_int_facet2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> F_def G_def chambers <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.adj_map'<span class="main">[</span><span class="operator">OF</span> morph<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            adjacent_to_adjacent_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> 1
            adjacent_to_adjacent_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span> funeq fun_eq_on_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> G_def morph<span class="main">(</span>2<span class="main">)</span> chambers <span class="keyword1"><span class="command">have</span></span> F_facet'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">⊲</span><span class="free">g</span><span class="main">`</span><span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.adj_map' adjacent_int_facet2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.chamber_map<span class="main">[</span><span class="operator">OF</span> morph<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> F_facet
            ChamberComplexMorphism.chamber_map<span class="main">[</span><span class="operator">OF</span> morph<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            fun_eq_on_im<span class="main">[</span><span class="operator">OF</span> funeq<span class="main">]</span>
            facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>3<span class="main">)</span> v False <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span><span class="free">D</span><span class="main">∩</span><span class="free">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_sym adjacent_conv_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp<span class="main">[</span><span class="operator">OF</span> adjacent_sym<span class="main">,</span> <span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">f</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 2 w<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span><span class="main">∈</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">v'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> w<span class="main">(</span>1<span class="main">)</span> 3 funeq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_on_im<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-standard_uniqueness_pgallery_betw"><span class="command">lemma</span></span> standard_uniqueness_pgallery_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> morph   <span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
                    <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="free">W</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
                    <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">g</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> morph<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="free">W</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.domain_complex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span><span class="main">;</span> ChamberComplex.gallery <span class="free">W</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
          pgallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">;</span> pgallery <span class="main">(</span><span class="free">g</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
          fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">from</span></span> assms Nil<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplex.galleryD_chamber<span class="main">[</span><span class="operator">OF</span> W Nil<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            ChamberComplex.galleryD_adj<span class="main">[</span><span class="operator">OF</span> W Nil<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
            pgalleryD_distinct<span class="main">[</span><span class="operator">OF</span> Nil<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> pgalleryD_distinct<span class="main">[</span><span class="operator">OF</span> Nil<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
            pgalleryD_chamber<span class="main">[</span><span class="operator">OF</span> Nil<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> standard_uniqueness_dbl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">W</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">B</span> <span class="skolem">Bs</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> standard_uniqueness_dbl<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> morph<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> morph<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∼</span><span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ChamberComplex.galleryD_chamber<span class="main">[</span><span class="operator">OF</span> W Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
              ChamberComplex.galleryD_adj<span class="main">[</span><span class="operator">OF</span> W Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pgalleryD_distinct<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="skolem">B</span> <span class="main">≠</span> <span class="free">g</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pgalleryD_distinct<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">g</span><span class="main">`</span><span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> pgalleryD_chamber<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplex.gallery_Cons_reduce<span class="main">[</span><span class="operator">OF</span> W<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
            pgallery_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
            pgallery_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">⊨</span><span class="main">(</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> chambers <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-standard_uniqueness"><span class="command">lemma</span></span> standard_uniqueness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> morph   <span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
                    <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">W</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chamber <span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     map_gals<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> ChamberComplex.min_gallery <span class="free">W</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">)</span> <span class="main">⟹</span> pgallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> ChamberComplex.min_gallery <span class="free">W</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">)</span> <span class="main">⟹</span> pgallery <span class="main">(</span><span class="free">g</span><span class="main">⊨</span><span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="main">⋃</span><span class="free">W</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> morph<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="free">W</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.axioms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">⋃</span><span class="free">W</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplex.simplex_in_max<span class="main">[</span><span class="operator">OF</span> W<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> ChamberComplex.gallery <span class="free">W</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber map_gals<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem">Cs</span></span><span class="main"><span class="main">@</span></span><span class="main"><span class="main">[</span></span><span class="skolem"><span class="skolem">D</span></span><span class="main"><span class="main">]</span></span>"</span></span></span><span class="main">]</span>
          ChamberComplex.gallery_least_length<span class="main">[</span><span class="operator">OF</span> W<span class="main">]</span>
          ChamberComplex.min_gallery_least_length<span class="main">[</span><span class="operator">OF</span> W<span class="main">]</span>
          standard_uniqueness_pgallery_betw<span class="main">[</span><span class="operator">OF</span> morph<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> chamber<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">]</span>
          fun_eq_onD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">=</span><span class="free">C</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-standard_uniqueness_isomorphs"><span class="command">lemma</span></span> standard_uniqueness_isomorphs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">W</span> <span class="free">X</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">W</span> <span class="free">X</span> <span class="free">g</span>"</span></span>
          <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">W</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="main">(</span><span class="main">⋃</span><span class="free">W</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms ChamberComplexIsomorphism.chamber_morphism
          ChamberComplexIsomorphism.domain_complex
          ChamberComplex.min_gallery_pgallery
          ChamberComplexIsomorphism.pgallery_map
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> standard_uniqueness<span class="main">)</span>

<span class="keyword1" id="Chamber-standard_uniqueness_automorphs"><span class="command">lemma</span></span> standard_uniqueness_automorphs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> <span class="free">g</span>"</span></span>
          <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">=</span><span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms ChamberComplexAutomorphism.equality
          standard_uniqueness_isomorphs
          ChamberComplexAutomorphism.axioms<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">blast</span>
  

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinishChamberComplex *)</span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> standard_uniqueness               <span class="main">=</span> standard_uniqueness
<span class="keyword1"><span class="command">lemmas</span></span> standard_uniqueness_isomorphs     <span class="main">=</span> standard_uniqueness_isomorphs
<span class="keyword1"><span class="command">lemmas</span></span> standard_uniqueness_pgallery_betw <span class="main">=</span> standard_uniqueness_pgallery_betw

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplex *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Foldings of thin chamber complexes›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ThinishChamberComplexFolding <span class="main">=</span>
  ThinishChamberComplex <span class="quoted"><span class="free">X</span></span> <span class="main">+</span> folding<span class="main">:</span> ChamberComplexFolding <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">opp_chamber</span> <span class="main">≡</span> folding.opp_chamber"</span></span>

<span class="keyword1" id="Chamber-adjacent_half_chamber_system_image"><span class="command">lemma</span></span> adjacent_half_chamber_system_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> adjacent <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> facetrel_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> chamber_system_simplices
          folding.simplicialcomplex_image
          SimplicialComplex.faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
          folding.simplex_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> chambers <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">≠</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chambers chamber_system_def folding.chamber_map
          folding.facet_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
          facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-adjacent_half_chamber_system_image_reverse"><span class="command">lemma</span></span> adjacent_half_chamber_system_image_reverse<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">C</span><span class="main">∼</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> opp_chamber <span class="free">C</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_half_chamber_system_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
        the1_equality<span class="main">[</span><span class="operator">OF</span> folding.folding'<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-chamber_image_closer"><span class="command">lemma</span></span> chamber_image_closer<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">≠</span><span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="free">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">Cs</span> <span class="main">&lt;</span> length <span class="free">Ds</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">Es</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">#</span><span class="free">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.split_gallery<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">Ds</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">)</span> split<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∼</span><span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gallery_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">As</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span>"</span></span><span class="main">]</span> galleryD_adj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> split<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  fB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">B</span> <span class="main">=</span> <span class="free">B</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fA<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">A</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">E</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.chamber_retraction2 adjacent_half_chamber_system_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">E</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">Cs</span> <span class="main">&lt;</span> length <span class="free">Ds</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">As</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">have</span></span> As<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> split<span class="main">(</span>3<span class="main">)</span> As assms<span class="main">(</span>3<span class="main">)</span> fE <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">Fs</span> <span class="skolem">F</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> split<span class="main">(</span>3<span class="main">)</span> As fE
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">=</span> <span class="skolem">E</span><span class="main">#</span><span class="skolem">Fs</span>"</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">B</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">Fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fB folding.gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span> gallery_Cons_reduce
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">H</span> <span class="skolem">Hs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> Cons split<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">=</span> <span class="skolem">Hs</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">=</span><span class="skolem">E</span>"</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="skolem">Hs</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> decomp<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> fB fA fE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">B</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">Hs</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> folding.gallery_map gallery_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="skolem">Hs</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> decomp<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">Fs</span> <span class="skolem">F</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> split<span class="main">(</span>3<span class="main">)</span> Cons assms<span class="main">(</span>4<span class="main">)</span> fB fA fE
        <span class="keyword1"><span class="command">have</span></span>  decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Ds</span> <span class="main">=</span> <span class="skolem">Hs</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Fs</span>"</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">B</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="skolem">Hs</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> folding.gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">#</span><span class="skolem">Hs</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
              gallery_remdup_adj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">#</span><span class="free">f</span><span class="main">⊨</span><span class="skolem">Hs</span>"</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊨</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> decomp<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="main">(</span><span class="skolem">Hs</span><span class="main">@</span><span class="skolem">A</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">Ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> decomp<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_image_subset"><span class="command">lemma</span></span> chamber_image_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≡</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">closerToC</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">B</span></span><span class="main">∈</span>𝒞<span class="main">.</span> chamber_distance <span class="bound">B</span> <span class="free">C</span> <span class="main">&lt;</span> chamber_distance <span class="bound">B</span> <span class="free">D</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⊆</span> <span class="free">closerToC</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span>𝒞"</span></span> <span class="keyword1"><span class="command">using</span></span> folding.chamber_system_into <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="free">closerToC</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">=</span><span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> B D closerToC_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B' chamber_distance_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ds</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Ds</span><span class="main">.</span> gallery <span class="main">(</span><span class="skolem">B</span><span class="main">#</span><span class="bound">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B C D False closerToC_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_system_def folding.chamber_map gallery_least_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
            chamber_image_closer<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">Ds</span></span><span class="main">]</span>
            chamber_distance_le chamber_distance_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-gallery_double_cross_not_minimal_Cons1"><span class="command">lemma</span></span> gallery_double_cross_not_minimal_Cons1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">B</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">¬</span> min_gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> galleryD_adj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">#</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
        adjacent_half_chamber_system_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
        folding.gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">#</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
        gallery_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">#</span> <span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
        is_arg_minD2<span class="main">[</span><span class="operator">of</span> <span class="quoted">length</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">Ds</span><span class="main">.</span> maxsimpchain <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="bound">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span>"</span></span><span class="main">]</span>
        min_maxsimpchain.simps<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="free">Cs</span>"</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> folding.chamber_retraction2<span class="main">)</span><span class="main">(</span><span class="operator">meson</span> impossible_Cons not_less<span class="main">)</span>

<span class="keyword1" id="Chamber-gallery_double_cross_not_minimal1"><span class="command">lemma</span></span> gallery_double_cross_not_minimal1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">B</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="free">Bs</span><span class="main">@</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">¬</span> min_gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="free">Bs</span><span class="main">@</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Bs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> gallery_double_cross_not_minimal_Cons1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span><span class="main">@</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
            min_gallery_betw_CCons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span><span class="main">@</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span>"</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_chamber_system
            gallery_double_cross_not_minimal_Cons1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span><span class="main">@</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* ThinishChamberComplexFolding *)</span>

<span class="keyword1"><span class="command">locale</span></span> ThinChamberComplexFolding <span class="main">=</span>
  ThinChamberComplex <span class="quoted"><span class="free">X</span></span> <span class="main">+</span> folding<span class="main">:</span> ChamberComplexFolding <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ThinChamberComplexFolding <span class="main">&lt;</span> ThinishChamberComplexFolding <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexFolding
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flop</span> <span class="main">≡</span> folding.flop"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> adjacent_half_chamber_system_image <span class="main">=</span> adjacent_half_chamber_system_image
<span class="keyword1"><span class="command">lemmas</span></span> gallery_double_cross_not_minimal1  <span class="main">=</span> gallery_double_cross_not_minimal1
<span class="keyword1"><span class="command">lemmas</span></span> gallery_double_cross_not_minimal_Cons1 <span class="main">=</span>
  gallery_double_cross_not_minimal_Cons1

<span class="keyword1" id="Chamber-adjacent_preimage"><span class="command">lemma</span></span> adjacent_preimage<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span> <span class="main">∼</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">=</span><span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> chambers <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.inj_on_opp_chambers''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> adjacent_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> chambers <span class="keyword1"><span class="command">have</span></span> CD<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> ch_fCD<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def folding.chamber_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> adjacent <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">⊲</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>1<span class="main">)</span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">⊲</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def folding.inj_on_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          inj_on_pullback_facet<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> the_adj_chamber <span class="free">C</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> CD<span class="main">(</span>1<span class="main">)</span> y<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">⊲</span><span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">≠</span><span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_adj_chamber the_adj_chamber_facet the_adj_chamber_neq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">≠</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> chamber_system_def folding.inj_on_opp_chambers''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> fB_fC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> folding.chamber_retraction2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>1<span class="main">)</span> y<span class="main">(</span>2<span class="main">)</span> B<span class="main">(</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facetrel_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> chamber_system_def chamberD_simplex face_im
              folding.simplex_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> chambers y<span class="main">(</span>1<span class="main">)</span> z<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> CD<span class="main">(</span>1<span class="main">)</span> ch_fCD<span class="main">(</span>2<span class="main">)</span> B facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>2<span class="main">)</span> chambers fB_fC False <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> folding.chamber_retraction2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> False z y<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fB_fD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ch_fCD B<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> folding.chamber_map folding.facet_map
          facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> B<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_system_def fB_fD folding.inj_on_opp_chambers'' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> fB_fD <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> folding.chamber_retraction2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> z<span class="main">(</span>1<span class="main">)</span> y<span class="main">(</span>2<span class="main">)</span> B<span class="main">(</span>2<span class="main">)</span> chambers<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> facetrel_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> chamber_system_def chamberD_simplex face_im
            folding.simplex_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> CD y<span class="main">(</span>1<span class="main">)</span> B ch_fCD<span class="main">(</span>1<span class="main">)</span> z<span class="main">(</span>1<span class="main">)</span> False chambers<span class="main">(</span>1<span class="main">)</span>
            facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> y<span class="main">(</span>1<span class="main">)</span> B<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> adjacentI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-adjacent_opp_chamber"><span class="command">lemma</span></span> adjacent_opp_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">C</span><span class="main">∼</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> opp_chamber <span class="free">C</span> <span class="main">∼</span> opp_chamber <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> folding.opp_chamberD1 folding.opp_chamberD2 adjacent_preimage <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-adjacentchain_preimage"><span class="command">lemma</span></span> adjacentchain_preimage<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> adjacentchain <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span> adjacentchain <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_preimage <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-gallery_preimage"><span class="command">lemma</span></span> gallery_preimage<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> gallery <span class="main">(</span><span class="free">f</span><span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span> gallery <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> galleryD_adj adjacentchain_preimage chamber_system_def gallery_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Chamber-chambercomplex_opp_half_apartment"><span class="command">lemma</span></span> chambercomplex_opp_half_apartment<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex folding.Y"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> folding.simplicialcomplex_opp_half_apartment<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> folding.Y"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="skolem">Y</span>"</span></span> 
  <span class="keyword1"><span class="command">with</span></span> Y_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">⊆</span><span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.opp_half_apartment_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Y_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> SimplicialComplex.maxsimp <span class="skolem">Y</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">⊆</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.subcomplex_opp_half_apartment
          folding.opp_chambers_subset_opp_half_apartment
          chamber_system_def max_in_subcomplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> folding.Y"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="skolem">D</span>
  <span class="keyword3"><span class="command">assume</span></span> CD<span class="main">:</span>  <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="skolem">Y</span> <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="skolem">Y</span> <span class="skolem">D</span>"</span></span>
              <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">≠</span><span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> CD<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Y_def <span class="keyword1"><span class="command">have</span></span> CD'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.maxsimp_in_opp_half_apartment <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> CD<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ds</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="skolem">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.inj_on_opp_chambers''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span> chamber_system_def
          folding.maxsimp_map_into_image folding.chambercomplex_image
          ChamberComplex.maxsimp_connect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="skolem">D</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> map opp_chamber <span class="skolem">Ds</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> Ds <span class="keyword1"><span class="command">have</span></span> Ds'<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="skolem">C</span><span class="main">)</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="skolem">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.chambersubcomplex_image subcomplex_gallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> Ds <span class="keyword1"><span class="command">have</span></span> Ds''<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Ds</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.chambercomplex_image folding.chamber_system_image
          ChamberComplex.galleryD_chamber ChamberComplex.chamberD_simplex
          gallery_chamber_system
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">Cs</span> <span class="main">⊆</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> set <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cs_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span>set <span class="skolem">Ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> opp_chamber <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Ds'' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword1"><span class="command">using</span></span> folding.opp_chamberD1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cs_def CD' Ds' Ds'' * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.f_opp_chamber_list gallery_preimage<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Cs</span><span class="main">.</span> SimplicialComplex.maxsimpchain <span class="skolem">Y</span> <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="bound">Cs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Y_def CD' folding.subcomplex_opp_half_apartment
          folding.opp_chambers_subset_opp_half_apartment
          maxsimpchain_in_subcomplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Y</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-flop_adj"><span class="command">lemma</span></span> flop_adj<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"flop <span class="free">C</span> <span class="main">∼</span> flop <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> both
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> adjacent_opp_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> one
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def adjacent_half_chamber_system_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          adjacent_half_chamber_system_image_reverse adjacent_sym
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> other
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def adjacent_sym<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          adjacent_half_chamber_system_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> 
          adjacent_half_chamber_system_image_reverse
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms folding.adj_map<span class="main">)</span>

<span class="keyword1" id="Chamber-flop_gallery"><span class="command">lemma</span></span> flop_gallery<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="free">Cs</span> <span class="main">⟹</span> gallery <span class="main">(</span>map flop <span class="free">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>flop <span class="skolem">B</span> <span class="main">#</span> <span class="main">(</span>flop <span class="skolem">C</span><span class="main">)</span> <span class="main">#</span> map flop <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> gallery_CConsI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>flop <span class="skolem">B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> galleryD_chamber folding.flop_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>flop <span class="skolem">C</span> <span class="main">#</span> map flop <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce<span class="main">[</span><span class="operator">OF</span> CCons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flop <span class="skolem">B</span> <span class="main">∼</span> flop <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> galleryD_chamber galleryD_adj flop_adj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> galleryD_chamber folding.flop_chamber gallery_def<span class="main">)</span>

<span class="keyword1" id="Chamber-morphism_half_apartments"><span class="command">lemma</span></span> morphism_half_apartments<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism folding.Y <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="free">f</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexMorphism.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chambercomplex_opp_half_apartment<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> folding.chambercomplex_image<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span>
<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> SimplicialComplex.maxsimp folding.Y <span class="bound">C</span> <span class="main">⟹</span>
      SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="bound">C</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span><span class="main">.</span> SimplicialComplex.maxsimp folding.Y <span class="bound">C</span> <span class="main">⟹</span> card <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="bound">C</span><span class="main">)</span> <span class="main">=</span> card <span class="bound">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.chamber_in_opp_half_apartment folding.chamber_map
          folding.chambersubcomplex_image chamber_in_subcomplex
          chamberD_simplex folding.dim_map
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_image_complement_closer"><span class="command">lemma</span></span> chamber_image_complement_closer<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">B</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">B</span><span class="main">≠</span><span class="free">D</span><span class="main">;</span> gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">f</span><span class="main">`</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">Ds</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">B</span><span class="main">#</span><span class="bound">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">∧</span> length <span class="bound">Ds</span> <span class="main">&lt;</span> length <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flop_gallery chamber_image_closer<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"map flop <span class="free">Cs</span>"</span></span><span class="main">]</span>
        folding.opp_chamber_reverse folding.inj_on_opp_chambers''<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Chamber-chamber_image_complement_subset"><span class="command">lemma</span></span> chamber_image_complement_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≡</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">closerToD</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">B</span></span><span class="main">∈</span>𝒞<span class="main">.</span> chamber_distance <span class="bound">B</span> <span class="free">D</span> <span class="main">&lt;</span> chamber_distance <span class="bound">B</span> <span class="free">C</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⊆</span> <span class="free">closerToD</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="free">closerToD</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">=</span><span class="free">D</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> B C closerToD_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_distance_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> gallery <span class="main">(</span><span class="skolem">B</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> B C D False closerToD_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_system_def folding.chamber_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
            gallery_least_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> chamber_distance_le
            chamber_image_complement_closer<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">]</span>
            chamber_distance_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_image_and_complement"><span class="command">lemma</span></span> chamber_image_and_complement<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≡</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">closerToC</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">B</span></span><span class="main">∈</span>𝒞<span class="main">.</span> chamber_distance <span class="bound">B</span> <span class="free">C</span> <span class="main">&lt;</span> chamber_distance <span class="bound">B</span> <span class="free">D</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">closerToD</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">B</span></span><span class="main">∈</span>𝒞<span class="main">.</span> chamber_distance <span class="bound">B</span> <span class="free">D</span> <span class="main">&lt;</span> chamber_distance <span class="bound">B</span> <span class="free">C</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">closerToC</span>"</span></span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">closerToD</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> closerToC_def closerToD_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">closerToC</span> <span class="main">∩</span> <span class="free">closerToD</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> C D closerToC_def closerToD_def
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝒞 <span class="main">=</span> <span class="free">f</span> <span class="main">⊢</span> 𝒞 <span class="main">∪</span> <span class="main">(</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">closerToC</span> <span class="main">⊆</span> 𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">closerToD</span> <span class="main">⊆</span> 𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding.chamber_system_into
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⊆</span> <span class="free">closerToC</span>"</span></span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⊆</span> <span class="free">closerToD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_image_subset chamber_image_complement_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">closerToC</span>"</span></span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">closerToD</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_decomp_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒞</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">]</span> set_decomp_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒞</span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexFolding *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Pairs of opposed foldings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A pair of foldings of a thin chamber complex are opposed or opposite if there is a corresponding
  pair of adjacent chambers, where each folding sends its corresponding chamber to the other
  chamber.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> OpposedThinChamberComplexFoldings <span class="main">=</span>
  ThinChamberComplex <span class="quoted"><span class="free">X</span></span>
<span class="main">+</span> folding_f<span class="main">:</span> ChamberComplexFolding <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span>
<span class="main">+</span> folding_g<span class="main">:</span> ChamberComplexFolding <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">g</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∼</span><span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">≠</span><span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">g</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">D0</span> <span class="main">≡</span> <span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> chamber_D0 <span class="main">=</span> folding_g.chamber_map<span class="main">[</span><span class="operator">OF</span> chambers<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>

<span class="keyword1" id="Chamber-ThinChamberComplexFolding_f"><span class="command">lemma</span></span> ThinChamberComplexFolding_f<span class="main">:</span> <span class="quoted"><span class="quoted">"ThinChamberComplexFolding <span class="free">X</span> <span class="free">f</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1" id="Chamber-ThinChamberComplexFolding_g"><span class="command">lemma</span></span> ThinChamberComplexFolding_g<span class="main">:</span> <span class="quoted"><span class="quoted">"ThinChamberComplexFolding <span class="free">X</span> <span class="free">g</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> foldf <span class="main">=</span> ThinChamberComplexFolding_f
<span class="keyword1"><span class="command">lemmas</span></span> foldg <span class="main">=</span> ThinChamberComplexFolding_g

<span class="keyword1" id="Chamber-fg_symmetric"><span class="command">lemma</span></span> fg_symmetric<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">g</span> <span class="free">f</span> D0"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>2-4<span class="main">)</span> chamber_D0 adjacent_sym <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-basechambers_half_chamber_systems"><span class="command">lemma</span></span> basechambers_half_chamber_systems<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"D0<span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> chamber_D0 chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> basech_halfchsys <span class="main">=</span>
  basechambers_half_chamber_systems

<span class="keyword1" id="Chamber-f_trivial_C0"><span class="command">lemma</span></span> f_trivial_C0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C0</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>4<span class="main">)</span> chamber_D0 chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted">D0</span><span class="main">]</span>
        folding_f.vertex_retraction
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> g_trivial_D0 <span class="main">=</span>
  OpposedThinChamberComplexFoldings.f_trivial_C0<span class="main">[</span><span class="operator">OF</span> fg_symmetric<span class="main">]</span>

<span class="keyword1" id="Chamber-double_fold_D0"><span class="command">lemma</span></span> double_fold_D0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> D0 <span class="main">-</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms chambers<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"D0 <span class="main">=</span> insert <span class="free">v</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_sym adjacent_conv_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span>D0 <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">=</span> <span class="free">C0</span><span class="main">∩</span>D0"</span></span> <span class="keyword1"><span class="command">using</span></span> f_trivial_C0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">=</span> <span class="free">C0</span><span class="main">∩</span>D0"</span></span>
    <span class="keyword1"><span class="command">using</span></span> g_trivial_D0 fixespointwise_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted">D0</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span>D0"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D0 <span class="main">=</span> insert <span class="main">(</span><span class="free">g</span> <span class="main">(</span><span class="free">f</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> double_fold_C0 <span class="main">=</span>
  OpposedThinChamberComplexFoldings.double_fold_D0<span class="main">[</span><span class="operator">OF</span> fg_symmetric<span class="main">]</span>

<span class="keyword1" id="Chamber-flopped_half_chamber_systems_fg"><span class="command">lemma</span></span> flopped_half_chamber_systems_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"D0<span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def chamber_D0 folding_f.chamber_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted">D0</span><span class="main">]</span>
          folding_g.chamber_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> ThinChamberComplexFolding.chamber_image_and_complement<span class="main">[</span>
            <span class="operator">OF</span> ThinChamberComplexFolding_g<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C0</span></span></span></span>
          <span class="main">]</span>
          ThinChamberComplexFolding.chamber_image_and_complement<span class="main">[</span>
            <span class="operator">OF</span> ThinChamberComplexFolding_f<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">D0</span></span>
          <span class="main">]</span>
          adjacent_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted">D0</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> flopped_half_chamber_systems_gf <span class="main">=</span>
  OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_fg<span class="main">[</span>
    <span class="operator">OF</span> fg_symmetric
  <span class="main">]</span>

<span class="keyword1" id="Chamber-flopped_half_apartments_fg"><span class="command">lemma</span></span> flopped_half_apartments_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"folding_f.opp_half_apartment <span class="main">=</span> <span class="free">g</span><span class="main">⊢</span><span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> folding_f.Y"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">⊆</span><span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding_f.opp_half_apartment_def flopped_half_chamber_systems_fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices
          ChamberComplex.faces<span class="main">[</span><span class="operator">OF</span> folding_g.chambercomplex_image<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span> <span class="keyword3"><span class="command">assume</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span><span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">⊆</span> <span class="free">g</span><span class="main">`</span><span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_in_max chamber_system_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> C<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="skolem">C</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="skolem">C</span> <span class="main">∈</span> 𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword1"><span class="command">using</span></span> flopped_half_chamber_systems_fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> C<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">.</span> <span class="skolem">b</span><span class="main">⊆</span><span class="bound">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> folding_g.simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> folding_f.Y"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> folding_f.opp_half_apartment_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> flopped_half_apartments_gf <span class="main">=</span>
  OpposedThinChamberComplexFoldings.flopped_half_apartments_fg<span class="main">[</span>
    <span class="operator">OF</span> fg_symmetric
  <span class="main">]</span>

<span class="keyword1" id="Chamber-vertex_set_split"><span class="command">lemma</span></span> vertex_set_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">X</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">f</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">g</span></span><span class="antiquote">}</span></span> will both be the identity on the intersection›</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">X</span> <span class="main">⊇</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding_f.simplex_map folding_g.simplex_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">X</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> C<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∨</span> <span class="skolem">C</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_system_def flopped_half_chamber_systems_fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> C<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="main">(</span><span class="free">f</span><span class="main">`</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="free">g</span><span class="main">`</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-half_chamber_system_disjoint_union"><span class="command">lemma</span></span> half_chamber_system_disjoint_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝒞 <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∪</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">∩</span> <span class="main">(</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> folding_f.chamber_system_into
        flopped_half_chamber_systems_fg<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> halfchsys_decomp <span class="main">=</span>
  half_chamber_system_disjoint_union

<span class="keyword1" id="Chamber-chamber_in_other_half_fg"><span class="command">lemma</span></span> chamber_in_other_half_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">∉</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">C</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_def half_chamber_system_disjoint_union<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Chamber-adjacent_half_chamber_system_image_fg"><span class="command">lemma</span></span> adjacent_half_chamber_system_image_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">C</span><span class="main">∼</span><span class="free">D</span> <span class="main">⟹</span> <span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ThinChamberComplexFolding.adjacent_half_chamber_system_image<span class="main">[</span>
          <span class="operator">OF</span> ThinChamberComplexFolding_f
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> flopped_half_chamber_systems_fg<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> adjacent_half_chamber_system_image_gf <span class="main">=</span>
  OpposedThinChamberComplexFoldings.adjacent_half_chamber_system_image_fg<span class="main">[</span>
    <span class="operator">OF</span> fg_symmetric
  <span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> adjhalfchsys_image_gf <span class="main">=</span>
  adjacent_half_chamber_system_image_gf

<span class="keyword1" id="Chamber-switch_basechamber"><span class="command">lemma</span></span> switch_basechamber<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span>𝒞<span class="main">-</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword1"><span class="command">using</span></span> flopped_half_chamber_systems_gf <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def adjacent_half_chamber_system_image_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Chamber-unique_half_chamber_system_f"><span class="command">lemma</span></span> unique_half_chamber_system_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> D0"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f'</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g'</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> OpposedThinChamberComplexFoldings.intro<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">X</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"ThinChamberComplex <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">X</span> <span class="free">g'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> chambers
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings_axioms <span class="free">X</span> <span class="free">f</span> <span class="free">g'</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">f'</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">⊆</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span><span class="main">⊆</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="skolem">a</span> <span class="main">=</span> 𝒞<span class="main">-</span><span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span>
          ChamberComplexFolding.chamber_system_into<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">]</span>
          ChamberComplexFolding.chamber_system_into<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f'</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_fg<span class="main">[</span>
            <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          <span class="main">]</span>
          OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_fg<span class="main">[</span>
            <span class="operator">OF</span> 1
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> a_def b_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-unique_half_chamber_system_g"><span class="command">lemma</span></span> unique_half_chamber_system_g<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">C0</span> <span class="main">⟹</span> <span class="free">g'</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> D0 <span class="main">⟹</span>
    <span class="free">g'</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unique_half_chamber_system_f flopped_half_chamber_systems_fg
        OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_fg<span class="main">[</span>
          <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">g'</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Chamber-split_gallery_fg"><span class="command">lemma</span></span> split_gallery_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">;</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">As</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Bs</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">B</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="bound">A</span><span class="main">#</span><span class="bound">B</span><span class="main">#</span><span class="bound">Bs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> folding_f.split_gallery flopped_half_chamber_systems_fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> split_gallery_gf <span class="main">=</span>
  OpposedThinChamberComplexFoldings.split_gallery_fg<span class="main">[</span><span class="operator">OF</span> fg_symmetric<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OpposedThinChamberComplexFoldings *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The automorphism induced by a pair of opposed foldings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Recall that a folding of a chamber complex is a special kind of chamber complex retraction, and
  so is the identity on its image. Hence a pair of opposed foldings will be the identity on the
  intersection of their images and so we can stitch them together to create an automorphism of the
  chamber complex, by allowing each folding to act on the complement of its image.
  This automorphism will be of order two, and will be the unique automorphism of the chamber
  complex that fixes pointwise the facet shared by the pair of adjacent chambers associated to the
  opposed foldings.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> OpposedThinChamberComplexFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">induced_automorphism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_automorphism</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span>
          <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">g</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">∈</span><span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="keyword1">then</span> <span class="free">f</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>
<span class="comment1">― ‹<span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">f</span></span><span class="antiquote">}</span></span> and <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted"><span class="free">g</span></span><span class="antiquote">}</span></span> will both be the identity on the intersection of their images›</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗌</span> <span class="main">≡</span> induced_automorphism"</span></span>

<span class="keyword1" id="Chamber-induced_automorphism_fg_symmetric"><span class="command">lemma</span></span> induced_automorphism_fg_symmetric<span class="main">:</span>
  <span class="quoted"><span class="quoted">"𝗌 <span class="main">=</span> OpposedThinChamberComplexFoldings.𝗌 <span class="free">X</span> <span class="free">g</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        folding_f.vertex_retraction folding_g.vertex_retraction
        induced_automorphism_def
        OpposedThinChamberComplexFoldings.induced_automorphism_def<span class="main"><span class="main">[</span></span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main"><span class="main">]</span></span>
      <span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_on_simplices_fg"><span class="command">lemma</span></span> induced_automorphism_on_simplices_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span> <span class="main">⟹</span> <span class="free">v</span><span class="main">∈</span><span class="free">x</span> <span class="main">⟹</span> 𝗌 <span class="free">v</span> <span class="main">=</span> <span class="free">g</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-induced_automorphism_eq_foldings_on_chambers_fg"><span class="command">lemma</span></span> induced_automorphism_eq_foldings_on_chambers_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> fun_eq_on 𝗌 <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices induced_automorphism_on_simplices_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_onI<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_eq_foldch_fg <span class="main">=</span>
  induced_automorphism_eq_foldings_on_chambers_fg

<span class="keyword1" id="Chamber-induced_automorphism_eq_foldings_on_chambers_gf"><span class="command">lemma</span></span> induced_automorphism_eq_foldings_on_chambers_gf<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> fun_eq_on 𝗌 <span class="free">f</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        OpposedThinChamberComplexFoldings.indaut_eq_foldch_fg<span class="main"><span class="main">[</span></span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main"><span class="main">]</span></span>
        induced_automorphism_fg_symmetric
      <span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_on_chamber_vertices_f"><span class="command">lemma</span></span> induced_automorphism_on_chamber_vertices_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">v</span><span class="main">∈</span><span class="free">C</span> <span class="main">⟹</span> 𝗌 <span class="free">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="keyword1">then</span> <span class="free">g</span> <span class="free">v</span> <span class="keyword1">else</span> <span class="free">f</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_def induced_automorphism_eq_foldings_on_chambers_fg
        induced_automorphism_eq_foldings_on_chambers_gf
        flopped_half_chamber_systems_fg<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
        fun_eq_onD<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> fun_eq_onD<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-induced_automorphism_simplex_image"><span class="command">lemma</span></span> induced_automorphism_simplex_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">x</span><span class="main">⊆</span><span class="free">C</span> <span class="main">⟹</span> 𝗌<span class="main">`</span><span class="free">x</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">x</span><span class="main">⊆</span><span class="free">C</span> <span class="main">⟹</span> 𝗌<span class="main">`</span><span class="free">x</span> <span class="main">=</span> <span class="free">f</span><span class="main">`</span><span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_im<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> fun_eq_on_im<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
        induced_automorphism_eq_foldings_on_chambers_fg
        induced_automorphism_eq_foldings_on_chambers_gf
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-induced_automorphism_chamber_list_image_fg"><span class="command">lemma</span></span> induced_automorphism_chamber_list_image_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> 𝗌<span class="main">⊨</span><span class="free">Cs</span> <span class="main">=</span> <span class="free">g</span><span class="main">⊨</span><span class="free">Cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_automorphism_simplex_image<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-induced_automorphism_chamber_image_fg"><span class="command">lemma</span></span> induced_automorphism_chamber_image_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> 𝗌<span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="keyword1">then</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="keyword1">else</span> <span class="free">f</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_system_def induced_automorphism_simplex_image
        flopped_half_chamber_systems_fg<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-induced_automorphism_C0"><span class="command">lemma</span></span> induced_automorphism_C0<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">`</span><span class="free">C0</span> <span class="main">=</span> D0"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> basechambers_half_chamber_systems<span class="main">(</span>1<span class="main">)</span>
        induced_automorphism_chamber_image_fg
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-induced_automorphism_fixespointwise_C0_int_D0"><span class="command">lemma</span></span> induced_automorphism_fixespointwise_C0_int_D0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fixespointwise 𝗌 <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fun_eq_on_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span> fun_eq_on_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
        fixespointwise_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted">D0</span><span class="main">]</span>
        induced_automorphism_eq_foldings_on_chambers_fg
        basechambers_half_chamber_systems
        folding_g.chamber_retraction1 
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_fixes_fundfacet <span class="main">=</span>
  induced_automorphism_fixespointwise_C0_int_D0

<span class="keyword1" id="Chamber-induced_automorphism_adjacent_half_chamber_system_image_fg"><span class="command">lemma</span></span> induced_automorphism_adjacent_half_chamber_system_image_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">;</span> <span class="free">C</span><span class="main">∼</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span> 𝗌<span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adjacent_half_chamber_system_image_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
        induced_automorphism_simplex_image<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_adj_halfchsys_im_fg <span class="main">=</span>
  induced_automorphism_adjacent_half_chamber_system_image_fg

<span class="keyword1" id="Chamber-induced_automorphism_chamber_map"><span class="command">lemma</span></span> induced_automorphism_chamber_map<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> chamber <span class="main">(</span>𝗌<span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_chamber_image_fg folding_f.chamber_map
        folding_g.chamber_map
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_chmap <span class="main">=</span> induced_automorphism_chamber_map

<span class="keyword1" id="Chamber-induced_automorphism_ntrivial"><span class="command">lemma</span></span> induced_automorphism_ntrivial<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌 <span class="main">≠</span> id"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 𝗌<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌 <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∉</span> D0"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_int_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted">D0</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>4<span class="main">)</span> 𝗌 v<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> gv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamberD_simplex<span class="main">[</span><span class="operator">OF</span> chamber_D0<span class="main">]</span>
          induced_automorphism_on_simplices_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>2<span class="main">)</span> gv <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">C0</span> <span class="main">⟹</span> <span class="bound">x</span><span class="main">∈</span><span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> g_trivial_D0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y<span class="main">(</span>1<span class="main">)</span> v<span class="main">(</span>2<span class="main">)</span> gv <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> g_trivial_D0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">=</span><span class="skolem">v</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-induced_automorphism_bij_between_half_chamber_systems_f"><span class="command">lemma</span></span> induced_automorphism_bij_between_half_chamber_systems_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> 𝗌<span class="main">)</span> <span class="main">(</span>𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_simplex_image<span class="main">(</span>2<span class="main">)</span>
        flopped_half_chamber_systems_fg
        folding_f.opp_chambers_bij bij_betw_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"𝒞<span class="main">-</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(`)</span> 𝗌"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_bij_btw_halfchsys_f <span class="main">=</span>
  induced_automorphism_bij_between_half_chamber_systems_f

<span class="keyword1" id="Chamber-induced_automorphism_bij_between_half_chamber_systems_g"><span class="command">lemma</span></span> induced_automorphism_bij_between_half_chamber_systems_g<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> 𝗌<span class="main">)</span> <span class="main">(</span>𝒞<span class="main">-</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">(</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_fg_symmetric
        OpposedThinChamberComplexFoldings.indaut_bij_btw_halfchsys_f<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Chamber-induced_automorphism_halfmorphism_fopp_to_fimage"><span class="command">lemma</span></span> induced_automorphism_halfmorphism_fopp_to_fimage<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexMorphism folding_f.opp_half_apartment <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> 𝗌"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexMorphism.cong<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> ThinChamberComplexFolding.morphism_half_apartments<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> ThinChamberComplexFolding_f<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fun_eq_onI
<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">⋃</span>folding_f.Y <span class="main">⟹</span> 𝗌 <span class="bound">v</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding_f.opp_half_apartment_def chamber_system_simplices
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            flopped_half_chamber_systems_fg
            induced_automorphism_fg_symmetric
            OpposedThinChamberComplexFoldings.induced_automorphism_def<span class="main"><span class="main">[</span></span>
              <span class="operator">OF</span> fg_symmetric
            <span class="main"><span class="main">]</span></span>
          <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_halfmorph_fopp_fim <span class="main">=</span>
  induced_automorphism_halfmorphism_fopp_to_fimage

<span class="keyword1" id="Chamber-induced_automorphism_half_chamber_system_gallery_map_f"><span class="command">lemma</span></span> induced_automorphism_half_chamber_system_gallery_map_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> gallery <span class="free">Cs</span> <span class="main">⟹</span> gallery <span class="main">(</span>𝗌<span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> folding_g.gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">]</span>
        induced_automorphism_chamber_list_image_fg<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-induced_automorphism_half_chamber_system_pgallery_map_f"><span class="command">lemma</span></span> induced_automorphism_half_chamber_system_pgallery_map_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> pgallery <span class="free">Cs</span> <span class="main">⟹</span> pgallery <span class="main">(</span>𝗌<span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_half_chamber_system_gallery_map_f pgallery
        flopped_half_chamber_systems_gf pgalleryD_distinct
        folding_g.opp_chambers_distinct_map
        induced_automorphism_chamber_list_image_fg<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pgalleryI_gallery<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_halfchsys_pgal_map_f <span class="main">=</span>
  induced_automorphism_half_chamber_system_pgallery_map_f

<span class="keyword1" id="Chamber-induced_automorphism_half_chamber_system_pgallery_map_g"><span class="command">lemma</span></span> induced_automorphism_half_chamber_system_pgallery_map_g<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">Cs</span> <span class="main">⊆</span> <span class="free">g</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> pgallery <span class="free">Cs</span> <span class="main">⟹</span> pgallery <span class="main">(</span>𝗌<span class="main">⊨</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_fg_symmetric
        OpposedThinChamberComplexFoldings.indaut_halfchsys_pgal_map_f<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Chamber-induced_automorphism_halfmorphism_fimage_to_fopp"><span class="command">lemma</span></span> induced_automorphism_halfmorphism_fimage_to_fopp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> folding_f.opp_half_apartment 𝗌"</span></span>
  <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.indaut_halfmorph_fopp_fim<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          flopped_half_apartments_gf flopped_half_apartments_fg
          induced_automorphism_fg_symmetric
        <span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_selfcomp_halfmorphism_f"><span class="command">lemma</span></span> induced_automorphism_selfcomp_halfmorphism_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_halfmorphism_fimage_to_fopp
        induced_automorphism_halfmorphism_fopp_to_fimage
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ChamberComplexMorphism.comp<span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_selfcomp_halftrivial_f"><span class="command">lemma</span></span> induced_automorphism_selfcomp_halftrivial_f<span class="main">:</span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> standard_uniqueness<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ChamberComplexMorphism.expand_codomain<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> induced_automorphism_selfcomp_halfmorphism_f
<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="free">X</span> id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding_f.chambersubcomplex_image inclusion_morphism <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> chamberD_simplex<span class="main">[</span><span class="operator">OF</span> chamber_D0<span class="main">]</span>
          chamber_in_subcomplex<span class="main">[</span><span class="operator">OF</span> folding_f.chambersubcomplex_image<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fixespointwiseI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chamber_D0 chamberD_simplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌 <span class="skolem">v</span> <span class="main">=</span> <span class="free">g</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> induced_automorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> id <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span>D0"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> v <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 g_trivial_D0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> v chambers<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗌 <span class="main">(</span><span class="free">g</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chamberD_simplex induced_automorphism_fg_symmetric
              OpposedThinChamberComplexFoldings.induced_automorphism_def<span class="main">[</span>
                <span class="operator">OF</span> fg_symmetric<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="skolem">v</span>"</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
      <span class="keyword1"><span class="command">with</span></span> v False chambers<span class="main">(</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> double_fold_C0 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="main">(</span><span class="free">f</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_gallery_pgallery folding_f.chambercomplex_image
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> pCs<span class="main">:</span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> folding_f.chambersubcomplex_image subcomplex_pgallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span>id<span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> set_Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cs pCs folding_f.chambersubcomplex_image
          ChamberSubcomplexD_complex ChamberComplex.pgalleryD_chamber
          ChamberComplex.chamberD_simplex pgallery_chamber_system
          folding_f.chamber_system_image
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span>𝗌<span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pCs induced_automorphism_half_chamber_system_pgallery_map_f<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>𝗌<span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>𝗌<span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> 𝗌<span class="main">⊢</span><span class="main">(</span>𝒞<span class="main">-</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_Cs flopped_half_chamber_systems_gf <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_surj_on<span class="main">[</span>
              <span class="operator">OF</span> induced_automorphism_bij_between_half_chamber_systems_g
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span>𝗌<span class="main">⊨</span><span class="main">(</span>𝗌<span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_automorphism_half_chamber_system_pgallery_map_g<span class="main">[</span>
            <span class="operator">of</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span>"</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span><span class="main">⊨</span><span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ssubst<span class="main">[</span><span class="operator">OF</span> setlistmapim_comp<span class="main">,</span> <span class="operator">of</span> <span class="quoted">pgallery</span><span class="main">,</span> <span class="operator">of</span> <span class="quoted">𝗌</span> <span class="quoted">𝗌</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> folding_f.chambersubcomplex_image<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_selfcomp_halftriv_f <span class="main">=</span>
  induced_automorphism_selfcomp_halftrivial_f

<span class="keyword1" id="Chamber-induced_automorphism_selfcomp_halftrivial_g"><span class="command">lemma</span></span> induced_automorphism_selfcomp_halftrivial_g<span class="main">:</span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">g</span><span class="main">⊢</span><span class="free">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_fg_symmetric
        OpposedThinChamberComplexFoldings.indaut_selfcomp_halftriv_f<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Chamber-induced_automorphism_trivial_outside"><span class="command">lemma</span></span> induced_automorphism_trivial_outside<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∉</span><span class="main">⋃</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"𝗌 <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∉</span> <span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> vertex_set_split <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"𝗌 <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> induced_automorphism_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-induced_automorphism_morphism"><span class="command">lemma</span></span> induced_automorphism_morphism<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> 𝗌"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> induced_automorphism_chamber_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>𝗌<span class="main">`</span><span class="skolem">C</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_automorphism_chamber_image_fg folding_f.dim_map
          folding_g.dim_map
          flopped_half_chamber_systems_fg<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> induced_automorphism_trivial_outside<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_morph <span class="main">=</span> induced_automorphism_morphism

<span class="keyword1" id="Chamber-induced_automorphism_morphism_order2"><span class="command">lemma</span></span> induced_automorphism_morphism_order2<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">∘</span>𝗌 <span class="main">=</span> id"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> id <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">f</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">g</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> both
    <span class="keyword1"><span class="command">from</span></span> both<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> induced_automorphism_selfcomp_halftrivial_f fixespointwiseD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">∘</span>𝗌"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> one <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> induced_automorphism_selfcomp_halftrivial_f fixespointwiseD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">∘</span>𝗌"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> other <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> induced_automorphism_selfcomp_halftrivial_g fixespointwiseD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">∘</span>𝗌"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> induced_automorphism_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_order2 <span class="main">=</span> induced_automorphism_morphism_order2

<span class="keyword1"><span class="command">lemmas</span></span> induced_automorphism_bij <span class="main">=</span>
  o_bij<span class="main">[</span><span class="operator">OF</span>
    induced_automorphism_morphism_order2
    induced_automorphism_morphism_order2
  <span class="main">]</span>

<span class="keyword1" id="Chamber-induced_automorphism_surj_on_vertexset"><span class="command">lemma</span></span> induced_automorphism_surj_on_vertexset<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝗌<span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">⋃</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_automorphism_morphism
          ChamberComplexEndomorphism.vertex_map
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>𝗌<span class="main">∘</span>𝗌<span class="main">)</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> 𝗌<span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">X</span> <span class="main">⊆</span> 𝗌<span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> induced_automorphism_morphism_order2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-induced_automorphism_bij_betw_vertexset"><span class="command">lemma</span></span> induced_automorphism_bij_betw_vertexset<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw 𝗌 <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_bij induced_automorphism_surj_on_vertexset 
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> bij_betw_subset<span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_surj_on_simplices"><span class="command">lemma</span></span> induced_automorphism_surj_on_simplices<span class="main">:</span> <span class="quoted"><span class="quoted">"𝗌<span class="main">⊢</span><span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝗌<span class="main">⊢</span><span class="free">X</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_automorphism_morphism
          ChamberComplexEndomorphism.simplex_map
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"𝗌<span class="main">⊢</span><span class="main">(</span>𝗌<span class="main">⊢</span><span class="free">X</span><span class="main">)</span> <span class="main">⊆</span> 𝗌<span class="main">⊢</span><span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> 𝗌<span class="main">⊢</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          setsetmapim_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> induced_automorphism_morphism_order2
        <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-induced_automorphism_automorphism"><span class="command">lemma</span></span> induced_automorphism_automorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> 𝗌"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_chamber_map
        ChamberComplexEndomorphism.dim_map
        induced_automorphism_morphism
        induced_automorphism_bij_betw_vertexset
        induced_automorphism_surj_on_simplices
        induced_automorphism_trivial_outside
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_aut <span class="main">=</span> induced_automorphism_automorphism

<span class="keyword1" id="Chamber-induced_automorphism_unique_automorphism'"><span class="command">lemma</span></span> induced_automorphism_unique_automorphism'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplexAutomorphism <span class="free">X</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span>id"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">s</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">s</span> 𝗌 <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_on_subset_and_diff_imp_eq_on<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">s</span> 𝗌 <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_automorphism_fixespointwise_C0_int_D0
          fixespointwise2_imp_eq_on
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">s</span> 𝗌 <span class="main">(</span><span class="free">C0</span> <span class="main">-</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">C0</span> <span class="main">-</span> <span class="free">C0</span><span class="main">∩</span>D0"</span></span>
    <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> C0_insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_conv_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"𝗌<span class="main">`</span><span class="free">C0</span> <span class="main">=</span> insert <span class="main">(</span>𝗌 <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span>𝗌<span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  insert<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> insert <span class="main">(</span><span class="free">s</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"D0 <span class="main">=</span> insert <span class="main">(</span>𝗌 <span class="skolem">v</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> basechambers_half_chamber_systems
            induced_automorphism_fixespointwise_C0_int_D0
            induced_automorphism_simplex_image<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixespointwise_im<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> C0D0_C0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">⊲</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_int_facet1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">⊲</span> <span class="free">s</span><span class="main">`</span><span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexAutomorphism.facet_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> C0D0_sC0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">⊲</span> <span class="free">s</span><span class="main">`</span><span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixespointwise_im<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> sv_nin_C0D0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">v</span> <span class="main">∉</span> <span class="free">C0</span><span class="main">∩</span>D0"</span></span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>1<span class="main">)</span> facetrel_psubset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span><span class="free">s</span><span class="main">`</span><span class="free">C0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexAutomorphism.chamber_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> chambers<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> C0D0_D0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">⊲</span> D0"</span></span>
      <span class="keyword1"><span class="command">using</span></span> adjacent_sym adjacent_int_facet1 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span> <span class="main">∨</span> <span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> D0"</span></span>
      <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> chamber_D0 C0D0_C0 C0D0_sC0
            facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span>D0"</span></span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted">D0</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">assume</span></span> sC0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> id"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
        <span class="operator">rule</span> standard_uniqueness_automorphs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> trivial_automorphism<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chambers<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> fixespointwise_subset_and_diff_imp_eq_on<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> Int_lower1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fixespointwiseI
      <span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="free">C0</span><span class="main">-</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C0_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">with</span></span> sC0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">a</span> <span class="main">=</span> id <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> C0_insert sv_nin_C0D0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> sC0_D0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> D0"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗌 <span class="skolem">v</span> <span class="main">∉</span> <span class="free">C0</span><span class="main">∩</span>D0"</span></span> <span class="keyword1"><span class="command">using</span></span> insert<span class="main">(</span>2<span class="main">)</span> C0D0_D0 facetrel_psubset <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="skolem">v</span> <span class="main">=</span> 𝗌 <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert sC0_D0 sv_nin_C0D0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-induced_automorphism_unique_automorphism"><span class="command">lemma</span></span> induced_automorphism_unique_automorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> ChamberComplexAutomorphism <span class="free">X</span> <span class="free">s</span><span class="main">;</span> <span class="free">s</span><span class="main">≠</span>id<span class="main">;</span> fixespointwise <span class="free">s</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span>D0<span class="main">)</span> <span class="main">⟧</span>
    <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> 𝗌"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">)</span> induced_automorphism_unique_automorphism'
        standard_uniqueness_automorphs induced_automorphism_automorphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_uniq_aut <span class="main">=</span>
  induced_automorphism_unique_automorphism

<span class="keyword1" id="Chamber-induced_automorphism_unique"><span class="command">lemma</span></span> induced_automorphism_unique<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">C0</span> <span class="main">⟹</span> <span class="free">g'</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">C0</span> <span class="main">⟹</span>
    OpposedThinChamberComplexFoldings.induced_automorphism <span class="free">X</span> <span class="free">f'</span> <span class="free">g'</span> <span class="main">=</span> 𝗌"</span></span>
  <span class="keyword1"><span class="command">using</span></span> induced_automorphism_automorphism induced_automorphism_ntrivial
        induced_automorphism_fixespointwise_C0_int_D0
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>
          OpposedThinChamberComplexFoldings.indaut_uniq_aut<span class="main"><span class="main">[</span></span>
            <span class="operator">THEN</span> sym
          <span class="main"><span class="main">]</span></span>
        <span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_sym"><span class="command">lemma</span></span> induced_automorphism_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings.induced_automorphism <span class="free">X</span> <span class="free">g</span> <span class="free">f</span> <span class="main">=</span> 𝗌"</span></span>
  <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.indaut_aut<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
        OpposedThinChamberComplexFoldings.induced_automorphism_ntrivial<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
        OpposedThinChamberComplexFoldings.indaut_fixes_fundfacet<span class="main">[</span>
          <span class="operator">OF</span> fg_symmetric
        <span class="main">]</span>
        induced_automorphism_unique_automorphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chambers<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> Int_commute<span class="main">)</span>

<span class="keyword1" id="Chamber-induced_automorphism_respects_labels"><span class="command">lemma</span></span> induced_automorphism_respects_labels<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">B</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="main">(</span>𝗌 <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          induced_automorphism_on_chamber_vertices_f folding_f.respects_labels
          folding_g.respects_labels
        <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_resplabels <span class="main">=</span>
  induced_automorphism_respects_labels

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OpposedThinChamberComplexFoldings *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Walls›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A pair of opposed foldings of a thin chamber complex defines a decomposition of the chamber
  system into the two disjoint chamber system images. Call such a decomposition a wall, as we image
  that disjointness erects a wall between the two half chamber systems. By considering the
  collection of all possible opposed folding pairs, and their associated walls, we can obtain
  information about minimality of galleries by considering the walls they cross.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">foldpairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">foldpairs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">.</span> <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">C</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">walls</span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>foldpairs<span class="main">.</span> <span class="main">{</span><span class="main">{</span><span class="bound">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="bound">g</span><span class="main">⊢</span>𝒞<span class="main">}</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_wall_betw</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span>
              THE_default <span class="main">{}</span> <span class="main">(</span><span class="main">λ</span><span class="bound">H</span><span class="main">.</span> <span class="bound">H</span><span class="main">∈</span>walls <span class="main">∧</span> separated_by <span class="bound">H</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">walls_betw</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set set set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">walls_betw</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">H</span></span><span class="main">∈</span>walls<span class="main">.</span> separated_by <span class="bound">H</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wall_crossings</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set list <span class="main">⇒</span> <span class="tfree">'a</span> set set set list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">wall_crossings</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span>     <span class="quoted"><span class="quoted">"<span class="free">wall_crossings</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="main">|</span>     <span class="quoted"><span class="quoted">"<span class="free">wall_crossings</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span> <span class="main">=</span> the_wall_betw <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">#</span> <span class="free">wall_crossings</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">#</span><span class="free"><span class="bound"><span class="entity">Cs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Chamber-foldpairs_sym"><span class="command">lemma</span></span> foldpairs_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>foldpairs <span class="main">⟹</span> <span class="main">(</span><span class="free">g</span><span class="main">,</span><span class="free">f</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldpairs_def OpposedThinChamberComplexFoldings.fg_symmetric <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-not_self_separated_by_wall"><span class="command">lemma</span></span> not_self_separated_by_wall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>walls <span class="main">⟹</span> <span class="main">¬</span> separated_by <span class="free">H</span> <span class="free">C</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldpairs_def OpposedThinChamberComplexFoldings.halfchsys_decomp<span class="main">(</span>2<span class="main">)</span>
        not_self_separated_by_disjoint
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Chamber-the_wall_betw_nempty"><span class="command">lemma</span></span> the_wall_betw_nempty<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">D</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">D</span> <span class="main">∈</span> walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="main">(</span>the_wall_betw <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">H'</span></span><span class="main">∈</span>walls<span class="main">.</span> separated_by <span class="bound">H'</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> THE_default_none<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">H</span><span class="main">.</span> <span class="bound">H</span><span class="main">∈</span>walls <span class="main">∧</span> separated_by <span class="bound">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">D</span> <span class="main">∈</span> walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="main">(</span>the_wall_betw <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> THE_defaultI'<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-the_wall_betw_self_empty"><span class="command">lemma</span></span> the_wall_betw_self_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">C</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">C</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_wall_betw_nempty<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> the_wall_betw_nempty<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> foldpairs_def
            OpposedThinChamberComplexFoldings.halfchsys_decomp<span class="main">(</span>2<span class="main">)</span><span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span>
            <span class="main">]</span>
            not_self_separated_by_disjoint<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-length_wall_crossings"><span class="command">lemma</span></span> length_wall_crossings<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> length <span class="free">Cs</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-wall_crossings_snoc"><span class="command">lemma</span></span> wall_crossings_snoc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wall_crossings <span class="main">(</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">,</span><span class="free">E</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> wall_crossings <span class="main">(</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>the_wall_betw <span class="free">D</span> <span class="free">E</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-wall_crossings_are_walls"><span class="command">lemma</span></span> wall_crossings_are_walls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">H</span><span class="main">≠</span><span class="main">{}</span> <span class="main">⟹</span> <span class="free">H</span><span class="main">∈</span>walls"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">H</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">B</span> <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> the_wall_betw_nempty<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-in_set_wall_crossings_decomp"><span class="command">lemma</span></span> in_set_wall_crossings_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">As</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Bs</span><span class="main">.</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="main">[</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">]</span><span class="main">@</span><span class="bound">Bs</span> <span class="main">∧</span> <span class="free">H</span> <span class="main">=</span> the_wall_betw <span class="bound">A</span> <span class="bound">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">C</span> <span class="skolem">D</span> <span class="skolem">Ds</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">∈</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">D</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> CCons<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="main">(</span><span class="skolem">D</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">As</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> the_wall_betw <span class="skolem">A</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="main">(</span><span class="skolem">D</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">)</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">D</span><span class="main">]</span><span class="main">@</span><span class="skolem">Ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> the_wall_betw <span class="skolem">C</span> <span class="skolem">D</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplex *)</span>

<span class="keyword1"><span class="command">context</span></span> OpposedThinChamberComplexFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-foldpair"><span class="command">lemma</span></span> foldpair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> foldpairs_def
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span> <span class="free">g</span><span class="main">)</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">.</span>
          <span class="main">∃</span><span class="bound">C</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">C</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-separated_by_this_wall_fg"><span class="command">lemma</span></span> separated_by_this_wall_fg<span class="main">:</span>
  <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="free">C</span> <span class="free">D</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> separated_by_disjoint<span class="main">[</span>
          <span class="operator">OF</span> _ half_chamber_system_disjoint_union<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> separated_by_this_wall_gf <span class="main">=</span>
  OpposedThinChamberComplexFoldings.separated_by_this_wall_fg<span class="main">[</span>
    <span class="operator">OF</span> fg_symmetric
  <span class="main">]</span>

<span class="keyword1" id="Chamber-induced_automorphism_this_wall_vertex"><span class="command">lemma</span></span> induced_automorphism_this_wall_vertex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"𝗌 <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"𝗌 <span class="free">v</span> <span class="main">=</span> <span class="free">g</span> <span class="free">v</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices induced_automorphism_on_simplices_fg
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"𝗌 <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_simplices folding_g.retraction <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> indaut_wallvertex <span class="main">=</span>
  induced_automorphism_this_wall_vertex

<span class="keyword1" id="Chamber-unique_wall"><span class="command">lemma</span></span> unique_wall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> opp'    <span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">C'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">f'</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span><span class="free">g'</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∼</span><span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">f'</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g'</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> chambers <span class="keyword1"><span class="command">have</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span><span class="free">g</span><span class="main">`</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">=</span><span class="free">g'</span><span class="main">`</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> adjacent_half_chamber_system_image_gf
          OpposedThinChamberComplexFoldings.adjhalfchsys_image_gf<span class="main">[</span>
            <span class="operator">OF</span> opp'
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  A <span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="free">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   A'<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f'</span> <span class="free">g'</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> switch_basechamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.switch_basechamber<span class="main">[</span>
            <span class="operator">OF</span> opp'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.unique_half_chamber_system_f<span class="main">[</span>
            <span class="operator">OF</span> A A'
          <span class="main">]</span>
          OpposedThinChamberComplexFoldings.unique_half_chamber_system_g<span class="main">[</span>
            <span class="operator">OF</span> A A'
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OpposedThinChamberComplexFoldings *)</span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-separated_by_wall_ex_foldpair"><span class="command">lemma</span></span> separated_by_wall_ex_foldpair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="free">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>foldpairs<span class="main">.</span> <span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="bound">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">∧</span> <span class="free">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">D</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> fg assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldpairs_def
            OpposedThinChamberComplexFoldings.separated_by_this_wall_fg<span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="main">_</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> fg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> foldpairs_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> separated_by_in_other<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-not_separated_by_wall_ex_foldpair"><span class="command">lemma</span></span> not_separated_by_wall_ex_foldpair<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     wall    <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>walls"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> separated_by <span class="free">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>foldpairs<span class="main">.</span> <span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="bound">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">∧</span> <span class="free">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="free">D</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> wall<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> chambers <span class="keyword1"><span class="command">have</span></span> chambers'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞 <span class="main">∨</span> <span class="free">C</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞 <span class="main">∨</span> <span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_system_def
          OpposedThinChamberComplexFoldings.halfchsys_decomp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span>
            <span class="operator">OF</span> A
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> chambers'<span class="main">(</span>2<span class="main">)</span> fg<span class="main">(</span>2<span class="main">)</span> wall<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> chambers'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> chambers'<span class="main">(</span>2<span class="main">)</span> fg<span class="main">(</span>2<span class="main">)</span> wall<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> insert_commute<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> fg foldpairs_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-adj_wall_imp_ex1_wall"><span class="command">lemma</span></span> adj_wall_imp_ex1_wall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> adj <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     wall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H0</span><span class="main">∈</span>walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="free">H0</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">H</span></span><span class="main">∈</span>walls<span class="main">.</span> separated_by <span class="bound">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex1I<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wall<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wall<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">∈</span>walls <span class="main">∧</span> separated_by <span class="skolem">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">=</span><span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> separated_by_wall_ex_foldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wall <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f0</span></span> <span class="skolem"><span class="skolem">g0</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> f0g0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f0</span><span class="main">,</span><span class="skolem">g0</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H0</span><span class="main">=</span><span class="main">{</span><span class="skolem">f0</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g0</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f0</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g0</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> separated_by_wall_ex_foldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H0</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>1<span class="main">)</span> f0g0<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">A0</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span>  <span class="skolem">g</span>  <span class="skolem">A</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   A0<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f0</span> <span class="skolem">g0</span> <span class="skolem">A0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>2-4<span class="main">)</span> f0g0<span class="main">(</span>2-4<span class="main">)</span> adj <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="free">H0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.unique_wall<span class="main">[</span><span class="operator">OF</span> A0 A<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplex *)</span>

<span class="keyword1"><span class="command">context</span></span> OpposedThinChamberComplexFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-this_wall_betwI"><span class="command">lemma</span></span> this_wall_betwI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C</span> <span class="free">D</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> THE_default1_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> adj_wall_imp_ex1_wall<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span><span class="main">∈</span>walls"</span></span> <span class="keyword1"><span class="command">using</span></span> foldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span><span class="main">∈</span>walls <span class="main">∧</span> separated_by <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="free">C</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Chamber-this_wall_betw_basechambers"><span class="command">lemma</span></span> this_wall_betw_basechambers<span class="main">:</span>
  <span class="quoted"><span class="quoted">"the_wall_betw <span class="free">C0</span> D0 <span class="main">=</span> <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> basechambers_half_chamber_systems chambers<span class="main">(</span>2<span class="main">)</span> this_wall_betwI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-this_wall_in_crossingsI_fg"><span class="command">lemma</span></span> this_wall_in_crossingsI_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">≡</span> <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">H</span> <span class="main">∈</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">from</span></span> Nil<span class="main">(</span>1<span class="main">)</span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="free">H</span> <span class="skolem">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpair <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> galleryD_adj<span class="main">[</span><span class="operator">OF</span> Nil<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          THE_default1_equality<span class="main">[</span><span class="operator">OF</span> adj_wall_imp_ex1_wall<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">B</span> <span class="skolem">Bs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> H <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="free">H</span> <span class="skolem">C</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> galleryD_chamber<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> chamber_in_other_half_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span> foldpair
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> galleryD_adj<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
            THE_default1_equality<span class="main">[</span><span class="operator">OF</span> adj_wall_imp_ex1_wall<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OpposedThinChamberComplexFoldings *)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ThinChamberComplex<span class="main">)</span> walls_betw_subset_wall_crossings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"walls_betw <span class="free">C</span> <span class="free">D</span> <span class="main">⊆</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> walls_betw <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">∈</span>walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="skolem">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> walls_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> separated_by_wall_ex_foldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">Z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms H<span class="main">(</span>2<span class="main">)</span> fg<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.this_wall_in_crossingsI_fg<span class="main">[</span><span class="operator">OF</span> Z<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> OpposedThinChamberComplexFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-same_side_this_wall_wall_crossings_not_distinct_f"><span class="command">lemma</span></span> same_side_this_wall_wall_crossings_not_distinct_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">C</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span> <span class="free">D</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span>
    <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">¬</span> distinct <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">=</span> the_wall_betw <span class="skolem">C</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="skolem">C</span> <span class="free">D</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Nil<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> the_wall_betw_nempty<span class="main">(</span>2<span class="main">)</span> separated_by_this_wall_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          half_chamber_system_disjoint_union<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">C</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">E</span> <span class="main">#</span> <span class="skolem">Es</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
      <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">∈</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases
    <span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> both <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> one
      <span class="keyword1"><span class="command">from</span></span> one<span class="main">(</span>2<span class="main">)</span> Cons<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">=</span> the_wall_betw <span class="skolem">C</span> <span class="skolem">E</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"the_wall_betw <span class="skolem">C</span> <span class="skolem">E</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> one<span class="main">(</span>1<span class="main">)</span> the_wall_betw_nempty<span class="main">(</span>2<span class="main">)</span>
              separated_by_this_wall_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">E</span></span><span class="main">]</span>
              half_chamber_system_disjoint_union<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> other <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> 1 galleryD_chamber<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> galleryD_adj<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> 
              chamber_in_other_half_fg this_wall_betwI
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> neither
      <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> neither<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
        <span class="keyword1"><span class="command">using</span></span> galleryD_chamber chamber_in_other_half_fg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="skolem">E</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="main">∈</span> walls_betw <span class="skolem">E</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> foldpair walls_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> neither<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> walls_betw_subset_wall_crossings
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sside_wcrossings_ndistinct_f <span class="main">=</span>
  same_side_this_wall_wall_crossings_not_distinct_f

<span class="keyword1" id="Chamber-separated_by_this_wall_chain3_fg"><span class="command">lemma</span></span> separated_by_this_wall_chain3_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span>
          <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="free">B</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms separated_by_this_wall_fg separated_by_this_wall_gf
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> sepwall_chain3_fg <span class="main">=</span>
  separated_by_this_wall_chain3_fg

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context OpposedThinChamberComplexFoldings *)</span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-wall_crossings_min_gallery_betwI"><span class="command">lemma</span></span> wall_crossings_min_gallery_betwI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> separated_by <span class="bound">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> min_galleryI_betw<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> BBs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> snoc_conv_cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> the_wall_betw <span class="free">C</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> BBs assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"separated_by <span class="skolem">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">=</span><span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> H_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> walls"</span></span> <span class="keyword1"><span class="command">using</span></span> the_wall_betw_nempty<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 separated_by_wall_ex_foldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> foldpairs_def 
            OpposedThinChamberComplexFoldings.halfchsys_decomp<span class="main">(</span>2<span class="main">)</span><span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Ds</span> <span class="keyword3"><span class="command">assume</span></span> Ds<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="skolem">Ds</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span>walls_betw <span class="free">C</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> walls_betw <span class="free">C</span> <span class="free">D</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span>     separated_by_not_empty wall_crossings_are_walls<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span>"</span></span><span class="main">]</span>
                walls_betw_def
                walls_betw_subset_wall_crossings<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def
      <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> distinct_card<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span> length_wall_crossings <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>walls_betw <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>length <span class="skolem">Ds</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> Ds <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>walls_betw <span class="free">C</span> <span class="free">D</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span>set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> walls_betw_subset_wall_crossings finite_set card_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> length <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> card_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> length_wall_crossings <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">Cs</span> <span class="main">≤</span> length <span class="skolem">Ds</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Chamber-ex_nonseparating_wall_imp_wall_crossings_not_distinct"><span class="command">lemma</span></span> ex_nonseparating_wall_imp_wall_crossings_not_distinct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> gal <span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     wall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="main">¬</span> separated_by <span class="free">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">H</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wall_crossings_are_walls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
          not_separated_by_wall_ex_foldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">H</span></span><span class="main">]</span>
          galleryD_chamber
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">Z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> wall fg<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.sside_wcrossings_ndistinct_f <span class="main">[</span>
            <span class="operator">OF</span> Z gal
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-not_min_gallery_double_crosses_wall"><span class="command">lemma</span></span> not_min_gallery_double_crosses_wall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"gallery <span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> min_gallery <span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> Single <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> galleryD_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">B</span> <span class="skolem">Bs</span> <span class="skolem">C</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">=</span><span class="skolem">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Bs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> True Cons_snoc assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> the_wall_betw_self_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> the_wall_betw <span class="skolem">B</span> <span class="skolem">E</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> Cons_snoc * <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cons_snoc Cons True H_def
              the_wall_betw_nempty<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">E</span></span><span class="main">]</span> not_self_separated_by_wall<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
              ex_nonseparating_wall_imp_wall_crossings_not_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">Bs</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">H</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> assms Cons_snoc
      <span class="keyword1"><span class="command">have</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span> <span class="main">∨</span>
              <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span><span class="main">.</span> separated_by <span class="bound">H</span> <span class="skolem">B</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wall_crossings_min_gallery_betwI
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="bound">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span><span class="main">.</span> separated_by <span class="bound">H</span> <span class="skolem">B</span> <span class="skolem">C</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">H</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> separated_by <span class="skolem">H</span> <span class="skolem">B</span> <span class="skolem">C</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> H<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cons_snoc
              ex_nonseparating_wall_imp_wall_crossings_not_distinct
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-not_distinct_crossings_split_gallery"><span class="command">lemma</span></span> not_distinct_crossings_split_gallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> gallery <span class="free">Cs</span><span class="main">;</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span><span class="main">;</span> <span class="main">¬</span> distinct <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">As</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Bs</span> <span class="bound">E</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>foldpairs <span class="main">∧</span> <span class="bound">A</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">B</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">E</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">F</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span>
      <span class="main">(</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="main">[</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">,</span><span class="bound">F</span><span class="main">]</span><span class="main">@</span><span class="bound">Fs</span> <span class="main">∨</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="main">[</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">]</span><span class="main">@</span><span class="bound">Bs</span><span class="main">@</span><span class="main">[</span><span class="bound">E</span><span class="main">,</span><span class="bound">F</span><span class="main">]</span><span class="main">@</span><span class="bound">Fs</span> <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>CCons <span class="skolem">C</span> <span class="skolem">J</span> <span class="skolem">Js</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> split<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span> <span class="main">∨</span> <span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> CCons<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
    <span class="keyword1"><span class="command">from</span></span> split<span class="main">(</span>6<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">As</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span> <span class="main">∨</span>
              <span class="skolem">C</span><span class="main">#</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">As</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>   <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> split<span class="main">(</span>1-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> the_wall_betw <span class="skolem">C</span> <span class="skolem">J</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> True CCons<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">∈</span>set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> split1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> the_wall_betw <span class="skolem">E</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> in_set_wall_crossings_decomp
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> H_def split1<span class="main">(</span>2<span class="main">)</span> CCons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  Hwall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> walls"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="skolem">H</span> <span class="skolem">C</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="skolem">H</span> <span class="skolem">E</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_wall_betw_nempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">C</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">J</span></span></span></span><span class="main">]</span> the_wall_betw_nempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">E</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">F</span></span></span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> Hwall<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">=</span><span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> separated_by_wall_ex_foldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">H</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">J</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Z</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">Z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> foldpairs_def
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Bs</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> CCons<span class="main">(</span>2<span class="main">)</span> Hwall<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> fg<span class="main">(</span>2-4<span class="main">)</span> split1<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">J</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> galleryD_chamber 
              OpposedThinChamberComplexFoldings.sepwall_chain3_fg<span class="main">(</span>2<span class="main">)</span><span class="main">[</span>
                <span class="operator">OF</span> Z<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">F</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> fg<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">K</span> <span class="skolem">Ks</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Bs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Bs</span> <span class="main">=</span> <span class="skolem">K</span><span class="main">#</span><span class="skolem">Ks</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">from</span></span> CCons<span class="main">(</span>2<span class="main">)</span> split1<span class="main">(</span>1<span class="main">)</span> Bs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Ks</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> gallery_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">#</span><span class="skolem">Ks</span><span class="main">@</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">F</span><span class="main">#</span><span class="skolem">Fs</span>"</span></span><span class="main">]</span>
                gallery_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">#</span><span class="skolem">Ks</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">#</span><span class="skolem">Fs</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> fg<span class="main">(</span>4<span class="main">)</span> True <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ls</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="skolem"><span class="skolem">M</span></span> <span class="skolem"><span class="skolem">Ms</span></span>
          <span class="keyword2"><span class="keyword">where</span></span> LsLMMs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">M</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">#</span><span class="skolem">Ks</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">Ls</span><span class="main">@</span><span class="skolem">L</span><span class="main">#</span><span class="skolem">M</span><span class="main">#</span><span class="skolem">Ms</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.split_gallery_gf<span class="main">[</span>
                  <span class="operator">OF</span> Z<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="skolem">Ks</span></span>
                <span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Ls</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> Nil
          <span class="keyword1"><span class="command">with</span></span> split1<span class="main">(</span>1<span class="main">)</span> Bs LsLMMs<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">J</span><span class="main">,</span><span class="skolem">M</span><span class="main">]</span><span class="main">@</span><span class="main">(</span><span class="skolem">Ms</span><span class="main">@</span><span class="skolem">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span>   <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> fg<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> LsLMMs<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">N</span> <span class="skolem">Ns</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> split1<span class="main">(</span>1<span class="main">)</span> Bs LsLMMs<span class="main">(</span>3<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">J</span><span class="main">]</span><span class="main">@</span><span class="skolem">Ns</span><span class="main">@</span><span class="main">[</span><span class="skolem">L</span><span class="main">,</span><span class="skolem">M</span><span class="main">]</span><span class="main">@</span><span class="main">(</span><span class="skolem">Ms</span><span class="main">@</span><span class="skolem">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span>   <span class="operator">simp</span>
          <span class="keyword1"><span class="command">with</span></span> fg<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> LsLMMs<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> Hwall<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> fg<span class="main">(</span>2<span class="main">)</span> split1<span class="main">(</span>1<span class="main">)</span> Cons
          <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">J</span><span class="main">#</span><span class="skolem">Js</span> <span class="main">=</span> <span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">,</span><span class="skolem">J</span><span class="main">]</span><span class="main">@</span><span class="skolem">Ks</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.separated_by_this_wall_fg<span class="main">[</span>
                  <span class="operator">OF</span> Z
                <span class="main">]</span>
                separated_by_in_other<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> fg<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-not_min_gallery_double_split"><span class="command">lemma</span></span> not_min_gallery_double_split<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> gallery <span class="free">Cs</span><span class="main">;</span> <span class="main">¬</span> min_gallery <span class="free">Cs</span><span class="main">;</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>wall_crossings <span class="free">Cs</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">As</span> <span class="bound">A</span> <span class="bound">B</span> <span class="bound">Bs</span> <span class="bound">E</span> <span class="bound">F</span> <span class="bound">Fs</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>foldpairs <span class="main">∧</span> <span class="bound">A</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">B</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">E</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span> <span class="bound">F</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span>
      <span class="main">(</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="main">[</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">,</span><span class="bound">F</span><span class="main">]</span><span class="main">@</span><span class="bound">Fs</span> <span class="main">∨</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="main">[</span><span class="bound">A</span><span class="main">,</span><span class="bound">B</span><span class="main">]</span><span class="main">@</span><span class="bound">Bs</span><span class="main">@</span><span class="main">[</span><span class="bound">E</span><span class="main">,</span><span class="bound">F</span><span class="main">]</span><span class="main">@</span><span class="bound">Fs</span> <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> not_min_gallery_double_crosses_wall not_distinct_crossings_split_gallery
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplex *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Thin chamber complexes with many foldings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we begin to examine thin chamber complexes in which every pair of adjacent chambers affords a
  pair of opposed foldings of the complex. This condition will ultimately be shown to be sufficient
  to ensure that a thin chamber complex is isomorphic to some Coxeter complex.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ThinChamberComplexManyFoldings <span class="main">=</span> ThinChamberComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>   <span class="free">X</span>  <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">C0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fundchamber<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     ex_walls   <span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">C</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">C</span><span class="main">∼</span><span class="free">D</span><span class="main">;</span> <span class="free">C</span><span class="main">≠</span><span class="free">D</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="bound">f</span> <span class="bound">g</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">D</span><span class="main">=</span><span class="bound">g</span><span class="main">`</span><span class="free">C</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ThinChamberComplex<span class="main">)</span> ThinChamberComplexManyFoldingsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> <span class="main">⟦</span> chamber <span class="bound">C</span><span class="main">;</span> chamber <span class="bound">D</span><span class="main">;</span> <span class="bound">C</span><span class="main">∼</span><span class="bound">D</span><span class="main">;</span> <span class="bound">C</span><span class="main">≠</span><span class="bound">D</span> <span class="main">⟧</span> <span class="main">⟹</span>
            <span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">C</span> <span class="main">∧</span> <span class="bound">D</span><span class="main">=</span><span class="bound">g</span><span class="main">`</span><span class="bound">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ThinChamberComplexManyFoldings <span class="free">X</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">fast</span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> ThinChamberComplexManyFoldings<span class="main">)</span> wall_crossings_subset_walls_betw<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> walls_betw <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">H</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> set <span class="main">(</span>wall_crossings <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">=</span>the_wall_betw <span class="skolem">A</span> <span class="skolem">B</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> in_set_wall_crossings_decomp
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> pgal<span class="main">:</span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> min_gallery_pgallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> H<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">=</span><span class="skolem">g</span><span class="main">`</span><span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pgalleryD_chamber pgalleryD_adj
          binrelchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted">adjacent</span> <span class="quoted"><span class="skolem">As</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span>"</span></span><span class="main">]</span>
          pgalleryD_distinct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span>"</span></span><span class="main">]</span> ex_walls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> H<span class="main">(</span>2<span class="main">)</span> fg <span class="keyword1"><span class="command">have</span></span> H'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span><span class="main">∈</span>walls"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.basech_halfchsys<span class="main">[</span>
            <span class="operator">OF</span> fg<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span>
          <span class="main">]</span>
          OpposedThinChamberComplexFoldings.chambers<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.this_wall_betwI<span class="main">[</span><span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          foldpairs_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> CD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞 <span class="main">∪</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞 <span class="main">∪</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pgal pgalleryD_chamber chamber_system_def
          OpposedThinChamberComplexFoldings.halfchsys_decomp<span class="main">(</span>1<span class="main">)</span><span class="main">[</span>
            <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">∈</span> walls_betw <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Bs</span></span> <span class="quoted"><span class="skolem">As</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons'<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> both_Nil <span class="keyword1"><span class="command">with</span></span> H <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>3<span class="main">)</span> the_wall_betw_nempty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">A</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">B</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> walls_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil1 <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> Nil1 H<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="skolem">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> walls_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms Nil1 H<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.foldg<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              CD<span class="main">(</span>1<span class="main">)</span> H'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> pgal pgallery
              OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_gf<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              ThinChamberComplexFolding.gallery_double_cross_not_minimal1<span class="main">[</span>
                <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Nil2 <span class="skolem">Fs</span> <span class="skolem">F</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> assms Nil2 H<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.foldf<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              H'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> pgal pgallery
              OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_fg<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              ThinChamberComplexFolding.gallery_double_cross_not_minimal_Cons1<span class="main">[</span>
                <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">f</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> Nil2 H<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="skolem">H</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> CD<span class="main">(</span>2<span class="main">)</span> H'<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> walls_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_Cons <span class="skolem">Fs</span> <span class="skolem">F</span> <span class="skolem">E</span> <span class="skolem">Es</span><span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> both <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> walls_betw_def <span class="keyword1"><span class="command">unfolding</span></span> separated_by_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> one
      <span class="keyword1"><span class="command">with</span></span> snoc_Cons assms H<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.foldf<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              CD<span class="main">(</span>2<span class="main">)</span> H'<span class="main">(</span>2<span class="main">)</span> pgal pgallery
              OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_fg<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              ThinChamberComplexFolding.gallery_double_cross_not_minimal1<span class="main">[</span>
                <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">]</span>"</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> other
      <span class="keyword1"><span class="command">with</span></span> snoc_Cons assms H<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.ThinChamberComplexFolding_g<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              CD<span class="main">(</span>1<span class="main">)</span> H'<span class="main">(</span>1<span class="main">)</span> pgal pgallery
              OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_gf<span class="main">[</span>
                <span class="operator">OF</span> fg<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              <span class="main">]</span>
              ThinChamberComplexFolding.gallery_double_cross_not_minimal1<span class="main">[</span>
                <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">#</span><span class="skolem">Fs</span>"</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> neither
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"separated_by <span class="main">{</span><span class="skolem">g</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="skolem">f</span><span class="main">⊢</span>𝒞<span class="main">}</span> <span class="free">C</span> <span class="free">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> CD <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> separated_byI<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> H'<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> walls_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The group of automorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Recall that a pair of opposed foldings of a thin chamber complex can be stitched together to form
  an automorphism of the complex. Choosing an arbitrary chamber in the complex to act as a sort of
  centre of the complex (referred to as the fundamental chamber), we consider the group (under
  composition) generated by the automorphisms afforded by the chambers adjacent to the fundamental
  chamber via the pairs of opposed foldings that we have assumed to exist.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fundfoldpairs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span><span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fundfoldpairs</span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="bound">f</span> <span class="bound">g</span> <span class="free">C0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fundadjset</span> <span class="main">≡</span> adjacentset <span class="free">C0</span> <span class="main">-</span> <span class="main">{</span><span class="free">C0</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">induced_automorph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_automorph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span>
          OpposedThinChamberComplexFoldings.induced_automorphism <span class="free">X</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">Abs_induced_automorph</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> permutation"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Abs_induced_automorph</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> Abs_permutation <span class="main">(</span>induced_automorph <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="main">{</span>Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">≡</span> <span class="main">⟨</span>S<span class="main">⟩</span>"</span></span>

<span class="keyword1" id="Chamber-fundfoldpairs_induced_autormorph_bij"><span class="command">lemma</span></span> fundfoldpairs_induced_autormorph_bij<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fundfoldpairs <span class="main">⟹</span> bij <span class="main">(</span>induced_automorph <span class="free">f</span> <span class="free">g</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     OpposedThinChamberComplexFoldings.induced_automorphism_bij
  <span class="keyword1"><span class="command">unfolding</span></span> fundfoldpairs_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> permutation_conv_induced_automorph <span class="main">=</span>
  Abs_permutation_inverse<span class="main">[</span><span class="operator">OF</span> CollectI<span class="main">,</span> <span class="operator">OF</span> fundfoldpairs_induced_autormorph_bij<span class="main">]</span>

<span class="keyword1" id="Chamber-fundfoldpairs_induced_autormorph_order2"><span class="command">lemma</span></span> fundfoldpairs_induced_autormorph_order2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fundfoldpairs <span class="main">⟹</span> induced_automorph <span class="free">f</span> <span class="free">g</span> <span class="main">∘</span> induced_automorph <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     OpposedThinChamberComplexFoldings.indaut_order2
  <span class="keyword1"><span class="command">unfolding</span></span> fundfoldpairs_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Chamber-fundfoldpairs_induced_autormorph_ntrivial"><span class="command">lemma</span></span> fundfoldpairs_induced_autormorph_ntrivial<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span> <span class="main">∈</span> fundfoldpairs <span class="main">⟹</span> induced_automorph <span class="free">f</span> <span class="free">g</span> <span class="main">≠</span> id"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     OpposedThinChamberComplexFoldings.induced_automorphism_ntrivial
  <span class="keyword1"><span class="command">unfolding</span></span> fundfoldpairs_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Chamber-fundfoldpairs_fundchamber_image"><span class="command">lemma</span></span> fundfoldpairs_fundchamber_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs <span class="main">⟹</span> Abs_induced_automorph <span class="free">f</span> <span class="free">g</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          permutation_conv_induced_automorph
          OpposedThinChamberComplexFoldings.induced_automorphism_C0
        <span class="main">)</span>

<span class="keyword1" id="Chamber-fundfoldpair_fundchamber_in_half_chamber_system_f"><span class="command">lemma</span></span> fundfoldpair_fundchamber_in_half_chamber_system_f<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs <span class="main">⟹</span> <span class="free">C0</span><span class="main">∈</span><span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
        OpposedThinChamberComplexFoldings.basech_halfchsys<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Chamber-fundfoldpair_unique_half_chamber_system_f"><span class="command">lemma</span></span> fundfoldpair_unique_half_chamber_system_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f'</span><span class="main">,</span><span class="free">g'</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span>
          <span class="quoted"><span class="quoted">"Abs_induced_automorph <span class="free">f'</span> <span class="free">g'</span> <span class="main">=</span> Abs_induced_automorph <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f'</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">g'</span><span class="main">`</span><span class="free">C0</span> <span class="main">=</span> <span class="free">g</span><span class="main">`</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_fundchamber_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          fundfoldpairs_fundchamber_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f'</span><span class="main">⊢</span>𝒞 <span class="main">=</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
          OpposedThinChamberComplexFoldings.unique_half_chamber_system_f<span class="main">[</span>
            <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="free">f'</span></span> <span class="quoted"><span class="free">g'</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundfoldpair_unique_half_chamber_systems_chamber_ng_f"><span class="command">lemma</span></span> fundfoldpair_unique_half_chamber_systems_chamber_ng_f<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f'</span><span class="main">,</span><span class="free">g'</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span>
          <span class="quoted"><span class="quoted">"Abs_induced_automorph <span class="free">f'</span> <span class="free">g'</span> <span class="main">=</span> Abs_induced_automorph <span class="free">f</span> <span class="free">g</span>"</span></span>
          <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∉</span><span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">f'</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3-5<span class="main">)</span> fundfoldpairs_def chamber_system_def
        OpposedThinChamberComplexFoldings.flopped_half_chamber_systems_gf<span class="main">[</span>
          <span class="operator">THEN</span> sym
        <span class="main">]</span>
        fundfoldpair_unique_half_chamber_system_f<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-the_wall_betw_adj_fundchamber"><span class="command">lemma</span></span> the_wall_betw_adj_fundchamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs <span class="main">⟹</span>
    the_wall_betw <span class="free">C0</span> <span class="main">(</span>Abs_induced_automorph <span class="free">f</span> <span class="free">g</span> <span class="main">`→</span> <span class="free">C0</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span><span class="main">⊢</span>𝒞<span class="main">,</span><span class="free">g</span><span class="main">⊢</span>𝒞<span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
        OpposedThinChamberComplexFoldings.this_wall_betw_basechambers
        OpposedThinChamberComplexFoldings.induced_automorphism_C0
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_conv_induced_automorph<span class="main">)</span>

<span class="keyword1" id="Chamber-zero_notin_S"><span class="command">lemma</span></span> zero_notin_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∉</span>S"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span>S"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">=</span> Abs_induced_automorph <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> Abs_permutation_inject<span class="main">[</span><span class="operator">of</span> <span class="quoted">id</span> <span class="quoted"><span class="quoted">"induced_automorph <span class="skolem">f</span> <span class="skolem">g</span>"</span></span><span class="main">]</span>
          bij_id fundfoldpairs_induced_autormorph_bij
          fundfoldpairs_induced_autormorph_ntrivial
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.abs_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-S_order2_add"><span class="command">lemma</span></span> S_order2_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">s</span> <span class="main">+</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_induced_autormorph_bij zero_permutation.abs_eq
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          plus_permutation_abs_eq fundfoldpairs_induced_autormorph_order2
        <span class="main">)</span>

<span class="keyword1" id="Chamber-S_add_order2"><span class="command">lemma</span></span> S_add_order2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"add_order <span class="free">s</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> add_order_equality<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+^</span><span class="numeral">2</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> S_order2_add <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nataction_2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+^</span><span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> zero_notin_S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">=</span><span class="main">1</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> S_uminus <span class="main">=</span> minus_unique<span class="main">[</span><span class="operator">OF</span> S_order2_add<span class="main">]</span>

<span class="keyword1" id="Chamber-S_sym"><span class="command">lemma</span></span> S_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"uminus <span class="main">`</span> S <span class="main">⊆</span> S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_uminus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> sum_list_S_in_W  <span class="main">=</span> sum_list_lists_in_genby_sym<span class="main">[</span><span class="operator">OF</span> S_sym<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> W_conv_sum_lists <span class="main">=</span> genby_sym_eq_sum_lists<span class="main">[</span><span class="operator">OF</span> S_sym<span class="main">]</span>

<span class="keyword1" id="Chamber-S_endomorphism"><span class="command">lemma</span></span> S_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>permutation <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
        OpposedThinChamberComplexFoldings.induced_automorphism_morphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_conv_induced_automorph<span class="main">)</span>

<span class="keyword1" id="Chamber-S_list_endomorphism"><span class="command">lemma</span></span> S_list_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists S <span class="main">⟹</span> ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>permutation <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        zero_permutation.rep_eq trivial_endomorphism plus_permutation.rep_eq
        S_endomorphism ChamberComplexEndomorphism.endo_comp
      <span class="main">)</span>

<span class="keyword1" id="Chamber-W_endomorphism"><span class="command">lemma</span></span> W_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>permutation <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> W_conv_sum_lists S_list_endomorphism <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-S_automorphism"><span class="command">lemma</span></span> S_automorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> ChamberComplexAutomorphism <span class="free">X</span> <span class="main">(</span>permutation <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
        OpposedThinChamberComplexFoldings.induced_automorphism_automorphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_conv_induced_automorph<span class="main">)</span>

<span class="keyword1" id="Chamber-S_list_automorphism"><span class="command">lemma</span></span> S_list_automorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists S <span class="main">⟹</span> ChamberComplexAutomorphism <span class="free">X</span> <span class="main">(</span>permutation <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        zero_permutation.rep_eq trivial_automorphism plus_permutation.rep_eq
        S_automorphism ChamberComplexAutomorphism.comp
      <span class="main">)</span>

<span class="keyword1" id="Chamber-W_automorphism"><span class="command">lemma</span></span> W_automorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> ChamberComplexAutomorphism <span class="free">X</span> <span class="main">(</span>permutation <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> W_conv_sum_lists S_list_automorphism <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-S_respects_labels"><span class="command">lemma</span></span> S_respects_labels<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> label_wrt <span class="free">B</span> <span class="free">φ</span><span class="main">;</span> <span class="free">s</span><span class="main">∈</span>S<span class="main">;</span> <span class="free">v</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">(</span><span class="free">s</span> <span class="main">→</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
        OpposedThinChamberComplexFoldings.indaut_resplabels<span class="main">[</span>
          <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">v</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_conv_induced_automorph<span class="main">)</span>

<span class="keyword1" id="Chamber-S_list_respects_labels"><span class="command">lemma</span></span> S_list_respects_labels<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> label_wrt <span class="free">B</span> <span class="free">φ</span><span class="main">;</span> <span class="free">ss</span><span class="main">∈</span>lists S<span class="main">;</span> <span class="free">v</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">(</span>sum_list <span class="free">ss</span> <span class="main">→</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_endomorphism ChamberComplexEndomorphism.vertex_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          plus_permutation.rep_eq S_respects_labels zero_permutation.rep_eq
        <span class="main">)</span>

<span class="keyword1" id="Chamber-W_respects_labels"><span class="command">lemma</span></span> W_respects_labels<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> label_wrt <span class="free">B</span> <span class="free">φ</span><span class="main">;</span> <span class="free">w</span><span class="main">∈</span>W<span class="main">;</span> <span class="free">v</span><span class="main">∈</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w</span><span class="main">→</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">φ</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> W_conv_sum_lists S_list_respects_labels<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">φ</span></span> <span class="main">_</span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Action of the group of automorphisms on the chamber system›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Now we examine the action of the group <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on the chamber system. In particular, we show
  that the action is transitive.
›</span></span>


<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-fundchamber_S_chamber"><span class="command">lemma</span></span> fundchamber_S_chamber<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> chamber <span class="main">(</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 
          fundfoldpairs_fundchamber_image
          OpposedThinChamberComplexFoldings.chamber_D0
        <span class="main">)</span>

<span class="keyword1" id="Chamber-fundchamber_W_image_chamber"><span class="command">lemma</span></span> fundchamber_W_image_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> chamber <span class="main">(</span><span class="free">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber W_endomorphism
        ChamberComplexEndomorphism.chamber_map
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundchamber_S_adjacent"><span class="command">lemma</span></span> fundchamber_S_adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">C0</span> <span class="main">∼</span> <span class="main">(</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          fundfoldpairs_fundchamber_image
          OpposedThinChamberComplexFoldings.chambers<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        <span class="main">)</span>

<span class="keyword1" id="Chamber-fundchamber_WS_image_adjacent"><span class="command">lemma</span></span> fundchamber_WS_image_adjacent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="main">(</span><span class="free">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">∼</span> <span class="main">(</span><span class="main">(</span><span class="free">w</span><span class="main">+</span><span class="free">s</span><span class="main">)</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber fundchamber_S_adjacent fundchamber_S_chamber
        W_endomorphism
        ChamberComplexEndomorphism.adj_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"permutation <span class="free">w</span>"</span></span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp plus_permutation.rep_eq<span class="main">)</span>

<span class="keyword1" id="Chamber-fundchamber_S_image_neq_fundchamber"><span class="command">lemma</span></span> fundchamber_S_image_neq_fundchamber<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">s</span><span class="main">`→</span><span class="free">C0</span> <span class="main">≠</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def OpposedThinChamberComplexFoldings.chambers<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fundfoldpairs_fundchamber_image<span class="main">)</span>

<span class="keyword1" id="Chamber-fundchamber_next_WS_image_neq"><span class="command">lemma</span></span> fundchamber_next_WS_image_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">+</span><span class="free">s</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">≠</span> <span class="free">w</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">w</span><span class="main">+</span><span class="free">s</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> <span class="free">w</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_permutation.rep_eq image_comp permutation_eq_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundchamber_S_fundadjset"><span class="command">lemma</span></span> fundchamber_S_fundadjset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">s</span><span class="main">`→</span><span class="free">C0</span> <span class="main">∈</span> fundadjset"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber_S_adjacent fundchamber_S_image_neq_fundchamber
        fundchamber_S_chamber chamberD_simplex adjacentset_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Chamber-fundadjset_eq_S_image"><span class="command">lemma</span></span> fundadjset_eq_S_image<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>fundadjset <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span>S<span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber adjacentsetD_adj adjacentset_chamber ex_walls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
        fundfoldpairs_def fundfoldpairs_fundchamber_image
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>

<span class="keyword1" id="Chamber-S_fixespointwise_fundchamber_image_int"><span class="command">lemma</span></span> S_fixespointwise_fundchamber_image_int<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="main">(→)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> Abs_induced_automorph <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fixespointwise_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="main">(</span><span class="main">(→)</span> <span class="free">s</span><span class="main">)</span> <span class="main">(</span>induced_automorph <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> permutation_conv_induced_automorph fun_eq_onI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>induced_automorph <span class="skolem">f</span> <span class="skolem">g</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_fundchamber_image fundfoldpairs_def
            OpposedThinChamberComplexFoldings.indaut_fixes_fundfacet
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-S_fixes_fundchamber_image_int"><span class="command">lemma</span></span> S_fixes_fundchamber_image_int<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">s</span><span class="main">`→</span><span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">=</span> <span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fixespointwise_im<span class="main">[</span><span class="operator">OF</span> S_fixespointwise_fundchamber_image_int<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-fundfacets"><span class="command">lemma</span></span> fundfacets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span> <span class="main">⊲</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span> <span class="main">⊲</span> <span class="free">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms fundchamber_S_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
          fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
          adjacent_int_facet1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span> adjacent_int_facet2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundadjset_ex1_eq_S_image"><span class="command">lemma</span></span> fundadjset_ex1_eq_S_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span>fundadjset"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound"><span class="bound">s</span></span><span class="main">∈</span>S<span class="main">.</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">∈</span>S <span class="main">∧</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">s</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundadjset_eq_S_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S <span class="main">∧</span> <span class="free">D</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span>S <span class="main">∧</span> <span class="free">D</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>1<span class="main">)</span> t<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="skolem"><span class="skolem">g'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="skolem">f</span>  <span class="skolem">g</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f'</span><span class="main">,</span><span class="skolem">g'</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> Abs_induced_automorph <span class="skolem">f'</span> <span class="skolem">g'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>2<span class="main">)</span> t<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span><span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def fundfoldpairs_fundchamber_image
            OpposedThinChamberComplexFoldings.induced_automorphism_unique<span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">g'</span></span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundchamber_S_image_inj_on"><span class="command">lemma</span></span> fundchamber_S_image_inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="bound">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span><span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber_S_fundadjset
          bex1_equality<span class="main">[</span><span class="operator">OF</span> fundadjset_ex1_eq_S_image<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-S_list_image_gallery"><span class="command">lemma</span></span> S_list_image_gallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists S <span class="main">⟹</span> gallery <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_ssnoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber fundchamber_S_chamber fundchamber_S_adjacent
          gallery_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ssnoc <span class="skolem">ss</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span> <span class="main">`→</span> <span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ssnoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">E</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span>"</span></span><span class="main">]</span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span><span class="main">]</span>
          fundchamber_W_image_chamber
          fundchamber_WS_image_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          sum_list_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gallery_snocI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Cs_def D_def E_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sums_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gallery_def fundchamber zero_permutation.rep_eq<span class="main">)</span>

<span class="keyword1" id="Chamber-pgallery_last_eq_W_image"><span class="command">lemma</span></span> pgallery_last_eq_W_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span><span class="main">∈</span>W<span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span>fundadjset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pgallery_def chamberD_simplex adjacentset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundadjset_eq_S_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> genby_genset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">S</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">D</span> <span class="skolem">Ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> DC<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∼</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">≠</span><span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pgallery_def snoc<span class="main">(</span>2<span class="main">)</span>
          binrelchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted">adjacent</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">Ds</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">D</span><span class="main">,</span><span class="skolem">C</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> snoc <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pgallery_append_reduce1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">C</span><span class="main">]</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> w<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">`→</span><span class="skolem">D</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          image_comp plus_permutation.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
          zero_permutation.rep_eq
        <span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> DC w<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span> <span class="main">∼</span> <span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">`→</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span> <span class="main">≠</span> <span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">`→</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">`→</span><span class="skolem">C</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_uminus_closed W_endomorphism<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w</span>"</span></span><span class="main">]</span>
          ChamberComplexEndomorphism.adj_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
          permutation_eq_image<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w</span>"</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span> chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
          ChamberComplexEndomorphism.simplex_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">`→</span><span class="skolem">C</span> <span class="main">∈</span> fundadjset"</span></span> <span class="keyword1"><span class="command">using</span></span> adjacentset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">`→</span><span class="skolem">C</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundadjset_eq_S_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>permutation <span class="skolem">w</span> <span class="main">∘</span> permutation <span class="main">(</span><span class="main">-</span><span class="skolem">w</span><span class="main">)</span><span class="main">)</span><span class="main">`</span><span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span>permutation <span class="skolem">w</span> <span class="main">∘</span> permutation <span class="skolem">s</span><span class="main">)</span><span class="main">`</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">w</span><span class="main">+</span><span class="skolem">s</span><span class="main">)</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_permutation.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> zero_permutation.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> w<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_genset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">S</span><span class="main">]</span> genby_add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-chamber_eq_W_image"><span class="command">lemma</span></span> chamber_eq_W_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">∈</span>W<span class="main">.</span> <span class="free">C</span> <span class="main">=</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">C0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="main">0</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_0_closed <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>  
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber chamber_pconnect pgallery_last_eq_W_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-S_list_image_crosses_walls"><span class="command">lemma</span></span> S_list_image_crosses_walls<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists S <span class="main">⟹</span> <span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>wall_crossings <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_ssnoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">s</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber fundchamber_S_chamber fundchamber_S_adjacent
          fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> ex_walls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.this_wall_betw_basechambers
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ssnoc <span class="skolem">ss</span> <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ssnoc<span class="main">(</span>2<span class="main">)</span> A_def B_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">=</span><span class="skolem">g</span><span class="main">`</span><span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span><span class="main">]</span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span>"</span></span><span class="main">]</span>
          fundchamber_W_image_chamber sum_list_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span><span class="main">]</span>
          fundchamber_next_WS_image_neq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
          fundchamber_WS_image_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          ex_walls<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.this_wall_betw_basechambers
          sums_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc wall_crossings_snoc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A labelling by the vertices of the fundamental chamber›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we show that by repeatedly applying the composition of all the elements in the collection
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of fundamental automorphisms, we can retract the entire chamber complex onto the
  fundamental chamber. This retraction provides a means of labelling the chamber complex, using the
  vertices of the fundamental chamber as labels.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">Spair</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span><span class="main">×</span><span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">Spair</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
          <span class="keyword1">SOME</span> <span class="bound">fg</span><span class="main">.</span> <span class="bound">fg</span> <span class="main">∈</span> fundfoldpairs <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> case_prod Abs_induced_automorph <span class="bound">fg</span>"</span></span>

<span class="keyword1" id="Chamber-Spair_fundfoldpair"><span class="command">lemma</span></span> Spair_fundfoldpair<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> Spair <span class="free">s</span> <span class="main">∈</span> fundfoldpairs"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Spair_def
        someI_ex<span class="main">[</span><span class="operator">of</span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fg</span><span class="main">.</span> <span class="bound">fg</span> <span class="main">∈</span> fundfoldpairs <span class="main">∧</span>
            <span class="free">s</span> <span class="main">=</span> case_prod Abs_induced_automorph <span class="bound">fg</span>"</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-Spair_induced_automorph"><span class="command">lemma</span></span> Spair_induced_automorph<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">s</span> <span class="main">=</span> case_prod Abs_induced_automorph <span class="main">(</span>Spair <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Spair_def
        someI_ex<span class="main">[</span><span class="operator">of</span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">fg</span><span class="main">.</span> <span class="bound">fg</span> <span class="main">∈</span> fundfoldpairs <span class="main">∧</span>
            <span class="free">s</span> <span class="main">=</span> case_prod Abs_induced_automorph <span class="bound">fg</span>"</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-S_list_pgallery_decomp1"><span class="command">lemma</span></span> S_list_pgallery_decomp1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">=</span> S"</span></span> <span class="keyword2"><span class="keyword">and</span></span> gal<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span>set <span class="free">ss</span><span class="main">.</span> <span class="main">∃</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
            <span class="bound">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">D</span> <span class="skolem">Ds</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> gal<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>fundadjset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pgallery_def chamberD_simplex adjacentset_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundadjset_eq_S_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="skolem">D</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def fundfoldpairs_fundchamber_image 
          OpposedThinChamberComplexFoldings.basechambers_half_chamber_systems<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>1<span class="main">)</span> ss Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gal<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Chamber-S_list_pgallery_decomp2"><span class="command">lemma</span></span> S_list_pgallery_decomp2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">=</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rs</span> <span class="bound">s</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">rs</span><span class="main">@</span><span class="bound">s</span><span class="main">#</span><span class="bound">ts</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
        <span class="bound">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="bound">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
          <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ts</span></span>  <span class="keyword2"><span class="keyword">where</span></span> rs_s_ts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">rs</span><span class="main">@</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span>
      <span class="main">¬</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list_first_prop<span class="main">[</span><span class="operator">OF</span> S_list_pgallery_decomp1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">Cs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
          <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prod_ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">r</span> <span class="skolem">C</span> <span class="skolem">f</span> <span class="skolem">g</span>
    <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">∈</span> set <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> set <span class="free">Cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span>
            <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Abs_induced_automorph <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> rs_s_ts<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pgalleryD_chamber
            fundfoldpair_unique_half_chamber_systems_chamber_ng_f<span class="main">[</span>
              <span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="skolem">C</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> rs_s_ts<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-S_list_pgallery_decomp3"><span class="command">lemma</span></span> S_list_pgallery_decomp3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">=</span> S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Cs</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rs</span> <span class="bound">s</span> <span class="bound">ts</span> <span class="bound">As</span> <span class="bound">B</span> <span class="bound">Bs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">rs</span><span class="main">@</span><span class="bound">s</span><span class="main">#</span><span class="bound">ts</span> <span class="main">∧</span> <span class="free">Cs</span> <span class="main">=</span> <span class="bound">As</span><span class="main">@</span><span class="bound">B</span><span class="main">#</span><span class="bound">Bs</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="bound">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">B</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="bound">As</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
        <span class="bound">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">A</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞<span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="bound">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
        <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> rs_s_ts<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">rs</span><span class="main">@</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">B</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">B</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">B</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_list_pgallery_decomp2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">Cs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> As_B_Bs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">Cs</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="skolem">B</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="skolem">As</span><span class="main">.</span> <span class="main">∃</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">∧</span> <span class="bound">A</span><span class="main">∉</span><span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> split_list_first_prop<span class="main">[</span><span class="operator">OF</span> rs_s_ts<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> As_B_Bs<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="skolem">As</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
          <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">A</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pgalleryD_chamber
            fundfoldpair_unique_half_chamber_systems_chamber_ng_f
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> rs_s_ts<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> As_B_Bs<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundfold_trivial_f𝒞"><span class="command">lemma</span></span> fundfold_trivial_f𝒞<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="free">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="free">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span>
    fst <span class="main">(</span>Spair <span class="free">r</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Spair_fundfoldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> Spair_induced_automorph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">r</span></span><span class="main">]</span> fundfoldpairs_def
        OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span>
          <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>Spair <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">C0</span></span>
        <span class="main">]</span>
        ChamberComplexFolding.chamber_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="free">r</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-fundfold_comp_trivial_f𝒞"><span class="command">lemma</span></span> fundfold_comp_trivial_f𝒞<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">rs</span> <span class="main">⊆</span> S <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="free">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span>
    fold fst <span class="main">(</span>map Spair <span class="free">rs</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">r</span> <span class="skolem">rs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">r</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span>
          fold fst <span class="main">(</span>map Spair <span class="skolem">rs</span><span class="main">)</span> <span class="main">`</span> fst <span class="main">(</span>Spair <span class="skolem">r</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fundfold_trivial_f𝒞<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Chamber-fundfold_trivial_f𝒞_list"><span class="command">lemma</span></span> fundfold_trivial_f𝒞_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">r</span><span class="main">∈</span>S <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="free">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span>
    fst <span class="main">(</span>Spair <span class="free">r</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundfold_trivial_f𝒞 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundfold_comp_trivial_f𝒞_list"><span class="command">lemma</span></span> fundfold_comp_trivial_f𝒞_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"set <span class="free">rs</span> <span class="main">⊆</span> S <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="free">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">C</span><span class="main">∈</span>set <span class="free">Cs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">⟹</span>
    fold fst <span class="main">(</span>map Spair <span class="free">rs</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span> <span class="main">=</span> <span class="free">Cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">rs</span></span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2'<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">r</span> <span class="skolem">rs</span> <span class="skolem">C</span> <span class="skolem">Cs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
              <span class="skolem">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">D</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">r</span><span class="main">#</span><span class="skolem">rs</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span> <span class="main">=</span>
            map <span class="main">(</span><span class="main">(`)</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="skolem">rs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>Spair <span class="skolem">r</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> 4 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundfold_trivial_f𝒞_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">r</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fundfold_comp_trivial_f𝒞<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundfold_gallery_map"><span class="command">lemma</span></span> fundfold_gallery_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> gallery <span class="free">Cs</span> <span class="main">⟹</span> gallery <span class="main">(</span>fst <span class="main">(</span>Spair <span class="free">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Spair_fundfoldpair fundfoldpairs_def
        OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>2<span class="main">)</span>
        ChamberComplexFolding.gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="free">s</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-fundfold_comp_gallery_map"><span class="command">lemma</span></span> fundfold_comp_gallery_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pregal<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> S <span class="main">⟹</span> gallery <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="skolem">ss</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundfold_gallery_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="skolem">ss</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span><span class="main">)</span> <span class="main">=</span>
            fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="free">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 subst<span class="main">[</span><span class="operator">OF</span> 2<span class="main">,</span> <span class="operator">of</span> <span class="quoted">gallery</span><span class="main">,</span> <span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pregal galleryD_adj<span class="main">)</span>

<span class="keyword1" id="Chamber-fundfold_comp_pgallery_ex_funpow"><span class="command">lemma</span></span> fundfold_comp_pgallery_ex_funpow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">=</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="free">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span>
            <span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs</span> <span class="skolem">C</span>
  <span class="keyword3"><span class="command">assume</span></span> step  <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">&lt;</span> length <span class="skolem">Cs</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> pgallery <span class="main">(</span><span class="free">C0</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span><span class="main">)</span> <span class="main">⟶</span>
                    <span class="main">(</span><span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">C0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>  set_up<span class="main">:</span>  <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ss set_up <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> decomps<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">rs</span><span class="main">@</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="skolem">B</span><span class="main">∈</span><span class="bound">g</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="skolem">As</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">A</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">D</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_list_pgallery_decomp3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Es</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> EsE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">As</span> <span class="main">=</span> <span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> cons_conv_snoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword1"><span class="command">have</span></span> EsE_s_f𝒞<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">A</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
      <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">A</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span>set <span class="main">(</span><span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> EsE decomps<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="skolem">A</span> <span class="main">∈</span> <span class="bound">f</span> <span class="main">⊢</span> 𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundfoldpair_fundchamber_in_half_chamber_system_f
            set_ConsD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">As</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> decomps<span class="main">(</span>2<span class="main">)</span> EsE
    <span class="keyword1"><span class="command">have</span></span>  decomp2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">Es</span><span class="main">@</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ss decomps<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> sB<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">B</span> <span class="main">=</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_up decomps<span class="main">(</span>3<span class="main">)</span> Spair_fundfoldpair<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
          Spair_induced_automorph<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> fundfoldpairs_def
          pgalleryD_adj
          binrelchain_append_reduce2<span class="main">[</span><span class="operator">of</span> <span class="quoted">adjacent</span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">#</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span>"</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.adjacent_half_chamber_system_image_fg<span class="main">[</span>
            <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="skolem">B</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span><span class="main">=</span><span class="main">[]</span> <span class="main">∧</span> <span class="skolem">Bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">from</span></span> decomps<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">rs</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="skolem">C</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> decomps<span class="main">(</span>1<span class="main">)</span> ss
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> fold fst <span class="main">(</span>map Spair <span class="skolem">ts</span><span class="main">)</span> <span class="main">`</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundfold_comp_trivial_f𝒞<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
              <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="free">C0</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundfoldpair_fundchamber_in_half_chamber_system_f
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> True decomps<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> ss EsE sB fundfold_comp_trivial_f𝒞<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
            fundfold_comp_trivial_f𝒞<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">have</span></span> EsBs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">Es</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∧</span> <span class="skolem">Bs</span> <span class="main">=</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> decomps<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> C0CsC_rs_f𝒞<span class="main">:</span>
        <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">rs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">D</span><span class="main">∈</span>set <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span> 
          <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="bound">D</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fundfoldpair_fundchamber_in_half_chamber_system_f
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> decomps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">rs</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="skolem">rs</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> ss decomps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C0CsC_rs_f𝒞 fundfold_comp_trivial_f𝒞_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> decomp2 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>  fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">Es</span><span class="main">@</span><span class="skolem">E</span><span class="main">#</span><span class="skolem">B</span><span class="main">#</span><span class="skolem">Bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">rs</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C0</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">@</span><span class="main">[</span><span class="skolem">C</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
                <span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> decomps<span class="main">(</span>1<span class="main">)</span> ss sB EsE_s_f𝒞 fundfold_trivial_f𝒞_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">]</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> set_up ss decomps<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  gal<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> pgallery fundfold_comp_gallery_map<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span>"</span></span><span class="main">]</span>
              gallery_remdup_adj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

      <span class="keyword1"><span class="command">from</span></span> EsBs decomp2 EsE
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Zs</span><span class="main">.</span> length <span class="bound">Zs</span> <span class="main">&lt;</span> length <span class="skolem">Cs</span> <span class="main">∧</span>
                <span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span> <span class="main">=</span> <span class="free">C0</span> <span class="main">#</span> <span class="bound">Zs</span> <span class="main">@</span> <span class="main">[</span>fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sB
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Bs</span></span> <span class="quoted"><span class="skolem">Es</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons'<span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Zs<span class="main">:</span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">Zs</span> <span class="main">&lt;</span> length <span class="skolem">Cs</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span> <span class="main">=</span> <span class="free">C0</span> <span class="main">#</span> <span class="skolem">Zs</span> <span class="main">@</span> <span class="main">[</span>fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ys</span> <span class="main">=</span> fold fst <span class="main">(</span>map Spair <span class="skolem">ts</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Zs</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> Zs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="skolem">ts</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span><span class="main">)</span> <span class="main">=</span>
          fold fst <span class="main">(</span>map Spair <span class="skolem">ts</span><span class="main">)</span> <span class="main">`</span> <span class="free">C0</span> <span class="main">#</span> <span class="skolem">Ys</span> <span class="main">@</span> <span class="main">[</span>fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">]</span>"</span></span>
         <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">r</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> <span class="main">∀</span><span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs<span class="main">.</span>
                <span class="bound">r</span> <span class="main">=</span> Abs_induced_automorph <span class="bound">f</span> <span class="bound">g</span> <span class="main">⟶</span> <span class="free">C0</span><span class="main">∈</span><span class="bound">f</span><span class="main">⊢</span>𝒞"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fundfoldpair_fundchamber_in_half_chamber_system_f
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
        <span class="quoted"><span class="quoted">"fold fst <span class="main">(</span>map Spair <span class="skolem">ts</span><span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span><span class="main">)</span> <span class="main">=</span>
          <span class="free">C0</span> <span class="main">#</span> <span class="skolem">Ys</span> <span class="main">@</span> <span class="main">[</span>fold fst <span class="main">(</span>map Spair <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> fold fst <span class="main">(</span>map Spair <span class="skolem">rs</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> decomps<span class="main">(</span>1<span class="main">)</span> ss C0CsC_rs_f𝒞 fundfold_comp_trivial_f𝒞<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
              fundfold_comp_trivial_f𝒞<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quoted"><span class="skolem">C</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> decomps<span class="main">(</span>1<span class="main">)</span> ss <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> Xs<span class="main">:</span>
        <span class="quoted"><span class="quoted">"length <span class="skolem">Xs</span> <span class="main">≤</span> length <span class="skolem">Ys</span>"</span></span>
        <span class="quoted"><span class="quoted">"pgallery <span class="main">(</span><span class="free">C0</span> <span class="main">#</span> <span class="skolem">Xs</span> <span class="main">@</span> <span class="main">[</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> gal fundfold_comp_gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">Es</span> <span class="main">@</span> <span class="skolem">E</span> <span class="main">#</span> fst <span class="main">(</span>Spair <span class="skolem">s</span><span class="main">)</span> <span class="main">⊨</span> <span class="skolem">Bs</span>"</span></span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
              gallery_obtain_pgallery<span class="main">[</span><span class="operator">OF</span> False<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> not_sym<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Ys_def Xs<span class="main">(</span>1<span class="main">)</span> Zs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Xs</span> <span class="main">&lt;</span> length <span class="skolem">Cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Xs<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp funpow_Suc_right<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundfold_comp_chamber_ex_funpow"><span class="command">lemma</span></span> fundfold_comp_chamber_ex_funpow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">=</span> S"</span></span> <span class="keyword2"><span class="keyword">and</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="bound">n</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">C0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span> <span class="main">^^</span> <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> fundchamber assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_pconnect<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> fundfold_comp_pgallery_ex_funpow
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundfold_comp_fixespointwise_C0"><span class="command">lemma</span></span> fundfold_comp_fixespointwise_C0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fold_fixespointwise<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fg</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fg</span> <span class="main">∈</span> set <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>set <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fg</span> <span class="main">=</span> Spair <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms
    <span class="keyword1"><span class="command">have</span></span>  fg'<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="main">(</span>fst <span class="skolem">fg</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">fg</span><span class="main">)</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Spair_fundfoldpair fundfoldpairs_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>fst <span class="skolem">fg</span><span class="main">)</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fg'<span class="main">]</span>
          OpposedThinChamberComplexFoldings.chamber_D0<span class="main">[</span><span class="operator">OF</span> fg'<span class="main">]</span>
          OpposedThinChamberComplexFoldings.chambers<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> fg'<span class="main">]</span>
          chamber_system_def
          ChamberComplexFolding.chamber_retraction1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">fg</span>"</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundfold_comp_endomorphism"><span class="command">lemma</span></span> fundfold_comp_endomorphism<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> S"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>fold fst <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fold_chamber_complex_endomorph_list<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">fg</span> <span class="keyword3"><span class="command">assume</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">fg</span> <span class="main">∈</span>set <span class="main">(</span>map Spair <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>set <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fg</span> <span class="main">=</span> Spair <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> <span class="main">(</span>fst <span class="skolem">fg</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>     Spair_fundfoldpair
              OpposedThinChamberComplexFoldings.axioms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
              ChamberComplexFolding.axioms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
              ChamberComplexRetraction.axioms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fundfoldpairs_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-finite_S"><span class="command">lemma</span></span> finite_S<span class="main">:</span> <span class="quoted"><span class="quoted">"finite S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber_S_fundadjset fundchamber finite_adjacentset
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_on_finite fundchamber_S_image_inj_on<span class="main">)</span>

<span class="keyword1" id="Chamber-ex_label_retraction"><span class="command">lemma</span></span> ex_label_retraction<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ</span><span class="main">.</span> label_wrt <span class="free">C0</span> <span class="bound">φ</span> <span class="main">∧</span> fixespointwise <span class="bound">φ</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="skolem">ss</span> <span class="main">=</span> S"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_S finite_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">fgs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">fgs</span> <span class="main">=</span> map Spair <span class="skolem">ss</span>"</span></span>
  <span class="comment1">― ‹for <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">fg</span> <span class="main">∈</span> set <span class="skolem">fgs</span>"</span><span class="antiquote">}</span></span>, have <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="main">(</span>fst <span class="free">fg</span><span class="main">)</span> <span class="main">`</span> <span class="free">D</span> <span class="main">=</span> <span class="free">C0</span>"</span><span class="antiquote">}</span></span> for some <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">"<span class="free">D</span> <span class="main">∈</span> <span class="free">fundajdset</span>"</span><span class="antiquote">}</span></span>›</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ψ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> fold fst <span class="skolem">fgs</span>"</span></span> <span class="comment1">(* ψ = fn ∘ … ∘ f1 *)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">vdist</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vdist</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="bound">n</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">C0</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="main">(</span><span class="skolem">vdist</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">v</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> label_wrt_def
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">C</span> <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span>𝒞"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="skolem">φ</span> <span class="skolem">C</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> ψ_def fgs_def ss C <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="skolem">m</span><span class="main">)</span><span class="main">`</span><span class="skolem">C</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chamber_system_def fundfold_comp_chamber_ex_funpow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span><span class="main">∈</span><span class="skolem">C</span> <span class="main">⟹</span> <span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="skolem">m</span><span class="main">)</span> <span class="bound">v</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">C</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">LEAST</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="bound">n</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">C0</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">from</span></span> v m φ_def vdist_def n_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="skolem">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">C0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Least_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="bound">n</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
                LeastI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="bound">n</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">C0</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">ψ</span><span class="main">^^</span><span class="skolem">m</span><span class="main">)</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="skolem">v</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ss ψ_def fgs_def φ_def vdist_def n_def funpow_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span><span class="main">-</span><span class="skolem">n</span>"</span></span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span>
                fundfold_comp_fixespointwise_C0
                funpower_fixespointwise fixespointwiseD
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> C m ss ψ_def fgs_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> chamber_system_def fundchamber fundfold_comp_endomorphism
              ChamberComplexEndomorphism.funpower_endomorphism<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
              ChamberComplexEndomorphism.bij_betw_chambers<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
              bij_betw_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span><span class="main">^^</span><span class="skolem">m</span>"</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> vdist_def φ_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">φ</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Least_eq_0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-ex_label_map"><span class="command">lemma</span></span> ex_label_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ</span><span class="main">.</span> label_wrt <span class="free">C0</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_label_retraction <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹More on the action of the group of automorphisms on chambers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Recall that we have already verified that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> acts transitively on the chamber system. We
  now use the labelling of the chamber complex examined in the previous section to show that this
  action is simply transitive.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Chamber-fundchamber_W_image_ker"><span class="command">lemma</span></span> fundchamber_W_image_ker<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">`→</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_label_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>permutation <span class="free">w</span><span class="main">)</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> W_respects_labels<span class="main">[</span><span class="operator">OF</span> φ assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> chamberD_simplex<span class="main">[</span><span class="operator">OF</span> fundchamber<span class="main">]</span>
          ChamberComplexEndomorphism.respects_label_fixes_chamber_imp_fixespointwise<span class="main">[</span>
            <span class="operator">OF</span> W_endomorphism<span class="main">,</span> <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> φ fundchamber assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber W_automorphism trivial_automorphism
          standard_uniqueness_automorphs
          permutation_inject<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundchamber_W_image_inj_on"><span class="command">lemma</span></span> fundchamber_W_image_inj_on<span class="main">:</span>
  <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> W"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span> <span class="main">=</span> <span class="skolem">w'</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ww'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span><span class="main">`→</span><span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span> <span class="main">=</span> <span class="main">(</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span><span class="main">`→</span><span class="skolem">w'</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> ww'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber_W_image_ker<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w'</span><span class="main">+</span><span class="skolem">w</span>"</span></span><span class="main">]</span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w'</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            image_comp plus_permutation.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
            zero_permutation.rep_eq genby_uminus_add_closed
          <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹A bijection between the fundamental chamber and the set of generating automorphisms›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Removing a single vertex from the fundamental chamber determines a facet, a facet in the
  fundamental chamber determines an adjacent chamber (since our complex is thin), and a chamber
  adjacent to the fundamental chamber determines an automorphism (via some pair of opposed foldings)
  in our generating set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Here we show that this correspondence is bijective.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fundantivertex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">fundantivertex</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">C0</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fundantipermutation</span> <span class="main">≡</span> the_inv_into S fundantivertex"</span></span>

<span class="keyword1" id="Chamber-fundantivertex"><span class="command">lemma</span></span> fundantivertex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> fundantivertex <span class="free">s</span> <span class="main">∈</span> <span class="free">C0</span><span class="main">-</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber_S_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        fundantivertex_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> theI'<span class="main">[</span><span class="operator">OF</span> adj_antivertex<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundantivertex_fundchamber_decomp"><span class="command">lemma</span></span> fundantivertex_fundchamber_decomp<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">C0</span> <span class="main">=</span> insert <span class="main">(</span>fundantivertex <span class="free">s</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber_S_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        fundantivertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> adjacent_conv_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundantivertex_unstable"><span class="command">lemma</span></span> fundantivertex_unstable<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S <span class="main">⟹</span> <span class="free">s</span> <span class="main">→</span> fundantivertex <span class="free">s</span> <span class="main">≠</span> fundantivertex <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundantivertex_fundchamber_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
          image_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(→)</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"fundantivertex <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span><span class="free">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span><span class="main">]</span>
          S_fixes_fundchamber_image_int fundchamber_S_image_neq_fundchamber
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Chamber-fundantivertex_inj_on"><span class="command">lemma</span></span> fundantivertex_inj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on fundantivertex S"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"fundantivertex <span class="skolem">s</span> <span class="main">=</span> fundantivertex <span class="skolem">t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"insert <span class="main">(</span>fundantivertex <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">=</span>
          insert <span class="main">(</span>fundantivertex <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="free">C0</span><span class="main">∩</span><span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundantivertex_fundchamber_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
          fundantivertex_fundchamber_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> st
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fundantivertex <span class="skolem">s</span> <span class="main">∉</span> <span class="free">C0</span><span class="main">∩</span><span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"fundantivertex <span class="skolem">s</span> <span class="main">∉</span> <span class="free">C0</span><span class="main">∩</span><span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundantivertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> fundantivertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span><span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span><span class="main">∩</span><span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> insert_subset_equality<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fundantivertex <span class="skolem">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> st<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">=</span><span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber fundchamber_S_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> fundchamber_S_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          fundfacets<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span><span class="main">]</span> fundfacets<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
          fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          facet_unique_other_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∩</span><span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span><span class="main">]</span>
          genby_genset_closed<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted">S</span><span class="main">]</span>
          inj_onD<span class="main">[</span><span class="operator">OF</span> fundchamber_W_image_inj_on<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundantivertex_surj_on"><span class="command">lemma</span></span> fundantivertex_surj_on<span class="main">:</span> <span class="quoted"><span class="quoted">"fundantivertex <span class="main">`</span> S <span class="main">=</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> fundantivertex <span class="main">`</span> S <span class="main">⟹</span> <span class="bound">v</span><span class="main">∈</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fundantivertex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">C0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> the_adj_chamber <span class="free">C0</span> <span class="main">(</span><span class="free">C0</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span>fundadjset"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber facetrel_diff_vertex the_adj_chamber_adjacentset
          the_adj_chamber_neq
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundadjset_eq_S_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> v D_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fundantivertex <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>     fundchamber fundchamber_S_adjacent
              fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
              facetrel_diff_vertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
              the_adj_chamber_facet facetrel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">-</span><span class="main">{</span><span class="skolem">v</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> fundantivertex_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> the1_equality<span class="main"><span class="main">[</span></span><span class="operator">OF</span> adj_antivertex<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> fundantivertex <span class="main">`</span> S"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Chamber-fundantivertex_bij_betw"><span class="command">lemma</span></span> fundantivertex_bij_betw<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw fundantivertex S <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
  <span class="keyword1"><span class="command">using</span></span>     fundantivertex_inj_on fundantivertex_surj_on
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Chamber-card_S_fundchamber"><span class="command">lemma</span></span> card_S_fundchamber<span class="main">:</span> <span class="quoted"><span class="quoted">"card S <span class="main">=</span> card <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_same_card<span class="main">[</span><span class="operator">OF</span> fundantivertex_bij_betw<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Chamber-card_S_chamber"><span class="command">lemma</span></span> card_S_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> card <span class="free">C</span> <span class="main">=</span> card S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundchamber chamber_card<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> card_S_fundchamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-fundantipermutation1"><span class="command">lemma</span></span> fundantipermutation1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C0</span> <span class="main">⟹</span> fundantipermutation <span class="free">v</span> <span class="main">∈</span> S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fundantivertex_surj_on the_inv_into_into<span class="main">[</span><span class="operator">OF</span> fundantivertex_inj_on<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>




<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Thick chamber complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A thick chamber complex is one in which every facet is a facet of at least three chambers.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ThickChamberComplex <span class="main">=</span> ChamberComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> thick<span class="main">:</span>
    <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">D</span> <span class="bound">E</span><span class="main">.</span> <span class="bound">D</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">}</span> <span class="main">∧</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">D</span> <span class="main">∧</span> <span class="bound">E</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">,</span><span class="bound">D</span><span class="main">}</span> <span class="main">∧</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">E</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">some_third_chamber</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">some_third_chamber</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> <span class="keyword1">SOME</span> <span class="bound">E</span><span class="main">.</span> <span class="bound">E</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">}</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">⊲</span><span class="bound">E</span>"</span></span>

<span class="keyword1" id="Chamber-facet_ex_third_chamber"><span class="command">lemma</span></span> facet_ex_third_chamber<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">E</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">}</span><span class="main">.</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> thick<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Chamber-some_third_chamberD_facet"><span class="command">lemma</span></span> some_third_chamberD_facet<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⊲</span> some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facet_ex_third_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">}</span> <span class="main">∧</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">E</span>"</span></span><span class="main">]</span>
        some_third_chamber_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  
<span class="keyword1" id="Chamber-some_third_chamberD_simplex"><span class="command">lemma</span></span> some_third_chamberD_simplex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facet_ex_third_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">}</span> <span class="main">∧</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">E</span>"</span></span><span class="main">]</span>
        some_third_chamber_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Chamber-some_third_chamberD_adj"><span class="command">lemma</span></span> some_third_chamberD_adj<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> <span class="free">C</span> <span class="main">∼</span> some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> some_third_chamberD_facet <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adjacentI<span class="main">)</span>

<span class="keyword1" id="Chamber-chamber_some_third_chamber"><span class="command">lemma</span></span> chamber_some_third_chamber<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">⊲</span><span class="free">C</span> <span class="main">⟹</span> chamber <span class="main">(</span>some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_adj some_third_chamberD_simplex some_third_chamberD_adj
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Chamber-some_third_chamberD_ne"><span class="command">lemma</span></span> some_third_chamberD_ne<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="free">z</span> <span class="main">≠</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="free">z</span> <span class="main">≠</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms facet_ex_third_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          someI_ex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">E</span><span class="main">.</span> <span class="bound">E</span><span class="main">∈</span><span class="free">X</span><span class="main">-</span><span class="main">{</span><span class="free">C</span><span class="main">,</span><span class="free">D</span><span class="main">}</span> <span class="main">∧</span> <span class="free">z</span><span class="main">⊲</span><span class="bound">E</span>"</span></span><span class="main">]</span> some_third_chamber_def
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThickChamberComplex *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Coxeter">
<div class="head">
<h1>Theory Coxeter</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Coxeter systems and complexes›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A Coxeter system is a group that affords a presentation, where each generator is of order two,
  and each relator is an alternating word of even length in two generators.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Coxeter
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Chamber">Chamber</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Coxeter-like systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we work in a group generated by elements of order two.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> PreCoxeterSystem <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span><span class="main">::</span>group_add set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> genset_order2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> add_order <span class="free">s</span> <span class="main">=</span> <span class="numeral">2</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">W</span> <span class="main">≡</span> <span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S_length</span>  <span class="main">≡</span> word_length <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S_reduced_for</span> <span class="main">≡</span> reduced_word_for <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">S_reduced</span> <span class="main">≡</span> reduced_word <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">relfun</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">s</span> <span class="bound">t</span><span class="main">.</span> add_order <span class="main">(</span><span class="bound">s</span><span class="main">+</span><span class="bound">t</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Coxeter-no_zero_genset"><span class="command">lemma</span></span> no_zero_genset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∉</span><span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'w</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> add_order0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> genset_order2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-genset_order2_add"><span class="command">lemma</span></span> genset_order2_add<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">+</span> <span class="free">s</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2 nataction_2<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> genset_uminus <span class="main">=</span> minus_unique<span class="main">[</span><span class="operator">OF</span> genset_order2_add<span class="main">]</span>

<span class="keyword1" id="Coxeter-relfun_S"><span class="command">lemma</span></span> relfun_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> relfun <span class="free">s</span> <span class="free">s</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order_relator<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2 nataction_2<span class="main">)</span>

<span class="keyword1" id="Coxeter-relfun_eq1"><span class="command">lemma</span></span> relfun_eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">1</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">=</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order_add_eq1 genset_uminus <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-S_relator_list"><span class="command">lemma</span></span> S_relator_list<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> pair_relator_list <span class="free">s</span> <span class="free">s</span> <span class="main">=</span> <span class="main">[</span><span class="free">s</span><span class="main">,</span><span class="free">s</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> relfun_S alternating_list2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coxeter-S_sym"><span class="command">lemma</span></span> S_sym<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span> uminus <span class="main">`</span> <span class="free">T</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genset_uminus <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> special_subgroup_eq_sum_list <span class="main">=</span>
  genby_sym_eq_sum_lists<span class="main">[</span><span class="operator">OF</span> S_sym<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> genby_S_reduced_word_for_arg_min <span class="main">=</span>
  reduced_word_for_genby_sym_arg_min<span class="main">[</span><span class="operator">OF</span> S_sym<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> in_genby_S_reduced_letter_set <span class="main">=</span>
  in_genby_sym_imp_in_reduced_letter_set<span class="main">[</span><span class="operator">OF</span> S_sym<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystem *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Special cosets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  From a Coxeter system we will eventually construct an associated chamber complex. To do so, we
  will consider the collection of special cosets: left cosets of subgroups generated by subsets of
  the generating set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. This collection forms a poset under the supset relation that, under
  a certain extra assumption, can be used to form a simplicial complex whose poset of simplices
  is isomorphic to this poset of special cosets.  In the literature, groups generated by subsets of
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> are often referred to as parabolic subgroups of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and their cosets as parabolic
  cosets, but following Garrett \cite{Garrett:Buildings} we have opted for the names special
  subgroups and special cosets.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">special_cosets</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">special_cosets</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">T</span><span class="main">∈</span>Pow <span class="free">S</span><span class="main">.</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span>W<span class="main">.</span> <span class="main">{</span> <span class="bound">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="bound">T</span><span class="main">⟩</span> <span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒫</span> <span class="main">≡</span> special_cosets"</span></span>

<span class="keyword1" id="Coxeter-special_cosetsI"><span class="command">lemma</span></span> special_cosetsI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-special_coset_singleton"><span class="command">lemma</span></span> special_coset_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span><span class="main">∈</span>𝒫"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_cosetsI genby_lcoset_empty<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-special_coset_nempty"><span class="command">lemma</span></span> special_coset_nempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span>𝒫 <span class="main">⟹</span> <span class="free">X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_cosets_def genby_lcoset_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-special_subgroup_special_coset"><span class="command">lemma</span></span> special_subgroup_special_coset<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span> <span class="main">⟹</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_0_closed special_cosetsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-special_cosets_lcoset_closed"><span class="command">lemma</span></span> special_cosets_lcoset_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">X</span><span class="main">∈</span>𝒫 <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="free">X</span> <span class="main">∈</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_add_closed <span class="keyword1"><span class="command">unfolding</span></span> special_cosets_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_plus_rearrange2<span class="main">)</span>

<span class="keyword1" id="Coxeter-special_cosets_lcoset_shift"><span class="command">lemma</span></span> special_cosets_lcoset_shift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="main">`</span> 𝒫 <span class="main">=</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_cosets_lcoset_closed genby_uminus_closed
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_plus_rearrange2<span class="main">)</span>

<span class="keyword1" id="Coxeter-special_cosets_has_bottom"><span class="command">lemma</span></span> special_cosets_has_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"supset_has_bottom 𝒫"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ordering.has_bottomI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> supset_poset<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"W<span class="main">∈</span>𝒫"</span></span> <span class="keyword1"><span class="command">using</span></span> special_subgroup_special_coset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> wT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> W"</span></span> <span class="keyword1"><span class="command">using</span></span> genby_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span><span class="main">]</span> genby_lcoset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-special_cosets_bottom"><span class="command">lemma</span></span> special_cosets_bottom<span class="main">:</span> <span class="quoted"><span class="quoted">"supset_bottom 𝒫 <span class="main">=</span> W"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> supset_bottomI<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">⊆</span>W"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> set_plus_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span> <span class="quoted">W</span><span class="main">]</span> genby_lcoset_el_reduce
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> special_subgroup_special_coset<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Transfer from the free group over generators›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We form a set of relators and show that it and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> form a
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> GroupWithGeneratorsRelators<span class="antiquote"><span class="antiquote">}</span></span></span></span>. The associated quotient group <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">G</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> maps surjectively
  onto <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. In the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>CoxeterSystem›</span></span></span></span> locale below, this correspondence will be assumed
  to be injective as well.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">{</span>pair_relator_list <span class="bound">s</span> <span class="bound">t</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">≡</span> map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="main">`</span> R"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">P'</span> <span class="main">≡</span> GroupWithGeneratorsRelators.P' <span class="free">S</span> R"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">≡</span> GroupWithGeneratorsRelators.Q <span class="free">S</span> R"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≡</span> GroupWithGeneratorsRelators.G <span class="free">S</span> R"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">relator_freeword</span> <span class="main">≡</span>
                GroupWithGeneratorsRelators.relator_freeword <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pair_relator_freeword</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'w</span> freeword"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">pair_relator_freeword</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> Abs_freelist <span class="main">(</span>pair_relator_list <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">freeliftid</span> <span class="main">≡</span> freeword_funlift id"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">induced_id</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> freeword set permutation <span class="main">⇒</span> <span class="tfree">'w</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_id</span> <span class="main">≡</span> GroupWithGeneratorsRelators.induced_id <span class="free">S</span> R"</span></span>

<span class="keyword1" id="Coxeter-S_relator_freeword"><span class="command">lemma</span></span> S_relator_freeword<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> pair_relator_freeword <span class="free">s</span> <span class="free">s</span> <span class="main">=</span> <span class="free">s</span><span class="main">[+]</span><span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_relator_list Abs_freeletter_add<span class="main">)</span>

<span class="keyword1" id="Coxeter-map_charpair_map_pairtrue_R"><span class="command">lemma</span></span> map_charpair_map_pairtrue_R<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span>
    map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="main">(</span>pair_relator_list <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> map pairtrue <span class="main">(</span>pair_relator_list <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_alternating_list map_charpair_uniform <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-relator_freeword"><span class="command">lemma</span></span> relator_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span>
    pair_relator_freeword <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> relator_freeword <span class="main">(</span>pair_relator_list <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_alternating_list
        arg_cong<span class="main">[</span><span class="operator">OF</span> map_charpair_map_pairtrue_R<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted">Abs_freeword</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-relator_freewords"><span class="command">lemma</span></span> relator_freewords<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="main">`</span> R <span class="main">=</span> P'"</span></span>
  <span class="keyword1"><span class="command">using</span></span> relator_freeword <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Coxeter-GroupWithGeneratorsRelators_S_R"><span class="command">lemma</span></span> GroupWithGeneratorsRelators_S_R<span class="main">:</span> <span class="quoted"><span class="quoted">"GroupWithGeneratorsRelators <span class="free">S</span> R"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">rs</span> <span class="keyword3"><span class="command">assume</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span><span class="main">∈</span>R"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> rs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> set_alternating_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> rs' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> lists <span class="main">(</span><span class="free">S</span> <span class="main">∪</span> uminus <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> rs <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">rs</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_list_pair_relator_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> rs' <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"proper_signed_list <span class="main">(</span>map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="skolem">rs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd
          arg_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>charpair <span class="free">S</span><span class="main">)</span> <span class="skolem">rs</span>"</span></span> <span class="quoted"><span class="quoted">"map pairtrue <span class="skolem">rs</span>"</span></span> <span class="quoted">proper_signed_list</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> GroupByPresentation_S_P <span class="main">=</span>
  GroupWithGeneratorsRelators.GroupByPresentation_S_P<span class="main">[</span>
    <span class="operator">OF</span> GroupWithGeneratorsRelators_S_R
  <span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> Q_FreeS <span class="main">=</span> GroupByPresentation.Q_FreeS<span class="main">[</span><span class="operator">OF</span> GroupByPresentation_S_P<span class="main">]</span>

<span class="keyword1" id="Coxeter-relator_freeword_Q"><span class="command">lemma</span></span> relator_freeword_Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> pair_relator_freeword <span class="free">s</span> <span class="free">t</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> relator_freeword
        GroupByPresentation.relators<span class="main">[</span><span class="operator">OF</span> GroupByPresentation_S_P<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> P'_FreeS <span class="main">=</span>
  GroupWithGeneratorsRelators.P'_FreeS<span class="main">[</span>
    <span class="operator">OF</span> GroupWithGeneratorsRelators_S_R
  <span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> GroupByPresentationInducedFun_S_P_id <span class="main">=</span>
  GroupWithGeneratorsRelators.GroupByPresentationInducedFun_S_P_id<span class="main">[</span>
    <span class="operator">OF</span> GroupWithGeneratorsRelators_S_R
  <span class="main">]</span>

<span class="keyword1" id="Coxeter-rconj_relator_freeword"><span class="command">lemma</span></span> rconj_relator_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> proper_signed_list <span class="free">xs</span><span class="main">;</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span>
    rconjby <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> GroupWithGeneratorsRelators.rconj_relator_freeword<span class="main">[</span>
          <span class="operator">OF</span> GroupWithGeneratorsRelators_S_R
        <span class="main">]</span>
        relator_freeword
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-lconjby_Abs_freelist_relator_freeword"><span class="command">lemma</span></span> lconjby_Abs_freelist_relator_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="free">xs</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟧</span> <span class="main">⟹</span>
    lconjby <span class="main">(</span>Abs_freelist <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> GroupWithGeneratorsRelators.lconjby_Abs_freelist_relator_freeword<span class="main">[</span>
          <span class="operator">OF</span> GroupWithGeneratorsRelators_S_R
        <span class="main">]</span>
        relator_freeword
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-Abs_freelist_rev_append_alternating_list_in_Q"><span class="command">lemma</span></span> Abs_freelist_rev_append_alternating_list_in_Q<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="main">(</span>rev <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">@</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="skolem">m</span> <span class="keyword1">then</span> <span class="free">s</span> <span class="keyword1">else</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> Abs_freelist <span class="main">(</span>rev <span class="main">(</span>alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">@</span> alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> u_def x_def assms <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"Abs_freelist <span class="main">(</span>rev <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">@</span>
      alternating_list <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span>pair_relator_freeword <span class="skolem">u</span> <span class="skolem">u</span><span class="main">)</span> <span class="main">+</span> rconjby <span class="main">(</span>Abs_freeletter <span class="skolem">u</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freelist_append<span class="main">[</span><span class="operator">of</span>
            <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">#</span> rev <span class="main">(</span>alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">@</span> alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
            <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">u</span><span class="main">]</span>"</span></span>
          <span class="main">]</span>
          Abs_freelist_Cons<span class="main">[</span><span class="operator">of</span>
            <span class="quoted"><span class="skolem">u</span></span>
            <span class="quoted"><span class="quoted">"rev <span class="main">(</span>alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">@</span> alternating_list <span class="skolem">m</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> S_relator_freeword<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Suc assms u_def x_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rconjby <span class="main">(</span>Abs_freeletter <span class="skolem">u</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">∈</span> Q"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freeletter_in_FreeGroup_iff<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
          FreeGroup_genby_set_lconjby_set_rconjby_closed
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> u_def assms relator_freeword_Q genby_add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> genby_0_closed<span class="main">)</span>

<span class="keyword1" id="Coxeter-Abs_freeword_freelist_uminus_add_in_Q"><span class="command">lemma</span></span> Abs_freeword_freelist_uminus_add_in_Q<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span>
    <span class="main">-</span> Abs_freelistfst <span class="free">xs</span> <span class="main">+</span> Abs_freeword <span class="free">xs</span> <span class="main">∈</span> Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">-</span> Abs_freelistfst <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> Abs_freeword <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">-</span>Abs_freelistfst <span class="skolem">xs</span> <span class="main">+</span> <span class="main">-</span>Abs_freeletter <span class="main">(</span>fst <span class="skolem">x</span><span class="main">)</span>
          <span class="main">+</span> Abs_freeword <span class="main">[</span><span class="skolem">x</span><span class="main">]</span> <span class="main">+</span> Abs_freeword <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freelist_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">xs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_freeword_Cons<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> add.assoc minus_add<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"snd <span class="skolem">x</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 1
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
              Abs_freeletter_prod_conv_Abs_freeword
              binrelchain_Cons_reduce
            <span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> fst <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> s_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> rconjby <span class="main">(</span>Abs_freelistfst <span class="skolem">xs</span><span class="main">)</span> <span class="main">(</span>pair_relator_freeword <span class="skolem">s</span> <span class="skolem">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> s_def False Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">-</span> Abs_freelistfst <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> Abs_freeword <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">-</span>Abs_freelistfst <span class="skolem">xs</span> <span class="main">+</span> <span class="main">-</span>pair_relator_freeword <span class="skolem">s</span> <span class="skolem">s</span> <span class="main">+</span> Abs_freeword <span class="skolem">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 surjective_pairing<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> S_relator_freeword<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
            uminus_Abs_freeword_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">False</span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> q_def <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">-</span> Abs_freelistfst <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">+</span> Abs_freeword <span class="main">(</span><span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">-</span><span class="skolem">q</span> <span class="main">+</span> <span class="main">(</span><span class="main">-</span>Abs_freelistfst <span class="skolem">xs</span> <span class="main">+</span> Abs_freeword <span class="skolem">xs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rconjby_uminus<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> q_def s_def Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">q</span><span class="main">∈</span>Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> proper_signed_list_map_uniform_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted">True</span> <span class="quoted"><span class="quoted">"map fst <span class="skolem">xs</span>"</span></span><span class="main">]</span>
            rconj_relator_freeword genby_uminus_closed
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>Abs_freelistfst <span class="skolem">xs</span> <span class="main">+</span> Abs_freeword <span class="skolem">xs</span> <span class="main">∈</span> Q"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> binrelchain_Cons_reduce<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> genby_add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> genby_0_closed<span class="main">)</span>

<span class="keyword1" id="Coxeter-Q_freelist_freeword'"><span class="command">lemma</span></span> Q_freelist_freeword'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> proper_signed_list <span class="free">xs</span><span class="main">;</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">;</span> Abs_freelistfst <span class="free">xs</span> <span class="main">∈</span> Q <span class="main">⟧</span> <span class="main">⟹</span>
    Abs_freeword <span class="free">xs</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Abs_freeword_freelist_uminus_add_in_Q genby_add_closed
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-Q_freelist_freeword"><span class="command">lemma</span></span> Q_freelist_freeword<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> Abs_freelist <span class="main">(</span>map fst <span class="main">(</span>freeword <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Q <span class="main">⟹</span> <span class="free">c</span> <span class="main">∈</span> Q"</span></span>
 <span class="keyword1"><span class="command">using</span></span> freeword FreeGroupD Q_freelist_freeword' freeword_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
 <span class="keyword1"><span class="command">by</span></span>     <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we show that the lift of the identity map to the free group on <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is really just
  summation.
›</span></span>

<span class="keyword1" id="Coxeter-freeliftid_Abs_freeword_conv_sum_list"><span class="command">lemma</span></span> freeliftid_Abs_freeword_conv_sum_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span>
    freeliftid <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> freeword_funlift_Abs_freeword<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted">id</span><span class="main">]</span> genset_uminus
        sum_list_map_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="quoted">"apply_sign id"</span></span> <span class="quoted">fst</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystem *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Words in generators containing alternating subwords›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Besides cancelling subwords equal to relators, the primary algebraic manipulation in seeking to
  reduce a word in generators in a Coxeter system is to reverse the order of alternating subwords
  of half the length of the associated relator, in order to create adjacent repeated letters that
  can be cancelled. Here we detail the mechanics of such manipulations.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-sum_list_pair_relator_halflist_flip"><span class="command">lemma</span></span> sum_list_pair_relator_halflist_flip<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span>
    sum_list <span class="main">(</span>pair_relator_halflist <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>pair_relator_halflist <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_order<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">+</span><span class="free">t</span>"</span></span><span class="main">]</span> genset_order2_add
        alternating_order2_even_cancel_right<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span><span class="main">(</span>relfun <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alternating_sum_list_conv_nataction add_order_add_sym<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flip_altsublist_adjacent</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> list <span class="main">⇒</span> <span class="tfree">'w</span> list <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">flip_altsublist_adjacent</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>
          <span class="main">≡</span> <span class="main">∃</span><span class="bound">s</span> <span class="bound">t</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ss</span></span></span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="bound">s</span> <span class="bound">t</span><span class="main">)</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">∧</span>
              <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="bound">t</span> <span class="bound">s</span><span class="main">)</span> <span class="main">@</span> <span class="bound">bs</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">flip_altsublist_chain</span> <span class="main">≡</span> binrelchain flip_altsublist_adjacent"</span></span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacentI"><span class="command">lemma</span></span> flip_altsublist_adjacentI<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">⟹</span>
    <span class="free">ts</span> <span class="main">=</span> <span class="free">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">@</span> <span class="free">bs</span> <span class="main">⟹</span>
    flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_Cons_grow"><span class="command">lemma</span></span> flip_altsublist_adjacent_Cons_grow<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ts</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ssts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span> 
                <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> ssts <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="free">ss</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> flip_altsublist_adjacentI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flip_altsublist_chain_map_Cons_grow"><span class="command">lemma</span></span> flip_altsublist_chain_map_Cons_grow<span class="main">:</span>
  <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="free">tss</span> <span class="main">⟹</span> flip_altsublist_chain <span class="main">(</span>map <span class="main">(</span><span class="main">(#)</span> <span class="free">t</span><span class="main">)</span> <span class="free">tss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">tss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        binrelchain_Cons_reduce<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted">flip_altsublist_adjacent</span><span class="main"><span class="main">]</span></span>
        flip_altsublist_adjacent_Cons_grow
      <span class="main">)</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_refl"><span class="command">lemma</span></span> flip_altsublist_adjacent_refl<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟹</span> flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">s</span><span class="main">]</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">@</span> pair_relator_halflist <span class="skolem">s</span> <span class="skolem">s</span> <span class="main">@</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> relfun_S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> flip_altsublist_adjacentI<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> cons <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_Cons_grow <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_sym"><span class="command">lemma</span></span> flip_altsublist_adjacent_sym<span class="main">:</span>
  <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span> <span class="main">⟹</span> flip_altsublist_adjacent <span class="free">ts</span> <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_def flip_altsublist_adjacentI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-rev_flip_altsublist_chain"><span class="command">lemma</span></span> rev_flip_altsublist_chain<span class="main">:</span>
  <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="free">xss</span> <span class="main">⟹</span> flip_altsublist_chain <span class="main">(</span>rev <span class="free">xss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_sym binrelchain_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted">flip_altsublist_adjacent</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct_CCons<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_set"><span class="command">lemma</span></span> flip_altsublist_adjacent_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"set <span class="free">ts</span> <span class="main">=</span> set <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> ssts<span class="main">:</span>  
    <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> set_alternating_list2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"relfun <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
          set_alternating_list2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"relfun <span class="skolem">t</span> <span class="skolem">s</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
          add_order_add_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> relfun_eq1
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"relfun <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_cases_2Suc<span class="main">)</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_set_ball"><span class="command">lemma</span></span> flip_altsublist_adjacent_set_ball<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ss</span><span class="main">∈</span>lists <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ts</span><span class="main">.</span> flip_altsublist_adjacent <span class="bound">ss</span> <span class="bound">ts</span> <span class="main">⟶</span> set <span class="bound">ts</span> <span class="main">=</span> set <span class="bound">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_lists"><span class="command">lemma</span></span> flip_altsublist_adjacent_lists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">ts</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_set <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_lists_ball"><span class="command">lemma</span></span> flip_altsublist_adjacent_lists_ball<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ss</span><span class="main">∈</span>lists <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ts</span><span class="main">.</span> flip_altsublist_adjacent <span class="bound">ss</span> <span class="bound">ts</span> <span class="main">⟶</span> <span class="bound">ts</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-flip_altsublist_chain_lists"><span class="command">lemma</span></span> flip_altsublist_chain_lists<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> flip_altsublist_chain <span class="main">(</span><span class="free">ss</span><span class="main">#</span><span class="free">xss</span><span class="main">@</span><span class="main">[</span><span class="free">ts</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ts</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_lists
        binrelchain_propcong_Cons_snoc<span class="main">[</span><span class="operator">of</span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> <span class="bound">ss</span><span class="main">∈</span>lists <span class="free">S</span>"</span></span> <span class="quoted">flip_altsublist_adjacent</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">xss</span></span> <span class="quoted"><span class="free">ts</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> flip_altsublist_chain_funcong_Cons_snoc <span class="main">=</span>
  binrelchain_setfuncong_Cons_snoc<span class="main">[</span><span class="operator">OF</span> flip_altsublist_adjacent_lists_ball<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> flip_altsublist_chain_set <span class="main">=</span>
  flip_altsublist_chain_funcong_Cons_snoc<span class="main">[</span>
    <span class="operator">OF</span> flip_altsublist_adjacent_set_ball
  <span class="main">]</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_length"><span class="command">lemma</span></span> flip_altsublist_adjacent_length<span class="main">:</span>
  <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span> <span class="main">⟹</span> length <span class="free">ts</span> <span class="main">=</span> length <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> flip_altsublist_adjacent_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_order_add_sym length_alternating_list<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> flip_altsublist_chain_length <span class="main">=</span>
  binrelchain_funcong_Cons_snoc<span class="main">[</span>
    <span class="operator">of</span> <span class="quoted">flip_altsublist_adjacent</span> <span class="quoted">length</span><span class="main">,</span> <span class="operator">OF</span> flip_altsublist_adjacent_length<span class="main">,</span> <span class="operator">simplified</span>
  <span class="main">]</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_sum_list"><span class="command">lemma</span></span> flip_altsublist_adjacent_sum_list<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ts</span> <span class="main">=</span> sum_list <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> stasbs<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">(</span>pair_relator_halflist <span class="skolem">t</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"relfun <span class="skolem">s</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> stasbs <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_order_add_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Suc
    <span class="keyword1"><span class="command">with</span></span> assms stasbs <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_alternating_list1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="skolem">s</span><span class="main">+</span><span class="skolem">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            set_alternating_list1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="skolem">t</span><span class="main">+</span><span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
            add_order_add_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
            flip_altsublist_adjacent_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> stasbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list_pair_relator_halflist_flip <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_sum_list_ball"><span class="command">lemma</span></span> flip_altsublist_adjacent_sum_list_ball<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ss</span><span class="main">∈</span>lists <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">ts</span><span class="main">.</span> flip_altsublist_adjacent <span class="bound">ss</span> <span class="bound">ts</span> <span class="main">⟶</span> sum_list <span class="bound">ts</span> <span class="main">=</span> sum_list <span class="bound">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-S_reduced_forI_flip_altsublist_adjacent"><span class="command">lemma</span></span> S_reduced_forI_flip_altsublist_adjacent<span class="main">:</span>
  <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="free">ss</span> <span class="main">⟹</span> flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span> <span class="main">⟹</span> S_reduced_for <span class="free">w</span> <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> reduced_word_for_sum_list
        flip_altsublist_adjacent_lists flip_altsublist_adjacent_sum_list
        flip_altsublist_adjacent_length
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduced_word_forI_compare<span class="main">)</span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_in_Q'"><span class="command">lemma</span></span> flip_altsublist_adjacent_in_Q'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">as</span> <span class="free">bs</span> <span class="free">s</span> <span class="free">t</span>
  <span class="keyword2"><span class="keyword">defines</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≡</span> <span class="free">as</span> <span class="main">@</span> pair_relator_halflist <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     ys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">≡</span> <span class="free">as</span> <span class="main">@</span> pair_relator_halflist <span class="free">t</span> <span class="free">s</span> <span class="main">@</span> <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Axs<span class="main">:</span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="free">xs</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="free">ys</span> <span class="main">∈</span> Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">half_st</span></span> <span class="skolem"><span class="skolem">half2_st</span></span> <span class="skolem"><span class="skolem">half_ts</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Abs_freelist <span class="free">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> Abs_freelist <span class="free">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> Abs_freelist <span class="free">as</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> Abs_freelist <span class="free">bs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">half_st</span> <span class="main">=</span> Abs_freelist <span class="main">(</span>pair_relator_halflist <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">half2_st</span> <span class="main">=</span> Abs_freelist <span class="main">(</span>pair_relator_halflist2 <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">half_ts</span> <span class="main">=</span> Abs_freelist <span class="main">(</span>pair_relator_halflist <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">half2_st</span> <span class="main">+</span> <span class="skolem">B</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">=</span> rconjby <span class="skolem">z</span> <span class="main">(</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> Abs_freelist <span class="main">(</span>rev <span class="main">(</span>pair_relator_halflist <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">@</span> pair_relator_halflist <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w3</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">=</span> rconjby <span class="skolem">B</span> <span class="skolem">w2</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> w1_def z_def
    <span class="keyword1"><span class="command">have</span></span>  w1'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">=</span> rconjby <span class="skolem">B</span> <span class="main">(</span>lconjby <span class="skolem">half2_st</span> <span class="main">(</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rconjby_add<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w1</span> <span class="main">=</span> rconjby <span class="skolem">B</span> <span class="main">(</span>lconjby <span class="skolem">half2_st</span> <span class="main">(</span><span class="main">-</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lconjby_uminus<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">half2_st</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rconjby_uminus<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> X_def xs A_def half_st_def B_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">+</span> rconjby <span class="skolem">B</span> <span class="skolem">half_st</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          Abs_freelist_append_append<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
        <span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="main">-</span><span class="skolem">w1</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">+</span>
      <span class="main">(</span> rconjby <span class="skolem">B</span> <span class="main">(</span><span class="skolem">half_st</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">half2_st</span> <span class="main">+</span> <span class="main">-</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span> <span class="main">-</span> <span class="skolem">half2_st</span><span class="main">)</span><span class="main">)</span> <span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc add_rconjby<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> w2_def half2_st_def half_ts_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> <span class="skolem">half2_st</span> <span class="main">+</span> <span class="skolem">half_ts</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          Abs_freelist_append<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
          pair_relator_halflist2_conv_rev_pair_relator_halflist
        <span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">+</span> <span class="main">-</span><span class="skolem">w1</span> <span class="main">+</span> <span class="skolem">w3</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">+</span> <span class="skolem">B</span> <span class="main">+</span> <span class="main">(</span>rconjby <span class="skolem">B</span> <span class="main">(</span><span class="main">-</span><span class="skolem">half2_st</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">half2_st</span> <span class="main">+</span> <span class="skolem">half_ts</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> half_st_def half2_st_def w3_def add_assoc4<span class="main">[</span>
            <span class="operator">of</span> <span class="quoted"><span class="skolem">half_st</span></span> <span class="quoted"><span class="skolem">half2_st</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span>pair_relator_freeword <span class="free">s</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">half2_st</span>"</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            Abs_freelist_append<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> pair_relator_halflist_append
            add.assoc add_rconjby
          <span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> Y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">X</span> <span class="main">-</span> <span class="skolem">w1</span> <span class="main">+</span> <span class="skolem">w3</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_def half_ts_def B_def ys Y_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            add.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
            Abs_freelist_append_append<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
          <span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Axs <span class="keyword1"><span class="command">have</span></span> xs_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q_FreeS FreeGroupD_transfer' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">∈</span>Q <span class="main">∧</span> <span class="skolem">w3</span><span class="main">∈</span>Q"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"relfun <span class="free">s</span> <span class="free">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> w1_def w2_def w3_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> genby_0_closed
      <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            zero_freeword.abs_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
            add_order_add_sym
          <span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">have</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">,</span><span class="free">t</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> m xs xs_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> set_alternating_list1 relfun_eq1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Suc <span class="keyword1"><span class="command">with</span></span> m xs xs_S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> set_alternating_list2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">s</span><span class="main">+</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">from</span></span> xs xs_S B_def <span class="keyword1"><span class="command">have</span></span> B_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Abs_freelist_in_FreeGroup<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> w2_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">∈</span>Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> st Abs_freelist_rev_append_alternating_list_in_Q<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"add_order <span class="main">(</span><span class="free">t</span><span class="main">+</span><span class="free">s</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w3</span> <span class="main">∈</span> Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w3_def FreeGroup_genby_set_lconjby_set_rconjby_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> half2_st_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w1' st B_S alternating_list_in_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> alternating_list_in_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
            lconjby_Abs_freelist_relator_freeword<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> FreeGroup_genby_set_lconjby_set_rconjby_closed<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> X_def Y_def Axs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Y' genby_diff_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">]</span> genby_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">-</span><span class="skolem">w1</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">w3</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flip_altsublist_adjacent_in_Q"><span class="command">lemma</span></span> flip_altsublist_adjacent_in_Q<span class="main">:</span>
  <span class="quoted"><span class="quoted">"Abs_freelist <span class="free">ss</span> <span class="main">∈</span> Q <span class="main">⟹</span> flip_altsublist_adjacent <span class="free">ss</span> <span class="free">ts</span> <span class="main">⟹</span> Abs_freelist <span class="free">ts</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_def flip_altsublist_adjacent_in_Q' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-flip_altsublist_chain_G_in_Q"><span class="command">lemma</span></span> flip_altsublist_chain_G_in_Q<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> Abs_freelist <span class="free">ss</span> <span class="main">∈</span> Q<span class="main">;</span> flip_altsublist_chain <span class="main">(</span><span class="free">ss</span><span class="main">#</span><span class="free">xss</span><span class="main">@</span><span class="main">[</span><span class="free">ts</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span> Abs_freelist <span class="free">ts</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flip_altsublist_adjacent_in_Q
        binrelchain_propcong_Cons_snoc<span class="main">[</span><span class="operator">of</span>
          <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ss</span><span class="main">.</span> Abs_freelist <span class="bound">ss</span> <span class="main">∈</span> Q"</span></span>
          <span class="quoted">flip_altsublist_adjacent</span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-alternating_S_no_flip"><span class="command">lemma</span></span> alternating_S_no_flip<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">∨</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span> <span class="main">-</span> sum_list <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>alternating_list <span class="main">(</span><span class="numeral">2</span><span class="main">*</span><span class="free">n</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"even <span class="free">n</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
          genset_order2_add uminus_sum_list_alternating_order2
          sum_list.append<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
          alternating_list_append mult_2
        <span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> less_add_order_eq_0_contra add_order_eq0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> alternating_sum_list_conv_nataction<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-exchange_alternating_not_in_alternating"><span class="command">lemma</span></span> exchange_alternating_not_in_alternating<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">∨</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> <span class="free">cs</span> <span class="main">=</span> <span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">@</span><span class="free">ys</span>"</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">xs</span><span class="main">@</span><span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gr0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">altnst</span></span> <span class="skolem"><span class="skolem">altnts</span></span> <span class="skolem"><span class="skolem">altmts</span></span> <span class="skolem"><span class="skolem">altkst</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altnst</span> <span class="main">=</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altnts</span> <span class="main">=</span> alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altmts</span> <span class="main">=</span> alternating_list <span class="skolem">m</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altkst</span> <span class="main">=</span> alternating_list <span class="skolem">k</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> altnst_def altmts_def n <span class="keyword1"><span class="command">have</span></span> altnmst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">altnst</span> <span class="main">=</span> <span class="free">s</span> <span class="main">#</span> <span class="skolem">altmts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> altnst_def <span class="keyword1"><span class="command">have</span></span> s_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> t_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> m altnmst altmts_def altkst_def <span class="keyword1"><span class="command">have</span></span> altnkst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">altnst</span> <span class="main">=</span> <span class="free">s</span> <span class="main">#</span> <span class="free">t</span> <span class="main">#</span> <span class="skolem">altkst</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> alternating_list_Suc_Cons <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> length <span class="free">xs</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> n altnts_def <span class="keyword1"><span class="command">have</span></span> flip<span class="main">:</span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="main">(</span><span class="skolem">altnts</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> length_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
            same_length_eq_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">altnts</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span><span class="main">@</span><span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">cs</span></span> <span class="quoted"><span class="free">ys</span></span><span class="main">]</span>
            alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> altnst_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">altnst</span> <span class="main">=</span> sum_list <span class="skolem">altnts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
            reduced_word_for_sum_list<span class="main">[</span><span class="operator">OF</span> flip<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> n assms<span class="main">(</span>2<span class="main">)</span> altnst_def altnts_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> alternating_S_no_flip<span class="main">[</span><span class="operator">OF</span> s_S t_S<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_snoc_Cons<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil1
      <span class="keyword1"><span class="command">from</span></span> Nil1<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> altnkst altnst_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ys</span> <span class="main">=</span> <span class="free">t</span> <span class="main">#</span> <span class="skolem">altkst</span> <span class="main">@</span> <span class="free">cs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> Nil1<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> t_S genset_order2_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
              contains_order2_nreduced<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altkst</span><span class="main">@</span><span class="free">cs</span>"</span></span><span class="main">]</span>
              reduced_word_for_imp_reduced_word
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Nil2 <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">)</span> altnst_def False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> length_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">altnst</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_alternating_list<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc_Cons <span class="skolem">us</span> <span class="skolem">u</span> <span class="skolem">z</span> <span class="skolem">zs</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> altnst_def
        <span class="keyword1"><span class="command">have</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">altnst</span> <span class="main">@</span> <span class="free">cs</span> <span class="main">=</span> <span class="skolem">us</span><span class="main">@</span><span class="main">[</span><span class="skolem">u</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="skolem">us</span><span class="main">@</span><span class="main">[</span><span class="skolem">u</span><span class="main">,</span><span class="skolem">z</span><span class="main">]</span><span class="main">@</span><span class="skolem">zs</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>1<span class="main">)</span> snoc_Cons<span class="main">(</span>1<span class="main">)</span> False altnst_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> take_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">altnst</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span> take_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span><span class="main">@</span><span class="main">[</span><span class="skolem">u</span><span class="main">,</span><span class="free">x</span><span class="main">,</span><span class="skolem">z</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">]</span>
              set_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
              alternating_list_alternates<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
              reduced_word_for_imp_reduced_word<span class="main">[</span><span class="operator">OF</span> 1<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
              s_S t_S genset_order2_add 
              contains_order2_nreduced<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">#</span><span class="skolem">us</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_alternating_list<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary facts on the word problem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The word problem seeks criteria for determining whether two words over the generator set represent
  the same element in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Here we establish one direction of the word problem, as well as a
  preliminary step toward the other direction.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> flip_altsublist_chain_sum_list <span class="main">=</span>
  flip_altsublist_chain_funcong_Cons_snoc<span class="main">[</span><span class="operator">OF</span> flip_altsublist_adjacent_sum_list_ball<span class="main">]</span>
<span class="comment1">― ‹This lemma represents one direction in the word problem: if a word in generators can be
transformed into another by a sequence of manipulations, each of which consists of replacing a
half-relator subword by its reversal, then the two words sum to the same element of <span class="antiquoted"><span class="antiquote">@{</span><span class="operator">term</span> <span class="quoted">W</span><span class="antiquote">}</span></span>.›</span>

<span class="keyword1" id="Coxeter-reduced_word_problem_eq_hd_step"><span class="command">lemma</span></span> reduced_word_problem_eq_hd_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">ss</span> <span class="bound">ts</span><span class="main">.</span> <span class="main">⟦</span>
                  S_length <span class="bound">y</span> <span class="main">&lt;</span> S_length <span class="free">w</span><span class="main">;</span> <span class="bound">y</span><span class="main">≠</span><span class="main">0</span><span class="main">;</span> S_reduced_for <span class="bound">y</span> <span class="bound">ss</span><span class="main">;</span> S_reduced_for <span class="bound">y</span> <span class="bound">ts</span>
                <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="bound">ss</span> <span class="main">#</span> <span class="bound">xss</span> <span class="main">@</span> <span class="main">[</span><span class="bound">ts</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     set_up<span class="main">:</span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span> <span class="main">#</span> <span class="bound">xss</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">#</span><span class="free">ts</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">=</span><span class="free">ts</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> set_up<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">a</span><span class="main">#</span><span class="free">ts</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists flip_altsublist_adjacent_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> sum_list <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> set_up<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="skolem">y</span> <span class="free">ss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_imp_reduced_word reduced_word_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y_def ss <span class="keyword1"><span class="command">have</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="skolem">y</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list<span class="main">[</span><span class="operator">OF</span> set_up<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          reduced_word_for_sum_list<span class="main">[</span><span class="operator">OF</span> set_up<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          reduced_word_for_eq_length<span class="main">[</span><span class="operator">OF</span> set_up<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> set_up<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
          reduced_word_for_lists<span class="main">[</span><span class="operator">OF</span> set_up<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduced_word_forI_compare<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> ss set_up<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S_length <span class="skolem">y</span> <span class="main">&lt;</span> S_length <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_length reduced_word_for_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ss ts reduced_word_for_0_imp_nil reduced_word_for_0_imp_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> step flip_altsublist_chain_map_Cons_grow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Preliminary facts related to the deletion condition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The deletion condition states that in a Coxeter system, every non-reduced word in the generating
  set can be shortened to an equivalent word by deleting some particular pair of letters. This
  condition is both necessary and sufficient for a group generated by elements of order two to be a
  Coxeter system. Here we establish some facts related to the deletion condition that are true in
  any group generated by elements of order two.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">ℋ</span> <span class="main">≡</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span>W<span class="main">.</span> lconjby <span class="bound">w</span> <span class="main">`</span> <span class="free">S</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹the set of reflections›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">lift_signed_lconjperm</span> <span class="main">≡</span> freeword_funlift signed_lconjpermutation"</span></span>

<span class="keyword1" id="Coxeter-lconjseq_reflections"><span class="command">lemma</span></span> lconjseq_reflections<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟹</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> ℋ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_subgroup_eq_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> lconjseq_snoc<span class="main">)</span>

<span class="keyword1" id="Coxeter-deletion'"><span class="command">lemma</span></span> deletion'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> distinct <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">@</span> <span class="bound">cs</span> <span class="main">∧</span>
      sum_list <span class="free">ss</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="bound">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>lconjseq <span class="skolem">ss</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> subset_inj_on<span class="main">[</span><span class="operator">OF</span> lconjby_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>lconjseq <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
            distinct_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"lconjby <span class="skolem">s</span>"</span></span><span class="main">]</span>
            genset_order2_add order2_hd_in_lconjseq_deletion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">algebra_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
      <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Coxeter-S_reduced_imp_distinct_lconjseq'"><span class="command">lemma</span></span> S_reduced_imp_distinct_lconjseq'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S_reduced <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"S_reduced <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
                  <span class="quoted"><span class="quoted">"sum_list <span class="free">ss</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deletion'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> ss decomp assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-S_reduced_imp_distinct_lconjseq"><span class="command">lemma</span></span> S_reduced_imp_distinct_lconjseq<span class="main">:</span> <span class="quoted"><span class="quoted">"S_reduced <span class="free">ss</span> <span class="main">⟹</span> distinct <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists S_reduced_imp_distinct_lconjseq' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>  

<span class="keyword1" id="Coxeter-permutation_lift_signed_lconjperm_eq_signed_list_lconjaction'"><span class="command">lemma</span></span> permutation_lift_signed_lconjperm_eq_signed_list_lconjaction'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"proper_signed_list <span class="free">xs</span> <span class="main">⟹</span> fst <span class="main">`</span> set <span class="free">xs</span> <span class="main">⊆</span> <span class="free">S</span> <span class="main">⟹</span>
    permutation <span class="main">(</span>lift_signed_lconjperm <span class="main">(</span>Abs_freeword <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      signed_list_lconjaction <span class="main">(</span>map fst <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_freeword <span class="main">(</span><span class="main">[]</span><span class="main">::</span><span class="tfree">'w</span> signed list<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'w</span> freeword<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zero_freeword.abs_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq freeword_funlift_0<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Abs_freeword_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
          binrelchain_Cons_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted">nflipped_signed</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
          bij_signed_lconjaction<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> genset_order2_add<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            plus_permutation.rep_eq freeword_funlift_add
            freeword_funlift_Abs_freeletter
            Abs_permutation_inverse uminus_permutation.rep_eq
            the_inv_signed_lconjaction_by_order2
            freeword_funlift_uminus_Abs_freeletter
          <span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-permutation_lift_signed_lconjperm_eq_signed_list_lconjaction"><span class="command">lemma</span></span> permutation_lift_signed_lconjperm_eq_signed_list_lconjaction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span>
    permutation <span class="main">(</span>lift_signed_lconjperm <span class="free">x</span><span class="main">)</span> <span class="main">=</span>
      signed_list_lconjaction <span class="main">(</span>map fst <span class="main">(</span>freeword <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> freeword FreeGroup_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> freeword_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
        permutation_lift_signed_lconjperm_eq_signed_list_lconjaction'
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-even_count_lconjseq_rev_relator"><span class="command">lemma</span></span> even_count_lconjseq_rev_relator<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> even <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="main">(</span>rev <span class="main">(</span>pair_relator_list <span class="free">s</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> even_count_lconjseq_alternating_order2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2_add add_order rev_pair_relator_list<span class="main">)</span>

<span class="keyword1" id="Coxeter-GroupByPresentationInducedFun_S_R_signed_lconjaction"><span class="command">lemma</span></span> GroupByPresentationInducedFun_S_R_signed_lconjaction<span class="main">:</span>
  <span class="quoted"><span class="quoted">"GroupByPresentationInducedFun <span class="free">S</span> P signed_lconjpermutation"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> GroupByPresentation_S_P<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ps</span> <span class="keyword3"><span class="command">assume</span></span> ps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ps</span><span class="main">∈</span>P"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">r</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> Abs_freeword <span class="skolem">ps</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ps <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span><span class="main">∈</span>P'"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> pair_relator_freeword <span class="skolem">s</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> relator_freewords <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> r st<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>lift_signed_lconjperm <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span>
              signed_list_lconjaction <span class="main">(</span>pair_relator_list <span class="skolem">s</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P'_FreeS
          permutation_lift_signed_lconjperm_eq_signed_list_lconjaction
          Abs_freelist_inverse<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pair_relator_list <span class="skolem">s</span> <span class="skolem">t</span>"</span></span><span class="main">]</span>
          map_fst_map_const_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted">True</span> <span class="quoted"><span class="quoted">"pair_relator_list <span class="skolem">s</span> <span class="skolem">t</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>lift_signed_lconjperm <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift_signed_lconjperm <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">x</span> <span class="main">=</span> id <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>freeword_funlift signed_lconjpermutation <span class="skolem">r</span> <span class="main">→</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">(</span>id <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 st<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> even_count_lconjseq_rev_relator genset_order2_add
              set_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span><span class="main">*</span>relfun <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">t</span></span><span class="main">]</span>
              signed_list_lconjaction_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"pair_relator_list <span class="skolem">s</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 signed_list_lconjaction_fst sum_list_pair_relator_list<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"permutation <span class="main">(</span><span class="main">0</span><span class="main">::</span><span class="tfree">'w</span> signed permutation<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>id<span class="main">::</span><span class="tfree">'w</span> signed <span class="main">⇒</span> <span class="tfree">'w</span> signed<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zero_permutation.rep_eq
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"lift_signed_lconjperm <span class="skolem">r</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> permutation_inject <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystem *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Coxeter-like systems with deletion›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we add the so-called deletion condition as an assumption, and explore its consequences.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition›</span></span>

<span class="keyword1"><span class="command">locale</span></span> PreCoxeterSystemWithDeletion <span class="main">=</span> PreCoxeterSystem <span class="quoted"><span class="free">S</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span><span class="main">::</span>group_add set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> deletion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> reduced_word <span class="free">S</span> <span class="free">ss</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">@</span> <span class="bound">cs</span> <span class="main">∧</span>
      sum_list <span class="free">ss</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="bound">cs</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Consequences of the deletion condition›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystemWithDeletion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-deletion_reduce"><span class="command">lemma</span></span> deletion_reduce<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> ssubseqs <span class="free">ss</span> <span class="main">∩</span> reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"S_reduced <span class="free">ss</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span>
          <span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> ssubseqs <span class="free">ss</span> <span class="main">∩</span> reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ssubseqs_refl<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> S_reduced <span class="free">ss</span> <span class="main">⟹</span>
        <span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> ssubseqs <span class="free">ss</span> <span class="main">∩</span> reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'w</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> xs<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ys</span><span class="main">.</span> length <span class="bound">ys</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">⟶</span> <span class="bound">ys</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟶</span> <span class="main">¬</span> S_reduced <span class="bound">ys</span>
        <span class="main">⟶</span> <span class="main">(</span><span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> ssubseqs <span class="bound">ys</span> <span class="main">∩</span> reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="bound">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S_reduced <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> xs<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">cs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> asbscs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">xs</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deletion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> ssubseqs <span class="skolem">xs</span> <span class="main">∩</span> reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"S_reduced <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> asbscs xs<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> delete2_ssubseqs <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> asbscs<span class="main">(</span>1<span class="main">)</span> xs<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">∈</span> ssubseqs <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span> <span class="main">∩</span>
                    reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> xs<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> asbscs<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> asbscs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> delete2_ssubseqs<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="skolem">cs</span></span> <span class="quoted"><span class="skolem">a</span></span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> ssubseqs_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> False
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span>
            <span class="main">∃</span><span class="bound">ts</span><span class="main">.</span> <span class="bound">ts</span> <span class="main">∈</span> ssubseqs <span class="free">ss</span> <span class="main">∩</span> reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-deletion_reduce'"><span class="command">lemma</span></span> deletion_reduce'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ts</span><span class="main">∈</span>reduced_words_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span><span class="main">.</span> set <span class="bound">ts</span> <span class="main">⊆</span> set <span class="free">ss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> deletion_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span> subseqs_powset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystemWithDeletion *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The exchange condition›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The exchange condition states that, given a reduced word in the generators, if prepending a
  letter to the word does not remain reduced, then the new word can be shortened to a word
  equivalent to the original one by deleting some letter other than the prepended one. Thus, one
  able to exchange some letter for the addition of a desired letter at the beginning of a word,
  without changing the elemented represented.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystemWithDeletion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-exchange"><span class="command">lemma</span></span> exchange<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="free">ss</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S_reduced <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">t</span> <span class="bound">as</span> <span class="bound">bs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="bound">t</span><span class="main">#</span><span class="bound">bs</span> <span class="main">∧</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="bound">as</span><span class="main">@</span><span class="bound">bs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ss_lists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">#</span><span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> del<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">#</span><span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">a</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">bs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">b</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
                <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">ss</span><span class="main">)</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deletion<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">#</span><span class="free">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">as</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> del <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> genset_order2_add ss_lists
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduced_word_forI_compare<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">d</span> <span class="skolem">ds</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> del assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> ss_lists reduced_word_for_imp_reduced_word
            reduced_word_for_minimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ss</span>"</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-reduced_head_imp_exchange"><span class="command">lemma</span></span> reduced_head_imp_exchange<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="free">cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">ds</span> <span class="bound">es</span><span class="main">.</span> <span class="free">cs</span> <span class="main">=</span> <span class="bound">ds</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">es</span> <span class="main">∧</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="bound">ds</span><span class="main">@</span><span class="bound">es</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> s_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S_reduced <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> not_reduced_word_for<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s_S reduced_word_for_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> add.assoc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> genset_order2_add
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">as</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">cs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="skolem"><span class="skolem">es</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">=</span> <span class="skolem">ds</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">es</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="skolem">ds</span><span class="main">@</span><span class="skolem">es</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> exchange<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystemWithDeletion *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹More on words in generators containing alternating subwords›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we explore more of the mechanics of manipulating words over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> that contain
  alternating subwords, in preparation of the word problem.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystemWithDeletion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-two_reduced_heads_imp_reduced_alt_step"><span class="command">lemma</span></span> two_reduced_heads_imp_reduced_alt_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">∨</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> <span class="free">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ds</span><span class="main">.</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span>alternating_list <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">t</span> <span class="free">s</span> <span class="main">@</span> <span class="bound">ds</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">altnst</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altnst</span> <span class="main">=</span> alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span> 
    <span class="keyword2"><span class="keyword">where</span></span> xxsys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">altnst</span> <span class="main">@</span> <span class="free">cs</span> <span class="main">=</span> <span class="skolem">xs</span><span class="main">@</span><span class="main">[</span><span class="skolem">x</span><span class="main">]</span><span class="main">@</span><span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="skolem">xs</span><span class="main">@</span><span class="skolem">ys</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_head_imp_exchange
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_cases_2Suc<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">with</span></span> xxsys<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> 1 <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> xxsys altnst_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">#</span><span class="free">cs</span>"</span></span><span class="main">]</span>
            reduced_word_for_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">#</span><span class="free">cs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>SucSuc <span class="skolem">k</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> xxsys altnst_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">≥</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exchange_alternating_not_in_alternating <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ds</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ds</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span> <span class="free">cs</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">#</span><span class="skolem">xs</span><span class="main">@</span><span class="skolem">ys</span> <span class="main">=</span> alternating_list <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">t</span> <span class="free">s</span> <span class="main">@</span> <span class="skolem">ds</span> <span class="main">@</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xxsys<span class="main">(</span>1<span class="main">)</span> altnst_def take_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span>"</span></span> <span class="quoted"><span class="skolem">altnst</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span>
            alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_alternating_list<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> xxsys<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-two_reduced_heads_imp_reduced_alt'"><span class="command">lemma</span></span> two_reduced_heads_imp_reduced_alt'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">∨</span> relfun <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">cs</span><span class="main">.</span>
          reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">)</span> <span class="main">∨</span>
          reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span>alternating_list <span class="free">n</span> <span class="free">t</span> <span class="free">s</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">)</span>
        <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0 <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order_add_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
          two_reduced_heads_imp_reduced_alt_step<span class="main">[</span>
            <span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> not_sym<span class="main"><span class="main">]</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span>
          <span class="main">]</span>
          two_reduced_heads_imp_reduced_alt_step<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-two_reduced_heads_imp_reduced_alt"><span class="command">lemma</span></span> two_reduced_heads_imp_reduced_alt<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span>pair_relator_halflist <span class="free">s</span> <span class="free">t</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">altst</span></span> <span class="skolem"><span class="skolem">altts</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altst</span> <span class="main">=</span> pair_relator_halflist <span class="free">s</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altts</span> <span class="main">=</span> pair_relator_halflist <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altst</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">∨</span>
                reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altts</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order_add_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span> two_reduced_heads_imp_reduced_alt'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> altst_def altts_def
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altts</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">⟹</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altst</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> reduced_word_for_lists<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
          flip_altsublist_adjacent_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> S_reduced_forI_flip_altsublist_adjacent
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_order_add_sym<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">cs</span><span class="main">.</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altst</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-two_reduced_heads_imp_nzero_relfun"><span class="command">lemma</span></span> two_reduced_heads_imp_nzero_relfun<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">≠</span><span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">s</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">t</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"relfun <span class="free">s</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"relfun <span class="free">s</span> <span class="free">t</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">altst</span></span> <span class="skolem"><span class="skolem">altts</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altst</span> <span class="main">=</span> alternating_list <span class="main">(</span>Suc <span class="main">(</span>S_length <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">s</span> <span class="free">t</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">altts</span> <span class="main">=</span> alternating_list <span class="main">(</span>Suc <span class="main">(</span>S_length <span class="free">w</span><span class="main">)</span><span class="main">)</span> <span class="free">t</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altst</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">∨</span>
            reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="skolem">altts</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> two_reduced_heads_imp_reduced_alt'<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> altst_def altts_def
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">altst</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">&gt;</span> S_length <span class="free">w</span>"</span></span>
          <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">altts</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span> <span class="main">&gt;</span> S_length <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> length_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> length_alternating_list<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystemWithDeletion *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The word problem›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Here we establish the other direction of the word problem for reduced words.›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystemWithDeletion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-reduced_word_problem_ConsCons_step"><span class="command">lemma</span></span> reduced_word_problem_ConsCons_step<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span> <span class="bound">ss</span> <span class="bound">ts</span><span class="main">.</span> <span class="main">⟦</span> S_length <span class="bound">y</span> <span class="main">&lt;</span> S_length <span class="free">w</span><span class="main">;</span> <span class="bound">y</span><span class="main">≠</span><span class="main">0</span><span class="main">;</span> reduced_word_for <span class="free">S</span> <span class="bound">y</span> <span class="bound">ss</span><span class="main">;</span>
            reduced_word_for <span class="free">S</span> <span class="bound">y</span> <span class="bound">ts</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="bound">ss</span> <span class="main">#</span> <span class="bound">xss</span> <span class="main">@</span> <span class="main">[</span><span class="bound">ts</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">≠</span><span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span><span class="main">#</span><span class="bound">xss</span><span class="main">@</span><span class="main">[</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> cs<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="main">(</span>pair_relator_halflist <span class="free">a</span> <span class="free">b</span> <span class="main">@</span> <span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> two_reduced_heads_imp_reduced_alt
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> pair_relator_halflist <span class="free">a</span> <span class="free">b</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> pair_relator_halflist <span class="free">b</span> <span class="free">a</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> a_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span><span class="free">S</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">#</span><span class="free">as</span>"</span></span><span class="main">]</span> reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">#</span><span class="free">bs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> rs_def us_def <span class="keyword1"><span class="command">have</span></span> midlink<span class="main">:</span> <span class="quoted"><span class="quoted">"flip_altsublist_adjacent <span class="skolem">rs</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order_add_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> flip_altsublist_adjacent_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"relfun <span class="free">a</span> <span class="free">b</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> two_reduced_heads_imp_nzero_relfun <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"relfun <span class="free">a</span> <span class="free">b</span> <span class="main">=</span> Suc <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not0_implies_Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">qs</span></span> <span class="skolem"><span class="skolem">vs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qs</span> <span class="main">=</span> alternating_list <span class="skolem">k</span> <span class="free">b</span> <span class="free">a</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> alternating_list <span class="skolem">k</span> <span class="free">a</span> <span class="free">b</span> <span class="main">@</span> <span class="skolem">cs</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> k rs_def us_def <span class="keyword1"><span class="command">have</span></span> rs'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> <span class="free">a</span> <span class="main">#</span> <span class="skolem">qs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> us'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">=</span> <span class="free">b</span> <span class="main">#</span> <span class="skolem">vs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> add_order_add_sym<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> alternating_list_Suc_Cons<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> cs rs_def rs'
    <span class="keyword1"><span class="command">have</span></span>  startlink<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">≠</span> <span class="skolem">qs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="bound">xss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_problem_eq_hd_step
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> rs_def cs us'
    <span class="keyword1"><span class="command">have</span></span>  endlink<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">≠</span> <span class="skolem">vs</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="skolem">us</span> <span class="main">#</span> <span class="bound">xss</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> midlink flip_altsublist_adjacent_sym
          S_reduced_forI_flip_altsublist_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">]</span>
          reduced_word_problem_eq_hd_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">=</span> <span class="skolem">qs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">=</span> <span class="skolem">vs</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> both
    <span class="keyword1"><span class="command">with</span></span> rs' us' <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> midlink <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> one
    <span class="keyword1"><span class="command">with</span></span> rs' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">us</span> <span class="main">#</span> <span class="skolem">xss</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> endlink midlink
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> other
    <span class="keyword1"><span class="command">from</span></span> other<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> startlink <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> other<span class="main">(</span>2<span class="main">)</span> us' startlink
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">xss</span><span class="main">@</span><span class="main">[</span><span class="skolem">rs</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> midlink binrelchain_snoc<span class="main">[</span><span class="operator">of</span> <span class="quoted">flip_altsublist_adjacent</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span><span class="main">#</span><span class="skolem">xss</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">from</span></span> neither<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> startlink
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> neither<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yss</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">rs</span><span class="main">,</span><span class="skolem">us</span><span class="main">]</span> <span class="main">@</span> <span class="skolem">yss</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">#</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> startlink midlink endlink
            binrelchain_join<span class="main">[</span><span class="operator">of</span> <span class="quoted">flip_altsublist_adjacent</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">a</span><span class="main">#</span><span class="free">as</span><span class="main">)</span><span class="main">#</span><span class="skolem">xss</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-reduced_word_problem"><span class="command">lemma</span></span> reduced_word_problem<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">w</span><span class="main">≠</span><span class="main">0</span><span class="main">;</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="free">ss</span><span class="main">;</span> reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="free">ts</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">xss</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="free">ss</span><span class="main">#</span><span class="bound">xss</span><span class="main">@</span><span class="main">[</span><span class="free">ts</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> measure_induct_rule<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"S_length"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">w</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">ts</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_lists_cases_Cons_Cons<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil1 <span class="keyword1"><span class="command">from</span></span> Nil1<span class="main">(</span>1<span class="main">)</span> less<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> Nil2 <span class="keyword1"><span class="command">from</span></span> Nil2<span class="main">(</span>2<span class="main">)</span> less<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ConsCons <span class="skolem">a</span> <span class="skolem">as</span> <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">=</span><span class="skolem">b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> less ConsCons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> reduced_word_problem_eq_hd_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">with</span></span> less ConsCons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> reduced_word_problem_ConsCons_step<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-reduced_word_letter_set"><span class="command">lemma</span></span> reduced_word_letter_set<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reduced_letter_set <span class="free">S</span> <span class="free">w</span> <span class="main">=</span> set <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_0_imp_nil<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span> reduced_letter_set_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"set <span class="free">ss</span> <span class="main">⊆</span> reduced_letter_set <span class="free">S</span> <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"reduced_letter_set <span class="free">S</span> <span class="free">w</span> <span class="main">⊆</span> set <span class="free">ss</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> reduced_letter_set <span class="free">S</span> <span class="free">w</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="free">w</span> <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> False assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">ss</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span> reduced_word_problem<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span>
              flip_altsublist_chain_set
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystemWithDeletion *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Special subgroups and cosets›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Recall that special subgroups are those generated by subsets of the generating set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Here we show that the presence of the deletion condition guarantees that the collection of
  special subgroups and their left cosets forms a poset under reverse inclusion that satisfies the
  necessary properties to ensure that the poset of simplices in the associated simplicial complex
  is isomorphic to this poset of special cosets.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystemWithDeletion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-special_subgroup_int_S"><span class="command">lemma</span></span> special_subgroup_int_S<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">=</span> <span class="free">T</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">∩</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">∩</span> <span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">∈</span> lists <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> sum_list <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> special_subgroup_eq_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> us<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="main">(</span>sum_list <span class="skolem">ts</span><span class="main">)</span> <span class="skolem">us</span>"</span></span> <span class="quoted"><span class="quoted">"set <span class="skolem">us</span> <span class="main">⊆</span> set <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> deletion_reduce'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> no_zero_genset ts<span class="main">(</span>2<span class="main">)</span> t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span> reduced_word_for_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span>
            reduced_word_for_imp_reduced_word<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span> el_reduced<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> us ts <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="free">T</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span> <span class="main">_</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">us</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">∩</span> <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> genby_genset_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-special_subgroup_inj"><span class="command">lemma</span></span> special_subgroup_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on genby <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_subgroup_int_S inj_on_inverseI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">W</span><span class="main">.</span> <span class="bound">W</span><span class="main">∩</span><span class="free">S</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-special_subgroup_genby_subset_ordering_iso"><span class="command">lemma</span></span> special_subgroup_genby_subset_ordering_iso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subset_ordering_iso <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span> genby"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> genby_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> special_subgroup_inj<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> genby <span class="main">`</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> genby <span class="main">`</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">⊆</span><span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> XY<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">TX</span></span> <span class="skolem"><span class="skolem">TY</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">TX</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">TX</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">TY</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">TY</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span> genby <span class="skolem">X</span> <span class="main">=</span> <span class="skolem">X</span><span class="main">∩</span><span class="free">S</span>"</span></span>
        <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span> genby <span class="skolem">Y</span> <span class="main">=</span> <span class="skolem">Y</span><span class="main">∩</span><span class="free">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> special_subgroup_inj<span class="main">]</span> special_subgroup_int_S
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> XY<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span> genby <span class="skolem">X</span> <span class="main">⊆</span> the_inv_into <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span> genby <span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> special_subgroup_genby_rev_mono
  <span class="main">=</span> OrderingSetIso.rev_ordsetmap<span class="main">[</span><span class="operator">OF</span> special_subgroup_genby_subset_ordering_iso<span class="main">]</span>

<span class="keyword1" id="Coxeter-special_subgroup_word_length"><span class="command">lemma</span></span> special_subgroup_word_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"word_length <span class="free">T</span> <span class="free">w</span> <span class="main">=</span> S_length <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">∈</span> lists <span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> sum_list <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_subgroup_eq_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">us</span> <span class="main">∈</span> ssubseqs <span class="skolem">ts</span>"</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deletion_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> ts<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span>     ssubseqs_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ts</span></span><span class="main">]</span> reduced_word_for_sum_list
              is_arg_min_size_subprop<span class="main">[</span><span class="operator">of</span> <span class="quoted">length</span> <span class="quoted"><span class="quoted">"word_for <span class="free">S</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="skolem">us</span></span> <span class="quoted"><span class="quoted">"word_for <span class="free">T</span> <span class="free">w</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> reduced_word_for_def word_length_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-S_subset_reduced_imp_S_reduced"><span class="command">lemma</span></span> S_subset_reduced_imp_S_reduced<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span> <span class="main">⟹</span> reduced_word <span class="free">T</span> <span class="free">ts</span> <span class="main">⟹</span> S_reduced <span class="free">ts</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="main">_</span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span>
        reduced_word_for_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ts</span>"</span></span> <span class="quoted"><span class="free">ts</span></span><span class="main">]</span> special_subgroup_eq_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
        special_subgroup_word_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ts</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reduced_word_forI_length<span class="main">)</span>

<span class="keyword1" id="Coxeter-smallest_genby"><span class="command">lemma</span></span> smallest_genby<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">∈</span><span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">⟹</span> reduced_letter_set <span class="free">S</span> <span class="free">w</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_S_reduced_word_for_arg_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span>
        reduced_word_for_imp_reduced_word<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
        S_subset_reduced_imp_S_reduced<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="quoted">"arg_min length <span class="main">(</span>word_for <span class="free">T</span> <span class="free">w</span><span class="main">)</span>"</span></span><span class="main">]</span>
        reduced_word_for_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span><span class="main">]</span> reduced_word_for_lists reduced_word_letter_set
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-special_cosets_below_in"><span class="command">lemma</span></span> special_cosets_below_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"𝒫<span class="main">.⊇</span><span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">R</span><span class="main">∈</span><span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="free">T</span><span class="main">.</span> <span class="main">{</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> 𝒫<span class="main">.⊇</span><span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊇</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">w'</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> A<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">R</span><span class="main">∈</span><span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="free">T</span><span class="main">.</span> <span class="main">{</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_subgroup_imp_eq_reps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="skolem">w'</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span>
          lcoset_eq_reps_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
          special_subgroup_genby_rev_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">R</span><span class="main">∈</span><span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="free">T</span><span class="main">.</span> <span class="main">{</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">" <span class="skolem">R</span> <span class="main">∈</span> <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="free">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">⊇</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_mono elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">∈</span> special_cosets <span class="main">.⊇</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> special_cosetsI <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> special_coset_inj
  <span class="main">=</span> comp_inj_on<span class="main">[</span><span class="operator">OF</span> special_subgroup_inj<span class="main">,</span> <span class="operator">OF</span> inj_inj_on<span class="main">,</span> <span class="operator">OF</span> lcoset_inj_on<span class="main">]</span>

<span class="keyword1" id="Coxeter-special_coset_eq_imp_eq_gensets"><span class="command">lemma</span></span> special_coset_eq_imp_eq_gensets<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">T1</span><span class="main">∈</span>Pow <span class="free">S</span><span class="main">;</span> <span class="free">T2</span><span class="main">∈</span>Pow <span class="free">S</span><span class="main">;</span> <span class="free">w1</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T1</span><span class="main">⟩</span> <span class="main">=</span> <span class="free">w2</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T2</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">T1</span><span class="main">=</span><span class="free">T2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> set_plus_rearrange2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">w1</span>"</span></span> <span class="quoted"><span class="free">w1</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T1</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
        set_plus_rearrange2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">w1</span>"</span></span> <span class="quoted"><span class="free">w2</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T2</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
        genby_lcoset_subgroup_imp_eq_reps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="free">T1</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">w1</span><span class="main">+</span><span class="free">w2</span>"</span></span> <span class="quoted"><span class="free">T2</span></span><span class="main">]</span>
        inj_onD<span class="main">[</span><span class="operator">OF</span> special_subgroup_inj<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-special_subgroup_special_coset_subset_ordering_iso"><span class="command">lemma</span></span> special_subgroup_special_coset_subset_ordering_iso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subset_ordering_iso <span class="main">(</span>genby <span class="main">`</span> Pow <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="bound">a</span> <span class="main">⊆</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="bound">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>genby <span class="main">`</span> Pow <span class="free">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lcoset_inj_on inj_inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">∈</span> <span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">`</span> genby <span class="main">`</span> Pow <span class="free">S</span> <span class="main">⟹</span>
          <span class="bound">b</span> <span class="main">∈</span> <span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">`</span> genby <span class="main">`</span> Pow <span class="free">S</span> <span class="main">⟹</span>
          <span class="bound">a</span> <span class="main">⊆</span> <span class="bound">b</span> <span class="main">⟹</span>
          the_inv_into <span class="main">(</span>genby <span class="main">`</span> Pow <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="bound">a</span> <span class="main">⊆</span>
            the_inv_into <span class="main">(</span>genby <span class="main">`</span> Pow <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="bound">b</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> ab <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> <span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">`</span> genby <span class="main">`</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">`</span> genby <span class="main">`</span> Pow <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>  a_b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">⊆</span><span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> ab <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Ta</span></span> <span class="skolem"><span class="skolem">Tb</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ta</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">Ta</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tb</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">Tb</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> a_b
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"the_inv_into <span class="main">(</span>genby <span class="main">`</span> Pow <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">a</span> <span class="main">⊆</span>
              the_inv_into <span class="main">(</span>genby <span class="main">`</span> Pow <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="skolem">b</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> the_inv_into_f_eq<span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> lcoset_eq_reps_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">Ta</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="skolem">Tb</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-special_coset_subset_ordering_iso"><span class="command">lemma</span></span> special_coset_subset_ordering_iso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subset_ordering_iso <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">∘</span> genby<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_subgroup_genby_subset_ordering_iso
        special_subgroup_special_coset_subset_ordering_iso
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OrderingSetIso.iso_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> special_coset_subset_rev_mono <span class="main">=</span>
  OrderingSetIso.rev_ordsetmap<span class="main">[</span><span class="operator">OF</span> special_coset_subset_ordering_iso<span class="main">]</span>

<span class="keyword1" id="Coxeter-special_coset_below_in_subset_ordering_iso"><span class="command">lemma</span></span> special_coset_below_in_subset_ordering_iso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"subset_ordering_iso <span class="main">(</span><span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">∘</span> genby<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_coset_subset_ordering_iso <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> OrderingSetIso.iso_subset<span class="main">)</span>

<span class="keyword1" id="Coxeter-special_coset_below_in_supset_ordering_iso"><span class="command">lemma</span></span> special_coset_below_in_supset_ordering_iso<span class="main">:</span>
  <span class="quoted"><span class="quoted">"OrderingSetIso <span class="main">(⊇)</span> <span class="main">(⊃)</span> <span class="main">(⊇)</span> <span class="main">(⊃)</span> <span class="main">(</span><span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="free">T</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span> <span class="main">∘</span> genby<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_coset_below_in_subset_ordering_iso OrderingSetIso.iso_dual <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-special_coset_pseudominimals"><span class="command">lemma</span></span> special_coset_pseudominimals<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"supset_pseudominimal_in 𝒫 <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span>W <span class="main">∧</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span>𝒫"</span></span> <span class="keyword1"><span class="command">using</span></span> supset_pseudominimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> wT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">=</span><span class="free">S</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> wT<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> genby_lcoset_el_reduce supset_pseudominimal_ne_bottom
            special_cosets_bottom
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> wT<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> s<span class="main">(</span>2<span class="main">)</span> wT<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊆</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> genby_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms wT<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">X</span> <span class="main">⊂</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> special_cosetsI<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
            supset_pseudominimal_inD2<span class="main">[</span><span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
            lcoset_eq_reps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">S</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
            inj_onD<span class="main">[</span><span class="operator">OF</span> special_subgroup_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> special_cosets_bottom genby_lcoset_el_reduce<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wT<span class="main">(</span>1<span class="main">)</span> s<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-special_coset_pseudominimal_in_below_in"><span class="command">lemma</span></span> special_coset_pseudominimal_in_below_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"supset_pseudominimal_in <span class="main">(</span>𝒫<span class="main">.⊇</span><span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="free">T</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_has_bottom special_cosetsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
          supset_has_bottom_pseudominimal_in_below_in
          special_coset_pseudominimals
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">⊇</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supset_pseudominimal_inD1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> vs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_subgroup_imp_eq_reps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> X assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">⊆</span> <span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosetsI special_coset_subset_rev_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> vs<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-exclude_one_is_pseudominimal"><span class="command">lemma</span></span> exclude_one_is_pseudominimal<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"supset_pseudominimal_in 𝒫 <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> supset_pseudominimal_inI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> special_cosetsI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> W"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span> <span class="main">≠</span> W"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_el_reduce<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> lcoset_eq_reps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="main">_</span> <span class="quoted">W</span><span class="main">]</span> 
          inj_onD<span class="main">[</span><span class="operator">OF</span> special_subgroup_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span> <span class="main">≠</span> supset_bottom 𝒫"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_bottom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⊂</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">R</span><span class="main">∈</span><span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="main">{</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="bound">R</span><span class="main">⟩</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> subst<span class="main">[</span><span class="operator">OF</span> special_cosets_below_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">A</span><span class="main">.</span> <span class="skolem">X</span><span class="main">∈</span><span class="bound">A</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">∈</span> <span class="main">(</span>Pow <span class="free">S</span><span class="main">)</span><span class="main">.⊇</span><span class="main">(</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> R<span class="main">(</span>2<span class="main">)</span> X<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">≠</span> <span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> R<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span><span class="main">=</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> R<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> supset_bottom 𝒫"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_el_reduce special_cosets_bottom <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-exclude_one_is_pseudominimal_in_below_in"><span class="command">lemma</span></span> exclude_one_is_pseudominimal_in_below_in<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">w</span><span class="main">∈</span>W<span class="main">;</span> <span class="free">T</span><span class="main">∈</span>Pow <span class="free">S</span><span class="main">;</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span><span class="main">-</span><span class="free">T</span> <span class="main">⟧</span> <span class="main">⟹</span>
    supset_pseudominimal_in <span class="main">(</span>𝒫<span class="main">.⊇</span><span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_cosets_has_bottom special_cosetsI
        exclude_one_is_pseudominimal<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
        genby_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">]</span>
        supset_has_bottom_pseudominimal_in_below_inI<span class="main">[</span>
          <span class="operator">of</span> <span class="quoted">𝒫</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-glb_special_subset_coset"><span class="command">lemma</span></span> glb_special_subset_coset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   wTT'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span> W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T'</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">≡</span> <span class="free">T</span> <span class="main">∪</span> <span class="free">T'</span> <span class="main">∪</span> reduced_letter_set <span class="free">S</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"supset_glbound_in_of 𝒫 <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> supset_glbound_in_ofI<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> wTT'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> U <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span> <span class="main">∈</span> 𝒫"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_letter_set_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> special_subgroup_special_coset <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"supset_lbound_of <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span><span class="main">)</span> <span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> supset_lbound_ofI<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> U <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> genby_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span> <span class="main">⊆</span> <span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> wTT'<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">w</span> <span class="main">+</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> wTT'<span class="main">(</span>1<span class="main">)</span> U <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_genby_S_reduced_letter_set genby_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span>
              genby_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T'</span></span> <span class="quoted"><span class="free">U</span></span><span class="main">]</span> genby_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">U</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">next</span></span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"supset_lbound_of <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> vR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">v</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> X'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊇</span> <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊇</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supset_lbound_of_def<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">X</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X'<span class="main">(</span>1<span class="main">)</span> vR<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_0_closed genby_lcoset_el_reduce0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> X'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span><span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> genby_0_closed lcoset_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">T'</span> <span class="main">⊆</span> <span class="skolem">R</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
    <span class="operator">rule</span> special_subgroup_genby_rev_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> wTT'<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> vR<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> subsetI
  <span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> X'<span class="main">(</span>2<span class="main">)</span> R <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">⟨</span><span class="skolem">R</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span>"</span></span><span class="main">]</span> w genby_uminus_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span>"</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">+</span><span class="skolem">x</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> X'<span class="main">(</span>1<span class="main">)</span> wTT'<span class="main">(</span>2<span class="main">)</span> vR<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span><span class="free">U</span><span class="main">⟩</span><span class="main">⊆</span><span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_subgroup_genby_rev_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">T</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span> w smallest_genby U R
          genby_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-glb_special_subset_coset_ex"><span class="command">lemma</span></span> glb_special_subset_coset_ex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span> W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">T'</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">.</span> supset_glbound_in_of 𝒫 <span class="main">⟨</span><span class="free">T</span><span class="main">⟩</span> <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">T'</span><span class="main">⟩</span><span class="main">)</span> <span class="bound">B</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     glb_special_subset_coset<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-special_cosets_have_glbs"><span class="command">lemma</span></span> special_cosets_have_glbs<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span><span class="main">∈</span>𝒫"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">B</span><span class="main">.</span> supset_glbound_in_of 𝒫 <span class="free">X</span> <span class="free">Y</span> <span class="bound">B</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">wx</span></span> <span class="skolem"><span class="skolem">Tx</span></span> <span class="skolem"><span class="skolem">wy</span></span> <span class="skolem"><span class="skolem">Ty</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wx</span> <span class="main">∈</span> W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Tx</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">wx</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">Tx</span><span class="main">⟩</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">wy</span> <span class="main">∈</span> W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ty</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">=</span> <span class="skolem">wy</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">Ty</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> Y<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"supset_glbound_in_of 𝒫 <span class="main">⟨</span><span class="skolem">Tx</span><span class="main">⟩</span> <span class="main">(</span><span class="main">(</span><span class="main">-</span><span class="skolem">wx</span><span class="main">+</span><span class="skolem">wy</span><span class="main">)</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">Ty</span><span class="main">⟩</span><span class="main">)</span> <span class="skolem">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_uminus_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">wx</span></span><span class="main">]</span> glb_special_subset_coset_ex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> Y<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"supset_glbound_in_of 𝒫 <span class="free">X</span> <span class="free">Y</span> <span class="main">(</span><span class="skolem">wx</span> <span class="keyword1">+o</span> <span class="skolem">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> supset_glbound_in_of_lcoset_shift<span class="main">[</span><span class="operator">OF</span> A<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">wx</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> set_plus_rearrange2 special_cosets_lcoset_shift<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystemWithDeletion *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Coxeter systems›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale definition and transfer from the associated free group›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Now we consider groups generated by elements of order two with an additional assumption to ensure
  that the natural correspondence between the group <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and the group presentation on the
  generating set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and its relations is bijective. Below, such groups will be shown to
  satisfy the deletion condition.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> CoxeterSystem <span class="main">=</span> PreCoxeterSystem <span class="quoted"><span class="free">S</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span>      <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span><span class="main">::</span>group_add set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> induced_id_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on induced_id G"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> PreCoxeterSystem<span class="main">)</span> CoxeterSystemI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span><span class="main">∈</span>G <span class="main">⟹</span> induced_id <span class="bound">g</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="bound">g</span><span class="main">=</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"CoxeterSystem <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"GroupIso G induced_id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> GroupWithGeneratorsRelators_S_R
          GroupWithGeneratorsRelators.induced_id_hom_surj<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> GroupHom.isoI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"inj_on induced_id G"</span></span> <span class="keyword1"><span class="command">using</span></span> GroupIso.inj_on <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">context</span></span> CoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">inv_induced_id</span> <span class="main">≡</span> GroupPresentation.inv_induced_id <span class="free">S</span> R"</span></span>

<span class="keyword1" id="Coxeter-GroupPresentation_S_R"><span class="command">lemma</span></span> GroupPresentation_S_R<span class="main">:</span> <span class="quoted"><span class="quoted">"GroupPresentation <span class="free">S</span> R"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span>
        <span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> GroupWithGeneratorsRelators_S_R<span class="main"><span class="keyword3">,</span></span>
        <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> induced_id_inj
      <span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> inv_induced_id_sum_list <span class="main">=</span>
  GroupPresentation.inv_induced_id_sum_list_S<span class="main">[</span><span class="operator">OF</span> GroupPresentation_S_R<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context CoxeterSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The deletion condition is necessary›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Call an element of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">W</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> a reflection if it is a conjugate of a generating element (and so
  is also of order two). Here we use the action of words over <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> on such reflections to show
  that Coxeter systems satisfy the deletion condition.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> CoxeterSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">induced_signed_lconjperm</span> <span class="main">≡</span>
  GroupByPresentationInducedFun.induced_hom <span class="free">S</span> P signed_lconjpermutation"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">flipped_reflections</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> <span class="main">⇒</span> <span class="tfree">'w</span> set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">flipped_reflections</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">≡</span>
          <span class="main">{</span><span class="bound"><span class="bound">t</span></span><span class="main">∈</span>ℋ<span class="main">.</span> induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">→</span>
            <span class="main">(</span><span class="bound">t</span><span class="main">,</span>True<span class="main">)</span> <span class="main">=</span> <span class="main">(</span>rconjby <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="bound">t</span><span class="main">,</span> False<span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Coxeter-induced_signed_lconjperm_inv_induced_id_sum_list"><span class="command">lemma</span></span> induced_signed_lconjperm_inv_induced_id_sum_list<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
          sum_list <span class="main">(</span>map signed_lconjpermutation <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        inv_induced_id_sum_list Abs_freelist_in_FreeGroup
        GroupByPresentationInducedFun.induced_hom_Abs_freelist_conv_sum_list<span class="main"><span class="main">[</span></span>
          <span class="operator">OF</span> GroupByPresentationInducedFun_S_R_signed_lconjaction
        <span class="main"><span class="main">]</span></span>
      <span class="main">)</span>

<span class="keyword1" id="Coxeter-induced_signed_eq_lconjpermutation"><span class="command">lemma</span></span> induced_signed_eq_lconjpermutation<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span>
    permutation <span class="main">(</span>induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      signed_list_lconjaction <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span>sum_list <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_signed_lconjperm_inv_induced_id_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
          zero_permutation.rep_eq
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
            signed_lconjpermutation <span class="skolem">s</span> <span class="main">+</span> sum_list <span class="main">(</span>map signed_lconjpermutation <span class="skolem">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_signed_lconjperm_inv_induced_id_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span>sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      permutation <span class="main">(</span>signed_lconjpermutation <span class="skolem">s</span><span class="main">)</span> <span class="main">∘</span>
        permutation <span class="main">(</span>induced_signed_lconjperm <span class="main">(</span>inv_induced_id <span class="main">(</span>sum_list <span class="skolem">ss</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> plus_permutation.rep_eq induced_signed_lconjperm_inv_induced_id_sum_list
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_signed_lconjaction<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span> Abs_permutation_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flipped_reflections_odd_lconjseq"><span class="command">lemma</span></span> flipped_reflections_odd_lconjseq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span><span class="main">∈</span>ℋ<span class="main">.</span> odd <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"snd <span class="main">(</span>signed_list_lconjaction <span class="main">(</span>rev <span class="free">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span>True<span class="main">)</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flipped_reflections_def genset_order2_add uminus_sum_list_order2
          induced_signed_eq_lconjpermutation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span><span class="main">∈</span>ℋ<span class="main">.</span> odd <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms flipped_reflections_def genset_order2_add
          signed_list_lconjaction_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">ss</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> t<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">t</span></span><span class="main">∈</span>ℋ<span class="main">.</span> odd <span class="main">(</span>count_list <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span> <span class="bound">t</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"signed_list_lconjaction <span class="main">(</span>rev <span class="free">ss</span><span class="main">)</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span>True<span class="main">)</span> <span class="main">=</span>
            <span class="main">(</span>rconjby <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="skolem">t</span><span class="main">,</span> False<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genset_order2_add signed_list_lconjaction_snd<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">ss</span>"</span></span><span class="main">]</span>
          signed_list_lconjaction_fst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">ss</span>"</span></span><span class="main">]</span>
          uminus_sum_list_order2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> t assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_signed_eq_lconjpermutation<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"rev <span class="free">ss</span>"</span></span><span class="main">]</span> genset_order2_add
          uminus_sum_list_order2 flipped_reflections_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flipped_reflections_in_lconjseq"><span class="command">lemma</span></span> flipped_reflections_in_lconjseq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span> <span class="main">⟹</span> flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> flipped_reflections_odd_lconjseq odd_n0 count_notin<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"lconjseq <span class="free">ss</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-flipped_reflections_distinct_lconjseq_eq_lconjseq"><span class="command">lemma</span></span> flipped_reflections_distinct_lconjseq_eq_lconjseq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">⊆</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> flipped_reflections_in_lconjseq <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">⊇</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_list <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span> <span class="skolem">t</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
       <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> distinct_count_list<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> flipped_reflections_odd_lconjseq lconjseq_reflections
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-flipped_reflections_reduced_eq_lconjseq"><span class="command">lemma</span></span> flipped_reflections_reduced_eq_lconjseq<span class="main">:</span>
  <span class="quoted"><span class="quoted">"S_reduced <span class="free">ss</span> <span class="main">⟹</span> flipped_reflections <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>lconjseq <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> S_reduced_imp_distinct_lconjseq
        flipped_reflections_distinct_lconjseq_eq_lconjseq
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-card_flipped_reflections"><span class="command">lemma</span></span> card_flipped_reflections<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>flipped_reflections <span class="free">w</span><span class="main">)</span> <span class="main">=</span> S_length <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> arg_min length <span class="main">(</span>word_for <span class="free">S</span> <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"S_reduced_for <span class="free">w</span> <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_S_reduced_word_for_arg_min <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> reduced_word_for_sum_list flipped_reflections_reduced_eq_lconjseq
          S_reduced_imp_distinct_lconjseq distinct_card length_lconjseq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span>
          reduced_word_for_length
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context CoxeterSystem *)</span>

<span class="keyword1"><span class="command">sublocale</span></span> CoxeterSystem <span class="main">&lt;</span> PreCoxeterSystemWithDeletion
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ss</span> <span class="keyword3"><span class="command">assume</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> S_reduced <span class="skolem">ss</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> sum_list <span class="skolem">ss</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ss<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>lconjseq <span class="skolem">ss</span><span class="main">)</span> <span class="main">⟹</span> card <span class="main">(</span>flipped_reflections <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            flipped_reflections_distinct_lconjseq_eq_lconjseq distinct_card
            length_lconjseq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> w_def ss <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ss</span> <span class="main">&gt;</span> S_length <span class="skolem">w</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> word_length_lt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> w_def ss<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>flipped_reflections <span class="skolem">w</span><span class="main">)</span> <span class="main">=</span> S_length <span class="skolem">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_subgroup_eq_sum_list card_flipped_reflections <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> distinct <span class="main">(</span>lconjseq <span class="skolem">ss</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> w_def ss
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">cs</span><span class="main">.</span> <span class="skolem">ss</span> <span class="main">=</span> <span class="bound">as</span> <span class="main">@</span> <span class="main">[</span><span class="bound">a</span><span class="main">]</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">b</span><span class="main">]</span> <span class="main">@</span> <span class="bound">cs</span> <span class="main">∧</span>
            sum_list <span class="skolem">ss</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="bound">as</span> <span class="main">@</span> <span class="bound">bs</span> <span class="main">@</span> <span class="bound">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> deletion'
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The deletion condition is sufficient›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Now we come full circle and show that a pair consisting of a group and a generating set of
  order-two elements that satisfies the deletion condition affords a presentation that makes it a
  Coxeter system.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> PreCoxeterSystemWithDeletion
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-reducible_by_flipping"><span class="command">lemma</span></span> reducible_by_flipping<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">¬</span> S_reduced <span class="free">ss</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">xss</span> <span class="bound">as</span> <span class="bound">t</span> <span class="bound">bs</span><span class="main">.</span> flip_altsublist_chain <span class="main">(</span><span class="free">ss</span> <span class="main">#</span> <span class="bound">xss</span> <span class="main">@</span> <span class="main">[</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">t</span><span class="main">,</span><span class="bound">t</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"S_reduced <span class="skolem">ss</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> sum_list <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> ss_red_w<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="skolem">w</span> <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="keyword2"><span class="keyword">where</span></span> asbs<span class="main">:</span> <span class="quoted"><span class="quoted">"reduced_word_for <span class="free">S</span> <span class="skolem">w</span> <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span> exchange <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> asbs <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> reduced_word_for_0_imp_nil <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="skolem">ss</span> <span class="main">#</span> <span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ss_red_w asbs reduced_word_problem <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span>
              <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span><span class="main">(#)</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="main">[]</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span><span class="main">]</span>
            <span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> flip_altsublist_chain_map_Cons_grow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">bs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span>
              <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span> <span class="main">#</span> map <span class="main">(</span><span class="main">(#)</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">as</span><span class="main">)</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">]</span>
            <span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip_altsublist_chain_map_Cons_grow
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nil_reduced_word_for_0<span class="main">)</span>

<span class="keyword1" id="Coxeter-freeliftid_kernel'"><span class="command">lemma</span></span> freeliftid_kernel'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> sum_list <span class="free">ss</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> Abs_freelist <span class="free">ss</span> <span class="main">∈</span> Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> length_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ss</span>
  <span class="keyword3"><span class="command">assume</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">ts</span><span class="main">.</span> length <span class="bound">ts</span> <span class="main">&lt;</span> length <span class="skolem">ss</span> <span class="main">⟶</span> <span class="bound">ts</span> <span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟶</span>
                sum_list <span class="bound">ts</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span> Abs_freelist <span class="bound">ts</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> set_up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ss</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="skolem">ss</span> <span class="main">∈</span> Q"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">=</span><span class="main">[]</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> genby_0_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="bound">w</span><span class="main">∈</span>FreeGroup <span class="free">S</span><span class="main">.</span> lconjby <span class="bound">w</span> <span class="main">`</span> P'"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_freeword.abs_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> set_up <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xss</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">bs</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> xss<span class="main">:</span> <span class="quoted"><span class="quoted">"flip_altsublist_chain <span class="main">(</span><span class="skolem">ss</span> <span class="main">#</span> <span class="skolem">xss</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list_zero_nreduced reducible_by_flipping<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> set_up
      <span class="keyword1"><span class="command">have</span></span>  astbs<span class="main">:</span>  <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> length <span class="skolem">ss</span>"</span></span>
                    <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span>
                    <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> flip_altsublist_chain_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">xss</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span><span class="main">]</span>
            flip_altsublist_chain_sum_list<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">xss</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span><span class="main">]</span>
            flip_altsublist_chain_lists<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quoted"><span class="skolem">xss</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> listsS<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span><span class="main">∈</span>lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> astbs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">as</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">t</span> <span class="main">+</span> <span class="skolem">t</span> <span class="main">+</span> sum_list <span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> astbs<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> listsS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2_add<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">ss</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> astbs<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span> <span class="main">∈</span> lists <span class="free">S</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> listsS<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span> <span class="keyword1"><span class="command">using</span></span> step <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="skolem">as</span> <span class="main">+</span> pair_relator_freeword <span class="skolem">t</span> <span class="skolem">t</span> <span class="main">+</span>
            <span class="main">(</span><span class="main">-</span> Abs_freelist <span class="skolem">as</span> <span class="main">+</span> <span class="main">(</span>Abs_freelist <span class="skolem">as</span> <span class="main">+</span> Abs_freelist <span class="skolem">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> listsS<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> lconjby_Abs_freelist_relator_freeword<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">as</span></span><span class="main">]</span>
            genby_add_closed
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_freelist_append<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> add.assoc<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Abs_freelist <span class="skolem">as</span> <span class="main">+</span> Abs_freelist <span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span> <span class="main">+</span> Abs_freelist <span class="skolem">bs</span> <span class="main">∈</span> Q"</span></span>
      <span class="keyword1"><span class="command">using</span></span> listsS<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> S_relator_freeword Abs_freeletter_add<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Abs_freelist_append_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="skolem">bs</span></span><span class="main">]</span>
            rev_flip_altsublist_chain<span class="main">[</span><span class="operator">OF</span> xss<span class="main">]</span>
            flip_altsublist_chain_G_in_Q<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"rev <span class="skolem">xss</span>"</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-freeliftid_kernel"><span class="command">lemma</span></span> freeliftid_kernel<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"freeliftid <span class="free">c</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">c</span><span class="main">∈</span>Q"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"freeliftid <span class="main">(</span>Abs_freeword <span class="main">(</span>freeword <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> freeword_inverse<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span>map fst <span class="main">(</span>freeword <span class="free">c</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> FreeGroup_def freeword freeliftid_Abs_freeword_conv_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> FreeGroup_def freeliftid_kernel'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>freeword <span class="free">c</span><span class="main">)</span>"</span></span><span class="main">]</span>
          Q_freelist_freeword
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-induced_id_kernel"><span class="command">lemma</span></span> induced_id_kernel<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">c</span> <span class="main">∈</span> FreeGroup <span class="free">S</span> <span class="main">⟹</span> induced_id <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span><span class="free">c</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">c</span><span class="main">∈</span>Q"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
        freeliftid_kernel
        GroupByPresentationInducedFun.induced_hom_equality<span class="main"><span class="main">[</span></span>
          <span class="operator">OF</span> GroupByPresentationInducedFun_S_P_id
        <span class="main"><span class="main">]</span></span>
      <span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> CoxeterSystem<span class="main">:</span> <span class="quoted"><span class="quoted">"CoxeterSystem <span class="free">S</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> CoxeterSystemI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span>G"</span></span> <span class="quoted"><span class="quoted">"induced_id <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">∈</span> FreeGroup <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="main">⌈</span>FreeGroup <span class="free">S</span><span class="main">|</span><span class="skolem">c</span><span class="main">|</span>Q<span class="main">⌉</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Group.quotient_group_UN FreeGroup_Group <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">=</span><span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> induced_id_kernel
          Group.quotient_identity_rule<span class="main">[</span><span class="operator">OF</span> FreeGroup_Group<span class="main">]</span>
          GroupByPresentation.Q_subgroup_FreeS<span class="main">[</span><span class="operator">OF</span> GroupByPresentation_S_P<span class="main">]</span>
          GroupByPresentation.normal_Q<span class="main">[</span><span class="operator">OF</span> GroupByPresentation_S_P<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context PreCoxeterSystemWithDeletion *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Coxeter system associated to a thin chamber complex with many foldings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We now show that the fundamental automorphisms in a thin chamber complex with many foldings
  satisfy the deletion condition, and hence form a Coxeter system.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-not_reduced_word_not_min_gallery"><span class="command">lemma</span></span> not_reduced_word_not_min_gallery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists S"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word S <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">¬</span> min_gallery <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> nil_reduced_word_for_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">s</span><span class="main">)</span> <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> zero_notin_S reduced_word_singleton<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted">S</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">s</span> <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">#</span><span class="skolem">ts</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ms</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ms</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>sums <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> ss
    <span class="keyword1"><span class="command">have</span></span>  C0_ms_ss_C0<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span> <span class="main">=</span>
                          <span class="free">C0</span> <span class="main">#</span> <span class="skolem">Ms</span> <span class="main">@</span> <span class="main">[</span>sum_list <span class="free">ss</span> <span class="main">`→</span> <span class="free">C0</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc zero_permutation.rep_eq<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">=</span> arg_min length <span class="main">(</span>word_for S <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rs</span> <span class="main">∈</span> lists S"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">rs</span> <span class="main">=</span> sum_list <span class="free">ss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> arg_min_natI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">rs</span><span class="main">.</span> word_for S <span class="main">(</span>sum_list <span class="free">ss</span><span class="main">)</span> <span class="bound">rs</span>"</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted">length</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">rs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ss</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C0_ms_ss_C0 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Single <span class="skolem">r</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Single <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">[</span><span class="free">C0</span><span class="main">,</span><span class="skolem">r</span><span class="main">`→</span><span class="free">C0</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>1<span class="main">)</span> fundchamber fundchamber_S_chamber fundchamber_S_adjacent
            fundchamber_S_image_neq_fundchamber            
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_gallery_adj<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Single C0_ms_ss_C0 Ms_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> rs<span class="main">(</span>2<span class="main">)</span> min_galleryD_min_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">Ms</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ss</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
            min_galleryD_gallery
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_sums<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">p</span> <span class="skolem">qs</span> <span class="skolem">q</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ns</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ns</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">(</span>sums <span class="skolem">qs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms rs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rs</span> <span class="main">&lt;</span> length <span class="free">ss</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> word_length_lt<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted">S</span><span class="main">]</span>
            reduced_word_for_length reduced_word_for_arg_min<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted">S</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">with</span></span> Cons_snoc ss Ms_def Ns_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Ns</span> <span class="main">&lt;</span> length <span class="skolem">Ms</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_sums<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Ns_def Cons_snoc
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C0</span> <span class="main">#</span> <span class="skolem">Ns</span> <span class="main">@</span> <span class="main">[</span>sum_list <span class="free">ss</span> <span class="main">`→</span> <span class="free">C0</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rs S_list_image_gallery<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">rs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc zero_permutation.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> C0_ms_ss_C0 not_min_galleryI_betw <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-S_list_not_min_gallery_double_split"><span class="command">lemma</span></span> S_list_not_min_gallery_double_split<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> min_gallery <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span> <span class="bound">as</span> <span class="bound">s</span> <span class="bound">bs</span> <span class="bound">t</span> <span class="bound">cs</span><span class="main">.</span>
      <span class="main">(</span><span class="bound">f</span><span class="main">,</span><span class="bound">g</span><span class="main">)</span><span class="main">∈</span>foldpairs <span class="main">∧</span>
      sum_list <span class="bound">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span>
      sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span>
      sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="bound">g</span><span class="main">⊢</span>𝒞 <span class="main">∧</span>
      sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="main">[</span><span class="bound">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="bound">f</span><span class="main">⊢</span>𝒞 <span class="main">∧</span>
      <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">s</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="main">[</span><span class="bound">t</span><span class="main">]</span><span class="main">@</span><span class="bound">cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="skolem">Cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_list_image_gallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> Cs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span> <span class="main">∉</span> set <span class="main">(</span>wall_crossings <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_list_image_crosses_walls <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">As</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="skolem"><span class="skolem">Bs</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="skolem"><span class="skolem">F</span></span> <span class="skolem"><span class="skolem">Fs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span>   fg          <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     sep         <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>     decomp_cases<span class="main">:</span>
      <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span> <span class="main">∨</span> <span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">]</span><span class="main">@</span><span class="skolem">Bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">E</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>3<span class="main">)</span> not_min_gallery_double_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Cs</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>      <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="skolem">As</span><span class="main">@</span><span class="main">[</span><span class="skolem">A</span><span class="main">,</span><span class="skolem">B</span><span class="main">,</span><span class="skolem">F</span><span class="main">]</span><span class="main">@</span><span class="skolem">Fs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation list"</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> True Cs_def <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> sum_list <span class="skolem">as</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">,</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pullback_sums_map_middle3<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="skolem">As</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">Fs</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> sep<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> bs_def <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"sum_list <span class="skolem">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> fg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> Cs_def decomp_cases <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">cs</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> sum_list <span class="skolem">as</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> pullback_sums_map_double_middle2<span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="free">ss</span></span> <span class="quoted"><span class="skolem">As</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">Bs</span></span> <span class="quoted"><span class="skolem">E</span></span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">Fs</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> sep <span class="keyword1"><span class="command">have</span></span>
      <span class="quoted"><span class="quoted">"sum_list <span class="skolem">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> 
      <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> 
      <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> fg <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-fold_end_sum_chain_fg"><span class="command">lemma</span></span> fold_end_sum_chain_fg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> 𝗌  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝗌</span> <span class="main">≡</span> induced_automorph <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fg <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span> <span class="main">∈</span> foldpairs"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     as <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists S"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     s  <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     sep<span class="main">:</span>  <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span>lists S <span class="main">⟹</span>
            <span class="free">𝗌</span> <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span>lists S <span class="main">⟹</span> <span class="free">𝗌</span> <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">bs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">from</span></span> 𝗌 as s sep C <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span><span class="main">]</span> sum_list_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">s</span><span class="main">]</span>"</span></span><span class="main">]</span>
            fundchamber_WS_image_adjacent
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
              OpposedThinChamberComplexFoldings.indaut_adj_halfchsys_im_fg
            <span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">b</span> <span class="skolem">bs</span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">bC0</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">bC0</span> <span class="main">=</span> <span class="skolem">b</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">C0</span><span class="main">∩</span><span class="skolem">bC0</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">z'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="free">𝗌</span> <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="skolem">y</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="skolem">y</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> snoc B_def <span class="keyword1"><span class="command">have</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝗌</span> <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> <span class="skolem">B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ</span></span> <span class="keyword2"><span class="keyword">where</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="skolem">φ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ex_label_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> bC0_def y_def snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">u</span></span> <span class="keyword2"><span class="keyword">where</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bC0</span> <span class="main">=</span> insert <span class="skolem">u</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundchamber_S_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> adjacent_sym
            fundchamber_S_image_neq_fundchamber
            adjacent_int_decomp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">bC0</span></span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Int_commute<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">v'</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">𝗌</span> <span class="main">(</span>sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">u</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">u</span>"</span></span>

    <span class="keyword1"><span class="command">from</span></span> bC0_def u v_def z_def v'_def z'_def
      <span class="keyword1"><span class="command">have</span></span>  ins_vz <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝗌</span> <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="skolem">z</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   ins_vz'<span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> insert <span class="skolem">v'</span> <span class="skolem">z'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> image_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
            image_insert<span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">𝗌</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span><span class="main">→</span><span class="skolem">u</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span><span class="main">`→</span><span class="skolem">y</span>"</span></span><span class="main">,</span>
              <span class="operator">THEN</span> sym<span class="main">]</span>
            image_insert<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"permutation <span class="main">(</span>sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_permutation.rep_eq image_comp<span class="main">)</span>

    <span class="keyword1"><span class="command">from</span></span> as s snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> sums<span class="main">:</span>
      <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> W"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">∈</span> W"</span></span>
      <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> W"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">∈</span> W"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span><span class="main">]</span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="skolem">bs</span>"</span></span><span class="main">]</span>
            sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span>"</span></span><span class="main">]</span> sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> u bC0_def snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundchamber_S_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">bC0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> as s snoc<span class="main">(</span>2<span class="main">)</span> u <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">→</span> <span class="skolem">u</span> <span class="main">∈</span> <span class="main">⋃</span><span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sums<span class="main">(</span>1<span class="main">)</span>
            ChamberComplexEndomorphism.vertex_map<span class="main">[</span><span class="operator">OF</span> W_endomorphism<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">φ</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">φ</span> <span class="skolem">v'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 𝗌 v_def v'_def sums<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> W_respects_labels<span class="main">[</span><span class="operator">OF</span> φ<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
            W_respects_labels<span class="main">[</span><span class="operator">OF</span> φ<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">u</span></span><span class="main">]</span>
            OpposedThinChamberComplexFoldings.indaut_resplabels<span class="main">[</span>
              <span class="operator">OF</span> C φ
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> 𝗌 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>insert <span class="skolem">v</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>insert <span class="skolem">v'</span> <span class="skolem">z'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sums<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
            fundchamber_W_image_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
            OpposedThinChamberComplexFoldings.indaut_chmap<span class="main">[</span>
              <span class="operator">OF</span> C
            <span class="main">]</span>
            fundchamber_W_image_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_vz<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> ins_vz'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> y_def z_def z'_def bC0_def B_def snoc<span class="main">(</span>2<span class="main">)</span> 𝗌 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">⊲</span><span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z'</span><span class="main">⊲</span><span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B' sums<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> fundchamber_S_adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
            fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span>
            adjacent_int_facet1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span><span class="main">]</span>
            W_endomorphism<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
            W_endomorphism<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
            fundchamber fundchamber_W_image_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
            ChamberComplexEndomorphism.facet_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
            OpposedThinChamberComplexFoldings.indaut_morph<span class="main">[</span>
              <span class="operator">OF</span> C
            <span class="main">]</span>
            ChamberComplexEndomorphism.facet_map<span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">𝗌</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">)</span> B_def 𝗌 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">v</span> <span class="skolem">z</span> <span class="main">≠</span> <span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"insert <span class="skolem">v'</span> <span class="skolem">z'</span> <span class="main">≠</span> <span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sum_list_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">]</span>"</span></span><span class="main">]</span> sum_list_append<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="skolem">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">b</span><span class="main">]</span>"</span></span><span class="main">]</span>
            fundchamber_next_WS_image_neq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
            fundchamber_next_WS_image_neq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
            OpposedThinChamberComplexFoldings.indaut_aut<span class="main">[</span>
              <span class="operator">OF</span> C
            <span class="main">]</span>
            ChamberComplexAutomorphism.bij bij_is_inj B'
            inj_eq_image<span class="main">[</span>
              <span class="operator">of</span> <span class="quoted"><span class="free">𝗌</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_vz<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> ins_vz'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> B_def sums<span class="main">(</span>2<span class="main">)</span> fundchamber_W_image_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span>"</span></span><span class="main">]</span>
            label_wrt_eq_on_adjacent_vertex<span class="main">[</span><span class="operator">OF</span> φ<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span> <span class="quoted"><span class="skolem">v'</span></span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">z'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ins_vz<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span> ins_vz'<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-fold_end_sum_chain_gf"><span class="command">lemma</span></span> fold_end_sum_chain_gf<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">f</span> <span class="free">g</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝗌</span> <span class="main">≡</span> induced_automorph <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fg <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span> <span class="main">∈</span> foldpairs"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span>lists S"</span></span>
          <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
          <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">𝗌</span> <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_sym fold_end_sum_chain_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">bs</span></span><span class="main">]</span>
          OpposedThinChamberComplexFoldings.induced_automorphism_sym<span class="main">[</span><span class="operator">OF</span> C<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-fold_middle_sum_chain"><span class="command">lemma</span></span> fold_middle_sum_chain<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> fg <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">,</span><span class="free">g</span><span class="main">)</span> <span class="main">∈</span> foldpairs"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     S  <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">as</span> <span class="main">∈</span> lists S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">∈</span> lists S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">cs</span> <span class="main">∈</span>lists S"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     sep<span class="main">:</span>  <span class="quoted"><span class="quoted">"sum_list <span class="free">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
                <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span>
                <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">g</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="free">f</span><span class="main">⊢</span>𝒞"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">𝗌</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">𝗌</span> <span class="main">=</span> induced_automorph <span class="free">f</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> fg <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="free">f</span> <span class="free">g</span> <span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> foldpairs_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"id <span class="main">`</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="main">[</span><span class="free">t</span><span class="main">]</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="free">as</span><span class="main">@</span><span class="free">bs</span><span class="main">@</span><span class="free">cs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 𝗌_def fg S sep fold_end_sum_chain_gf<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="quoted">"<span class="free">as</span><span class="main">@</span><span class="main">[</span><span class="free">s</span><span class="main">]</span><span class="main">@</span><span class="free">bs</span>"</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">cs</span></span><span class="main">]</span>
          fold_end_sum_chain_fg<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">g</span></span> <span class="quoted"><span class="free">as</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span><span class="main">@</span><span class="free">cs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
            image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
            OpposedThinChamberComplexFoldings.indaut_order2<span class="main"><span class="main">[</span></span>
              <span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span>
          <span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-S_list_not_min_gallery_deletion"><span class="command">lemma</span></span> S_list_not_min_gallery_deletion<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ss</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation list"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> w <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">≡</span> sum_list <span class="free">ss</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> min_gallery <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">@</span><span class="bound">cs</span> <span class="main">∧</span> <span class="free">w</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="bound">cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> w ss<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> w_W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="keyword1"><span class="command">using</span></span> sum_list_S_in_W <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ss <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> fg    <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>foldpairs"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   sep   <span class="main">:</span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">as</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
                  <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
                  <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
                  <span class="quoted"><span class="quoted">"sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span> <span class="main">∈</span> <span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   decomp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">t</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_list_not_min_gallery_double_split<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">ss</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> fg sep decomp w ss<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">`→</span><span class="free">C0</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_middle_sum_chain
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> ss<span class="main">(</span>1<span class="main">)</span> decomp <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> w_W sum_list_S_in_W<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> inj_onD fundchamber_W_image_inj_on<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> decomp <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-deletion"><span class="command">lemma</span></span> deletion<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">∈</span> lists S <span class="main">⟹</span> <span class="main">¬</span> reduced_word S <span class="free">ss</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">a</span> <span class="bound">b</span> <span class="bound">as</span> <span class="bound">bs</span> <span class="bound">cs</span><span class="main">.</span> <span class="free">ss</span> <span class="main">=</span> <span class="bound">as</span><span class="main">@</span><span class="main">[</span><span class="bound">a</span><span class="main">]</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="main">[</span><span class="bound">b</span><span class="main">]</span><span class="main">@</span><span class="bound">cs</span> <span class="main">∧</span> sum_list <span class="free">ss</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="bound">as</span><span class="main">@</span><span class="bound">bs</span><span class="main">@</span><span class="bound">cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> nil_reduced_word_for_0<span class="main">[</span><span class="operator">of</span> <span class="quoted">S</span><span class="main">]</span> not_reduced_word_not_min_gallery
        S_list_not_min_gallery_deletion
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-PreCoxeterSystemWithDeletion"><span class="command">lemma</span></span> PreCoxeterSystemWithDeletion<span class="main">:</span> <span class="quoted"><span class="quoted">"PreCoxeterSystemWithDeletion S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_add_order2 deletion <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="operator">simp</span>

<span class="keyword1" id="Coxeter-CoxeterSystem"><span class="command">lemma</span></span> CoxeterSystem<span class="main">:</span> <span class="quoted"><span class="quoted">"CoxeterSystem S"</span></span>
  <span class="keyword1"><span class="command">using</span></span> PreCoxeterSystemWithDeletion
        PreCoxeterSystemWithDeletion.CoxeterSystem
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Coxeter complexes›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale and complex definitions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Now we add in the assumption that the generating set is finite, and construct the associated
  Coxeter complex from the poset of special cosets.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> CoxeterComplex <span class="main">=</span> CoxeterSystem <span class="quoted"><span class="free">S</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span><span class="main">::</span>group_add set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> finite_genset<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">S</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">TheComplex</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'w</span> set set set"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">TheComplex</span> <span class="main">≡</span> ordering.PosetComplex <span class="main">(⊇)</span> <span class="main">(⊃)</span> 𝒫"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≡</span> TheComplex"</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context CoxeterComplex *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹As a simplicial complex›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we record the fact that the Coxeter complex associated to a Coxeter system is a simplicial
  complex, and note that the poset of special cosets is complex-like. This last fact allows us to
  reason about the complex by reasoning about the poset, via the poset isomorphism
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ComplexLikePoset.smap<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> CoxeterComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-simplex_like_special_cosets"><span class="command">lemma</span></span> simplex_like_special_cosets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span>𝒫"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"supset_simplex_like <span class="main">(</span>𝒫<span class="main">.⊇</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> image_eq_UN<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">f</span> <span class="main">`</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="main">{</span><span class="bound">f</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">∈</span> Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> image_eq_UN<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">(+o)</span> <span class="skolem">w</span> <span class="main">∘</span> genby"</span></span><span class="main">]</span>
          finite_genset simplex_like_pow_above_in
          OrderingSetIso.simplex_like_map<span class="main">[</span>
            <span class="operator">OF</span> special_coset_below_in_supset_ordering_iso<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">T</span></span> <span class="quoted"><span class="skolem">w</span></span>
          <span class="main">]</span>
          special_cosets_below_in
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-SimplicialComplex_Σ"><span class="command">lemma</span></span> SimplicialComplex_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"SimplicialComplex Σ"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> TheComplex_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ordering.poset_is_SimplicialComplex<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ordering <span class="main">(⊇)</span> <span class="main">(⊃)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>𝒫<span class="main">.</span> supset_simplex_like <span class="main">(</span>𝒫<span class="main">.⊇</span><span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_like_special_cosets <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-ComplexLikePoset_special_cosets"><span class="command">lemma</span></span> ComplexLikePoset_special_cosets<span class="main">:</span> <span class="quoted"><span class="quoted">"ComplexLikePoset <span class="main">(⊇)</span> <span class="main">(⊃)</span> 𝒫"</span></span>
  <span class="keyword1"><span class="command">using</span></span> simplex_like_special_cosets special_cosets_has_bottom special_cosets_have_glbs
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">smap</span> <span class="main">≡</span> ordering.poset_simplex_map <span class="main">(⊇)</span> <span class="main">(⊃)</span> 𝒫"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> smap_def <span class="main">=</span> ordering.poset_simplex_map_def<span class="main">[</span><span class="operator">OF</span> supset_poset<span class="main">,</span> <span class="operator">of</span> <span class="quoted">𝒫</span><span class="main">]</span>

<span class="keyword1" id="Coxeter-ordsetmap_smap"><span class="command">lemma</span></span> ordsetmap_smap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span><span class="main">∈</span>𝒫<span class="main">;</span> <span class="free">Y</span><span class="main">∈</span>𝒫<span class="main">;</span> <span class="free">X</span><span class="main">⊇</span><span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> smap <span class="free">X</span> <span class="main">⊆</span> smap <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ComplexLikePoset.ordsetmap_smap<span class="main">[</span><span class="operator">OF</span> ComplexLikePoset_special_cosets<span class="main">]</span>
        smap_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Coxeter-rev_ordsetmap_smap"><span class="command">lemma</span></span> rev_ordsetmap_smap<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">X</span><span class="main">∈</span>𝒫<span class="main">;</span> <span class="free">Y</span><span class="main">∈</span>𝒫<span class="main">;</span> smap <span class="free">X</span> <span class="main">⊆</span> smap <span class="free">Y</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="free">X</span><span class="main">⊇</span><span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ComplexLikePoset.rev_ordsetmap_smap<span class="main">[</span>
          <span class="operator">OF</span> ComplexLikePoset_special_cosets
        <span class="main">]</span>
        smap_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Coxeter-smap_onto_PosetComplex"><span class="command">lemma</span></span> smap_onto_PosetComplex<span class="main">:</span> <span class="quoted"><span class="quoted">"smap <span class="main">`</span> 𝒫 <span class="main">=</span> Σ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ComplexLikePoset.smap_onto_PosetComplex<span class="main">[</span>
          <span class="operator">OF</span> ComplexLikePoset_special_cosets
        <span class="main">]</span>
        smap_def TheComplex_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> simplices_conv_special_cosets <span class="main">=</span> smap_onto_PosetComplex<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">]</span>

<span class="keyword1" id="Coxeter-smap_into_PosetComplex"><span class="command">lemma</span></span> smap_into_PosetComplex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span>𝒫 <span class="main">⟹</span> smap <span class="free">X</span> <span class="main">∈</span> Σ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smap_onto_PosetComplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-smap_pseudominimal"><span class="command">lemma</span></span> smap_pseudominimal<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> smap <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smap_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
        special_coset_pseudominimal_in_below_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">]</span>
        exclude_one_is_pseudominimal_in_below_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-exclude_one_notin_smap_singleton"><span class="command">lemma</span></span> exclude_one_notin_smap_singleton<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">∉</span> smap <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smap_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
        supset_pseudominimal_inD1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"𝒫<span class="main">.⊇</span><span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span><span class="main">]</span>
        special_coset_subset_rev_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-maxsimp_vertices"><span class="command">lemma</span></span> maxsimp_vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">∈</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> special_cosetsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">]</span> special_coset_singleton
        ordsetmap_smap<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span><span class="main">]</span> smap_pseudominimal
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genby_lcoset_refl<span class="main">)</span>

<span class="keyword1" id="Coxeter-maxsimp_singleton"><span class="command">lemma</span></span> maxsimp_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp Σ <span class="main">(</span>smap <span class="main">{</span><span class="free">w</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> SimplicialComplex.maxsimpI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SimplicialComplex_Σ<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">∈</span> Σ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_coset_singleton smap_into_PosetComplex <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span><span class="main">∈</span>Σ"</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">⊆</span> <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> smap <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplices_conv_special_cosets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms z<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_coset_singleton rev_ordsetmap_smap special_coset_nempty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> X<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-maxsimp_is_singleton"><span class="command">lemma</span></span> maxsimp_is_singleton<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"SimplicialComplex.maxsimp Σ <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span><span class="main">∈</span>W<span class="main">.</span> smap <span class="main">{</span><span class="bound">w</span><span class="main">}</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"smap <span class="skolem">X</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> SimplicialComplex.maxsimpD_simplex<span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>
          simplices_conv_special_cosets
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> wT<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span><span class="main">∈</span>Pow <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> wT<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">w</span><span class="main">}</span><span class="main">∈</span>𝒫"</span></span> <span class="keyword1"><span class="command">using</span></span> special_coset_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> X wT<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> smap <span class="main">{</span><span class="skolem">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_refl ordsetmap_smap <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms wT<span class="main">(</span>1<span class="main">)</span> smap_into_PosetComplex
          SimplicialComplex.maxsimpD_maximal<span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-maxsimp_vertex_conv_special_coset"><span class="command">lemma</span></span> maxsimp_vertex_conv_special_coset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">X</span> <span class="main">∈</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="free">X</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> smap_def special_coset_pseudominimal_in_below_in<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genby_lcoset_empty<span class="main">)</span>

<span class="keyword1" id="Coxeter-vertices"><span class="command">lemma</span></span> vertices<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">∈</span> <span class="main">⋃</span>Σ"</span></span>
  <span class="keyword1"><span class="command">using</span></span> maxsimp_singleton SimplicialComplex.maxsimpD_simplex<span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>
        maxsimp_vertices
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-smap0_conv_special_subgroups"><span class="command">lemma</span></span> smap0_conv_special_subgroups<span class="main">:</span>
  <span class="quoted"><span class="quoted">"smap <span class="main">0</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">`</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_0_closed maxsimp_vertices maxsimp_vertex_conv_special_coset
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-S_bij_betw_chamber0"><span class="command">lemma</span></span> S_bij_betw_chamber0<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="free">S</span> <span class="main">(</span>smap <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="skolem">s</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="skolem">t</span><span class="main">∈</span><span class="free">S</span><span class="main">;</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">t</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⟧</span> <span class="main">⟹</span> <span class="skolem">s</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> special_subgroup_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">t</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> smap0_conv_special_subgroups<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Coxeter-smap_singleton_conv_W_image"><span class="command">lemma</span></span> smap_singleton_conv_W_image<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>smap <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_0_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span> maxsimp_vertices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> maxsimp_vertices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span><span class="main">]</span>
        maxsimp_vertex_conv_special_coset
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-W_lcoset_bij_betw_singletons"><span class="command">lemma</span></span> W_lcoset_bij_betw_singletons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">0</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">{</span><span class="free">w</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> XY<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> smap <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> smap <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="keyword1">+o</span> <span class="skolem">X</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="skolem">Y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> XY<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sx</span></span> <span class="skolem"><span class="skolem">sy</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">sx</span><span class="main">}</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">sy</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> maxsimp_vertex_conv_special_coset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main">]</span>
          maxsimp_vertex_conv_special_coset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="skolem">Y</span></span><span class="main">]</span> genby_0_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> XY<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">=</span><span class="skolem">Y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inj_onD<span class="main">[</span><span class="operator">OF</span> special_coset_inj<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">sx</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">sy</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> smap_singleton_conv_W_image<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main">)</span>

<span class="keyword1" id="Coxeter-facets"><span class="command">lemma</span></span> facets<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">⊲</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> facetrelI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exclude_one_notin_smap_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> order_antisym
<span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">⊆</span> insert <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="skolem">t</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> maxsimp_vertex_conv_special_coset <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span> insert <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> exclude_one_is_pseudominimal_in_below_in smap_def
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">=</span><span class="free">s</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">⊇</span> insert <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span> <span class="main">-</span> <span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> <span class="main">(</span>smap <span class="main">(</span><span class="free">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_refl special_cosetsI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span><span class="main">]</span> special_coset_singleton
          ordsetmap_smap maxsimp_vertices
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-facets'"><span class="command">lemma</span></span> facets'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> smap <span class="main">{</span><span class="free">w</span><span class="main">,</span><span class="free">w</span><span class="main">+</span><span class="free">s</span><span class="main">}</span> <span class="main">⊲</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facets <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2_add genby_lcoset_order2<span class="main">)</span>

<span class="keyword1" id="Coxeter-adjacent"><span class="command">lemma</span></span> adjacent<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W <span class="main">⟹</span> <span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> smap <span class="main">{</span><span class="free">w</span><span class="main">+</span><span class="free">s</span><span class="main">}</span> <span class="main">∼</span> smap <span class="main">{</span><span class="free">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facets'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> genby_genset_closed genby_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
        facets'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">+</span><span class="free">s</span>"</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span>
          <span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adjacentI
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2_add add.assoc insert_commute
        <span class="main">)</span>

<span class="keyword1" id="Coxeter-singleton_adjacent_0"><span class="command">lemma</span></span> singleton_adjacent_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">⟹</span> smap <span class="main">{</span><span class="free">s</span><span class="main">}</span> <span class="main">∼</span> smap <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> genby_genset_closed genby_0_closed facets'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> facets'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> adjacentI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genset_order2_add insert_commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context CoxeterComplex *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹As a chamber complex›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we verify that a Coxeter complex is a chamber complex.›</span></span>

<span class="keyword1"><span class="command">context</span></span> CoxeterComplex
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">chamber</span> <span class="main">≡</span> SimplicialComplex.maxsimp Σ"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">gallery</span> <span class="main">≡</span> SimplicialComplex.maxsimpchain Σ"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> chamber_singleton                 <span class="main">=</span> maxsimp_singleton
<span class="keyword1"><span class="command">lemmas</span></span> chamber_vertex_conv_special_coset <span class="main">=</span> maxsimp_vertex_conv_special_coset
<span class="keyword1"><span class="command">lemmas</span></span> chamber_vertices                  <span class="main">=</span> maxsimp_vertices
<span class="keyword1"><span class="command">lemmas</span></span> chamber_is_singleton              <span class="main">=</span> maxsimp_is_singleton

<span class="keyword1"><span class="command">lemmas</span></span> faces       <span class="main">=</span> SimplicialComplex.faces            <span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> gallery_def <span class="main">=</span> SimplicialComplex.maxsimpchain_def <span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> gallery_rev <span class="main">=</span> SimplicialComplex.maxsimpchain_rev <span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> chamberD_simplex <span class="main">=</span>
  SimplicialComplex.maxsimpD_simplex<span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> gallery_CConsI <span class="main">=</span>
  SimplicialComplex.maxsimpchain_CConsI<span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> gallery_overlap_join <span class="main">=</span>
  SimplicialComplex.maxsimpchain_overlap_join<span class="main">[</span><span class="operator">OF</span> SimplicialComplex_Σ<span class="main">]</span>

<span class="keyword1" id="Coxeter-word_gallery_to_0"><span class="command">lemma</span></span> word_gallery_to_0<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ss</span><span class="main">∈</span> lists <span class="free">S</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> gallery <span class="main">(</span>smap <span class="main">{</span>sum_list <span class="free">ss</span><span class="main">}</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span>smap <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_nonempty_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>single <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>smap <span class="main">{</span>sum_list <span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">}</span> <span class="main">#</span> <span class="main">[]</span> <span class="main">@</span> <span class="main">[</span>smap <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_genset_closed genby_0_closed chamber_singleton
          singleton_adjacent_0 gallery_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>smap <span class="main">{</span>sum_list <span class="skolem">ss</span><span class="main">}</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>smap <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>smap <span class="main">{</span>sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_subgroup_eq_sum_list chamber_singleton <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>smap <span class="main">{</span>sum_list <span class="main">(</span><span class="skolem">ss</span><span class="main">@</span><span class="main">[</span><span class="skolem">s</span><span class="main">]</span><span class="main">)</span><span class="main">}</span> <span class="main">#</span>
              <span class="main">(</span>smap <span class="main">{</span>sum_list <span class="skolem">ss</span><span class="main">}</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span>smap <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>3<span class="main">)</span> special_subgroup_eq_sum_list adjacent<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ss</span>"</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> gallery_CConsI<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-gallery_to_0"><span class="command">lemma</span></span> gallery_to_0<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">≠</span><span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">xs</span><span class="main">.</span> gallery <span class="main">(</span>smap <span class="main">{</span><span class="free">w</span><span class="main">}</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">@</span> <span class="main">[</span>smap <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> ss<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span><span class="main">∈</span>lists <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">=</span> sum_list <span class="skolem">ss</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_subgroup_eq_sum_list <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> word_gallery_to_0<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-ChamberComplex_Σ"><span class="command">lemma</span></span> ChamberComplex_Σ<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex Σ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> SimplicialComplex_Σ<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span>Σ"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span><span class="main">∈</span>𝒫"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> smap <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplices_conv_special_cosets <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> X<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="skolem">T</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> special_cosets_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> X <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> chamber <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">y</span> <span class="main">⊆</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_lcoset_refl special_coset_singleton ordsetmap_smap
          chamber_singleton
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
  <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">≠</span><span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> xy<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">w'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> smap <span class="main">{</span><span class="skolem">w</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> smap <span class="main">{</span><span class="skolem">w'</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_is_singleton
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">zs</span><span class="main">.</span> gallery <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">=</span><span class="main">0</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> two_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> both <span class="keyword1"><span class="command">with</span></span> xy<span class="main">(</span>1<span class="main">)</span> ww'<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> one <span class="keyword1"><span class="command">with</span></span> ww'<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_to_0 gallery_rev <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> other <span class="keyword1"><span class="command">with</span></span> ww'<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> gallery_to_0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> neither
    <span class="keyword1"><span class="command">from</span></span> this ww' <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="skolem"><span class="skolem">ys</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span> <span class="main">@</span> <span class="main">[</span>smap <span class="main">0</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span>smap <span class="main">0</span> <span class="main">#</span> <span class="skolem">ys</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_to_0 gallery_rev
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">@</span> smap <span class="main">0</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> gallery_overlap_join<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">#</span><span class="skolem">xs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-card_chamber"><span class="command">lemma</span></span> card_chamber<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">x</span> <span class="main">⟹</span> card <span class="free">x</span> <span class="main">=</span> card <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> bij_betw_same_card<span class="main">[</span><span class="operator">OF</span> S_bij_betw_chamber0<span class="main">]</span> chamber_singleton
        genby_0_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">S</span></span><span class="main">]</span>
        ChamberComplex.chamber_card<span class="main">[</span><span class="operator">OF</span> ChamberComplex_Σ<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"smap <span class="main">0</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Coxeter-vertex_conv_special_coset"><span class="command">lemma</span></span> vertex_conv_special_coset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">∈</span><span class="main">⋃</span>Σ <span class="main">⟹</span> <span class="main">∃</span><span class="bound">w</span> <span class="bound">s</span><span class="main">.</span> <span class="bound">w</span><span class="main">∈</span>W <span class="main">∧</span> <span class="bound">s</span><span class="main">∈</span><span class="free">S</span> <span class="main">∧</span> <span class="free">X</span> <span class="main">=</span> <span class="bound">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span><span class="free">S</span><span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplex.simplex_in_max<span class="main">[</span><span class="operator">OF</span> ChamberComplex_Σ<span class="main">]</span> chamber_is_singleton
        chamber_vertex_conv_special_coset
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context CoxeterComplex *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Coxeter complex associated to a thin chamber complex with many foldings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Having previously verified that the fundamental automorphisms in a thin chamber complex with many
  foldings form a Coxeter system, we now record the existence of a chamber complex isomorphism onto
  the associated Coxeter complex.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ThinChamberComplexManyFoldings
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Coxeter-CoxeterComplex"><span class="command">lemma</span></span> CoxeterComplex<span class="main">:</span> <span class="quoted"><span class="quoted">"CoxeterComplex S"</span></span>
  <span class="keyword1"><span class="command">by</span></span>  <span class="main">(</span>
        <span class="operator">rule</span> CoxeterComplex.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> CoxeterSystem<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">rule</span> finite_S
      <span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Σ</span> <span class="main">≡</span> CoxeterComplex.TheComplex S"</span></span>

<span class="keyword1" id="Coxeter-S_list_not_min_gallery_not_reduced"><span class="command">lemma</span></span> S_list_not_min_gallery_not_reduced<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">≠</span><span class="main">[]</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> min_gallery <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> reduced_word S <span class="free">ss</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">∈</span>lists S"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">as</span></span> <span class="skolem"><span class="skolem">bs</span></span> <span class="skolem"><span class="skolem">cs</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ss</span> <span class="main">=</span> <span class="skolem">as</span><span class="main">@</span><span class="main">[</span><span class="skolem">a</span><span class="main">]</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="main">[</span><span class="skolem">b</span><span class="main">]</span><span class="main">@</span><span class="skolem">cs</span>"</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="free">ss</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_list_not_min_gallery_deletion <span class="main">[</span><span class="operator">OF</span> True assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> not_reduced_word_for<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">as</span><span class="main">@</span><span class="skolem">bs</span><span class="main">@</span><span class="skolem">cs</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-reduced_S_list_min_gallery"><span class="command">lemma</span></span> reduced_S_list_min_gallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">ss</span><span class="main">≠</span><span class="main">[]</span> <span class="main">⟹</span> reduced_word S <span class="free">ss</span> <span class="main">⟹</span> min_gallery <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="free">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> S_list_not_min_gallery_not_reduced <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Coxeter-fundchamber_vertex_stabilizer1"><span class="command">lemma</span></span> fundchamber_vertex_stabilizer1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>   <span class="free">t</span>
  <span class="keyword2"><span class="keyword">defines</span></span> v<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≡</span> fundantivertex <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> tw<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> v tw<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v_C0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fundantivertex <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> arg_min length <span class="main">(</span>word_for S <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reduced_word S <span class="skolem">ss</span> <span class="main">⟹</span> sum_list <span class="skolem">ss</span> <span class="main">→</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span> <span class="main">⟹</span> sum_list <span class="skolem">ss</span> <span class="main">∈</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">s</span> <span class="skolem">ss</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> s_S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="keyword1"><span class="command">using</span></span> reduced_word_for_lists <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">g</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> fg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span><span class="main">,</span><span class="skolem">g</span><span class="main">)</span><span class="main">∈</span>fundfoldpairs"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> Abs_induced_automorph <span class="skolem">f</span> <span class="skolem">g</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> fg<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> opp_fg<span class="main">:</span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">X</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fundfoldpairs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>sums <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> minCs<span class="main">:</span> <span class="quoted"><span class="quoted">"min_gallery <span class="skolem">Cs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_S_list_min_gallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> sv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ss</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">ts</span> <span class="skolem">t</span><span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Ms</span></span> <span class="skolem"><span class="skolem">Cn</span></span>
        <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ms</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="bound">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>map <span class="main">(</span><span class="main">(+)</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span>sums <span class="skolem">ts</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cn</span> <span class="main">=</span> sum_list <span class="main">(</span><span class="skolem">s</span><span class="main">#</span><span class="skolem">ss</span><span class="main">)</span> <span class="main">`→</span> <span class="free">C0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> snoc Cs_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="free">C0</span> <span class="main">#</span> <span class="skolem">Ms</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">Cn</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sums_snoc zero_permutation.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> minCs Cs_def fg <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">C0</span><span class="main">∈</span><span class="skolem">f</span><span class="main">⊢</span>𝒞"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cn</span><span class="main">∈</span><span class="skolem">g</span><span class="main">⊢</span>𝒞"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sums_Cons_conv_append_tl<span class="main">[</span><span class="operator">THEN</span> sym<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="skolem">ss</span></span><span class="main">]</span>
              wall_crossings_subset_walls_betw<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">Ms</span></span> <span class="quoted"><span class="skolem">Cn</span></span><span class="main">]</span> fundfoldpairs_def
              the_wall_betw_adj_fundchamber walls_betw_def
              OpposedThinChamberComplexFoldings.basech_halfchsys<span class="main">(</span>1<span class="main">)</span><span class="main">[</span>
                <span class="operator">OF</span> opp_fg
              <span class="main">]</span>
              OpposedThinChamberComplexFoldings.separated_by_this_wall_fg<span class="main">[</span>
                <span class="operator">OF</span> opp_fg<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="skolem">Cn</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> Cn_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="skolem">Cn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> v_C0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> v_C0 fg
              OpposedThinChamberComplexFoldings.indaut_wallvertex<span class="main">[</span>
                <span class="operator">OF</span> opp_fg
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> permutation_conv_induced_automorph<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">→</span> sum_list <span class="skolem">ss</span> <span class="main">→</span> <span class="free">v</span> <span class="main">=</span> <span class="skolem">s</span><span class="main">→</span><span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> s_S
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_permutation.rep_eq S_order2_add<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ss</span> <span class="main">→</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Cons<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sum_list <span class="skolem">ss</span> <span class="main">∈</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reduced_word_Cons_reduce <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> tw<span class="main">(</span>1<span class="main">)</span> v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span><span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sv s_S genby_genset_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"S<span class="main">-</span><span class="main">{</span><span class="free">t</span><span class="main">}</span>"</span></span><span class="main">]</span> fundantivertex_unstable
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> genby_add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> genby_0_closed<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> tw<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> reduced_word_for_genby_sym_arg_min<span class="main">[</span><span class="operator">OF</span> S_sym<span class="main">]</span>
          reduced_word_for_sum_list
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-fundchamber_vertex_stabilizer2"><span class="command">lemma</span></span> fundchamber_vertex_stabilizer2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≡</span> fundantivertex <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">w</span> <span class="main">∈</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span> <span class="main">⟹</span> <span class="free">w</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> genby.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> s v <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C0</span><span class="main">∩</span><span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span>     inj_on_eq_iff<span class="main">[</span><span class="operator">OF</span> fundantivertex_inj_on<span class="main">]</span> fundchamber_S_adjacent
              fundchamber_S_image_neq_fundchamber<span class="main">[</span><span class="operator">THEN</span> not_sym<span class="main">]</span>
              not_the1<span class="main">[</span><span class="operator">OF</span> adj_antivertex<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span> fundantivertex
    <span class="keyword1"><span class="command">unfolding</span></span> fundantivertex_def
    <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> S_fixespointwise_fundchamber_image_int fixespointwiseD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="skolem">w'</span> <span class="keyword3"><span class="command">assume</span></span> ww'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> ww'<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> id <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> plus_permutation.rep_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w'</span>"</span></span> <span class="quoted"><span class="skolem">w'</span></span><span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ww'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">w</span><span class="main">-</span><span class="skolem">w'</span><span class="main">)</span><span class="main">→</span><span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> plus_permutation.rep_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">w</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="skolem">w'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_wrt_special_coset1"><span class="command">lemma</span></span> label_wrt_special_coset1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span><span class="main">∈</span>S"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">≡</span> fundantivertex <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span> <span class="main">→</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> v_C0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fundantivertex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="main">(</span><span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="main">(</span><span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span><span class="main">→</span><span class="free">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">-</span><span class="free">w0</span> <span class="main">+</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">→</span> <span class="free">v</span> <span class="main">=</span> <span class="main">0</span><span class="main">→</span><span class="free">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w<span class="main">(</span>2<span class="main">)</span> v_C0 fundchamber chamberD_simplex
            W_respects_labels<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> plus_permutation.rep_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">w0</span>"</span></span> <span class="quoted"><span class="free">w0</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_permutation.rep_eq fixespointwiseD<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> w<span class="main">(</span>1<span class="main">)</span> genby_uminus_add_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted">S</span> <span class="quoted"><span class="skolem">w</span></span><span class="main">]</span>
            fundchamber_vertex_stabilizer1
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> zero_permutation.rep_eq elt_set_plus_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span> <span class="keyword3"><span class="command">assume</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="keyword2"><span class="keyword">where</span></span> w1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="main">∈</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> <span class="free">w0</span> <span class="main">+</span> <span class="skolem">w1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> elt_set_plus_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> w assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> w_W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span>
      <span class="keyword1"><span class="command">using</span></span> genby_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span>"</span></span> <span class="quoted">S</span><span class="main">]</span> genby_add_closed <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span><span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="main">(</span><span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2-5<span class="main">)</span> v_C0 fundchamber chamberD_simplex
            W_respects_labels<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
            fundchamber_vertex_stabilizer2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="skolem">w1</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixespointwiseD plus_permutation.rep_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_wrt_special_coset1'"><span class="command">lemma</span></span> label_wrt_special_coset1'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≡</span> fundantipermutation <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span> <span class="main">→</span> <span class="free">φ</span> <span class="main">(</span><span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">)</span> <span class="main">=</span> <span class="free">w0</span><span class="main">→</span><span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms fundantipermutation1 fundantivertex_bij_betw
          bij_betw_f_the_inv_into_f label_wrt_special_coset1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">w0</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">fastforce</span>

<span class="keyword1" id="Coxeter-label_wrt_special_coset2'"><span class="command">lemma</span></span> label_wrt_special_coset2'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">w0</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≡</span> fundantipermutation <span class="main">(</span><span class="free">φ</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span> <span class="main">→</span> <span class="free">φ</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span><span class="main">}</span> <span class="main">=</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="free">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms fundchamber chamberD_simplex W_respects_labels
          label_wrt_special_coset1'<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1-3<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fixespointwiseD<span class="main">)</span> <span class="comment1">(* slow *)</span>

<span class="keyword1" id="Coxeter-label_stab_map_W_fundchamber_image"><span class="command">lemma</span></span> label_stab_map_W_fundchamber_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span><span class="main">∈</span>W"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">=</span> CoxeterComplex.smap S <span class="main">{</span><span class="free">w0</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> CoxeterComplex.smap S <span class="main">{</span><span class="free">w0</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CoxeterComplex.chamber_vertex_conv_special_coset<span class="main">[</span>
            <span class="operator">OF</span> CoxeterComplex<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">w0</span></span>
          <span class="main">]</span>
          label_wrt_special_coset1 fundantivertex
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span> <span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">ψ</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span>fundantipermutation <span class="main">(</span><span class="free">φ</span> <span class="skolem">v</span><span class="main">)</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_special_coset2' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundchamber chamberD_simplex W_endomorphism
          ChamberComplexEndomorphism.vertex_map
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> CoxeterComplex.smap S <span class="main">{</span><span class="free">w0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> label_wrt_elt_image fundantipermutation1
          CoxeterComplex.chamber_vertices<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_stab_map_chamber_map"><span class="command">lemma</span></span> label_stab_map_chamber_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     C<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"CoxeterComplex.chamber S <span class="main">(</span><span class="free">ψ</span><span class="main">`</span><span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> C <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_eq_W_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> φ ψ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> CoxeterComplex.smap S <span class="main">{</span><span class="skolem">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_stab_map_W_fundchamber_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> w<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> CoxeterComplex.chamber_singleton<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_stab_map_inj_on_vertices"><span class="command">lemma</span></span> label_stab_map_inj_on_vertices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="free">ψ</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> inj_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">v1</span> <span class="main">=</span> <span class="free">ψ</span> <span class="skolem">v2</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> φv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v1</span> <span class="main">∈</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v2</span> <span class="main">∈</span> <span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_elt_image<span class="main">[</span><span class="operator">OF</span> φ<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s1</span></span> <span class="skolem"><span class="skolem">s2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s1</span> <span class="main">=</span> fundantipermutation <span class="main">(</span><span class="free">φ</span> <span class="skolem">v1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s2</span> <span class="main">=</span> fundantipermutation <span class="main">(</span><span class="free">φ</span> <span class="skolem">v2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w1</span></span> <span class="skolem"><span class="skolem">w2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span><span class="main">∈</span><span class="skolem">w1</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w2</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v2</span><span class="main">∈</span><span class="skolem">w2</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_in_max chamber_eq_W_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms s1_def s2_def <span class="keyword1"><span class="command">have</span></span> ψv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">v1</span> <span class="main">=</span> <span class="skolem">w1</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="skolem">s1</span><span class="main">}</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">v2</span> <span class="main">=</span> <span class="skolem">w2</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="skolem">s2</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_special_coset2' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> v<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w1</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="skolem">s1</span><span class="main">}</span><span class="main">⟩</span> <span class="main">=</span> <span class="skolem">w2</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="skolem">s2</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_special_coset2' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> s1_def s2_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v1</span> <span class="main">=</span> <span class="free">φ</span> <span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> PreCoxeterSystemWithDeletion.special_coset_eq_imp_eq_gensets<span class="main">[</span>
            <span class="operator">OF</span> PreCoxeterSystemWithDeletion<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"S<span class="main">-</span><span class="main">{</span><span class="skolem">s1</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"S<span class="main">-</span><span class="main">{</span><span class="skolem">s2</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="skolem">w1</span></span> <span class="quoted"><span class="skolem">w2</span></span>
          <span class="main">]</span>
          φv fundantipermutation1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v1</span>"</span></span><span class="main">]</span> fundantipermutation1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v2</span>"</span></span><span class="main">]</span>
          bij_betw_f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> fundantivertex_bij_betw<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v1</span>"</span></span><span class="main">]</span>
          bij_betw_f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> fundantivertex_bij_betw<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">φ</span> <span class="skolem">v2</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> v<span class="main">(</span>3<span class="main">)</span> ψ <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v1</span><span class="main">=</span><span class="skolem">v2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ψv<span class="main">(</span>1<span class="main">)</span> genby_0_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"S<span class="main">-</span><span class="main">{</span><span class="skolem">s1</span><span class="main">}</span>"</span></span><span class="main">]</span> lcoset_refl<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="skolem">s1</span><span class="main">}</span><span class="main">⟩</span>"</span></span> <span class="quoted"><span class="skolem">w1</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_stab_map_surj_on_vertices"><span class="command">lemma</span></span> label_stab_map_surj_on_vertices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">⋃</span>Σ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="free">ψ</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> v<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> simplex_in_max chamber_eq_W_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms v <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">∈</span><span class="main">⋃</span>Σ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_special_coset2' label_wrt_elt_image<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
          fundantipermutation1 CoxeterComplex.vertices<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">u</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span><span class="main">∈</span><span class="main">⋃</span>Σ"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span><span class="main">∈</span>S"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">=</span> <span class="skolem">w</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="skolem">s</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CoxeterComplex.vertex_conv_special_coset<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">u</span> <span class="main">∈</span> <span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_special_coset1 fundantivertex fundchamber chamberD_simplex
          W_endomorphism ChamberComplexEndomorphism.vertex_map
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_stab_map_bij_betw_vertices"><span class="command">lemma</span></span> label_stab_map_bij_betw_vertices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"bij_betw <span class="free">ψ</span> <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span>Σ<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
  <span class="keyword1"><span class="command">using</span></span>     assms label_stab_map_inj_on_vertices label_stab_map_surj_on_vertices
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1" id="Coxeter-label_stab_map_bij_betw_W_chambers"><span class="command">lemma</span></span> label_stab_map_bij_betw_W_chambers<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">w0</span><span class="main">∈</span>W"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"bij_betw <span class="free">ψ</span> <span class="main">(</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">(</span>CoxeterComplex.smap S <span class="main">{</span><span class="free">w0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> inj_on_inverseI<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f1</span></span> <span class="skolem"><span class="skolem">f2</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f1</span> <span class="main">=</span> the_inv_into <span class="main">(</span>CoxeterComplex.smap S <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w0</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f2</span> <span class="main">=</span> the_inv_into S <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> <span class="main">(</span><span class="main">(→)</span> <span class="free">w0</span><span class="main">)</span> <span class="main">∘</span> fundantivertex <span class="main">∘</span> <span class="skolem">f2</span> <span class="main">∘</span> <span class="skolem">f1</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> inj_opw0<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="keyword1">(+o)</span> <span class="free">w0</span><span class="main">)</span> <span class="main">(</span>CoxeterComplex.smap S <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">OF</span> CoxeterComplex.W_lcoset_bij_betw_singletons<span class="main">]</span>
          CoxeterComplex
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> inj_genby_minus_s<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span><span class="bound">s</span><span class="main">}</span><span class="main">⟩</span><span class="main">)</span> S"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_inj_on<span class="main">[</span><span class="operator">OF</span> CoxeterComplex.S_bij_betw_chamber0<span class="main">]</span>
          CoxeterComplex
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v0</span></span> <span class="keyword2"><span class="keyword">where</span></span> v0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v0</span><span class="main">∈</span><span class="free">C0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">=</span> <span class="free">w0</span><span class="main">→</span><span class="skolem">v0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> v0<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> fap_v0<span class="main">:</span> <span class="quoted"><span class="quoted">"fundantipermutation <span class="skolem">v0</span> <span class="main">∈</span> S"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fundantipermutation1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  v0'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span>fundantipermutation <span class="skolem">v0</span><span class="main">}</span><span class="main">⟩</span> <span class="main">∈</span> CoxeterComplex.smap S <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> genby_0_closed<span class="main">[</span><span class="operator">of</span> <span class="quoted">S</span><span class="main">]</span>
          CoxeterComplex.chamber_vertices<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

  <span class="keyword1"><span class="command">from</span></span> v0 assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="skolem">v</span> <span class="main">=</span> <span class="free">w0</span> <span class="keyword1">+o</span> <span class="main">⟨</span>S<span class="main">-</span><span class="main">{</span>fundantipermutation <span class="skolem">v0</span><span class="main">}</span><span class="main">⟩</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_wrt_special_coset1' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> f1_def assms<span class="main">(</span>3<span class="main">)</span> f2_def v0 g_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">(</span><span class="free">ψ</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> v0' fap_v0 the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> inj_opw0<span class="main">]</span>
          the_inv_into_f_f<span class="main">[</span><span class="operator">OF</span> inj_genby_minus_s<span class="main">]</span>
          bij_betw_f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> fundantivertex_bij_betw<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">`</span><span class="main">(</span><span class="free">w0</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="main">=</span> CoxeterComplex.smap S <span class="main">{</span><span class="free">w0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_stab_map_W_fundchamber_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_stab_map_surj_on_simplices"><span class="command">lemma</span></span> label_stab_map_surj_on_simplices<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">⊢</span> <span class="free">X</span> <span class="main">=</span> Σ"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">ψ</span> <span class="main">⊢</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">`</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">⊆</span><span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms x<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> Σ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_stab_map_chamber_map
          CoxeterComplex.chamberD_simplex<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span>
          CoxeterComplex.faces<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span><span class="main">`</span><span class="skolem">C</span>"</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> Σ"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"CoxeterComplex.chamber S <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">⊆</span><span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplex.simplex_in_max<span class="main">[</span>
            <span class="operator">OF</span> CoxeterComplex.ChamberComplex_Σ<span class="main">,</span>
            <span class="operator">OF</span> CoxeterComplex
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> z<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">where</span></span> w<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span><span class="main">∈</span>W"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> CoxeterComplex.smap S <span class="main">{</span><span class="skolem">w</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CoxeterComplex.chamber_is_singleton<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">ψ</span> <span class="main">(</span><span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_stab_map_bij_betw_W_chambers <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">hence</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"bij_betw <span class="main">(</span><span class="main">(`)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>Pow <span class="main">(</span><span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Pow <span class="skolem">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_imp_bij_betw_Pow <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≡</span> the_inv_into <span class="main">(</span>Pow <span class="main">(</span><span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(`)</span> <span class="free">ψ</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">⊆</span> <span class="skolem">w</span><span class="main">`→</span><span class="free">C0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> bij_betw_the_inv_into_onto<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> w<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> faces fundchamber_W_image_chamber chamberD_simplex
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> x z<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">ψ</span> <span class="main">`</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> bij_betw_f_the_inv_into_f<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="free">ψ</span> <span class="main">⊢</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-label_stab_map_iso_to_coxeter_complex"><span class="command">lemma</span></span> label_stab_map_iso_to_coxeter_complex<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"label_wrt <span class="free">C0</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">φ</span> <span class="free">C0</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">ψ</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound"><span class="bound">w</span></span><span class="main">∈</span>W<span class="main">.</span> <span class="bound">w</span><span class="main">→</span><span class="main">(</span><span class="free">φ</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> <span class="bound">v</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">X</span> Σ <span class="free">ψ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ChamberComplexIsomorphism.intro<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> ChamberComplexMorphism.intro
<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex Σ"</span></span>
    <span class="keyword1"><span class="command">using</span></span> CoxeterComplex CoxeterComplex.ChamberComplex_Σ <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism_axioms <span class="free">X</span> Σ <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_stab_map_chamber_map
          CoxeterComplex.card_chamber<span class="main">[</span><span class="operator">OF</span> CoxeterComplex<span class="main">]</span>
          card_S_chamber
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism_axioms <span class="free">X</span> Σ <span class="free">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> label_stab_map_bij_betw_vertices label_stab_map_surj_on_simplices
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Coxeter-ex_iso_to_coxeter_complex'"><span class="command">lemma</span></span> ex_iso_to_coxeter_complex'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">X</span> <span class="main">(</span>CoxeterComplex.TheComplex S<span class="main">)</span> <span class="bound">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> CoxeterComplex ex_label_retraction label_stab_map_iso_to_coxeter_complex
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword1" id="Coxeter-ex_iso_to_coxeter_complex"><span class="command">lemma</span></span> ex_iso_to_coxeter_complex<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'a</span> permutation set<span class="main">.</span> CoxeterComplex <span class="bound">S</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">X</span> <span class="main">(</span>CoxeterComplex.TheComplex <span class="bound">S</span><span class="main">)</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> CoxeterComplex ex_iso_to_coxeter_complex' <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ThinChamberComplexManyFoldings *)</span>



<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div><div id="Building">
<div class="head">
<h1>Theory Building</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Buildings›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  In this section we collect the axioms for a (thick) building in a locale, and prove that
  apartments in a building are uniformly Coxeter.
›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Building
<span class="keyword2"><span class="keyword">imports</span></span> <a href="#Coxeter">Coxeter</a>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Apartment systems›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First we describe and explore the basic structure of apartment systems. An apartment system is a
  collection of isomorphic thin chamber subcomplexes with certain intersection properties.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Locale and basic facts›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexWithApartmentSystem <span class="main">=</span> ChamberComplex <span class="quoted"><span class="free">X</span></span>
  <span class="keyword2"><span class="keyword">for</span></span>   <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> subcomplexes         <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span> <span class="main">⟹</span> ChamberSubcomplex <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     thincomplexes        <span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span> <span class="main">⟹</span> ThinChamberComplex <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     no_trivial_apartments<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="main">{}</span><span class="main">∉</span><span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     containtwo           <span class="main">:</span> 
    <span class="quoted"><span class="quoted">"chamber <span class="free">C</span> <span class="main">⟹</span> chamber <span class="free">D</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">.</span> <span class="free">C</span><span class="main">∈</span><span class="bound">A</span> <span class="main">∧</span> <span class="free">D</span><span class="main">∈</span><span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     intersecttwo         <span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">A'</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">;</span> chamber <span class="free">C</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="bound">f</span> <span class="main">∧</span> fixespointwise <span class="bound">f</span> <span class="free">x</span> <span class="main">∧</span>
        fixespointwise <span class="bound">f</span> <span class="free">C</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> complexes                <span class="main">=</span> ChamberSubcomplexD_complex <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> apartment_simplices      <span class="main">=</span> ChamberSubcomplexD_sub     <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> chamber_in_apartment     <span class="main">=</span> chamber_in_subcomplex      <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> apartment_chamber        <span class="main">=</span> subcomplex_chamber         <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> gallery_in_apartment     <span class="main">=</span> gallery_in_subcomplex      <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> apartment_gallery        <span class="main">=</span> subcomplex_gallery         <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> min_gallery_in_apartment <span class="main">=</span> min_gallery_in_subcomplex  <span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_simplex_in_max <span class="main">=</span>
  ChamberComplex.simplex_in_max <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_faces <span class="main">=</span>
  ChamberComplex.faces <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_chamber_system_def <span class="main">=</span>
  ChamberComplex.chamber_system_def <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_chamberD_simplex <span class="main">=</span>
  ChamberComplex.chamberD_simplex <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_chamber_distance_def <span class="main">=</span>
  ChamberComplex.chamber_distance_def <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_galleryD_chamber <span class="main">=</span>
  ChamberComplex.galleryD_chamber <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_gallery_least_length <span class="main">=</span>
  ChamberComplex.gallery_least_length <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_min_galleryD_gallery <span class="main">=</span>
  ChamberComplex.min_galleryD_gallery <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_min_gallery_pgallery <span class="main">=</span>
  ChamberComplex.min_gallery_pgallery <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_trivial_morphism <span class="main">=</span>
  ChamberComplex.trivial_morphism <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_chamber_system_simplices <span class="main">=</span>
  ChamberComplex.chamber_system_simplices <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_min_gallery_least_length <span class="main">=</span>
  ChamberComplex.min_gallery_least_length <span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_vertex_set_int <span class="main">=</span>
  ChamberComplex.vertex_set_int<span class="main">[</span><span class="operator">OF</span> complexes complexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_standard_uniqueness_pgallery_betw <span class="main">=</span>
  ThinChamberComplex.standard_uniqueness_pgallery_betw<span class="main">[</span><span class="operator">OF</span> thincomplexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_standard_uniqueness <span class="main">=</span>
  ThinChamberComplex.standard_uniqueness<span class="main">[</span><span class="operator">OF</span> thincomplexes<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> apartment_standard_uniqueness_isomorphs <span class="main">=</span>
  ThinChamberComplex.standard_uniqueness_isomorphs<span class="main">[</span><span class="operator">OF</span> thincomplexes<span class="main">]</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">supapartment</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="free"><span class="bound"><span class="entity">D</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">SOME</span> <span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span><span class="free">𝒜</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">∈</span><span class="bound">A</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">D</span></span></span><span class="main">∈</span><span class="bound">A</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Building-supapartmentD"><span class="command">lemma</span></span> supapartmentD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> CD<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">≡</span> supapartment <span class="free">C</span> <span class="free">D</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> CD <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span><span class="main">∈</span><span class="free">𝒜</span> <span class="main">∧</span> <span class="free">C</span><span class="main">∈</span><span class="bound">A</span> <span class="main">∧</span> <span class="free">D</span><span class="main">∈</span><span class="bound">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> containtwo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> someI_ex<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-iso_fixespointwise_chamber_in_int_apartments"><span class="command">lemma</span></span> iso_fixespointwise_chamber_in_int_apartments<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> apartments<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∈</span> <span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span> <span class="main">∈</span> <span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chamber   <span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     iso       <span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fixespointwiseI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">A'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">∩</span><span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> apartments x<span class="main">(</span>1<span class="main">)</span> chamber intersecttwo<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A'</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">g</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> g<span class="main">:</span>  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="skolem">g</span>"</span></span>
              <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">g</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">g</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> assms g<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">f</span> <span class="skolem">g</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment 
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span>
            apartment_standard_uniqueness_isomorphs
            fixespointwise2_imp_eq_on
          <span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> x g<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">v</span> <span class="main">=</span> id <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fixespointwiseD fun_eq_onD <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-strong_intersecttwo"><span class="command">lemma</span></span> strong_intersecttwo<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">A'</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">C</span> <span class="main">∈</span> <span class="free">A</span><span class="main">∩</span><span class="free">A'</span> <span class="main">⟧</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="bound">f</span> <span class="main">∧</span> fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> intersecttwo<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A'</span></span><span class="main">]</span>
        iso_fixespointwise_chamber_in_int_apartments<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A'</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexWithApartmentSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Isomorphisms between apartments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  By standard uniqueness, the isomorphism between overlapping apartments guaranteed by the axiom
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>intersecttwo›</span></span></span></span> is unique.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexWithApartmentSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Building-ex1_apartment_iso"><span class="command">lemma</span></span> ex1_apartment_iso<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">f</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="bound">f</span> <span class="main">∧</span>
            fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="comment1">― ‹The third clause in the conjunction is to facilitate uniqueness.›</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ex_ex1I<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> f<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> strong_intersecttwo
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f'</span> <span class="main">=</span> restrict1 <span class="skolem">f</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> f<span class="main">(</span>1<span class="main">)</span> f'_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="skolem">f'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> ChamberComplexIsomorphism.iso_cong fun_eq_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> f<span class="main">(</span>2<span class="main">)</span> f'_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">f'</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fun_eq_onI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">f'</span></span> <span class="quoted"><span class="skolem">f</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwise_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> f'_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">f'</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="bound">f</span> <span class="main">∧</span>
            fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="skolem">g</span>
  <span class="keyword3"><span class="command">assume</span></span>  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="skolem">f</span> <span class="main">∧</span>
            fixespointwise <span class="skolem">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fixespointwise <span class="skolem">f</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="skolem">g</span> <span class="main">∧</span>
            fixespointwise <span class="skolem">g</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">A'</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fixespointwise <span class="skolem">g</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">=</span><span class="skolem">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment fixespointwise2_imp_eq_on<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">g</span></span><span class="main">]</span> fun_eq_on_cong
          fixespointwise_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          fixespointwise_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">g</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          apartment_standard_uniqueness_isomorphs
    <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_on_set_and_comp_imp_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">the_apartment_iso</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">the_apartment_iso</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="main">≡</span>
          <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">f</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">A'</span></span></span> <span class="bound">f</span> <span class="main">∧</span>
            fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">∩</span><span class="free"><span class="bound"><span class="entity">A'</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> fixespointwise <span class="bound">f</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Building-the_apartment_isoD"><span class="command">lemma</span></span> the_apartment_isoD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> the_apartment_iso <span class="free">A</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A'</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="quoted"><span class="quoted">"fixespointwise <span class="free">f</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms theI'<span class="main">[</span><span class="operator">OF</span> ex1_apartment_iso<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> the_apartment_iso_def
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> the_apartment_iso_apartment_chamber_map <span class="main">=</span>
  ChamberComplexIsomorphism.chamber_map <span class="main">[</span><span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  
<span class="keyword1"><span class="command">lemmas</span></span> the_apartment_iso_apartment_simplex_map <span class="main">=</span>
  ChamberComplexIsomorphism.simplex_map <span class="main">[</span><span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  

<span class="keyword1" id="Building-the_apartment_iso_chamber_map"><span class="command">lemma</span></span> the_apartment_iso_chamber_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">B</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
    chamber <span class="main">(</span>the_apartment_iso <span class="free">A</span> <span class="free">B</span> <span class="main">`</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> apartment_chamber
        the_apartment_iso_apartment_chamber_map
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Building-the_apartment_iso_comp"><span class="command">lemma</span></span> the_apartment_iso_comp<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> apartments<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A''</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chamber   <span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> the_apartment_iso <span class="free">A</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> the_apartment_iso <span class="free">A'</span> <span class="free">A''</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">≡</span> the_apartment_iso <span class="free">A</span> <span class="free">A''</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">gf</span> <span class="main">≡</span> restrict1 <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">h</span> <span class="main">=</span> <span class="free">gf</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> fun_eq_on_set_and_comp_imp_eq<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> apartment_standard_uniqueness_isomorphs<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> apartments<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gf_def <span class="keyword1"><span class="command">have</span></span> gf_cong1<span class="main">:</span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">gf</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_onI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> gf_def <span class="keyword1"><span class="command">have</span></span> gf_cong2<span class="main">:</span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">gf</span> <span class="main">(</span><span class="main">-</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> chamber h_def
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A''</span> <span class="free">h</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_apartment_isoD<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> apartments chamber f_def g_def
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">A''</span> <span class="free">gf</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexIsomorphism.iso_cong<span class="main">[</span><span class="operator">OF</span> _ gf_cong1<span class="main">]</span>
          ChamberComplexIsomorphism.iso_comp the_apartment_isoD<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chamber <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">h</span> <span class="free">gf</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fixespointwise2_imp_eq_on<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> chamber h_def <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">h</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fixespointwise_subset the_apartment_isoD<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">gf</span> <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fun_eq_on_subset<span class="main">[</span><span class="operator">OF</span> gf_cong1<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span><span class="main">)</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> f_def g_def apartments chamber
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span><span class="free">g</span><span class="main">∘</span><span class="free">f</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fixespointwise_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">g</span></span><span class="main">]</span>
            fixespointwise_subset<span class="main">[</span>
              <span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span><span class="main">)</span>"</span></span>
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">gf</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">∩</span><span class="free">A''</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fixespointwise_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">gf</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">∘</span><span class="free">f</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> chamber<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="free">gf</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fixespointwise_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">from</span></span> h_def apartments<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> chamber <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="free">h</span> <span class="free">gf</span> <span class="main">(</span><span class="main">-</span> <span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_apartment_isoD<span class="main">(</span>3<span class="main">)</span> gf_cong2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fun_eq_on_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-the_apartment_iso_int_im"><span class="command">lemma</span></span> the_apartment_iso_int_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>   <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> the_apartment_iso <span class="free">A</span> <span class="free">A'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>     <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>     assms the_apartment_isoD<span class="main">(</span>2<span class="main">)</span> fixespointwise_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">A</span><span class="main">∩</span><span class="free">A'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>        <span class="operator">fast</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexWithApartmentSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Retractions onto apartments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Since the isomorphism between overlapping apartments is the identity on their intersection,
  starting with a fixed chamber in a fixed apartment, we can construct a retraction onto that
  apartment as follows. Given a vertex in the complex, that vertex is contained a chamber, and
  that chamber lies in a common apartment with the fixed chamber. We then apply to the vertex the
  apartment isomorphism from that common apartment to the fixed apartment. It turns out that the
  image of the vertex does not depend on the containing chamber and apartment chosen, and so
  since the isomorphisms between apartments used are unique, such a retraction onto an apartment
  is canonical.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexWithApartmentSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">canonical_retraction</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">⇒</span><span class="tfree">'a</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">canonical_retraction</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">C</span></span></span> <span class="main">=</span>
          restrict1 <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> the_apartment_iso <span class="main">(</span>supapartment <span class="main">(</span>supchamber <span class="bound">v</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">C</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">v</span><span class="main">)</span>
            <span class="main">(</span><span class="main">⋃</span><span class="free">X</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Building-canonical_retraction_retraction"><span class="command">lemma</span></span> canonical_retraction_retraction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> supchamber <span class="free">v</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> supapartment <span class="skolem">D</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> D_def assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> D_facts<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_simplices supchamberD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">v</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> B_def assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> B_facts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span><span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D_facts<span class="main">(</span>1<span class="main">)</span> supapartmentD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">D</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span><span class="main">∈</span><span class="main">⋃</span><span class="main">(</span><span class="skolem">B</span><span class="main">∩</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D_facts<span class="main">(</span>2<span class="main">)</span> B_facts<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> apartment_vertex_set_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> D_def B_def <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> canonical_retraction_def B_facts<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> fixespointwiseD<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="skolem">B</span><span class="main">∩</span><span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">]</span>
          the_apartment_isoD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-canonical_retraction_simplex_retraction1"><span class="command">lemma</span></span> canonical_retraction_simplex_retraction1<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span>
    fixespointwise <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span><span class="main">)</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> canonical_retraction_retraction <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwiseI<span class="main">)</span>

<span class="keyword1" id="Building-canonical_retraction_simplex_retraction2"><span class="command">lemma</span></span> canonical_retraction_simplex_retraction2<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">a</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="free">a</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> canonical_retraction_simplex_retraction1 fixespointwise_im<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Building-canonical_retraction_uniform"><span class="command">lemma</span></span> canonical_retraction_uniform<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> apartments<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers  <span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fun_eq_on <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span>the_apartment_iso <span class="free">B</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">B</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fun_eq_onI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">B</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D'</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="skolem"><span class="skolem">h</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> supchamber <span class="skolem">v</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> supapartment <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> the_apartment_iso <span class="skolem">B'</span> <span class="free">A</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> the_apartment_iso <span class="free">B</span> <span class="skolem">B'</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">=</span> the_apartment_iso <span class="free">B</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> D'_def v apartments<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> D'_facts<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_simplices supchamberD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">v</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> B'_def chambers<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> B'_facts<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span><span class="main">∈</span><span class="skolem">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">B'</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> D'_facts<span class="main">(</span>1<span class="main">)</span> supapartmentD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">D'</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> f_def apartments<span class="main">(</span>2<span class="main">)</span> chambers <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="skolem">f</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">B</span> <span class="main">∩</span> <span class="skolem">B'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B'_facts<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> the_apartment_isoD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="skolem">B'</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> v apartments<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">⋃</span><span class="main">(</span><span class="free">B</span><span class="main">∩</span><span class="skolem">B'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D'_facts<span class="main">(</span>2<span class="main">)</span> B'_facts<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> apartment_vertex_set_int <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="skolem">v</span> <span class="main">=</span> <span class="skolem">h</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D'_def B'_def g_def f_def h_def v apartments chambers fixespointwiseD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="free">B</span><span class="main">∩</span><span class="skolem">B'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">]</span>
          canonical_retraction_def apartment_simplices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span><span class="main">]</span> B'_facts<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span>
          the_apartment_iso_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="skolem">B'</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-canonical_retraction_uniform_im"><span class="command">lemma</span></span> canonical_retraction_uniform_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">B</span><span class="main">;</span> <span class="free">x</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span>
    canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="free">x</span> <span class="main">=</span> the_apartment_iso <span class="free">B</span> <span class="free">A</span> <span class="main">`</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> canonical_retraction_uniform fun_eq_on_im<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Building-canonical_retraction_simplex_im"><span class="command">lemma</span></span> canonical_retraction_simplex_im<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">⊢</span> <span class="free">X</span> <span class="main">=</span> <span class="free">A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">⊢</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> x<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">⊆</span><span class="skolem">D</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> D<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span><span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> containtwo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms D<span class="main">(</span>2<span class="main">)</span> x<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">∈</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_apartment_isoD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
          ChamberComplexIsomorphism.surj_simplex_map
          canonical_retraction_uniform_im apartment_faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">D</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">a</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">∈</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">⊢</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> canonical_retraction_simplex_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">a</span></span><span class="main">,</span> <span class="operator">THEN</span> sym<span class="main">]</span>
          apartment_simplices
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-canonical_retraction_vertex_im"><span class="command">lemma</span></span> canonical_retraction_vertex_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span> <span class="main">⟧</span> <span class="main">⟹</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="main">⋃</span><span class="free">X</span> <span class="main">=</span> <span class="main">⋃</span><span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> singleton_simplex ChamberComplex.singleton_simplex complexes
        canonical_retraction_simplex_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>

<span class="keyword1" id="Building-canonical_retraction"><span class="command">lemma</span></span> canonical_retraction<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"ChamberComplexRetraction <span class="free">X</span> <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">D</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="skolem">D</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"card <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="skolem">D</span><span class="main">)</span> <span class="main">=</span> card <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> containtwo<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span> canonical_retraction_uniform_im
          the_apartment_iso_chamber_map chamber_in_apartment
          ChamberComplexIsomorphism.dim_map<span class="main">[</span><span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword1"><span class="command">from</span></span> assms
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">X</span> <span class="main">⟹</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span>
              canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> canonical_retraction_retraction canonical_retraction_vertex_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> canonical_retraction_def<span class="main">)</span>

<span class="keyword1" id="Building-canonical_retraction_comp_endomorphism"><span class="command">lemma</span></span> canonical_retraction_comp_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span>
    ChamberComplexEndomorphism <span class="free">X</span>
      <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="free">B</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> canonical_retraction<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> canonical_retraction<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
        ChamberComplexRetraction.axioms<span class="main">(</span>1<span class="main">)</span>
        ChamberComplexEndomorphism.endo_comp
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Building-canonical_retraction_comp_simplex_im_subset"><span class="command">lemma</span></span> canonical_retraction_comp_simplex_im_subset<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span>
      <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="free">B</span> <span class="free">D</span><span class="main">)</span> <span class="main">⊢</span> <span class="free">X</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> canonical_retraction<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> ChamberComplexRetraction.simplex_map
        canonical_retraction_simplex_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Building-canonical_retraction_comp_apartment_endomorphism"><span class="command">lemma</span></span> canonical_retraction_comp_apartment_endomorphism<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> <span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> <span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">;</span> chamber <span class="free">C</span><span class="main">;</span> chamber <span class="free">D</span><span class="main">;</span> <span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">;</span> <span class="free">D</span><span class="main">∈</span><span class="free">B</span> <span class="main">⟧</span> <span class="main">⟹</span>
    ChamberComplexEndomorphism <span class="free">A</span>
      <span class="main">(</span>restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="free">B</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplexEndomorphism.restrict_endo<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span> <span class="main">_</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        canonical_retraction_comp_endomorphism<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> subcomplexes<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        canonical_retraction_comp_simplex_im_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
        apartment_simplices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexWithApartmentSystem *)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Distances in apartments›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Here we examine distances between chambers and between a facet and a chamber, especially with
  respect to canonical retractions onto an apartment. Note that a distance measured within an
  apartment is equal to the distance measured between the same objects in the wider chamber
  complex. In other words, the shortest distance between chambers can always be achieved within an
  apartment.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> ChamberComplexWithApartmentSystem
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Building-apartment_chamber_distance"><span class="command">lemma</span></span> apartment_chamber_distance<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplex.chamber_distance <span class="free">A</span> <span class="free">C</span> <span class="free">D</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">=</span><span class="free">D</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_chamber_distance_def chamber_distance_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Cs</span></span> <span class="skolem"><span class="skolem">Ds</span></span> <span class="skolem"><span class="skolem">f</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Cs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Cs</span><span class="main">.</span> ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Cs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Ds</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Ds</span><span class="main">.</span> gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> canonical_retraction <span class="free">A</span> <span class="free">C</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> False Ds_def <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> gallery_least_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> f_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="skolem">f</span><span class="main">⊨</span><span class="skolem">Ds</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> canonical_retraction ChamberComplexRetraction.gallery_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">X</span></span><span class="main">]</span>
          canonical_retraction_simplex_retraction2
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> f_def assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">f</span><span class="main">⊨</span><span class="skolem">Ds</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 1 galleryD_chamber chamberD_simplex
          canonical_retraction_simplex_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="skolem">f</span><span class="main">⊨</span><span class="skolem">Ds</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> gallery_in_apartment <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">)</span> Ds_def False
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.chamber_distance <span class="free">A</span> <span class="free">C</span> <span class="free">D</span> <span class="main">≤</span> chamber_distance <span class="free">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplex.chamber_distance_le<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
          chamber_distance_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms False Cs_def
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"chamber_distance <span class="free">C</span> <span class="free">D</span> <span class="main">≤</span> ChamberComplex.chamber_distance <span class="free">A</span> <span class="free">C</span> <span class="free">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment apartment_gallery_least_length
          subcomplex_gallery<span class="main">[</span><span class="operator">OF</span> subcomplexes<span class="main">]</span>
          chamber_distance_le apartment_chamber_distance_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-apartment_min_gallery"><span class="command">lemma</span></span> apartment_min_gallery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="free">Cs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_gallery <span class="free">Cs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_cases_Cons_snoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Single <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_min_galleryD_gallery apartment_gallery galleryD_chamber
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons_snoc <span class="skolem">C</span> <span class="skolem">Ds</span> <span class="skolem">D</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="skolem">C</span><span class="main">#</span><span class="skolem">Ds</span><span class="main">@</span><span class="main">[</span><span class="skolem">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_min_galleryD_gallery<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">Cs</span></span><span class="main">]</span> apartment_gallery<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">Cs</span></span><span class="main">]</span>
          apartment_galleryD_chamber apartment_chamberD_simplex
          ChamberComplex.min_gallery_betw_chamber_distance<span class="main">[</span>
            <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">C</span></span> <span class="quoted"><span class="skolem">Ds</span></span> <span class="quoted"><span class="skolem">D</span></span>
          <span class="main">]</span>
          galleryD_chamber apartment_chamber_distance
          min_galleryI_chamber_distance_betw
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Building-apartment_face_distance"><span class="command">lemma</span></span> apartment_face_distance<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplex.face_distance <span class="free">A</span> <span class="free">F</span> <span class="free">C</span> <span class="main">=</span> face_distance <span class="free">F</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">D</span></span> <span class="skolem"><span class="skolem">D'</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span> <span class="main">=</span> closest_supchamber <span class="free">F</span> <span class="free">C</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D'</span> <span class="main">=</span> ChamberComplex.closest_supchamber <span class="free">A</span> <span class="free">F</span> <span class="free">C</span>"</span></span>

  <span class="keyword1"><span class="command">from</span></span> assms D'_def <span class="keyword1"><span class="command">have</span></span> chamber_D'<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment ChamberComplex.closest_supchamberD<span class="main">(</span>1<span class="main">)</span>
          complexes
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> D_def <span class="keyword1"><span class="command">have</span></span> chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closest_supchamberD<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> apartment_chamber
          apartment_simplices
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-3<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber_distance <span class="free">A</span> <span class="skolem">D'</span> <span class="free">C</span> <span class="main">=</span> chamber_distance <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_D' chambers<span class="main">(</span>2<span class="main">)</span> apartment_chamberD_simplex
          apartment_chamber_distance
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> assms D_def D'_def <span class="keyword1"><span class="command">have</span></span> F_DD'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">⊆</span><span class="skolem">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">⊆</span><span class="skolem">D'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_simplices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> closest_supchamberD<span class="main">(</span>2<span class="main">)</span> chamber_in_apartment
          ChamberComplex.closest_supchamberD<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">D</span><span class="main">∈</span><span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">)</span> containtwo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the_apartment_iso <span class="skolem">B</span> <span class="free">A</span> <span class="main">`</span> <span class="free">F</span> <span class="main">=</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F_DD'<span class="main">(</span>1<span class="main">)</span> apartment_faces the_apartment_iso_int_im <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"the_apartment_iso <span class="skolem">B</span> <span class="free">A</span> <span class="main">`</span> <span class="free">F</span> <span class="main">⊆</span> the_apartment_iso <span class="skolem">B</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">D</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F_DD'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"chamber_distance <span class="skolem">D</span> <span class="free">C</span> <span class="main">≥</span> chamber_distance <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> D'_def 1 chambers<span class="main">(</span>1<span class="main">)</span> apartment_chamber_distance<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span><span class="main">]</span>
          chamber_in_apartment<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">D</span></span><span class="main">]</span> chamber_in_apartment<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          ChamberComplexIsomorphism.chamber_map<span class="main">[</span>
            <span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
          ChamberComplex.closest_supchamber_closest<span class="main">[</span> 
            <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"the_apartment_iso <span class="skolem">B</span> <span class="free">A</span> <span class="main">`</span> <span class="skolem">D</span>"</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          ChamberComplexIsomorphism.chamber_distance_map<span class="main">[</span>
            <span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
          the_apartment_iso_int_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms D_def
    <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"chamber_distance <span class="skolem">D</span> <span class="free">C</span> <span class="main">≤</span> chamber_distance <span class="skolem">D'</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closest_supchamber_closest chambers<span class="main">(</span>2<span class="main">)</span> F_DD'<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> D_def D'_def face_distance_def 1
          ChamberComplex.face_distance_def<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-apartment_face_distance_eq_chamber_distance_compare_other_chamber"><span class="command">lemma</span></span> apartment_face_distance_eq_chamber_distance_compare_other_chamber<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">∈</span><span class="free">A</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"chamber_distance <span class="free">C</span> <span class="free">E</span> <span class="main">≤</span> chamber_distance <span class="free">D</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="free">E</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms apartment_chamber_distance apartment_face_distance
          facetrel_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> apartment_faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> chamber_in_apartment
          ThinChamberComplex.face_distance_eq_chamber_distance_compare_other_chamber<span class="main">[</span>
            <span class="operator">OF</span> thincomplexes<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">E</span></span>
          <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">auto</span>

<span class="keyword1" id="Building-canonical_retraction_face_distance_map"><span class="command">lemma</span></span> canonical_retraction_face_distance_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">⊆</span><span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"face_distance <span class="free">F</span> <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">`</span> <span class="free">D</span><span class="main">)</span> <span class="main">=</span> face_distance <span class="free">F</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="skolem">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="skolem">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> containtwo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> apartment_faces<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span>
          apartment_face_distance chamber_in_apartment the_apartment_iso_int_im
          the_apartment_iso_chamber_map the_apartment_iso_apartment_simplex_map
          apartment_face_distance canonical_retraction_uniform_im
          ChamberComplexIsomorphism.face_distance_map<span class="main">[</span>
            <span class="operator">OF</span> the_apartment_isoD<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">F</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexWithApartmentSystem *)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Special situation: a triangle of apartments and chambers›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  To facilitate proving that apartments in buildings have sufficient foldings to be Coxeter, we
  explore the situation of three chambers sharing a common facet, along with three apartments, each
  of which contains two of the chambers. A folding of one of the apartments is
  constructed by composing two apartment retractions, and by symmetry we automatically obtain an
  opposed folding.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> ChamberComplexApartmentSystemTriangle <span class="main">=</span>
  ChamberComplexWithApartmentSystem <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">𝒜</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">A</span> <span class="free">B</span> <span class="free">B'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">C</span> <span class="free">D</span> <span class="free">E</span> <span class="free">z</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> apartments   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">B'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers     <span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     facet        <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊲</span><span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     in_apartments<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span><span class="main">∩</span><span class="free">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">∈</span><span class="free">B</span><span class="main">∩</span><span class="free">B'</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     chambers_ne  <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">≠</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">E</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fold_A</span> <span class="main">≡</span> canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">∘</span> canonical_retraction <span class="free">B</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">res_fold_A</span> <span class="main">≡</span> restrict1 fold_A <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">opp_fold_A</span> <span class="main">≡</span> canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="free">B'</span> <span class="free">D</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">res_opp_fold_A</span> <span class="main">≡</span> restrict1 opp_fold_A <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Building-rotate"><span class="command">lemma</span></span> rotate<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexApartmentSystemTriangle <span class="free">X</span> <span class="free">𝒜</span> <span class="free">B'</span> <span class="free">A</span> <span class="free">B</span> <span class="free">D</span> <span class="free">E</span> <span class="free">C</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments chambers facet in_apartments chambers_ne
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1" id="Building-reflect"><span class="command">lemma</span></span> reflect<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexApartmentSystemTriangle <span class="free">X</span> <span class="free">𝒜</span> <span class="free">A</span> <span class="free">B'</span> <span class="free">B</span> <span class="free">D</span> <span class="free">C</span> <span class="free">E</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments chambers facet in_apartments chambers_ne
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>

<span class="keyword1" id="Building-facet_in_chambers"><span class="command">lemma</span></span> facet_in_chambers<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facet facetrel_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Building-A_chambers"><span class="command">lemma</span></span> A_chambers<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="free">D</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chamber_in_apartment
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Building-res_fold_A_A_chamber_image"><span class="command">lemma</span></span> res_fold_A_A_chamber_image<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="free">F</span> <span class="main">⟹</span> res_fold_A <span class="main">`</span> <span class="free">F</span> <span class="main">=</span> fold_A <span class="main">`</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> apartment_chamberD_simplex restrict1_image
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1" id="Building-the_apartment_iso_middle_im"><span class="command">lemma</span></span> the_apartment_iso_middle_im<span class="main">:</span> <span class="quoted"><span class="quoted">"the_apartment_iso <span class="free">A</span> <span class="free">B</span> <span class="main">`</span> <span class="free">D</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexIsomorphism.thin_image_shared_facet<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="free">A</span> <span class="free">B</span> <span class="main">(</span>the_apartment_iso <span class="free">A</span> <span class="free">B</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_apartment_isoD<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>2<span class="main">)</span> chambers<span class="main">(</span>3<span class="main">)</span> in_apartments<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">B</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"ThinChamberComplex <span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chamber_in_apartment thincomplexes
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">A</span><span class="main">∩</span><span class="free">B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> facet_in_chambers<span class="main">(</span>1<span class="main">)</span> apartment_faces <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">)</span> chambers_ne<span class="main">(</span>3<span class="main">)</span> facet<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"the_apartment_iso <span class="free">A</span> <span class="free">B</span> <span class="main">`</span> <span class="free">z</span> <span class="main">⊲</span> <span class="free">E</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≠</span> the_apartment_iso <span class="free">A</span> <span class="free">B</span> <span class="main">`</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> the_apartment_iso_int_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span>
  <span class="operator">rule</span> A_chambers<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> A_chambers<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> facet<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> facet<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> chambers_ne<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">THEN</span> not_sym<span class="main"><span class="main">]</span></span>
<span class="main">)</span>

<span class="keyword1" id="Building-inside_canonical_retraction_chamber_images"><span class="command">lemma</span></span> inside_canonical_retraction_chamber_images<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span> 
  <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span> <span class="main">`</span> <span class="free">D</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
  <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span> <span class="main">`</span> <span class="free">E</span> <span class="main">=</span> <span class="free">E</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments
        canonical_retraction_simplex_retraction2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
        canonical_retraction_uniform_im the_apartment_iso_middle_im
        canonical_retraction_simplex_retraction2
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> in_canretract_chimages <span class="main">=</span>
  inside_canonical_retraction_chamber_images

<span class="keyword1" id="Building-outside_canonical_retraction_chamber_images"><span class="command">lemma</span></span> outside_canonical_retraction_chamber_images<span class="main">:</span>
  <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">`</span> <span class="free">D</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
  <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">`</span> <span class="free">E</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplexApartmentSystemTriangle.in_canretract_chimages<span class="main">[</span>
          <span class="operator">OF</span> rotate
        <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Building-fold_A_chamber_images"><span class="command">lemma</span></span> fold_A_chamber_images<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fold_A <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"fold_A <span class="main">`</span> <span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"fold_A <span class="main">`</span> <span class="free">E</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> inside_canonical_retraction_chamber_images
        outside_canonical_retraction_chamber_images
        image_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
        image_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
        image_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">A</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="free">E</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_chamber_images <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_chamber_images<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-res_fold_A_chamber_images"><span class="command">lemma</span></span> res_fold_A_chamber_images<span class="main">:</span> <span class="quoted"><span class="quoted">"res_fold_A <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"res_fold_A <span class="main">`</span> <span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> fold_A_chamber_images<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        res_fold_A_A_chamber_image A_chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> res_opp_fold_A_chamber_images <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.res_fold_A_chamber_images<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-fold_A_fixespointwise1"><span class="command">lemma</span></span> fold_A_fixespointwise1<span class="main">:</span> <span class="quoted"><span class="quoted">"fixespointwise fold_A <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        canonical_retraction_simplex_retraction1
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> fixespointwise_comp<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_fixespointwise2 <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_fixespointwise1<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-fold_A_facet_im"><span class="command">lemma</span></span> fold_A_facet_im<span class="main">:</span> <span class="quoted"><span class="quoted">"fold_A <span class="main">`</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> facet_in_chambers<span class="main">(</span>1<span class="main">)</span> fixespointwise_im<span class="main">[</span><span class="operator">OF</span> fold_A_fixespointwise1<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Building-fold_A_endo_X"><span class="command">lemma</span></span> fold_A_endo_X<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">X</span> fold_A"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        canonical_retraction_comp_endomorphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1" id="Building-res_fold_A_endo_A"><span class="command">lemma</span></span> res_fold_A_endo_A<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">A</span> res_fold_A"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        canonical_retraction_comp_apartment_endomorphism
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_res_fold_A_endo_A <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.res_fold_A_endo_A<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-fold_A_morph_A_A"><span class="command">lemma</span></span> fold_A_morph_A_A<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">A</span> <span class="free">A</span> fold_A"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplexEndomorphism.axioms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> res_fold_A_endo_A<span class="main">]</span>
        ChamberComplexMorphism.cong fun_eq_on_sym<span class="main">[</span><span class="operator">OF</span> fun_eq_on_restrict1<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_morph_A_A <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_morph_A_A<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-res_fold_A_A_im_fold_A_A_im"><span class="command">lemma</span></span> res_fold_A_A_im_fold_A_A_im<span class="main">:</span> <span class="quoted"><span class="quoted">"res_fold_A  <span class="main">⊢</span> <span class="free">A</span> <span class="main">=</span> fold_A  <span class="main">⊢</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> setsetmapim_restrict1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted">fold_A</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> res_opp_fold_A_A_im_opp_fold_A_A_im <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.res_fold_A_A_im_fold_A_A_im<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-res_fold_A_𝒞_A_im_fold_A_𝒞_A_im"><span class="command">lemma</span></span> res_fold_A_𝒞_A_im_fold_A_𝒞_A_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"res_fold_A  <span class="main">⊢</span> <span class="main">(</span>ChamberComplex.chamber_system <span class="free">A</span><span class="main">)</span> <span class="main">=</span>
    fold_A  <span class="main">⊢</span> <span class="main">(</span>ChamberComplex.chamber_system <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> setsetmapim_restrict1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ChamberComplex.chamber_system <span class="free">A</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        apartments<span class="main">(</span>1<span class="main">)</span> apartment_chamber_system_simplices
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemmas</span></span> res_opp_fold_A_𝒞_A_im_opp_fold_A_𝒞_A_im <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.res_fold_A_𝒞_A_im_fold_A_𝒞_A_im<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-chambercomplex_fold_A_im"><span class="command">lemma</span></span> chambercomplex_fold_A_im<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.chambercomplex_image<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> chambercomplex_opp_fold_A_im <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.chambercomplex_fold_A_im<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-chambersubcomplex_fold_A_im"><span class="command">lemma</span></span> chambersubcomplex_fold_A_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplex.ChamberSubcomplex <span class="free">A</span> <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.chambersubcomplex_image<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemmas</span></span> chambersubcomplex_opp_fold_A_im <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.chambersubcomplex_fold_A_im<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-fold_A_facet_distance_map"><span class="command">lemma</span></span> fold_A_facet_distance_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">F</span> <span class="main">⟹</span> face_distance <span class="free">z</span> <span class="main">(</span>fold_A<span class="main">`</span><span class="free">F</span><span class="main">)</span> <span class="main">=</span> face_distance <span class="free">z</span> <span class="free">F</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet_in_chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        ChamberComplexRetraction.chamber_map<span class="main">[</span>
          <span class="operator">OF</span> canonical_retraction<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">F</span></span>
        <span class="main">]</span>
        canonical_retraction_face_distance_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="quoted">"canonical_retraction <span class="free">B</span> <span class="free">C</span> <span class="main">`</span> <span class="free">F</span>"</span></span><span class="main">]</span>
        canonical_retraction_face_distance_map
  <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main">)</span>

<span class="keyword1" id="Building-fold_A_min_gallery_betw_map"><span class="command">lemma</span></span> fold_A_min_gallery_betw_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">⊆</span><span class="free">F</span>"</span></span>
          <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="free">G</span> <span class="main">=</span> chamber_distance <span class="free">F</span> <span class="free">G</span>"</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="free">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">G</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span>fold_A<span class="main">⊨</span><span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="free">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">G</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms fold_A_facet_im fold_A_facet_distance_map
          ChamberComplexEndomorphism.facedist_chdist_mingal_btwmap<span class="main">[</span>
            <span class="operator">OF</span> fold_A_endo_X<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">G</span></span> <span class="quoted"><span class="free">z</span></span>
          <span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="operator">force</span>

<span class="keyword1" id="Building-fold_A_chamber_system_image_fixespointwise'"><span class="command">lemma</span></span> fold_A_chamber_system_image_fixespointwise'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> 𝒞_A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒞_A</span>  <span class="main">≡</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> f𝒞_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f𝒞_A</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">F</span></span><span class="main">∈</span><span class="free">𝒞_A</span><span class="main">.</span> face_distance <span class="free">z</span> <span class="bound">F</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="bound">F</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> F   <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">∈</span><span class="free">f𝒞_A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fixespointwise fold_A <span class="free">F</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">=</span><span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_A_fixespointwise1 fixespointwise_restrict1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> assms
      <span class="keyword1"><span class="command">have</span></span>  Achamber_F<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complexes ChamberComplex.chamber_system_def
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Fs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Fs</span><span class="main">.</span> ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> apartment_standard_uniqueness_pgallery_betw<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> apartments<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">A</span> <span class="free">A</span> fold_A"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_A_morph_A_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">A</span> <span class="free">A</span> id"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartment_trivial_morphism <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise fold_A <span class="free">C</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_A_fixespointwise1 fixespointwise_restrict1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
     
      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> False Fs_def
        <span class="keyword3"><span class="command">show</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_chambers<span class="main">(</span>1<span class="main">)</span> Achamber_F apartment_gallery_least_length
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

      <span class="keyword1"><span class="command">from</span></span> False Fs_def apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> mingal<span class="main">:</span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="skolem">Fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_chambers<span class="main">(</span>1<span class="main">)</span> Achamber_F apartment_min_gallery
              apartment_min_gallery_least_length
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> set_A<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1 apartment_galleryD_chamber apartment_chamberD_simplex
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> f𝒞_A F <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">)</span> apartments<span class="main">(</span>1<span class="main">)</span> apartment_chamber Achamber_F
              facet_in_chambers<span class="main">(</span>1<span class="main">)</span> mingal
              fold_A_min_gallery_betw_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span> min_gallery_in_apartment
              apartment_min_gallery_pgallery
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> False Fs_def
        <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span>id <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A_chambers<span class="main">(</span>1<span class="main">)</span> Achamber_F
              ChamberComplex.pgallery_least_length<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-fold_A_chamber_system_image"><span class="command">lemma</span></span> fold_A_chamber_system_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">defines</span></span> 𝒞_A <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">𝒞_A</span> <span class="main">≡</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> f𝒞_A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f𝒞_A</span> <span class="main">≡</span> <span class="main">{</span><span class="bound"><span class="bound">F</span></span><span class="main">∈</span><span class="free">𝒞_A</span><span class="main">.</span> face_distance <span class="free">z</span> <span class="bound">F</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="bound">F</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fold_A <span class="main">⊢</span> <span class="free">𝒞_A</span> <span class="main">=</span> <span class="free">f𝒞_A</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">𝒞_A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> 𝒞_A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="free">𝒞_A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.chamber_system_into<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="skolem">F</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="skolem">F</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">=</span><span class="free">C</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">have</span></span> F_ne_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">≠</span><span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fact</span>
    <span class="keyword1"><span class="command">from</span></span> F <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span><span class="main">∈</span><span class="free">𝒞_A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> fold_A <span class="main">`</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> 𝒞_A apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> G'<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">G</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span><span class="main">∈</span><span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartment_chamber_system_def complexes apartment_chamber
            apartment_chamberD_simplex
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"chamber_distance <span class="free">C</span> <span class="skolem">G</span> <span class="main">≤</span> chamber_distance <span class="free">D</span> <span class="skolem">G</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="skolem">F</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
              chambers_ne<span class="main">(</span>1<span class="main">)</span> F_ne_C G<span class="main">(</span>2<span class="main">)</span> G' fold_A_chamber_images<span class="main">(</span>1<span class="main">)</span>
              facet_in_chambers<span class="main">(</span>1<span class="main">)</span> fold_A_facet_distance_map
              fold_A_facet_im
              apartment_face_distance_eq_chamber_distance_compare_other_chamber<span class="main">[</span>
                <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="free">z</span></span>
              <span class="main">]</span>
              ChamberComplexEndomorphism.face_distance_eq_chamber_distance_map<span class="main">[</span>
                <span class="operator">OF</span> fold_A_endo_X<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="free">z</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="skolem">F</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
              chambers_ne<span class="main">(</span>1<span class="main">)</span> F_ne_C G<span class="main">(</span>2<span class="main">)</span> G' fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span>
              facet_in_chambers<span class="main">(</span>2<span class="main">)</span> fold_A_facet_distance_map fold_A_facet_im
              apartment_face_distance_eq_chamber_distance_compare_other_chamber<span class="main">[</span>
                <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="free">z</span></span>
              <span class="main">]</span>
              ChamberComplexEndomorphism.face_distance_eq_chamber_distance_map<span class="main">[</span>
                <span class="operator">OF</span> fold_A_endo_X<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="skolem">G</span></span> <span class="quoted"><span class="free">z</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> chambers<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> facet_in_chambers<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> face_distance_eq_0 chamber_distance_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="free">f𝒞_A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f𝒞_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">from</span></span> 𝒞_A f𝒞_A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">F</span><span class="main">.</span> <span class="bound">F</span><span class="main">∈</span><span class="free">f𝒞_A</span> <span class="main">⟹</span> <span class="bound">F</span><span class="main">∈</span>fold_A <span class="main">⊢</span> <span class="free">𝒞_A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_system_image_fixespointwise' fixespointwise_im <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_chamber_system_image <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_chamber_system_image<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-fold_A_chamber_system_image_fixespointwise"><span class="command">lemma</span></span> fold_A_chamber_system_image_fixespointwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="free">A</span> <span class="main">⟹</span> fixespointwise fold_A <span class="main">(</span>fold_A<span class="main">`</span><span class="free">F</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_system_image
        fold_A_chamber_system_image_fixespointwise'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fold_A<span class="main">`</span><span class="free">F</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemmas</span></span> fold_A_chsys_imfix <span class="main">=</span> fold_A_chamber_system_image_fixespointwise

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_chamber_system_image_fixespointwise <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_chsys_imfix<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-chamber_in_fold_A_im"><span class="command">lemma</span></span> chamber_in_fold_A_im<span class="main">:</span>
  <span class="quoted"><span class="quoted">"chamber <span class="free">F</span> <span class="main">⟹</span> <span class="free">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
        ChamberComplexMorphism.chamber_system_image<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
        ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
        chamber_in_apartment apartment_chamber_system_def
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemmas</span></span> chamber_in_opp_fold_A_im <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.chamber_in_fold_A_im<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-simplex_in_fold_A_im_image"><span class="command">lemma</span></span> simplex_in_fold_A_im_image<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"fold_A <span class="main">`</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊆</span> fold_A<span class="main">`</span><span class="skolem">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_simplex_in_max apartment_chamber_system_def
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_system_image_fixespointwise fixespointwise_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-chamber1_notin_rfold_im"><span class="command">lemma</span></span> chamber1_notin_rfold_im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∉</span> opp_fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> chambers_ne<span class="main">(</span>1<span class="main">)</span> facet_in_chambers<span class="main">(</span>1<span class="main">)</span>
        min_gallery_adj adjacentI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span> face_distance_eq_0
        min_gallery_betw_chamber_distance<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
        chamber_in_opp_fold_A_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> opp_fold_A_chamber_system_image
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

<span class="keyword1" id="Building-fold_A_min_gallery_from1_map"><span class="command">lemma</span></span> fold_A_min_gallery_from1_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">F</span><span class="main">;</span> <span class="free">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">;</span> min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    min_gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> fold_A <span class="main">⊨</span> <span class="free">Fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>1<span class="main">)</span> chamber_in_fold_A_im fold_A_chamber_system_image
        facet_in_chambers<span class="main">(</span>1<span class="main">)</span> fold_A_min_gallery_betw_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">F</span></span><span class="main">]</span>
        fold_A_chamber_images<span class="main">(</span>1<span class="main">)</span> simplex_in_fold_A_im_image
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Building-fold_A_min_gallery_from2_map"><span class="command">lemma</span></span> fold_A_min_gallery_from2_map<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> chamber <span class="free">F</span><span class="main">;</span> <span class="free">F</span> <span class="main">∈</span> opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">;</span> min_gallery <span class="main">(</span><span class="free">D</span><span class="main">#</span><span class="free">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span> <span class="main">⟧</span> <span class="main">⟹</span>
    min_gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> chambers<span class="main">(</span>2<span class="main">)</span> facet_in_chambers<span class="main">(</span>2<span class="main">)</span> chamber_in_opp_fold_A_im
        opp_fold_A_chamber_system_image fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span>
        fold_A_min_gallery_betw_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">Fs</span></span><span class="main">]</span> 
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1" id="Building-fold_A_min_gallery_to2_map"><span class="command">lemma</span></span> fold_A_min_gallery_to2_map<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> opp_fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="free">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="free">Fs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span>   assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> min_gallery_rev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">#</span> fold_A <span class="main">⊨</span> <span class="main">(</span>rev <span class="free">Fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">F</span><span class="main">]</span><span class="main">)</span>"</span></span><span class="main">]</span>
          min_gallery_rev<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> fold_A_min_gallery_from2_map<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">Fs</span>"</span></span><span class="main">]</span>
          fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span>      <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_map<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_min_gallery_from1_map <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_min_gallery_from2_map<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_min_gallery_to1_map <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_min_gallery_to2_map<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-closer_to_chamber1_not_in_rfold_im_chamber_system"><span class="command">lemma</span></span> closer_to_chamber1_not_in_rfold_im_chamber_system<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"chamber_distance <span class="free">C</span> <span class="free">F</span> <span class="main">≤</span> chamber_distance <span class="free">D</span> <span class="free">F</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∉</span> ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> res_opp_fold_A <span class="main">⊢</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res_opp_fold_A_A_im_opp_fold_A_A_im
          ChamberComplexEndomorphism.image_chamber_system<span class="main">[</span>
            <span class="operator">OF</span> opp_res_fold_A_endo_A
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> F'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> opp_fold_A <span class="main">⊢</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res_opp_fold_A_𝒞_A_im_opp_fold_A_𝒞_A_im <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Achamber_F<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="free">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F apartment_chamber_system_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
          ChamberComplexEndomorphism.chamber_system_image<span class="main">[</span>
            <span class="operator">OF</span> opp_res_fold_A_endo_A
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> F_ne_C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">F</span><span class="main">≠</span><span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F' apartment_chamber_system_simplices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> chamber1_notin_rfold_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise opp_fold_A <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> apartment_standard_uniqueness_pgallery_betw<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> apartments<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">A</span> <span class="free">A</span> opp_fold_A"</span></span>
      <span class="keyword1"><span class="command">using</span></span> opp_fold_A_morph_A_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="free">A</span> <span class="free">A</span> id"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartment_trivial_morphism <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise opp_fold_A <span class="free">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F' opp_fold_A_chamber_system_image_fixespointwise <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Fs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Fs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Fs</span><span class="main">.</span> ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="bound">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  mingal<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A_chambers<span class="main">(</span>1<span class="main">)</span> Achamber_F F_ne_C
            apartment_min_gallery_least_length<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">F</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span>  5<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span>id <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartment_min_galleryD_gallery apartment_min_gallery_pgallery
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">D</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> opp_fold_A_min_gallery_to1_map<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Achamber_F apartment_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
              chambers_ne<span class="main">(</span>1<span class="main">)</span> Achamber_F apartment_chamber
              apartment_chamberD_simplex
              apartment_face_distance_eq_chamber_distance_compare_other_chamber
              apartment_chamber_system_def fold_A_chamber_system_image
              apartment_chamber_system_simplices
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartment_chamber_system_simplices<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">F</span> <span class="main">#</span> <span class="skolem">Fs</span> <span class="main">@</span> <span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> mingal apartment_min_gallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> opp_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 5 apartment_galleryD_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
            apartment_chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
            ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> opp_fold_A_morph_A_A<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> min_gallery_in_apartment <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">F</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="free">C</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartment_min_gallery_pgallery
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"opp_fold_A <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> fixespointwise_im <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">with</span></span> chambers_ne<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">using</span></span> opp_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> clsrch1_nin_rfold_im_chsys <span class="main">=</span>
  closer_to_chamber1_not_in_rfold_im_chamber_system

<span class="keyword1"><span class="command">lemmas</span></span> closer_to_chamber2_not_in_fold_im_chamber_system <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.clsrch1_nin_rfold_im_chsys<span class="main">[</span>
    <span class="operator">OF</span> reflect
  <span class="main">]</span>

<span class="keyword1" id="Building-fold_A_opp_fold_A_chamber_systems"><span class="command">lemma</span></span> fold_A_opp_fold_A_chamber_systems<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplex.𝒞 <span class="free">A</span> <span class="main">=</span>
    <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> seteqI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> F'<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="skolem">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span><span class="main">∈</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_chamber_system_def apartment_chamber_system_simplices
          apartment_chamber
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> F'<span class="main">(</span>1<span class="main">)</span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> F''<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">F</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartment_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
          <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"chamber_distance <span class="free">C</span> <span class="skolem">F</span> <span class="main">≤</span> chamber_distance <span class="free">D</span> <span class="skolem">F</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
            chambers_ne<span class="main">(</span>1<span class="main">)</span> F F'<span class="main">(</span>2<span class="main">)</span> F'' fold_A_chamber_system_image
            apartment_face_distance_eq_chamber_distance_compare_other_chamber
            ChamberComplexMorphism.image_chamber_system<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> chambers<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> in_apartments<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> facet<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
            chambers_ne<span class="main">(</span>1<span class="main">)</span> F F'<span class="main">(</span>2<span class="main">)</span> F'' opp_fold_A_chamber_system_image
            apartment_face_distance_eq_chamber_distance_compare_other_chamber
            ChamberComplexMorphism.image_chamber_system<span class="main">[</span><span class="operator">OF</span> opp_fold_A_morph_A_A<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span>
  <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∪</span>
              <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.image_chamber_system_image<span class="main">[</span>
            <span class="operator">OF</span> fold_A_morph_A_A
          <span class="main">]</span>
          ChamberComplexMorphism.image_chamber_system_image<span class="main">[</span>
            <span class="operator">OF</span> opp_fold_A_morph_A_A
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">∩</span>
          <span class="main">(</span>ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> closer_to_chamber1_not_in_rfold_im_chamber_system
          closer_to_chamber2_not_in_fold_im_chamber_system
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-fold_A_im_min_gallery'"><span class="command">lemma</span></span> fold_A_im_min_gallery'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> A_chambers<span class="main">(</span>1<span class="main">)</span> ChamberComplex.min_gallery_simps<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">Fs</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms snoc apartments<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span>  ch<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">H</span><span class="main">∈</span>set <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> ChamberComplex.chamber <span class="free">A</span> <span class="bound">H</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_galleryD_gallery
          ChamberComplex.galleryD_chamber
          chambercomplex_fold_A_im
          ChamberComplex.subcomplex_chamber<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
          chambersubcomplex_fold_A_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> ch_F<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">F</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> apartment_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplex.min_galleryI_betw_compare<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> complexes<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> apartments<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Gs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Gs</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">ARG_MIN</span> length <span class="bound">Gs</span><span class="main">.</span> ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="bound">Gs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms snoc <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_gallery_pgallery
            ChamberComplex.pgalleryD_distinct
            chambercomplex_fold_A_im
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">with</span></span> chambers<span class="main">(</span>1<span class="main">)</span> apartments<span class="main">(</span>1<span class="main">)</span> assms snoc Gs_def
      <span class="keyword3"><span class="command">show</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Gs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ch apartment_min_gallery_least_length
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> assms snoc apartments<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ch ChamberComplex.min_galleryD_gallery
            ChamberComplex.galleryD_adj
            chambercomplex_fold_A_im
            ChamberComplex.gallery_def<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">Fs</span> <span class="main">=</span> length <span class="skolem">Gs</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> set_gal<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Gs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 3 apartment_min_galleryD_gallery apartment_galleryD_chamber
              apartment_chamberD_simplex
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">from</span></span> assms snoc <span class="keyword1"><span class="command">have</span></span> F_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_galleryD_gallery
              ChamberComplex.galleryD_chamber
              ChamberComplex.chamberD_simplex chambercomplex_fold_A_im
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> fold_A <span class="main">⊨</span> <span class="skolem">Gs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ch_F 3 apartment_min_gallery fold_A_min_gallery_from1_map <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Gs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_gal
              ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span> <span class="main">(</span><span class="free">C</span> <span class="main">#</span> fold_A <span class="main">⊨</span> <span class="skolem">Gs</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> F_in min_gallery_in_apartment
              fold_A_chamber_images<span class="main">(</span>1<span class="main">)</span> fold_A_chamber_system_image_fixespointwise
              simplex_in_fold_A_im_image
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Gs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">⊆</span> fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> set_gal <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms snoc apartments<span class="main">(</span>1<span class="main">)</span> F_in fold_A_chamber_images<span class="main">(</span>1<span class="main">)</span>
              simplex_in_fold_A_im_image
              ChamberComplex.min_gallery_in_subcomplex<span class="main">[</span>
                <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">OF</span> _ chambersubcomplex_fold_A_im
              <span class="main">]</span>
              ChamberComplex.min_gallery_betw_uniform_length<span class="main">[</span> 
                <span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="quoted">"fold_A <span class="main">⊨</span> <span class="skolem">Gs</span>"</span></span> <span class="quoted"><span class="skolem">F</span></span> <span class="quoted"><span class="skolem">Fs</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-fold_A_im_min_gallery"><span class="command">lemma</span></span> fold_A_im_min_gallery<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span> <span class="main">⟹</span> min_gallery <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="free">Cs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> apartments<span class="main">(</span>1<span class="main">)</span> fold_A_im_min_gallery' apartment_min_gallery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>

<span class="keyword1" id="Building-fold_A_comp_fixespointwise"><span class="command">lemma</span></span> fold_A_comp_fixespointwise<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> apartment_standard_uniqueness<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> apartments<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fun_eq_on <span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">(</span>res_fold_A <span class="main">∘</span> res_opp_fold_A<span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexEndomorphism.vertex_map<span class="main">[</span><span class="operator">OF</span> opp_res_fold_A_endo_A<span class="main">]</span>
          fun_eq_onI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"fold_A <span class="main">∘</span> opp_fold_A"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="free">A</span> <span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexEndomorphism.endo_comp<span class="main">[</span>
            <span class="operator">OF</span> opp_res_fold_A_endo_A res_fold_A_endo_A
          <span class="main">]</span>
          ChamberComplexEndomorphism.axioms<span class="main">(</span>1<span class="main">)</span>
          ChamberComplexMorphism.cong
          ChamberComplexMorphism.restrict_domain
          chambersubcomplex_fold_A_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="free">A</span> id"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.restrict_domain apartment_trivial_morphism
          chambersubcomplex_fold_A_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="free">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A_chambers<span class="main">(</span>1<span class="main">)</span> apartment_chamberD_simplex fold_A_chamber_images<span class="main">(</span>1<span class="main">)</span>
          ChamberComplex.chamber_in_subcomplex<span class="main">[</span>
            <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">OF</span> _ chambersubcomplex_fold_A_im<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">C</span></span>
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword1"><span class="command">from</span></span> facet<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∉</span><span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="free">z</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> facetrel_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">C</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fixespointwise <span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">(</span>insert <span class="skolem">v</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fixespointwise_insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fixespointwise_comp<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise opp_fold_A <span class="free">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facet_in_chambers<span class="main">(</span>2<span class="main">)</span> fixespointwise_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted">opp_fold_A</span> <span class="quoted"><span class="free">D</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
              opp_fold_A_fixespointwise2
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fixespointwise fold_A <span class="free">z</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> facet_in_chambers<span class="main">(</span>1<span class="main">)</span> fixespointwise_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted">fold_A</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
              fold_A_fixespointwise1
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">`</span> <span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> opp_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> 
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> v<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">`</span> <span class="main">(</span>insert <span class="skolem">v</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> insert <span class="skolem">v</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">with</span></span> v<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> ChamberComplex.min_gallery <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="bound">Cs</span><span class="main">)</span> <span class="main">⟹</span>
          ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span><span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="bound">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Cs</span> <span class="keyword3"><span class="command">assume</span></span> Cs<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span><span class="main">(</span>fold_A <span class="main">∘</span> opp_fold_A<span class="main">)</span> <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span> <span class="main">#</span> <span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">Cs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> opp_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span>
              A_chambers<span class="main">(</span>1<span class="main">)</span> ChamberComplex.pgallery_def<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_comp<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> sym<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">Fs</span> <span class="skolem">F</span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cs snoc apartments<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_galleryD_gallery<span class="main">[</span>
                <span class="operator">OF</span> chambercomplex_fold_A_im
              <span class="main">]</span>
              ChamberComplex.galleryD_chamber<span class="main">[</span>
                <span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span>"</span></span>
              <span class="main">]</span>
              ChamberComplex.chamberD_simplex<span class="main">[</span><span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">]</span>
              ChamberComplex.subcomplex_chamber<span class="main">[</span>
                <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">OF</span> _ chambersubcomplex_fold_A_im
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> F<span class="main">(</span>2<span class="main">)</span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> F'<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartment_chamber <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
      <span class="keyword1"><span class="command">with</span></span> F<span class="main">(</span>1<span class="main">)</span> apartments<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  zF_CF<span class="main">:</span> <span class="quoted"><span class="quoted">"face_distance <span class="free">z</span> <span class="skolem">F</span> <span class="main">=</span> chamber_distance <span class="free">C</span> <span class="skolem">F</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> chamber_in_fold_A_im<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">F</span></span><span class="main">]</span> fold_A_chamber_system_image
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">C</span> <span class="main">#</span> fold_A <span class="main">⊨</span> <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="skolem">Fs</span> <span class="main">@</span> <span class="main">[</span>opp_fold_A <span class="main">`</span> <span class="skolem">F</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> fold_A_min_gallery_from2_map<span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> Cs snoc
          <span class="keyword1"><span class="command">have</span></span>  Cs'<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.gallery <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Fs</span><span class="main">@</span><span class="main">[</span><span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_galleryD_gallery chambercomplex_fold_A_im
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> chF<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="skolem">F</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ChamberComplex.galleryD_chamber chambercomplex_fold_A_im
                ChamberComplex.subcomplex_chamber<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
                chambersubcomplex_fold_A_im
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"chamber <span class="main">(</span>opp_fold_A <span class="main">`</span> <span class="skolem">F</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.chamber_map opp_fold_A_morph_A_A
                apartment_chamber
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
        <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"opp_fold_A <span class="main">`</span> <span class="skolem">F</span> <span class="main">∈</span> opp_fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chF ChamberComplex.chamberD_simplex complexes <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
        <span class="keyword1"><span class="command">from</span></span> Cs snoc apartments<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span><span class="free">D</span> <span class="main">#</span> opp_fold_A <span class="main">⊨</span> <span class="skolem">Fs</span> <span class="main">@</span> <span class="main">[</span>opp_fold_A <span class="main">`</span> <span class="skolem">F</span><span class="main">]</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> chF Cs' opp_fold_A_min_gallery_from1_map apartment_chamber
                ChamberComplex.chamberD_simplex
                ChamberComplex.galleryD_chamber
                chambercomplex_fold_A_im fold_A_im_min_gallery
          <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">with</span></span> snoc <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min_gallery <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> opp_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Cs apartments<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.min_gallery <span class="free">A</span>
                <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ChamberComplex.min_galleryD_gallery<span class="main">[</span>
                <span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span>
              <span class="main">]</span>
              ChamberComplex.galleryD_chamber<span class="main">[</span>
                <span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">#</span><span class="skolem">Cs</span>"</span></span>
              <span class="main">]</span>
              ChamberComplex.subcomplex_chamber<span class="main">[</span>
                <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">OF</span> _ chambersubcomplex_fold_A_im
              <span class="main">]</span>
              apartment_chamberD_simplex
              ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> opp_fold_A_morph_A_A<span class="main">]</span>
              ChamberComplexMorphism.simplex_map<span class="main">[</span><span class="operator">OF</span> fold_A_morph_A_A<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> min_gallery_in_apartment<span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span>fold_A <span class="main">⊨</span> <span class="main">(</span>opp_fold_A <span class="main">⊨</span> <span class="main">(</span><span class="free">C</span><span class="main">#</span><span class="skolem">Cs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> apartment_min_gallery_pgallery
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> ssubst<span class="main">[</span>
                <span class="operator">OF</span> setlistmapim_comp<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">Cs</span><span class="main">.</span> ChamberComplex.pgallery <span class="free">A</span> <span class="bound">Cs</span>"</span></span>
              <span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Cs</span><span class="main">.</span> ChamberComplex.min_gallery <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="bound">Cs</span> <span class="main">⟹</span>
            ChamberComplex.pgallery <span class="free">A</span> <span class="main">(</span>id <span class="main">⊨</span> <span class="bound">Cs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> chambersubcomplex_fold_A_im
          ChamberComplex.min_gallery_pgallery<span class="main">[</span><span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">]</span>
          ChamberComplex.subcomplex_pgallery<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="quoted">"fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_fold_A_comp_fixespointwise <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.fold_A_comp_fixespointwise<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword1" id="Building-fold_A_fold"><span class="command">lemma</span></span> fold_A_fold<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> fold_A"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexMorphism.isoI_inverse<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> fold_A"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.restrict_domain
          ChamberComplexMorphism.restrict_codomain_to_image
          ChamberComplexMorphism.cong fun_eq_on_sym<span class="main">[</span><span class="operator">OF</span> fun_eq_on_restrict1<span class="main">]</span>
          ChamberComplexEndomorphism.axioms<span class="main">(</span>1<span class="main">)</span> res_fold_A_endo_A
          chambersubcomplex_opp_fold_A_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexMorphism <span class="main">(</span>fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span> opp_fold_A"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexMorphism.restrict_domain
          ChamberComplexMorphism.restrict_codomain_to_image
          ChamberComplexMorphism.cong fun_eq_on_sym<span class="main">[</span><span class="operator">OF</span> fun_eq_on_restrict1<span class="main">]</span>
          ChamberComplexEndomorphism.axioms<span class="main">(</span>1<span class="main">)</span> opp_res_fold_A_endo_A
          chambersubcomplex_fold_A_im
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> opp_fold_A_comp_fixespointwise<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> fold_A_comp_fixespointwise<span class="main">)</span>

<span class="keyword1" id="Building-res_fold_A"><span class="command">lemma</span></span> res_fold_A<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> res_fold_A"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexFolding.intro<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ChamberComplexEndomorphism <span class="free">A</span> <span class="main">(</span>res_fold_A<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> res_fold_A_endo_A <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"ChamberComplexRetraction <span class="free">A</span> <span class="main">(</span>res_fold_A<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ChamberComplexRetraction.intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold_locales</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="main">⋃</span><span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">with</span></span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">∈</span><span class="skolem">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartment_simplex_in_max apartment_chamber_system_def
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"res_fold_A <span class="main">(</span>res_fold_A <span class="skolem">v</span><span class="main">)</span> <span class="main">=</span> res_fold_A <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> fold_A_chamber_system_image_fixespointwise fixespointwiseD
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding_axioms <span class="free">A</span> res_fold_A"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">F</span> <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="skolem">F</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> res_fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> F<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> F'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> setsetmapim_restrict1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted">fold_A</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">∈</span> fold_A <span class="main">⊢</span> <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplexIsomorphism.surj_simplex_map<span class="main">[</span><span class="operator">OF</span> fold_A_fold<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">G</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> opp_fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">F</span> <span class="main">=</span> fold_A <span class="main">`</span> <span class="skolem">G</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> F<span class="main">(</span>1<span class="main">)</span> F' apartments<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  G'<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplex.chamber <span class="free">A</span> <span class="skolem">G</span>"</span></span>
                <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∈</span> ChamberComplex.𝒞 <span class="main">(</span>opp_fold_A <span class="main">⊢</span> <span class="free">A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ChamberComplex.chamber_in_subcomplex<span class="main">[</span><span class="operator">OF</span> complexes<span class="main">]</span>
            chambersubcomplex_fold_A_im
            ChamberComplexIsomorphism.chamber_preimage<span class="main">[</span><span class="operator">OF</span> fold_A_fold<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">G</span></span><span class="main">]</span>
            ChamberComplex.subcomplex_chamber<span class="main">[</span>
              <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">OF</span> apartments<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> chambersubcomplex_opp_fold_A_im
            <span class="main">]</span>
            ChamberComplex.chamber_system_def<span class="main">[</span>
              <span class="operator">OF</span> chambercomplex_opp_fold_A_im
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>

    <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> G<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">H</span><span class="main">.</span> ChamberComplex.chamber <span class="free">A</span> <span class="bound">H</span> <span class="main">∧</span> <span class="bound">H</span> <span class="main">∉</span> fold_A <span class="main">⊢</span> <span class="free">A</span> <span class="main">∧</span>
                fold_A <span class="main">`</span> <span class="bound">H</span> <span class="main">=</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="bound">H</span><span class="main">=</span><span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G'<span class="main">(</span>2<span class="main">)</span> apartment_chamber_system_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
            fold_A_opp_fold_A_chamber_systems<span class="main">(</span>1<span class="main">)</span>
            chambercomplex_fold_A_im ChamberComplex.chamber_system_def
            ChamberComplex.chamberD_simplex
            inj_onD<span class="main">[</span>
              <span class="operator">OF</span> ChamberComplexIsomorphism.inj_on_chamber_system<span class="main">,</span>
              <span class="operator">OF</span> fold_A_fold
            <span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> apartments<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">H</span><span class="main">.</span> ChamberComplex.chamber <span class="free">A</span> <span class="bound">H</span> <span class="main">∧</span> <span class="bound">H</span> <span class="main">∉</span> res_fold_A <span class="main">⊢</span> <span class="free">A</span> <span class="main">∧</span>
              res_fold_A <span class="main">`</span> <span class="bound">H</span> <span class="main">=</span> <span class="skolem">F</span> <span class="main">⟹</span> <span class="bound">H</span><span class="main">=</span><span class="skolem">G</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 res_fold_A_A_chamber_image apartment_chamberD_simplex
            res_fold_A_A_im_fold_A_A_im
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> apartments<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">∉</span> res_fold_A <span class="main">⊢</span> <span class="free">A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G'
            ChamberComplex.chamber_system_def<span class="main">[</span><span class="operator">OF</span> chambercomplex_fold_A_im<span class="main">]</span>
            ChamberComplex.chamber_in_subcomplex<span class="main">[</span>
              <span class="operator">OF</span> complexes<span class="main">,</span> <span class="operator">OF</span> _ chambersubcomplex_fold_A_im
            <span class="main">]</span>
            fold_A_opp_fold_A_chamber_systems<span class="main">(</span>2<span class="main">)</span> res_fold_A_A_im_fold_A_A_im
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span>
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃!</span><span class="bound">G</span><span class="main">.</span> ChamberComplex.chamber <span class="free">A</span> <span class="bound">G</span> <span class="main">∧</span> <span class="bound">G</span> <span class="main">∉</span> res_fold_A <span class="main">⊢</span> <span class="free">A</span> <span class="main">∧</span>
              res_fold_A <span class="main">`</span> <span class="bound">G</span> <span class="main">=</span> <span class="skolem">F</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G'<span class="main">(</span>1<span class="main">)</span> G<span class="main">(</span>2<span class="main">)</span> res_fold_A_A_chamber_image ex1I<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">G</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
  <span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> opp_res_fold_A <span class="main">=</span>
  ChamberComplexApartmentSystemTriangle.res_fold_A<span class="main">[</span><span class="operator">OF</span> reflect<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context ChamberComplexApartmentSystemTriangle *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Building locale and basic lemmas›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Finally, we define a (thick) building to be a thick chamber complex with a system of apartments.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> Building <span class="main">=</span> ChamberComplexWithApartmentSystem <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">𝒜</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">X</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">𝒜</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set set"</span></span>
<span class="main">+</span> <span class="keyword2"><span class="keyword">assumes</span></span> thick<span class="main">:</span> <span class="quoted"><span class="quoted">"ThickChamberComplex <span class="free">X</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">some_third_chamber</span> <span class="main">≡</span>
                ThickChamberComplex.some_third_chamber <span class="free">X</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> some_third_chamberD_facet <span class="main">=</span>
  ThickChamberComplex.some_third_chamberD_facet <span class="main">[</span><span class="operator">OF</span> thick<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> some_third_chamberD_ne <span class="main">=</span>
  ThickChamberComplex.some_third_chamberD_ne <span class="main">[</span><span class="operator">OF</span> thick<span class="main">]</span>

<span class="keyword1"><span class="command">lemmas</span></span> chamber_some_third_chamber <span class="main">=</span>
  ThickChamberComplex.chamber_some_third_chamber <span class="main">[</span><span class="operator">OF</span> thick<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Building *)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Apartments are uniformly Coxeter›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  Using the assumption of thickness, we may use the special situation
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> ChamberComplexApartmentSystemTriangle<span class="antiquote"><span class="antiquote">}</span></span></span></span> to verify that apartments have enough pairs of
  opposed foldings to ensure that they are isomorphic to a Coxeter complex. Since the apartments
  are all isomorphic, they are uniformly isomorphic to a single Coxeter complex.
›</span></span>

<span class="keyword1"><span class="command">context</span></span> Building
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Building-apartments_have_many_foldings1"><span class="command">lemma</span></span> apartments_have_many_foldings1<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≡</span> some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span>  <span class="main">≡</span> supapartment <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">≡</span> supapartment <span class="free">D</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">∘</span> canonical_retraction <span class="free">B</span>  <span class="free">C</span><span class="main">)</span>
            <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="free">B'</span> <span class="free">D</span><span class="main">)</span>
            <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> <span class="free">f</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> <span class="free">g</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span>
    <span class="quoted"><span class="quoted">"ChamberComplexApartmentSystemTriangle <span class="free">X</span> <span class="free">𝒜</span> <span class="free">A</span> <span class="free">B</span> <span class="free">B'</span> <span class="free">C</span> <span class="free">D</span> <span class="free">E</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adjacent_int_facet1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span> adjacent_int_facet2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
          some_third_chamberD_facet chamber_some_third_chamber
          some_third_chamberD_ne<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="free"><span class="free">C</span></span><span class="main"><span class="main">∩</span></span><span class="free"><span class="free">D</span></span>"</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="main">]</span> supapartmentD
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">unfold_locales</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> f_def g_def
    <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> <span class="free">g</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">D</span>"</span></span> 
    <span class="keyword1"><span class="command">using</span></span> ChamberComplexApartmentSystemTriangle.res_fold_A <span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span>
          ChamberComplexApartmentSystemTriangle.opp_res_fold_A<span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span>
          ChamberComplexApartmentSystemTriangle.res_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span><span class="main">[</span>
            <span class="operator">OF</span> 1
          <span class="main">]</span>
          ChamberComplexApartmentSystemTriangle.res_opp_fold_A_chamber_images<span class="main">(</span>2<span class="main">)</span><span class="main">[</span>
            <span class="operator">OF</span> 1
          <span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-apartments_have_many_foldings2"><span class="command">lemma</span></span> apartments_have_many_foldings2<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">E</span> <span class="main">≡</span> some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span>  <span class="main">≡</span> supapartment <span class="free">C</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">B'</span> <span class="main">≡</span> supapartment <span class="free">D</span> <span class="free">E</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">≡</span> restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">∘</span> canonical_retraction <span class="free">B</span>  <span class="free">C</span><span class="main">)</span>
            <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>     <span class="quoted"><span class="quoted">"<span class="free">g</span> <span class="main">≡</span> restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="free">B'</span> <span class="free">D</span><span class="main">)</span>
            <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">A</span> <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> OpposedThinChamberComplexFoldings.intro<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"ChamberComplexFolding <span class="free">A</span> <span class="free">g</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartments_have_many_foldings1<span class="main">(</span>2<span class="main">,</span>4<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">A</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">C</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">D</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings_axioms <span class="free">A</span> <span class="free">f</span> <span class="free">g</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
    <span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chamber_in_apartment<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
  <span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-7<span class="main">)</span> E_def B_def B'_def g_def f_def
      <span class="keyword1"><span class="command">have</span></span>  gC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">D</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span>   fD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">D</span> <span class="main">=</span> <span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartments_have_many_foldings1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
            apartments_have_many_foldings1<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">∼</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">≠</span> <span class="free">g</span><span class="main">`</span><span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span><span class="main">`</span><span class="free">g</span><span class="main">`</span><span class="free">C</span> <span class="main">=</span> <span class="free">C</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">rule</span> thincomplexes<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Building-apartments_have_many_foldings3"><span class="command">lemma</span></span> apartments_have_many_foldings3<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∼</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">≠</span><span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span><span class="main">∈</span><span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">A</span> <span class="bound">f</span> <span class="bound">g</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">D</span><span class="main">=</span><span class="bound">g</span><span class="main">`</span><span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">E</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">E</span> <span class="main">=</span> some_third_chamber <span class="free">C</span> <span class="free">D</span> <span class="main">(</span><span class="free">C</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span> <span class="main">=</span> supapartment <span class="free">C</span> <span class="skolem">E</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">=</span> restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">D</span> <span class="main">∘</span> canonical_retraction <span class="skolem">B</span> <span class="free">C</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">g</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">A</span> <span class="skolem">f</span> <span class="bound">g</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">D</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">`</span> <span class="free">C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span> <span class="main">=</span> supapartment <span class="free">D</span> <span class="skolem">E</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">g</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">g</span> <span class="main">=</span> restrict1 <span class="main">(</span>canonical_retraction <span class="free">A</span> <span class="free">C</span> <span class="main">∘</span> canonical_retraction <span class="skolem">B'</span> <span class="free">D</span><span class="main">)</span> <span class="main">(</span><span class="main">⋃</span><span class="free">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> assms E_def B_def f_def B'_def g_def
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"OpposedThinChamberComplexFoldings <span class="free">A</span> <span class="skolem">f</span> <span class="skolem">g</span> <span class="free">C</span> <span class="main">∧</span> <span class="free">D</span> <span class="main">=</span> <span class="skolem">g</span><span class="main">`</span><span class="free">C</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartments_have_many_foldings1<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">C</span></span> <span class="quoted"><span class="free">D</span></span><span class="main">]</span>
            apartments_have_many_foldings2
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Building-apartments_have_many_foldings"><span class="command">lemma</span></span> apartments_have_many_foldings<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"chamber <span class="free">C</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"ThinChamberComplexManyFoldings <span class="free">A</span> <span class="free">C</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span>
  <span class="operator">rule</span> ThinChamberComplex.ThinChamberComplexManyFoldingsI<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> thincomplexes<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> chamber_in_apartment<span class="main"><span class="keyword3">,</span></span>
  <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">C</span> <span class="bound">D</span><span class="main">.</span> ChamberComplex.chamber <span class="free">A</span> <span class="bound">C</span> <span class="main">⟹</span>
            ChamberComplex.chamber <span class="free">A</span> <span class="bound">D</span> <span class="main">⟹</span> <span class="bound">C</span><span class="main">∼</span><span class="bound">D</span> <span class="main">⟹</span>
            <span class="bound">C</span><span class="main">≠</span><span class="bound">D</span> <span class="main">⟹</span>
            <span class="main">∃</span><span class="bound">f</span> <span class="bound">g</span><span class="main">.</span> OpposedThinChamberComplexFoldings <span class="free">A</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">C</span> <span class="main">∧</span> <span class="bound">D</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">`</span> <span class="bound">C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartments_have_many_foldings3 apartment_chamber
          apartment_chamberD_simplex
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> apartments_are_coxeter<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">A</span><span class="main">∈</span><span class="free">𝒜</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'a</span> permutation set<span class="main">.</span> <span class="main">(</span>
    CoxeterComplex <span class="bound">S</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span> ChamberComplexIsomorphism <span class="free">A</span> <span class="main">(</span>CoxeterComplex.TheComplex <span class="bound">S</span><span class="main">)</span> <span class="bound">ψ</span><span class="main">)</span>
  <span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> no_trivial_apartments apartment_simplex_in_max<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        apartment_chamberD_simplex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span> apartment_chamber<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        apartments_have_many_foldings<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
        ThinChamberComplexManyFoldings.ex_iso_to_coxeter_complex<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">A</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">corollary</span></span> apartments_are_uniformly_coxeter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span><span class="main">≠</span><span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">S</span><span class="main">::</span><span class="tfree">'a</span> permutation set<span class="main">.</span> CoxeterComplex <span class="bound">S</span> <span class="main">∧</span>
            <span class="main">(</span><span class="main">∀</span><span class="bound">A</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">.</span> <span class="main">∃</span><span class="bound">ψ</span><span class="main">.</span>
              ChamberComplexIsomorphism <span class="bound">A</span> <span class="main">(</span>CoxeterComplex.TheComplex <span class="bound">S</span><span class="main">)</span> <span class="bound">ψ</span>
            <span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C</span></span> <span class="keyword2"><span class="keyword">where</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> simplex_in_max <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> this <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="keyword2"><span class="keyword">where</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> containtwo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">from</span></span> A<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> permutation set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ψ</span></span>
    <span class="keyword2"><span class="keyword">where</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"CoxeterComplex <span class="skolem">S</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span>   ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"ChamberComplexIsomorphism <span class="skolem">A</span> <span class="main">(</span>CoxeterComplex.TheComplex <span class="skolem">S</span><span class="main">)</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> apartments_are_coxeter
    <span class="keyword1"><span class="command">by</span></span>    <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">B</span><span class="main">∈</span><span class="free">𝒜</span><span class="main">.</span> <span class="main">∃</span><span class="bound">φ</span><span class="main">.</span>
        ChamberComplexIsomorphism <span class="bound">B</span> <span class="main">(</span>CoxeterComplex.TheComplex <span class="skolem">S</span><span class="main">)</span> <span class="bound">φ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">B</span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B</span><span class="main">≠</span><span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> no_trivial_apartments <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">C'</span></span> <span class="keyword2"><span class="keyword">where</span></span> C'<span class="main">:</span> <span class="quoted"><span class="quoted">"chamber <span class="skolem">C'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span><span class="main">∈</span><span class="skolem">B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> apartment_simplex_in_max apartment_chamberD_simplex
            apartment_chamber<span class="main">[</span><span class="operator">OF</span> B<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">force</span>
    <span class="keyword1"><span class="command">from</span></span> C C'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">B'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">B'</span><span class="main">∈</span><span class="free">𝒜</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C</span><span class="main">∈</span><span class="skolem">B'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">C'</span><span class="main">∈</span><span class="skolem">B'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> containtwo <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
    <span class="keyword1"><span class="command">with</span></span> A B C C' ψ
      <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">φ</span><span class="main">.</span> ChamberComplexIsomorphism <span class="skolem">B</span>
              <span class="main">(</span>CoxeterComplex.TheComplex <span class="skolem">S</span><span class="main">)</span> <span class="bound">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> strong_intersecttwo
            ChamberComplexIsomorphism.iso_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B'</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span>
            ChamberComplexIsomorphism.iso_comp<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">B</span></span> <span class="quoted"><span class="skolem">B'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span>    <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> S <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* context Building *)</span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(* theory *)</span>
</pre>
</div>