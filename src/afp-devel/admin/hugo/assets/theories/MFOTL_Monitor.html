<div id="Trace">
<div class="head">
<h1>Theory Trace</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Trace
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Stream.html">HOL-Library.Stream</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Traces and trace prefixes›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Infinite traces›</span></span>

<span class="keyword1"><span class="command">coinductive</span></span> <span class="entity">ssorted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linorder stream <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"shd <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≤</span> shd <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ssorted</span> <span class="main">(</span>stl <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ssorted</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1" id="Trace-ssorted_siterate"><span class="command">lemma</span></span> ssorted_siterate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span> ssorted <span class="main">(</span>siterate <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-ssortedD"><span class="command">lemma</span></span> ssortedD<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">≤</span> stl <span class="free">s</span> <span class="main">!!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssorted.cases<span class="main">)</span>

<span class="keyword1" id="Trace-ssorted_sdrop"><span class="command">lemma</span></span> ssorted_sdrop<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> ssorted <span class="main">(</span>sdrop <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssorted.cases ssortedD<span class="main">)</span>

<span class="keyword1" id="Trace-ssorted_monoD"><span class="command">lemma</span></span> ssorted_monoD<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">i</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2-4<span class="main">)</span> ssortedD<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq Suc_diff_le<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Trace-sorted_stake"><span class="command">lemma</span></span> sorted_stake<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟹</span> sorted <span class="main">(</span>stake <span class="free">i</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> ssorted.cases <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_conv_nth
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> ssorted_monoD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> order_trans<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ ssortedD<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trace-ssorted_monoI"><span class="command">lemma</span></span> ssorted_monoI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">j</span> <span class="main">⟹</span> ssorted <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> spec2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main">0</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trace-ssorted_iff_mono"><span class="command">lemma</span></span> ssorted_iff_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ssorted_monoI ssorted_monoD <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1" id="Trace-ssorted_iff_le_Suc"><span class="command">lemma</span></span> ssorted_iff_le_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">.</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="free">s</span> <span class="main">!!</span> Suc <span class="bound">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mono_iff_le_Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"snth <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mono_def ssorted_iff_mono<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sincreasing</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Trace-sincreasingI"><span class="command">lemma</span></span> sincreasingI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sincreasing_def<span class="main">)</span>

<span class="keyword1" id="Trace-sincreasing_grD"><span class="command">lemma</span></span> sincreasing_grD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semilattice_sup"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">&gt;</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"insert <span class="free">x</span> <span class="main">{</span><span class="free">s</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">|</span> <span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> <span class="free">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"Sup_fin <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sincreasing_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> order.strict_trans1<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_fin.coboundedI<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">≤</span> Sup_fin <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_fin.coboundedI<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-sincreasing_siterate_nat"><span class="command">lemma</span></span> sincreasing_siterate_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">n</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="free">f</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span>siterate <span class="free">f</span> <span class="free">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> sincreasing_def <span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans1<span class="main">[</span><span class="operator">OF</span> le0 assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">x</span> <span class="main">&lt;</span> siterate <span class="free">f</span> <span class="free">n</span> <span class="main">!!</span> Suc <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> order.strict_trans1<span class="main">[</span><span class="operator">OF</span> _ assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> snth.simps<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-sincreasing_stl"><span class="command">lemma</span></span> sincreasing_stl<span class="main">:</span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span> <span class="main">⟹</span> sincreasing <span class="main">(</span>stl <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> semilattice_sup stream"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sincreasingI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sincreasing_grD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">s</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> stream<span class="main">.</span> ssorted <span class="main">(</span>smap snd <span class="bound">s</span><span class="main">)</span> <span class="main">∧</span> sincreasing <span class="main">(</span>smap snd <span class="bound">s</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"smap <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">λ</span></span></span><span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">{}</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">i</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> nats"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp stream.map_ident <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_trace

<span class="keyword1"><span class="command">lift_definition</span></span> Γ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> fst <span class="main">(</span><span class="bound">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> τ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">s</span> <span class="bound">i</span><span class="main">.</span> snd <span class="main">(</span><span class="bound">s</span> <span class="main">!!</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Trace-stream_eq_iff"><span class="command">lemma</span></span> stream_eq_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">n</span><span class="main">.</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">n</span> <span class="main">=</span> <span class="free">s'</span> <span class="main">!!</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> stream.map_cong0 stream_smap_nats<span class="main">)</span>

<span class="keyword1" id="Trace-trace_eqI"><span class="command">lemma</span></span> trace_eqI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> Γ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> Γ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">σ</span> <span class="main">=</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream_eq_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prod_eqI<span class="main">)</span>

<span class="keyword1" id="Trace-τ_mono"><span class="command">lemma</span></span> τ_mono<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> τ <span class="free">s</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">s</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_iff_mono<span class="main">)</span>

<span class="keyword1" id="Trace-ex_le_τ"><span class="command">lemma</span></span> ex_le_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free">i</span><span class="main">.</span> <span class="free">x</span> <span class="main">≤</span> τ <span class="free">s</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sincreasing_grD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">x</span></span><span class="main"><span class="main">]</span></span> less_imp_le<span class="main">)</span>

<span class="keyword1" id="Trace-le_τ_less"><span class="command">lemma</span></span> le_τ_less<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> antisym<span class="main">)</span>

<span class="keyword1" id="Trace-less_τD"><span class="command">lemma</span></span> less_τD<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">i</span> <span class="main">&lt;</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono less_le_not_le not_le_imp_less<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Δ</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span> τ <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> map_Γ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'b</span> trace"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span> <span class="bound">s</span><span class="main">.</span> smap <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="bound">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp prod.case_eq_if <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>

<span class="keyword1" id="Trace-Γ_map_Γ"><span class="command">lemma</span></span> Γ_map_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Γ <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span>Γ <span class="free">s</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>

<span class="keyword1" id="Trace-τ_map_Γ"><span class="command">lemma</span></span> τ_map_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">s</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> prod.case_eq_if<span class="main">)</span>

<span class="keyword1" id="Trace-map_Γ_id"><span class="command">lemma</span></span> map_Γ_id<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map_Γ id <span class="free">s</span> <span class="main">=</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_id<span class="main">)</span>

<span class="keyword1" id="Trace-map_Γ_comp"><span class="command">lemma</span></span> map_Γ_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"map_Γ <span class="free">g</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> map_Γ <span class="main">(</span><span class="free">g</span> <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stream.map_comp comp_def prod.case_eq_if case_prod_beta'<span class="main">)</span>

<span class="keyword1" id="Trace-map_Γ_cong"><span class="command">lemma</span></span> map_Γ_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> <span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="bound">x</span> <span class="main">=</span> <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> map_Γ <span class="free">f<span class="hidden">⇩</span><sub>1</sub></span> <span class="free">σ<span class="hidden">⇩</span><sub>1</sub></span> <span class="main">=</span> map_Γ <span class="free">f<span class="hidden">⇩</span><sub>2</sub></span> <span class="free">σ<span class="hidden">⇩</span><sub>2</sub></span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Finite trace prefixes›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> prefix <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">p</span> <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> list<span class="main">.</span> sorted <span class="main">(</span>map snd <span class="bound">p</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_prefix

<span class="keyword1"><span class="command">lift_definition</span></span> pmap_Γ <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'b</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'b</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta comp_def<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> last_ts <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> snd <span class="main">(</span>last <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> first_ts <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="bound">p</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> snd <span class="main">(</span>hd <span class="bound">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> pnil <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lift_definition</span></span> plen <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"length"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> psnoc <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> snd <span class="main">(</span>last <span class="bound">p</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> snd <span class="bound">x</span> <span class="keyword1">then</span> <span class="bound">p</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">goal_cases</span> sorted_psnoc<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sorted_psnoc <span class="skolem">p</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> prefix <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">order</span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_prefix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="bound">q</span> <span class="main">=</span> <span class="bound">p</span> <span class="main">@</span> <span class="bound">r</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">less_prefix</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">less_prefix</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> less refl trans antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>less <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> less_prefix_def <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>refl <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>trans <span class="skolem">x</span> <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>antisym <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Trace-psnoc_inject"><span class="command">lemma</span></span> psnoc_inject<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"last_ts <span class="free">p</span> <span class="main">≤</span> snd <span class="free">x</span> <span class="main">⟹</span> last_ts <span class="free">q</span> <span class="main">≤</span> snd <span class="free">y</span> <span class="main">⟹</span> psnoc <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> psnoc <span class="free">q</span> <span class="free">y</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> prefix_of <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">p</span> <span class="bound">s</span><span class="main">.</span> stake <span class="main">(</span>length <span class="bound">p</span><span class="main">)</span> <span class="bound">s</span> <span class="main">=</span> <span class="bound">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Trace-prefix_of_pnil"><span class="command">lemma</span></span> prefix_of_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of pnil <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-plen_pnil"><span class="command">lemma</span></span> plen_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plen pnil <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-prefix_of_pmap_Γ"><span class="command">lemma</span></span> prefix_of_pmap_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-plen_mono"><span class="command">lemma</span></span> plen_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> plen <span class="free">π</span> <span class="main">≤</span> plen <span class="free">π'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-prefix_of_psnocE"><span class="command">lemma</span></span> prefix_of_psnocE<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> last_ts <span class="free">p</span> <span class="main">≤</span> snd <span class="free">x</span> <span class="main">⟹</span>
  <span class="main">(</span>prefix_of <span class="free">p</span> <span class="free">s</span> <span class="main">⟹</span> Γ <span class="free">s</span> <span class="main">(</span>plen <span class="free">p</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span> <span class="main">⟹</span> τ <span class="free">s</span> <span class="main">(</span>plen <span class="free">p</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake.simps <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_Suc<span class="main">)</span>

<span class="keyword1" id="Trace-le_pnil"><span class="command">lemma</span></span> le_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pnil <span class="main">≤</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> take_prefix <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">stake</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_stake<span class="main">)</span>

<span class="keyword1" id="Trace-plen_take_prefix"><span class="command">lemma</span></span> plen_take_prefix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plen <span class="main">(</span>take_prefix <span class="free">i</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-plen_psnoc"><span class="command">lemma</span></span> plen_psnoc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">x</span> <span class="main">⟹</span> plen <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> plen <span class="free">π</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-prefix_of_take_prefix"><span class="command">lemma</span></span> prefix_of_take_prefix<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>take_prefix <span class="free">i</span> <span class="free">σ</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lift_definition</span></span> pdrop <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">drop</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> drop_map<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sorted_drop<span class="main">)</span>

<span class="keyword1" id="Trace-pdrop_0"><span class="command">lemma</span></span> pdrop_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pdrop <span class="main">0</span> <span class="free">π</span> <span class="main">=</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Trace-prefix_of_antimono"><span class="command">lemma</span></span> prefix_of_antimono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> prefix_of <span class="free">π'</span> <span class="free">s</span> <span class="main">⟹</span> prefix_of <span class="free">π</span> <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> stake_add <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_add<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trace-prefix_of_imp_linear"><span class="command">lemma</span></span> prefix_of_imp_linear<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="free">π'</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">∨</span> <span class="free">π'</span> <span class="main">≤</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">transfer</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">π'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> stream"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">σ</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span> <span class="main">@</span> <span class="bound">r</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="bound">r</span><span class="main">.</span> <span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span> <span class="main">@</span> <span class="bound">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"length <span class="skolem">π</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">π'</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> le_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> le
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π'</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π'</span> <span class="main">=</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms le <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb1 take_stake<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ge
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> take <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">π</span> <span class="main">@</span> drop <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">π</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>length <span class="skolem">π'</span><span class="main">)</span> <span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> min.absorb1 take_stake<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-ex_prefix_of"><span class="command">lemma</span></span> ex_prefix_of<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s</span><span class="main">.</span> prefix_of <span class="free">p</span> <span class="bound">s</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> bexI CollectI conjI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> set <span class="main">×</span> nat<span class="main">)</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map snd <span class="skolem">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?σ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">@-</span> smap <span class="main">(</span>Pair undefined<span class="main">)</span> <span class="main">(</span>fromN <span class="main">(</span>snd <span class="main">(</span>last <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="skolem">p</span><span class="main">)</span> <span class="var">?σ</span> <span class="main">=</span> <span class="skolem">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_shift<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> le_last<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span><span class="skolem">p</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> snd <span class="main">(</span>last <span class="skolem">p</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">p</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> sorted_nth_mono<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> that
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> last_conv_nth nth_Cons'<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span>smap snd <span class="var">?σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_iff_mono sorted_iff_nth_mono shift_snth<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span>smap snd <span class="var">?σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sincreasingI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> smap snd <span class="var">?σ</span> <span class="main">!!</span> Suc <span class="main">(</span>length <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> <span class="main">(</span><span class="operator">metis</span> Suc_pred add.commute diff_Suc_Suc length_greater_0_conv less_add_Suc1 less_diff_conv<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> smap snd <span class="var">?σ</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-τ_prefix_conv"><span class="command">lemma</span></span> τ_prefix_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">p</span> <span class="free">s</span> <span class="main">⟹</span> prefix_of <span class="free">p</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> plen <span class="free">p</span> <span class="main">⟹</span> τ <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">s'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trace-Γ_prefix_conv"><span class="command">lemma</span></span> Γ_prefix_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">p</span> <span class="free">s</span> <span class="main">⟹</span> prefix_of <span class="free">p</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> plen <span class="free">p</span> <span class="main">⟹</span> Γ <span class="free">s</span> <span class="free">i</span> <span class="main">=</span> Γ <span class="free">s'</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> stake_nth<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Trace-sincreasing_sdrop"><span class="command">lemma</span></span> sincreasing_sdrop<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> semilattice_sup<span class="main">)</span> stream"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span>sdrop <span class="free">n</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sincreasingI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sincreasing_grD<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> sdrop <span class="free">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sdrop_snth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> sdrop <span class="free">n</span> <span class="free">s</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-ssorted_shift"><span class="command">lemma</span></span> ssorted_shift<span class="main">:</span>
  <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sorted <span class="free">xs</span> <span class="main">∧</span> ssorted <span class="free">s</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>sset <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_iff_mono shift_snth sorted_iff_nth_mono <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> ssorted_sdrop<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sdrop_shift<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> sset <span class="free">s</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">!!</span> <span class="skolem">j</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_conv_nth sset_range<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> ssorted_monoD<span class="main">[</span><span class="operator">OF</span> *<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">+</span> length <span class="free">xs</span>"</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sorted <span class="free">xs</span>"</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>set <span class="free">xs</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">∈</span>sset <span class="free">s</span><span class="main">.</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ssorted <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">coinduction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>ssorted <span class="skolem">xs</span> <span class="skolem">s</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹ssorted <span class="skolem">s</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> ssorted.simps<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> neq_Nil_conv shd_sset <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-sincreasing_shift"><span class="command">lemma</span></span> sincreasing_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="free">s</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sincreasing <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sincreasingI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">s</span> <span class="main">!!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sincreasing_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">!!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@-</span> <span class="free">s</span><span class="main">)</span> <span class="main">!!</span> <span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> replace_prefix <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'a</span> trace"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">π</span> <span class="bound">σ</span><span class="main">.</span> <span class="keyword1">if</span> ssorted <span class="main">(</span>smap snd <span class="main">(</span><span class="bound">π</span> <span class="main">@-</span> sdrop <span class="main">(</span>length <span class="bound">π</span><span class="main">)</span> <span class="bound">σ</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
     <span class="bound">π</span> <span class="main">@-</span> sdrop <span class="main">(</span>length <span class="bound">π</span><span class="main">)</span> <span class="bound">σ</span> <span class="keyword1">else</span> smap <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> nats"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> stream.map_comp stream.map_ident sdrop_smap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_smap <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sincreasing_shift sincreasing_sdrop <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> stream.map_cong<span class="main">)</span>

<span class="keyword1" id="Trace-prefix_of_replace_prefix"><span class="command">lemma</span></span> prefix_of_replace_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="free">π</span> <span class="main">(</span>replace_prefix <span class="free">π</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">π</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake_sdrop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_shift split_beta o_def stake_shift sdrop_smap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        ssorted_sdrop not_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_smap<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-map_Γ_replace_prefix"><span class="command">lemma</span></span> map_Γ_replace_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⟹</span> prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟹</span> map_Γ <span class="free">f</span> <span class="main">(</span>replace_prefix <span class="free">π</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> map_Γ <span class="free">f</span> <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">f</span> <span class="skolem">π</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> stake_sdrop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
        <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> stake_sdrop<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ssorted_shift split_beta o_def stake_shift sdrop_smap<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> ssorted_sdrop
        not_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> sdrop_smap <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-prefix_of_pmap_Γ_D"><span class="command">lemma</span></span> prefix_of_pmap_Γ_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="free">π</span> <span class="bound">σ'</span> <span class="main">∧</span> prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="bound">σ'</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="skolem">σ'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Trace-prefix_of_map_Γ_D"><span class="command">lemma</span></span> prefix_of_map_Γ_D<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π'</span> <span class="main">(</span>map_Γ <span class="free">f</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">π''</span><span class="main">.</span> <span class="free">π'</span> <span class="main">=</span> pmap_Γ <span class="free">f</span> <span class="bound">π''</span> <span class="main">∧</span> prefix_of <span class="bound">π''</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"stake <span class="main">(</span>length <span class="main">_</span><span class="main">)</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> sym <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> sorted_stake<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> pts <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"map snd"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Trace-pts_pmap_Γ"><span class="command">lemma</span></span> pts_pmap_Γ<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pts <span class="main">(</span>pmap_Γ <span class="free">f</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> pts <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Table">
<div class="head">
<h1>Theory Table</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Table
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Finite tables›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">tabulate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free">tabulate</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1" id="Table-tabulate_alt"><span class="command">lemma</span></span> tabulate_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"tabulate <span class="free">f</span> <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> map <span class="free">f</span> <span class="main">[</span><span class="free">x</span> <span class="main">..&lt;</span> <span class="free">x</span> <span class="main">+</span> <span class="free">n</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le Suc_le_eq upt_rec<span class="main">)</span>

<span class="keyword1" id="Table-length_tabulate"><span class="command">lemma</span></span> length_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>tabulate <span class="free">f</span> <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Table-map_tabulate"><span class="command">lemma</span></span> map_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="free">f</span> <span class="main">(</span>tabulate <span class="free">g</span> <span class="free">x</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="main">(</span><span class="free">g</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Table-nth_tabulate"><span class="command">lemma</span></span> nth_tabulate<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> tabulate <span class="free">f</span> <span class="free">x</span> <span class="free">n</span> <span class="main">!</span> <span class="free">k</span> <span class="main">=</span> <span class="free">f</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">k</span></span><span class="main">)</span> <span class="operator">simp_all</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> tuple <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> table <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_tuple</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_tuple</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> length <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">table</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">.</span> wf_tuple <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty_table</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">unit_table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> None<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">singleton_table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span>tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="bound">j</span> <span class="keyword1">then</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Table-in_empty_table"><span class="command">lemma</span></span> in_empty_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">∈</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Table-empty_table"><span class="command">lemma</span></span> empty_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Table-unit_table_wf_tuple"><span class="command">lemma</span></span> unit_table_wf_tuple<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> unit_table <span class="free">n</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Table-unit_table"><span class="command">lemma</span></span> unit_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span>unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Table-in_unit_table"><span class="command">lemma</span></span> in_unit_table<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> unit_table <span class="free">n</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">{}</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> unit_table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1" id="Table-singleton_table_wf_tuple"><span class="command">lemma</span></span> singleton_table_wf_tuple<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> singleton_table <span class="free">n</span> <span class="free">i</span> <span class="free">z</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> singleton_table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Table-singleton_table"><span class="command">lemma</span></span> singleton_table<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span>singleton_table <span class="free">n</span> <span class="free">i</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Table-table_Un"><span class="command">lemma</span></span> table_Un<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="free">Y</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-wf_tuple_length"><span class="command">lemma</span></span> wf_tuple_length<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span> <span class="main">⟹</span> length <span class="free">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">join1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple <span class="main">×</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>Cons None<span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>Cons <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> map_option <span class="main">(</span>Cons <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>
    <span class="keyword1">then</span> map_option <span class="main">(</span>Cons <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">join1</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">join1</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">join</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">join</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">B</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> Option.these <span class="main">(</span>join1 <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">-</span> Option.these <span class="main">(</span>join1 <span class="main">`</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">B</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Table-join_True_code"><span class="command">lemma</span></span> join_True_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">A</span> True <span class="free">B</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">a</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> set_option <span class="main">(</span>join1 <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff<span class="main">)</span>

<span class="keyword1" id="Table-join_False_alt"><span class="command">lemma</span></span> join_False_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">X</span> False <span class="free">Y</span> <span class="main">=</span> <span class="free">X</span> <span class="main">-</span> join <span class="free">X</span> True <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-self_join1"><span class="command">lemma</span></span> self_join1<span class="main">:</span> <span class="quoted"><span class="quoted">"join1 <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">xs</span> <span class="main">⟹</span> join1 <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span> <span class="main">≠</span> Some <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">ys</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> join1.induct<span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Table-join_False_code"><span class="command">lemma</span></span> join_False_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"join <span class="free">A</span> False <span class="free">B</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="main">∀</span><span class="bound">b</span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> join1 <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">≠</span> Some <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_False_alt join_True_code
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> self_join1<span class="main">)</span>

<span class="keyword1" id="Table-wf_tuple_Nil"><span class="command">lemma</span></span> wf_tuple_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-Suc_pred'"><span class="command">lemma</span></span> Suc_pred'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="free">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> Suc <span class="main">0</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="Table-wf_tuple_Cons"><span class="command">lemma</span></span> wf_tuple_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> None <span class="keyword1">then</span> <span class="main">0</span> <span class="main">∉</span> <span class="free">A</span> <span class="keyword1">else</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span><span class="main">∃</span><span class="bound">m</span><span class="main">.</span> <span class="free">n</span> <span class="main">=</span> Suc <span class="bound">m</span> <span class="main">∧</span> wf_tuple <span class="bound">m</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons image_iff Ball_def gr0_conv_Suc Suc_pred' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="Table-join1_wf_tuple"><span class="command">lemma</span></span> join1_wf_tuple<span class="main">:</span>
  <span class="quoted"><span class="quoted">"join1 <span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v1</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">v2</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">v1</span><span class="main">,</span> <span class="free">v2</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v1</span></span> <span class="quoted"><span class="free">v2</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> join1.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Table-join_wf_tuple"><span class="command">lemma</span></span> join_wf_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> join_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def image_iff sup_absorb1 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> join1_wf_tuple <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Table-join_table"><span class="command">lemma</span></span> join_table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⟹</span>
  table <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> join_wf_tuple<span class="main">)</span>

<span class="keyword1" id="Table-wf_tuple_Suc"><span class="command">lemma</span></span> wf_tuple_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="free">A</span> <span class="free">a</span> <span class="main">⟷</span> <span class="free">a</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">∧</span>
   wf_tuple <span class="free">m</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">a</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟷</span> hd <span class="free">a</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="Table-table_project"><span class="command">lemma</span></span> table_project<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_Suc<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">restrict</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">restrict</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> length <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Table-restrict_Nil"><span class="command">lemma</span></span> restrict_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-restrict_Cons"><span class="command">lemma</span></span> restrict_Cons<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> <span class="free">x</span> <span class="main">#</span> restrict <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="keyword1">else</span> None <span class="main">#</span> restrict <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_upt_Suc image_iff Suc_pred' Ball_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="Table-wf_tuple_restrict"><span class="command">lemma</span></span> wf_tuple_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∩</span> <span class="free">B</span> <span class="main">=</span> <span class="free">C</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-wf_tuple_restrict_simple"><span class="command">lemma</span></span> wf_tuple_restrict_simple<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">⊆</span> <span class="free">B</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-nth_restrict"><span class="command">lemma</span></span> nth_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-restrict_eq_Nil"><span class="command">lemma</span></span> restrict_eq_Nil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-length_restrict"><span class="command">lemma</span></span> length_restrict<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span> <span class="main">=</span> length <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> restrict_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-join1_Some_restrict"><span class="command">lemma</span></span> join1_Some_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join1 <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">z</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> restrict <span class="free">A</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> restrict <span class="free">B</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> join1.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 4 0 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_Un Un_Diff<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-restrict_idle"><span class="command">lemma</span></span> restrict_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Table-map_the_restrict"><span class="command">lemma</span></span> map_the_restrict<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> map the <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> map the <span class="free">v</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' gr0_conv_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Table-join_restrict"><span class="command">lemma</span></span> join_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟷</span>
    wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="keyword1">else</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 4 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> join_def Option.these_def image_iff assms wf_tuple_restrict sup_absorb1 restrict_idle
    restrict_idle<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> assms
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> join1_Some_restrict<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">v</span>"</span></span><span class="main"><span class="main">]</span></span>
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"Some <span class="free">v</span>"</span></span><span class="main"><span class="main">]</span></span> join1_Some_restrict<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Table-join_restrict_table"><span class="command">lemma</span></span> join_restrict_table<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟷</span>
    wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="keyword1">else</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_restrict<span class="main">)</span>

<span class="keyword1" id="Table-join_restrict_annotated"><span class="command">lemma</span></span> join_restrict_annotated<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">X</span> <span class="free">Y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="keyword1">=simp=&gt;</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"join <span class="main">{</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">v</span><span class="main">}</span> <span class="free">b</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">v</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">Q</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">v</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">¬</span> <span class="free">Q</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> join_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple simp_implies_def<span class="main">)</span>

<span class="keyword1" id="Table-in_joinI"><span class="command">lemma</span></span> in_joinI<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">b</span> <span class="main">⟹</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">b</span> <span class="main">⟹</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> join_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Table-in_joinE"><span class="command">lemma</span></span> in_joinE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">B</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> restrict <span class="free">A</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">Y</span> <span class="keyword1">else</span> restrict <span class="free">B</span> <span class="free">v</span> <span class="main">∉</span> <span class="free">Y</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> join_restrict<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">qtable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tuple <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> tuple <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> table <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">qtable</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wf_tuple <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="bound">x</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">wf_table</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_table</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">≡</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> True<span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span>"</span></span>

<span class="keyword1" id="Table-wf_table_iff"><span class="command">lemma</span></span> wf_table_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_table <span class="free">n</span> <span class="free">A</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">Q</span> <span class="bound">x</span> <span class="main">∧</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-table_wf_table"><span class="command">lemma</span></span> table_wf_table<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">=</span> wf_table <span class="free">n</span> <span class="free">A</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def wf_table_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-qtableI"><span class="command">lemma</span></span> qtableI<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">)</span> <span class="main">⟹</span>
  qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-in_qtableI"><span class="command">lemma</span></span> in_qtableI<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Table-in_qtableE"><span class="command">lemma</span></span> in_qtableE<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Table-qtable_empty"><span class="command">lemma</span></span> qtable_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟹</span> False<span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> empty_table"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-qtable_empty_iff"><span class="command">lemma</span></span> qtable_empty_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> empty_table <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟶</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟶</span> False<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def empty_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-qtable_unit_table"><span class="command">lemma</span></span> qtable_unit_table<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">{}</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="main">{}</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def in_unit_table <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-qtable_union"><span class="command">lemma</span></span> qtable_union<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="bound">x</span> <span class="main">∨</span> <span class="free">Q2</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span><span class="free">X</span> <span class="main">∪</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Table-qtable_Union"><span class="command">lemma</span></span> qtable_Union<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="main">(</span><span class="free">Qi</span> <span class="bound">i</span><span class="main">)</span> <span class="main">(</span><span class="free">Xi</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">Qi</span> <span class="bound">i</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span><span class="main">.</span> <span class="free">Xi</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i</span> <span class="skolem">F</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?Q1.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="free">Qi</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> <span class="var">?Q2.0</span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">F</span><span class="main">.</span> <span class="free">Qi</span> <span class="bound">i</span> <span class="bound">x</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> empty_table_def<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="Table-qtable_join"><span class="command">lemma</span></span> qtable_join<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="free">b</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">x</span> <span class="main">⟷</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">¬</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">C</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtableI<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">C</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> join_table<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1-3<span class="main">)</span> assms<span class="main">(</span>5-7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 2 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_joinE <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms<span class="main">(</span>1-4<span class="main">)</span> assms<span class="main">(</span>5-7<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">x</span></span></span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> qtable_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_tuple_restrict_simple <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_joinI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">B</span></span> <span class="quoted"><span class="free">Y</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Table-qtable_join_fixed"><span class="command">lemma</span></span> qtable_join_fixed<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q1</span> <span class="free">X</span>"</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q2</span> <span class="free">Y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">B</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">C</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∪</span> <span class="free">B</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="free">C</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="free">P</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">C</span> <span class="free">P</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="free">Q1</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">b</span> <span class="keyword1">then</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">¬</span> <span class="free">Q2</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>join <span class="free">X</span> <span class="free">b</span> <span class="free">Y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Table-wf_tuple_cong"><span class="command">lemma</span></span> wf_tuple_cong<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> map the <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> map the <span class="free">w</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">v</span> <span class="main">=</span> length <span class="free">w</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> this assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">=</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"map the <span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">z</span> <span class="main">=</span> map the <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">z</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
      <span class="keyword1"><span class="command">using</span></span> that Cons<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">THEN</span> bspec<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">z</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">z</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> Cons<span class="main">(</span>1<span class="main">,</span>3-5<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span><span class="main"><span class="main">]</span></span> * <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mem_restr</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mem_restr</span> <span class="free"><span class="bound"><span class="entity">A</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">A</span></span></span><span class="main">.</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">a</span> <span class="bound">b</span><span class="main">.</span> <span class="bound">a</span> <span class="main">≠</span> None <span class="main">⟶</span> <span class="bound">a</span> <span class="main">=</span> Some <span class="bound">b</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Table-mem_restrI"><span class="command">lemma</span></span> mem_restrI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> length <span class="free">y</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">y</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> mem_restr <span class="free">A</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1" id="Table-mem_restrE"><span class="command">lemma</span></span> mem_restrE<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">x</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">V</span><span class="main">.</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">y</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth<span class="main">)</span>

<span class="keyword1" id="Table-mem_restr_IntD"><span class="command">lemma</span></span> mem_restr_IntD<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> mem_restr <span class="free">A</span> <span class="free">v</span> <span class="main">∧</span> mem_restr <span class="free">B</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Table-mem_restr_Un_iff"><span class="command">lemma</span></span> mem_restr_Un_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="main">(</span><span class="free">A</span> <span class="main">∪</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span> <span class="main">⟷</span> mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">∨</span> mem_restr <span class="free">B</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Table-mem_restr_UNIV"><span class="command">lemma</span></span> mem_restr_UNIV <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr UNIV <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list.rel_map <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"map the <span class="free">x</span>"</span></span><span class="main"><span class="main">]</span></span> list.rel_refl<span class="main">)</span>

<span class="keyword1" id="Table-restrict_mem_restr"><span class="command">lemma</span></span> restrict_mem_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> mem_restr <span class="free">A</span> <span class="main">(</span>restrict <span class="free">V</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mem_restr_def restrict_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">lift_envs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">lift_envs</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="bound">a</span> <span class="main">#</span> <span class="bound">b</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>UNIV <span class="main">×</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Table-lift_envs_mem_restr"><span class="command">lemma</span></span> lift_envs_mem_restr<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">A</span> <span class="free">x</span> <span class="main">⟹</span> mem_restr <span class="main">(</span>lift_envs <span class="free">A</span><span class="main">)</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_restr_def lift_envs_def<span class="main">)</span>

<span class="keyword1" id="Table-qtable_project"><span class="command">lemma</span></span> qtable_project<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">A</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="var">?A</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="var">?P</span> <span class="var">?X</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> qtableI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> exE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> table left right<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> table
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> table_project<span class="main">)</span> 
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span> <span class="main">∉</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> qtable_def table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">with</span></span> left<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">#</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> image_iff hd_Cons_tl<span class="main">)</span>    
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_qtableE<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> left<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>right <span class="skolem">v</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> <span class="free">A</span> <span class="keyword1">then</span> Some <span class="skolem">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="skolem">v</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> in_qtableI<span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Table-qtable_cong"><span class="command">lemma</span></span> qtable_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">=</span> <span class="free">B</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="free">P</span> <span class="bound">v</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">v</span> <span class="main">⟷</span> <span class="free">Q'</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span> qtable <span class="free">n</span> <span class="free">B</span> <span class="free">P</span> <span class="free">Q'</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_def<span class="main">)</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Abstract_Monitor">
<div class="head">
<h1>Theory Abstract_Monitor</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Abstract_Monitor
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Trace">Trace</a> <a href="#Table">Table</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Abstract monitors and slicing›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹First-order specifications›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We abstract from first-order trace specifications by referring only to their
  semantics. A first-order specification is described by a finite set of free
  variables and a satisfaction function that defines for every trace the pairs
  of valuations and time-points for which the specification is satisfied.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> fo_spec <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span>
    <span class="free">nfv</span> <span class="main">::</span> <span class="quoted">nat</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">fv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    <span class="free">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    fv_less_nfv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">fv</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">nfv</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    sat_fv_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">fv</span> <span class="main">⟹</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">sat</span> <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">=</span> <span class="free">sat</span> <span class="free">σ</span> <span class="free">v'</span> <span class="free">i</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">verdicts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> tuple<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">verdicts</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We usually employ a monitor to find the <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator">∗</span></span>‹violations›</span></span> of a specification.
  That is, the monitor should output the satisfactions of its negation.
  Moreover, all monitor implementations must work with finite prefixes.
  We are therefore interested in co-safety properties, which allow us to
  identify all satisfactions on finite prefixes.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> cosafety_fo_spec <span class="main">=</span> fo_spec <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> cosafety_lr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="bound">σ'</span> <span class="main">⟶</span> <span class="free">sat</span> <span class="bound">σ'</span> <span class="free">v</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Monitor-cosafety"><span class="command">lemma</span></span> cosafety<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="bound">σ'</span> <span class="main">⟶</span> <span class="free">sat</span> <span class="bound">σ'</span> <span class="free">v</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cosafety_lr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor function›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We model monitors abstractly as functions from prefixes to verdict sets.
  The following locale specifies a minimal set of properties that any
  reasonable monitor should have.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> monitor <span class="main">=</span> fo_spec <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> tuple<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    mono_monitor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> <span class="free">M</span> <span class="free">π</span> <span class="main">⊆</span> <span class="free">M</span> <span class="free">π'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    wf_monitor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span> <span class="main">⟹</span> wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="free">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    sound_monitor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span> <span class="main">⟹</span> prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> <span class="free">sat</span> <span class="free">σ</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    complete_monitor<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="free">v</span> <span class="main">⟹</span>
      <span class="main">(</span><span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free">π</span> <span class="bound">σ</span> <span class="main">⟹</span> <span class="free">sat</span> <span class="bound">σ</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">π'</span><span class="main">.</span> prefix_of <span class="bound">π'</span> <span class="free">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="bound">π'</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  A monitor for a co-safety specification computes precisely the set of all
  satisfactions in the limit:
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitor<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">M_limit</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">≡</span> <span class="main">⋃</span><span class="main">{</span><span class="free">M</span> <span class="bound">π</span> <span class="main">|</span> <span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> cosafety_monitor <span class="main">=</span> cosafety_fo_spec <span class="main">+</span> monitor
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Monitor-M_limit_eq"><span class="command">lemma</span></span> M_limit_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"M_limit <span class="free">σ</span> <span class="main">=</span> verdicts <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">{</span><span class="free">M</span> <span class="bound">π</span> <span class="main">|</span> <span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free">σ</span><span class="main">}</span> <span class="main">⊆</span> verdicts <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verdicts_def wf_monitor sound_monitor<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">{</span><span class="free">M</span> <span class="bound">π</span> <span class="main">|</span> <span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free">σ</span><span class="main">}</span> <span class="main">⊇</span> verdicts <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> verdicts_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">v</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="free">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="skolem">π</span> <span class="bound">σ'</span> <span class="main">⟶</span> <span class="free">sat</span> <span class="bound">σ'</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> cosafety_lr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>›</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="free">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complete_monitor <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">⋃</span><span class="main">{</span><span class="free">M</span> <span class="bound">π</span> <span class="main">|</span> <span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free">σ</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The monitor function <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">M</span></span>›</span></span></span></span> adds some information over <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">sat</span></span>›</span></span></span></span>, namely
  when a verdict is output. One possible behavior is that the monitor outputs
  its verdicts for one time-point at a time, in increasing order of
  time-points. Then <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹<span class="free"><span class="free">M</span></span>›</span></span></span></span> is uniquely defined by a progress function, which
  returns for every prefix the time-point up to which all verdicts are computed.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> progress <span class="main">=</span> fo_spec _ _ <span class="quoted"><span class="free">sat</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">progress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> nat"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    progress_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> <span class="free">progress</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">progress</span> <span class="free">π'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    ex_progress_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="free">σ</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">progress</span> <span class="bound">π</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    progress_sat_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="free">π</span> <span class="free">σ'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">progress</span> <span class="free">π</span> <span class="main">⟹</span>
      <span class="free">sat</span> <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">⟷</span> <span class="free">sat</span> <span class="free">σ'</span> <span class="free">v</span> <span class="free">i</span>"</span></span>
    <span class="comment1">― ‹The last condition is not necessary to obtain a proper monitor function.
      However, it corresponds to the intuitive understanding of monitor progress,
      and it results in a stronger characterisation. In particular, it implies that
      the specification is co-safety, as we will show below.›</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">M</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> tuple<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">M</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">∧</span> wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="bound">v</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> <span class="free">sat</span> <span class="bound">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Abstract_Monitor-M_alt"><span class="command">lemma</span></span> M_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"M <span class="free">π</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">progress</span> <span class="free">π</span> <span class="main">∧</span> wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="bound">v</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free">π</span> <span class="bound">σ</span> <span class="main">∧</span> <span class="free">sat</span> <span class="bound">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ex_prefix_of<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">π</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> progress_sat_cong<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> progress <span class="main">⊆</span> cosafety_monitor _ _ _ <span class="quoted">M</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">v</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π</span></span> <span class="keyword2"><span class="keyword">where</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">progress</span> <span class="skolem">π</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_progress_ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="skolem">σ'</span> <span class="skolem">v</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">σ'</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> progress_sat_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">π</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="bound">π</span> <span class="bound">σ'</span> <span class="main">⟶</span> <span class="free">sat</span> <span class="bound">σ'</span> <span class="skolem">v</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">π</span> <span class="skolem">π'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π'</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"M <span class="skolem">π</span> <span class="main">⊆</span> M <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress_mono prefix_of_antimono
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">v</span> <span class="skolem">π</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="skolem">π</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="skolem">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">v</span> <span class="skolem">π</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ'</span><span class="main">.</span> prefix_of <span class="skolem">π</span> <span class="bound">σ'</span> <span class="main">⟹</span> <span class="free">sat</span> <span class="bound">σ'</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">π'</span><span class="main">.</span> prefix_of <span class="bound">π'</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="bound">π'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">progress</span> <span class="skolem">π</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span> <span class="main">∧</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">progress</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ex_progress_ge <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>›</span></span> prefix_of_imp_linear False progress_mono
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> * ** <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prefix_of_antimono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Slicing›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Sliceable specifications can be evaluated meaningfully on a subset of events.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> abstract_slicer <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">relevant_events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">slice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'a</span> trace"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slice</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">relevant_events</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">pslice</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pslice</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> pmap_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">relevant_events</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Abstract_Monitor-prefix_of_psliceI"><span class="command">lemma</span></span> prefix_of_psliceI<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> prefix_of <span class="main">(</span>pslice <span class="free">S</span> <span class="free">π</span><span class="main">)</span> <span class="main">(</span>slice <span class="free">S</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Abstract_Monitor-plen_pslice"><span class="command">lemma</span></span> plen_pslice<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"plen <span class="main">(</span>pslice <span class="free">S</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> plen <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Monitor-pslice_pnil"><span class="command">lemma</span></span> pslice_pnil<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"pslice <span class="free">S</span> pnil <span class="main">=</span> pnil"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="operator">simp</span>

<span class="keyword1" id="Abstract_Monitor-last_ts_pslice"><span class="command">lemma</span></span> last_ts_pslice<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="main">(</span>pslice <span class="free">S</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> last_ts <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span> <span class="quasi_keyword">fixing</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">S</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> last_map case_prod_beta <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">verdict_filter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> tuple<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> tuple<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">verdict_filter</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="main">(</span><span class="bound"><span class="bound">i</span></span><span class="main">,</span> <span class="bound"><span class="bound">v</span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> mem_restr <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="bound">v</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> sliceable_fo_spec <span class="main">=</span> fo_spec _ _ <span class="quoted"><span class="free">sat</span></span> <span class="main">+</span> abstract_slicer <span class="quoted"><span class="free">relevant_events</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">relevant_events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sliceable<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="free">sat</span> <span class="main">(</span>slice <span class="free">S</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="main">⟷</span> <span class="free">sat</span> <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Monitor-union_verdicts_slice"><span class="command">lemma</span></span> union_verdicts_slice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">𝒮</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> verdict_filter <span class="bound">S</span> <span class="main">(</span>verdicts <span class="main">(</span>slice <span class="bound">S</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">𝒮</span><span class="main">)</span> <span class="main">=</span> verdicts <span class="free">σ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> tuple"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> verdicts <span class="main">(</span>slice <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="main">(</span>slice <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verdicts_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">S</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">fv</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">v'</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fv_less_nfv <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mem_restrE<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="main">(</span>slice <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v'</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sat</span> <span class="main">(</span>slice <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>›</span></span> tuple
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_length fv_less_nfv <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sat_fv_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">σ</span> <span class="skolem">v'</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sliceable<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple 1
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_length fv_less_nfv <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sat_fv_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> verdicts <span class="free">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> verdicts_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> tuple"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> verdicts <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> verdicts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> part <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">S</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_restrI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="free">nfv</span></span> <span class="quoted"><span class="free">fv</span></span><span class="main">]</span> tuple
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def fv_less_nfv<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="main">(</span>slice <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">sat</span> <span class="free">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span>›</span></span> sliceable<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹map the <span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> verdicts <span class="main">(</span>slice <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tuple <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> verdicts_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">S</span><span class="main">∈</span><span class="free">𝒮</span><span class="main">.</span> verdict_filter <span class="bound">S</span> <span class="main">(</span>verdicts <span class="main">(</span>slice <span class="bound">S</span> <span class="free">σ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="free">𝒮</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  We define a similar notion for monitors. It is potentially stronger because
  the time-point at which verdicts are output must not change.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> sliceable_monitor <span class="main">=</span> monitor _ _ <span class="quoted"><span class="free">sat</span></span> <span class="quoted"><span class="free">M</span></span> <span class="main">+</span> abstract_slicer <span class="quoted"><span class="free">relevant_events</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">relevant_events</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">M</span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> sliceable_M<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">S</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>pslice <span class="free">S</span> <span class="free">π</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Monitor-union_M_pslice"><span class="command">lemma</span></span> union_M_pslice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> part<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="free">𝒮</span> <span class="main">=</span> UNIV"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋃</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">S</span><span class="main">.</span> verdict_filter <span class="bound">S</span> <span class="main">(</span><span class="free">M</span> <span class="main">(</span>pslice <span class="bound">S</span> <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">𝒮</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> tuple"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">S</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>pslice <span class="skolem">S</span> <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> sliceable_M <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'b</span> tuple"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">nfv</span> <span class="free">fv</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_monitor<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> part <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">∈</span> <span class="free">𝒮</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">S</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mem_restrI<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"map the <span class="skolem">v</span>"</span></span> <span class="quoted"><span class="skolem">S</span></span> <span class="quoted"><span class="free">nfv</span></span> <span class="quoted"><span class="free">fv</span></span><span class="main">]</span> tuple
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def fv_less_nfv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>pslice <span class="skolem">S</span> <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span>›</span></span> sliceable_M <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">S</span><span class="main">∈</span><span class="free">𝒮</span><span class="main">.</span> verdict_filter <span class="bound">S</span> <span class="main">(</span><span class="free">M</span> <span class="main">(</span>pslice <span class="bound">S</span> <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">S</span> <span class="main">∈</span> <span class="free">𝒮</span>›</span></span> <span class="quoted"><span class="quoted">‹mem_restr <span class="skolem">S</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  If the specification is sliceable and the monitor's progress depends only on
  time-stamps, then also the monitor itself is sliceable.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> timed_progress <span class="main">=</span> progress <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> progress_time_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"pts <span class="free">π</span> <span class="main">=</span> pts <span class="free">π'</span> <span class="main">⟹</span> <span class="free">progress</span> <span class="free">π</span> <span class="main">=</span> <span class="free">progress</span> <span class="free">π'</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> sliceable_timed_progress <span class="main">=</span> sliceable_fo_spec <span class="main">+</span> timed_progress
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Abstract_Monitor-progress_pslice"><span class="command">lemma</span></span> progress_pslice<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="main">(</span>pslice <span class="free">S</span> <span class="free">π</span><span class="main">)</span> <span class="main">=</span> <span class="free">progress</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> progress_time_conv<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> sliceable_timed_progress <span class="main">⊆</span> sliceable_monitor _ _ _ _ <span class="quoted">M</span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">π</span>
  <span class="keyword3"><span class="command">assume</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="skolem">S</span> <span class="skolem">v</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="main">(</span>pslice <span class="skolem">S</span> <span class="skolem">π</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="skolem">π</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_def wf_tuple_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restrE
          box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sliceable sat_fv_cong sat_fv_cong<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> prefix_of_psliceI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fv_less_nfv spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"slice <span class="skolem">S</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
    <span class="keyword1"><span class="command">with</span></span> * <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> M_alt wf_tuple_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restrE
        box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sliceable sat_fv_cong sat_fv_cong<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD2<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"slice <span class="skolem">S</span> <span class="main">_</span>"</span></span><span class="main"><span class="main">]</span></span> prefix_of_psliceI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fv_less_nfv<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Interval">
<div class="head">
<h1>Theory Interval</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Interval
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Extended_Nat.html">HOL-Library.Extended_Nat</a>"</span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Product_Lexorder.html">HOL-Library.Product_Lexorder</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Intervals›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> ℐ <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span> <span class="main">::</span> nat<span class="main">,</span> <span class="bound">j</span> <span class="main">::</span> enat<span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="main"><span class="main"><span class="main">∞</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_ℐ

<span class="keyword1"><span class="command">instantiation</span></span> ℐ <span class="main">::</span> <span class="quoted">equal</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">equal_ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(=)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> ℐ <span class="main">::</span> <span class="quoted">linorder</span> <span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_eq_ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(≤)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">less_ℐ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(&lt;)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">instance</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">lift_definition</span></span> all <span class="main">::</span> <span class="quoted">ℐ</span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">∞</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lift_definition</span></span> left <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">fst</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> right <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">snd</span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> point <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="bound">n</span><span class="main">,</span> enat <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">lift_definition</span></span> init <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> enat <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">mem</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">mem</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≡</span> <span class="main">(</span>left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≤</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">lift_definition</span></span> subtract <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ℐ <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">j</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span> <span class="main">-</span> <span class="bound">n</span><span class="main">,</span> <span class="bound">j</span> <span class="main">-</span> enat <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_enat_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">lift_definition</span></span> add <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ℐ <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span> <span class="bound">b</span> <span class="main">+</span> enat <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_increasing2<span class="main">)</span>

<span class="keyword1" id="Interval-left_right"><span class="command">lemma</span></span> left_right<span class="main">:</span> <span class="quoted"><span class="quoted">"left <span class="free">I</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword1" id="Interval-point_simps"><span class="command">lemma</span></span> point_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"left <span class="main">(</span>point <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"right <span class="main">(</span>point <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Interval-init_simps"><span class="command">lemma</span></span> init_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"left <span class="main">(</span>init <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="quoted"><span class="quoted">"right <span class="main">(</span>init <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Interval-subtract_simps"><span class="command">lemma</span></span> subtract_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"left <span class="main">(</span>subtract <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> left <span class="free">I</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"right <span class="main">(</span>subtract <span class="free">n</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> right <span class="free">I</span> <span class="main">-</span> <span class="free">n</span>"</span></span>
  <span class="quoted"><span class="quoted">"subtract <span class="main">0</span> <span class="free">I</span> <span class="main">=</span> <span class="free">I</span>"</span></span>
  <span class="quoted"><span class="quoted">"subtract <span class="free">x</span> <span class="main">(</span>point <span class="free">y</span><span class="main">)</span> <span class="main">=</span> point <span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">shifted</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ℐ set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">shifted</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> subtract <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span> <span class="main">..</span> <span class="main">(</span><span class="keyword1">case</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">of</span> <span class="main">∞</span> <span class="main">⇒</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">|</span> enat <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Interval-subtract_too_much"><span class="command">lemma</span></span> subtract_too_much<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&gt;</span> <span class="main">(</span><span class="keyword1">case</span> right <span class="free">I</span> <span class="keyword1">of</span> <span class="main">∞</span> <span class="main">⇒</span> left <span class="free">I</span> <span class="main">|</span> enat <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="main">⟹</span>
  subtract <span class="free">i</span> <span class="free">I</span> <span class="main">=</span> subtract <span class="main">(</span><span class="keyword1">case</span> right <span class="free">I</span> <span class="keyword1">of</span> <span class="main">∞</span> <span class="main">⇒</span> left <span class="free">I</span> <span class="main">|</span> enat <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> enat.splits<span class="main">)</span>

<span class="keyword1" id="Interval-subtract_shifted"><span class="command">lemma</span></span> subtract_shifted<span class="main">:</span> <span class="quoted"><span class="quoted">"subtract <span class="free">n</span> <span class="free">I</span> <span class="main">∈</span> shifted <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">case</span> right <span class="free">I</span> <span class="keyword1">of</span> <span class="main">∞</span> <span class="main">⇒</span> left <span class="free">I</span> <span class="main">|</span> enat <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> shifted_def subtract_too_much<span class="main">)</span>

<span class="keyword1" id="Interval-finite_shifted"><span class="command">lemma</span></span> finite_shifted<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>shifted <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> shifted_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">interval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> enat <span class="main">⇒</span> ℐ"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">interval</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">then</span> Abs_ℐ <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">[</span><span class="operator">code</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">abstract</span></span></span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"Rep_ℐ <span class="main">(</span>interval <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">r</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">r</span><span class="main">)</span> <span class="keyword1">else</span> Rep_ℐ undefined<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> interval_def <span class="keyword1"><span class="command">using</span></span> Abs_ℐ_inverse <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="MFOTL">
<div class="head">
<h1>Theory MFOTL</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> MFOTL
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Interval">Interval</a> <a href="#Trace">Trace</a> <a href="#Abstract_Monitor">Abstract_Monitor</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Metric first-order temporal logic›</span></span>

<span class="keyword1"><span class="command">context</span></span> <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Formulas and satisfiability›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> name <span class="main">=</span> <span class="quoted">string</span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> event <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> database <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> event set"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> prefix <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> prefix"</span></span>
<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> trace <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>name <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> trace"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> env <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> trm <span class="main">=</span> Var <span class="quoted">nat</span> <span class="main">|</span> <span class="entity">is_Const</span><span class="main">:</span> Const <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fvi_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi_trm</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv_trm</span> <span class="main">≡</span> fvi_trm <span class="main">0</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">eval_trm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> env <span class="main">⇒</span> <span class="tfree">'a</span> trm <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_trm</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="MFOTL-eval_trm_cong"><span class="command">lemma</span></span> eval_trm_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="free">t</span><span class="main">.</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">⟹</span> eval_trm <span class="free">v</span> <span class="free">t</span> <span class="main">=</span> eval_trm <span class="free">v'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">datatype</span></span> <span class="main">(</span>discs_sels<span class="main">)</span> <span class="tfree">'a</span> formula <span class="main">=</span> Pred <span class="quoted">name</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm list"</span></span> <span class="main">|</span> Eq <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trm"</span></span>
  <span class="main">|</span> Neg <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="main">|</span> Or <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="main">|</span> Exists <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>
  <span class="main">|</span> Prev <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="main">|</span> Next <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>
  <span class="main">|</span> Since <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="main">|</span> Until <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span> <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fvi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">.</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="bound">t</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∪</span> fvi_trm <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∪</span> <span class="free">fvi</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">fv</span> <span class="main">≡</span> fvi <span class="main">0</span>"</span></span>

<span class="keyword1" id="MFOTL-finite_fvi_trm"><span class="command">lemma</span></span> finite_fvi_trm<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fvi_trm <span class="free">b</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="MFOTL-finite_fvi"><span class="command">lemma</span></span> finite_fvi<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="MFOTL-fvi_trm_Suc"><span class="command">lemma</span></span> fvi_trm_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi_trm <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟷</span> Suc <span class="free">x</span> <span class="main">∈</span> fvi_trm <span class="free">b</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="MFOTL-fvi_Suc"><span class="command">lemma</span></span> fvi_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span> <span class="main">⟷</span> Suc <span class="free">x</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_trm_Suc<span class="main">)</span>

<span class="keyword1" id="MFOTL-fvi_Suc_bound"><span class="command">lemma</span></span> fvi_Suc_bound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fvi <span class="free">b</span> <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> fvi <span class="free">b</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">nfv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">nfv</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>Suc <span class="main">`</span> fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="entity">envs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula <span class="main">⇒</span> <span class="tfree">'a</span> env set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">envs</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> length <span class="bound">v</span> <span class="main">=</span> nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="MFOTL-nfv_simps"><span class="command">lemma</span></span> nfv_simps<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Neg <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Or <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Prev <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Next <span class="free">I</span> <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> nfv <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Un Max_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="MFOTL-fvi_less_nfv"><span class="command">lemma</span></span> fvi_less_nfv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> nfv <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Max_gr_iff <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> max.strict_coboundedI2<span class="main">)</span>


<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">future_reach</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> formula <span class="main">⇒</span> enat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Pred <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">-</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">-</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">future_reach</span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span><span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">future_reach</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">+</span> <span class="main">1</span>"</span></span>


<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">sat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> trace <span class="main">⇒</span> <span class="tfree">'a</span> env <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> map <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">∈</span> Γ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">=</span> eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¬</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> False <span class="main">|</span> Suc <span class="bound">j</span> <span class="main">⇒</span> mem <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>mem <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≤</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> mem <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">j</span> <span class="main">&lt;..</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">.</span> mem <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">..&lt;</span> <span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="free">sat</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="MFOTL-sat_Until_rec"><span class="command">lemma</span></span> sat_Until_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span>
  mem <span class="main">0</span> <span class="free">I</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">ψ</span> <span class="main">∨</span>
  <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="free">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv le_diff_conv2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> now<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted">"next"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Until <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"next"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">..&lt;</span> <span class="skolem">j</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Δ j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="free">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> now j<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_eq_less_or_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MFOTL-sat_Since_rec"><span class="command">lemma</span></span> sat_Since_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span>
  mem <span class="main">0</span> <span class="free">I</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">ψ</span> <span class="main">∨</span>
  <span class="main">(</span><span class="free">i</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∧</span> Δ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">⟷</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">;</span></span> <span class="main">(</span><span class="operator">elim</span> disjE conjE<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Δ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> diff_le_mono2 le_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False j <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="free">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv le_diff_conv2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> Δ<span class="main">:</span> <span class="quoted"><span class="quoted">"Δ <span class="free">σ</span> <span class="free">i</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> now<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted">"prev"</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"prev"</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>subtract <span class="main">(</span>Δ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="skolem">j</span> <span class="free">ψ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">j</span> <span class="main">&lt;..</span> <span class="free">i</span> <span class="main">-</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="bound">k</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> Δ i j<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">j</span><span class="main">)</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="free">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv2<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> now i j<span class="main">(</span>1<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?L</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Suc_eq gr0_conv_Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MFOTL-sat_Since_0"><span class="command">lemma</span></span> sat_Since_0<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="main">0</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟷</span> mem <span class="main">0</span> <span class="free">I</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="main">0</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MFOTL-sat_Since_point"><span class="command">lemma</span></span> sat_Since_point<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">⋀</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">⟹</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span> <span class="free">I</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> diff_le_self<span class="main">)</span>

<span class="keyword1" id="MFOTL-sat_Since_pointD"><span class="command">lemma</span></span> sat_Since_pointD<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="main">(</span>point <span class="free">t</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">⟹</span> mem <span class="free">t</span> <span class="free">I</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>Since <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="MFOTL-eval_trm_fvi_cong"><span class="command">lemma</span></span> eval_trm_fvi_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="free">t</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> eval_trm <span class="free">v</span> <span class="free">t</span> <span class="main">=</span> eval_trm <span class="free">v'</span> <span class="free">t</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="MFOTL-sat_fvi_cong"><span class="command">lemma</span></span> sat_fvi_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> sat <span class="free">σ</span> <span class="free">v'</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">n</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong eval_trm_fvi_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Pred<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">simplified</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> bspec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">x1</span> <span class="skolem">x2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>  <span class="keyword1"><span class="command">unfolding</span></span> fvi.simps sat.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> UnCI eval_trm_fvi_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 8 0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iff_exI<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Defined connectives›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">And</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> Neg <span class="main">(</span>Or <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="MFOTL-fvi_And"><span class="command">lemma</span></span> fvi_And<span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">∪</span> fvi <span class="free">b</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MFOTL-nfv_And"><span class="command">lemma</span></span> nfv_And<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_And image_Un Max_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="MFOTL-future_reach_And"><span class="command">lemma</span></span> future_reach_And<span class="main">:</span> <span class="quoted"><span class="quoted">"future_reach <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>future_reach <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>future_reach <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MFOTL-sat_And"><span class="command">lemma</span></span> sat_And<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">And_Not</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> Neg <span class="main">(</span>Or <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="MFOTL-fvi_And_Not"><span class="command">lemma</span></span> fvi_And_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"fvi <span class="free">b</span> <span class="main">(</span>And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">∪</span> fvi <span class="free">b</span> <span class="free">ψ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> And_Not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MFOTL-nfv_And_Not"><span class="command">lemma</span></span> nfv_And_Not<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"nfv <span class="main">(</span>And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>nfv <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> nfv_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_And_Not image_Un Max_Un<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="MFOTL-future_reach_And_Not"><span class="command">lemma</span></span> future_reach_And_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"future_reach <span class="main">(</span>And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> max <span class="main">(</span>future_reach <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>future_reach <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> And_Not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="MFOTL-sat_And_Not"><span class="command">lemma</span></span> sat_And_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="main">(</span>And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">∧</span> <span class="main">¬</span> sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> And_Not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Safe formulas›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">safe_formula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∨</span> MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Or <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">ψ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">safe_formula</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">safe_formula</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">safe_formula</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="MFOTL-disjE_Not2"><span class="command">lemma</span></span> disjE_Not2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="main">∨</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">¬</span><span class="free">P</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="free">R</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">R</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="MFOTL-safe_formula_induct"><span class="command">lemma</span></span> safe_formula_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> MFOTL.is_Const <span class="bound">t1</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Eq <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t1</span> <span class="bound">t2</span><span class="main">.</span> MFOTL.is_Const <span class="bound">t2</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Eq <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">e</span> <span class="bound">ts</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Pred <span class="bound">e</span> <span class="bound">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> <span class="main">¬</span> <span class="main">(</span>safe_formula <span class="main">(</span>MFOTL.Neg <span class="bound">ψ</span><span class="main">)</span> <span class="main">∧</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">φ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.And <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> safe_formula <span class="bound">ψ</span> <span class="main">⟹</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.And_Not <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">ψ</span><span class="main">.</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">=</span> MFOTL.fv <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Or <span class="bound">φ</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Exists <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Prev <span class="bound">I</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">I</span> <span class="bound">φ</span><span class="main">.</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Next <span class="bound">I</span> <span class="bound">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> MFOTL.fv <span class="bound">φ</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Since <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> MFOTL.fv <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⟹</span>
      <span class="main">¬</span> safe_formula <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Since <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="bound">I</span> <span class="bound">ψ</span> <span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> MFOTL.fv <span class="bound">φ</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⟹</span> safe_formula <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Until <span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">φ</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">.</span> MFOTL.fv <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⟹</span>
      <span class="main">¬</span> safe_formula <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">φ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">ψ</span> <span class="main">⟹</span> <span class="free">P</span> <span class="main">(</span>MFOTL.Until <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="bound">I</span> <span class="bound">ψ</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> MFOTL.And_def MFOTL.And_Not_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">φ</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> disjE_Not2 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Slicing traces›</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">primrec</span></span> <span class="entity">matches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> env <span class="main">⇒</span> <span class="tfree">'a</span> formula <span class="main">⇒</span> name <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Pred <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∧</span> map <span class="main">(</span>eval_trm <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> snd <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> <span class="free">matches</span> <span class="main">(</span><span class="bound">z</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">(</span>Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">∨</span> <span class="free">matches</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="MFOTL-matches_fvi_cong"><span class="command">lemma</span></span> matches_fvi_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="free">v</span><span class="main">!</span><span class="bound">x</span> <span class="main">=</span> <span class="free">v'</span><span class="main">!</span><span class="bound">x</span> <span class="main">⟹</span> matches <span class="free">v</span> <span class="free">φ</span> <span class="free">e</span> <span class="main">=</span> matches <span class="free">v'</span> <span class="free">φ</span> <span class="free">e</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">v'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">n</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> map_cong eval_trm_fvi_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Pred<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">simplified</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator">THEN</span> bspec<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> matches.simps <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iff_exI<span class="main">)</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_Cons'<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> 5 0 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons'<span class="main">)</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">relevant_events</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">relevant_events</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">e</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">∩</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> matches <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="bound">e</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="MFOTL-sat_slice_strong"><span class="command">lemma</span></span> sat_slice_strong<span class="main">:</span> <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span> <span class="free">S</span> <span class="main">⊆</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">v</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span>
  sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">r</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> subset_eq<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Or.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span><span class="main">]</span> Or.prems
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">σ</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">z</span>
    <span class="keyword1"><span class="command">using</span></span> Exists.prems <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Exists.IH<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="skolem">z</span> <span class="main">#</span> <span class="bound">v</span> <span class="main">|</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="skolem">S</span><span class="main">}</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> nat.case_cong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Since.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span><span class="main">]</span> Since.prems
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Until.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span><span class="main">]</span> Until.prems
   <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Collect_disj_eq Int_Un_distrib subset_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> <span class="comment1">(*context*)</span>

<span class="keyword1"><span class="command">interpretation</span></span> MFOTL_slicer<span class="main">:</span> abstract_slicer <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">φ</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="MFOTL-sat_slice_iff"><span class="command">lemma</span></span> sat_slice_iff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="free">S</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_slice_strong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">S</span></span></span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> subset_refl assms<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1" id="MFOTL-slice_replace_prefix"><span class="command">lemma</span></span> slice_replace_prefix<span class="main">:</span>
  <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>MFOTL_slicer.pslice <span class="free">φ</span> <span class="free">R</span> <span class="free">π</span><span class="main">)</span> <span class="free">σ</span> <span class="main">⟹</span>
    MFOTL_slicer.slice <span class="free">φ</span> <span class="free">R</span> <span class="main">(</span>replace_prefix <span class="free">π</span> <span class="free">σ</span><span class="main">)</span> <span class="main">=</span> MFOTL_slicer.slice <span class="free">φ</span> <span class="free">R</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> map_Γ_replace_prefix<span class="main">)</span> <span class="operator">auto</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span></pre>
</div><div id="Monitor">
<div class="head">
<h1>Theory Monitor</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Monitor
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Abstract_Monitor">Abstract_Monitor</a> <a href="#MFOTL">MFOTL</a> <a href="#Table">Table</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Monitor implementation›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Monitorable formulas›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⟷</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> MFOTL.future_reach <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mmonitorable_exec</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∨</span> MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Or <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">ψ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">ψ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">=</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≠</span> <span class="main">∞</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">∧</span>
    <span class="main">(</span><span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∨</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">φ'</span> <span class="main">⇒</span> <span class="free">mmonitorable_exec</span> <span class="bound">φ'</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> False<span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">mmonitorable_exec</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmonitorable_exec</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> False"</span></span>

<span class="keyword1" id="Monitor-plus_eq_enat_iff"><span class="command">lemma</span></span> plus_eq_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">+</span> <span class="free">b</span> <span class="main">=</span> enat <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> enat <span class="bound">j</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> enat <span class="bound">k</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">+</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">b</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-minus_eq_enat_iff"><span class="command">lemma</span></span> minus_eq_enat_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">-</span> enat <span class="free">k</span> <span class="main">=</span> enat <span class="free">i</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">a</span> <span class="main">=</span> enat <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">-</span> <span class="free">k</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-safe_formula_mmonitorable_exec"><span class="command">lemma</span></span> safe_formula_mmonitorable_exec<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> MFOTL.future_reach <span class="free">φ</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> mmonitorable_exec <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_reach.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_reach.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_reach.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">unfolding</span></span> safe_formula.simps future_reach.simps mmonitorable_exec.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> plus_eq_enat_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> plus_eq_enat_iff minus_eq_enat_iff<span class="main">)</span>

<span class="keyword1" id="Monitor-mmonitorable_exec_mmonitorable"><span class="command">lemma</span></span> mmonitorable_exec_mmonitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable_exec <span class="free">φ</span> <span class="main">⟹</span> mmonitorable <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mmonitorable_exec.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmonitorable_def mmonitorable_exec.simps safe_formula.simps
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> one_enat_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmonitorable_def one_enat_def<span class="main">)</span>

<span class="keyword1" id="Monitor-monitorable_formula_code"><span class="command">lemma</span></span> monitorable_formula_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">=</span> mmonitorable_exec <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mmonitorable_exec_mmonitorable safe_formula_mmonitorable_exec mmonitorable_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>



<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The executable monitor›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> ts <span class="main">=</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> mbuf2 <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> msaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> muaux <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>ts <span class="main">×</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> table<span class="main">)</span> list"</span></span>

<span class="keyword1"><span class="command">datatype</span></span> <span class="tfree">'a</span> mformula <span class="main">=</span>
    MRel <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table"</span></span>
  <span class="main">|</span> MPred <span class="quoted">MFOTL.name</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trm list"</span></span>
  <span class="main">|</span> MAnd <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span>
  <span class="main">|</span> MOr <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span>
  <span class="main">|</span> MExists <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span>
  <span class="main">|</span> MPrev <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table list"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span>
  <span class="main">|</span> MNext <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"ts list"</span></span>
  <span class="main">|</span> MSince <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> msaux"</span></span>
  <span class="main">|</span> MUntil <span class="quoted">bool</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted">ℐ</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mbuf2"</span></span> <span class="quoted"><span class="quoted">"ts list"</span></span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> muaux"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="tfree">'a</span> mstate <span class="main">=</span>
  mstate_i <span class="main">::</span> <span class="quoted">nat</span>
  mstate_m <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> mformula"</span></span>
  mstate_n <span class="main">::</span> <span class="quoted">nat</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eq_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> singleton_table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">neq_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.trm <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">neq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> empty_table <span class="keyword1">else</span> unit_table <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">neq_rel</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> empty_table <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">neq_rel</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">minit0</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> mformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
    MFOTL.Eq <span class="bound">t1</span> <span class="bound">t2</span> <span class="main">⇒</span> MRel <span class="main">(</span>neq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">t1</span> <span class="bound">t2</span><span class="main">)</span>
  <span class="main">|</span> MFOTL.Or <span class="main">(</span>MFOTL.Neg <span class="bound">φ</span><span class="main">)</span> <span class="bound">ψ</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="bound">ψ</span> <span class="main">∧</span> MFOTL.fv <span class="bound">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="bound">φ</span>
      <span class="keyword1">then</span> MAnd <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> False <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">ψ</span> <span class="keyword1">of</span> MFOTL.Neg <span class="bound">ψ</span> <span class="main">⇒</span> MAnd <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> True <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>
  <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> MRel <span class="main">(</span>eq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> MOr <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MExists <span class="main">(</span><span class="free">minit0</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">[]</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span> MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> True <span class="main">[]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MSince True <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      MFOTL.Neg <span class="bound">φ</span> <span class="main">⇒</span> MSince False <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free"><span class="bound"><span class="entity">φ</span></span></span>
    <span class="keyword1">then</span> MUntil True <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">of</span>
      MFOTL.Neg <span class="bound">φ</span> <span class="main">⇒</span> MUntil False <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">φ</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free">minit0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span>
    <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> undefined<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minit</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> mstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> MFOTL.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">⦇</span>mstate_i <span class="main">=</span> <span class="main">0</span><span class="main">,</span> mstate_m <span class="main">=</span> minit0 <span class="bound">n</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">,</span> mstate_n <span class="main">=</span> <span class="bound">n</span><span class="main">⦈</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mprev_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> ts list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> table list <span class="main">×</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span> <span class="main">=</span> <span class="free">mprev_next</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> mem <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t'</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span> <span class="main">#</span> <span class="bound">ys</span><span class="main">,</span> <span class="bound">zs</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2_add</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> table list <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">mbuf2_add</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">xs'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">ys'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> <span class="tfree">'b</span> list <span class="main">×</span> <span class="tfree">'a</span> mbuf2"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> <span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mbuf2_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mbuf2t_take</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> ts list <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">×</span> <span class="tfree">'a</span> mbuf2 <span class="main">×</span> ts list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mbuf2t_take</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">match</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trm list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇀</span> <span class="tfree">'a</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">[]</span> <span class="main">[]</span> <span class="main">=</span> Some Map.empty"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">then</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">else</span> None<span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">match</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="free"><span class="bound"><span class="entity">ys</span></span></span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">f</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">f</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
        None <span class="main">⇒</span> Some <span class="main">(</span><span class="bound">f</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">↦</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> Some <span class="bound">z</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="bound">z</span> <span class="keyword1">then</span> Some <span class="bound">f</span> <span class="keyword1">else</span> None<span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">match</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">=</span> None"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_since</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span>
  <span class="tfree">'a</span> msaux <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">×</span> <span class="tfree">'a</span> msaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_since</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">aux</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">]</span> <span class="keyword1">of</span>
        <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span><span class="main">]</span>
      <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="keyword1">else</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span>foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="bound">aux</span><span class="main">,</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">]</span> <span class="main">{}</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update_until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> bool <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> <span class="tfree">'a</span> muaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">update_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span>
    <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">a1</span><span class="main">,</span> <span class="bound">a2</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> join <span class="bound">a1</span> True <span class="free"><span class="bound"><span class="entity">rel1</span></span></span> <span class="keyword1">else</span> <span class="bound">a1</span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">,</span>
      <span class="keyword1">if</span> mem <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">then</span> <span class="bound">a2</span> <span class="main">∪</span> join <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">a1</span> <span class="keyword1">else</span> <span class="bound">a2</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">@</span>
    <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">nt</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">rel1</span></span></span><span class="main">,</span> <span class="keyword1">if</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">rel2</span></span></span> <span class="keyword1">else</span> empty_table<span class="main">)</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_until</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"ℐ <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> muaux"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> <span class="free">eval_until</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">nt</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">meval</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.database <span class="main">⇒</span> <span class="tfree">'a</span> mformula <span class="main">⇒</span> <span class="tfree">'a</span> table list <span class="main">×</span> <span class="tfree">'a</span> mformula"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MRel <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">]</span><span class="main">,</span> MRel <span class="free"><span class="bound"><span class="entity">rel</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span><span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">`</span> Option.these
    <span class="main">(</span>match <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">db</span></span></span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="bound">e'</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> join <span class="bound">r1</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">r2</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MAnd <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">)</span> <span class="main">=</span> mbuf2_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span><span class="main">.</span> <span class="bound">r1</span> <span class="main">∪</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MOr <span class="bound">φ</span> <span class="bound">ψ</span> <span class="bound">buf</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">in</span> <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="bound">r</span><span class="main">.</span> tl <span class="main">`</span> <span class="bound">r</span><span class="main">)</span> <span class="bound">xs</span><span class="main">,</span> MExists <span class="bound">φ</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mprev_next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">@</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="keyword1">then</span> empty_table <span class="main">#</span> <span class="bound">zs</span> <span class="keyword1">else</span> <span class="bound">zs</span><span class="main">,</span> MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> False <span class="bound">buf</span> <span class="bound">nts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">first</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">first</span></span></span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> False<span class="main">)</span> <span class="main">|</span> <span class="bound">a</span> <span class="main">⇒</span> <span class="bound">a</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mprev_next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">xs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">φ</span> <span class="bound">first</span> <span class="bound">nts</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MSince <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">let</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> update_since <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span>
        <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MSince <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="main">(</span>MUntil <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">ys</span><span class="main">,</span> <span class="bound">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="free">meval</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">db</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">aux</span><span class="main">,</span> <span class="bound">buf</span><span class="main">,</span> <span class="bound">nts</span><span class="main">)</span> <span class="main">=</span> mbuf2t_take <span class="main">(</span>update_until <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>mbuf2_add <span class="bound">xs</span> <span class="bound">ys</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">]</span><span class="main">)</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span> <span class="main">=</span> eval_until <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">nts</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="bound">aux</span>
    <span class="keyword1">in</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> MUntil <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="bound">φ</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">ψ</span> <span class="bound">buf</span> <span class="bound">nts</span> <span class="bound">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.database <span class="main">×</span> ts <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> set <span class="main">×</span> <span class="tfree">'a</span> mstate"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mstep</span> <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> meval <span class="main">(</span>mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">tdb</span></span></span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span>set <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="bound">X</span><span class="main">)</span> <span class="main">(</span>List.enumerate <span class="main">(</span>mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">,</span>
      <span class="main">⦇</span>mstate_i <span class="main">=</span> mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">+</span> length <span class="bound">xs</span><span class="main">,</span> mstate_m <span class="main">=</span> <span class="bound">m</span><span class="main">,</span> mstate_n <span class="main">=</span> mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Monitor-mstep_alt"><span class="command">lemma</span></span> mstep_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"mstep <span class="free">tdb</span> <span class="free">st</span> <span class="main">=</span>
     <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span> <span class="main">=</span> meval <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">tdb</span><span class="main">)</span> <span class="main">(</span>fst <span class="free">tdb</span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span>
     <span class="keyword1">in</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="main">(</span>List.enumerate <span class="main">(</span>mstate_i <span class="free">st</span><span class="main">)</span> <span class="bound">xs</span><span class="main">)</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">v</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">v</span><span class="main">)</span><span class="main">}</span><span class="main">,</span>
      <span class="main">⦇</span>mstate_i <span class="main">=</span> mstate_i <span class="free">st</span> <span class="main">+</span> length <span class="bound">xs</span><span class="main">,</span> mstate_m <span class="main">=</span> <span class="bound">m</span><span class="main">,</span> mstate_n <span class="main">=</span> mstate_n <span class="free">st</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mstep_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Progress›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">progress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> min <span class="main">(</span>Suc <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    Inf <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span> min <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">progress</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">⟶</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≥</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">k</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Monitor-progress_And"><span class="command">lemma</span></span> progress_And<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>MFOTL.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-progress_And_Not"><span class="command">lemma</span></span> progress_And_Not<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>MFOTL.And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_Not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-progress_mono"><span class="command">lemma</span></span> progress_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> trans_le_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_superset_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-progress_le"><span class="command">lemma</span></span> progress_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> trans_le_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-progress_0"><span class="command">lemma</span></span> progress_0<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> progress_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-progress_ge"><span class="command">lemma</span></span> progress_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="free">φ</span> <span class="main">≠</span> <span class="main">∞</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="bound">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Or.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ1</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Or.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ2</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Or.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≤</span> <span class="skolem">j2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Prev.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Prev.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Next.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Next.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Since.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ1</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Since.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ2</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Since.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≤</span> <span class="skolem">j2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span> <span class="main">=</span> enat <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">i'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_le_τ<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">&lt;</span> τ <span class="free">σ</span> <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ1</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ2</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="skolem">φ2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j1</span></span> <span class="skolem"><span class="skolem">j2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="skolem">j1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i'</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="skolem">j2</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Until.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="skolem"><span class="skolem">i'</span></span>"</span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>max <span class="skolem">j1</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> nonempty greatest<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> nonempty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"max <span class="skolem">j1</span> <span class="skolem">j2</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>greatest <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">i'</span>›</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">≤</span> <span class="skolem">j2</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">i'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> max_absorb1 max_absorb2 less_eq_Suc_le
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> not_le_imp_less<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> less_imp_le<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Monitor-cInf_restrict_nat"><span class="command">lemma</span></span> cInf_restrict_nat<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">x</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Inf <span class="free">A</span> <span class="main">=</span> Inf <span class="main">{</span><span class="bound"><span class="bound">y</span></span> <span class="main">∈</span> <span class="free">A</span><span class="main">.</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> cInf_greatest cInf_lower Inf_nat_def1<span class="main">)</span>

<span class="keyword1" id="Monitor-progress_time_conv"><span class="command">lemma</span></span> progress_time_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span><span class="main">&lt;</span><span class="free">j</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="free">σ'</span> <span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span> <span class="main">=</span> progress <span class="free">σ'</span> <span class="free">φ</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> Until <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>enat <span class="skolem">b</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> enat * Until <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms τ_mono<span class="main">[</span><span class="operator">THEN</span> trans_le_add1<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 6 0
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> box_equals<span class="main"><span class="main">[</span></span><span class="operator">OF</span> arg_cong<span class="main"><span class="main"><span class="main">[</span></span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted">Inf</span><span class="main"><span class="main"><span class="main">]</span></span></span>
            cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span> cInf_restrict_nat<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">symmetric</span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main"><span class="main">=</span></span></span></span><span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp_all</span>

<span class="keyword1" id="Monitor-Inf_UNIV_nat"><span class="command">lemma</span></span> Inf_UNIV_nat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Inf UNIV <span class="main">::</span> nat<span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> cInf_eq_minimum<span class="main">)</span>

<span class="keyword1" id="Monitor-progress_prefix_conv"><span class="command">lemma</span></span> progress_prefix_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ'</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> progress_time_conv τ_prefix_conv<span class="main">)</span>

<span class="keyword1" id="Monitor-sat_prefix_conv"><span class="command">lemma</span></span> sat_prefix_conv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> MFOTL.sat <span class="free">σ'</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Pred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Γ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Eq <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Neg <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Or <span class="skolem">φ1</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Exists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">φ</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Next τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Since <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> Since τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span> <span class="main">=</span> enat <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_UNIV_nat<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> 1<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword1"><span class="command">from</span></span> Until.prems <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="free">σ'</span> <span class="main">(</span>MFOTL.Until <span class="skolem">φ1</span> <span class="skolem">I</span> <span class="skolem">φ2</span><span class="main">)</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ'</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> τ <span class="free">σ'</span> <span class="skolem">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> progress <span class="free">σ'</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le not_le <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Suc_leI <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_cInf_iff<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ1</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> 21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">φ2</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ'</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> less_τD<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free">σ'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> 31<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> plen <span class="free">π</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ'</span> <span class="skolem">k</span> <span class="main">≤</span> τ <span class="free">σ'</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">b</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">using</span></span> 11<span class="main">[</span><span class="operator">OF</span> that<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> less_eq_Suc_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ progress_le<span class="main"><span class="main">]</span></span><span class="main">)</span>

  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sat.simps
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">intro</span> ex_cong iffI<span class="main"><span class="keyword3">;</span></span> <span class="operator">elim</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> LR RL<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>LR <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 1<span class="main">]</span> Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main">]</span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 3<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv add.commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>RL <span class="skolem">j</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> Until.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 11<span class="main">]</span> Until.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 21<span class="main">]</span> τ_prefix_conv<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> 31<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_diff_conv add.commute <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> less_imp_le order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> τ_mono<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Specification›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pprogress</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pprogress</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span> progress <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">n</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Monitor-pprogress_eq"><span class="command">lemma</span></span> pprogress_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span> <span class="main">⟹</span> pprogress <span class="free">φ</span> <span class="free">π</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> pprogress_def <span class="keyword1"><span class="command">using</span></span> progress_prefix_conv
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">locale</span></span> future_bounded_mfotl <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> future_bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.future_reach <span class="free">φ</span> <span class="main">≠</span> <span class="main">∞</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> future_bounded_mfotl <span class="main">⊆</span> sliceable_timed_progress <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> MFOTL.sat <span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"pprogress <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_less_nfv<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> sat_fvi_cong<span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">v</span> <span class="skolem">S</span> <span class="skolem">σ</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sat_slice_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> prefix_of_antimono<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π'</span>›</span></span> <span class="quoted"><span class="quoted">‹prefix_of <span class="skolem">π'</span> <span class="skolem">σ</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq plen_mono progress_mono<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">σ</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> progress <span class="skolem">σ</span> <span class="free">φ</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> future_bounded progress_ge <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> pprogress <span class="free">φ</span> <span class="main">(</span>take_prefix <span class="skolem">j</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">π</span> <span class="skolem">σ</span> <span class="skolem">σ'</span> <span class="skolem">i</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> progress <span class="skolem">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 6 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> sat_prefix_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"plen <span class="skolem">π</span> <span class="main">=</span> plen <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="skolem"><span class="skolem">σ'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="skolem">σ'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> plen <span class="skolem">π</span><span class="main">.</span> τ <span class="skolem">σ</span> <span class="bound">i</span> <span class="main">=</span> τ <span class="skolem">σ'</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> 7 calculation
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pprogress_eq progress_time_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">locale</span></span> monitorable_mfotl <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> monitorable<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> monitorable_mfotl <span class="main">⊆</span> future_bounded_mfotl
  <span class="keyword1"><span class="command">using</span></span> monitorable <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmonitorable_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuf2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">⇒</span> <span class="tfree">'a</span> table <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuf2</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ja</span></span></span> <span class="free"><span class="bound"><span class="entity">jb</span></span></span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">ja</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">jb</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⇒</span>
    list_all2 <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ja</span></span></span><span class="main">]</span> <span class="bound">xs</span> <span class="main">∧</span> list_all2 <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">jb</span></span></span><span class="main">]</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mbuf2'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span>
  <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> mbuf2 <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mbuf2'</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟷</span> wf_mbuf2 <span class="main">(</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span>"</span></span>

<span class="keyword1" id="Monitor-wf_mbuf2'_UNIV_alt"><span class="command">lemma</span></span> wf_mbuf2'_UNIV_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> UNIV <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span> <span class="main">⟷</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">buf</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">ys</span><span class="main">)</span> <span class="main">⇒</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">..&lt;</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">..&lt;</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_restr_UNIV<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> eqTrueI<span class="main"><span class="main">,</span></span> <span class="operator">abs_def</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> ts list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_ts</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">(</span>progress <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sincep</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> MFOTL.Since <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_since_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> bool <span class="main">⇒</span>
    <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> msaux <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_since_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Monitor-qtable_mem_restr_UNIV"><span class="command">lemma</span></span> qtable_mem_restr_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>mem_restr UNIV<span class="main">)</span> <span class="free">Q</span> <span class="free">X</span> <span class="main">=</span> wf_table <span class="free">n</span> <span class="free">A</span> <span class="free">Q</span> <span class="free">X</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> qtable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-wf_since_aux_UNIV_alt"><span class="command">lemma</span></span> wf_since_aux_UNIV_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> UNIV <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">⟷</span> sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">aux</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span> <span class="main">⟶</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">∧</span>
      wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def qtable_mem_restr_UNIV <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_until_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> bool <span class="main">⇒</span>
    <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> ℐ <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> muaux <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_until_aux</span> <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span> <span class="bound">r1</span> <span class="main">∧</span>
      qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ne</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">∧</span> mem <span class="main">(</span>τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="bound">i</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span>
          MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free"><span class="bound"><span class="entity">σ</span></span></span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
    <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">ne</span></span></span><span class="main">+</span>length <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1" id="Monitor-wf_until_aux_UNIV_alt"><span class="command">lemma</span></span> wf_until_aux_UNIV_alt<span class="main">:</span>
  <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> UNIV <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span> <span class="main">⟷</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">i</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">r1</span><span class="main">,</span> <span class="bound">r2</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">∧</span>
      wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span>
          <span class="keyword1">then</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="free">aux</span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span>
          <span class="keyword1">else</span> <span class="main">(</span><span class="main">∃</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="free">aux</span><span class="main">}</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">r1</span> <span class="main">∧</span>
      wf_table <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span> <span class="main">∧</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="free">I</span> <span class="main">∧</span>
          MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∧</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="bound">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="bound">r2</span><span class="main">)</span>
    <span class="free">aux</span> <span class="main">[</span><span class="free">ne</span><span class="main">..&lt;</span><span class="free">ne</span><span class="main">+</span>length <span class="free">aux</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def qtable_mem_restr_UNIV <span class="keyword1"><span class="command">..</span></span>
   

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">wf_mformula</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.trace <span class="main">⇒</span> nat <span class="main">⇒</span>
  nat <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> mformula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">σ</span> <span class="entity">j</span> <span class="keyword2"><span class="keyword">where</span></span>
  Eq<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">∨</span> MFOTL.is_Const <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MRel <span class="main">(</span>eq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>MFOTL.Eq <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> neq_Const<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> MRel <span class="main">(</span>neq_rel <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> neq_Var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MRel empty_table<span class="main">)</span> <span class="main">(</span>MFOTL.Neg <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="main">|</span> Pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MPred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">ts</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> And<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> MFOTL.And <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="main">(</span>safe_formula <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>
      <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span> <span class="main">=</span> MFOTL.And_Not <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">∧</span> safe_formula <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">∧</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MAnd <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">χ</span></span></span>"</span></span>
<span class="main">|</span> Or<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">=</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MOr <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">(</span>lift_envs <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MExists <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">⟷</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MPrev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Next<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟹</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MNext <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">first</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Since<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟹</span>
    MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_since_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MSince <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> Until<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span> <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> MFOTL.Neg <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⟹</span>
    safe_formula <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="main">⟹</span>
    MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="main">⊆</span> MFOTL.fv <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="main">⟹</span>
    wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="main">⟹</span>
    wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="main">⟹</span>
    wf_until_aux <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    progress <span class="free">σ</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">aux</span></span></span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">φ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">wf_mformula</span> <span class="free">σ</span> <span class="free">j</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>MUntil <span class="free"><span class="bound"><span class="entity">pos</span></span></span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="free"><span class="bound"><span class="entity">buf</span></span></span> <span class="free"><span class="bound"><span class="entity">nts</span></span></span> <span class="free"><span class="bound"><span class="entity">aux</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">φ''</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ'</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_mstate</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> <span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> <span class="tfree">'a</span> list set <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_mstate</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">⟷</span> mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> MFOTL.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">σ</span> <span class="main">⟶</span>
    mstate_i <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> progress <span class="bound">σ</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">∧</span>
    wf_mformula <span class="bound">σ</span> <span class="main">(</span>plen <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="main">(</span>mstate_m <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Initialisation›</span></span>

<span class="keyword1" id="Monitor-minit0_And"><span class="command">lemma</span></span> minit0_And<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>safe_formula <span class="main">(</span>MFOTL.Neg <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> MFOTL.fv <span class="free">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">⟹</span>
     minit0 <span class="free">n</span> <span class="main">(</span>MFOTL.And <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> MAnd <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> True <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-minit0_And_Not"><span class="command">lemma</span></span> minit0_And_Not<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">ψ</span> <span class="main">∧</span> MFOTL.fv <span class="free">ψ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">φ</span> <span class="main">⟹</span>
  minit0 <span class="free">n</span> <span class="main">(</span>MFOTL.And_Not <span class="free">φ</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>MAnd <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> False <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_Not_def MFOTL.is_Neg_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> formula.split<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_mbuf2'_0"><span class="command">lemma</span></span> wf_mbuf2'_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="main">0</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_mbuf2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-wf_ts_0"><span class="command">lemma</span></span> wf_ts_0<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="main">0</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-wf_since_aux_Nil"><span class="command">lemma</span></span> wf_since_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span> <span class="main">[]</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-wf_until_aux_Nil"><span class="command">lemma</span></span> wf_until_aux_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ'</span> <span class="free">I</span> <span class="free">ψ'</span> <span class="main">[]</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-wf_minit0"><span class="command">lemma</span></span> wf_minit0<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv <span class="free">φ</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  wf_mformula <span class="free">σ</span> <span class="main">0</span> <span class="free">n</span> <span class="free">R</span> <span class="main">(</span>minit0 <span class="free">n</span> <span class="free">φ</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minit0_And fvi_And minit0_And_Not fvi_And_Not
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.intros wf_mbuf2'_0 wf_ts_0 wf_since_aux_Nil wf_until_aux_Nil
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> fvi_Suc_bound<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_mstate_minit"><span class="command">lemma</span></span> wf_mstate_minit<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> pnil <span class="free">R</span> <span class="main">(</span>minit <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def minit_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_minit0 fvi_less_nfv<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Evaluation›</span></span>

<span class="keyword1" id="Monitor-match_wf_tuple"><span class="command">lemma</span></span> match_wf_tuple<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> MFOTL.fv_trm <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>tabulate <span class="free">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Monitor-match_fvi_trm_None"><span class="command">lemma</span></span> match_fvi_trm_None<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="free">x</span> <span class="main">∉</span> MFOTL.fv_trm <span class="bound">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1" id="Monitor-match_fvi_trm_Some"><span class="command">lemma</span></span> match_fvi_trm_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">∈</span> set <span class="free">ts</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> MFOTL.fv_trm <span class="free">t</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1" id="Monitor-match_eval_trm"><span class="command">lemma</span></span> match_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">i</span><span class="main">∈</span>MFOTL.fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> Some <span class="free">f</span> <span class="main">=</span> match <span class="free">ts</span> <span class="free">xs</span> <span class="main">⟹</span>
    map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> the <span class="main">(</span><span class="free">f</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 3<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> 3<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> match_fvi_trm_Some sym <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_tuple_tabulate_Some"><span class="command">lemma</span></span> wf_tuple_tabulate_Some<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="main">(</span>tabulate <span class="free">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-ex_match"><span class="command">lemma</span></span> ex_match<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> MFOTL.fv_trm <span class="bound">t</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="free">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="bound">t</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> match <span class="free">ts</span> <span class="main">(</span>map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">f</span> <span class="main">∧</span> <span class="free">v</span> <span class="main">=</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">ts</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> match.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">ts</span> <span class="skolem">y</span> <span class="skolem">ys</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> MFOTL.fv_trm <span class="bound">t</span><span class="main">)</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_absorb <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_tuple_tabulate_Some meta_spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> 3<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span>
      *<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span> <span class="main">=</span> map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="main">(</span><span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_list_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> False 3<span class="main">(</span>2-4<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span>
      <span class="quoted"><span class="quoted">"match <span class="skolem">ts</span> <span class="main">(</span>map <span class="main">(</span>MFOTL.eval_trm <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ts</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span><span class="main">[</span><span class="skolem">x</span> <span class="main">:=</span> None<span class="main">]</span> <span class="main">=</span> tabulate <span class="skolem">f</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> *
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> 3<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">v</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">x</span></span></span> <span class="main"><span class="main"><span class="main">:=</span></span></span> None<span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def nth_list_update <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> eval_trm_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> None"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">v</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> match_fvi_trm_None<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sym<span class="main"><span class="main">]</span></span> arg_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted">length</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 3<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> nth_equalityI<span class="main">)</span>

<span class="keyword1" id="Monitor-eq_rel_eval_trm"><span class="command">lemma</span></span> eq_rel_eval_trm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">v</span> <span class="main">∈</span> eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span> <span class="main">⟹</span> MFOTL.is_Const <span class="free">t1</span> <span class="main">∨</span> MFOTL.is_Const <span class="free">t2</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>MFOTL.fv_trm <span class="free">t1</span> <span class="main">∪</span> MFOTL.fv_trm <span class="free">t2</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span> MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> singleton_table_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Monitor-in_eq_rel"><span class="command">lemma</span></span> in_eq_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fv_trm <span class="free">t1</span> <span class="main">∪</span> MFOTL.fv_trm <span class="free">t2</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  MFOTL.is_Const <span class="free">t1</span> <span class="main">∨</span> MFOTL.is_Const <span class="free">t2</span> <span class="main">⟹</span>
  MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t1</span> <span class="main">=</span> MFOTL.eval_trm <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">t2</span> <span class="main">⟹</span>
  <span class="free">v</span> <span class="main">∈</span> eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> singleton_table_def wf_tuple_def unit_table_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> nth_equalityI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1" id="Monitor-table_eq_rel"><span class="command">lemma</span></span> table_eq_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.is_Const <span class="free">t1</span> <span class="main">∨</span> MFOTL.is_Const <span class="free">t2</span> <span class="main">⟹</span>
  table <span class="free">n</span> <span class="main">(</span>MFOTL.fv_trm <span class="free">t1</span> <span class="main">∪</span> MFOTL.fv_trm <span class="free">t2</span><span class="main">)</span> <span class="main">(</span>eq_rel <span class="free">n</span> <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t1</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span> <span class="quoted"><span class="free">t2</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Monitor-wf_tuple_Suc_fviD"><span class="command">lemma</span></span> wf_tuple_Suc_fviD<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>tl <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fvi_Suc nth_tl<span class="main">)</span>

<span class="keyword1" id="Monitor-table_fvi_tl"><span class="command">lemma</span></span> table_fvi_tl<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="free">X</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_tuple_Suc_fviD<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_tuple_Suc_fvi_SomeI"><span class="command">lemma</span></span> wf_tuple_Suc_fvi_SomeI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> MFOTL.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>Some <span class="free">x</span> <span class="main">#</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc less_Suc_eq_0_disj<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_tuple_Suc_fvi_NoneI"><span class="command">lemma</span></span> wf_tuple_Suc_fvi_NoneI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∉</span> MFOTL.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">⟹</span>
  wf_tuple <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>MFOTL.fvi <span class="free">b</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>None <span class="main">#</span> <span class="free">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_tuple_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_Suc less_Suc_eq_0_disj<span class="main">)</span>

<span class="keyword1" id="Monitor-qtable_project_fv"><span class="command">lemma</span></span> qtable_project_fv<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="main">(</span>lift_envs <span class="free">R</span><span class="main">)</span><span class="main">)</span> <span class="free">P</span> <span class="free">X</span> <span class="main">⟹</span>
    qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fvi <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span><span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">∈</span> fv <span class="free">φ</span> <span class="keyword1">then</span> Some <span class="bound">x</span> <span class="keyword1">else</span> None<span class="main">)</span> <span class="main">#</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>tl <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_iff Bex_def fvi_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_project<span class="main">)</span>

<span class="keyword1" id="Monitor-mprev"><span class="command">lemma</span></span> mprev<span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
    <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="free">ys</span> <span class="main">∧</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs'</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">I</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="free">j'</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">I</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-mnext"><span class="command">lemma</span></span> mnext<span class="main">:</span> <span class="quoted"><span class="quoted">"mprev_next <span class="free">I</span> <span class="free">xs</span> <span class="free">ts</span> <span class="main">=</span> <span class="main">(</span><span class="free">ys</span><span class="main">,</span> <span class="free">xs'</span><span class="main">,</span> <span class="free">ts'</span><span class="main">)</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="free">i</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts</span> <span class="main">⟹</span> Suc <span class="free">i</span> <span class="main">≤</span> <span class="free">j'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="free">I</span> <span class="keyword1">then</span> <span class="free">P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
    <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">]</span> <span class="free">ys</span> <span class="main">∧</span>
  list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="main">(</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">xs'</span> <span class="main">∧</span>
  list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span><span class="free">j'</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">ts'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">ys</span></span> <span class="quoted"><span class="free">xs'</span></span> <span class="quoted"><span class="free">ts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mprev_next.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">I</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">I</span> <span class="skolem">v</span> <span class="skolem">v'</span> <span class="skolem">t</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span><span class="free">j'</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 3 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">I</span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">t</span> <span class="skolem">t'</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 4<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"tl <span class="skolem">ys</span>"</span></span> <span class="quoted"><span class="skolem">xs'</span></span> <span class="quoted"><span class="skolem">ts'</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span>"</span></span><span class="main">]</span> 4<span class="main">(</span>2-6<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv Suc_less_eq2
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits if_splits<span class="main">)</span> <span class="comment1">(* slow 10 sec *)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-in_foldr_UnI"><span class="command">lemma</span></span> in_foldr_UnI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="free">xs</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-in_foldr_UnE"><span class="command">lemma</span></span> in_foldr_UnE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> foldr <span class="main">(∪)</span> <span class="free">xs</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> <span class="bound">A</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> <span class="bound">A</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="Monitor-sat_the_restrict"><span class="command">lemma</span></span> sat_the_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">⊆</span> <span class="free">A</span> <span class="main">⟹</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="main">(</span>restrict <span class="free">A</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">=</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sat_fvi_cong<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_the_restrict<span class="main">)</span>

<span class="keyword1" id="Monitor-update_since"><span class="command">lemma</span></span> update_since<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> result_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">rel</span><span class="main">,</span> <span class="free">aux'</span><span class="main">)</span> <span class="main">=</span> update_since <span class="free">I</span> <span class="free">pos</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">aux</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?wf_tuple</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">aux0</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> join <span class="bound">rel</span> <span class="free">pos</span> <span class="free">rel1</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">aux</span><span class="main">,</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free">I</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> sorted_aux0<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="skolem">aux0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pre<span class="main">[</span><span class="operator">unfolded</span> wf_since_aux_def<span class="main">,</span> <span class="operator">THEN</span> conjunct1<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux0_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">aux</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_aux0_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">∧</span>
      <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span>MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span>
        <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux0_def <span class="keyword1"><span class="command">using</span></span> fvi_subset
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_since_aux_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct1<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> in_aux0_le_τ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> τ_mono diff_le_self le_trans<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> in_aux0_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">⟹</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span> <span class="main">⟹</span>
    <span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_since_aux_def<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> conjunct2<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gr0_conv_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order_trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> diff_le_mono τ_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> join <span class="skolem">X</span> <span class="free">pos</span> <span class="free">rel1</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> aux0_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> aux0_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">aux0</span> <span class="main">=</span> <span class="main">[]</span> <span class="main">⟹</span> <span class="free">ne</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span> <span class="main">∧</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∄</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> in_aux0_2 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> aux'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">aux0</span> <span class="keyword1">of</span>
      <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span><span class="main">]</span>
    <span class="main">|</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">if</span> fst <span class="bound">x</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">x</span> <span class="main">∪</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">aux'</span> <span class="keyword1">else</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span><span class="main">,</span> <span class="free">rel2</span><span class="main">)</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">#</span> <span class="bound">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">unfolding</span></span> aux0_def update_since_def Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> sorted_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"sorted_wrt <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">&gt;</span> fst <span class="bound">y</span><span class="main">)</span> <span class="free">aux'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq
    <span class="keyword1"><span class="command">using</span></span> sorted_aux0 in_aux0_le_τ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> in_aux'_1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">∧</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span> <span class="skolem">X</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword1"><span class="command">with</span></span> aux' <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> qtable2 aux0_Nil
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> t<span class="main">:</span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> snd <span class="skolem">a</span> <span class="main">∪</span> <span class="free">rel2</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> sorted_aux0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> in_aux0_1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
          <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> fst <span class="skolem">a</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> fst <span class="skolem">a</span>"</span></span>
          <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>
            <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> fst <span class="skolem">a</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span>
              <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">a</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> qtable2 t True
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="free">rel2</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> sorted_aux0 in_aux0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> aux' Cons t False <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> qtable2 in_aux0_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span><span class="main">]</span> in_aux0_le_τ<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">a</span>"</span></span><span class="main">]</span> sorted_aux0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enat_0_iff not_le
            <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_τ_less meta_mp<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> aux' Cons <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span>
        <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="main">(</span>point <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="main">∧</span>
           <span class="main">(</span><span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> in_aux0_1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">with</span></span> False aux' Cons <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> qtable2
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_Since_rec<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free">ne</span></span><span class="main"><span class="main">]</span></span> sat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
          diff_diff_right<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> j<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span> <span class="main">+</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> k<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span><span class="main"><span class="main">,</span></span>
            <span class="operator">OF</span> trans_le_add2<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> order_trans <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> le_τ_less<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> in_aux'_2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">t</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">aux0</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">as</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> True <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fst <span class="skolem">a</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> that <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> le_τ_less neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> False that <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span><span class="main">-</span><span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI Suc_pred τ_mono diff_is_0_eq' order.antisym neq0_conv not_le<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">aux0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="skolem">t</span> <span class="main">≤</span> right <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∃</span><span class="bound">i</span><span class="main">.</span> τ <span class="free">σ</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">t</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">atomize_elim</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux0_2<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq <span class="keyword1"><span class="command">using</span></span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">X</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.split<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux'</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_since_aux_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_aux'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> sorted_aux' in_aux'_2<span class="main">)</span>

  <span class="keyword1"><span class="command">have</span></span> rel_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> foldr <span class="main">(∪)</span> <span class="main">[</span><span class="bound">rel</span><span class="main">.</span> <span class="main">(</span>t<span class="main">,</span> rel<span class="main">)</span> <span class="main">←</span> <span class="free">aux'</span><span class="main">,</span> left <span class="free">I</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span><span class="main">]</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> aux'_eq aux0_def
    <span class="keyword1"><span class="command">using</span></span> result_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_since_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rel_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">rel</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">rel</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">aux'</span><span class="main">.</span> <span class="keyword1">if</span> left <span class="free">I</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">ne</span> <span class="main">-</span> <span class="bound">t</span> <span class="keyword1">then</span> <span class="bound">rel</span> <span class="keyword1">else</span> empty_table<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnE bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_foldr_UnI<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">ne</span> <span class="main">(</span>Sincep <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span> <span class="free">rel</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> rel_alt
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> qtable_Union<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Qi<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="main"><span class="main">(</span></span><span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">,</span></span> <span class="bound"><span class="bound">X</span></span><span class="main"><span class="main">)</span></span> <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">.</span></span>
    left <span class="free"><span class="free">I</span></span> <span class="main"><span class="main">≤</span></span> τ <span class="free"><span class="free">σ</span></span> <span class="free"><span class="free">ne</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">t</span></span> <span class="main"><span class="main">∧</span></span> MFOTL.sat <span class="free"><span class="free">σ</span></span> <span class="main"><span class="main">(</span></span>map the <span class="bound"><span class="bound">v</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ne</span></span> <span class="main"><span class="main">(</span></span>Sincep <span class="free"><span class="free">pos</span></span> <span class="free"><span class="free">φ</span></span> <span class="main"><span class="main">(</span></span>point <span class="main"><span class="main">(</span></span>τ <span class="free"><span class="free">σ</span></span> <span class="free"><span class="free">ne</span></span> <span class="main"><span class="main">-</span></span> <span class="bound"><span class="bound">t</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">ψ</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
    <span class="operator">goal_cases</span> finite qtable equiv<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>equiv <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> sat_Since_point<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> left right<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>left <span class="skolem">j</span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> in_aux'_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">j</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> _ _ exI<span class="main">,</span> <span class="operator">OF</span> _ _ refl<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> right
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_Since_pointD <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> in_aux'_1<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_aux'_1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Monitor-length_update_until"><span class="command">lemma</span></span> length_update_until<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>update_until <span class="free">pos</span> <span class="free">I</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="free">nt</span> <span class="free">aux</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="free">aux</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> update_until_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Monitor-wf_update_until"><span class="command">lemma</span></span> wf_update_until<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="free">ne</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable1<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="free">φ</span><span class="main">)</span> <span class="free">rel1</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> qtable2<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">rel2</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span> <span class="main">⊆</span> MFOTL.fv <span class="free">ψ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span>update_until <span class="free">I</span> <span class="free">pos</span> <span class="free">rel1</span> <span class="free">rel2</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span><span class="main">)</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def length_update_until
  <span class="keyword1"><span class="command">unfolding</span></span> update_until_def list.rel_map add_Suc_right upt.simps eqTrueI<span class="main">[</span><span class="operator">OF</span> le_add1<span class="main">]</span> if_True
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list_all2_appendI<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> list.rel_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> old new<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> old
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> list.rel_mono_strong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_until_aux_def<span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mono1 mono2<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono1 <span class="skolem">i</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict less_Suc_eq
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_join<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable1<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono2 <span class="skolem">i</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">v</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> fvi_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sat_the_restrict less_Suc_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_union<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ qtable_join_fixed<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">OF</span> qtable2<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ refl<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="comment1">(* slow 8 sec*)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> new
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> qtable_empty qtable1 qtable2<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> qtable_cong<span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span>"</span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq zero_enat_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Monitor-wf_until_aux_Cons"><span class="command">lemma</span></span> wf_until_aux_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="free">a</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span>
  wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="free">aux</span> <span class="main">(</span>Suc <span class="free">ne</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">cong</span><span class="main"><span class="main">:</span></span> if_cong<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_until_aux_Cons1"><span class="command">lemma</span></span> wf_until_aux_Cons1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">ne</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_until_aux_Cons3"><span class="command">lemma</span></span> wf_until_aux_Cons3<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="free">n</span> <span class="free">R</span> <span class="free">pos</span> <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">a1</span><span class="main">,</span> <span class="free">a2</span><span class="main">)</span> <span class="main">#</span> <span class="free">aux</span><span class="main">)</span> <span class="free">ne</span> <span class="main">⟹</span>
  qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="free">ne</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="free">ne</span> <span class="main">+</span> length <span class="free">aux</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="free">ne</span><span class="main">)</span> <span class="free">I</span> <span class="main">∧</span>
    MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="free">ψ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="free">ne</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">a2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_until_aux_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_conv_Cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc<span class="main">)</span>

<span class="keyword1" id="Monitor-upt_append"><span class="command">lemma</span></span> upt_append<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex upt_add_eq_append<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_mbuf2_add"><span class="command">lemma</span></span> wf_mbuf2_add<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">ja</span><span class="main">..&lt;</span><span class="free">ja'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">Q</span> <span class="main">[</span><span class="free">jb</span><span class="main">..&lt;</span><span class="free">jb'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">ja'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">jb'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja'</span> <span class="free">jb'</span> <span class="free">P</span> <span class="free">Q</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_append2 upt_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> list_all2_lengthD
    <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">ja</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">ja</span><span class="main">..&lt;</span><span class="free">ja'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span>
           exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">jb</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">jb</span><span class="main">..&lt;</span><span class="free">jb'</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Monitor-mbuf2_take_eqD"><span class="command">lemma</span></span> mbuf2_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="free">buf</span> <span class="main">=</span> <span class="main">(</span><span class="free">xs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">i</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">Q</span> <span class="bound">i</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv min_absorb1 min_absorb2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Monitor-mbuf2t_take_eqD"><span class="command">lemma</span></span> mbuf2t_take_eqD<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2t_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Monitor-mbuf2t_take_induct"><span class="command">lemma</span></span> mbuf2t_take_induct<span class="main">[</span><span class="operator">consumes</span> 5<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="free">buf</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2 <span class="free">i</span> <span class="free">ja</span> <span class="free">jb</span> <span class="free">P</span> <span class="free">Q</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">R</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">ja</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">jb</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="free">i</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> <span class="free">ja</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> <span class="free">jb</span> <span class="main">⟹</span>
      <span class="free">P</span> <span class="bound">k</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">Q</span> <span class="bound">k</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="free">R</span> <span class="bound">k</span> <span class="bound">t</span> <span class="main">⟹</span> <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">t</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="free">ja</span> <span class="free">jb</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="free">buf</span></span> <span class="quoted"><span class="free">nts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">z'</span></span> <span class="quoted"><span class="free">buf'</span></span> <span class="quoted"><span class="free">nts'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> mbuf2t_take.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv less_eq_Suc_le min_absorb1 min_absorb2
       <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> arg_cong2<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">U</span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> _ refl<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Monitor-mbuf2_take_add'"><span class="command">lemma</span></span> mbuf2_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2_take <span class="free">f</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">zs</span><span class="main">,</span> <span class="free">buf'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">Z</span><span class="main">.</span> <span class="main">∃</span><span class="bound">X</span> <span class="bound">Y</span><span class="main">.</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">∧</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">∧</span>
      <span class="bound">Z</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">X</span> <span class="bound">Y</span><span class="main">)</span>
      <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">)</span><span class="main">]</span> <span class="free">zs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Monitor-mbuf2t_take_add'"><span class="command">lemma</span></span> mbuf2t_take_add'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j'</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">j'</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">nts'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_ts_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2t_take_eqD<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span><span class="main"><span class="main">]</span></span>
      progress_le<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Monitor-mbuf2t_take_add_induct'"><span class="command">lemma</span></span> mbuf2t_take_add_induct'<span class="main">[</span><span class="operator">consumes</span> 6<span class="main">,</span> <span class="operator">case_names</span> base step<span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="free">f</span> <span class="free">z</span> <span class="main">(</span>mbuf2_add <span class="free">xs</span> <span class="free">ys</span> <span class="free">buf</span><span class="main">)</span> <span class="free">nts</span> <span class="main">=</span> <span class="main">(</span><span class="free">z'</span><span class="main">,</span> <span class="free">buf'</span><span class="main">,</span> <span class="free">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">ψ</span> <span class="free">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pre_nts<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span><span class="free">j'</span><span class="main">]</span> <span class="free">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">xs</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ys<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">ψ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">]</span> <span class="free">ys</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> base<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">k</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="bound">z</span><span class="main">.</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟹</span>
      Suc <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span> <span class="main">⟹</span> Suc <span class="bound">k</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span> <span class="main">⟹</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">φ</span><span class="main">)</span> <span class="bound">X</span> <span class="main">⟹</span>
      qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="free">ψ</span><span class="main">)</span> <span class="bound">Y</span> <span class="main">⟹</span>
      <span class="free">U</span> <span class="bound">k</span> <span class="bound">z</span> <span class="main">⟹</span> <span class="free">U</span> <span class="main">(</span>Suc <span class="bound">k</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span> <span class="bound">Y</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">U</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j'</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j'</span><span class="main">)</span><span class="main">)</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> pre_buf pre_nts <span class="keyword1"><span class="command">unfolding</span></span> wf_mbuf2'_def wf_ts_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mbuf2t_take_induct<span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq<span class="main"><span class="main">]</span></span> wf_mbuf2_add<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ xs ys<span class="main"><span class="main">]</span></span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="free">j</span> <span class="main">≤</span> <span class="free">j'</span>›</span></span><span class="main"><span class="main">]</span></span>
      progress_le base step<span class="main">)</span>

<span class="keyword1" id="Monitor-progress_Until_le"><span class="command">lemma</span></span> progress_Until_le<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="free">φ</span> <span class="free">I</span> <span class="free">ψ</span><span class="main">)</span> <span class="free">j</span> <span class="main">≤</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="free">ψ</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="free">I</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> trans_le_add1 <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower<span class="main">)</span>

<span class="keyword1" id="Monitor-list_all2_upt_Cons"><span class="command">lemma</span></span> list_all2_upt_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">a</span> <span class="free">x</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span>Suc <span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> Suc <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span>
  list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>

<span class="keyword1" id="Monitor-list_all2_upt_append"><span class="command">lemma</span></span> list_all2_upt_append<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">b</span><span class="main">]</span> <span class="free">xs</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">b</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="free">ys</span> <span class="main">⟹</span>
  <span class="free">a</span> <span class="main">≤</span> <span class="free">b</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">≤</span> <span class="free">c</span> <span class="main">⟹</span> list_all2 <span class="free">P</span> <span class="main">[</span><span class="free">a</span><span class="main">..&lt;</span><span class="free">c</span><span class="main">]</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">a</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_all2_Cons2 upt_eq_Cons_conv<span class="main">)</span>

<span class="keyword1" id="Monitor-meval"><span class="command">lemma</span></span> meval<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="free">n</span> <span class="free">R</span> <span class="free">φ</span> <span class="free">φ'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> meval <span class="free">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="free">φ</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">xs</span><span class="main">,</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span><span class="main">)</span> <span class="main">⇒</span> wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="free">n</span> <span class="free">R</span> <span class="bound">φ<span class="hidden">⇩</span><sub>n</sub></span> <span class="free">φ'</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="free">n</span> <span class="main">(</span>MFOTL.fv <span class="free">φ'</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ'</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ'</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="bound">xs</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">R</span></span> <span class="quoted"><span class="free">φ'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MRel <span class="skolem">rel</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ball_Un <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.intros qtableI table_eq_rel eq_rel_eval_trm
        in_eq_rel qtable_empty qtable_unit_table<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPred <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> table_def in_these_eq match_wf_tuple match_eval_trm image_iff <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> ex_match
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.intros qtableI <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MAnd <span class="skolem">φ</span> <span class="skolem">pos</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MAnd.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fvi_And sat_And fvi_And_Not sat_And_Not sat_the_restrict
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MAnd.IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.And qtable_join
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mbuf2_take_add' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MOr <span class="skolem">φ</span> <span class="skolem">ψ</span> <span class="skolem">buf</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MOr.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MOr.IH <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Or qtable_union
       <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mbuf2_take_add' <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MExists <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MExists.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
      <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list.rel_map fvi_Suc sat_fvi_cong nth_Cons'
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Exists <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> MExists.IH qtable_project_fv 
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong table_fvi_tl qtable_cong sat_fvi_cong<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span> -1<span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MPrev <span class="skolem">I</span> <span class="skolem">φ</span> <span class="skolem">first</span> <span class="skolem">buf</span> <span class="skolem">nts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MPrev.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Prev <span class="skolem">ψ</span><span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="main">(</span><span class="skolem">buf</span> <span class="main">@</span> <span class="var">?xs</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Prev MPrev.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="var">?φ</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="var">?P</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Prev<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">I</span> <span class="keyword1">then</span> <span class="var">?P</span> <span class="bound">i</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
        <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">..&lt;</span><span class="var">?min</span><span class="main">]</span> <span class="var">?ls</span> <span class="main">∧</span>
       list_all2 <span class="var">?P</span> <span class="main">[</span><span class="var">?min</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?rs</span> <span class="main">∧</span>
       list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="var">?min</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="var">?ts</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mprev<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono progress_le <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> 
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_upt_append list_all2_appendI order.trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> min.cobounded1<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>Suc <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> Suc <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span><span class="free">j</span><span class="main">-</span><span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> Prev<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> IH 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> map_Suc_upt<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> upt_Suc<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main"><span class="main">]</span></span> list.rel_map qtable_empty_iff
        <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Prev list.rel_mono_strong
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MNext <span class="skolem">I</span> <span class="skolem">φ</span> <span class="skolem">first</span> <span class="skolem">nts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> MNext.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Next <span class="skolem">ψ</span><span class="main">)</span>

    <span class="keyword1"><span class="command">have</span></span> min<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
      <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
      <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
      <span class="keyword1"><span class="command">using</span></span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="skolem">j</span></span><span class="main">]</span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="main">(</span><span class="var">?xs</span><span class="main">,</span> <span class="skolem">first</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span> <span class="main">#</span> <span class="bound">xs</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="bound">xs</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="var">?xs</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?φ</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ts</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>snd <span class="main">(</span>mprev_next <span class="skolem">I</span> <span class="var">?ys</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>fv <span class="skolem">ψ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> Next MNext.IH<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">n</span></span> <span class="quoted"><span class="skolem">R</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="var">?φ</span> <span class="skolem">ψ</span>"</span></span>
      <span class="quoted"><span class="quoted">"list_all2 <span class="var">?P</span> <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> Next <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">X</span><span class="main">.</span> <span class="keyword1">if</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="skolem">I</span> <span class="keyword1">then</span> <span class="var">?P</span> <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="bound">X</span> <span class="keyword1">else</span> <span class="bound">X</span> <span class="main">=</span> empty_table<span class="main">)</span>
        <span class="main">[</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">-</span> <span class="main">1</span><span class="main">..&lt;</span><span class="var">?min</span><span class="main">]</span> <span class="var">?ls</span> <span class="main">∧</span>
       list_all2 <span class="var">?P</span> <span class="main">[</span>Suc <span class="var">?min</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="var">?rs</span> <span class="main">∧</span>
       list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">[</span><span class="var">?min</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="var">?ts</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span> that
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mnext<span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono list_all2_Cons2 upt_eq_Cons_conv
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list_all2_upt_append list_all2_appendI <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> progress_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span><span class="main">]</span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> Next IH
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">&gt;</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="free">j</span>"</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qtable_empty_iff le_Suc_eq le_diff_conv
         <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Next list.rel_mono_strong list_all2_appendI
         <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split list.splits if_split_asm<span class="main">)</span>  <span class="comment1">(* slow 5 sec*)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MSince <span class="skolem">pos</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MSince.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="skolem"><span class="skolem">φ'''</span></span> <span class="skolem"><span class="skolem">ψ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Since_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> MFOTL.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="skolem">φ'''</span> <span class="main">=</span> MFOTL.Neg <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="skolem">φ''</span> <span class="main">⊆</span> MFOTL.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="skolem">φ'''</span> <span class="main">=</span> MFOTL.fv <span class="skolem">φ''</span>"</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all2_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> update<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_since_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="main">(</span>snd <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>MFOTL.fv <span class="skolem">φ'''</span> <span class="main">∪</span> MFOTL.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
      <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Since <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">]</span> <span class="main">(</span>fst <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">if</span></span> eval_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eval_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="main">(</span><span class="main">λ</span><span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="main">(</span><span class="bound">zs</span><span class="main">,</span> <span class="bound">aux</span><span class="main">)</span><span class="main">.</span>
        <span class="keyword1">case</span> update_since <span class="skolem">I</span> <span class="skolem">pos</span> <span class="bound">r1</span> <span class="bound">r2</span> <span class="bound">t</span> <span class="bound">aux</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">zs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">z</span><span class="main">]</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="skolem">aux</span><span class="main">)</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux'</span><span class="main">)</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span>
    <span class="keyword1"><span class="command">unfolding</span></span> progress.simps φ'''
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free">j</span></span>"</span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> z'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">zs</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">aux'</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
      <span class="operator">goal_cases</span> xs ys _ base step<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> xs
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> MSince.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> eval_φ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> ys
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
      <span class="keyword1"><span class="command">using</span></span> MSince.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> eval_ψ <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> base
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
     <span class="keyword1"><span class="command">using</span></span> aux <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> φ'''<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>step <span class="skolem">k</span> <span class="skolem">X</span> <span class="skolem">Y</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> fvi_subset pos
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Un_absorb1 <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_since<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list_all2_appendI <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update_since<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> MSince.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> MSince.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Since_eq <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mformula.Since<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _  _ pos pos_eq fvi_subset<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>MUntil <span class="skolem">pos</span> <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span> <span class="skolem">buf</span> <span class="skolem">nts</span> <span class="skolem">aux</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> sat.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span> progress.simps<span class="main">[</span><span class="operator">simp</span> <span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword"><span class="quasi_keyword">del</span></span></span></span></span></span></span></span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> MUntil.prems <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">φ''</span></span> <span class="skolem"><span class="skolem">φ'''</span></span> <span class="skolem"><span class="skolem">ψ''</span></span> <span class="keyword2"><span class="keyword">where</span></span> Until_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">φ'</span> <span class="main">=</span> MFOTL.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="skolem">φ'''</span> <span class="main">=</span> MFOTL.Neg <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> pos_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="skolem">φ'''</span> <span class="main">=</span> <span class="skolem">pos</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> φ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ</span> <span class="skolem">φ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">ψ</span> <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> fvi_subset<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="skolem">φ''</span> <span class="main">⊆</span> MFOTL.fv <span class="skolem">ψ''</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> buf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mbuf2' <span class="free">σ</span> <span class="free">j</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">buf</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> nts<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="free">j</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> length_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">aux</span> <span class="main">=</span>
      min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quasi_keyword">pred</span><span class="main"><span class="main">:</span></span> wf_mformula<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> φ'''<span class="main">:</span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="skolem">j</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">using</span></span> pos <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress.simps <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> nts_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span> <span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span>
    <span class="main">[</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="free">j</span><span class="main">)</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">]</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> nts <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_le<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> min.coboundedI1<span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> list_all2_appendI<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">zs</span> <span class="skolem">aux'</span> <span class="skolem">aux''</span> <span class="skolem">buf'</span> <span class="skolem">nts'</span>
    <span class="keyword3"><span class="command">assume</span></span> eval_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">φ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">xs</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eval_ψ<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>meval <span class="skolem">n</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq1<span class="main">:</span> <span class="quoted"><span class="quoted">"mbuf2t_take <span class="main">(</span>update_until <span class="skolem">I</span> <span class="skolem">pos</span><span class="main">)</span> <span class="skolem">aux</span> <span class="main">(</span>mbuf2_add <span class="skolem">xs</span> <span class="skolem">ys</span> <span class="skolem">buf</span><span class="main">)</span> <span class="main">(</span><span class="skolem">nts</span> <span class="main">@</span> <span class="main">[</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">(</span><span class="skolem">aux'</span><span class="main">,</span> <span class="skolem">buf'</span><span class="main">,</span> <span class="skolem">nts'</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> eq2<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_until <span class="skolem">I</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="skolem">aux'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">zs</span><span class="main">,</span> <span class="skolem">aux''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> update1<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
      progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="free">j</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span>
        min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MUntil.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> eval_φ MUntil.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span>
        eval_ψ nts_snoc nts_snoc length_aux aux fvi_subset
      <span class="keyword1"><span class="command">unfolding</span></span> φ'''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">elim</span> mbuf2t_take_add_induct'<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j'<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="free"><span class="free"><span class="free">j</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> eq1 buf<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_update_until <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> wf_update_until<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> nts'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_ts <span class="free">σ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="skolem">φ''</span> <span class="skolem">ψ''</span> <span class="skolem">nts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> MUntil.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> eval_φ MUntil.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> eval_ψ nts_snoc
      <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> mbuf2t_take_eqD<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> eq1<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> progress_mono progress_le
        <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> wf_mbuf2_add buf<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> wf_mbuf2'_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
      wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="skolem">i</span> <span class="main">⟹</span>
      <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
      wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux''</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">∧</span>
        <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span> <span class="main">+</span> length <span class="skolem">aux''</span> <span class="main">=</span> min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
        list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="skolem">n</span> <span class="main">(</span>MFOTL.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span>
          <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="main">(</span>formula.Until <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> MFOTL.Neg <span class="skolem">φ''</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
          <span class="main">[</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">zs</span><span class="main">]</span> <span class="skolem">zs</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">using</span></span> eq2
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">aux'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">zs</span></span> <span class="quoted"><span class="skolem">aux''</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> antisym<span class="main"><span class="main">[</span></span><span class="operator">OF</span> progress_Until_le<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">aux'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">a1</span></span> <span class="skolem"><span class="skolem">a2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_until_aux <span class="free">σ</span> <span class="skolem">n</span> <span class="skolem">R</span> <span class="skolem">pos</span> <span class="skolem">φ''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span> <span class="skolem">aux'</span> <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons1<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> 3<span class="main">:</span> <span class="quoted"><span class="quoted">"qtable <span class="skolem">n</span> <span class="main">(</span>MFOTL.fv <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="skolem">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span>
        <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span><span class="main">≥</span><span class="skolem">i</span><span class="main">.</span> <span class="bound">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span><span class="main">)</span> <span class="main">∧</span> mem <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">j</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="skolem">I</span> <span class="main">∧</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">j</span> <span class="skolem">ψ''</span> <span class="main">∧</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">∈</span><span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="bound">j</span><span class="main">}</span><span class="main">.</span> <span class="keyword1">if</span> <span class="skolem">pos</span> <span class="keyword1">then</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="skolem">φ''</span> <span class="keyword1">else</span> <span class="main">¬</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">k</span> <span class="skolem">φ''</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">a2</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> wf_until_aux_Cons3<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> Cons.prems<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> Suc_i_aux'<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">aux'</span> <span class="main">=</span>
          min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≥</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"enat <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span> <span class="main">≤</span> enat <span class="skolem">t</span> <span class="main">+</span> right <span class="skolem">I</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def progress.simps
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> 1 list_all2_Cons2 upt_eq_Cons_conv φ'''
          <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> cInf_lower τ_mono <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> order.trans<span class="main"><span class="main">[</span></span><span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="main">(</span>formula.Until <span class="skolem">φ'''</span> <span class="skolem">I</span> <span class="skolem">ψ''</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span>
        <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"enat <span class="skolem">t</span> <span class="main">+</span> right <span class="skolem">I</span> <span class="main">&lt;</span> enat <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> that <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> m<span class="main">:</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span> <span class="main">=</span> enat <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> τ_min<span class="main">:</span>  <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>min <span class="free">j</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> min <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min_of_mono monoI<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> le_progress_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">i</span> <span class="main">⟷</span> progress <span class="free">σ</span> <span class="skolem">φ</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">φ</span> <span class="skolem">i</span>
          <span class="keyword1"><span class="command">using</span></span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">φ</span></span> <span class="quoted"><span class="skolem">i</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> min_Suc<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"min <span class="free">j</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?X</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> Suc <span class="free">j</span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">≤</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ'''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> enat <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">k</span><span class="main">)</span> <span class="main">≤</span> enat <span class="main">(</span>τ <span class="free">σ</span> <span class="bound">i</span><span class="main">)</span> <span class="main">+</span> right <span class="skolem">I</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?min</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"min <span class="free">j</span> <span class="main">(</span>min <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>progress <span class="free">σ</span> <span class="skolem">ψ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="var">?min</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">j</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> τ_mono<span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> m <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> τ_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span>
           <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le not_less φ''' <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="skolem">φ''</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">thm</span></span> less_le_trans<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">from</span></span> m <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> that nts' <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def progress.simps
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> cInf_greatest<span class="main"><span class="main">[</span></span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="var">?X</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> 1 φ''' not_le not_less list_all2_Cons2 upt_eq_Cons_conv less_Suc_eq
              <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits
              <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="var">?min</span>"</span></span><span class="main"><span class="main">]</span></span> less_le_trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">_</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span><span class="main"><span class="main">]</span></span> less_τD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="skolem">ψ</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span>
        <span class="quoted"><span class="quoted">"enat <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">+</span> right <span class="skolem">I</span> <span class="main">&lt;</span> enat <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"enat <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> right <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ψ</span> <span class="main">=</span> <span class="skolem">ψ''</span> <span class="main">∨</span> <span class="skolem">ψ</span> <span class="main">=</span> <span class="skolem">φ''</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="skolem">ψ</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">from</span></span> that<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span> <span class="main">=</span> enat <span class="skolem">m</span>"</span></span>
           <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">&lt;</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">nts'</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">|</span> <span class="bound">nt</span> <span class="main">#</span> <span class="bound">x</span> <span class="main">⇒</span> <span class="bound">nt</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span> <span class="main">-</span> τ <span class="free">σ</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"right <span class="skolem">I</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">with</span></span> that<span class="main">(</span>3<span class="main">)</span> nts' progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">ψ''</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span> progress_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">σ</span></span> <span class="quoted"><span class="skolem">φ''</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">j</span>"</span></span><span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> wf_ts_def le_diff_conv
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> not_le list_all2_Cons2 upt_eq_Cons_conv less_Suc_eq add.commute
            <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> le_less_trans<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">k</span>"</span></span><span class="main"><span class="main">]</span></span> less_τD<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> Cons.prems Suc_i_aux'<span class="main">[</span><span class="operator">simplified</span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">a1</span><span class="main">,</span> <span class="skolem">a2</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> φ''' 1 sat.simps upt_conv_Cons <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span>  Cons.IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ aux' Suc_i_aux'<span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> upt_Suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits prod.splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> iff_exI qtable_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 3 refl<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">OF</span> progress_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> le_SucI<span class="main"><span class="main">,</span></span> <span class="operator">OF</span> order.refl<span class="main"><span class="main">]</span></span> conjunct1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">]</span></span> conjunct2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> update1<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">note</span></span> update <span class="main">=</span> this
  <span class="keyword1"><span class="command">from</span></span> MUntil.IH<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> φ<span class="main">]</span> MUntil.IH<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> ψ<span class="main">]</span> pos pos_eq fvi_subset <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 4 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Until_eq φ''' progress.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split if_splits
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> update<span class="main"><span class="main">[</span></span><span class="operator">OF</span> refl refl<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mformula.Until
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> list.rel_mono_strong qtable_cong
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span> mbuf2t_take_add'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ buf nts_snoc<span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor step›</span></span>

<span class="keyword1" id="Monitor-wf_mstate_mstep"><span class="command">lemma</span></span> wf_mstate_mstep<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span> <span class="main">⟹</span> last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span> <span class="main">⟹</span>
  wf_mstate <span class="free">φ</span> <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>snd <span class="main">(</span>mstep <span class="free">tdb</span> <span class="free">st</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def mstep_def Let_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> progress_mono le_imp_diff_is_add <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_psnocE <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> meval list_all2_lengthD<span class="main">)</span>

<span class="keyword1" id="Monitor-mstep_output_iff"><span class="command">lemma</span></span> mstep_output_iff<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">σ</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span>mstep <span class="free">tdb</span> <span class="free">st</span><span class="main">)</span> <span class="main">⟷</span>
    progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    wf_tuple <span class="main">(</span>MFOTL.nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>MFOTL.fv <span class="free">φ</span><span class="main">)</span> <span class="free">v</span> <span class="main">∧</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> prefix_of_psnocE<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="free">σ</span>"</span></span> 
    <span class="quoted"><span class="quoted">"Γ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">=</span> snd <span class="free">tdb</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="quoted"><span class="quoted">‹prefix_of <span class="free">π</span> <span class="free">σ</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mstate_n <span class="free">st</span> <span class="main">=</span> MFOTL.nfv <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"mstate_i <span class="free">st</span> <span class="main">=</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> wf_mstate_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> meval<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹wf_mformula <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="free">φ</span>›</span></span><span class="main">]</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Vs</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"meval <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Γ <span class="free">σ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mstate_m <span class="free">st</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">Vs</span><span class="main">,</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"wf_mformula <span class="free">σ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="free">R</span> <span class="skolem">st'</span> <span class="free">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"list_all2 <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> qtable <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="bound">i</span> <span class="free">φ</span><span class="main">)</span><span class="main">)</span>
      <span class="main">[</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">..&lt;</span>progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">]</span> <span class="skolem">Vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"qtable <span class="main">(</span>mstate_n <span class="free">st</span><span class="main">)</span> <span class="main">(</span>fv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>mem_restr <span class="free">R</span><span class="main">)</span>
    <span class="main">(</span><span class="main">λ</span><span class="bound">v</span><span class="main">.</span> MFOTL.sat <span class="free">σ</span> <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">Vs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>Suc <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> list_all2_conv_all_nth
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> mstep_def Let_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_set_enumerate_eq list_all2_conv_all_nth progress_mono le_imp_diff_is_add
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_qtableE in_qtableI <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">Vs</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">-</span> progress <span class="free">σ</span> <span class="free">φ</span> <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Monitor function›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">minit_safe</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">minit_safe</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> mmonitorable_exec <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">then</span> minit <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="keyword1">else</span> undefined<span class="main">)</span>"</span></span>

<span class="keyword1" id="Monitor-minit_safe_minit"><span class="command">lemma</span></span> minit_safe_minit<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">⟹</span> minit_safe <span class="free">φ</span> <span class="main">=</span> minit <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> minit_safe_def monitorable_formula_code <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> mstep_mverdicts<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> le<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> fst <span class="main">(</span>mstep <span class="free">tdb</span> <span class="free">st</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> p2<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_prefix_of <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword1"><span class="command">have</span></span> p1<span class="main">:</span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">blast</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_psnocE<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> M_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> 0 3 <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p2 progress_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span> sat_prefix_conv<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ p1<span class="main"><span class="main">]</span></span> not_less
        pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1<span class="main"><span class="main">]</span></span> pprogress_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p2<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span>  mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le p2 restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> spec<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">σ</span></span><span class="main"><span class="main">]</span></span>
             mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le _ restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD1<span class="main"><span class="main">]</span></span> progress_sat_cong<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p1<span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mstep_output_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf le p2 restrict<span class="main"><span class="main">,</span></span> <span class="operator">THEN</span> iffD2<span class="main"><span class="main">]</span></span> p1<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">msteps0</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msteps0</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msteps0</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> <span class="free">msteps0</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">∪</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">msteps0_stateless</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">msteps0_stateless</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">msteps0_stateless</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free"><span class="bound"><span class="entity">tdb</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="keyword1">in</span> <span class="bound">V'</span> <span class="main">∪</span> <span class="free">msteps0_stateless</span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="bound">st'</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Monitor-msteps0_msteps0_stateless"><span class="command">lemma</span></span> msteps0_msteps0_stateless<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>msteps0 <span class="free">w</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> msteps0_stateless <span class="free">w</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">w</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">lift_definition</span></span> msteps <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> option list<span class="main">)</span> set <span class="main">×</span> <span class="tfree">'a</span> mstate"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">msteps0</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> msteps_stateless <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.prefix <span class="main">⇒</span> <span class="tfree">'a</span> mstate <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> option list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted">msteps0_stateless</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1" id="Monitor-msteps_msteps_stateless"><span class="command">lemma</span></span> msteps_msteps_stateless<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>msteps <span class="free">w</span> <span class="free">st</span><span class="main">)</span> <span class="main">=</span> msteps_stateless <span class="free">w</span> <span class="free">st</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">rule</span> msteps0_msteps0_stateless<span class="main">)</span>

<span class="keyword1" id="Monitor-msteps0_snoc"><span class="command">lemma</span></span> msteps0_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"msteps0 <span class="main">(</span><span class="free">π</span> <span class="main">@</span> <span class="main">[</span><span class="free">tdb</span><span class="main">]</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> msteps0 <span class="free">π</span> <span class="free">st</span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free">tdb</span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">∪</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">π</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1" id="Monitor-msteps_psnoc"><span class="command">lemma</span></span> msteps_psnoc<span class="main">:</span> <span class="quoted"><span class="quoted">"last_ts <span class="free">π</span> <span class="main">≤</span> snd <span class="free">tdb</span> <span class="main">⟹</span> msteps <span class="main">(</span>psnoc <span class="free">π</span> <span class="free">tdb</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">V'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> msteps <span class="free">π</span> <span class="free">st</span><span class="main">;</span> <span class="main">(</span><span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mstep <span class="free">tdb</span> <span class="bound">st'</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">V'</span> <span class="main">∪</span> <span class="bound">V''</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msteps0_snoc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">monitor</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">monitor</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">=</span> msteps_stateless <span class="free"><span class="bound"><span class="entity">π</span></span></span> <span class="main">(</span>minit_safe <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Monitor-Suc_length_conv_snoc"><span class="command">lemma</span></span> Suc_length_conv_snoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>Suc <span class="free">n</span> <span class="main">=</span> length <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">ys</span> <span class="main">@</span> <span class="main">[</span><span class="bound">y</span><span class="main">]</span> <span class="main">∧</span> length <span class="bound">ys</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> wf_mstate_msteps<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span> <span class="main">⟹</span> mem_restr <span class="free">R</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span>
  <span class="free">X</span> <span class="main">=</span> msteps <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> <span class="free">π'</span> <span class="free">R</span> <span class="main">(</span>snd <span class="free">X</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> fst <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="quoted">"plen <span class="free">π'</span> <span class="main">-</span> plen <span class="free">π</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">X</span></span> <span class="quoted"><span class="free">st</span></span> <span class="quoted"><span class="free">π</span></span> <span class="quoted"><span class="free">π'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">from</span></span> 0<span class="main">(</span>1<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">=</span> <span class="skolem">π'</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="main">{}</span><span class="main">,</span> <span class="skolem">st</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 0<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Suc<span class="main">(</span>2<span class="main">,</span>5<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="skolem"><span class="skolem">tdb</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> plen <span class="skolem">π''</span> <span class="main">-</span> plen <span class="skolem">π</span>"</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">π</span> <span class="main">≤</span> <span class="skolem">π''</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="main">(</span>psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span><span class="main">)</span> <span class="main">=</span> psnoc <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π''</span><span class="main">)</span> <span class="skolem">tdb</span>"</span></span>
    <span class="quoted"><span class="quoted">"last_ts <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="skolem">π</span><span class="main">)</span> <span class="skolem">π''</span><span class="main">)</span> <span class="main">≤</span> snd <span class="skolem">tdb</span>"</span></span> <span class="quoted"><span class="quoted">"last_ts <span class="skolem">π''</span> <span class="main">≤</span> snd <span class="skolem">tdb</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">π''</span> <span class="main">≤</span> psnoc <span class="skolem">π''</span> <span class="skolem">tdb</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> prefix<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>prefix _ _ <span class="skolem">π'</span> _ <span class="skolem">π_tdb</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">π_tdb</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">π</span> <span class="skolem">tdb</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> prefix <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">π'</span></span></span> <span class="main"><span class="main"><span class="main">@</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">tdb</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_append append_eq_Cons_conv <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">qed</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> this<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Suc.prems<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span> this<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> refl<span class="main">]</span> Suc.prems <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> msteps_msteps_stateless<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> msteps_psnoc split_beta mstep_mverdicts
      <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> mono_monitor<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> set_mp<span class="main"><span class="main">,</span></span> <span class="operator">rotated</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> wf_mstate_mstep<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> wf_mstate_msteps_stateless<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> <span class="free">R</span> <span class="free">st</span>"</span></span> <span class="quoted"><span class="quoted">"mem_restr <span class="free">R</span> <span class="free">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> msteps_stateless <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mstate_msteps<span class="main">[</span><span class="operator">OF</span> assms refl<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> msteps_msteps_stateless <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> wf_mstate_msteps_stateless_UNIV<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_mstate <span class="free">φ</span> <span class="free">π</span> UNIV <span class="free">st</span> <span class="main">⟹</span> <span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span>
  msteps_stateless <span class="main">(</span>pdrop <span class="main">(</span>plen <span class="free">π</span><span class="main">)</span> <span class="free">π'</span><span class="main">)</span> <span class="free">st</span> <span class="main">=</span> M <span class="free">π'</span> <span class="main">-</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_mstate_msteps_stateless<span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ mem_restr_UNIV<span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> mverdicts_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"M pnil <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> M_def pprogress_eq<span class="main">)</span>

<span class="keyword1" id="Monitor-wf_mstate_minit_safe"><span class="command">lemma</span></span> wf_mstate_minit_safe<span class="main">:</span> <span class="quoted"><span class="quoted">"mmonitorable <span class="free">φ</span> <span class="main">⟹</span> wf_mstate <span class="free">φ</span> pnil <span class="free">R</span> <span class="main">(</span>minit_safe <span class="free">φ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_mstate_minit minit_safe_minit mmonitorable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> monitorable_mfotl<span class="main">)</span> monitor_mverdicts<span class="main">:</span> <span class="quoted"><span class="quoted">"monitor <span class="free">φ</span> <span class="free">π</span> <span class="main">=</span> M <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> monitor_def <span class="keyword1"><span class="command">using</span></span> monitorable
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> wf_mstate_msteps_stateless_UNIV<span class="main"><span class="main">[</span></span><span class="operator">OF</span> wf_mstate_minit_safe<span class="main"><span class="main">,</span></span> <span class="operator">simplified</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmonitorable_def mverdicts_Nil<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Collected correctness results›</span></span>

<span class="keyword1"><span class="command">context</span></span> monitorable_mfotl
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We summarize the main results proved above.
\begin{enumerate}
\item The term <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> describes semantically the monitor's expected behaviour:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mono_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> mono_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sound_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sound_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] complete_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> complete_monitor<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sliceable_M<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sliceable_M<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\item The executable monitor's online interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">minit_safe</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">mstep</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
  preserves the invariant <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">wf_mstate</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and produces the the verdicts according
  to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] wf_mstate_minit_safe<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wf_mstate_minit_safe<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] wf_mstate_mstep<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> wf_mstate_mstep<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] mstep_mverdicts<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> mstep_mverdicts<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\item The executable monitor's offline interface <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">monitor</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> implements <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">M</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>:
\begin{itemize}
\item <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] monitor_mverdicts<span class="antiquote"><span class="antiquote">}</span></span></span></span>: <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> monitor_mverdicts<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
\end{itemize}
\end{enumerate}
›</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Slicing">
<div class="head">
<h1>Theory Slicing</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Slicing
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Abstract_Monitor">Abstract_Monitor</a> <a href="#MFOTL">MFOTL</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Slicing framework›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This section formalizes the abstract slicing framework and the joint data slicer
  presented in the article~\cite[Sections 4.2 and~4.3]{SchneiderBBKT-STTT20}.›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract slicing›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition 1›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Corresponds to locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span> defined in theory
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Monitor.html"></a><a href="Abstract_Monitor.html">MFOTL_Monitor.Abstract_Monitor</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition 2›</span></span>

<span class="keyword1"><span class="command">locale</span></span> slicer <span class="main">=</span> monitor <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">submonitor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'k</span> <span class="main">::</span> finite <span class="main">⇒</span> <span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> option list<span class="main">)</span> set"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">splitter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   <span class="free">joiner</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> option list<span class="main">)</span> set<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'b</span> option list<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">assumes</span></span> mono_splitter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> <span class="free">splitter</span> <span class="free">π</span> <span class="free">k</span> <span class="main">≤</span> <span class="free">splitter</span> <span class="free">π'</span> <span class="free">k</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span>   correct_slicer<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">joiner</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">submonitor</span> <span class="bound">k</span> <span class="main">(</span><span class="free">splitter</span> <span class="free">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">M</span> <span class="free">π</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> sound_slicer <span class="main">=</span> equalityD1<span class="main">[</span><span class="operator">OF</span> correct_slicer<span class="main">]</span>
<span class="keyword1"><span class="command">lemmas</span></span> complete_slicer <span class="main">=</span> equalityD2<span class="main">[</span><span class="operator">OF</span> correct_slicer<span class="main">]</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> self_slicer <span class="main">=</span> slicer <span class="quoted"><span class="free">nfv</span></span> <span class="quoted"><span class="free">fv</span></span> <span class="quoted"><span class="free">sat</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span>"</span></span> <span class="quoted"><span class="free">splitter</span></span> <span class="quoted"><span class="free">joiner</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">nfv</span> <span class="free">fv</span> <span class="free">sat</span> <span class="free">M</span> <span class="free">splitter</span> <span class="free">joiner</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition 3›</span></span>

<span class="keyword1"><span class="command">locale</span></span> event_separable_splitter <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">event_splitter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">::</span> finite set"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> splitter <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> prefix <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">⇒</span> <span class="tfree">'a</span> prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">π</span> <span class="bound">k</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">D</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="bound">D</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">event_splitter</span> <span class="bound">e</span><span class="main">}</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="bound">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> o_def split_beta<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 1›</span></span>

<span class="keyword1" id="Slicing-mono_splitter"><span class="command">lemma</span></span> mono_splitter<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">π</span> <span class="main">≤</span> <span class="free">π'</span> <span class="main">⟹</span> splitter <span class="free">π</span> <span class="free">k</span> <span class="main">≤</span> splitter <span class="free">π'</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Joint data slicer›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">ok</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">≡</span> wf_tuple <span class="main">(</span>MFOTL.nfv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.fv <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> splitting_strategy <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">φ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">strategy</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option list <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">::</span> finite set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> strategy_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">φ</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">strategy</span> <span class="free">v</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">slice_set</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">slice_set</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">.</span> map the <span class="bound">v'</span> <span class="main">=</span> <span class="bound">v</span> <span class="main">∧</span> ok <span class="free">φ</span> <span class="bound">v'</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">∈</span> <span class="free">strategy</span> <span class="bound">v'</span><span class="main">}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition 4›</span></span>

<span class="keyword1"><span class="command">locale</span></span> MFOTL_monitor <span class="main">=</span>
  monitor <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> MFOTL.sat <span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">φ</span> <span class="free">M</span>

<span class="keyword1"><span class="command">locale</span></span> joint_data_slicer <span class="main">=</span> MFOTL_monitor <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">M</span></span> <span class="main">+</span> splitting_strategy <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">strategy</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">φ</span> <span class="free">M</span> <span class="free">strategy</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">event_splitter</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">event_splitter</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="free">strategy</span> <span class="main">`</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> ok <span class="free">φ</span> <span class="bound">v</span> <span class="main">∧</span> MFOTL.matches <span class="main">(</span>map the <span class="bound">v</span><span class="main">)</span> <span class="free">φ</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> event_separable_splitter <span class="keyword2"><span class="keyword">where</span></span> event_splitter <span class="main">=</span> <span class="quoted">event_splitter</span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">joiner</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">joiner</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">s</span> <span class="bound">k</span> <span class="main">∩</span> <span class="main">(</span>UNIV <span class="main">::</span> nat set<span class="main">)</span> <span class="main">×</span> <span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="bound">v</span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Slicing-splitter_pslice"><span class="command">lemma</span></span> splitter_pslice<span class="main">:</span> <span class="quoted"><span class="quoted">"splitter <span class="free">π</span> <span class="free">k</span> <span class="main">=</span> MFOTL_slicer.pslice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="free">k</span><span class="main">)</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> event_splitter_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 2›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Corresponds to the following theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span>[source] sat_slice_strong<span class="antiquote"><span class="antiquote">}</span></span></span></span> proved in theory
   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Monitor.html"></a><a href="Abstract_Monitor.html">MFOTL_Monitor.Abstract_Monitor</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>:

   <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> sat_slice_strong<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">no_vars</span></span><span class="main"><span class="main">]</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Theorem 1›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> joint_monitor<span class="main">:</span> MFOTL_monitor <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">π</span><span class="main">.</span> joiner <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="bound">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mono wf sound complete<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mono <span class="skolem">π</span> <span class="skolem">π'</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> mono_monitor<span class="main">[</span><span class="operator">OF</span> mono_splitter<span class="main">,</span> <span class="operator">OF</span> mono<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> joiner_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>wf <span class="skolem">i</span> <span class="skolem">v</span> <span class="skolem">π</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> in_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> joiner_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_monitor<span class="main">[</span><span class="operator">OF</span> in_M<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sound <span class="skolem">i</span> <span class="skolem">v</span> <span class="skolem">π</span> <span class="skolem">σ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> in_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>  <span class="keyword2"><span class="keyword">and</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> joiner_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> wf<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">φ</span> <span class="skolem">v</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> sat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">σ</span><span class="main">.</span> prefix_of <span class="main">(</span>splitter <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span> <span class="bound">σ</span> <span class="main">⟹</span> MFOTL.sat <span class="bound">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sound_monitor<span class="main">[</span><span class="operator">OF</span> in_M<span class="main">]</span> wf_monitor<span class="main">[</span><span class="operator">OF</span> in_M<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="skolem">σ</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">σ</span>
    <span class="keyword1"><span class="command">using</span></span> that k
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> sat_slice_iff<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"map the <span class="skolem"><span class="skolem"><span class="skolem">v</span></span></span>"</span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"slice_set <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span>"</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">σ</span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">φ</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def fvi_less_nfv splitter_pslice <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main"><span class="main">]</span></span> prefix_of_pmap_Γ<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> sound<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>complete <span class="skolem">π</span> <span class="skolem">σ</span> <span class="skolem">v</span> <span class="skolem">i</span><span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> strategy_nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="skolem">σ'</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="main">(</span>MFOTL_slicer.pslice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="skolem">k</span><span class="main">)</span> <span class="skolem">π</span><span class="main">)</span> <span class="skolem">σ'</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">σ'</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="skolem">σ'</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="skolem">k</span><span class="main">)</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complete<span class="main">(</span>2<span class="main">)</span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_slice_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="skolem">k</span><span class="main">)</span> <span class="main">(</span>replace_prefix <span class="skolem">π</span> <span class="skolem">σ'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> that complete k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> slice_replace_prefix<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>replace_prefix <span class="skolem">π</span> <span class="skolem">σ'</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> complete<span class="main">(</span>2<span class="main">)</span> k <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_slice_iff<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> complete<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prefix_of_replace_prefix<span class="main"><span class="main">[</span></span><span class="operator">OF</span> that<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> complete<span class="main">(</span>1-3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π'</span></span> <span class="keyword2"><span class="keyword">where</span></span> π'<span class="main">:</span>
    <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π'</span> <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="skolem">k</span><span class="main">)</span> <span class="skolem">σ</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="skolem">π'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> complete_monitor<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> π<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"MFOTL_slicer.pslice <span class="free"><span class="free"><span class="free">φ</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span>slice_set <span class="skolem"><span class="skolem"><span class="skolem">k</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">π</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> splitter_pslice <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_pmap_Γ<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> π'<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">π''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">π'</span> <span class="main">=</span> MFOTL_slicer.pslice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="skolem">k</span><span class="main">)</span> <span class="skolem">π''</span>"</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="skolem">π''</span> <span class="skolem">σ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">atomize_elim</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> prefix_of_map_Γ_D<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> π' k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">π''</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> joiner_def splitter_pslice <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">k</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Corollary 1›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> joint_slicer<span class="main">:</span> slicer <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> MFOTL.sat <span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">π</span><span class="main">.</span> joiner <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="bound">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span><span class="main">.</span> <span class="free">M</span>"</span></span> <span class="quoted">splitter</span> <span class="quoted">joiner</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mono_splitter<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition 5›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Corresponds to locale <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">locale</span></span> sliceable_monitor<span class="antiquote"><span class="antiquote">}</span></span></span></span> defined in theory
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="Abstract_Monitor.html"></a><a href="Abstract_Monitor.html">MFOTL_Monitor.Abstract_Monitor</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> slicable_joint_data_slicer <span class="main">=</span>
  sliceable_monitor <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"relevant_events <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> MFOTL.sat <span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="main">+</span>
  joint_data_slicer <span class="quoted"><span class="free">φ</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted"><span class="free">strategy</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">φ</span> <span class="free">M</span> <span class="free">strategy</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Slicing-monitor_split"><span class="command">lemma</span></span> monitor_split<span class="main">:</span> <span class="quoted"><span class="quoted">"ok <span class="free">φ</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="free">π</span> <span class="free">k</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="free">π</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> splitter_pslice
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sliceable_M<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> wf_tuple_def fvi_less_nfv <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mem_restrI<span class="main"><span class="main">[</span></span><span class="operator">rotated</span> 2<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> y<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="quoted">"map the <span class="free">v</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Theorem 2›</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> self_slicer <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"MFOTL.fv <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span><span class="main">.</span> MFOTL.sat <span class="bound">σ</span> <span class="bound">v</span> <span class="bound">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="free">M</span></span> <span class="quoted">splitter</span> <span class="quoted">joiner</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> mono_splitter<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> sound complete<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>sound <span class="skolem">π</span> <span class="skolem">i</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">φ</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> joint_monitor.wf_monitor<span class="main">[</span><span class="operator">OF</span> sound<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sound <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> joiner_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹ok <span class="free">φ</span> <span class="skolem">v</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monitor_split<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>complete <span class="skolem">π</span> <span class="skolem">i</span> <span class="skolem">v</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">φ</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_monitor<span class="main">[</span><span class="operator">OF</span> complete<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> complete strategy_nonempty <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="skolem">v</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="skolem">π</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> complete <span class="quoted"><span class="quoted">‹ok <span class="free">φ</span> <span class="skolem">v</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> monitor_split<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> k <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> joiner_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Towards Theorem 3›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">names</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> MFOTL.name set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Pred <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∪</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∪</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">names</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∪</span> <span class="free">names</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">gen_unique</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> MFOTL.formula <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Pred <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">(</span>MFOTL.Var <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> False"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Eq <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Neg <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Or <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">∧</span> names <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∩</span> names <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Exists <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Prev <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Next <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Since <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">∧</span> names <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∩</span> names <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">gen_unique</span> <span class="main">(</span>MFOTL.Until <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">β</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∧</span> <span class="free">gen_unique</span> <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">∧</span> names <span class="free"><span class="bound"><span class="entity">α</span></span></span> <span class="main">∩</span> names <span class="free"><span class="bound"><span class="entity">β</span></span></span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Slicing-sat_inter_names_cong"><span class="command">lemma</span></span> sat_inter_names_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> names <span class="free">φ</span> <span class="main">⟹</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">E</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">xs</span><span class="main">.</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">xs</span><span class="main">)</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span>
  MFOTL.sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">E</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟷</span> MFOTL.sat <span class="main">(</span>map_Γ <span class="main">(</span><span class="main">λ</span><span class="bound">D</span><span class="main">.</span> <span class="bound">D</span> <span class="main">∩</span> <span class="free">F</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>

<span class="keyword1" id="Slicing-matches_in_names"><span class="command">lemma</span></span> matches_in_names<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.matches <span class="free">v</span> <span class="free">φ</span> <span class="free">x</span> <span class="main">⟹</span> fst <span class="free">x</span> <span class="main">∈</span> names <span class="free">φ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">φ</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Slicing-unique_names_matches_absorb"><span class="command">lemma</span></span> unique_names_matches_absorb<span class="main">:</span> <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∈</span> names <span class="free">α</span> <span class="main">⟹</span> names <span class="free">α</span> <span class="main">∩</span> names <span class="free">β</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
    MFOTL.matches <span class="free">v</span> <span class="free">α</span> <span class="free">x</span> <span class="main">∨</span> MFOTL.matches <span class="free">v</span> <span class="free">β</span> <span class="free">x</span> <span class="main">⟷</span> MFOTL.matches <span class="free">v</span> <span class="free">α</span> <span class="free">x</span>"</span></span>
  <span class="quoted"><span class="quoted">"fst <span class="free">x</span> <span class="main">∈</span> names <span class="free">β</span> <span class="main">⟹</span> names <span class="free">α</span> <span class="main">∩</span> names <span class="free">β</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span>
    MFOTL.matches <span class="free">v</span> <span class="free">α</span> <span class="free">x</span> <span class="main">∨</span> MFOTL.matches <span class="free">v</span> <span class="free">β</span> <span class="free">x</span> <span class="main">⟷</span> MFOTL.matches <span class="free">v</span> <span class="free">β</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> matches_in_names<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mergeable_envs</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mergeable_envs</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">S</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v1</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">v2</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">A</span> <span class="bound">B</span> <span class="bound">f</span><span class="main">.</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">v1</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">B</span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> <span class="bound">v2</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">v</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">S</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="bound">A</span> <span class="main">∪</span> <span class="bound">B</span><span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Slicing-mergeable_envsI"><span class="command">lemma</span></span> mergeable_envsI<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v1</span> <span class="bound">v2</span> <span class="bound">v</span><span class="main">.</span> <span class="bound">v1</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> <span class="bound">v2</span> <span class="main">∈</span> <span class="free">S</span> <span class="main">⟹</span> length <span class="bound">v</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound"><span class="bound">x</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">v1</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">∨</span> <span class="bound">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">v2</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mergeable_envs <span class="free">n</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mergeable_envs_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mergeable<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="main">(</span>mergeable <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">f</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"tabulate <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∪</span> <span class="skolem">B</span> <span class="keyword1">then</span> <span class="skolem">f</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="skolem">v1</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">0</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">v2</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span><span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Slicing-in_listset_nth"><span class="command">lemma</span></span> in_listset_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> listset <span class="free">As</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">As</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">!</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">As</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">As</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">i</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Slicing-all_nth_in_listset"><span class="command">lemma</span></span> all_nth_in_listset<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">x</span> <span class="main">=</span> length <span class="free">As</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">As</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">As</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> listset <span class="free">As</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">As</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> list_induct2<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def nth_Cons<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Slicing-mergeable_envs_listset"><span class="command">lemma</span></span> mergeable_envs_listset<span class="main">:</span> <span class="quoted"><span class="quoted">"mergeable_envs <span class="main">(</span>length <span class="free">As</span><span class="main">)</span> <span class="main">(</span>listset <span class="free">As</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mergeable_envsI<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> all_nth_in_listset <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> in_listset_nth<span class="main">)</span>

<span class="keyword1" id="Slicing-mergeable_envs_Ex"><span class="command">lemma</span></span> mergeable_envs_Ex<span class="main">:</span> <span class="quoted"><span class="quoted">"mergeable_envs <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> MFOTL.nfv <span class="free">α</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> MFOTL.nfv <span class="free">β</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">α</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">β</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">α</span> <span class="main">∪</span> fv <span class="free">β</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mergeable<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mergeable <span class="skolem">v1</span> <span class="skolem">v2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> order.strict_trans2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fvi_less_nfv<span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator">rule_format</span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span>
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mergeable_envs_def<span class="main"><span class="main">[</span></span><span class="operator">THEN</span> iffD1<span class="main"><span class="main">,</span></span> <span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">v1</span></span> <span class="quoted"><span class="skolem">v2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Slicing-in_set_ConsE"><span class="command">lemma</span></span> in_set_ConsE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">∈</span> set_Cons <span class="free">A</span> <span class="free">As</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">ys</span> <span class="main">∈</span> <span class="free">As</span> <span class="main">⟹</span> <span class="free">P</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_Cons_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Slicing-mergeable_envs_set_Cons"><span class="command">lemma</span></span> mergeable_envs_set_Cons<span class="main">:</span> <span class="quoted"><span class="quoted">"mergeable_envs <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> mergeable_envs <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">(</span>set_Cons UNIV <span class="free">S</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mergeable_envs_def
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">elim</span> in_set_ConsE<span class="main"><span class="keyword3">,</span></span> <span class="operator">goal_cases</span> mergeable<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>mergeable <span class="skolem">v1</span> <span class="skolem">v2</span> <span class="skolem">A</span> <span class="skolem">B</span> <span class="skolem">f</span> <span class="skolem">y1</span> <span class="skolem">ys1</span> <span class="skolem">y2</span> <span class="skolem">ys2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="skolem">B</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> mergeable<span class="main">(</span>4-9<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v</span> <span class="main">∈</span> <span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span><span class="main">.</span> <span class="bound">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mergeable<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mergeable<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">rule_format</span><span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem">ys1</span></span> <span class="quoted"><span class="skolem">ys2</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?A</span> <span class="main">∪</span> <span class="var">?B</span><span class="main">.</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="main">(</span>Suc <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">f</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">v</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_Cons' set_Cons_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Slicing-slice_Exists"><span class="command">lemma</span></span> slice_Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL_slicer.slice <span class="main">(</span>MFOTL.Exists <span class="free">φ</span><span class="main">)</span> <span class="free">S</span> <span class="free">σ</span> <span class="main">=</span> MFOTL_slicer.slice <span class="free">φ</span> <span class="main">(</span>set_Cons UNIV <span class="free">S</span><span class="main">)</span> <span class="free">σ</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> map_Γ_cong<span class="main">)</span>

<span class="keyword1" id="Slicing-image_Suc_fvi"><span class="command">lemma</span></span> image_Suc_fvi<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">`</span> MFOTL.fvi <span class="main">(</span>Suc <span class="free">b</span><span class="main">)</span> <span class="free">φ</span> <span class="main">=</span> MFOTL.fvi <span class="free">b</span> <span class="free">φ</span> <span class="main">-</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> image_def Bex_def MFOTL.fvi_Suc <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> gr0_implies_Suc<span class="main">)</span>

<span class="keyword1" id="Slicing-nfv_Exists"><span class="command">lemma</span></span> nfv_Exists<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.nfv <span class="main">(</span>MFOTL.Exists <span class="free">φ</span><span class="main">)</span> <span class="main">=</span> MFOTL.nfv <span class="free">φ</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.nfv_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"fv <span class="free">φ</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> image_Suc_fvi mono_Max_commute<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mono_def<span class="main">)</span>

<span class="keyword1" id="Slicing-set_Cons_empty_iff"><span class="command">lemma</span></span> set_Cons_empty_iff<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set_Cons <span class="free">A</span> <span class="free">Xs</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟷</span> <span class="free">A</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="free">Xs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> set_Cons_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Slicing-unique_sat_slice_mem"><span class="command">lemma</span></span> unique_sat_slice_mem<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> gen_unique <span class="free">φ</span> <span class="main">⟹</span> <span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  mergeable_envs <span class="free">n</span> <span class="free">S</span> <span class="main">⟹</span> MFOTL.nfv <span class="free">φ</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span>
  MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="free">S</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="free">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">S</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> safe_formula_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t2</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFOTL.is_Const_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">t1</span> <span class="skolem">t2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">t1</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFOTL.is_Const_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">x</span> <span class="skolem">y</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">e</span> <span class="skolem">ts</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> MFOTL.eval_trm <span class="skolem">v'</span> <span class="bound">t</span> <span class="main">=</span> MFOTL.eval_trm <span class="skolem">v</span> <span class="bound">t</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span>set <span class="skolem">ts</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="bound">t</span><span class="main">.</span> <span class="skolem">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> set <span class="skolem">ts</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> eq <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.eval_trm <span class="skolem">v'</span> <span class="skolem">t</span> <span class="main">=</span> MFOTL.eval_trm <span class="skolem">v</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv_trm <span class="skolem">t</span><span class="main">.</span> <span class="skolem">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> <span class="skolem">S</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>6 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">φ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.And <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">ψ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">ψ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 6<span class="main">(</span>1<span class="main">,</span>4-<span class="main">)</span> 6<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mergeable_envs_Ex<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>7 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.And_Not <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">φ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_Not_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 7<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>5-<span class="main">)</span> 7<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">S</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> MFOTL.And_Not_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fv <span class="skolem">ψ</span> <span class="main">⊆</span> fv <span class="skolem">φ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> MFOTL.fvi_And_Not<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>8 <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">φ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Or <span class="skolem">φ</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">ψ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">ψ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">i</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">with</span></span> 8<span class="main">(</span>1<span class="main">,</span>4-<span class="main">)</span> 8<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> S<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">S</span></span></span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹fv <span class="skolem">ψ</span> <span class="main">=</span> fv <span class="skolem">φ</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹fv <span class="skolem">ψ</span> <span class="main">=</span> fv <span class="skolem">φ</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>9 <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> sat_φ<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Exists <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted">"9.prems"</span> sat_φ <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span>set_Cons UNIV <span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">φ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">#</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> slice_Exists
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> <span class="quoted">"9.IH"</span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nfv_Exists <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> mergeable_envs_set_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> set_Cons_def fvi_Suc Ball_def nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>10 <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">φ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 10 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>11 <span class="skolem">I</span> <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">φ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> 11 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>12 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">ψ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 12 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Since <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 12 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>13 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.Since <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Since <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">ψ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 13 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Since <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 13 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fv <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>14 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">ψ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 14 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Until <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 14 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fv <span class="skolem">φ</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>15 <span class="skolem">φ</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹gen_unique <span class="main">(</span>MFOTL.Until <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span>›</span></span>
  <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Until <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span> <span class="main">=</span> MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="skolem">ψ</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">j</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> unique_names_matches_absorb <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> sat_inter_names_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 15 <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="main">(</span>MFOTL.Until <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">I</span> <span class="skolem">ψ</span><span class="main">)</span> <span class="skolem">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">j</span> <span class="skolem">ψ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> 15 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">v'</span><span class="main">∈</span><span class="skolem">S</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="skolem">ψ</span><span class="main">.</span> <span class="bound">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹fv <span class="main">(</span>MFOTL.Neg <span class="skolem">φ</span><span class="main">)</span> <span class="main">⊆</span> fv <span class="skolem">ψ</span>›</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Slicing-unique_sat_slice"><span class="command">lemma</span></span> unique_sat_slice<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> formula<span class="main">:</span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"gen_unique <span class="free">φ</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> restr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"mergeable_envs <span class="main">(</span>MFOTL.nfv <span class="free">φ</span><span class="main">)</span> <span class="free">S</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> sat_slice<span class="main">:</span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="free">S</span> <span class="free">σ</span><span class="main">)</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="free">σ</span> <span class="free">v</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">S</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> fv_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span>fv <span class="free">φ</span><span class="main">.</span> <span class="skolem">v'</span> <span class="main">!</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">v</span> <span class="main">!</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> unique_sat_slice_mem<span class="main">[</span><span class="operator">OF</span> formula restr order_refl sat_slice<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">with</span></span> sat_slice <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="free">S</span> <span class="free">σ</span><span class="main">)</span> <span class="skolem">v'</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> sat_fvi_cong<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"MFOTL.sat <span class="free">σ</span> <span class="skolem">v'</span> <span class="free">i</span> <span class="free">φ</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sat_slice_iff<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹<span class="skolem">v'</span> <span class="main">∈</span> <span class="free">S</span>›</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> fv_eq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">iff</span><span class="main"><span class="main">:</span></span> sat_fvi_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Lemma 3›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> splitting_strategy<span class="main">)</span> unique_sat_strategy<span class="main">:</span>
  <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span> <span class="main">⟹</span> gen_unique <span class="free">φ</span> <span class="main">⟹</span> slice_set <span class="free">k</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  mergeable_envs <span class="main">(</span>MFOTL.nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>slice_set <span class="free">k</span><span class="main">)</span> <span class="main">⟹</span>
  MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="free">k</span><span class="main">)</span> <span class="free">σ</span><span class="main">)</span> <span class="main">(</span>map the <span class="free">v</span><span class="main">)</span> <span class="free">i</span> <span class="free">φ</span> <span class="main">⟹</span>
  ok <span class="free">φ</span> <span class="free">v</span> <span class="main">⟹</span> <span class="free">k</span> <span class="main">∈</span> <span class="free">strategy</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> unique_sat_slice_mem<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> wf_tuple_cong<span class="main">)</span>

<span class="keyword1"><span class="command">locale</span></span> skip_inter <span class="main">=</span> joint_data_slicer <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"slice_set <span class="free">k</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> mergeable<span class="main">:</span> <span class="quoted"><span class="quoted">"mergeable_envs <span class="main">(</span>MFOTL.nfv <span class="free">φ</span><span class="main">)</span> <span class="main">(</span>slice_set <span class="free">k</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Definition of J'›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">skip_joiner</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">s</span><span class="main">.</span> <span class="main">⋃</span><span class="bound">k</span><span class="main">.</span> <span class="bound">s</span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Theorem 3›</span></span>

<span class="keyword1" id="Slicing-skip_joiner"><span class="command">lemma</span></span> skip_joiner<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"safe_formula <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"gen_unique <span class="free">φ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"joiner <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="free">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> skip_joiner <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="free">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?L</span> <span class="main">=</span> <span class="var">?R</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">safe</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">v</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?R</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="keyword2"><span class="keyword">where</span></span> in_M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="free">π</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> skip_joiner_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">from</span></span> ex_prefix_of <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">σ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"prefix_of <span class="free">π</span> <span class="skolem">σ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">with</span></span> wf_monitor<span class="main">[</span><span class="operator">OF</span> in_M<span class="main">]</span> sound_monitor<span class="main">[</span><span class="operator">OF</span> in_M<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span>
    <span class="quoted"><span class="quoted">"MFOTL.sat <span class="main">(</span>MFOTL_slicer.slice <span class="free">φ</span> <span class="main">(</span>slice_set <span class="skolem">k</span><span class="main">)</span> <span class="skolem">σ</span><span class="main">)</span> <span class="main">(</span>map the <span class="skolem">v</span><span class="main">)</span> <span class="skolem">i</span> <span class="free">φ</span>"</span></span> <span class="quoted"><span class="quoted">"ok <span class="free">φ</span> <span class="skolem">v</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> splitter_pslice <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> prefix_of_pmap_Γ<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> unique_sat_strategy<span class="main">[</span><span class="operator">OF</span> assms nonempty mergeable this<span class="main">]</span>
  <span class="keyword1"><span class="command">with</span></span> in_M <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?L</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> joiner_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> joiner_def skip_joiner_def<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> skip_joint_monitor<span class="main">:</span> MFOTL_monitor <span class="quoted"><span class="free">φ</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">π</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> safe_formula <span class="free">φ</span> <span class="main">∧</span> gen_unique <span class="free">φ</span> <span class="keyword1">then</span> skip_joiner <span class="keyword1">else</span> joiner<span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="free">M</span> <span class="main">(</span>splitter <span class="bound">π</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> joint_monitor.mono_monitor joint_monitor.wf_monitor joint_monitor.sound_monitor joint_monitor.complete_monitor
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> skip_joiner<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Monitor_Code">
<div class="head">
<h1>Theory Monitor_Code</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Monitor_Code
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Monitor">Monitor</a>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Code_Target_Nat.html">HOL-Library.Code_Target_Nat</a>"</span>
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/String.html">HOL.String</a>"</span>
    <a href="../../containers/theories/#Containers">Containers.Containers</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">derive</span></span> ccompare <span class="quoted">MFOTL.trm</span>
<span class="keyword1"><span class="command">derive</span></span> <span class="main">(</span>eq<span class="main">)</span> ceq <span class="quoted">MFOTL.trm</span>
<span class="keyword1"><span class="command">derive</span></span> <span class="main">(</span>rbt<span class="main">)</span> set_impl <span class="quoted">MFOTL.trm</span>

<span class="keyword1" id="Monitor_Code-image_these"><span class="command">lemma</span></span> image_these<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> Option.these <span class="free">X</span> <span class="main">=</span> Option.these <span class="main">(</span>map_option <span class="free">f</span> <span class="main">`</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> in_these_eq Bex_def image_iff map_option_case <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1" id="Monitor_Code-meval_MPred"><span class="command">lemma</span></span> meval_MPred<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="free">n</span> <span class="free">t</span> <span class="free">db</span> <span class="main">(</span>MPred <span class="free">e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span>Option.these
  <span class="main">(</span><span class="main">(</span>map_option <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span> <span class="keyword1">o</span> match <span class="free">ts</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">db</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">e'</span> <span class="keyword1">then</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> MPred <span class="free">e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> meval.simps image_these image_image o_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Monitor_Code-meval_MPred'"><span class="command">lemma</span></span> meval_MPred'<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="free">n</span> <span class="free">t</span> <span class="free">db</span> <span class="main">(</span>MPred <span class="free">e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span>Option.these
  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">db</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">e'</span> <span class="keyword1">then</span> <span class="main">{</span>map_option <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>match <span class="free">ts</span> <span class="bound">x</span><span class="main">)</span><span class="main">}</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> MPred <span class="free">e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> meval_MPred image_UN split_beta if_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"image <span class="main">_</span>"</span></span><span class="main">]</span> image_insert image_empty o_apply
  <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="Monitor_Code-these_UNION"><span class="command">lemma</span></span> these_UNION<span class="main">:</span> <span class="quoted"><span class="quoted">"Option.these <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="free">B</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span> <span class="main">(</span><span class="main">(</span>Option.these <span class="keyword1">o</span> <span class="free">B</span><span class="main">)</span> <span class="main">`</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def<span class="main">)</span>

<span class="keyword1" id="Monitor_Code-meval_MPred''"><span class="command">lemma</span></span> meval_MPred''<span class="main">:</span> <span class="quoted"><span class="quoted">"meval <span class="free">n</span> <span class="free">t</span> <span class="free">db</span> <span class="main">(</span>MPred <span class="free">e</span> <span class="free">ts</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">[</span>
  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">db</span><span class="main">.</span> <span class="keyword1">if</span> <span class="free">e</span> <span class="main">=</span> <span class="bound">e'</span> <span class="keyword1">then</span> set_option <span class="main">(</span>map_option <span class="main">(</span><span class="main">λ</span><span class="bound">f</span><span class="main">.</span> tabulate <span class="bound">f</span> <span class="main">0</span> <span class="free">n</span><span class="main">)</span> <span class="main">(</span>match <span class="free">ts</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">{}</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> MPred <span class="free">e</span> <span class="free">ts</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> meval_MPred' these_UNION o_def prod.case_distrib<span class="main">[</span><span class="operator">of</span> <span class="quoted">Option.these</span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Option.these_def map_option_case image_iff <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemmas</span></span> meval_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span> <span class="main">=</span> meval.simps<span class="main">(</span>1<span class="main">)</span> meval_MPred'' meval.simps<span class="main">(</span>3-9<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">db_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>char list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> list <span class="main">⇒</span> <span class="main">(</span>char list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">db_code</span> <span class="main">=</span> set"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">verdict_code</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> <span class="tfree">'a</span> <span class="main">::</span> ccompare option list<span class="main">)</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">verdict_code</span> <span class="main">=</span> RBT_Set2.keys"</span></span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">HOL.equal</span></span> <span class="quoted"><span class="quoted">Collection_Eq.ceq</span></span> <span class="quoted"><span class="quoted">Collection_Order.ccompare</span></span> <span class="quoted"><span class="quoted">Eq</span></span> <span class="quoted"><span class="quoted">Lt</span></span> <span class="quoted"><span class="quoted">Gt</span></span> <span class="quoted"><span class="quoted">set_RBT</span></span> <span class="quoted"><span class="quoted">set_impl</span></span> <span class="quoted"><span class="quoted">phantom</span></span>
  <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">integer_of_nat</span></span> <span class="quoted"><span class="quoted">enat</span></span> <span class="quoted"><span class="quoted">literal.explode</span></span> <span class="quoted"><span class="quoted">db_code</span></span> <span class="quoted"><span class="quoted">set</span></span> <span class="quoted"><span class="quoted">interval</span></span> <span class="quoted"><span class="quoted">RBT_set</span></span> <span class="quoted"><span class="quoted">verdict_code</span></span>
  <span class="quoted"><span class="quoted">MFOTL.Var</span></span> <span class="quoted"><span class="quoted">MFOTL.Const</span></span>
  <span class="quoted"><span class="quoted">MFOTL.Pred</span></span> <span class="quoted"><span class="quoted">MFOTL.Eq</span></span> <span class="quoted"><span class="quoted">MFOTL.Neg</span></span> <span class="quoted"><span class="quoted">MFOTL.Or</span></span> <span class="quoted"><span class="quoted">MFOTL.Exists</span></span>
  <span class="quoted"><span class="quoted">MFOTL.Prev</span></span> <span class="quoted"><span class="quoted">MFOTL.Next</span></span> <span class="quoted"><span class="quoted">MFOTL.Since</span></span> <span class="quoted"><span class="quoted">MFOTL.Until</span></span>
  <span class="keyword2"><span class="keyword">checking</span></span> OCaml<span class="main">?</span>

<span class="keyword1"><span class="command">export_code</span></span> <span class="quoted"><span class="quoted">HOL.equal</span></span> <span class="quoted"><span class="quoted">Collection_Eq.ceq</span></span> <span class="quoted"><span class="quoted">Collection_Order.ccompare</span></span> <span class="quoted"><span class="quoted">Eq</span></span> <span class="quoted"><span class="quoted">Lt</span></span> <span class="quoted"><span class="quoted">Gt</span></span> <span class="quoted"><span class="quoted">set_RBT</span></span> <span class="quoted"><span class="quoted">set_impl</span></span> <span class="quoted"><span class="quoted">phantom</span></span>
  <span class="quoted"><span class="quoted">nat_of_integer</span></span> <span class="quoted"><span class="quoted">integer_of_nat</span></span> <span class="quoted"><span class="quoted">enat</span></span> <span class="quoted"><span class="quoted">literal.explode</span></span> <span class="quoted"><span class="quoted">db_code</span></span> <span class="quoted"><span class="quoted">set</span></span> <span class="quoted"><span class="quoted">interval</span></span> <span class="quoted"><span class="quoted">RBT_set</span></span> <span class="quoted"><span class="quoted">verdict_code</span></span>
  <span class="quoted"><span class="quoted">MFOTL.Var</span></span> <span class="quoted"><span class="quoted">MFOTL.Const</span></span>
  <span class="quoted"><span class="quoted">MFOTL.Pred</span></span> <span class="quoted"><span class="quoted">MFOTL.Eq</span></span> <span class="quoted"><span class="quoted">MFOTL.Neg</span></span> <span class="quoted"><span class="quoted">MFOTL.Or</span></span> <span class="quoted"><span class="quoted">MFOTL.Exists</span></span>
  <span class="quoted"><span class="quoted">MFOTL.Prev</span></span> <span class="quoted"><span class="quoted">MFOTL.Next</span></span> <span class="quoted"><span class="quoted">MFOTL.Since</span></span> <span class="quoted"><span class="quoted">MFOTL.Until</span></span>
  <span class="quoted"><span class="quoted">minit_safe</span></span> <span class="quoted"><span class="quoted">mstep</span></span> <span class="keyword2"><span class="keyword">in</span></span> OCaml <span class="keyword2"><span class="keyword">module_name</span></span> Monitor <span class="keyword2"><span class="keyword">file_prefix</span></span> <span class="quoted">"verified"</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div><div id="Examples">
<div class="head">
<h1>Theory Examples</h1>
</div>
<pre class="source"><span class="comment1">(*&lt;*)</span>
<span class="keyword1"><span class="command">theory</span></span> Examples
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Monitor_Code">Monitor_Code</a>
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="comment1">(*&gt;*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Examples›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">TT</span> <span class="main">≡</span> MFOTL.Eq <span class="main">(</span>MFOTL.Const <span class="inner_quoted">''_''</span><span class="main">)</span> <span class="main">(</span>MFOTL.Const <span class="inner_quoted">''_''</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">Eventually</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span> <span class="main">≡</span> MFOTL.Until TT <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">ψ</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">φ<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub></span> <span class="main">=</span> MFOTL.And_Not <span class="main">(</span>MFOTL.Pred <span class="inner_quoted">''A''</span> <span class="main">[</span>MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span>
  <span class="main">(</span>Eventually <span class="main">(</span>interval <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>MFOTL.Exists <span class="main">(</span>MFOTL.Pred <span class="inner_quoted">''B''</span> <span class="main">[</span>MFOTL.Var <span class="main">1</span><span class="main">,</span> MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mmonitorable φ<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Offline monitoring:›</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> π<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub> <span class="main">::</span> <span class="quoted"><span class="quoted">"string MFOTL.prefix"</span></span> <span class="keyword2"><span class="keyword">is</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">[</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="inner_quoted">''A''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''d''</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''A''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''e''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span>
   <span class="main">,</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="inner_quoted">''B''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''d''</span><span class="main">,</span> <span class="inner_quoted">''f''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span>
   <span class="main">,</span> <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="inner_quoted">''B''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''e''</span><span class="main">,</span> <span class="inner_quoted">''f''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="numeral">5</span><span class="main">)</span>
  <span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"monitor φ<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub> π<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>Some <span class="inner_quoted">''e''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Online monitoring:›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m1</span> <span class="main">=</span> mstep <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="inner_quoted">''A''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''d''</span><span class="main">]</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="inner_quoted">''A''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''e''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>minit φ<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m2</span> <span class="main">=</span> mstep <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="inner_quoted">''B''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''d''</span><span class="main">,</span> <span class="inner_quoted">''f''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>snd m1<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">m3</span> <span class="main">=</span> mstep <span class="main">(</span><span class="main">{</span><span class="main">(</span><span class="inner_quoted">''B''</span><span class="main">,</span> <span class="main">[</span><span class="inner_quoted">''e''</span><span class="main">,</span> <span class="inner_quoted">''f''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span><span class="main">,</span> <span class="numeral">5</span><span class="main">)</span> <span class="main">(</span>snd m2<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"fst m1 <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"fst m2 <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"fst m3 <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>Some <span class="inner_quoted">''e''</span><span class="main">]</span><span class="main">)</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Operation of the monitor:›</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"minit φ<span class="hidden">⇩</span><sub>e</sub><span class="hidden">⇩</span><sub>x</sub> <span class="main">=</span> <span class="main">⦇</span>
  mstate_i <span class="main">=</span> <span class="main">0</span><span class="main">,</span>
  mstate_m <span class="main">=</span>
    MAnd <span class="main">(</span>MPred <span class="inner_quoted">''A''</span> <span class="main">[</span>MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span> False
     <span class="main">(</span>MUntil True <span class="main">(</span>MRel <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>interval <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>MExists <span class="main">(</span>MPred <span class="inner_quoted">''B''</span> <span class="main">[</span>MFOTL.Var <span class="main">1</span><span class="main">,</span> MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
       <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[]</span><span class="main">)</span>
     <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">,</span>
  mstate_n <span class="main">=</span> <span class="main">1</span><span class="main">⦈</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mstate_m <span class="main">(</span>snd m1<span class="main">)</span> <span class="main">=</span> MAnd <span class="main">(</span>MPred <span class="inner_quoted">''A''</span> <span class="main">[</span>MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span> False
  <span class="main">(</span>MUntil True <span class="main">(</span>MRel <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>interval <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>MExists <span class="main">(</span>MPred <span class="inner_quoted">''B''</span> <span class="main">[</span>MFOTL.Var <span class="main">1</span><span class="main">,</span> MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="main">(</span><span class="main">[</span><span class="main">{</span><span class="main">[</span>Some <span class="inner_quoted">''d''</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="inner_quoted">''e''</span><span class="main">]</span><span class="main">}</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mstate_m <span class="main">(</span>snd m2<span class="main">)</span> <span class="main">=</span> MAnd <span class="main">(</span>MPred <span class="inner_quoted">''A''</span> <span class="main">[</span>MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span> False
  <span class="main">(</span>MUntil True <span class="main">(</span>MRel <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>interval <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>MExists <span class="main">(</span>MPred <span class="inner_quoted">''B''</span> <span class="main">[</span>MFOTL.Var <span class="main">1</span><span class="main">,</span> MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
   <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[</span><span class="main">(</span><span class="main">1</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Some <span class="inner_quoted">''d''</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="numeral">2</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="main">(</span><span class="main">[</span><span class="main">{</span><span class="main">[</span>Some <span class="inner_quoted">''d''</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="inner_quoted">''e''</span><span class="main">]</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"mstate_m <span class="main">(</span>snd m3<span class="main">)</span> <span class="main">=</span> MAnd <span class="main">(</span>MPred <span class="inner_quoted">''A''</span> <span class="main">[</span>MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span> False
  <span class="main">(</span>MUntil True <span class="main">(</span>MRel <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">)</span> <span class="main">(</span>interval <span class="main">1</span> <span class="numeral">2</span><span class="main">)</span> <span class="main">(</span>MExists <span class="main">(</span>MPred <span class="inner_quoted">''B''</span> <span class="main">[</span>MFOTL.Var <span class="main">1</span><span class="main">,</span> MFOTL.Var <span class="main">0</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span> <span class="main">[]</span> <span class="main">[</span><span class="main">(</span><span class="numeral">5</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>None<span class="main">]</span><span class="main">}</span><span class="main">,</span> <span class="main">{}</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
  <span class="main">(</span><span class="main">[</span><span class="main">{}</span><span class="main">]</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>

<span class="comment1">(*&lt;*)</span>
<span class="keyword2"><span class="keyword">end</span></span>
<span class="comment1">(*&gt;*)</span>
</pre>
</div>