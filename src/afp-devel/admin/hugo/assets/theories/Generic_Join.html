<div id="Generic_Join">
<div class="head">
<h1>Theory Generic_Join</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹The algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Generic_Join
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="../MFOTL_Monitor/Table.html">MFOTL_Monitor.Table</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> atable <span class="main">=</span> <span class="quoted"><span class="quoted">"nat set <span class="main">×</span> <span class="tfree">'a</span> table"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> query <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atable set"</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> vertices <span class="main">=</span> <span class="quoted"><span class="quoted">"nat set"</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Generic algorithm›</span></span>

<span class="keyword1"><span class="command">locale</span></span> getIJ <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">getIJ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> vertices <span class="main">⇒</span> vertices <span class="main">×</span> vertices"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> coreProperties<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="main">⟹</span> <span class="free">getIJ</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span> <span class="main">=</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">⟹</span>
    card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generic_Join-getIJProperties"><span class="command">lemma</span></span> getIJProperties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coreProperties<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">Q_pos</span></span> <span class="quoted"><span class="free">Q_neg</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">≤</span> card <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> coreProperties<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">Q_pos</span></span> <span class="quoted"><span class="free">Q_neg</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">J</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Int_ac<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> One_nat_def Suc_le_lessD assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff card_seteq dual_order.trans getIJ.coreProperties getIJ_axioms leI
        le_iff_inf one_le_numeral sup_ge1 sup_ge2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">&lt;</span> card <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff card_seteq
        getIJ.coreProperties getIJ_axioms leI le_0_eq le_iff_inf nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> sup_ge1 sup_ge2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> getIJ.coreProperties getIJ_axioms<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> getIJ_axioms getIJ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">projectTable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> atable <span class="main">⇒</span> <span class="tfree">'a</span> atable"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">projectTable</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">,</span> Set.image <span class="main">(</span>restrict <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filterQuery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterQuery</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="main">(</span><span class="bound">s</span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">filterQueryNeg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">filterQueryNeg</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">projectQuery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">projectQuery</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Set.image <span class="main">(</span>projectTable <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">isSameIntersection</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple <span class="main">⇒</span> nat set <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">isSameIntersection</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">!</span><span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">semiJoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> atable <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> atable"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">semiJoin</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tab</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tup</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">,</span> Set.filter <span class="main">(</span>isSameIntersection <span class="free"><span class="bound"><span class="entity">tup</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tab</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">newQuery</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> tuple<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">newQuery</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">=</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> projectTable <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">(</span>semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge_option</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> option <span class="main">×</span> <span class="tfree">'a</span> option <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>None<span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>None<span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">merge_option</span> <span class="main">(</span>Some <span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Some <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">=</span> Some <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>
<span class="comment1">(* Last case shouldn't happen but useful for proof *)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">merge</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple <span class="main">⇒</span> <span class="tfree">'a</span> tuple"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">merge</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> map merge_option <span class="main">(</span>zip <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="main">(</span>sequential<span class="main">)</span> <span class="entity">genericJoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">genericJoin</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> card <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="bound">I</span> <span class="main">(</span>filterQuery <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="bound">I</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> <span class="free">genericJoin</span> <span class="bound">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="bound">J</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="free">genericJoin</span> <span class="bound">J</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_pos</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_neg</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">termination</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">V</span><span class="main">,</span> <span class="bound">Q_pos</span><span class="main">,</span> <span class="bound">Q_neg</span><span class="main">)</span><span class="main">.</span> card <span class="bound">V</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> getIJProperties<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">wrapperGenericJoin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wrapperGenericJoin</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">.</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">{}</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> Set.is_empty <span class="bound">Q</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="keyword1">in</span>
        genericJoin <span class="bound">V</span> <span class="bound">Q</span> <span class="bound">Qn</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹An instantation›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">score</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">score</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">relevant</span> <span class="main">=</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> card <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">sign</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> <span class="bound">sign</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="bound">relevant</span> <span class="keyword1">in</span>
    foldl <span class="main">(+)</span> <span class="main">0</span> <span class="bound">l</span>
<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">arg_max_list</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">arg_max_list</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> Max <span class="main">(</span>set <span class="main">(</span>map <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span> arg_min_list <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="bound">m</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Generic_Join-arg_max_list_element"><span class="command">lemma</span></span> arg_max_list_element<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">l</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"arg_max_list <span class="free">f</span> <span class="free">l</span> <span class="main">∈</span> set <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def arg_max_list.simps arg_min_list_in assms le_imp_less_Suc less_irrefl list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">max_getIJ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> vertices <span class="main">⇒</span> vertices <span class="main">×</span> vertices"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">max_getIJ</span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">=</span> <span class="main">(</span>
  <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="keyword1">in</span>
  <span class="keyword1">if</span> Set.is_empty <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="keyword1">then</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span>
  <span class="keyword1">else</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Generic_Join-max_getIJ_coreProperties"><span class="command">lemma</span></span> max_getIJ_coreProperties<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> max_getIJ <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span> <span class="main">∧</span> <span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> card.infinite <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> sorted_list_of_set <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">l</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_1 Suc_le_lessD <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> distinct_card
        distinct_sorted_list_of_set less_imp_le set_sorted_list_of_set<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="free">Q_neg</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_pos</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> length <span class="skolem">l</span>›</span></span> arg_max_list_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> l_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">,</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span>  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="free">V</span> <span class="keyword1">in</span>
    <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_pos</span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_def x_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Pair_inject <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_neg</span><span class="main">)</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span>set <span class="skolem">l</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> length <span class="skolem">l</span>›</span></span> arg_max_list_element <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> l_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="skolem">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> sorted_list_of_set <span class="free">V</span> <span class="keyword1">in</span>
  <span class="keyword1">let</span> <span class="bound">x</span> <span class="main">=</span> arg_max_list <span class="main">(</span>score <span class="free">Q_neg</span><span class="main">)</span> <span class="bound">l</span> <span class="keyword1">in</span> <span class="main">(</span><span class="free">V</span> <span class="main">-</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> l_def x_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Pair_inject <span class="quoted"><span class="quoted">‹finite <span class="free">V</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> New_max<span class="main">:</span> getIJ <span class="quoted">max_getIJ</span>
  <span class="keyword2"><span class="keyword">defines</span></span> New_max_getIJ_genericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"New_max.genericJoin"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> New_max_getIJ_wrapperGenericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"New_max.wrapperGenericJoin"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> max_getIJ_coreProperties<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Generic_Join_Correctness">
<div class="head">
<h1>Theory Generic_Join_Correctness</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Well-formed queries›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Generic_Join_Correctness
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Generic_Join.html">Generic_Join</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> vertices <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_set</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">.</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_atable</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> atable <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_atable</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">⟷</span> table <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span> <span class="main">∧</span> finite <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">wf_query</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">wf_query</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">Q_neg</span></span></span><span class="main">)</span><span class="main">.</span> wf_atable <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>wf_set <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>card <span class="free"><span class="bound"><span class="entity">Q_pos</span></span></span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">included</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">included</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">covering</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">covering</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">non_empty_query</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">non_empty_query</span> <span class="free"><span class="bound"><span class="entity">Q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">Q</span></span></span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rwf_query</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> vertices <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> <span class="tfree">'a</span> query <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">rwf_query</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Qp</span></span></span> <span class="free"><span class="bound"><span class="entity">Qn</span></span></span> <span class="main">⟷</span> wf_query <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Qp</span></span></span> <span class="free"><span class="bound"><span class="entity">Qn</span></span></span> <span class="main">∧</span> covering <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Qp</span></span></span> <span class="main">∧</span> included <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Qp</span></span></span> <span class="main">∧</span> included <span class="free"><span class="bound"><span class="entity">V</span></span></span> <span class="free"><span class="bound"><span class="entity">Qn</span></span></span>
                         <span class="main">∧</span> non_empty_query <span class="free"><span class="bound"><span class="entity">Qp</span></span></span> <span class="main">∧</span> non_empty_query <span class="free"><span class="bound"><span class="entity">Qn</span></span></span>"</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_tuple_empty"><span class="command">lemma</span></span> wf_tuple_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">{}</span> <span class="free">v</span> <span class="main">⟷</span> <span class="free">v</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> replicate_eqI <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_def in_set_conv_nth<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-table_empty"><span class="command">lemma</span></span> table_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="main">{}</span> <span class="free">X</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">X</span> <span class="main">=</span> empty_table <span class="main">∨</span> <span class="free">X</span> <span class="main">=</span> unit_table <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_tuple_empty unit_table_def table_def<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> getIJ <span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Generic_Join_Correctness-isSame_equi_dev"><span class="command">lemma</span></span> isSame_equi_dev<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">B</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">⊆</span> <span class="free">B</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"isSameIntersection <span class="free">t1</span> <span class="free">s</span> <span class="free">t2</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span> <span class="main">=</span> restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="free">t1</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">t2</span><span class="main">!</span><span class="bound">i</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span> <span class="main">=</span> restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟷</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⟹</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">s</span> <span class="main">⟹</span> <span class="free">t1</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">t2</span><span class="main">!</span><span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">s</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">t2</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">s</span>›</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">s</span> <span class="free">t1</span> <span class="main">=</span> restrict <span class="free">s</span> <span class="free">t2</span>›</span></span>
              assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_restrict nth_restrict wf_tuple_length<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⟹</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> length_restrict wf_tuple_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">s</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="free">t1</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">t2</span> <span class="main">!</span> <span class="bound">i</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span>
                <span class="quoted"><span class="quoted">‹length <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> length_restrict nth_restrict<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> hide_lams<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> wf_tuple_def
                wf_tuple_restrict_simple<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t1</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>restrict <span class="free">s</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> nth_equalityI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_getIJ"><span class="command">lemma</span></span> wf_getIJ<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">I</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">J</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff coreProperties<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_projectTable"><span class="command">lemma</span></span> wf_projectTable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="main">(</span>projectTable <span class="free">I</span> <span class="free">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span>fst <span class="main">(</span>projectTable <span class="free">I</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="free">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> projectTable <span class="free">I</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sX</span></span> <span class="skolem"><span class="skolem">tX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sX</span><span class="main">,</span> <span class="skolem">tX</span><span class="main">)</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∩</span> <span class="skolem">sX</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sY</span></span> <span class="skolem"><span class="skolem">tY</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sY</span><span class="main">,</span> <span class="skolem">tY</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sY</span> <span class="main">=</span> <span class="skolem">S</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> projectTable <span class="free">I</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">tY</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="skolem">S</span> <span class="bound">t</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">tY</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">tX</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">sY</span><span class="main">,</span> <span class="skolem">tY</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">tY</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> projectTable <span class="free">I</span> <span class="free">X</span>›</span></span> calculation<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">sX</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">sX</span> <span class="skolem">tX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> wf_atable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">tX</span>›</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">S</span> <span class="skolem">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="skolem">x</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> wf_tuple_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>      
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span> <span class="main">∈</span> <span class="skolem">tY</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="skolem">S</span> <span class="bound">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">S</span> <span class="skolem">tY</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">sY</span><span class="main">,</span> <span class="skolem">tY</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> projectTable <span class="free">I</span> <span class="free">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">sY</span> <span class="main">=</span> <span class="skolem">S</span>›</span></span> assms calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> finite_Int fst_conv inf_commute snd_conv wf_atable_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-set_filterQuery"><span class="command">lemma</span></span> set_filterQuery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQ</span> <span class="main">=</span> filterQuery <span class="free">I</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟷</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">QQ</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> <span class="main">(</span>card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟷</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">QQ</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>fst <span class="skolem">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟹</span> <span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>fst <span class="skolem">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="keyword1">case</span> <span class="skolem">X</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">uu_</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">s</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>›</span></span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>        
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span> <span class="main">⟹</span> card <span class="main">(</span>fst <span class="skolem">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">X</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> case_prod_beta'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card.infinite card_gt_0_iff finite_Int non_empty_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>card <span class="main">(</span>fst <span class="skolem">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟷</span> <span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_filterQuery"><span class="command">lemma</span></span> wf_filterQuery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Qp</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQp</span> <span class="main">=</span> filterQuery <span class="free">I</span> <span class="free">Qp</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">I</span> <span class="free">QQp</span> <span class="free">QQn</span>"</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQp</span>"</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">I</span> <span class="free">QQp</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQp</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> filterQuery.simps member_filter non_empty_query_def rwf_query_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">I</span> <span class="free">QQp</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Qp</span><span class="main">.</span> <span class="main">(</span>card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">⟷</span> <span class="bound">X</span> <span class="main">∈</span> <span class="free">QQp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> set_filterQuery assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qp</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">∈</span><span class="free">QQp</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span> <span class="main">∩</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qp</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qp</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">QQp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff One_nat_def Suc_le_eq
            <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Qp</span><span class="main">.</span> <span class="main">(</span><span class="main">1</span> <span class="main">≤</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">X</span> <span class="main">∈</span> <span class="free">QQp</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qp</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
            calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff empty_iff finite_Int fst_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> covering_def inf.absorb_iff2 le_infI1 rwf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">I</span> <span class="free">QQp</span> <span class="free">QQn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">QQp</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> rwf_query_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>wf_set <span class="free">n</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rwf_query_def subsetD wf_query_def wf_set_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">QQp</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">I</span> <span class="free">QQp</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹covering <span class="free">I</span> <span class="free">QQp</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Set.is_empty <span class="free">QQp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">¬</span> <span class="main">(</span>Set.is_empty <span class="free">QQp</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="free">QQp</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">¬</span> Set.is_empty <span class="free">QQp</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">QQp</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> SUP_empty Set.is_empty_def <span class="quoted"><span class="quoted">‹Set.is_empty <span class="free">QQp</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹covering <span class="free">I</span> <span class="free">QQp</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_eq_0_iff covering_def not_one_le_zero subset_empty<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">QQp</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> card.infinite filterQuery.simps finite_filter not_one_le_zero rwf_query_def wf_query_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Set.is_empty_def Suc_leI calculation card_gt_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">⊆</span> <span class="free">Qn</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">I</span> <span class="free">QQp</span> <span class="free">Qn</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Un_iff assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rwf_query_def wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹wf_query <span class="free">n</span> <span class="free">I</span> <span class="free">QQp</span> <span class="free">Qn</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> subset_eq sup_mono wf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_set_subset"><span class="command">lemma</span></span> wf_set_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generic_Join_Correctness-wf_projectQuery"><span class="command">lemma</span></span> wf_projectQuery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">I</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">I</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">I</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"included <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">I</span> <span class="free">QQ</span> <span class="free">Qn</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">I</span> <span class="free">QQ</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">QQ</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> wf_query_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_projectTable wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">QQ</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">QQ</span> <span class="main">=</span> card <span class="main">(</span>Set.image <span class="main">(</span>projectTable <span class="free">I</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_le_eq assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff finite_imageI image_is_empty wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Un_iff assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">I</span> <span class="free">QQ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> covering_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">QQ</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>projectTable <span class="free">I</span> <span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="main">(</span>projectTable <span class="free">I</span> <span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_projectTable <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">QQ</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">S</span> <span class="main">∩</span> <span class="free">I</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> covering_def inf_absorb2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">I</span> <span class="free">QQ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">QQ</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">QQ</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> Set.image <span class="main">(</span>projectTable <span class="free">I</span><span class="main">)</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">QQ</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XX</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">I</span> <span class="skolem">XX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> projectTable <span class="free">I</span> <span class="main">`</span> <span class="free">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∩</span> <span class="main">(</span>fst <span class="skolem">XX</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> projectTable.simps fst_conv inf_commute prod.collapse<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">QQ</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> included_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> non_empty_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>8<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> rwf_query_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_firstRecursiveCall"><span class="command">lemma</span></span> wf_firstRecursiveCall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Qp</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Qp</span> <span class="free">Qn</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="free">I</span> <span class="main">(</span>filterQuery <span class="free">I</span> <span class="free">Qp</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">I</span> <span class="free">Q_I_pos</span> <span class="free">Q_I_neg</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> getIJProperties<span class="main">(</span>5<span class="main">)</span> getIJProperties<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tQ</span> <span class="main">=</span> filterQuery <span class="free">I</span> <span class="free">Qp</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">I</span> <span class="skolem">tQ</span> <span class="free">Q_I_neg</span>"</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="skolem">tQ</span>"</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">I</span> <span class="skolem">tQ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_filterQuery<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_filterQuery<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_filterQuery<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
        <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">I</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> tQ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">tQ</span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_filterQuery <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="free">I</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> rwf_query_def tQ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">I</span> <span class="free">Q_I_neg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> included_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_projectQuery <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⟦</span>wf_query <span class="free">n</span> <span class="free">I</span> <span class="skolem">tQ</span> <span class="free">Q_I_neg</span><span class="main">;</span> non_empty_query <span class="skolem">tQ</span><span class="main">;</span> covering <span class="free">I</span> <span class="skolem">tQ</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span>
        assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> filterQueryNeg.simps member_filter non_empty_query_def rwf_query_def tQ_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_atable_subset"><span class="command">lemma</span></span> wf_atable_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">⊆</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">Y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> subsetD table_def<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-same_set_semiJoin"><span class="command">lemma</span></span> same_set_semiJoin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"fst <span class="main">(</span>semiJoin <span class="free">x</span> <span class="free">other</span><span class="main">)</span> <span class="main">=</span> fst <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sx</span></span> <span class="skolem"><span class="skolem">tx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sx</span><span class="main">,</span> <span class="skolem">tx</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">so</span></span> <span class="skolem"><span class="skolem">to</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">other</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">so</span><span class="main">,</span> <span class="skolem">to</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">sx</span><span class="main">,</span> <span class="skolem">tx</span><span class="main">)</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_semiJoin"><span class="command">lemma</span></span> wf_semiJoin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQ</span> <span class="main">=</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">QQ</span> <span class="free">Qn</span>"</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQ</span>"</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="free">QQ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">QQ</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">QQ</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span><span class="main">∈</span><span class="free">QQ</span> <span class="main">⟹</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> semiJoin <span class="skolem">Y</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQ</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">X</span> <span class="main">=</span> fst <span class="skolem">Y</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> semiJoin <span class="skolem">Y</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>›</span></span> fst_conv prod.collapse semiJoin.simps<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">X</span> <span class="main">⊆</span> snd <span class="skolem">Y</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> semiJoin <span class="skolem">Y</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>›</span></span> member_filter prod.collapse semiJoin.simps snd_conv subsetI<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="main">(</span>fst <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹wf_atable <span class="free">n</span> <span class="skolem">Y</span>›</span></span> calculation wf_atable_def wf_atable_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>fst <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹wf_atable <span class="free">n</span> <span class="skolem">Y</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_atable_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_atable_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">QQ</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_leI assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> card.infinite card_gt_0_iff finite_imageI image_is_empty wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> wf_query_def Un_iff assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQ</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> image_iff non_empty_query_def same_set_semiJoin<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="free">QQ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">QQ</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> same_set_semiJoin <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> covering_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-newQuery_equiv_def"><span class="command">lemma</span></span> newQuery_equiv_def<span class="main">:</span>
  <span class="quoted"><span class="quoted">"newQuery <span class="free">V</span> <span class="free">Q</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> projectQuery <span class="free">V</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">st</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> image_image newQuery.simps projectQuery.elims<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-included_project"><span class="command">lemma</span></span> included_project<span class="main">:</span>
  <span class="quoted"><span class="quoted">"included <span class="free">V</span> <span class="main">(</span>projectQuery <span class="free">V</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">S</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>projectQuery <span class="free">V</span> <span class="free">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">S</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>projectQuery <span class="free">V</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">SS</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">V</span> <span class="main">(</span><span class="skolem">SS</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">S</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> projectQuery <span class="free">V</span> <span class="free">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">SS</span> <span class="main">∩</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> case_prodI2 included_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-non_empty_newQuery"><span class="command">lemma</span></span> non_empty_newQuery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q1</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Q0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q2</span> <span class="main">=</span> newQuery <span class="free">J</span> <span class="free">Q1</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q0</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span><span class="main">∈</span><span class="free">Q2</span> <span class="main">⟹</span> card <span class="main">(</span>fst <span class="bound">X</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q2</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="skolem">X2</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">∈</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">Q1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> newQuery.simps <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">Q2</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> image_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>fst <span class="skolem">X2</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">∈</span> <span class="free">Q1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X2</span> <span class="main">=</span> semiJoin <span class="skolem">X1</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X2</span> <span class="main">∈</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q1</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">X1</span> <span class="main">=</span> fst <span class="skolem">X2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_set_semiJoin<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X1</span> <span class="main">∈</span> filterQuery <span class="free">J</span> <span class="free">Q0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X1</span> <span class="main">∈</span> <span class="free">Q1</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="skolem">X1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Set.is_empty_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Set.is_empty <span class="main">(</span>fst <span class="skolem">X1</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.is_empty_def case_prod_beta'<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filterQuery.elims One_nat_def Set.is_empty_def Suc_leI <span class="quoted"><span class="quoted">‹<span class="skolem">X1</span> <span class="main">∈</span> <span class="free">Q1</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
            assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> calculation card_gt_0_iff finite_Int member_filter wf_atable_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>fst <span class="skolem">X</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> projectTable.simps <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="skolem">X2</span>›</span></span> fst_conv prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> non_empty_query_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_newQuery"><span class="command">lemma</span></span> wf_newQuery<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">Q</span> <span class="free">Qn0</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQ</span> <span class="main">=</span> newQuery <span class="free">J</span> <span class="free">Q</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">=</span> newQuery <span class="free">J</span> <span class="free">Qn</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Qn</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Qn0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">J</span> <span class="free">QQ</span> <span class="free">QQn</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tt</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> newQuery_equiv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">QS</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">QS</span> <span class="main">=</span> Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="skolem">QS</span> <span class="free">Qn0</span>"</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="skolem">QS</span>"</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="skolem">QS</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_semiJoin<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_semiJoin<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_semiJoin<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> QS_def
        assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">QS</span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> QS_def assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="main">(</span>projectQuery <span class="free">J</span> <span class="skolem">QS</span><span class="main">)</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> projectQuery.simps Un_iff calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> image_iff
        wf_projectTable wf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">QQ</span> <span class="free">QQn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">X</span><span class="main">.</span> <span class="bound">X</span><span class="main">∈</span><span class="free">QQn</span> <span class="main">⟹</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQn</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="free">Qn</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> newQuery_equiv_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>›</span></span> assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="skolem">XX</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XX</span> <span class="main">∈</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="free">Qn</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">∈</span> <span class="free">QQn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XXX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XX</span> <span class="main">=</span> semiJoin <span class="skolem">XXX</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XXX</span> <span class="main">∈</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="skolem">XXX</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filterQuery.elims Un_iff assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> member_filter wf_query_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="skolem">XX</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fst <span class="skolem">XX</span> <span class="main">=</span> fst <span class="skolem">XXX</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> same_set_semiJoin <span class="quoted"><span class="quoted">‹<span class="skolem">XX</span> <span class="main">=</span> semiJoin <span class="skolem">XXX</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">XX</span> <span class="main">=</span> Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">tt</span> <span class="main">(</span>fst <span class="skolem">XX</span> <span class="main">∩</span> <span class="skolem">st</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>snd <span class="skolem">XXX</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> semiJoin.simps <span class="quoted"><span class="quoted">‹<span class="skolem">XX</span> <span class="main">=</span> semiJoin <span class="skolem">XXX</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span>›</span></span> calculation prod.collapse snd_conv<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"snd <span class="skolem">XX</span> <span class="main">⊆</span> snd <span class="skolem">XXX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_atable_subset <span class="quoted"><span class="quoted">‹wf_atable <span class="free">n</span> <span class="skolem">XXX</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_atable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_projectTable <span class="quoted"><span class="quoted">‹<span class="skolem">X</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="skolem">XX</span>›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">QQn</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="main">(</span><span class="free">QQ</span> <span class="main">∪</span> <span class="free">QQn</span><span class="main">)</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> QS_def <span class="quoted"><span class="quoted">‹<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span>projectQuery <span class="free">J</span> <span class="skolem">QS</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">QQ</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> newQuery.simps One_nat_def Suc_leI <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
          assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> card.infinite card_gt_0_iff finite_imageI image_is_empty wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> calculation wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">J</span> <span class="free">QQn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="free">Qn</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> newQuery_equiv_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>›</span></span> assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> included_project <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="free">QQ</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> QS_def calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> covering_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">J</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">J</span>  <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> image_cong <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span> <span class="main">∩</span> <span class="free">J</span>  <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span><span class="free">Q</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">J</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">S</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>›</span></span> covering_def inf_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> QS_def <span class="quoted"><span class="quoted">‹<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>›</span></span>
      <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="skolem">QS</span><span class="main">.</span> <span class="main">1</span> <span class="main">≤</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>›</span></span> non_empty_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">QQn</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> non_empty_newQuery Un_iff <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span>›</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>9<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> wf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> included_project <span class="quoted"><span class="quoted">‹<span class="free">QQ</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="skolem">st</span><span class="main">,</span> <span class="skolem">tt</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="free">Q</span><span class="main">)</span>›</span></span>
      calculation<span class="main">(</span>4<span class="main">)</span> calculation<span class="main">(</span>5<span class="main">)</span> calculation<span class="main">(</span>6<span class="main">)</span> calculation<span class="main">(</span>7<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-subset_Q_neg"><span class="command">lemma</span></span> subset_Q_neg<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">QQn</span> <span class="main">⊆</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">QQn</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">QQn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">QQn</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Un_iff assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rwf_query_def subsetD wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> UnE UnI1 assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rwf_query_def wf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">V</span> <span class="free">QQn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> included_def rwf_query_def subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> non_empty_query_def subsetD assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation rwf_query_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_secondRecursiveCalls"><span class="command">lemma</span></span> wf_secondRecursiveCalls<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Qns</span> <span class="main">⊆</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_neg</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Qns</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="free">Q_J_pos</span><span class="main">.</span> card <span class="main">(</span>fst <span class="bound">X</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> set_filterQuery assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> getIJ.coreProperties getIJ_axioms<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="free">Qns</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">J</span> <span class="free">Q</span> <span class="free">Qns</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> subset_Q_neg wf_set_subset assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>
          getIJ.coreProperties getIJ_axioms rwf_query_def sup_ge2 wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_pos</span> <span class="main">⊆</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">X</span><span class="main">∈</span><span class="main">(</span><span class="free">Q_J_pos</span> <span class="main">∪</span> <span class="free">Qns</span><span class="main">)</span><span class="main">.</span> wf_atable <span class="free">n</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">Q_J_pos</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_filterQuery<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> getIJ.coreProperties
          getIJ_axioms sup_ge2 wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q_J_pos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_filterQuery<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> getIJ.coreProperties
        getIJ_axioms sup_ge2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>  <span class="quoted"><span class="quoted">"covering <span class="free">J</span> <span class="free">Q_J_pos</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_filterQuery<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> getIJ.coreProperties
        getIJ_axioms sup_ge2<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="free">Q_J_neg</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> filterQuery.elims assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> member_filter
        non_empty_query_def rwf_query_def subsetD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wf_newQuery assms<span class="main">(</span>5<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> calculation<span class="main">(</span>4<span class="main">)</span>
      calculation<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-simple_merge_option"><span class="command">lemma</span></span> simple_merge_option<span class="main">:</span>
  <span class="quoted"><span class="quoted">"merge_option <span class="main">(</span><span class="free">a</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="main">(</span><span class="free">a</span> <span class="main">=</span> None <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> merge_option.elims <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Generic_Join_Correctness-wf_merge"><span class="command">lemma</span></span> wf_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> merge <span class="free">t1</span> <span class="free">t2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">t</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free">V</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None <span class="main">⟷</span> <span class="skolem">i</span> <span class="main">∉</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> merge <span class="free">t1</span> <span class="free">t2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> map merge_option <span class="main">(</span>zip <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"merge_option <span class="main">(</span><span class="free">t1</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">t2</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> length_zip min_less_iff_conj nth_map nth_zip wf_tuple_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">t1</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">t2</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹merge_option <span class="main">(</span><span class="free">t1</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">t2</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> None›</span></span> simple_merge_option<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> map merge_option <span class="main">(</span>zip <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"merge_option <span class="main">(</span><span class="free">t1</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">t2</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_zip merge_option.elims min_less_iff_conj nth_map nth_zip wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False UnI1 UnI2 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> simple_merge_option wf_tuple_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t1</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t2</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>zip <span class="free">t1</span> <span class="free">t2</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation wf_tuple_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_inter"><span class="command">lemma</span></span> wf_inter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sa</span><span class="main">,</span> <span class="free">a</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">sb</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="main">(</span><span class="free">a</span> <span class="main">∩</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"card <span class="free">sa</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="free">sb</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> fst_conv non_empty_query_def rwf_query_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="main">{</span><span class="free">i</span><span class="main">}</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">S</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">S</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> included_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sb</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">sa</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">sb</span> <span class="main">=</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="free">sa</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="free">sb</span>›</span></span> card.empty not_one_le_zero subset_singletonD<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> inf_le1 prod.sel<span class="main">(</span>1<span class="main">)</span> prod.sel<span class="main">(</span>2<span class="main">)</span> rwf_query_def wf_atable_def
      wf_atable_subset wf_query_def Un_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-table_subset"><span class="command">lemma</span></span> table_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">S</span> <span class="main">⊆</span> <span class="free">T</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> wf_atable_subset assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Generic_Join_Correctness-wf_base_case"><span class="command">lemma</span></span> wf_base_case<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">∧</span> included <span class="free">V</span> <span class="free">Q</span> <span class="main">∧</span> non_empty_query <span class="free">Q</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span><span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"card <span class="free">Q</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">Q</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">Q</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"0.hyps"</span> <span class="quoted">"0.prems"</span> One_nat_def le_add_diff_inverse plus_1_eq_Suc wf_query_def<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def <span class="quoted"><span class="quoted">‹card <span class="skolem">Q</span> <span class="main">=</span> <span class="main">1</span>›</span></span> card_eq_0_iff card_eq_SucD card_mono finite_insert insertE
          nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> not_one_le_zero subrelI<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> card_1_singletonE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">s</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> calculation non_empty_query_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">}</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="main">{</span><span class="skolem">i</span><span class="main">}</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> <span class="quoted"><span class="quoted">‹<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>›</span></span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_seteq case_prodD finite.emptyI finite.insertI included_def singletonI<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">s</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"0.prems"</span> calculation<span class="main">(</span>1<span class="main">)</span> rwf_query_def wf_atable_def wf_query_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rwf_query_def wf_atable_def wf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> wf_atable_subset <span class="quoted"><span class="quoted">‹<span class="free">V</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">i</span><span class="main">}</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">y</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> all_not_in_conv card.empty nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> zero_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">H</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xx</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">H</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation card_Diff_singleton card.infinite diff_Suc_1 less_imp_le not_one_le_zero zero_less_Suc zero_less_diff<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="skolem">H</span> <span class="free">Qn</span> <span class="main">∧</span> included <span class="free">V</span> <span class="skolem">H</span> <span class="main">∧</span> non_empty_query <span class="skolem">H</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="skolem">H</span> <span class="free">Qn</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> DiffD1 Suc.hyps<span class="main">(</span>2<span class="main">)</span> Suc.prems <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xx</span><span class="main">}</span>›</span></span> calculation<span class="main">(</span>1<span class="main">)</span> card_Diff_singleton
          card.infinite le_add1 not_one_le_zero plus_1_eq_Suc wf_query_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Un_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> DiffD1 Suc.prems <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xx</span><span class="main">}</span>›</span></span> included_def non_empty_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="skolem">H</span> <span class="free">Qn</span> <span class="main">∧</span> included <span class="free">V</span> <span class="skolem">H</span> <span class="main">∧</span> non_empty_query <span class="skolem">H</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span><span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="skolem">H</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.hyps<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sa</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">sa</span><span class="main">,</span> <span class="skolem">a</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc.hyps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xx</span><span class="main">}</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card.empty card_eq_0_iff card_le_Suc0_iff_eq diff_is_0_eq' equals0I insert_Diff le0 nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> prod.collapse singletonD<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>Set.is_empty <span class="skolem">sa</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.is_empty_def <span class="quoted"><span class="quoted">‹wf_query <span class="free">n</span> <span class="free">V</span> <span class="skolem">H</span> <span class="free">Qn</span> <span class="main">∧</span> included <span class="free">V</span> <span class="skolem">H</span> <span class="main">∧</span> non_empty_query <span class="skolem">H</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span>
          card.empty non_empty_query_def not_one_le_zero prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">H</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∩</span> <span class="main">(</span>snd <span class="skolem">xx</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int2 Diff_Int_distrib2 IntE calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> table_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> INF_insert Int_commute <span class="quoted"><span class="quoted">‹<span class="skolem">H</span> <span class="main">=</span> <span class="skolem">Q</span> <span class="main">-</span> <span class="main">{</span><span class="skolem">xx</span><span class="main">}</span>›</span></span> calculation<span class="main">(</span>1<span class="main">)</span> insert_Diff snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> genericJoin.simps le_numeral_extra<span class="main">(</span>4<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-filter_Q_J_neg_same"><span class="command">lemma</span></span> filter_Q_J_neg_same<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"filterQuery <span class="free">J</span> <span class="main">(</span><span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span><span class="main">)</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">⊆</span> <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subset_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">⊆</span> <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Set.is_empty_def Suc_leI Suc_le_lessD <span class="quoted"><span class="quoted">‹<span class="main">¬</span> <span class="main">1</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
            assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff finite_Int getIJ.coreProperties getIJ_axioms<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">V</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.is_empty_def UnE assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation disjoint_iff_not_equal
              getIJProperties<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> subsetD subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">x</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>›</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset subset_Q_neg assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> fst_conv rwf_query_def set_filterQuery<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-vars_genericJoin"><span class="command">lemma</span></span> vars_genericJoin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="free">I</span> <span class="main">(</span>filterQuery <span class="free">I</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_I</span> <span class="main">=</span> genericJoin <span class="free">I</span> <span class="free">Q_I_pos</span> <span class="free">Q_I_neg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_neg</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="main">(</span><span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">R_I</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"filterQuery <span class="free">J</span> <span class="main">(</span><span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span><span class="main">)</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>10<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> filter_Q_J_neg_same <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_neg</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> card <span class="free">V</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="free">V</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="bound">I</span> <span class="main">(</span>filterQuery <span class="bound">I</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="bound">I</span> <span class="free">Qn</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> genericJoin <span class="bound">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="bound">J</span> <span class="free">Q</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="bound">J</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_pos</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_neg</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>card <span class="free">V</span> <span class="main">≤</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> gen<span class="main">:</span> <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="free">V</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="bound">I</span> <span class="main">(</span>filterQuery <span class="bound">I</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="bound">I</span> <span class="free">Qn</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> genericJoin <span class="bound">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="bound">J</span> <span class="free">Q</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="bound">J</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_pos</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_neg</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="free">I</span> <span class="main">(</span>filterQuery <span class="free">I</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> genericJoin <span class="free">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Q</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="bound">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="bound">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> case_prod_conv<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> gen<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-base_genericJoin"><span class="command">lemma</span></span> base_genericJoin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">=</span>  <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> card <span class="free">V</span> <span class="main">≤</span> <span class="main">1</span> <span class="keyword1">then</span>
      <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="free">V</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="bound">I</span> <span class="main">(</span>filterQuery <span class="bound">I</span> <span class="free">Q</span><span class="main">)</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="bound">I</span> <span class="free">Qn</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">R_I</span> <span class="main">=</span> genericJoin <span class="bound">I</span> <span class="bound">Q_I_pos</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>

      <span class="keyword1">let</span> <span class="bound">Q_J_neg</span> <span class="main">=</span> <span class="free">Qn</span> <span class="main">-</span> <span class="bound">Q_I_neg</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="bound">J</span> <span class="free">Q</span> <span class="keyword1">in</span>
      <span class="keyword1">let</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="bound">J</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_pos</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="bound">J</span> <span class="bound">Q_J_neg</span> <span class="main">(</span><span class="bound">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="bound">R_I</span><span class="main">}</span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_genericJoin"><span class="command">lemma</span></span> wf_genericJoin<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span><span class="main">;</span> card <span class="free">V</span> <span class="main">≥</span> <span class="main">1</span><span class="main">⟧</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="free">V</span> <span class="main">(</span>genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">Qn</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> genericJoin.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">≤</span> <span class="main">1</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> le_antisym wf_base_case <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_I_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="skolem">I</span> <span class="main">(</span>filterQuery <span class="skolem">I</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_I_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="skolem">I</span> <span class="skolem">Qn</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R_I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R_I</span> <span class="main">=</span> genericJoin <span class="skolem">I</span> <span class="skolem">Q_I_pos</span> <span class="skolem">Q_I_neg</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_J_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_J_neg</span> <span class="main">=</span> filterQuery <span class="skolem">J</span> <span class="main">(</span><span class="skolem">Qn</span> <span class="main">-</span> <span class="skolem">Q_I_neg</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_J_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="skolem">J</span> <span class="skolem">Q</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">R_I</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vars_genericJoin<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?V</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?I</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?J</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Q_I_pos</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Q_I_pos</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Q</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Qn</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Qn</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span>
        <span class="var">?Q_I_neg</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Q_I_neg</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?R_I</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">R_I</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Q_J_neg</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Q_J_neg</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Q_J_pos</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Q_J_pos</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> Q_I_neg_def Q_I_pos_def Q_J_neg_def Q_J_pos_def R_I_def X_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> card <span class="skolem">V</span>›</span></span> getIJ.getIJProperties<span class="main">(</span>1<span class="main">)</span> getIJProperties<span class="main">(</span>2<span class="main">)</span> getIJ_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">I</span> <span class="skolem">Q_I_pos</span> <span class="skolem">Q_I_neg</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> Q_I_neg_def Q_I_pos_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> card <span class="skolem">V</span>›</span></span> getIJ.wf_firstRecursiveCall getIJ_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span><span class="main">∈</span><span class="skolem">R_I</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="skolem">J</span> <span class="main">(</span>genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> Q_J_neg_def Q_J_pos_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> card <span class="skolem">V</span>›</span></span>
          getIJ.wf_secondRecursiveCalls getIJ_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">J</span> <span class="main">(</span>genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False Q_I_neg_def Q_J_neg_def Q_J_pos_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span>
            <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> card <span class="skolem">V</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> filter_Q_J_neg_same<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t</span> <span class="bound">xx</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">R_I</span> <span class="main">∧</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="main">(</span>genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
               <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="main">(</span>merge <span class="bound">xx</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="skolem">xx</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span> <span class="main">∧</span> <span class="skolem">xx</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">∪</span> <span class="skolem">J</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="numeral">2</span> <span class="main">≤</span> card <span class="skolem">V</span>›</span></span> getIJ.coreProperties getIJ_axioms <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="skolem">xx</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">R_I</span> <span class="main">⟹</span> table <span class="free">n</span> <span class="skolem">J</span> <span class="main">(</span>genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>›</span></span>
          <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span> <span class="main">∧</span> <span class="skolem">xx</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">I</span> <span class="skolem">t</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.IH"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False Q_I_neg_def Q_I_pos_def
            R_I_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⟦</span><span class="main">1</span> <span class="main">≤</span> card <span class="skolem">I</span><span class="main">;</span> <span class="main">1</span> <span class="main">≤</span> card <span class="skolem">J</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span>
            <span class="quoted"><span class="quoted">‹rwf_query <span class="free">n</span> <span class="skolem">I</span> <span class="skolem">Q_I_pos</span> <span class="skolem">Q_I_neg</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span> <span class="main">∧</span> <span class="skolem">xx</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>
            <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span> table_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="main">(</span>merge <span class="skolem">xx</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> sup_commute wf_merge<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">R_I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">xx</span> <span class="main">∈</span> <span class="main">(</span>genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">.</span>
                wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="main">(</span>merge <span class="bound">xx</span> <span class="bound">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="skolem">R</span><span class="main">.</span> wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R_def X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Correctness›</span></span>

<span class="keyword1" id="Generic_Join_Correctness-base_correctness"><span class="command">lemma</span></span> base_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">V</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> table_def wf_base_case<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> non_empty_query_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> included_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation card.infinite card_seteq nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> INT_D <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> case_prod_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> non_empty_query_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> included_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation card_gt_0_iff card_seteq zero_less_one<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="skolem">z</span>›</span></span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> UN_iff <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> prod.sel<span class="main">(</span>2<span class="main">)</span> snd_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span>
          assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card.infinite card_seteq case_prod_beta' included_def nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
          non_empty_query_def restrict_idle rwf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">Q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> rwf_query_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span><span class="main">.</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span>
            assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card.infinite card_seteq case_prod_beta' included_def nat.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
            non_empty_query_def restrict_idle rwf_query_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> UN_iff case_prod_beta' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span><span class="main">.</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> INT_I case_prod_beta' <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">N</span><span class="main">,</span> <span class="bound">Z</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> <span class="bound">Z</span><span class="main">)</span> <span class="main">⊆</span> <span class="free">R</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">-</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">Z</span> <span class="bound">Za</span><span class="main">.</span> <span class="bound">Z</span> <span class="main">-</span> <span class="bound">Za</span> <span class="main">⊆</span> <span class="free">R</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">Za</span> <span class="main">∧</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">Z</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-simple_list_index_equality"><span class="command">lemma</span></span> simple_list_index_equality<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="free">a</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">b</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">=</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> nth_equalityI <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Generic_Join_Correctness-simple_restrict_none"><span class="command">lemma</span></span> simple_restrict_none<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="free">X</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> restrict_def<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-simple_restrict_some"><span class="command">lemma</span></span> simple_restrict_some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="free">X</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">X</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> restrict_def<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-merge_restrict"><span class="command">lemma</span></span> merge_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xx</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="free">xx</span> <span class="main">=</span> <span class="free">xx</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nth_restrict<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xx</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal simple_restrict_none<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xx</span> <span class="main">=</span> length <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">xx</span><span class="main">!</span><span class="skolem">i</span><span class="main">,</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">xx</span> <span class="main">=</span> length <span class="free">t</span>›</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"merge_option <span class="main">(</span>None<span class="main">,</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span>"</span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> merge_option.simps<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> merge_option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.exhaust<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>zip <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> nth_restrict<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> restrict_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xx</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="free">t</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> calculation simple_restrict_none <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">A</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None›</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> simple_list_index_equality<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?a</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?b</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?n</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="free">n</span>"</span></span><span class="main">]</span>
      assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-restrict_idle_include"><span class="command">lemma</span></span> restrict_idle_include<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="free">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">v</span> <span class="main">=</span> <span class="free">v</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">v</span> <span class="main">⟹</span> <span class="main">(</span>restrict <span class="free">I</span> <span class="free">v</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="free">v</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">v</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">I</span> <span class="free">v</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">v</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">v</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> nth_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">v</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> nth_restrict simple_restrict_none wf_tuple_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-merge_index"><span class="command">lemma</span></span> merge_index<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">tI</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">tJ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> merge <span class="free">tI</span> <span class="free">tJ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">tI</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">i</span> <span class="main">∈</span> <span class="free">J</span> <span class="main">∧</span> <span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">tJ</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="free">i</span> <span class="main">∉</span> <span class="free">I</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">∉</span> <span class="free">J</span> <span class="main">∧</span> <span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="main">(</span>zip <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> length_zip merge.simps
        min_less_iff_conj nth_map wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">tI</span><span class="main">!</span><span class="free">i</span><span class="main">,</span> <span class="free">tJ</span><span class="main">!</span><span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> nth_zip wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">tI</span><span class="main">!</span><span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tJ</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> True assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"merge_option <span class="main">(</span><span class="free">tI</span><span class="main">!</span><span class="free">i</span><span class="main">,</span> None<span class="main">)</span> <span class="main">=</span> <span class="free">tI</span><span class="main">!</span><span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> merge_option.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> option.exhaust wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">tI</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> <span class="free">tJ</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>›</span></span> calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">J</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">tJ</span><span class="main">!</span><span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tI</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> False assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>5<span class="main">)</span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"merge_option <span class="main">(</span>None<span class="main">,</span> <span class="free">tJ</span><span class="main">!</span><span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">tJ</span><span class="main">!</span><span class="free">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> merge_option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> option.exhaust wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">tI</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> <span class="free">tJ</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>›</span></span> calculation<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">tI</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">tJ</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None "</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> False <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">t</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">tI</span> <span class="main">!</span> <span class="free">i</span><span class="main">,</span> <span class="free">tJ</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">tI</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">tJ</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-restrict_index_in"><span class="command">lemma</span></span> restrict_index_in<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">I</span> <span class="free">X</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> <span class="free">X</span><span class="main">!</span><span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> nth_restrict<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-restrict_index_out"><span class="command">lemma</span></span> restrict_index_out<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">I</span> <span class="free">X</span><span class="main">)</span><span class="main">!</span><span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> simple_restrict_none<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-merge_length"><span class="command">lemma</span></span> merge_length<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">a</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"length <span class="free">b</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">a</span> <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-real_restrict_merge"><span class="command">lemma</span></span> real_restrict_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="free">J</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">tI</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">tJ</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">tI</span> <span class="main">∧</span> restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">tJ</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> merge_length wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">(</span>restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">I</span> <span class="free">tI</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>
                     <span class="main">∧</span> <span class="main">(</span>restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">J</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">I</span> <span class="free">tI</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">∧</span> <span class="main">(</span>restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">J</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">tI</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal merge_index<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">tI</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> simple_restrict_some<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal restrict_idle simple_restrict_none wf_tuple_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">J</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">tJ</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> merge_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> simple_restrict_none simple_restrict_some wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> merge_index <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> eq_iff equalityD1 restrict_idle_include simple_restrict_none wf_tuple_def wf_tuple_restrict_simple<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span>restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">I</span> <span class="free">tI</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span> 
          <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">.</span> <span class="main">(</span>restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">J</span> <span class="free">tJ</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> wf_merge wf_tuple_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">I</span> <span class="free">tI</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">J</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">tI</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">∧</span> restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">tI</span> <span class="free">tJ</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">tJ</span> <span class="main">!</span> <span class="bound">i</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> length_restrict simple_list_index_equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-simple_set_image_id"><span class="command">lemma</span></span> simple_set_image_id<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"Set.image <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.image <span class="free">f</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="free">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">f</span> <span class="main">`</span> <span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>›</span></span> calculation<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-nested_include_restrict"><span class="command">lemma</span></span> nested_include_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_index_in <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_restrict subsetD<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> simple_restrict_none <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span>›</span></span> calculation length_restrict<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> list_eq_iff_nth_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-restrict_nested"><span class="command">lemma</span></span> restrict_nested<span class="main">:</span>
  <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="main">(</span>restrict <span class="free">B</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">B</span><span class="main">)</span> <span class="free">x</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?lhs</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">x</span> <span class="main">⟹</span> <span class="var">?lhs</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="var">?rhs</span><span class="main">!</span><span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_iff length_restrict restrict_index_in simple_restrict_none<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_list_index_equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-newQuery_equi_dev"><span class="command">lemma</span></span> newQuery_equi_dev<span class="main">:</span>
  <span class="quoted"><span class="quoted">"newQuery <span class="free">V</span> <span class="free">Q</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Set.image <span class="main">(</span>projectTable <span class="free">V</span><span class="main">)</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> newQuery_equiv_def projectQuery.elims<span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-projectTable_idle"><span class="command">lemma</span></span> projectTable_idle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"projectTable <span class="free">I</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"projectTable <span class="free">I</span> <span class="main">(</span><span class="free">A</span><span class="main">,</span> <span class="free">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">,</span> Set.image <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> projectTable.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">=</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> restrict_idle_include <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.image <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="free">X</span> <span class="main">=</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span> <span class="main">⟹</span> restrict <span class="free">I</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">x</span>›</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="free">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">=</span> <span class="free">A</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-restrict_partition_merge"><span class="command">lemma</span></span> restrict_partition_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∪</span> <span class="free">J</span> <span class="main">=</span> <span class="free">V</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xx</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> merge <span class="free">xx</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">z</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> nth_restrict wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">t</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> simple_restrict_none Set.is_empty_def True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> disjoint_iff_not_equal wf_tuple_length<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> wf_tuple_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹merge <span class="free">xx</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹merge <span class="free">xx</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> merge_option <span class="main">(</span><span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">,</span> <span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">J</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">xx</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> nth_restrict wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="free">xx</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> None
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True UnI1 <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation sup_commute wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">a</span><span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False simple_restrict_none <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> wf_tuple_length<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Some <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> wf_tuple_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False UnE <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> wf_tuple_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xx</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False New_max.simple_restrict_none <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> wf_tuple_length<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> New_max.simple_restrict_none <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="free">I</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> wf_tuple_length<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> wf_tuple_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">z</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation simple_list_index_equality<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-restrict_merge"><span class="command">lemma</span></span> restrict_merge<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">zI</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">zJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="free">zI</span> <span class="main">∈</span> Set.image <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="free">zJ</span> <span class="main">∈</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span>isSameIntersection <span class="free">zI</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="free">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> merge <span class="free">zJ</span> <span class="free">zI</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="free">A</span> <span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zAJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zAJ</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="free">zJ</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zz</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zAJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="skolem">zz</span>"</span></span> <span class="quoted"><span class="quoted">"isSameIntersection <span class="free">zI</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> zAJ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">zI</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="free">zI</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>7<span class="main">)</span> assms<span class="main">(</span>9<span class="main">)</span> wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">zI</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>10<span class="main">)</span> wf_tuple_restrict_simple <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">A</span> <span class="skolem">zz</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> isSame_equi_dev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="main">_</span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">zI</span></span> <span class="quoted"><span class="free">A</span></span> <span class="quoted"><span class="skolem">zz</span></span> <span class="quoted"><span class="quoted">"<span class="free">A</span> <span class="main">∩</span> <span class="free">I</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹isSameIntersection <span class="free">zI</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span>›</span></span> assms<span class="main">(</span>7<span class="main">)</span> assms<span class="main">(</span>9<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_nested assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">zz</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> table_def wf_tuple_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">zI</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation length_restrict<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="skolem">zz</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">z</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> restrict_index_in<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">zI</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span> <span class="main">=</span> restrict <span class="free">A</span> <span class="free">zI</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> True <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="free">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zz</span> <span class="main">!</span> <span class="skolem">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
                length_restrict restrict_index_in<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="free">zJ</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False True UnE <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zAJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="skolem">zz</span>›</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
                restrict_index_in subsetD zAJ_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="free">A</span> <span class="free">zJ</span><span class="main">)</span><span class="main">!</span><span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> restrict_nested<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False True UnE <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="free">zJ</span> <span class="main">!</span> <span class="skolem">i</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span>
                calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_restrict restrict_index_in subsetD<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_restrict simple_restrict_none table_def wf_tuple_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> simple_list_index_equality <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> <span class="free">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-partial_correctness"><span class="command">lemma</span></span> partial_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="free">I</span> <span class="main">(</span>filterQuery <span class="free">I</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_neg</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="main">(</span><span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">NQ_pos</span> <span class="main">=</span> newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">NQ_neg</span> <span class="main">=</span> newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_NQ</span> <span class="main">=</span> genericJoin <span class="free">J</span> <span class="free">NQ_pos</span> <span class="free">NQ_neg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">R_I</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="free">R_NQ</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> merge <span class="free">xx</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">R_I</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">xx</span> <span class="main">∈</span> <span class="free">R_NQ</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>12<span class="main">)</span> assms<span class="main">(</span>13<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> assms<span class="main">(</span>16<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> wf_merge assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span> sup_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⟦</span>wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span><span class="main">;</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span>
          assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> merge_restrict restrict_idle sup.cobounded1 wf_tuple_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">xx</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⟦</span>wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span><span class="main">;</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span>
          assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inf_commute real_restrict_merge<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="free">xx</span> <span class="main">=</span> <span class="free">xx</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span>›</span></span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span>›</span></span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xx</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>14<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">t</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>12<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">xx</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>13<span class="main">)</span> assms<span class="main">(</span>16<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>17<span class="main">)</span> non_empty_query_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_neg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∪</span> <span class="free">Qn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation fst_conv snd_conv wf_atable_def wf_query_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">t</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_neg</span>›</span></span> assms<span class="main">(</span>12<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>›</span></span> nested_include_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_neg</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> False Int_greatest One_nat_def Set.is_empty_def Suc_leI
              Suc_le_lessD <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> card_gt_0_iff case_prodD
              finite_Int included_def rwf_query_def sup_ge2 sup_inf_absorb sup_inf_distrib1<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>8<span class="main">)</span> calculation
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_subset subset_Q_neg assms<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> fst_conv rwf_query_def set_filterQuery<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AI</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AJ</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">NQ_neg</span> <span class="main">=</span> projectQuery <span class="free">J</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">Q_J_neg</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> newQuery_equi_dev projectQuery.simps assms<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">XXX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XXX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NQ_neg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XXX</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AJ_def newQuery.simps projectTable.simps <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_neg</span>›</span></span> assms<span class="main"><span class="main">(</span></span>10<span class="main"><span class="main">)</span></span> image_eqI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AJ</span> <span class="free">xx</span> <span class="main">∉</span> <span class="skolem">XXX</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xx</span> <span class="main">∈</span> <span class="free">R_NQ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">xx</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">xx</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>13<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XXX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NQ_neg</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>

      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zA</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zA</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="free">z</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zA</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">zA</span> <span class="main">∉</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zA</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zA</span> <span class="main">=</span> restrict <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="free">t</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nested_include_restrict <span class="quoted"><span class="quoted">‹restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>›</span></span> inf_le1 inf_le2 zA_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSameIntersection <span class="free">t</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zA</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">⊆</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main">(</span>17<span class="main">)</span> included_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">zA</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span>›</span></span> calculation<span class="main">(</span>5<span class="main">)</span> wf_tuple_restrict_simple zA_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> isSame_equi_dev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">zA</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span>"</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="skolem">zA</span> <span class="main">=</span> restrict <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zA</span> <span class="main">∈</span> <span class="skolem">XX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">=</span> semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>›</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="skolem">zA</span> <span class="main">∈</span> <span class="skolem">XXX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XXX</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AJ</span> <span class="free">xx</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="skolem">zA</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> AJ_def restrict_nested <span class="quoted"><span class="quoted">‹restrict <span class="free">J</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> inf.right_idem inf_commute zA_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">AJ</span> <span class="free">xx</span> <span class="main">∉</span> <span class="skolem">XXX</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> zA_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⟦</span>wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span><span class="main">;</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span>
          assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> merge_restrict restrict_idle sup.cobounded1 wf_tuple_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="main">(</span>merge <span class="free">xx</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">xx</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">thesis</span><span class="main">.</span> <span class="main">(</span><span class="main">⟦</span>wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span><span class="main">;</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="bound">thesis</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">thesis</span>›</span></span>
          assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inf_commute real_restrict_merge<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="free">xx</span> <span class="main">=</span> <span class="free">xx</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span>›</span></span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span>›</span></span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xx</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>14<span class="main">)</span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">t</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>12<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">xx</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>13<span class="main">)</span> assms<span class="main">(</span>16<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main">(</span>17<span class="main">)</span> non_empty_query_def rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> filterQuery <span class="free">I</span> <span class="free">Q</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">=</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">A</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">s</span> <span class="main">∩</span> <span class="free">V</span> <span class="main">≠</span> <span class="main">{}</span><span class="main">)</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span> <span class="main">=</span> <span class="skolem">A</span>›</span></span> assms<span class="main"><span class="main">(</span></span>17<span class="main"><span class="main">)</span></span> fst_conv rwf_query_def set_filterQuery<span class="main">)</span>          
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Q</span> <span class="main">∪</span> <span class="free">Qn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation fst_conv snd_conv wf_atable_def wf_query_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"projectTable <span class="free">I</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True calculation projectTable_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_pos</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> filterQuery <span class="free">I</span> <span class="free">Q</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> image_eqI projectQuery.elims<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">t</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">t</span> <span class="main">∈</span> <span class="bound">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>›</span></span> nested_include_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">V</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False One_nat_def Suc_leI Suc_le_lessD UnE assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> 
            assms<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> card_gt_0_iff disjoint_iff_not_equal finite_Int subsetD subsetI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">≥</span> <span class="main">1</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zI</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">z</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">z</span>"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zI</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">=</span> <span class="free">xx</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> zI_def zJ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zI</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="free">t</span>›</span></span> calculation<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="skolem">zJ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">xx</span> <span class="main">∈</span> <span class="bound">X</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="free">xx</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zJ</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>filterQuery <span class="free">I</span> <span class="free">Q</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def set_filterQuery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">AI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AI</span> <span class="main">=</span> <span class="skolem">A</span><span class="main">∩</span><span class="free">I</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">XI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XI</span> <span class="main">=</span> Set.image <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AI</span><span class="main">,</span> <span class="skolem">XI</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">I</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> AI_def XI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AI</span><span class="main">,</span> <span class="skolem">XI</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_pos</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> filterQuery <span class="free">I</span> <span class="free">Q</span>›</span></span> assms<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> image_eqI projectQuery.elims<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AI</span> <span class="skolem">zI</span> <span class="main">∈</span> <span class="skolem">XI</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zI</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AJ</span></span> <span class="skolem"><span class="skolem">XJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XJ</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AJ</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XJ</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NQ_pos</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XJ</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zI</span> <span class="main">=</span> <span class="free">t</span>›</span></span> image_iff
          <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>9<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AJ</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="skolem">XJ</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="skolem">zJ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XJ</span> <span class="main">=</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AJ</span><span class="main">,</span> <span class="skolem">XJ</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AJ</span> <span class="skolem">zJ</span> <span class="main">∈</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span><span class="main">)</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">AJ</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="skolem">XJ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def wf_atable_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> restrict_merge<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">zI</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="skolem">zJ</span></span> <span class="quoted"><span class="free">J</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> AI_def True XI_def <span class="quoted"><span class="quoted">‹<span class="skolem">AJ</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span>›</span></span>
            <span class="quoted"><span class="quoted">‹restrict <span class="skolem">AI</span> <span class="skolem">zI</span> <span class="main">∈</span> <span class="skolem">XI</span>›</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">J</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span>›</span></span> assms<span class="main">(</span>1<span class="main">)</span>
            assms<span class="main">(</span>14<span class="main">)</span> assms<span class="main">(</span>17<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> rwf_query_def wf_query_def zI_def zJ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>6<span class="main">)</span> assms<span class="main">(</span>17<span class="main">)</span>
            rwf_query_def set_filterQuery <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">J</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False One_nat_def Set.is_empty_def Suc_leI Suc_le_lessD <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>›</span></span>
              assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> card_gt_0_iff finite_Int inf.absorb_iff2 inf_commute sup_commute sup_inf_absorb sup_inf_distrib1<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="free">xx</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">J</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> nested_include_restrict <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zI</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">z</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">z</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">=</span> <span class="free">xx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">J</span> <span class="free">z</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> zJ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zI</span> <span class="main">=</span> <span class="free">t</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="free">I</span> <span class="free">z</span> <span class="main">=</span> <span class="free">t</span>›</span></span> zI_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> merge <span class="skolem">zJ</span> <span class="skolem">zI</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zI</span> <span class="main">=</span> <span class="free">t</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zJ</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> assms<span class="main"><span class="main">(</span></span>14<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NQ_pos</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> calculation image_iff assms<span class="main">(</span>9<span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="skolem">XX</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">NQ_pos</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">xx</span> <span class="main">∈</span> <span class="bound">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zJ</span> <span class="main">=</span> <span class="free">xx</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="skolem">zJ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="free">xx</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zJ</span> <span class="main">=</span> <span class="free">xx</span>›</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="skolem">zJ</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">J</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">AA</span> <span class="main">=</span> <span class="skolem">A</span> <span class="main">∩</span> <span class="free">J</span>›</span></span> inf.absorb1<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="skolem">XX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">AA</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="skolem">XX</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XX</span> <span class="main">⊆</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AAA</span></span> <span class="skolem"><span class="skolem">XXX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AAA</span><span class="main">,</span> <span class="skolem">XXX</span><span class="main">)</span> <span class="main">=</span> semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XXX</span> <span class="main">⊆</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">XX</span> <span class="main">=</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="skolem">XXX</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AAA</span><span class="main">,</span> <span class="skolem">XXX</span><span class="main">)</span> <span class="main">=</span> semiJoin <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">XXX</span> <span class="main">⊆</span> <span class="skolem">X</span>›</span></span> image_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∈</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zz</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="skolem">zz</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∈</span> restrict <span class="free">J</span> <span class="main">`</span> <span class="skolem">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="skolem">zz</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Int_absorb2 <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">J</span>›</span></span> restrict_nested subset_refl<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zz</span> <span class="main">=</span> <span class="skolem">zz</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>17<span class="main">)</span> rwf_query_def wf_atable_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">zz</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zz</span> <span class="main">=</span> <span class="skolem">zz</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="skolem">zz</span>›</span></span> calculation<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-simple_set_inter"><span class="command">lemma</span></span> simple_set_inter<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">f</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">⊆</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">∈</span> <span class="free">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">X</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="free">I</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> subsetI<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-union_restrict"><span class="command">lemma</span></span> union_restrict<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="free">z1</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">z2</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="free">z1</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">z2</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z1</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z2</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zz1</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz1</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z1</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zz2</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz2</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z2</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">z1</span> <span class="main">=</span> length <span class="free">z2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> length_restrict<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">z1</span> <span class="main">⟹</span> <span class="skolem">zz1</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="skolem">zz2</span><span class="main">!</span><span class="bound">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">z1</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz1</span><span class="main">!</span><span class="skolem">i</span> <span class="main">=</span> <span class="skolem">zz2</span><span class="main">!</span><span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="free">I</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> simple_restrict_none <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">z1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">z1</span> <span class="main">=</span> length <span class="free">z2</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
            nth_restrict zz1_def zz2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> simple_restrict_none UnE <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">z1</span>›</span></span> <span class="quoted"><span class="quoted">‹length <span class="free">z1</span> <span class="main">=</span> length <span class="free">z2</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span>
            nth_restrict zz1_def zz2_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">z1</span><span class="main">.</span> <span class="main">(</span>restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z1</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span> <span class="main">=</span> <span class="main">(</span>restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="free">z2</span><span class="main">)</span><span class="main">!</span><span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> zz1_def zz2_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> simple_list_index_equality <span class="quoted"><span class="quoted">‹length <span class="free">z1</span> <span class="main">=</span> length <span class="free">z2</span>›</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-partial_correctness_direct"><span class="command">lemma</span></span> partial_correctness_direct<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="free">J</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="free">I</span> <span class="main">(</span>filterQuery <span class="free">I</span> <span class="free">Q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="free">Q</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="free">I</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q_J_neg</span> <span class="main">=</span> filterQuery <span class="free">J</span> <span class="main">(</span><span class="free">Qn</span> <span class="main">-</span> <span class="free">Q_I_neg</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_I</span> <span class="main">=</span> genericJoin <span class="free">I</span> <span class="free">Q_I_pos</span> <span class="free">Q_I_neg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="free">R_I</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">R_NQ</span> <span class="main">=</span> genericJoin <span class="free">J</span> <span class="free">NQ_pos</span> <span class="free">NQ_neg</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">R_I</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="free">R_I</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="bound">y</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> <span class="free">R</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">CI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">CI</span> <span class="main">=</span> filterQuery <span class="free">I</span> <span class="free">Q</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zI</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zI</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> wf_tuple_restrict_simple zI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="skolem">zI</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_pos</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> projectQuery <span class="free">I</span> <span class="free">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_pos</span>›</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> Set.image <span class="main">(</span>restrict <span class="free">I</span><span class="main">)</span> <span class="skolem">XX</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">AA</span> <span class="main">∩</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>restrict <span class="skolem">AA</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">XX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>15<span class="main">)</span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zI</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inf.right_idem inf_commute restrict_nested zI_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_neg</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="skolem">zI</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_I_neg</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>15<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_I_neg</span>›</span></span> assms<span class="main">(</span>7<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> restrict <span class="skolem">A</span> <span class="skolem">zI</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> nested_include_restrict zI_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zI</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zI</span> <span class="main">∈</span> <span class="free">R_I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span>›</span></span> assms<span class="main">(</span>13<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">zJ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="skolem">zJ</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> wf_tuple_restrict_simple zJ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_J_pos</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>15<span class="main">)</span> assms<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NQ</span> <span class="main">=</span> newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_J_pos</span> <span class="main">⟹</span> <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="free">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span>›</span></span> assms<span class="main">(</span>16<span class="main">)</span> rwf_query_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">V</span> <span class="free">Q_J_pos</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> filterQuery.elims assms<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> included_def member_filter rwf_query_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>›</span></span> included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">A</span> <span class="main">(</span>restrict <span class="skolem">A</span> <span class="free">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> assms<span class="main"><span class="main">(</span></span>15<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> wf_tuple_restrict_simple<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>restrict <span class="skolem">A</span> <span class="free">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> isSame_equi_dev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">I</span></span> <span class="quoted"><span class="skolem">zI</span></span> <span class="quoted"><span class="skolem">A</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">∩</span> <span class="free">I</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nested_include_restrict assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> inf_le1 inf_le2 sup_ge1 zI_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> NQ_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">NQ</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="free">z</span> <span class="main">∈</span> <span class="skolem">XX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">X</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="free">z</span> <span class="main">∈</span> snd <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">X</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_pos</span> <span class="main">⟹</span> isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> <span class="free">I</span><span class="main">)</span> <span class="main">(</span>restrict <span class="bound">A</span> <span class="free">z</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="free">z</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>›</span></span> fst_conv inf.idem inf_commute
          projectTable.simps restrict_nested semiJoin.simps zJ_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="bound">y</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zI</span> <span class="main">∈</span> <span class="free">R_I</span>›</span></span> assms<span class="main">(</span>14<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">∈</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>
                     <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="skolem">zJ</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="bound">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NQ_def calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="skolem">zJ</span> <span class="main">∉</span> <span class="bound">X</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span>Set.image <span class="main">(</span><span class="main">λ</span><span class="bound">tab</span><span class="main">.</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="bound">tab</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">Q_J_neg</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> newQuery.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">AA</span></span> <span class="skolem"><span class="skolem">XX</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_neg</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">AA</span> <span class="main">∩</span> <span class="free">J</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_J_neg</span>›</span></span> assms<span class="main">(</span>8<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="free">z</span> <span class="main">∉</span> <span class="skolem">XX</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>15<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">∉</span> <span class="skolem">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">∈</span> Set.image <span class="main">(</span>restrict <span class="free">J</span><span class="main">)</span> <span class="main">(</span>Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span><span class="main">)</span> <span class="skolem">XX</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> projectTable.simps semiJoin.simps <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">=</span> projectTable <span class="free">J</span> <span class="main">(</span>semiJoin <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>›</span></span>
            inf_commute snd_conv<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">zz</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="skolem">zz</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zz</span> <span class="main">∈</span> <span class="main">(</span>Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span><span class="main">)</span> <span class="skolem">XX</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="skolem">AA</span> <span class="skolem">zJ</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> restrict_nested <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="skolem">AA</span> <span class="main">∩</span> <span class="free">J</span>›</span></span> zJ_def<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="free">z</span> <span class="main">=</span> <span class="skolem">zz</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">J</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="skolem">zz</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">J</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="free">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> restrict_nested <span class="quoted"><span class="quoted">‹restrict <span class="skolem">A</span> <span class="skolem">zJ</span> <span class="main">=</span> restrict <span class="skolem">AA</span> <span class="skolem">zJ</span>›</span></span>
              calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> inf_commute inf_left_idem zJ_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span> <span class="skolem">zz</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span><span class="main">)</span> <span class="skolem">XX</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">AA</span> <span class="skolem">zz</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q</span> <span class="main">∪</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation rwf_query_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zz</span> <span class="main">∈</span> Set.filter <span class="main">(</span>isSameIntersection <span class="skolem">zI</span> <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span><span class="main">)</span> <span class="skolem">XX</span>›</span></span> table_def wf_atable_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">AA</span> <span class="skolem">zz</span> <span class="main">=</span> <span class="skolem">zz</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> calculation<span class="main">(</span>3<span class="main">)</span> restrict_idle <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">⊆</span> <span class="free">V</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="free">V</span> <span class="free">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>16<span class="main">)</span> rwf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> included_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>16<span class="main">)</span> rwf_query_def wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span> <span class="skolem">zz</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span><span class="main">)</span> <span class="skolem">zI</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> isSame_equi_dev<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="skolem">AA</span></span> <span class="quoted"><span class="skolem">zz</span></span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quoted"><span class="quoted">"<span class="free">I</span> <span class="main">∩</span> <span class="skolem">AA</span>"</span></span><span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> isSame_equi_dev <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">I</span> <span class="skolem">zI</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
              calculation<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> inf_le1 inf_le2 sup_ge1<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="free">I</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="skolem">zz</span><span class="main">)</span> <span class="main">=</span> restrict <span class="free">I</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="free">z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> restrict_nested inf_le1 nested_include_restrict zI_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> restrict <span class="main">(</span><span class="free">I</span> <span class="main">∪</span> <span class="free">J</span><span class="main">)</span> <span class="main">(</span>restrict <span class="skolem">AA</span> <span class="skolem">zz</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> union_restrict calculation<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">AA</span> <span class="main">⊆</span> <span class="free">I</span> <span class="main">∪</span> <span class="free">J</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">AA</span><span class="main">,</span> <span class="skolem">XX</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Qn</span>›</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>16<span class="main"><span class="main">)</span></span> case_prodD included_def rwf_query_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> restrict_nested calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>7<span class="main"><span class="main">)</span></span> inf.absorb_iff2<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹restrict <span class="skolem">AA</span> <span class="free">z</span> <span class="main">∉</span> <span class="skolem">XX</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">zJ</span> <span class="main">∈</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="free">J</span> <span class="skolem">zJ</span>›</span></span> calculation<span class="main">(</span>3<span class="main">)</span> calculation<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> merge <span class="skolem">zJ</span> <span class="skolem">zI</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> restrict_partition_merge assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>15<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> zI_def zJ_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">zI</span><span class="main">,</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zI</span> <span class="main">∈</span> <span class="free">R_I</span>›</span></span> assms<span class="main">(</span>10<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">zJ</span> <span class="main">∈</span> genericJoin <span class="free">J</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_pos</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="free">J</span> <span class="free">Q_J_neg</span> <span class="main">(</span><span class="free">I</span><span class="main">,</span> <span class="skolem">zI</span><span class="main">)</span><span class="main">)</span>›</span></span> assms<span class="main">(</span>11<span class="main">)</span>
      calculation<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-obvious_forall"><span class="command">lemma</span></span> obvious_forall<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="free">X</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">∈</span><span class="free">X</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Generic_Join_Correctness-correctness"><span class="command">lemma</span></span> correctness<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>rwf_query <span class="free">n</span> <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span><span class="main">;</span> card <span class="free">V</span> <span class="main">≥</span> <span class="main">1</span><span class="main">⟧</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">z</span> <span class="main">∈</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="free">V</span> <span class="free">z</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">V</span></span> <span class="quoted"><span class="free">Q</span></span> <span class="quoted"><span class="free">Qn</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">z</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> genericJoin.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">≤</span> <span class="main">1</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>2<span class="main">)</span> True le_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> base_correctness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">Qn</span></span> <span class="quoted"><span class="quoted">"genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">I</span></span> <span class="skolem"><span class="skolem">J</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> surj_pair<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_I_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_I_pos</span> <span class="main">=</span> projectQuery <span class="skolem">I</span> <span class="main">(</span>filterQuery <span class="skolem">I</span> <span class="skolem">Q</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_I_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_I_neg</span> <span class="main">=</span> filterQueryNeg <span class="skolem">I</span> <span class="skolem">Qn</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R_I</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R_I</span> <span class="main">=</span> genericJoin <span class="skolem">I</span> <span class="skolem">Q_I_pos</span> <span class="skolem">Q_I_neg</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_J_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_J_neg</span> <span class="main">=</span> filterQuery <span class="skolem">J</span> <span class="main">(</span><span class="skolem">Qn</span> <span class="main">-</span> <span class="skolem">Q_I_neg</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q_J_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q_J_pos</span> <span class="main">=</span> filterQuery <span class="skolem">J</span> <span class="skolem">Q</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">t</span> <span class="main">.</span> <span class="bound">t</span> <span class="main">∈</span> <span class="skolem">R_I</span><span class="main">}</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> vars_genericJoin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">Qn</span></span> <span class="quoted"><span class="skolem">Q_I_pos</span></span> <span class="quoted"><span class="skolem">Q_I_neg</span></span> <span class="quoted"><span class="skolem">R_I</span></span> <span class="quoted"><span class="skolem">Q_J_neg</span></span> <span class="quoted"><span class="skolem">Q_J_pos</span></span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">R</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False Q_I_neg_def Q_I_pos_def Q_J_neg_def Q_J_pos_def R_I_def Suc_1 X_def
            <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> not_less_eq_eq<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">I</span> <span class="skolem">Q_I_pos</span> <span class="skolem">Q_I_neg</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False Q_I_neg_def Q_I_pos_def Suc_1 <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> getIJ.getIJProperties<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
            getIJ.wf_firstRecursiveCall getIJ_axioms not_less_eq_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">R_I</span> <span class="main">⟷</span>
  wf_tuple <span class="free">n</span> <span class="skolem">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>  <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q_I_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>1<span class="main">)</span> False Q_I_neg_def Q_I_pos_def R_I_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">R_I</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">y</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Suc_1 <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> getIJProperties<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> le_SucE nat_le_linear<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> Diff_subset False Q_J_neg_def Q_J_pos_def Suc_1 <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span>
              getIJ.wf_secondRecursiveCalls getIJ_axioms not_less_eq_eq<span class="main">)</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NQ_pos</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NQ_pos</span> <span class="main">=</span> newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NQ_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NQ_neg</span> <span class="main">=</span> newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ_pos</span> <span class="skolem">NQ_neg</span> <span class="main">⟷</span>
  wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">J</span> <span class="skolem">NQ_pos</span> <span class="skolem">NQ_neg</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> NQ_neg_def NQ_pos_def <span class="quoted"><span class="quoted">‹rwf_query <span class="free">n</span> <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ_pos</span> <span class="skolem">NQ_neg</span> <span class="main">⟷</span>
  wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="skolem">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.IH"</span><span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">Q_I_pos</span></span> <span class="quoted"><span class="skolem">Q_I_neg</span></span> <span class="quoted"><span class="skolem">R_I</span></span> <span class="quoted"><span class="skolem">Q_J_neg</span></span> <span class="quoted"><span class="skolem">Q_J_pos</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False NQ_neg_def NQ_pos_def Q_I_neg_def Q_I_pos_def Q_J_neg_def
                Q_J_pos_def R_I_def Suc_1 <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> calculation filter_Q_J_neg_same not_less_eq_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">y</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> NQ_neg_def NQ_pos_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">∪</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="main">(</span><span class="skolem">I</span> <span class="main">∩</span> <span class="skolem">J</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">I</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">J</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False Set.is_empty_def Suc_1 <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">J</span><span class="main">)</span> <span class="main">=</span> <span class="free">getIJ</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="skolem">V</span>›</span></span> coreProperties not_less_eq_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="main">⟹</span> wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> R_def <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">R_NQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="skolem">t</span> <span class="main">|</span> <span class="bound">xx</span> <span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="skolem">R_NQ</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">R_NQ</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">∈</span><span class="skolem">X</span><span class="main">.</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="bound">t</span> <span class="main">|</span><span class="bound">xx</span><span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="bound">x</span><span class="main">}</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> X_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NQ</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NQ</span> <span class="main">=</span> newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NQ_neg</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NQ_neg</span> <span class="main">=</span> newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R_NQ</span> <span class="main">=</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ</span> <span class="skolem">NQ_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NQ_def NQ_neg_def X_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">t</span><span class="main">,</span> <span class="skolem">R_NQ</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">xx</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> merge <span class="skolem">xx</span> <span class="skolem">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xx</span> <span class="main">∈</span> <span class="skolem">R_NQ</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">∈</span> <span class="main">{</span>merge <span class="bound">xx</span> <span class="skolem">t</span> <span class="main">|</span><span class="bound">xx</span><span class="main">.</span> <span class="bound">xx</span> <span class="main">∈</span> <span class="skolem">R_NQ</span><span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">R_NQ</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">tt</span><span class="main">∈</span><span class="skolem">R_I</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ</span> <span class="skolem">NQ_neg</span>
                         <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> NQ_def NQ_neg_def <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span>›</span></span> calculation<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span><span class="main">∈</span><span class="skolem">R_I</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span>›</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ</span> <span class="skolem">NQ_neg</span>
                         <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span>  <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> obvious_forall<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?x</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?X</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">R_I</span></span><span class="main">]</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R_NQ</span> <span class="main">=</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ</span> <span class="skolem">NQ_neg</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> partial_correctness<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">Q_I_pos</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">Q_J_pos</span></span> <span class="quoted"><span class="skolem">Q_I_neg</span></span> <span class="quoted"><span class="skolem">Qn</span></span> <span class="quoted"><span class="skolem">Q_J_neg</span></span> <span class="quoted"><span class="skolem">NQ</span></span> <span class="quoted"><span class="skolem">t</span></span> <span class="quoted"><span class="skolem">NQ_neg</span></span> <span class="quoted"><span class="skolem">R_NQ</span></span> <span class="quoted"><span class="skolem">R_I</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">z</span></span> <span class="quoted"><span class="skolem">xx</span></span><span class="main">]</span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> NQ_def NQ_neg_def Q_I_neg_def Q_I_pos_def Q_J_neg_def Q_J_pos_def
              <span class="quoted"><span class="quoted">‹<span class="skolem">R_NQ</span> <span class="main">=</span> genericJoin <span class="skolem">J</span> <span class="skolem">NQ</span> <span class="skolem">NQ_neg</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> <span class="skolem">R_NQ</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">NQ_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="quoted"><span class="quoted">‹<span class="skolem">t</span> <span class="main">∈</span> <span class="skolem">R_I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">xx</span> <span class="main">∈</span> <span class="skolem">R_NQ</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">z</span> <span class="main">=</span> merge <span class="skolem">xx</span> <span class="skolem">t</span>›</span></span> calculation<span class="main">(</span>1<span class="main">)</span> calculation<span class="main">(</span>3<span class="main">)</span> calculation<span class="main">(</span>4<span class="main">)</span> calculation<span class="main">(</span>5<span class="main">)</span> calculation<span class="main">(</span>6<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="main">⟹</span> <span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">R</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> partial_correctness_direct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">I</span></span> <span class="quoted"><span class="skolem">J</span></span> <span class="quoted"><span class="skolem">Q_I_pos</span></span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="skolem">Q_J_pos</span></span> <span class="quoted"><span class="skolem">Q_I_neg</span></span> <span class="quoted"><span class="skolem">Qn</span></span> <span class="quoted"><span class="skolem">Q_J_neg</span></span> <span class="quoted"><span class="skolem">R_I</span></span> <span class="quoted"><span class="skolem">X</span></span> <span class="quoted"><span class="skolem">R</span></span>
                <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="skolem">z</span></span><span class="main">]</span>
            <span class="quoted">"1.prems"</span><span class="main">(</span>1<span class="main">)</span> Q_I_neg_def Q_I_pos_def Q_J_neg_def Q_J_pos_def R_I_def R_def X_def
              <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">I</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">J</span>›</span></span> <span class="quoted"><span class="quoted">‹Set.is_empty <span class="main">(</span><span class="skolem">I</span> <span class="main">∩</span> <span class="skolem">J</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">V</span> <span class="main">=</span> <span class="skolem">I</span> <span class="main">∪</span> <span class="skolem">J</span>›</span></span>
              <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">t</span><span class="main">∈</span><span class="skolem">R_I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="bound">y</span> <span class="main">∈</span> genericJoin <span class="skolem">J</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="skolem">J</span> <span class="bound">y</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_pos</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span>newQuery <span class="skolem">J</span> <span class="skolem">Q_J_neg</span> <span class="main">(</span><span class="skolem">I</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">y</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">R_I</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="skolem">I</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q_I_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q_I_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="bound">x</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span>
              <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="skolem">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">R</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wf_set_finite"><span class="command">lemma</span></span> wf_set_finite<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="free">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms finite_nat_set_iff_bounded wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Generic_Join_Correctness-vars_wrapperGenericJoin"><span class="command">lemma</span></span> vars_wrapperGenericJoin<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Q</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q_pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Q_neg</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">V</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat set"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="free">Qn</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> query"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="free">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free">Q_neg</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Set.is_empty <span class="free">Q</span>"</span></span>
      <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span> genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms wrapperGenericJoin.simps
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">then</span>
      <span class="main">{}</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> Set.is_empty <span class="bound">Q</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free">Q_neg</span> <span class="keyword1">in</span>
        genericJoin <span class="bound">V</span> <span class="bound">Q</span> <span class="bound">Qn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> Set.is_empty <span class="bound">Q</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free">Q_neg</span> <span class="keyword1">in</span>
        genericJoin <span class="bound">V</span> <span class="bound">Q</span> <span class="bound">Qn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span> <span class="keyword1">in</span> Set.is_empty <span class="bound">Q</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span> <span class="keyword1">in</span>
      <span class="keyword1">if</span> Set.is_empty <span class="bound">Q</span> <span class="keyword1">then</span>
        <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>
      <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free">Q_neg</span> <span class="keyword1">in</span>
        genericJoin <span class="bound">V</span> <span class="bound">Q</span> <span class="bound">Qn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="bound">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="keyword1">in</span>
        <span class="keyword1">let</span> <span class="bound">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="bound">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free">Q_neg</span> <span class="keyword1">in</span>
        genericJoin <span class="bound">V</span> <span class="bound">Q</span> <span class="bound">Qn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span>genericJoin <span class="free">V</span> <span class="free">Q</span> <span class="free">Qn</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wrapperGenericJoin.simps assms<span class="main">(</span>5<span class="main">)</span> calculation <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Generic_Join_Correctness-wrapper_correctness"><span class="command">lemma</span></span> wrapper_correctness<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"card <span class="free">Q_pos</span> <span class="main">≥</span><span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="main">(</span><span class="free">Q_pos</span> <span class="main">∪</span> <span class="free">Q_neg</span><span class="main">)</span><span class="main">.</span> table <span class="free">n</span> <span class="bound">A</span> <span class="bound">X</span> <span class="main">∧</span> wf_set <span class="free">n</span> <span class="bound">A</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wrapperGenericJoin.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> Set.is_empty <span class="bound">X</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Set.is_empty_def case_prod_beta' empty_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> None"</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span>"</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Set.is_empty <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Set.is_empty <span class="skolem">A</span>›</span></span> table_empty unit_table_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Set.is_empty <span class="skolem">X</span>›</span></span> empty_table_def set_eq_subset<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span>›</span></span> <span class="quoted"><span class="quoted">‹Set.is_empty <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Set.is_empty <span class="skolem">X</span>›</span></span>
          <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Set.is_empty_def <span class="quoted"><span class="quoted">‹table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>›</span></span> case_prod_beta' empty_table_def
            in_unit_table inf_le1 inf_le2 prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snd_conv subset_empty table_empty wf_tuple_restrict_simple<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?r</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> forall<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span> <span class="main">∨</span> Set.is_empty <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="main">¬</span> Set.is_empty <span class="bound">A</span><span class="main">)</span> <span class="free">Q_pos</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> r_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span> <span class="main">-</span>  <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q_def Set.is_empty_def False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> empty_u<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Q_def SUP_bot_conv<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Set.is_empty_def True case_prod_beta' empty_iff member_filter<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∉</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span>›</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">A</span> <span class="main">=</span> <span class="main">{}</span>›</span></span> <span class="quoted"><span class="quoted">‹table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>›</span></span> table_empty unit_table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹card <span class="free">Q_pos</span> <span class="main">≥</span> <span class="main">1</span>›</span></span>
        <span class="keyword1"><span class="command">using</span></span> True card.empty not_one_le_zero <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot.extremum_uniqueI subrelI<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?r</span>›</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">X</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?v</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"replicate <span class="free">n</span> None"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> disj<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{}</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">∧</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∄</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">∧</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span> <span class="main">⊆</span> <span class="bound">X</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">X</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> x_neg<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="var">?v</span> <span class="main">∉</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∄</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">∧</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">∧</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span> <span class="main">⊆</span> <span class="bound">X</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> <span class="var">?r</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> r_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∈</span> <span class="main">(</span><span class="main">⋂</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?v</span> <span class="main">∉</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x_neg <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> notI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="var">?v</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span> empty_u wf_tuple_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> getIJ.restrict_index_out getIJ_axioms length_replicate length_restrict nth_replicate nth_restrict simple_list_index_equality<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> disj <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">=</span> replicate <span class="free">n</span> None›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Set.is_empty_def <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">X</span> <span class="bound">A</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">⟹</span> <span class="bound">X</span> <span class="main">⊆</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> forall <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span><span class="var">?v</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> <span class="var">?v</span> <span class="main">∉</span> <span class="bound">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> r_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">⟷</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">⟹</span> <span class="var">?b</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">=</span> <span class="var">?v</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> getIJ.restrict_index_out getIJ_axioms length_replicate length_restrict nth_replicate nth_restrict simple_list_index_equality<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> replicate <span class="free">n</span> None <span class="main">∉</span> <span class="bound">X</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">X</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span>
              <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">=</span> replicate <span class="free">n</span> None›</span></span> empty_u wf_tuple_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">⟹</span> <span class="var">?a</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>›</span></span> empty_u wf_tuple_empty <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> False_prev<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Q</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"covering <span class="skolem">V</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> V_def covering_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="skolem">V</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> included_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Qn</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">∧</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span><span class="main">)</span> <span class="free">Q_neg</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Qn</span> <span class="main">⊆</span> <span class="free">Q_neg</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="skolem">V</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="skolem">V</span> <span class="main">⟹</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">V</span>"</span></span>
          <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> V_def <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">V</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Q_pos</span> <span class="main">∪</span> <span class="free">Q_neg</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_set_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">Q</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">Q_pos</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> not_one_le_zero <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Suc_leI card_gt_0_iff<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∪</span> <span class="free">Q_neg</span><span class="main">)</span> <span class="main">⟹</span> wf_atable <span class="free">n</span> <span class="bound">Y</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">Y</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">∈</span> <span class="main">(</span><span class="skolem">Q</span> <span class="main">∪</span> <span class="free">Q_neg</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> case_prodE case_prodI2<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Q_def UnE Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="free">Q_neg</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> case_prodD member_filter sup_commute<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="skolem">A</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Q_def UnE Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="free">Q_neg</span>›</span></span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> case_prod_conv member_filter sup.commute<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> wf_set_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf_atable <span class="free">n</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Y</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span>›</span></span> wf_atable_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_query <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">Q</span> <span class="free">Q_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Un_iff <span class="quoted"><span class="quoted">‹<span class="skolem">Qn</span> <span class="main">⊆</span> <span class="free">Q_neg</span>›</span></span> subsetD wf_query_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">pp</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span>nat set <span class="main">×</span> <span class="tfree">'a</span> option list set<span class="main">)</span> set <span class="main">⇒</span> nat <span class="main">⇒</span> nat set <span class="main">×</span> <span class="tfree">'a</span> option list set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
          f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="bound">N</span> <span class="bound">P</span> <span class="bound">Pa</span><span class="main">.</span> <span class="main">(</span>wf_query <span class="bound">n</span> <span class="bound">N</span> <span class="bound">P</span> <span class="bound">Pa</span> <span class="main">∨</span> <span class="main">¬</span> <span class="main">1</span> <span class="main">≤</span> card <span class="bound">P</span> <span class="main">∨</span> <span class="main">¬</span> wf_set <span class="bound">n</span> <span class="bound">N</span> <span class="main">∨</span> <span class="main">¬</span> wf_atable <span class="bound">n</span> <span class="main">(</span><span class="skolem">pp</span> <span class="bound">Pa</span> <span class="bound">P</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">pp</span> <span class="bound">Pa</span> <span class="bound">P</span> <span class="bound">n</span> <span class="main">∈</span> <span class="bound">P</span> <span class="main">∪</span> <span class="bound">Pa</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">1</span> <span class="main">≤</span> card <span class="bound">P</span> <span class="main">∧</span> wf_set <span class="bound">n</span> <span class="bound">N</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p</span><span class="main">.</span> wf_atable <span class="bound">n</span> <span class="bound">p</span> <span class="main">∨</span> <span class="bound">p</span> <span class="main">∉</span> <span class="bound">P</span> <span class="main">∪</span> <span class="bound">Pa</span><span class="main">)</span> <span class="main">∨</span> <span class="main">¬</span> wf_query <span class="bound">n</span> <span class="bound">N</span> <span class="bound">P</span> <span class="bound">Pa</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> wf_query_def<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pp</span> <span class="skolem">Qn</span> <span class="skolem">Q</span> <span class="free">n</span> <span class="main">∈</span> <span class="skolem">Qn</span> <span class="main">⟶</span> <span class="skolem">pp</span> <span class="skolem">Qn</span> <span class="skolem">Q</span> <span class="free">n</span> <span class="main">∈</span> <span class="free">Q_neg</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">Qn</span> <span class="main">⊆</span> <span class="free">Q_neg</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pp</span> <span class="skolem">Qn</span> <span class="skolem">Q</span> <span class="free">n</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="free">Q_neg</span> <span class="main">∨</span> wf_query <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_set <span class="free">n</span> <span class="skolem">V</span>›</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">Q</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">⋀</span><span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">∪</span> <span class="free">Q_neg</span> <span class="main">⟹</span> wf_atable <span class="free">n</span> <span class="bound">Y</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_set <span class="free">n</span> <span class="skolem">V</span>›</span></span> f1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="skolem">Q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Q</span> <span class="main">⟹</span> card <span class="bound">A</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> asm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹included <span class="skolem">V</span> <span class="skolem">Q</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> case_prodD included_def subsetD wf_query_def wf_set_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_set_finite <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> One_nat_def Q_def Set.is_empty_def Suc_leI asm card_gt_0_iff case_prod_beta' member_filter prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Q_def case_prodE fst_conv member_filter non_empty_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"included <span class="skolem">V</span> <span class="skolem">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qn_def case_prod_beta' included_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"non_empty_query <span class="skolem">Qn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Qn_def case_prod_beta' non_empty_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rwf_query <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹included <span class="skolem">V</span> <span class="skolem">Q</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> calculation<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> rwf_query_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">V</span> <span class="main">≥</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">A</span></span> <span class="skolem"><span class="skolem">X</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Set.is_empty <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Q_def <span class="quoted"><span class="quoted">‹included <span class="skolem">V</span> <span class="skolem">Q</span>›</span></span> included_def member_filter prod.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> wf_set_finite <span class="quoted"><span class="quoted">‹wf_query <span class="free">n</span> <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> wf_query_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Set.is_empty_def Suc_leI <span class="quoted"><span class="quoted">‹<span class="main">¬</span> Set.is_empty <span class="skolem">A</span>›</span></span> card_gt_0_iff subset_empty<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="main">⟷</span> wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> correctness<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> <span class="var">?n</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">n</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?V</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">V</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?Q</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="skolem">Q</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> <span class="var">?z</span><span class="main"><span class="main">=</span></span><span class="quoted"><span class="free">z</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Qn</span> <span class="main">=</span> Set.filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span><span class="main">.</span> <span class="bound">A</span> <span class="main">⊆</span> <span class="skolem">V</span> <span class="main">∧</span> <span class="main">1</span> <span class="main">≤</span> card <span class="bound">A</span><span class="main">)</span> <span class="free">Q_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Qn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Set.is_empty <span class="skolem">Q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> False_prev Set.is_empty_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> Set.is_empty <span class="bound">X</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span><span class="main">∃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span><span class="main">.</span> Set.is_empty <span class="bound">A</span> <span class="main">∧</span> <span class="main">¬</span> Set.is_empty <span class="bound">X</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> forall <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> vars_wrapperGenericJoin<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">Q</span></span> <span class="quoted"><span class="free">Q_pos</span></span> <span class="quoted"><span class="skolem">V</span></span> <span class="quoted"><span class="skolem">Qn</span></span> <span class="quoted"><span class="free">Q_neg</span></span><span class="main">]</span> Q_def V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="skolem">A</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> DiffD1 DiffD2 Q_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span>›</span></span> case_prod_beta' member_filter prod.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> Set.is_empty <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> forall <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">X</span> <span class="main">=</span> <span class="main">{</span>replicate <span class="free">n</span> None<span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.is_empty_def empty_table_def table_empty unit_table_def<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">=</span> replicate <span class="free">n</span> None"</span></span>
          <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Set.is_empty <span class="skolem">A</span>›</span></span> wf_tuple_empty wf_tuple_restrict_simple
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Diff_Int2 Diff_Int_distrib2 Diff_eq_empty_iff Set.is_empty_def inf_le2<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> calculation<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span> <span class="main">⟹</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">A</span> <span class="skolem">X</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> notc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span>card <span class="skolem">A</span> <span class="main">≥</span> <span class="main">1</span> <span class="main">∧</span> <span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">V</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Qn_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">A</span> <span class="main">⊆</span> <span class="skolem">V</span>"</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">case</span></span> True
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">A</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Qn_def <span class="keyword1"><span class="command">using</span></span> notc <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Set.is_empty <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> DiffD1 Set.is_empty_def True <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="main">1</span> <span class="main">≤</span> card <span class="skolem">V</span>›</span></span> card_eq_0_iff forall notc prod.simps<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> rev_finite_subset<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Set.is_empty_def<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">case</span></span> False
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">V</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_set <span class="free">n</span> <span class="skolem">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> wf_set_def<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="skolem">A</span><span class="main">,</span> <span class="skolem">X</span><span class="main">)</span> <span class="main">∈</span> <span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
            <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zz</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"restrict <span class="skolem">A</span> <span class="free">z</span>"</span></span>
            <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?zz</span> <span class="main">∉</span> <span class="skolem">X</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zz</span> <span class="main">∈</span> <span class="skolem">X</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"wf_tuple <span class="free">n</span> <span class="skolem">A</span> <span class="var">?zz</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹table <span class="free">n</span> <span class="skolem">A</span> <span class="skolem">X</span>›</span></span> table_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?zz</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≠</span> None"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> calculation wf_tuple_def<span class="main">)</span>
            <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∉</span> <span class="skolem">V</span>›</span></span> wf_tuple_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
            <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
              <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">A</span>›</span></span> <span class="quoted"><span class="quoted">‹wf_tuple <span class="free">n</span> <span class="skolem">A</span> <span class="main">(</span>restrict <span class="skolem">A</span> <span class="free">z</span><span class="main">)</span>›</span></span> nth_restrict wf_tuple_length <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>
<span class="main">∧</span> wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span> <span class="bound">X</span><span class="main">.</span> <span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∈</span> <span class="main">(</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Q_def Set.is_empty_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> V_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span> <span class="main">∪</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">⟹</span> <span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Diff_iff <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span> <span class="main">-</span> <span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_neg</span> <span class="main">-</span> <span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">⟹</span> <span class="var">?a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Q_def Qn_def <span class="quoted"><span class="quoted">‹<span class="main">(</span><span class="free">z</span> <span class="main">∈</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>wf_tuple <span class="free">n</span> <span class="skolem">V</span> <span class="free">z</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Q</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∈</span> <span class="bound">X</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="skolem">Qn</span><span class="main">.</span> restrict <span class="bound">A</span> <span class="free">z</span> <span class="main">∉</span> <span class="bound">X</span><span class="main">)</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">V</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="main">(</span><span class="bound">A</span><span class="main">,</span> <span class="bound">X</span><span class="main">)</span><span class="main">∈</span><span class="free">Q_pos</span><span class="main">.</span> <span class="bound">A</span><span class="main">)</span>›</span></span> <span class="quoted"><span class="quoted">‹wrapperGenericJoin <span class="free">Q_pos</span> <span class="free">Q_neg</span> <span class="main">=</span> genericJoin <span class="skolem">V</span> <span class="skolem">Q</span> <span class="skolem">Qn</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Examples_Join">
<div class="head">
<h1>Theory Examples_Join</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Example instantiations and queries›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Examples_Join
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="Generic_Join.html">Generic_Join</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Instantiations›</span></span>

<span class="keyword1"><span class="command">global_interpretation</span></span> Max_getIJ<span class="main">:</span> getIJ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">V</span><span class="main">.</span> <span class="main">(</span><span class="bound">V</span> <span class="main">-</span> <span class="main">{</span>Max <span class="bound">V</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span>Max <span class="bound">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> Max_getIJ_genericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"Max_getIJ.genericJoin"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Max_getIJ_wrapperGenericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"Max_getIJ.wrapperGenericJoin"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> Diff_disjoint Max_in One_nat_def Pair_inject Suc_1 Suc_le_mono card.insert_remove card.empty card.infinite card_insert_disjoint finite.emptyI inf_commute insert_Diff insert_absorb insert_is_Un insert_not_empty le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_numeral_le_zero sup_commute<span class="main">)</span>


<span class="keyword1"><span class="command">global_interpretation</span></span> Min_getIJ<span class="main">:</span> getIJ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span> <span class="bound">V</span><span class="main">.</span> <span class="main">(</span><span class="main">{</span>Min <span class="bound">V</span><span class="main">}</span><span class="main">,</span> <span class="bound">V</span> <span class="main">-</span> <span class="main">{</span>Min <span class="bound">V</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">defines</span></span> Min_getIJ_genericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"Min_getIJ.genericJoin"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> Min_getIJ_wrapperGenericJoin <span class="main">=</span> <span class="quoted"><span class="quoted">"Min_getIJ.wrapperGenericJoin"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> Diff_disjoint Min_in One_nat_def Pair_inject Suc_1 card.insert_remove card.empty card.infinite card_insert_disjoint finite.emptyI insert_Diff insert_absorb insert_is_Un insert_not_empty le_numeral_extra<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_less_eq_eq not_numeral_le_zero<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Queries›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"Max_getIJ.genericJoin <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">1</span><span class="main">,</span> Some <span class="main">1</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> Some <span class="main">1</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">{}</span> <span class="main">::</span> nat table"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"Min_getIJ.genericJoin <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">}</span> <span class="main">{</span><span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span><span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">1</span><span class="main">,</span> Some <span class="main">1</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span> <span class="main">,</span> <span class="main">1</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> Some <span class="main">1</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">}</span> <span class="main">{}</span> <span class="main">::</span> nat table"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">protoTableTriangle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">protoTableTriangle</span> <span class="main">0</span> <span class="main">=</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">}</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">protoTableTriangle</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">protoTableTriangle</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">,</span> <span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> Some <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">auxInsertNoneTriangle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat tuple <span class="main">⇒</span> nat <span class="main">⇒</span> nat tuple"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">auxInsertNoneTriangle</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">0</span> <span class="main">=</span> None <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">auxInsertNoneTriangle</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="main">(</span><span class="free">auxInsertNoneTriangle</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">auxInsertNoneTriangle</span> <span class="main">[]</span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">=</span> undefined"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">insertNoneTriangle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat table <span class="main">⇒</span> nat <span class="main">⇒</span> nat table"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">insertNoneTriangle</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span>auxInsertNoneTriangle <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">|</span> <span class="bound">x</span> <span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"set <span class="main">[</span><span class="main">0</span> <span class="main">..&lt;</span> <span class="numeral">5</span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getTableTriangle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat atable"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getTableTriangle</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">}</span><span class="main">,</span> insertNoneTriangle <span class="main">(</span>protoTableTriangle <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">getQueryTriangle</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat query"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">getQueryTriangle</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">{</span>getTableTriangle <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span><span class="main">,</span> getTableTriangle <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">1</span><span class="main">,</span> getTableTriangle <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">verticesTriangle</span> <span class="main">::</span> <span class="quoted">vertices</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">verticesTriangle</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="main">1</span><span class="main">,</span> <span class="numeral">2</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"getQueryTriangle <span class="numeral">2</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"Max_getIJ.genericJoin verticesTriangle <span class="main">(</span>getQueryTriangle <span class="numeral">2</span><span class="main">)</span> <span class="main">{</span><span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">,</span> <span class="numeral">2</span><span class="main">}</span><span class="main">,</span> <span class="main">{</span><span class="main">[</span>Some <span class="main">0</span><span class="main">,</span> None<span class="main">,</span> Some <span class="main">0</span><span class="main">]</span><span class="main">}</span><span class="main">)</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">n</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">in</span> <span class="keyword1">let</span> <span class="main">(</span><span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">A</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">B</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="bound">C</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>getTableTriangle <span class="bound">n</span> <span class="main">0</span><span class="main">,</span> getTableTriangle <span class="bound">n</span> <span class="main">1</span><span class="main">,</span> getTableTriangle <span class="bound">n</span> <span class="numeral">2</span><span class="main">)</span> <span class="keyword1">in</span>
<span class="keyword1">let</span> <span class="bound">AB</span> <span class="main">=</span> join <span class="bound">A</span> True <span class="bound">B</span> <span class="keyword1">in</span> join <span class="bound">AB</span> True <span class="bound">C</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"Min_getIJ.wrapperGenericJoin <span class="main">(</span>getQueryTriangle <span class="numeral">2</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"Max_getIJ.wrapperGenericJoin <span class="main">(</span>getQueryTriangle <span class="numeral">2</span><span class="main">)</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"New_max.wrapperGenericJoin <span class="main">(</span>getQueryTriangle <span class="numeral">2</span><span class="main">)</span> <span class="main">{}</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>