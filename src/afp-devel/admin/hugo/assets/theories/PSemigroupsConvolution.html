<div id="Partial_Semigroups">
<div class="head">
<h1>Theory Partial_Semigroups</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Partial Semigroups
   Author: Brijesh Dongol, Victor Gomes, Ian J Hayes, Georg Struth
   Maintainer: Victor Gomes &lt;victor.gomes@cl.cam.ac.uk&gt;
               Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Partial Semigroups›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Partial_Semigroups
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>

<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">notation</span></span> times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">and</span></span> times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊕</span>"</span> 70<span class="main">)</span> 
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Semigroups›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this context, partiality is modelled by a definedness constraint $D$ instead of a bottom element, 
which would make the algebra total. This is common practice in mathematics.›</span></span>

<span class="keyword1"><span class="command">class</span></span> partial_times <span class="main">=</span> times <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">D</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The definedness constraints for associativity state that the right-hand side of the associativity
law is defined if and only if the left-hand side is and that, in this case, both sides are equal. This and
slightly different constraints can be found in the literature.›</span></span>

<span class="keyword1"><span class="command">class</span></span> partial_semigroup <span class="main">=</span> partial_times <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> add_assocD<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">y</span> <span class="free">z</span> <span class="main">∧</span> D <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟷</span> D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> D <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> add_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> D <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every semigroup is a partial semigroup.›</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> semigroup_mult <span class="main">⊆</span> sg<span class="main">:</span> partial_semigroup _ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> partial_semigroup 
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following abbreviation is useful for sublocale statements.›</span></span>
  
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="main">(</span>input<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">≡</span> D <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span>"</span></span>
  
<span class="keyword1" id="Partial_Semigroups-add_assocD_var1"><span class="command">lemma</span></span> add_assocD_var1<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">y</span> <span class="free">z</span> <span class="main">∧</span> D <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> D <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assocD<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-add_assocD_var2"><span class="command">lemma</span></span> add_assocD_var2<span class="main">:</span> <span class="quoted"><span class="quoted">" D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> D <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">⟹</span> D <span class="free">y</span> <span class="free">z</span> <span class="main">∧</span> D <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assocD<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-add_assoc_var"><span class="command">lemma</span></span> add_assoc_var<span class="main">:</span> <span class="quoted"><span class="quoted">" D <span class="free">y</span> <span class="free">z</span> <span class="main">∧</span> D <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_assoc add_assocD<span class="main">)</span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Green's Preorders and Green's Relations›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We define the standard Green's preorders and Green's relations. They are usually defined on monoids. 
  On (partial) semigroups, we only obtain transitive relations.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gR_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> D <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strict_gR_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≺<span class="hidden">⇩</span><sub>R</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≺<span class="hidden">⇩</span><sub>R</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gL_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> D <span class="bound">z</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strict_gL_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≺<span class="hidden">⇩</span><sub>L</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≺<span class="hidden">⇩</span><sub>L</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="main">¬</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gH_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>H</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>H</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gJ_rel</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">≼<span class="hidden">⇩</span><sub>J</sub></span>"</span> 50<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1"><span class="free">≼<span class="hidden">⇩</span><sub>J</sub></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> D <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> D <span class="main">(</span><span class="bound">v</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="bound">w</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⋅</span> <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gR</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> 
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gL</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gH</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>H</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>H</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">gJ</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>J</sub></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>J</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>  
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gR_downset</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="main">(</span><span class="quoted">"_<span class="keyword1">↓</span>"</span> <span class="main">[</span>100<span class="main">]</span>100<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main"><span class="free">↓</span></span> <span class="main">≡</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following counterexample rules out reflexivity.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span>"</span></span> <span class="comment1">(* nitpick [expect=genuine] *)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1" id="Partial_Semigroups-gR_rel_trans"><span class="command">lemma</span></span> gR_rel_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gR_rel_def add_assoc add_assocD_var2<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroups-gL_rel_trans"><span class="command">lemma</span></span> gL_rel_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gL_rel_def add_assocD_var1 add_assoc_var<span class="main">)</span> 
    
<span class="keyword1" id="Partial_Semigroups-gR_add_isol"><span class="command">lemma</span></span> gR_add_isol<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">z</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gR_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> add_assocD_var1 add_assoc_var <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1" id="Partial_Semigroups-gL_add_isor"><span class="command">lemma</span></span> gL_add_isor<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>    
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gL_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_assoc add_assocD_var2<span class="main">)</span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">annil</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">annil</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> D <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">annir</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">annir</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">.</span> D <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Morphisms›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ps_morphism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>partial_semigroup<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ps_morphism</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> D <span class="bound">x</span> <span class="bound">y</span> <span class="main">⟶</span> D <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strong_ps_morphism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>partial_semigroup<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strong_ps_morphism</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span>ps_morphism <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> D <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">⟶</span> D <span class="bound">x</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Locally Finite Partial Semigroups›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In locally finite partial semigroups,  elements can only be split in finitely many ways.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> locally_finite_partial_semigroup <span class="main">=</span> partial_semigroup <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> loc_fin<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="free">x</span><span class="main">↓</span><span class="main">)</span>"</span></span>
    
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cancellative Partial Semigroups›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> cancellative_partial_semigroup <span class="main">=</span> partial_semigroup <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_cancl<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">z</span> <span class="free">x</span> <span class="main">⟹</span> D <span class="free">z</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> add_cancr<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">z</span> <span class="main">⟹</span> D <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> 
    
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="Partial_Semigroups-unique_resl"><span class="command">lemma</span></span> unique_resl<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">z</span> <span class="main">⟹</span> D <span class="free">x</span> <span class="free">z'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z'</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_cancl<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroups-unique_resr"><span class="command">lemma</span></span> unique_resr<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">z</span> <span class="free">x</span> <span class="main">⟹</span> D <span class="free">z'</span> <span class="free">x</span>  <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z'</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> <span class="free">z'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_cancr<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-gR_rel_mult"><span class="command">lemma</span></span> gR_rel_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  
<span class="keyword1" id="Partial_Semigroups-gL_rel_mult"><span class="command">lemma</span></span> gL_rel_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gL_rel_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹By cancellation, the element z is uniquely defined for each pair x y, provided it exists.
       In both cases, z is therefore a function of x and y; it is a quotient or residual of x y.›</span></span>  
  
<span class="keyword1" id="Partial_Semigroups-quotr_unique"><span class="command">lemma</span></span> quotr_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span>  <span class="main">⟹</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">z</span><span class="main">.</span> D <span class="free">x</span> <span class="bound">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def add_cancl <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Partial_Semigroups-quotl_unique"><span class="command">lemma</span></span> quotl_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃!</span><span class="bound">z</span><span class="main">.</span> D <span class="bound">z</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gL_rel_def unique_resr <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
 
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rquot</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> D <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">z</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="bound">z</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">lquot</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">THE</span> <span class="bound">z</span><span class="main">.</span> D <span class="bound">z</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∧</span> <span class="bound">z</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
  
<span class="keyword1" id="Partial_Semigroups-rquot_prop"><span class="command">lemma</span></span> rquot_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> rquot <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> rquot_def the_equality unique_resl<span class="main">)</span>
  
<span class="keyword1" id="Partial_Semigroups-rquot_mult"><span class="command">lemma</span></span> rquot_mult<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> rquot <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def rquot_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Partial_Semigroups-rquot_D"><span class="command">lemma</span></span> rquot_D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">=</span> rquot <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> D <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def rquot_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Partial_Semigroups-add_rquot"><span class="command">lemma</span></span> add_rquot<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span>D <span class="free">x</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">z</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">z</span> <span class="main">=</span> rquot <span class="free">y</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def rquot_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
 
<span class="keyword1" id="Partial_Semigroups-add_canc1"><span class="command">lemma</span></span> add_canc1<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> rquot <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> rquot_prop <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
 
<span class="keyword1" id="Partial_Semigroups-add_canc2"><span class="command">lemma</span></span> add_canc2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span>rquot <span class="free">y</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def add_canc1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
<span class="keyword1" id="Partial_Semigroups-add_canc2_prop"><span class="command">lemma</span></span> add_canc2_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> rquot <span class="free">y</span> <span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gL_rel_mult rquot_D rquot_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The next set of lemmas establishes standard Galois connections for cancellative partial semigroups.›</span></span>
  
<span class="keyword1" id="Partial_Semigroups-gR_galois_imp1"><span class="command">lemma</span></span> gR_galois_imp1<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> rquot <span class="free">y</span> <span class="free">x</span>"</span></span>    
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gR_rel_def add_assoc add_assocD_var2 rquot_prop<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-gR_galois_imp21"><span class="command">lemma</span></span> gR_galois_imp21<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> rquot <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_add_isol rquot_D rquot_mult <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
   
<span class="keyword1" id="Partial_Semigroups-gR_galois_imp22"><span class="command">lemma</span></span> gR_galois_imp22<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> rquot <span class="free">y</span> <span class="free">x</span> <span class="main">⟹</span> D <span class="free">x</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def add_assocD add_canc1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Partial_Semigroups-gR_galois"><span class="command">lemma</span></span> gR_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span>D <span class="free">x</span> <span class="free">z</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟷</span> <span class="free">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> rquot <span class="free">y</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> gR_galois_imp1 gR_galois_imp21 gR_galois_imp22  <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Partial_Semigroups-gR_rel_defined"><span class="command">lemma</span></span> gR_rel_defined<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> D <span class="free">x</span> <span class="main">(</span>rquot <span class="free">y</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rquot_D<span class="main">)</span>
 
<span class="keyword1" id="Partial_Semigroups-ex_add_galois"><span class="command">lemma</span></span> ex_add_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">z</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">⟷</span> rquot <span class="bound">y</span> <span class="free">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> add_canc1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    

             
<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Monoids›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We allow partial monoids with multiple units. This is similar to and inspired by small categories.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> partial_monoid <span class="main">=</span> partial_semigroup <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">E</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unitl_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span><span class="main">.</span> D <span class="bound">e</span> <span class="free">x</span> <span class="main">∧</span> <span class="bound">e</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> unitr_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> <span class="free">E</span><span class="main">.</span> D <span class="free">x</span> <span class="bound">e</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">e</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> units_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> <span class="free">e2</span> <span class="main">∈</span> <span class="free">E</span> <span class="main">⟹</span> D <span class="free">e1</span> <span class="free">e2</span> <span class="main">⟹</span> <span class="free">e1</span> <span class="main">=</span> <span class="free">e2</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every monoid is a partial monoid.›</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> monoid_mult <span class="main">⊆</span> mon<span class="main">:</span> partial_monoid _ <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> True"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> partial_monoid 
<span class="keyword2"><span class="keyword">begin</span></span>
    
<span class="keyword1" id="Partial_Semigroups-units_eq_var"><span class="command">lemma</span></span> units_eq_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">e2</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">e1</span> <span class="main">≠</span> <span class="free">e2</span> <span class="main">⟹</span> <span class="main">¬</span> D <span class="free">e1</span> <span class="free">e2</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> units_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In partial monoids, Green's relations become preorders, but need not be partial orders.›</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> gR<span class="main">:</span> preorder <span class="quoted">gR_rel</span> <span class="quoted">strict_gR_rel</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_gR_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_def unitr_ex <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    
<span class="keyword1"><span class="command">sublocale</span></span> gL<span class="main">:</span> preorder <span class="quoted">gL_rel</span> <span class="quoted">strict_gL_rel</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> strict_gL_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> gL_rel_def unitl_ex <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> gL_rel_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">y</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="comment1">(* nitpick [expect=genuine] *)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"annil <span class="free">x</span> <span class="main">⟹</span> annil <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="comment1">(* nitpick [expext=genuine] *)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span>  <span class="quoted"><span class="quoted">"annir <span class="free">x</span> <span class="main">⟹</span> annir <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="comment1">(* nitpick [expect=genuine] *)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define partial monoid morphisms.›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pm_morphism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>partial_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>partial_monoid<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pm_morphism</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span>ps_morphism <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> E <span class="main">⟶</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> E<span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">strong_pm_morphism</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>partial_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>partial_monoid<span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">strong_pm_morphism</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> <span class="main">(</span>pm_morphism <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">e</span><span class="main">)</span> <span class="main">∈</span> E <span class="main">⟶</span> <span class="bound">e</span> <span class="main">∈</span> E<span class="main">)</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Partial Monoids with a single unit form a special case.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> partial_monoid_one <span class="main">=</span> partial_semigroup <span class="main">+</span> one <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> oneDl<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> oneDr<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="main">1</span> <span class="free">x</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> oner<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">1</span> <span class="main">=</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> onel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> pmo<span class="main">:</span> partial_monoid _ _ <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> oneDr onel oneDl oner<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cancellative Partial Monoids›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> cancellative_partial_monoid <span class="main">=</span> cancellative_partial_semigroup <span class="main">+</span> partial_monoid
  
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="Partial_Semigroups-canc_unitr"><span class="command">lemma</span></span> canc_unitr<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">e</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> E"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancl unitr_ex<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroups-canc_unitl"><span class="command">lemma</span></span> canc_unitl<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">e</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> E"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_cancr unitl_ex<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Positive Partial Monoids›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> positive_partial_monoid  <span class="main">=</span> partial_monoid <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> posl<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> E"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> posr<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">y</span> <span class="main">∈</span> E"</span></span>
  
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="Partial_Semigroups-pos_unitl"><span class="command">lemma</span></span> pos_unitl<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> posl posr unitr_ex units_eq_var<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroups-pos_unitr"><span class="command">lemma</span></span> pos_unitr<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> posl posr unitr_ex units_eq_var<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Positive Cancellative Partial Monoids›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> positive_cancellative_partial_monoid <span class="main">=</span> positive_partial_monoid <span class="main">+</span> cancellative_partial_monoid
  
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In positive cancellative monoids, the Green's relations are partial orders.›</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> pcpmR<span class="main">:</span> order <span class="quoted">gR_rel</span> <span class="quoted">strict_gR_rel</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gR_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> canc_unitr add_assoc add_assocD_var2 pos_unitl<span class="main">)</span>
    
<span class="keyword1"><span class="command">sublocale</span></span> pcpmL<span class="main">:</span> order <span class="quoted">gL_rel</span> <span class="quoted">strict_gL_rel</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> gL_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> canc_unitl add_assoc add_assocD_var1 pos_unitr<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹From Partial Abelian Semigroups to Partial Abelian Monoids›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define partial abelian semigroups. These are interesting, e.g., for the foundations
of quantum mechanics and as resource monoids in separation logic.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> pas <span class="main">=</span> partial_semigroup <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> add_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> D <span class="free">y</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊕</span> <span class="free">x</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Partial_Semigroups-D_comm"><span class="command">lemma</span></span> D_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟷</span> D <span class="free">y</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_comm<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-add_comm'"><span class="command">lemma</span></span> add_comm'<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊕</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_comm<span class="main">)</span>
  
<span class="keyword1" id="Partial_Semigroups-gL_gH_rel"><span class="command">lemma</span></span> gL_gH_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>L</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>H</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gH_rel_def gL_rel_def gR_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> add_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    
<span class="keyword1" id="Partial_Semigroups-gR_gH_rel"><span class="command">lemma</span></span> gR_gH_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>H</sub></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gH_rel_def gL_rel_def gR_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> add_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="Partial_Semigroups-annilr"><span class="command">lemma</span></span> annilr<span class="main">:</span> <span class="quoted"><span class="quoted">"annil <span class="free">x</span> <span class="main">=</span> annir <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annil_def annir_def add_comm<span class="main">)</span>
  
<span class="keyword1" id="Partial_Semigroups-anni_unique"><span class="command">lemma</span></span> anni_unique<span class="main">:</span> <span class="quoted"><span class="quoted">"annil <span class="free">x</span> <span class="main">⟹</span> annil <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> annilr annil_def annir_def<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following classes collect families of partially ordered abelian semigroups and monoids.›</span></span>

<span class="keyword1"><span class="command">class</span></span> locally_finite_pas <span class="main">=</span> pas <span class="main">+</span> locally_finite_partial_semigroup
  
<span class="keyword1"><span class="command">class</span></span> pam <span class="main">=</span> pas <span class="main">+</span> partial_monoid  
  
<span class="keyword1"><span class="command">class</span></span> cancellative_pam <span class="main">=</span> pam <span class="main">+</span> cancellative_partial_semigroup
  
<span class="keyword1"><span class="command">class</span></span> positive_pam <span class="main">=</span> pam <span class="main">+</span> positive_partial_monoid
  
<span class="keyword1"><span class="command">class</span></span> positive_cancellative_pam  <span class="main">=</span> positive_pam <span class="main">+</span> cancellative_pam
  
<span class="keyword1"><span class="command">class</span></span> generalised_effect_algebra <span class="main">=</span> pas <span class="main">+</span> partial_monoid_one
  
<span class="keyword1"><span class="command">class</span></span> cancellative_pam_one <span class="main">=</span> cancellative_pam <span class="main">+</span> partial_monoid_one
  
<span class="keyword1"><span class="command">class</span></span> positive_cancellative_pam_one <span class="main">=</span> positive_cancellative_pam  <span class="main">+</span> cancellative_pam_one

<span class="keyword1"><span class="command">context</span></span> cancellative_pam_one
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="Partial_Semigroups-E_eq_one"><span class="command">lemma</span></span> E_eq_one<span class="main">:</span> <span class="quoted"><span class="quoted">"E <span class="main">=</span> <span class="main">{</span><span class="main">1</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> oneDr oner unitl_ex units_eq singleton_iff subsetI subset_antisym<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-one_in_E"><span class="command">lemma</span></span> one_in_E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">∈</span> E"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E_eq_one<span class="main">)</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Alternative Definitions›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹PAS's can be axiomatised more compactly as follows.›</span></span>

<span class="keyword1"><span class="command">class</span></span> pas_alt <span class="main">=</span> partial_times <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pas_alt_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> D <span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span><span class="main">)</span> <span class="free">z</span> <span class="main">⟹</span> D <span class="free">y</span> <span class="free">z</span> <span class="main">∧</span> D <span class="free">x</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊕</span> <span class="free">z</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊕</span> <span class="free">z</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⊕</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊕</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> pas_alt_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> D <span class="free">y</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">⊕</span> <span class="free">x</span>"</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> pas_alt <span class="main">⊆</span> palt<span class="main">:</span> pas
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> pas_alt_assoc pas_alt_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Positive abelian PAM's can be axiomatised more compactly as well.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> pam_pos_alt <span class="main">=</span> pam <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> pos_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">e</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">x</span> <span class="main">⊕</span> <span class="free">y</span> <span class="main">=</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">e</span>"</span></span>
    
<span class="keyword1"><span class="command">sublocale</span></span> pam_pos_alt <span class="main">⊆</span> ppalt<span class="main">:</span> positive_pam 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> pos_alt <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> add_comm pos_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Product Constructions›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We consider two kinds of product construction. The first one combines partial semigroups with sets, 
        the second one partial semigroups with partial semigroups. The first one is interesting for 
        Separation Logic. Semidirect product constructions are considered later.›</span></span>
  
<span class="keyword1"><span class="command">instantiation</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">partial_semigroup</span><span class="main">)</span> <span class="quoted">partial_semigroup</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">D_prod</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">∧</span> D <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">x</span> <span class="free">y</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_prod</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">times_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_prod_def times_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> partial_semigroup_class.add_assocD <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.add_assoc<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">partial_monoid</span><span class="main">)</span> <span class="quoted">partial_monoid</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">E_prod</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">E_prod</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> snd <span class="bound">x</span> <span class="main">∈</span> E<span class="main">}</span>"</span></span>
  
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_prod_def times_prod_def E_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> partial_monoid_class.unitl_ex <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">using</span></span> partial_monoid_class.unitr_ex <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_monoid_class.units_eq prod_eq_iff<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">pas</span><span class="main">)</span> <span class="quoted">pas</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> D_prod_def times_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> pas_class.add_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Partial_Semigroups-prod_div1"><span class="command">lemma</span></span> prod_div1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x1</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="free">y1</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>pas<span class="main">)</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x2</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="free">y2</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>pas<span class="main">)</span> <span class="main">⟹</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.gR_rel_def times_prod_def<span class="main">)</span>
 
<span class="keyword1" id="Partial_Semigroups-prod_div2"><span class="command">lemma</span></span> prod_div2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">y1</span><span class="main">)</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x2</span><span class="main">,</span> <span class="free">y2</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y1</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.gR_rel_def D_prod_def times_prod_def<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroups-prod_div_eq"><span class="command">lemma</span></span> prod_div_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">y1</span><span class="main">)</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x2</span><span class="main">,</span> <span class="free">y2</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">x1</span> <span class="main">=</span> <span class="free">x2</span> <span class="main">∧</span> <span class="free">y1</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.gR_rel_def D_prod_def times_prod_def<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">pam</span><span class="main">)</span> <span class="quoted">pam</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span>

<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">cancellative_pam</span><span class="main">)</span> <span class="quoted">cancellative_pam</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_prod_def times_prod_def add_cancr add_cancl<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroups-prod_res_eq"><span class="command">lemma</span></span> prod_res_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">y1</span><span class="main">)</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="main">(</span><span class="free">x2</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span><span class="free">y2</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>cancellative_pam<span class="main">)</span> 
    <span class="main">⟹</span> rquot <span class="main">(</span><span class="free">x2</span><span class="main">,</span> <span class="free">y2</span><span class="main">)</span> <span class="main">(</span><span class="free">x1</span><span class="main">,</span> <span class="free">y1</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x1</span><span class="main">,</span> rquot <span class="free">y2</span> <span class="free">y1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.gR_rel_def D_prod_def times_prod_def rquot_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> theI2 conjI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">using</span></span> add_cancl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> the_equality<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> add_cancl<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">positive_pam</span><span class="main">)</span> <span class="quoted">positive_pam</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E_prod_def D_prod_def times_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> positive_partial_monoid_class.posl <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">using</span></span> positive_partial_monoid_class.posr <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
    
<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">positive_cancellative_pam</span><span class="main">)</span> <span class="quoted">positive_cancellative_pam</span> <span class="keyword1"><span class="command">..</span></span>
    
<span class="keyword1"><span class="command">instance</span></span> prod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">,</span> <span class="quoted">locally_finite_pas</span><span class="main">)</span> <span class="quoted">locally_finite_pas</span>    
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">s</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="skolem">x</span><span class="main">↓</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> loc_fin<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> D <span class="bound">y</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊕</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.gR_downset_def partial_semigroup_class.gR_rel_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> D <span class="bound">y</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊕</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> f<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> finite_image_set<span class="main">)</span> 
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z1</span> <span class="bound">z2</span><span class="main">.</span> D <span class="bound">y</span> <span class="main">(</span><span class="bound">z1</span><span class="main">,</span> <span class="bound">z2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊕</span> <span class="main">(</span><span class="bound">z1</span><span class="main">,</span> <span class="bound">z2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">}</span> 
                    <span class="main">⊆</span> <span class="main">{</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z</span><span class="main">.</span> D <span class="bound">y</span> <span class="bound">z</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊕</span> <span class="bound">z</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_prod_def times_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">z1</span> <span class="bound">z2</span><span class="main">.</span> D <span class="bound">y</span> <span class="main">(</span><span class="bound">z1</span><span class="main">,</span> <span class="bound">z2</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">⊕</span> <span class="main">(</span><span class="bound">z1</span><span class="main">,</span> <span class="bound">z2</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> finite_subset<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span><span class="main">(</span><span class="skolem">s</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span><span class="main">↓</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.gR_downset_def partial_semigroup_class.gR_rel_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we consider products of two partial semigroups.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ps_prod_D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> partial_semigroup <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> partial_semigroup <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps_prod_D</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> D <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> D <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ps_prod_times</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> partial_semigroup <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> partial_semigroup <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
   <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ps_prod_times</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> ps_prod<span class="main">:</span> partial_semigroup <span class="quoted">ps_prod_times</span> <span class="quoted">ps_prod_D</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ps_prod_D_def ps_prod_times_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">meson</span> partial_semigroup_class.add_assocD<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_semigroup_class.add_assoc<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> pas_prod<span class="main">:</span> pas <span class="quoted">ps_prod_times</span> <span class="quoted"><span class="quoted">"ps_prod_D <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> pas <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> pas <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>  <span class="main">⇒</span> bool"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ps_prod_D_def ps_prod_times_def pas_class.add_comm<span class="main">)</span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pm_prod_E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> partial_monoid <span class="main">×</span> <span class="tfree">'b</span> <span class="main">::</span> partial_monoid<span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pm_prod_E</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">∈</span> E <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">∈</span> E<span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> pm_prod<span class="main">:</span> partial_monoid <span class="quoted">ps_prod_times</span> <span class="quoted">ps_prod_D</span> <span class="quoted">pm_prod_E</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ps_prod_times_def ps_prod_D_def pm_prod_E_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> partial_monoid_class.unitl_ex prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> partial_monoid_class.unitr_ex prod.collapse<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> partial_monoid_class.units_eq prod.expand<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> pam_prod<span class="main">:</span> pam <span class="quoted">ps_prod_times</span> <span class="quoted">ps_prod_D</span> <span class="quoted"><span class="quoted">"pm_prod_E <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">::</span> pam <span class="main">×</span> <span class="tfree">'a</span> <span class="main">::</span> pam<span class="main">)</span> set"</span></span> <span class="keyword1"><span class="command">..</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Semigroup Actions and Semidirect Products›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹(Semi)group actions are a standard mathematical construction. We generalise this to partial
semigroups and monoids. We use it to define semidirect products of partial semigroups. A generalisation 
to wreath products might be added in the future.›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define the (left) action of a partial semigroup on a set. A right action could be defined in a similar way, 
but we do not pursue this at the moment.›</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> partial_sg_laction <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">Dla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">act</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1"><span class="keyword1">α</span></span>"</span><span class="main">)</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> act_assocD<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟷</span> <span class="free">Dla</span> <span class="free">y</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="free">x</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">y</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">x</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">y</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the action of a partial semigroup on another partial semigroup.
In the tradition of semigroup theory we use addition as a non-commutative operation for the second semigroup.›</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> partial_sg_sg_laction <span class="main">=</span> partial_sg_laction <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act_distribD<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="main">(</span><span class="free">p</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>partial_semigroup<span class="main">)</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>partial_semigroup<span class="main">)</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊕</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟷</span> <span class="free">Dla</span> <span class="free">x</span> <span class="free">p</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="free">x</span> <span class="free">q</span> <span class="main">∧</span> D <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">q</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> act_distrib<span class="main">:</span> <span class="quoted"><span class="quoted">"D <span class="free">p</span> <span class="free">q</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="free">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊕</span> <span class="free">q</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊕</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">q</span><span class="main">)</span>"</span></span>  
  
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the semidirect product as a partial operation and show that the semidirect 
product of two partial semigroups forms a partial semigroup.›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sd_D</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sd_D</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> D <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free">Dla</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> D <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sd_prod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sd_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">⊕</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>   
  
<span class="keyword1"><span class="command">sublocale</span></span> dp_semigroup<span class="main">:</span> partial_semigroup <span class="quoted">sd_prod</span> <span class="quoted">sd_D</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def sd_D_def<span class="main">)</span>  
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> act_assoc act_assocD act_distrib act_distribD add_assocD<span class="main">)</span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> act_assoc act_assocD act_distrib act_distribD add_assoc add_assocD<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we define the semigroup action for two partial monoids and show that the semidirect product of two partial monoids
is a partial monoid.›</span></span>

<span class="keyword1"><span class="command">locale</span></span> partial_mon_sg_laction <span class="main">=</span> partial_sg_sg_laction <span class="quoted"><span class="free">Dla</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Dla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>partial_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act_unitl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="free">Dla</span> <span class="free">e</span> <span class="free">p</span> <span class="main">∧</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">e</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span>

<span class="keyword1"><span class="command">locale</span></span> partial_mon_mon_laction <span class="main">=</span> partial_mon_sg_laction _ <span class="quoted"><span class="free">Dla</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">Dla</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>partial_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>partial_monoid <span class="main">⇒</span> bool"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act_annir<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">Ea</span> <span class="main">⟹</span> <span class="free">Dla</span> <span class="free">x</span> <span class="free">e</span> <span class="main">∧</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">e</span> <span class="main">=</span> <span class="free">e</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sd_E</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sd_E</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">∈</span> E <span class="main">∧</span> snd <span class="bound">x</span> <span class="main">∈</span> E<span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">sublocale</span></span> dp_semigroup <span class="main">:</span> partial_monoid <span class="quoted">sd_prod</span> <span class="quoted">sd_D</span> <span class="quoted">sd_E</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def sd_D_def sd_E_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> act_annir eq_fst_iff eq_snd_iff mem_Collect_eq partial_monoid_class.unitl_ex<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> act_annir eq_fst_iff eq_snd_iff partial_monoid_class.unitr_ex<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> act_annir partial_monoid_class.units_eq prod_eqI<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Partial_Semigroup_Models">
<div class="head">
<h1>Theory Partial_Semigroup_Models</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Models of Partial Semigroups
   Author: Brijesh Dongol, Victor Gomes, Ian J Hayes, Georg Struth
   Maintainer: Victor Gomes &lt;victor.gomes@cl.cam.ac.uk&gt;
               Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Models of Partial Semigroups›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Partial_Semigroup_Models
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Partial_Semigroups">Partial_Semigroups</a>
    
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹So far this section collects three models that we need for applications. Other interesting models might be
added in the future. These might include binary relations, formal power series and matrices, paths in graphs under fusion, 
program traces with alternating state and action symbols under fusion, partial orders under series and parallel products.›</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Partial Monoids of Segments and Intervals›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Segments of a partial order are sub partial orders between two points. Segments generalise
intervals in that intervals are segments in linear orders. We formalise segments and intervals as pairs, 
where the first coordinate is smaller than the second one. Algebras of segments and intervals are interesting 
in Rota's work on the foundations of combinatorics as well as for interval logics and duration calculi.›</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we define the subtype of ordered pairs of one single type.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> <span class="tfree">'a</span> dprod <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">::</span><span class="tfree">'a</span><span class="main">,</span> <span class="bound">y</span><span class="main">::</span><span class="tfree">'a</span><span class="main">)</span><span class="main">.</span> True<span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_dprod
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Such pairs form partial semigroups and partial monoids with respect to fusion.›</span></span>
  
<span class="keyword1"><span class="command">instantiation</span></span> dprod <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">partial_semigroup</span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">D_dprod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dprod <span class="main">⇒</span> <span class="tfree">'a</span> dprod <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">x</span> <span class="main">=</span> fst <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_dprod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dprod <span class="main">⇒</span> <span class="tfree">'a</span> dprod <span class="main">⇒</span> <span class="tfree">'a</span> dprod"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"dprod"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">partial_monoid</span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">E_dprod</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> dprod set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1"><span class="command">instance</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span><span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the type of segments.›</span></span>
  
<span class="keyword1"><span class="command">typedef</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">overloaded</span></span><span class="main">)</span> <span class="tfree">'a</span> segment <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>order <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>order<span class="main">)</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">≤</span> snd <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_segment
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Segments form partial monoids as well.›</span></span>
  
<span class="keyword1"><span class="command">instantiation</span></span> segment <span class="main">::</span> <span class="main">(</span><span class="quoted">order</span><span class="main">)</span> <span class="quoted">partial_monoid</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">E_segment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> segment set"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span><span class="main">.</span> fst <span class="bound">x</span> <span class="main">=</span> snd <span class="bound">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span> 

<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">D_segment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order segment <span class="main">⇒</span> <span class="tfree">'a</span> segment <span class="main">⇒</span> bool"</span></span> 
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">(</span>snd <span class="bound">x</span> <span class="main">=</span> fst <span class="bound">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    
<span class="keyword1"><span class="command">lift_definition</span></span> <span class="class_parameter">times_segment</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order segment <span class="main">⇒</span> <span class="tfree">'a</span> segment <span class="main">⇒</span> <span class="tfree">'a</span> segment"</span></span> 
  <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="keyword1">if</span> snd <span class="bound">x</span> <span class="main">=</span> fst <span class="bound">y</span> <span class="keyword1">then</span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">,</span> snd <span class="bound">y</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">instance</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the function segm that maps segments-as-pairs to segments-as-sets.›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">segm</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>order segment <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">segm</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> fst <span class="main">(</span>Rep_segment <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">∧</span> <span class="bound">y</span> <span class="main">≤</span> snd <span class="main">(</span>Rep_segment <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">}</span>"</span></span>
  
  <span class="keyword1"><span class="command">thm</span></span> Rep_segment

<span class="keyword1" id="Partial_Semigroup_Models-segm_sub_morph"><span class="command">lemma</span></span> segm_sub_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>Rep_segment <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>Rep_segment <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> segm <span class="free">x</span> <span class="main">∪</span> segm <span class="free">y</span> <span class="main">≤</span> segm <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> segm_def times_segment.rep_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Rep_segment dual_order.trans <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Rep_segment dual_order.trans mem_Collect_eq<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function segm is not generally a morphism.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>Rep_segment <span class="free">x</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>Rep_segment <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> segm <span class="free">x</span> <span class="main">∪</span> segm <span class="free">y</span> <span class="main">=</span> segm <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span>"</span></span> <span class="comment1">(* nitpick [expect=genuine] *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Intervals are segments over orders that satisfy Halpern and Shoham's  linear order property. This 
is still more general than linearity of the poset.›</span></span>

<span class="keyword1"><span class="command">class</span></span> lip_order <span class="main">=</span> order <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> lip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="bound">v</span> <span class="main">∧</span> <span class="bound">v</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≤</span> <span class="bound">w</span> <span class="main">∧</span> <span class="bound">w</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟶</span> <span class="bound">v</span> <span class="main">≤</span> <span class="bound">w</span> <span class="main">∨</span> <span class="bound">w</span> <span class="main">≤</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The function segm is now a morphism.›</span></span>
  
<span class="keyword1" id="Partial_Semigroup_Models-segm_morph"><span class="command">lemma</span></span> segm_morph<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>Rep_segment <span class="free">x</span><span class="main">::</span><span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>lip_order <span class="main">×</span> <span class="tfree">'a</span><span class="main">::</span>lip_order<span class="main">)</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>Rep_segment <span class="free">y</span><span class="main">)</span> 
    <span class="main">⟹</span> segm <span class="free">x</span> <span class="main">∪</span> segm <span class="free">y</span> <span class="main">=</span> segm <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> segm_def times_segment_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Abs_segment_inverse lip<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> lip order_trans<span class="main">)</span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Cancellative PAM's of Partial Functions›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We show that partial functions under disjoint union form a positive cancellative PAM. 
This is interesting for modeling the heap in separation logic.›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="tfree">'a</span> pfun <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> option"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ortho</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> pfun <span class="main">⇒</span> <span class="tfree">'a</span> pfun <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">ortho</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">≡</span> dom <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">∩</span> dom <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1" id="Partial_Semigroup_Models-pfun_comm"><span class="command">lemma</span></span> pfun_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"ortho <span class="free">x</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">++</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">++</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ortho_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> map_add_comm<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroup_Models-pfun_canc"><span class="command">lemma</span></span> pfun_canc<span class="main">:</span> <span class="quoted"><span class="quoted">"ortho <span class="free">z</span> <span class="free">x</span> <span class="main">⟹</span> ortho <span class="free">z</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">++</span> <span class="free">x</span> <span class="main">=</span> <span class="free">z</span> <span class="main">++</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ortho_def map_add_def option.case_eq_if fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> domIff dom_restrict option.collapse restrict_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> pfun<span class="main">:</span> positive_cancellative_pam_one <span class="quoted">map_add</span> <span class="quoted">ortho</span> <span class="quoted"><span class="quoted">"<span class="main">{</span>Map.empty<span class="main">}</span>"</span></span> <span class="quoted">Map.empty</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ortho_def pfun_canc<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf_commute map_add_comm ortho_def pfun_canc<span class="main">)</span>
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹PAM's of Disjoint Unions of Sets›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This simple disjoint union construction underlies important compositions of graphs or partial orders,
in particular in the context of complete joins and disjoint unions of graphs and of series and parallel products
of partial orders.›</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">pas</span>
<span class="keyword2"><span class="keyword">begin</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">D_set</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">D_set</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∩</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">{}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_set</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">times_set</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∪</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_set_def times_set_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">instantiation</span></span> set <span class="main">::</span> <span class="main">(</span><span class="quoted">type</span><span class="main">)</span> <span class="quoted">pam</span>
<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">E_set</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">E_set</span> <span class="main">=</span> <span class="main">{</span><span class="main">{}</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> D_set_def times_set_def E_set_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>


</pre>
</div><div id="Quantales">
<div class="head">
<h1>Theory Quantales</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Quantales
   Author: Brijesh Dongol, Victor Gomes, Ian J Hayes, Georg Struth
   Maintainer: Victor Gomes &lt;victor.gomes@cl.cam.ac.uk&gt;
               Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Quantales›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This entry will be merged eventually with other quantale entries and become a standalone one.›</span></span>
  
<span class="keyword1"><span class="command">theory</span></span> Quantales
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>

<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">notation</span></span> sup <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊔</span>"</span> 60<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> inf <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⊓</span>"</span> 55<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> top <span class="main">(</span><span class="quoted">"<span class="keyword1">⊤</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> bot <span class="main">(</span><span class="quoted">"<span class="keyword1">⊥</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> relcomp <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">;</span>"</span> 70<span class="main">)</span> 
  <span class="keyword2"><span class="keyword">and</span></span> times <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">⋅</span>"</span> 70<span class="main">)</span>
  <span class="keyword2"><span class="keyword">and</span></span> Sup <span class="main">(</span><span class="quoted">"<span class="keyword1">⨆</span>_"</span> <span class="main">[</span>900<span class="main">]</span> 900<span class="main">)</span>  
  <span class="keyword2"><span class="keyword">and</span></span> Inf <span class="main">(</span><span class="quoted">"<span class="keyword1">⨅</span>_"</span> <span class="main">[</span>900<span class="main">]</span> 900<span class="main">)</span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Properties of Complete Lattices›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_lattice<span class="main">)</span> Sup_sup_pred<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∨</span> <span class="free">P</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> order.antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_mono Sup_subset_mono Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Sup_least Sup_upper sup.coboundedI2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_lattice<span class="main">)</span> sup_Sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_lattice<span class="main">)</span> sup_Sup_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_mem_eq sup_Sup<span class="main">)</span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_boolean_algebra<span class="main">)</span> shunt1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span>  <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sup.mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_inf_distrib1<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">-</span> <span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">(</span><span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span><span class="main">)</span> <span class="main">⊓</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf_mono <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span>  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inf.boundedE inf_sup_distrib2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_boolean_algebra<span class="main">)</span> meet_shunt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊥</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bot_least inf_absorb2 inf_compl_bot_left2 shunt1 sup_absorb1<span class="main">)</span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> complete_boolean_algebra<span class="main">)</span> join_shunt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⊤</span> <span class="main">⟷</span> <span class="main">-</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> compl_sup compl_top_eq double_compl meet_shunt<span class="main">)</span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹ Familes of Proto-Quantales›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Proto-Quanales are complete lattices equipped with an operation of composition or multiplication
that need not be associative.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> proto_near_quantale <span class="main">=</span> complete_lattice <span class="main">+</span> times <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Sup_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="free">X</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1" id="Quantales-mult_botl"><span class="command">lemma</span></span> mult_botl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊥</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sup_distr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Quantales-sup_distr"><span class="command">lemma</span></span> sup_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sup_distr<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> X<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sup_eqI<span class="main">)</span>
    
<span class="keyword1" id="Quantales-mult_isor"><span class="command">lemma</span></span> mult_isor<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> sup.absorb_iff1 sup_distr<span class="main">)</span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixr</span></span> <span class="quoted">"<span class="keyword1">→</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main"><span class="free">→</span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infixl</span></span> <span class="quoted">"<span class="keyword1">←</span>"</span> 60<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main"><span class="free">←</span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Quantales-bres_galois_imp"><span class="command">lemma</span></span> bres_galois_imp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">→</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper bres_def<span class="main">)</span>
    
<span class="keyword1" id="Quantales-fres_galois"><span class="command">lemma</span></span> fres_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">←</span> <span class="free">y</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">←</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper fres_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">←</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main">}</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fres_def mult_isor<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">class</span></span> proto_pre_quantale <span class="main">=</span> proto_near_quantale <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">assumes</span></span> Sup_subdistl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span> <span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="free">Y</span>"</span></span>
    
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Quantales-sup_subdistl"><span class="command">lemma</span></span> sup_subdistl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sup_subdistl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span><span class="main">]</span> Sup_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Quantales-mult_isol"><span class="command">lemma</span></span> mult_isol<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⋅</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_iff_sup le_sup_iff sup_subdistl<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
    
<span class="keyword1"><span class="command">class</span></span> weak_proto_quantale <span class="main">=</span> proto_near_quantale <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> weak_Sup_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="free">Y</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span> 
  
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">subclass</span></span> proto_pre_quantale
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">have</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="bound">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Y</span><span class="main">.</span> <span class="bound">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="bound">Y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_Sup_distl<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">Y</span><span class="main">.</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="bound">Y</span><span class="main">}</span> <span class="main">≤</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="bound">Y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a b <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Quantales-sup_distl"><span class="command">lemma</span></span>  sup_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">z</span><span class="main">)</span>"</span></span>  
  <span class="keyword1"><span class="command">using</span></span> weak_Sup_distl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">y</span><span class="main">,</span> <span class="free">z</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sup_eqI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">→</span> <span class="free">z</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span>"</span></span> <span class="comment1">(* nitpick [expect = genuine] *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">class</span></span> proto_quantale <span class="main">=</span> proto_near_quantale <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> Sup_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="free">Y</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>  

<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subclass</span></span> weak_proto_quantale
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distl<span class="main">)</span>
    
<span class="keyword1" id="Quantales-bres_galois"><span class="command">lemma</span></span> bres_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">→</span> <span class="free">z</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">→</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper bres_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">→</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bres_def mult_isol<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="free">x</span> <span class="main">⋅</span> <span class="bound">y</span> <span class="main">≤</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">≤</span> <span class="free">z</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span> 
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Families of Quantales›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> near_quantale <span class="main">=</span> proto_near_quantale <span class="main">+</span> semigroup_mult 
  
<span class="keyword1"><span class="command">class</span></span> unital_near_quantale <span class="main">=</span> near_quantale <span class="main">+</span> monoid_mult

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">iter</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">iter</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">⨅</span><span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="main">∃</span><span class="bound">i</span><span class="main">.</span> <span class="bound">y</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="bound">i</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Quantales-iter_ref"><span class="command">lemma</span></span> iter_ref <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"iter <span class="free">x</span> <span class="main">≤</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> iter_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Inf_lower local.power.power_0 mem_Collect_eq<span class="main">)</span>
    
<span class="keyword1" id="Quantales-le_top"><span class="command">lemma</span></span> le_top<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">⊤</span> <span class="main">⋅</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_isor mult.monoid_axioms top_greatest monoid.left_neutral<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">class</span></span> pre_quantale <span class="main">=</span> proto_pre_quantale <span class="main">+</span> semigroup_mult 
  
<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> pre_quantale<span class="main">)</span> near_quantale <span class="keyword1"><span class="command">..</span></span>
  
<span class="keyword1"><span class="command">class</span></span> unital_pre_quantale <span class="main">=</span> pre_quantale <span class="main">+</span> monoid_mult
  
<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> unital_pre_quantale<span class="main">)</span> unital_near_quantale <span class="keyword1"><span class="command">..</span></span>
    
<span class="keyword1"><span class="command">class</span></span> weak_quantale <span class="main">=</span> weak_proto_quantale <span class="main">+</span> semigroup_mult
  
<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> weak_quantale<span class="main">)</span> pre_quantale <span class="keyword1"><span class="command">..</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following counterexample shows an important consequence of weakness: 
the absence of right annihilation.›</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> weak_quantale<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="comment1">(*nitpick[expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">class</span></span> unital_weak_quantale <span class="main">=</span> weak_quantale <span class="main">+</span> monoid_mult
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> unital_weak_quantale<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span> <span class="comment1">(*nitpick[expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
  
<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> unital_weak_quantale<span class="main">)</span> unital_pre_quantale <span class="keyword1"><span class="command">..</span></span>
    
<span class="keyword1"><span class="command">class</span></span> quantale <span class="main">=</span> proto_quantale <span class="main">+</span> semigroup_mult 
  
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">subclass</span></span> weak_quantale <span class="keyword1"><span class="command">..</span></span>   

<span class="keyword1" id="Quantales-mult_botr"><span class="command">lemma</span></span> mult_botr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⋅</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> Sup_distl<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> Y<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"<span class="main">{}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">class</span></span> unital_quantale <span class="main">=</span> quantale <span class="main">+</span> monoid_mult

<span class="keyword1"><span class="command">subclass</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> unital_quantale<span class="main">)</span> unital_weak_quantale <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">class</span></span> ab_quantale <span class="main">=</span> quantale <span class="main">+</span> ab_semigroup_mult

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Quantales-bres_fres_eq"><span class="command">lemma</span></span> bres_fres_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">→</span> <span class="free">y</span> <span class="main">=</span> <span class="free">y</span> <span class="main">←</span> <span class="free">x</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fres_def bres_def mult_commute<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> ab_unital_quantale <span class="main">=</span> ab_quantale <span class="main">+</span> unital_quantale
  
<span class="keyword1"><span class="command">class</span></span> distrib_quantale <span class="main">=</span> quantale <span class="main">+</span> complete_distrib_lattice
  
<span class="keyword1"><span class="command">class</span></span> bool_quantale <span class="main">=</span> quantale <span class="main">+</span> complete_boolean_algebra 
  
<span class="keyword1"><span class="command">class</span></span> distrib_unital_quantale <span class="main">=</span> unital_quantale <span class="main">+</span> complete_distrib_lattice
  
<span class="keyword1"><span class="command">class</span></span> bool_unital_quantale <span class="main">=</span> unital_quantale <span class="main">+</span> complete_boolean_algebra 
  
<span class="keyword1"><span class="command">class</span></span> distrib_ab_quantale <span class="main">=</span> distrib_quantale <span class="main">+</span> ab_quantale
  
<span class="keyword1"><span class="command">class</span></span> bool_ab_quantale <span class="main">=</span> bool_quantale <span class="main">+</span> ab_quantale
  
<span class="keyword1"><span class="command">class</span></span> distrib_ab_unital_quantale <span class="main">=</span> distrib_quantale <span class="main">+</span> unital_quantale
  
<span class="keyword1"><span class="command">class</span></span> bool_ab_unital_quantale <span class="main">=</span> bool_ab_quantale <span class="main">+</span> unital_quantale
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quantales of Booleans and Complete Boolean Algebras›</span></span>
  
<span class="keyword1"><span class="command">instantiation</span></span> bool <span class="main">::</span> <span class="quoted">bool_ab_unital_quantale</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">one_bool</span></span> <span class="main">=</span> True"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">times_bool</span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∧</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_bool_def one_bool_def<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">context</span></span> complete_distrib_lattice
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">interpretation</span></span> cdl_quantale<span class="main">:</span> distrib_quantale _ _ _ _ _ _ _ _ <span class="quoted">inf</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf.assoc Setcompr_eq_image Sup_inf inf_Sup<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span> complete_boolean_algebra
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> cba_quantale<span class="main">:</span> bool_ab_unital_quantale <span class="quoted">inf</span> _ _ _ _ _ _ _ _ _ _ <span class="quoted">top</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inf.commute<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image Sup_inf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image inf_Sup<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In this setting, residuation can be translated like classical implication.›</span></span>
  
<span class="keyword1" id="Quantales-cba_bres1"><span class="command">lemma</span></span> cba_bres1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">⊓</span> <span class="free">y</span> <span class="main">≤</span> <span class="free">z</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> cba_quantale.bres <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cba_quantale.bres_galois inf.commute <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    
<span class="keyword1" id="Quantales-cba_bres2"><span class="command">lemma</span></span> cba_bres2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">-</span><span class="free">y</span> <span class="main">⊔</span> <span class="free">z</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">≤</span> cba_quantale.bres <span class="free">y</span> <span class="free">z</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cba_bres1 shunt1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="Quantales-cba_bres_prop"><span class="command">lemma</span></span> cba_bres_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"cba_quantale.bres <span class="free">x</span> <span class="free">y</span> <span class="main">=</span> <span class="main">-</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> cba_bres2 order.eq_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  
<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Other models will follow.›</span></span>
  
   
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Products of Quantales›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Inf_prod</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⨅</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">⨅</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">inf_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊓</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊓</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">bot_prod</span> <span class="main">=</span> <span class="main">(</span>bot<span class="main">,</span>bot<span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">Sup_prod</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">,</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span>  <span class="bound">x</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">X</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sup_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">top_prod</span> <span class="main">=</span> <span class="main">(</span>top<span class="main">,</span>top<span class="main">)</span>"</span></span>
    
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_eq_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> less_eq <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> less_eq <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">less_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">≡</span> less_eq <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> less_eq <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≠</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span>"</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">times_prod'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">one_prod</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">interpretation</span></span> prod<span class="main">:</span> complete_lattice <span class="quoted">Inf_prod</span> <span class="quoted">Sup_prod</span> <span class="quoted">inf_prod</span> <span class="quoted">less_eq_prod</span> <span class="quoted">less_prod</span> <span class="quoted">sup_prod</span> <span class="quoted">bot_prod</span> <span class="quoted"><span class="quoted">"top_prod <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>complete_lattice <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_prod_def Sup_prod_def inf_prod_def sup_prod_def bot_prod_def top_prod_def less_eq_prod_def less_prod_def Sup_distl Sup_distr<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Inf_lower<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> prod<span class="main">:</span> proto_near_quantale <span class="quoted">Inf_prod</span> <span class="quoted">Sup_prod</span> <span class="quoted">inf_prod</span> <span class="quoted">less_eq_prod</span> <span class="quoted">less_prod</span> <span class="quoted">sup_prod</span> <span class="quoted">bot_prod</span> <span class="quoted"><span class="quoted">"top_prod <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>proto_near_quantale <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span>"</span></span> <span class="quoted">times_prod'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_prod'_def Sup_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distr<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarify</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    
<span class="keyword1"><span class="command">interpretation</span></span> prod<span class="main">:</span> proto_quantale <span class="quoted">Inf_prod</span> <span class="quoted">Sup_prod</span> <span class="quoted">inf_prod</span> <span class="quoted">less_eq_prod</span> <span class="quoted">less_prod</span> <span class="quoted">sup_prod</span> <span class="quoted">bot_prod</span> <span class="quoted"><span class="quoted">"top_prod <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>proto_quantale <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>proto_quantale<span class="main">)</span>"</span></span> <span class="quoted">times_prod'</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_prod'_def Sup_prod_def less_eq_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distl<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> prod<span class="main">:</span> unital_quantale <span class="quoted">one_prod</span> <span class="quoted">times_prod'</span> <span class="quoted">Inf_prod</span> <span class="quoted">Sup_prod</span> <span class="quoted">inf_prod</span> <span class="quoted">less_eq_prod</span> <span class="quoted">less_prod</span> <span class="quoted">sup_prod</span> <span class="quoted">bot_prod</span> <span class="quoted"><span class="quoted">"top_prod <span class="main">::</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">::</span>unital_quantale <span class="main">×</span> <span class="tfree">'b</span><span class="main">::</span>unital_quantale<span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_prod_def times_prod'_def mult.assoc<span class="main">)</span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Quantale Modules and Semidirect Products›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Quantale modules are extensions of semigroup actions in that a quantale acts on a complete lattice.›</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> unital_quantale_module <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">act</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>unital_quantale <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>complete_lattice <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">α</span>"</span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> act1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">y</span> <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> act2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">1</span> <span class="free">p</span> <span class="main">=</span> <span class="free">p</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> act3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="main">⨆</span><span class="free">X</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="bound">x</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> act4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="main">⨆</span><span class="free">P</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="bound">p</span> <span class="main">|</span><span class="bound">p</span><span class="main">.</span> <span class="bound">p</span> <span class="main">∈</span> <span class="free">P</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">context</span></span> unital_quantale_module
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Actions are morphisms. The curried notation is particularly convenient for this.›</span></span>
  
<span class="keyword1" id="Quantales-act_morph1"><span class="command">lemma</span></span> act_morph1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">⋅</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">∘</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff act1<span class="main">)</span>
    
<span class="keyword1" id="Quantales-act_morph2"><span class="command">lemma</span></span> act_morph2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">1</span> <span class="main">=</span> id"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  
<span class="keyword1" id="Quantales-emp_act"><span class="command">lemma</span></span> emp_act<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="main">⨆</span><span class="main">{}</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> act3<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    
<span class="keyword1" id="Quantales-emp_act_var"><span class="command">lemma</span></span> emp_act_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">⊥</span> <span class="free">p</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> emp_act <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Quantales-act_emp"><span class="command">lemma</span></span> act_emp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> act4<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
    
<span class="keyword1" id="Quantales-act_emp_var"><span class="command">lemma</span></span> act_emp_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">⊥</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> act_emp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  
<span class="keyword1" id="Quantales-act_sup_distl"><span class="command">lemma</span></span> act_sup_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊔</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">q</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="free">p</span> <span class="main">⊔</span> <span class="free">q</span><span class="main">)</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="free">p</span><span class="main">,</span><span class="free">q</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="free">p</span><span class="main">,</span><span class="free">q</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> act4<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">p</span> <span class="main">∨</span> <span class="bound">v</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_disj_eq Sup_insert ccpo_Sup_singleton insert_def singleton_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Quantales-act_sup_distr"><span class="command">lemma</span></span> act_sup_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">y</span> <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="free">p</span>  <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">)</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="bound">v</span> <span class="free">p</span> <span class="main">|</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">∈</span> <span class="main">{</span><span class="free">x</span><span class="main">,</span><span class="free">y</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> act3<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">v</span><span class="main">.</span> <span class="bound">v</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="free">p</span> <span class="main">∨</span> <span class="bound">v</span> <span class="main">=</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">y</span> <span class="free">p</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> empty_iff insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Collect_disj_eq Sup_insert ccpo_Sup_singleton insert_def singleton_conv<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Quantales-act_sup_distr_var"><span class="command">lemma</span></span> act_sup_distr_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="free">x</span> <span class="main">⊔</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff act_sup_distr<span class="main">)</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Next we define the semidirect product of a  unital quantale and a complete lattice. ›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sd_prod</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">=</span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⋅</span> fst <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">,</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
   
<span class="keyword1" id="Quantales-sd_distr_aux"><span class="command">lemma</span></span> sd_distr_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">⊔</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sup_least<span class="main">)</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">pa</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">⊔</span> <span class="bound">b</span> <span class="main">=</span> snd <span class="bound">pa</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">pa</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">⊔</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span>snd <span class="bound">pa</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">pa</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">pa</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">pa</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper sup.bounded_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>  
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span> <span class="bound">pa</span><span class="main">.</span> <span class="bound">b</span> <span class="main">⊔</span> <span class="skolem">x</span> <span class="main">=</span> snd <span class="bound">pa</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">pa</span><span class="main">)</span> <span class="free">p</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">X</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">⊔</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span>snd <span class="bound">pa</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">pa</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">pa</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">pa</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper le_supE<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span> <span class="main">⊔</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="free">p</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper mem_Collect_eq sup.coboundedI1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper mem_Collect_eq sup.coboundedI2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Quantales-sd_distr"><span class="command">lemma</span></span> sd_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"sd_prod <span class="main">(</span>Sup_prod <span class="free">X</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> Sup_prod <span class="main">{</span>sd_prod <span class="bound">x</span> <span class="free">y</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sd_prod <span class="main">(</span>Sup_prod <span class="free">X</span><span class="main">)</span> <span class="free">y</span> <span class="main">=</span> sd_prod <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">,</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="free">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⋅</span> fst <span class="free">y</span><span class="main">,</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span>  <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">⋅</span> fst <span class="free">y</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span>  <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> 
    <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">⋅</span> fst <span class="free">y</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span><span class="main">⨆</span> <span class="main">{</span>snd <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> act3<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">x</span> <span class="main">⋅</span> fst <span class="free">y</span><span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">,</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> sd_distr_aux<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Sup_prod <span class="main">{</span><span class="main">(</span>fst <span class="bound">x</span> <span class="main">⋅</span> fst <span class="free">y</span><span class="main">,</span> snd <span class="bound">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="bound">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="free">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">X</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Quantales-sd_distl_aux"><span class="command">lemma</span></span> sd_distl_aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> sup_least<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="free">p</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">pa</span><span class="main">)</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">∧</span> <span class="free">p</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">pa</span><span class="main">)</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>  
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xa</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">∈</span> <span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">b</span> <span class="main">=</span> <span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">pa</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">xa</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">b</span><span class="main">.</span> <span class="bound">b</span> <span class="main">∈</span> <span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">pa</span><span class="main">)</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">∧</span> <span class="skolem">xa</span> <span class="main">≤</span> <span class="bound">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xa</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">pa</span><span class="main">)</span> <span class="main">|</span><span class="bound">pa</span><span class="main">.</span> <span class="bound">pa</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Sup_upper2<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">⨆</span><span class="main">{</span><span class="free">p</span> <span class="main">⊔</span> <span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">⊔</span> <span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="free">x</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_le_iff le_sup_iff mem_Collect_eq sup_ge1 sup_ge2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Quantales-sd_distl"><span class="command">lemma</span></span> sd_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> sd_prod <span class="free">x</span> <span class="main">(</span>Sup_prod <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> Sup_prod <span class="main">{</span>sd_prod <span class="free">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">Y</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sd_prod <span class="free">x</span> <span class="main">(</span>Sup_prod <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> sd_prod <span class="free">x</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">,</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>snd <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="free">x</span> <span class="main">⋅</span> fst <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>snd <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="free">x</span> <span class="main">⋅</span> fst <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">,</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> act4<span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span>fst <span class="free">x</span> <span class="main">⋅</span> fst <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">,</span> <span class="main">⨆</span><span class="main">{</span>snd <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> a sd_distl_aux <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> Sup_prod <span class="main">{</span><span class="main">(</span>fst <span class="free">x</span> <span class="main">⋅</span> fst <span class="bound">y</span><span class="main">,</span> snd <span class="free">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="keyword1"><span class="free">α</span></span> <span class="main">(</span>fst <span class="free">x</span><span class="main">)</span> <span class="main">(</span>snd <span class="bound">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_prod_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sd_unit</span> <span class="main">=</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="main">⊥</span><span class="main">)</span>"</span></span>
 
<span class="keyword1" id="Quantales-sd_unitl"><span class="command">lemma</span></span> sd_unitl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sd_prod sd_unit <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def sd_unit_def<span class="main">)</span>    
    
<span class="keyword1" id="Quantales-sd_unitr"><span class="command">lemma</span></span> sd_unitr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sd_prod <span class="free">x</span> sd_unit <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def sd_unit_def<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> act_emp <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
   
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following counterexamples rule out that semidirect products of quantales and complete lattices form quantales.
The reason is that the right annihilation law fails.›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sd_prod <span class="free">x</span> <span class="main">(</span>Sup_prod <span class="free">Y</span><span class="main">)</span> <span class="main">=</span> Sup_prod <span class="main">{</span>sd_prod <span class="free">x</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">Y</span><span class="main">}</span>"</span></span> <span class="comment1">(*nitpick[show_all,expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"sd_prod <span class="free">x</span> bot_prod <span class="main">=</span> bot_prod"</span></span> <span class="comment1">(*nitpick[show_all,expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹However we can show that semidirect products of (unital) quantales with complete lattices form weak (unital) quantales. ›</span></span>
    
<span class="keyword1"><span class="command">interpretation</span></span> dp_quantale<span class="main">:</span> weak_quantale <span class="quoted">sd_prod</span> <span class="quoted">Inf_prod</span> <span class="quoted">Sup_prod</span> <span class="quoted">inf_prod</span> <span class="quoted">less_eq_prod</span> <span class="quoted">less_prod</span> <span class="quoted">sup_prod</span> <span class="quoted">bot_prod</span> <span class="quoted">top_prod</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_distl sd_distr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sd_prod_def Inf_prod_def Sup_prod_def bot_prod_def sup_prod_def top_prod_def inf_prod_def less_eq_prod_def less_prod_def<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> act1 act_sup_distl sup_assoc<span class="main">)</span> 
    
<span class="keyword1"><span class="command">interpretation</span></span> dpu_quantale<span class="main">:</span> unital_weak_quantale <span class="quoted">sd_unit</span> <span class="quoted">sd_prod</span> <span class="quoted">Inf_prod</span> <span class="quoted">Sup_prod</span> <span class="quoted">inf_prod</span> <span class="quoted">less_eq_prod</span> <span class="quoted">less_prod</span> <span class="quoted">sup_prod</span> <span class="quoted">bot_prod</span> <span class="quoted">top_prod</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  


</pre>
</div><div id="Binary_Modalities">
<div class="head">
<h1>Theory Binary_Modalities</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Binary Modalities
   Author: Brijesh Dongol, Victor Gomes, Ian J Hayes, Georg Struth
   Maintainer: Victor Gomes &lt;victor.gomes@cl.cam.ac.uk&gt;
               Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Binary Modalities and Relational Convolution›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Binary_Modalities
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Quantales">Quantales</a>

<span class="keyword2"><span class="keyword">begin</span></span>
 
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary Properties›</span></span>
  
<span class="keyword1" id="Binary_Modalities-SUP_is_Sup"><span class="command">lemma</span></span> SUP_is_Sup<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="free">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span><span class="main">::</span><span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="free">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">f</span> <span class="free">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">∈</span> <span class="free">F</span> <span class="main">⟹</span> <span class="skolem">f</span> <span class="free">y</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">f</span> <span class="free">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="free">y</span><span class="main">)</span> <span class="main">≤</span> <span class="main">⨆</span><span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="free">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">f</span> <span class="free">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span> <span class="main">⟹</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="free">y</span><span class="main">)</span> "</span></span>
    <span class="keyword1"><span class="command">using</span></span> mk_disjoint_insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Sup <span class="main">{</span><span class="main">(</span><span class="bound">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="free">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span> <span class="main">≤</span> <span class="main">(</span><span class="keyword1">SUP</span> <span class="bound">f</span><span class="main">∈</span><span class="free">F</span><span class="main">.</span> <span class="bound">f</span> <span class="free">y</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Setcompr_eq_image<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_auxl"><span class="command">lemma</span></span> bmod_auxl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="free">z</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">f</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="free">y</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">f</span> <span class="free">y</span> <span class="main">⋅</span> <span class="free">g</span> <span class="free">z</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">F</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Binary_Modalities-bmod_auxr"><span class="command">lemma</span></span> bmod_auxr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="free">f</span> <span class="free">y</span> <span class="main">⋅</span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound">g</span><span class="main">.</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">g</span> <span class="free">z</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">f</span> <span class="free">y</span> <span class="main">⋅</span> <span class="bound">g</span> <span class="free">z</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1" id="Binary_Modalities-bmod_assoc_aux1"><span class="command">lemma</span></span> bmod_assoc_aux1<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">w</span><span class="main">}</span> 
     <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">y</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">∧</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">w</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  
<span class="keyword1" id="Binary_Modalities-bmod_assoc_aux2"><span class="command">lemma</span></span> bmod_assoc_aux2<span class="main">:</span>   
  <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">w</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">v</span> <span class="bound">w</span><span class="main">}</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span> 
     <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">w</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">w</span> <span class="bound">y</span><span class="main">.</span> <span class="free">R</span> <span class="bound">y</span> <span class="bound">v</span> <span class="bound">w</span> <span class="main">∧</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Binary Modalities›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Most of the development in the papers mentioned in the introduction generalises to proto-near-quantales. Binary modalities 
are interesting for various substructural logics over ternary Kripke frames. They also arise, e.g., 
as chop modalities in interval logics or as separation conjunction in separation logic. Binary modalities can be understood as a convolution
operation parametrised by a ternary operation. Our development yields a 
unifying framework.›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We would prefer a notation that is more similar to our articles, that is, $f\ast_R g$, but we don' know how we could 
index an infix operator by a variable in Isabelle.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bmod_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊗</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊗</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span> <span class="main">⋅</span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bmod_bres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊲</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊲</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">⨅</span><span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">z</span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bmod_fres</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> bool<span class="main">)</span>  <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">⊳</span>"</span><span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="main"><span class="free">⊳</span></span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">⨅</span><span class="main">{</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span> <span class="bound">y</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="bound">z</span><span class="main">}</span>"</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_un_rel"><span class="command">lemma</span></span> bmod_un_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="main">(</span><span class="free">R</span> <span class="main">⊔</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊗</span> <span class="free">R</span> <span class="main">⊔</span> <span class="main">⊗</span> <span class="free">S</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span>  <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff bmod_comp_def Sup_union_distrib<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> Collect_disj_eq<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1" id="Binary_Modalities-bmod_Un_rel"><span class="command">lemma</span></span> bmod_Un_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="main">(</span><span class="main">⨆</span><span class="free">ℛ</span><span class="main">)</span> <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⊗</span> <span class="bound">R</span> <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">|</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">∈</span> <span class="free">ℛ</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper mem_Collect_eq<span class="main">)</span>
    
<span class="keyword1" id="Binary_Modalities-bmod_sup_fun1"><span class="command">lemma</span></span> bmod_sup_fun1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">⊔</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">g</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff bmod_comp_def sup_distr<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> le_supI1 Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> le_supI2 Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_Sup_fun1"><span class="command">lemma</span></span> bmod_Sup_fun1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="main">(</span><span class="main">⨆</span><span class="free">ℱ</span><span class="main">)</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⊗</span> <span class="free">R</span> <span class="bound">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ℱ</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ℱ</span><span class="main">}</span><span class="main">)</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="bound">f</span> <span class="bound">y</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ℱ</span><span class="main">}</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def SUP_is_Sup<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="bound">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ℱ</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distr bmod_auxl<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="bound">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ℱ</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span> <span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_sup_fun2"><span class="command">lemma</span></span> bmod_sup_fun2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_proto_quantale<span class="main">)</span> <span class="main">(</span><span class="free">g</span> <span class="main">⊔</span> <span class="free">h</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="main">⊔</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">h</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff bmod_comp_def sup_distl<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> le_supI1 Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> le_supI2 Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
 
<span class="keyword1" id="Binary_Modalities-bmod_Sup_fun2_weak"><span class="command">lemma</span></span> bmod_Sup_fun2_weak<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">𝒢</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span><span class="free">𝒢</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="bound">g</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_proto_quantale<span class="main">)</span> <span class="free">x</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span><span class="main">.</span> <span class="main">{</span><span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">g</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def SUP_is_Sup<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> weak_Sup_distl<span class="main"><span class="main">[</span></span><span class="operator">OF</span> set<span class="main"><span class="main">]</span></span> bmod_auxr<span class="main">)</span>           
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Binary_Modalities-bmod_Sup_fun2"><span class="command">lemma</span></span> bmod_Sup_fun2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span><span class="free">𝒢</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="bound">g</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_quantale<span class="main">)</span> <span class="free">x</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="main">⨆</span><span class="main">{</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  bmod_comp_def SUP_is_Sup<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distl bmod_auxr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span>  <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">⋅</span> <span class="bound">g</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">𝒢</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_comp_bres_galois"><span class="command">lemma</span></span> bmod_comp_bres_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⊲</span> <span class="free">R</span> <span class="free">f</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="comment1">(* nitpick[expect=genuine] *)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following Galois connection requires functions into proto-quantales.›</span></span>
    
<span class="keyword1" id="Binary_Modalities-bmod_comp_bres_galois"><span class="command">lemma</span></span> bmod_comp_bres_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊗</span> <span class="free">R</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_quantale<span class="main">)</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⊲</span> <span class="free">R</span> <span class="free">f</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectI Sup_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span>  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">g</span> <span class="bound">z</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">→</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bres_galois<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff bmod_bres_def<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">using</span></span> le_Inf_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectI le_Inf_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 

<span class="keyword1" id="Binary_Modalities-bmod_comp_fres_galois"><span class="command">lemma</span></span> bmod_comp_fres_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">⊳</span> <span class="free">R</span> <span class="free">h</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectI Sup_le_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span>  <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">⟶</span> <span class="free">f</span> <span class="bound">y</span> <span class="main">≤</span> <span class="main">(</span><span class="free">h</span> <span class="bound">x</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fres_galois<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_fres_def fun_eq_iff<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command">using</span></span> le_Inf_iff <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> CollectI le_Inf_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> 
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relational Convolution and Correspondence Theory›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹We now fix a ternary relation $\rho$ and can then hide the parameter in a convolution-style notation.›</span></span>
  
<span class="keyword1"><span class="command">class</span></span> rel_magma <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">ρ</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> bool"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">times_rel_fun</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">infix</span></span> <span class="quoted">"<span class="keyword1">⋆</span>"</span> 70<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main"><span class="free">⋆</span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span> <span class="main">=</span> <span class="main">⊗</span> ρ <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">g</span></span></span>"</span></span>
  
<span class="keyword1" id="Binary_Modalities-rel_fun_Sup_distl_weak"><span class="command">lemma</span></span> rel_fun_Sup_distl_weak<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">G</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_proto_quantale<span class="main">)</span> <span class="main">⋆</span> <span class="main">⨆</span><span class="free">G</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="main">⋆</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span> 
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">f</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">G</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> set"</span></span> 
  <span class="keyword3"><span class="command">assume</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">G</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">⋆</span> <span class="main">⨆</span><span class="skolem">G</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="skolem">f</span> <span class="main">⋆</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="skolem">G</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff times_rel_fun_def bmod_Sup_fun2_weak<span class="main"><span class="main">[</span></span><span class="operator">OF</span> a<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="Binary_Modalities-rel_fun_Sup_distl"><span class="command">lemma</span></span> rel_fun_Sup_distl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_quantale<span class="main">)</span> <span class="main">⋆</span> <span class="main">⨆</span><span class="free">G</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="main">⋆</span> <span class="bound">g</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff times_rel_fun_def bmod_Sup_fun2<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Binary_Modalities-rel_fun_Sup_distr"><span class="command">lemma</span></span> rel_fun_Sup_distr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⨆</span><span class="free">G</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_near_quantale<span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="bound">g</span> <span class="main">⋆</span> <span class="free">f</span> <span class="main">|</span><span class="bound">g</span><span class="main">.</span> <span class="bound">g</span> <span class="main">∈</span> <span class="free">G</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff times_rel_fun_def bmod_Sup_fun1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> rel_semigroup <span class="main">=</span> rel_magma <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">y</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="free">u</span> <span class="free">v</span> <span class="main">∧</span> ρ <span class="free">x</span> <span class="bound">y</span> <span class="free">w</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∃</span><span class="bound">z</span><span class="main">.</span> ρ <span class="bound">z</span> <span class="free">v</span> <span class="free">w</span> <span class="main">∧</span> ρ <span class="free">x</span> <span class="free">u</span> <span class="bound">z</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick produces counterexamples even for weak quantales. 
Hence one cannot generally lift functions into weak quantales to weak quantales.›</span></span>
  
<span class="keyword1" id="Binary_Modalities-bmod_assoc"><span class="command">lemma</span></span> bmod_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="main">(</span><span class="main">⊗</span> ρ <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale<span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊗</span> ρ <span class="free">f</span> <span class="main">(</span><span class="main">⊗</span> ρ <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="comment1">(*nitpick[show_all,expect=genuine]*)</span>
    <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_assoc"><span class="command">lemma</span></span> bmod_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="main">(</span><span class="main">⊗</span> ρ <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>quantale<span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊗</span> ρ <span class="free">f</span> <span class="main">(</span><span class="main">⊗</span> ρ <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="main">(</span><span class="main">⊗</span> ρ <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def Sup_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">Sup</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">Sup</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">∧</span> ρ <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_assoc_aux1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">z</span> <span class="bound">y</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">v</span> <span class="bound">z</span> <span class="main">∧</span> ρ <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rel_assoc <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rel_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">v</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">y</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_assoc_aux2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="main">{</span><span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">v</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">y</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_distl mult.assoc<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">Sup</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">Sup</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Binary_Modalities-rel_fun_assoc"><span class="command">lemma</span></span> rel_fun_assoc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>quantale<span class="main">)</span> <span class="main">⋆</span> <span class="free">g</span><span class="main">)</span> <span class="main">⋆</span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋆</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_rel_fun_def fun_eq_iff bmod_assoc<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="main">(</span><span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">f</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="main">(</span><span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="comment1">(*apply (simp add: bmod_comp_def) nitpick[expect=genuine] *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">class</span></span> rel_monoid <span class="main">=</span> rel_semigroup <span class="main">+</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free"><span class="free"><span class="free">ξ</span></span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> set"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> unitl_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> <span class="free">ξ</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">e</span> <span class="free">x</span>"</span></span> 
  <span class="keyword2"><span class="keyword">and</span></span> unitr_ex<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">e</span> <span class="main">∈</span> <span class="free">ξ</span><span class="main">.</span> ρ <span class="free">x</span> <span class="free">x</span> <span class="bound">e</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> unitl_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">ξ</span> <span class="main">⟹</span> ρ <span class="free">x</span> <span class="free">e</span> <span class="free">y</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> unitr_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e</span> <span class="main">∈</span> <span class="free">ξ</span> <span class="main">⟹</span> ρ <span class="free">x</span> <span class="free">y</span> <span class="free">e</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>

<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Binary_Modalities-xi_prop"><span class="command">lemma</span></span> xi_prop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">e1</span> <span class="main">∈</span> ξ <span class="main">⟹</span> <span class="free">e2</span> <span class="main">∈</span> ξ <span class="main">⟹</span> <span class="free">e1</span> <span class="main">≠</span> <span class="free">e2</span> <span class="main">⟹</span> <span class="main">¬</span> ρ <span class="free">x</span> <span class="free">e1</span> <span class="free">e2</span> <span class="main">∧</span> <span class="main">¬</span> ρ <span class="free">x</span> <span class="free">e2</span> <span class="free">e1</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> unitl_eq unitr_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">pid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span>  <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_weak_quantale"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">δ</span>"</span><span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="free">δ</span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">∈</span> ξ <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Due to the absence of right annihilation, the right unit law fails for functions into weak quantales.›</span></span>
  
<span class="keyword1" id="Binary_Modalities-bmod_onel"><span class="command">lemma</span></span> bmod_onel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="free">f</span> <span class="main">(</span><span class="keyword1">δ</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_weak_quantale<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span> 
<span class="comment1">(*nitpick[expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A unital quantale is required for this lifting.›</span></span>
    
<span class="keyword1" id="Binary_Modalities-bmod_onel"><span class="command">lemma</span></span> bmod_onel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="free">f</span> <span class="main">(</span><span class="keyword1">δ</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_quantale<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def pid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bres_galois<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> unitr_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bot.extremum<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper mem_Collect_eq unitr_ex<span class="main">)</span>

<span class="keyword1" id="Binary_Modalities-bmod_oner"><span class="command">lemma</span></span>  bmod_oner<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="keyword1">δ</span> <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def pid_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fres_galois<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> unitl_eq <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> bot.extremum<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Sup_upper mem_Collect_eq unitl_ex<span class="main">)</span>

<span class="keyword1" id="Binary_Modalities-pid_unitl"><span class="command">lemma</span></span> pid_unitl <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">δ</span> <span class="main">⋆</span> <span class="free">f</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff times_rel_fun_def bmod_oner<span class="main">)</span>

<span class="keyword1" id="Binary_Modalities-pid_unitr"><span class="command">lemma</span></span> pid_unitr <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">⋆</span> <span class="main">(</span><span class="keyword1">δ</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_quantale<span class="main">)</span> <span class="main">=</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff times_rel_fun_def bmod_onel<span class="main">)</span>
    
<span class="keyword1" id="Binary_Modalities-bmod_assoc_weak_aux"><span class="command">lemma</span></span> bmod_assoc_weak_aux<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="free">u</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="main">{</span><span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="free">y</span> <span class="bound">v</span> <span class="bound">z</span><span class="main">}</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale<span class="main">)</span> <span class="free">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="free">y</span> <span class="bound">v</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">subst</span> weak_Sup_distl<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> unitl_ex <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> mult.assoc<span class="main">)</span>
    
<span class="keyword1" id="Binary_Modalities-bmod_assoc_weak"><span class="command">lemma</span></span> bmod_assoc_weak<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="main">(</span><span class="main">⊗</span> ρ <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale<span class="main">)</span> <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊗</span> ρ <span class="free">f</span> <span class="main">(</span><span class="main">⊗</span> ρ <span class="free">g</span> <span class="free">h</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="main">(</span><span class="main">⊗</span> ρ <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">u</span> <span class="bound">v</span><span class="main">}</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_comp_def Sup_distr<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> exI conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> f <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">Sup</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">and</span></span></span> g <span class="main"><span class="main">=</span></span> <span class="quoted"><span class="quoted">Sup</span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword">in</span></span></span> cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">u</span> <span class="bound">v</span> <span class="main">∧</span> ρ <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_assoc_aux1<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">v</span> <span class="bound">z</span> <span class="bound">y</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">v</span> <span class="bound">z</span> <span class="main">∧</span> ρ <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rel_assoc <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> rel_assoc <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">v</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">y</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_assoc_aux2<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">u</span> <span class="main">⋅</span> <span class="main">⨆</span><span class="main">{</span><span class="free">g</span> <span class="bound">v</span> <span class="main">⋅</span> <span class="free">h</span> <span class="bound">z</span> <span class="main">|</span><span class="bound">v</span> <span class="bound">z</span><span class="main">.</span> ρ <span class="bound">y</span> <span class="bound">v</span> <span class="bound">z</span><span class="main">}</span> <span class="main">|</span><span class="bound">u</span> <span class="bound">y</span><span class="main">.</span> ρ <span class="free">x</span> <span class="bound">u</span> <span class="bound">y</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bmod_assoc_weak_aux<span class="main">)</span> 
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bmod_comp_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword1" id="Binary_Modalities-rel_fun_assoc_weak"><span class="command">lemma</span></span> rel_fun_assoc_weak<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale<span class="main">)</span> <span class="main">⋆</span> <span class="free">g</span><span class="main">)</span> <span class="main">⋆</span> <span class="free">h</span> <span class="main">=</span> <span class="free">f</span> <span class="main">⋆</span> <span class="main">(</span><span class="free">g</span> <span class="main">⋆</span> <span class="free">h</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_rel_fun_def fun_eq_iff bmod_assoc_weak<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">in</span></span> rel_semigroup<span class="main">)</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">id</span><span class="main">.</span> <span class="main">∀</span><span class="bound">f</span> <span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⊗</span> ρ <span class="bound">f</span> <span class="bound">id</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">∧</span> <span class="main">⊗</span> ρ <span class="bound">id</span> <span class="bound">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
<span class="comment1">(* apply (simp add: bmod_comp_def) nitpick [expect=genuine] *)</span>
  <span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1"><span class="command">class</span></span> rel_ab_semigroup <span class="main">=</span> rel_semigroup <span class="main">+</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> rel_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"ρ <span class="free">x</span> <span class="free">y</span> <span class="free">z</span> <span class="main">⟹</span>  ρ <span class="free">x</span> <span class="free">z</span> <span class="free">y</span>"</span></span> 

<span class="keyword2"><span class="keyword">begin</span></span> 

<span class="keyword1" id="Binary_Modalities-bmod_comm"><span class="command">lemma</span></span> bmod_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ab_quantale<span class="main">)</span> <span class="free">g</span> <span class="main">=</span> <span class="main">⊗</span> ρ <span class="free">g</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff bmod_comp_def mult.commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> rel_comm<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> ρ <span class="free">f</span> <span class="free">g</span> <span class="main">=</span> <span class="main">⊗</span> ρ <span class="free">g</span> <span class="free">f</span>"</span></span> <span class="comment1">(* nitpick [expect=genuine] *)</span>
<span class="keyword1"><span class="command">oops</span></span>

<span class="keyword1" id="Binary_Modalities-bmod_bres_fres_eq"><span class="command">lemma</span></span> bmod_bres_fres_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊲</span> ρ <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ab_quantale<span class="main">)</span> <span class="free">g</span> <span class="main">=</span> <span class="main">⊳</span> ρ <span class="free">g</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff bmod_bres_def bmod_fres_def bres_fres_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">meson</span> rel_comm<span class="main">)</span>

<span class="keyword1" id="Binary_Modalities-rel_fun_comm"><span class="command">lemma</span></span> rel_fun_comm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ab_quantale<span class="main">)</span> <span class="main">⋆</span> <span class="free">g</span> <span class="main">=</span> <span class="free">g</span> <span class="main">⋆</span> <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_rel_fun_def bmod_comm<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">class</span></span> rel_ab_monoid <span class="main">=</span> rel_ab_semigroup <span class="main">+</span> rel_monoid
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Lifting to Function Spaces›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We lift by interpretation, since we need sort instantiations to be
     used for functions from PAM's to Quantales. Both instantiations cannot be
     used in Isabelle at the same time.›</span></span>
  
<span class="keyword1"><span class="command">interpretation</span></span> rel_fun<span class="main">:</span> weak_proto_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>rel_magma <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_proto_quantale"</span></span> <span class="quoted">times_rel_fun</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_Sup_distr rel_fun_Sup_distl_weak<span class="main">)</span>
  
<span class="keyword1"><span class="command">interpretation</span></span> rel_fun<span class="main">:</span> proto_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top <span class="main">::</span> <span class="tfree">'a</span><span class="main">::</span>rel_magma <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>proto_quantale"</span></span> <span class="quoted">times_rel_fun</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_Sup_distl<span class="main">)</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Nitpick shows that the lifting of weak quantales to weak quantales does not work for relational semigroups, because associativity fails.›</span></span>
  
<span class="keyword1"><span class="command">interpretation</span></span> rel_fun<span class="main">:</span> weak_quantale <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale"</span></span>
  <span class="comment1">(*apply standard  nitpick[expect=genuine]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Associativity is obtained when lifting from relational monoids, but the right unit law doesn't hold
 in the quantale on the function space, according to our above results. Hence the lifting results into a
non-unital quantale, in which only the left unit law holds, as shown above. We don't provide a special class for 
such quantales. Hence we lift only to non-unital quantales.›</span></span>
    
<span class="keyword1"><span class="command">interpretation</span></span> rel_fun<span class="main">:</span> weak_quantale <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_weak_quantale"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_assoc_weak<span class="main">)</span> 

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> quantale <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>quantale"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_assoc<span class="main">)</span>
    
<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> distrib_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>distrib_quantale"</span></span> <span class="quoted">times_rel_fun</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> bool_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>bool_quantale"</span></span> <span class="quoted">minus</span> <span class="quoted">uminus</span> <span class="quoted">times_rel_fun</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> unital_quantale <span class="quoted">pid</span> <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_quantale"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">;</span></span> <span class="operator">simp</span><span class="main">)</span>
    
<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> distrib_unital_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>distrib_unital_quantale"</span></span> <span class="quoted">pid</span> <span class="quoted">times_rel_fun</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> bool_unital_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>bool_unital_quantale"</span></span> <span class="quoted">minus</span> <span class="quoted">uminus</span> <span class="quoted">pid</span> <span class="quoted">times_rel_fun</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun<span class="main">:</span> ab_quantale <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_ab_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ab_quantale"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rel_fun_comm<span class="main">)</span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun<span class="main">:</span> ab_unital_quantale <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_ab_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>ab_unital_quantale"</span></span> <span class="quoted">pid</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> distrib_ab_unital_quantale <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_ab_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>distrib_ab_unital_quantale"</span></span> <span class="quoted">times_rel_fun</span> <span class="quoted">pid</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> rel_fun2<span class="main">:</span> bool_ab_unital_quantale <span class="quoted">times_rel_fun</span> <span class="quoted">Inf</span> <span class="quoted">Sup</span> <span class="quoted">inf</span> <span class="quoted">less_eq</span> <span class="quoted">less</span> <span class="quoted">sup</span> <span class="quoted">bot</span> <span class="quoted"><span class="quoted">"top<span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>rel_ab_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>bool_ab_unital_quantale"</span></span> <span class="quoted">minus</span> <span class="quoted">uminus</span> <span class="quoted">pid</span> <span class="keyword1"><span class="command">..</span></span>
    
<span class="keyword2"><span class="keyword">end</span></span>

  
  
  
</pre>
</div><div id="Unary_Modalities">
<div class="head">
<h1>Theory Unary_Modalities</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Unary Modalities
   Author: Brijesh Dongol, Victor Gomes, Ian J Hayes, Georg Struth
   Maintainer: Victor Gomes &lt;victor.gomes@cl.cam.ac.uk&gt;
               Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Unary Modalities›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Unary_Modalities
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Binary_Modalities">Binary_Modalities</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Unary modalites arise as specialisations of the binary ones; and as generalisations of the 
standard (multi-)modal operators from predicates to functions into complete lattices. They are interesting, for instance, 
in combination with partial semigroups or monoids, for modelling the Halpern-Shoham modalities in interval logics. ›</span></span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward and Backward Diamonds›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fdia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_lattice<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span> <span class="keyword1">|</span>_<span class="keyword1">⟩</span> _ _<span class="keyword3">)</span>"</span> <span class="main">[</span>61<span class="main">,</span>81<span class="main">]</span> 82<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main"><span class="free">|</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">⟩</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bdia</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_lattice<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword3">(</span> <span class="keyword1">⟨</span>_<span class="keyword1">|</span> _ _<span class="keyword3">)</span>"</span> <span class="main">[</span>61<span class="main">,</span>81<span class="main">]</span> 82<span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">⟨</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">|</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span>  

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">c1</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_quantale"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">c1</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The relationship with binary modalities is as follows.›</span></span>
  
<span class="keyword1" id="Unary_Modalities-fdia_bmod_comp"><span class="command">lemma</span></span> fdia_bmod_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊗</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="free">f</span> c1 <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def bmod_comp_def c1_def<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-bdia_bmod_comp"><span class="command">lemma</span></span> bdia_bmod_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">|</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊗</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span> <span class="bound">x</span> <span class="bound">z</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free">R</span><span class="main">)</span> <span class="free">f</span> c1 <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdia_def bmod_comp_def c1_def<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-bmod_fdia_comp"><span class="command">lemma</span></span> bmod_fdia_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">|</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span><span class="main">⟩</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⋅</span> <span class="main">(</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def bmod_comp_def<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-bmod_fdia_comp_var"><span class="command">lemma</span></span> bmod_fdia_comp_var<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⊗</span> <span class="free">R</span> <span class="free">f</span> <span class="free">g</span> <span class="free">x</span> <span class="main">=</span> <span class="main">|</span><span class="main">{</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">|</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="free">R</span> <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span><span class="main">⟩</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">v</span><span class="main">,</span><span class="bound">w</span><span class="main">)</span><span class="main">.</span><span class="main">(</span><span class="bound">v</span> <span class="main">⋅</span> <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span><span class="free">g</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def bmod_comp_def<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-fdia_im"><span class="command">lemma</span></span> fdia_im<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">R</span> <span class="main">``</span> <span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> SUP_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> SUP_least Sup_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-fdia_un_rel"><span class="command">lemma</span></span> fdia_un_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"fdia <span class="main">(</span><span class="free">R</span> <span class="main">∪</span> <span class="free">S</span><span class="main">)</span> <span class="main">=</span> fdia <span class="free">R</span> <span class="main">⊔</span> fdia <span class="free">S</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fun_eq_iff fdia_im SUP_union Un_Image<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-fdia_Un_rel"><span class="command">lemma</span></span> fdia_Un_rel<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="main">⋃</span><span class="free">ℛ</span><span class="main">⟩</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">|</span><span class="bound">R</span><span class="main">⟩</span> <span class="free">f</span> <span class="free">x</span> <span class="main">|</span><span class="bound">R</span><span class="main">.</span> <span class="bound">R</span> <span class="main">∈</span> <span class="free">ℛ</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_im<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> SUP_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Image_mono SUP_subset_mono Sup_upper<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-fdia_sup_fun"><span class="command">lemma</span></span> fdia_sup_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"fdia <span class="free">R</span> <span class="main">(</span><span class="free">f</span> <span class="main">⊔</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> fdia <span class="free">R</span> <span class="free">f</span> <span class="main">⊔</span> fdia <span class="free">R</span> <span class="free">g</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fun_eq_iff fdia_im complete_lattice_class.SUP_sup_distrib<span class="main">)</span>
    
<span class="keyword1" id="Unary_Modalities-fdia_Sup_fun"><span class="command">lemma</span></span> fdia_Sup_fun<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="main">(</span><span class="main">⨆</span><span class="free">ℱ</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="bound">f</span> <span class="free">x</span> <span class="main">|</span><span class="bound">f</span><span class="main">.</span> <span class="bound">f</span> <span class="main">∈</span> <span class="free">ℱ</span><span class="main">}</span> "</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_im<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_upper2<span class="main"><span class="keyword3">,</span></span> <span class="operator">force</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_upper<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main"><span class="keyword3">,</span></span> <span class="operator">safe</span><span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> SUP_upper2<span class="main">)</span>

<span class="keyword1" id="Unary_Modalities-fdia_seq"><span class="command">lemma</span></span> fdia_seq<span class="main">:</span> <span class="quoted"><span class="quoted">"fdia <span class="main">(</span><span class="free">R</span> <span class="main">;</span> <span class="free">S</span><span class="main">)</span> <span class="free">f</span> <span class="free">x</span>  <span class="main">=</span> fdia <span class="free">R</span> <span class="main">(</span>fdia <span class="free">S</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_im relcomp_Image<span class="main"><span class="keyword3">,</span></span> <span class="operator">metis</span> Image_eq_UN SUP_UNION<span class="main">)</span> 

<span class="keyword1" id="Unary_Modalities-fdia_Id"><span class="command">lemma</span></span> fdia_Id <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span>Id<span class="main">⟩</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def<span class="main">)</span>
    
    
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Forward and Backward Boxes›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fbox</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_lattice<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">|</span>_<span class="keyword1">]</span> _ _"</span> <span class="main">[</span>61<span class="main">,</span>81<span class="main">]</span> 82<span class="main">)</span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main"><span class="free">|</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">]</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">y</span><span class="main">|</span><span class="bound">y</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="bound">y</span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bbox</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> set <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_lattice<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="main">(</span><span class="quoted">"<span class="keyword1">[</span>_<span class="keyword1">|</span> _ _"</span> <span class="main">[</span>61<span class="main">,</span>81<span class="main">]</span> 82<span class="main">)</span><span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main"><span class="free">[</span></span><span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main"><span class="free">|</span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">{</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span> <span class="main">|</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free"><span class="bound"><span class="entity">R</span></span></span><span class="main">}</span>"</span></span>  
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Symmetries and Dualities›</span></span>
  
<span class="keyword1" id="Unary_Modalities-fdia_fbox_demorgan"><span class="command">lemma</span></span> fdia_fbox_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_boolean_algebra<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_def fdia_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_lower compl_le_swap1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_Inf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Unary_Modalities-fbox_fdia_demorgan"><span class="command">lemma</span></span> fbox_fdia_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_boolean_algebra<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">x</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_def fdia_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_Sup<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INF_greatest<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> Inf_lower<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper compl_le_swap2<span class="main">)</span>
    
<span class="keyword1" id="Unary_Modalities-bdia_bbox_demorgan"><span class="command">lemma</span></span> bdia_bbox_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">|</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_boolean_algebra<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">[</span><span class="free">R</span><span class="main">|</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bbox_def bdia_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Inf_lower compl_le_swap1<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_Inf<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> SUP_least<span class="main"><span class="keyword3">;</span></span> <span class="operator">intro</span> Sup_upper<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    
<span class="keyword1" id="Unary_Modalities-bbox_bdia_demorgan"><span class="command">lemma</span></span> bbox_bdia_demorgan<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">[</span><span class="free">R</span><span class="main">|</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_boolean_algebra<span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">-</span> <span class="main">⟨</span><span class="free">R</span><span class="main">|</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="free">x</span>"</span></span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bbox_def bdia_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> uminus_Sup<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> INF_greatest<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> Inf_lower<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_upper compl_le_swap2<span class="main">)</span>
 
<span class="keyword1" id="Unary_Modalities-fdia_bdia_conv"><span class="command">lemma</span></span> fdia_bdia_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⟨</span>converse <span class="free">R</span><span class="main">|</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def bdia_def<span class="main">)</span> 

<span class="keyword1" id="Unary_Modalities-fbox_bbox_conv"><span class="command">lemma</span></span> fbox_bbox_conv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="free">f</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>converse <span class="free">R</span><span class="main">|</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_def bbox_def<span class="main">)</span>
    
<span class="keyword1" id="Unary_Modalities-fdia_bbox_galois"><span class="command">lemma</span></span> fdia_bbox_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">[</span><span class="free">R</span><span class="main">|</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_def bbox_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sup_le_iff<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Inf_iff<span class="main">)</span>  
    
<span class="keyword1" id="Unary_Modalities-bdia_fbox_galois"><span class="command">lemma</span></span> bdia_fbox_galois<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">|</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">standard</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bdia_def fbox_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Inf_greatest<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Sup_le_iff<span class="main">)</span>  
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> Sup_least<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> le_Inf_iff<span class="main">)</span>  
  
<span class="keyword1" id="Unary_Modalities-dia_conjugate"><span class="command">lemma</span></span> dia_conjugate<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_boolean_algebra<span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊓</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊓</span> <span class="main">(</span><span class="main">⟨</span><span class="free">R</span><span class="main">|</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> meet_shunt fdia_bbox_galois bdia_bbox_demorgan<span class="main">)</span>
    
<span class="keyword1" id="Unary_Modalities-box_conjugate"><span class="command">lemma</span></span> box_conjugate<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">::</span>complete_boolean_algebra<span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⊤</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">⊔</span> <span class="main">(</span><span class="main">[</span><span class="free">R</span><span class="main">|</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊤</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⊔</span> <span class="free">g</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">⊤</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">|</span><span class="free">R</span><span class="main">]</span> <span class="free">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_shunt sup_commute<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">g</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">-</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fbox_fdia_demorgan<span class="main">)</span> 
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span> <span class="main">|</span><span class="free">R</span><span class="main">⟩</span> <span class="main">(</span><span class="main">λ</span><span class="bound">y</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">≤</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>      
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">...</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">-</span><span class="free">f</span> <span class="bound">x</span> <span class="main">≤</span> <span class="main">[</span><span class="free">R</span><span class="main">|</span> <span class="free">g</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fdia_bbox_galois<span class="main">)</span>  
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> join_shunt<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>
  
<span class="keyword2"><span class="keyword">end</span></span>
                            

  

</pre>
</div><div id="Partial_Semigroup_Lifting">
<div class="head">
<h1>Theory Partial_Semigroup_Lifting</h1>
</div>
<pre class="source"><span class="comment1">(* Title: Liftings of Partial Semigroups
   Author: Brijesh Dongol, Victor Gomes, Ian J Hayes, Georg Struth
   Maintainer: Victor Gomes &lt;victor.gomes@cl.cam.ac.uk&gt;
               Georg Struth &lt;g.struth@sheffield.ac.uk&gt; 
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Liftings of Partial Semigroups›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Partial_Semigroup_Lifting
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Partial_Semigroups">Partial_Semigroups</a> <a href="#Binary_Modalities">Binary_Modalities</a>

<span class="keyword2"><span class="keyword">begin</span></span>  
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹First we show that partial semigroups are instances of relational semigroups. Then we extend the lifting results for relational 
semigroups to partial semigroups.›</span></span>
  
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Relational Semigroups and Partial Semigroups›</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every partial semigroup is a relational partial semigroup.›</span></span>
  
<span class="keyword1"><span class="command">context</span></span> partial_semigroup 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rel_partial_semigroup<span class="main">:</span> rel_semigroup <span class="quoted"><span class="quoted">"R"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">metis</span> add_assoc add_assocD<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every partial monoid is a relational monoid.›</span></span>
  
<span class="keyword1"><span class="command">context</span></span> partial_monoid 
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> rel_partial_monoid<span class="main">:</span> rel_monoid <span class="quoted"><span class="quoted">"R"</span></span> <span class="quoted"><span class="quoted">"E"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> unitl_ex<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> unitr_ex<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> add_assocD_var1 unitl_ex units_eq_var<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_assocD_var2 unitr_ex units_eq_var<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every PAS is a relational abelian semigroup.›</span></span>
  
<span class="keyword1"><span class="command">context</span></span> pas 
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">sublocale</span></span> rel_pas<span class="main">:</span> rel_ab_semigroup <span class="quoted"><span class="quoted">"R"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command">using</span></span> add_comm <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Every PAM is a relational abelian monoid.›</span></span>
  
<span class="keyword1"><span class="command">context</span></span> pam 
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> rel_pam<span class="main">:</span> rel_ab_monoid <span class="quoted"><span class="quoted">"R"</span></span> <span class="quoted"><span class="quoted">"E"</span></span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Liftings of Partial Abelian Semigroups›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functions from partial semigroups into weak quantales form weak proto-quantales.›</span></span>  

<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">partial_semigroup</span><span class="main">,</span> <span class="quoted">weak_quantale</span><span class="main">)</span> <span class="quoted">weak_proto_quantale</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">times_fun</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">times_fun</span> <span class="main">≡</span> rel_partial_semigroup.times_rel_fun"</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following counterexample shows that the associativity law may fail in convolution algebras
of functions from partial semigroups into weak quantales. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="free">f</span> <span class="free">f</span><span class="main">)</span> <span class="free">f</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
  <span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale<span class="main">)</span> <span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="free">f</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="comment1">(*  nitpick[show_all]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"rel_partial_semigroup.times_rel_fun <span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="free">h</span> <span class="main">=</span>
  rel_partial_semigroup.times_rel_fun <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>partial_semigroup <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>weak_quantale<span class="main">)</span> <span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="free">g</span> <span class="free">h</span><span class="main">)</span>"</span></span>
<span class="comment1">(*  nitpick[show_all]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
  
<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_def rel_partial_semigroup.rel_fun_Sup_distr rel_magma.rel_fun_Sup_distl_weak<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functions from partial semigroups into quantales form quantales.›</span></span>  
  
<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">partial_semigroup</span><span class="main">,</span> <span class="quoted">quantale</span><span class="main">)</span> <span class="quoted">quantale</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_def rel_partial_semigroup.rel_fun_assoc rel_magma.rel_fun_Sup_distl<span class="main">)</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following counterexample shows that the right unit law may fail in convolution algebras
of functions from partial monoids into weak unital quantales. ›</span></span>
  
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>rel_partial_semigroup.times_rel_fun <span class="main">(</span><span class="free">f</span><span class="main">::</span><span class="tfree">'a</span><span class="main">::</span>partial_monoid <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>unital_weak_quantale<span class="main">)</span> rel_partial_monoid.pid<span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
  <span class="comment1">(*nitpick[show_all]*)</span>
  <span class="keyword1"><span class="command">oops</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Functions from partial monoids into unital quantales form unital quantales.›</span></span>
    
<span class="keyword1"><span class="command">instantiation</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">partial_monoid</span><span class="main">,</span> <span class="quoted">unital_quantale</span><span class="main">)</span> <span class="quoted">unital_quantale</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity"><span class="class_parameter">one_fun</span></span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">one_fun</span> <span class="main">≡</span> rel_partial_monoid.pid"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_fun_def times_fun_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹These lifting results extend to PASs and PAMs as expected.›</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">pam</span><span class="main">,</span> <span class="quoted">ab_quantale</span><span class="main">)</span> <span class="quoted">ab_quantale</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">standard</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_def rel_pas.rel_fun_comm<span class="main">)</span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">pam</span><span class="main">,</span> <span class="quoted">bool_ab_quantale</span><span class="main">)</span> <span class="quoted">bool_ab_quantale</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">instance</span></span> <span class="quoted">"fun"</span> <span class="main">::</span> <span class="main">(</span><span class="quoted">pam</span><span class="main">,</span> <span class="quoted">bool_ab_unital_quantale</span><span class="main">)</span> <span class="quoted">bool_ab_unital_quantale</span> <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">sublocale</span></span> ab_quantale <span class="main">&lt;</span> abq<span class="main">:</span> pas <span class="quoted"><span class="quoted">"<span class="main">(*)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main"><span class="bound">_</span></span> <span class="main"><span class="bound">_</span></span><span class="main">.</span> True"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_commute<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we prove some identities that hold in function spaces.›</span></span>
    
<span class="keyword1" id="Partial_Semigroup_Lifting-times_fun_var"><span class="command">lemma</span></span> times_fun_var<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">z</span> <span class="main">|</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> R <span class="free">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_def rel_partial_semigroup.times_rel_fun_def bmod_comp_def<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroup_Lifting-times_fun_var2"><span class="command">lemma</span></span> times_fun_var2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">g</span> <span class="bound">z</span> <span class="main">|</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> R <span class="bound">x</span> <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_var<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroup_Lifting-one_fun_var1"><span class="command">lemma</span></span> one_fun_var1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_fun_def rel_partial_monoid.pid_def<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroup_Lifting-one_fun_var2"><span class="command">lemma</span></span> one_fun_var2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> E <span class="main">⟹</span> <span class="main">1</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> one_fun_def rel_partial_monoid.pid_def<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroup_Lifting-times_fun_canc"><span class="command">lemma</span></span> times_fun_canc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="bound">y</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span>rquot <span class="free">x</span> <span class="bound">y</span><span class="main">)</span> <span class="main">|</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> Sup_subset_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_mono_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_mult add_canc1 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span> 
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_var<span class="main"><span class="keyword3">,</span></span> <span class="operator">intro</span> Sup_subset_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Collect_mono_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> gR_rel_defined add_canc2 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1" id="Partial_Semigroup_Lifting-times_fun_prod"><span class="command">lemma</span></span> times_fun_prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y1</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y2</span><span class="main">)</span> <span class="main">|</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">.</span> R <span class="bound">y</span> <span class="bound">y1</span> <span class="bound">y2</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_var2 times_prod_def D_prod_def<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroup_Lifting-one_fun_prod1"><span class="command">lemma</span></span> one_fun_prod1 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∈</span> E <span class="main">⟹</span> <span class="main">1</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E_prod_def<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroup_Lifting-one_fun_prod2"><span class="command">lemma</span></span> one_fun_prod2 <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">∉</span> E <span class="main">⟹</span> <span class="main">1</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">⊥</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> E_prod_def<span class="main">)</span>

<span class="keyword1" id="Partial_Semigroup_Lifting-fres_galois_funI"><span class="command">lemma</span></span> fres_galois_funI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">h</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="free">f</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">h</span> <span class="main">←</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> fres_galois le_funD le_funI<span class="main">)</span>
    
<span class="keyword1" id="Partial_Semigroup_Lifting-times_fun_prod_canc"><span class="command">lemma</span></span> times_fun_prod_canc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">⨆</span><span class="main">{</span><span class="free">f</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">z</span><span class="main">)</span> <span class="main">*</span> <span class="free">g</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> rquot <span class="free">y</span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="free">y</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_prod<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> gR_rel_defined gR_rel_mult add_canc1 add_canc2<span class="main">)</span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following statement shows, in a generalised setting, that the magic wand operator of separation
logic can be lifted from the heap subtraction operation generalised to a cancellative PAM.›</span></span>

<span class="keyword1" id="Partial_Semigroup_Lifting-fres_lift"><span class="command">lemma</span></span> fres_lift<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fres <span class="free">f</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span><span class="main">::</span><span class="tfree">'b</span><span class="main">::</span>cancellative_pam<span class="main">)</span> <span class="main">=</span> <span class="main">⨅</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span> <span class="bound">y</span> <span class="bound">z</span> <span class="main">.</span> <span class="bound">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> rquot <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
  <span class="keyword1"><span class="command">{</span></span> <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">h</span> <span class="skolem">y</span> <span class="skolem">z</span> 
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">≤</span> <span class="free">f</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="skolem">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> rquot <span class="skolem">y</span> <span class="skolem">z</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span>  <span class="quoted"><span class="quoted">"D <span class="skolem">z</span> <span class="free">x</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> add_rquot <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="free">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="skolem">z</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">h</span> <span class="main">⋅</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> add_comm <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> times_fun_var <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Sup_upper<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">hence</span></span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">h</span> <span class="main">*</span> <span class="free">g</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">⊕</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">⊕</span> <span class="free">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="quoted">‹D <span class="skolem">z</span> <span class="free">x</span>›</span></span> calculation<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> le_funD add_comm<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="skolem">z</span> <span class="main">⊕</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fres_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Sup_upper<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> this <span class="keyword2"><span class="keyword">and</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">h</span> <span class="main">(</span>rquot <span class="skolem">y</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="skolem">z</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_canc2<span class="main">)</span>
<span class="keyword1"><span class="command">}</span></span> 
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">f</span> <span class="main">←</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">⨅</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> rquot <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fres_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> Inf_greatest SUP_least<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> rquot <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span> <span class="main">≤</span> Sup<span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">⋅</span> <span class="free">g</span> <span class="main">≤</span> <span class="free">f</span><span class="main">}</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> times_fun_var <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> SUP_upper le_funI Sup_least<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fres_galois<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">intro</span> Inf_lower<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">safe</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> gR_rel_mult add_canc1 add_comm<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">⨅</span><span class="main">{</span><span class="main">(</span><span class="free">f</span> <span class="bound">y</span><span class="main">)</span> <span class="main">←</span> <span class="main">(</span><span class="free">g</span> <span class="bound">z</span><span class="main">)</span> <span class="main">|</span><span class="bound">y</span> <span class="bound">z</span><span class="main">.</span> <span class="bound">z</span> <span class="keyword1">≼<span class="hidden">⇩</span><sub>R</sub></span> <span class="bound">y</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">=</span> rquot <span class="bound">y</span> <span class="bound">z</span><span class="main">}</span> <span class="main">≤</span> <span class="main">(</span><span class="free">f</span> <span class="main">←</span> <span class="free">g</span><span class="main">)</span> <span class="free">x</span> "</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fres_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

</pre>
</div>