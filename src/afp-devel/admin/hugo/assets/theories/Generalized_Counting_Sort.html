<div id="Algorithm">
<div class="head">
<h1>Theory Algorithm</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Efficient Generalization of Counting Sort for Large, possibly Infinite Key Ranges
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Algorithm's description, analysis, and formalization"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Algorithm
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL/Main.html">Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

\emph{This paper is dedicated to Gaia, my sweet niece, whose arrival has blessed me and my family
with joy and tenderness.}

\null

\emph{Moreover, I would like to thank my colleague Iacopo Rippa, who patiently listened to the ideas
underlying sections \ref{SEC1} and \ref{SEC3}, and helped me expand those ideas into complete proofs
by providing me with valuable hints and test data.}
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Introduction"</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Counting sort"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\emph{Counting sort} is a well-known algorithm that sorts a collection of objects of any kind, as
long as each such object is associated with a signed integer key, according to their respective keys
(cf. \cite{R1}, \cite{R2}). If $xs$ is the input array containing $n$ objects to be sorted, $out$ is
the output, sorted array, and $key$ is the function mapping objects to keys, counting sort works as
follows (assuming arrays to be zero-based):

\begin{enumerate}

\item
Search the minimum key $mi$ and the maximum key $ma$ occurring within $xs$ (which can be done via a
single loop over $xs$).

\item
Allocate an array $ns$ of $ma - mi + 2$ unsigned integers and initialize all its elements to 0.

\item
For each $i$ from 0 to $n-1$, increase $ns[key(xs[i]) - mi + 1]$ by 1.

\item
For each $i$ from 2 to $ma - mi$, increase $ns[i]$ by $ns[i - 1]$.

\item
For each $i$ from 0 to $n-1$, set $out[ns[key(xs[i]) - mi]]$ to $xs[i]$ and increase
$ns[key(xs[i]) - mi]$ by 1.

\end{enumerate}

Steps 1 and 2 take $O(n)$ and $O(ma - mi)$ time, respectively. Step 3 counts how many times each
possible key occurs within $xs$, and takes $O(n)$ time. Step 4 computes the offset within $out$ of
the first object in $xs$, if any, having each possible key, and takes $O(ma - mi)$ time. Finally,
step 5 fills $out$, taking $O(n)$ time. Thus, the overall running time is $O(n) + O(ma - mi)$, and
the same is obviously true of memory space.

If the range of all the keys possibly occurring within $xs$, henceforth briefly referred to as the
\emph{key range}, is known in advance, the first two steps can be skipped by using the minimum and
maximum keys in the key range as $mi$, $ma$ and pre-allocating (possibly statically, rather than
dynamically, in real-world implementations) an array $ns$ of size $ma - mi + 2$. However, this does
not affect the asymptotic running time and memory space required by the algorithm, since both keep
being $O(n) + O(ma - mi)$ independently of the distribution of the keys actually occurring in $xs$
within the key range.

As a result, counting sort is suitable for direct use, viz. not just as a subroutine of another
sorting algorithm such as radix sort, only if the key range is not significantly larger than $n$.
Indeed, if 100 objects with 100,000 possible keys have to be sorted, accomplishing this task by
allocating, and iterating over, an array of 100,000 unsigned integers to count keys' occurrences
would be quite impractical! Whence the question that this paper will try to answer: how can counting
sort be generalized for direct use in case of a large key range?

Solving this problem clearly requires to renounce having one counter per key, rather using a bounded
number of counters, independent of the key range's cardinality, and partitioning the key range into
some number of intervals compatible with the upper bound on the counters' number. The resulting key
intervals will then form as many \emph{buckets}, and what will have to be counted is the number of
the objects contained in each bucket.

Counting objects per bucket, rather than per single key, has the following major consequences, the
former good, the latter bad:

\begin{itemize}

\item
\emph{Keys are no longer constrained to be integers, but may rather be elements of any linear order,
even of infinite cardinality.}
\\In fact, in counting sort keys must be integers -- or anything else in one-to-one correspondence
with some subset of the integers, such as alphabet letters -- since this ensures that the key range
contains finitely many keys, so that finitely many counters are needed. Thus, the introduction of an
upper bound for the number of counters makes this constraint vanish. As a result, keys of any kind
are now allowed and the key range can even be infinite (mathematically, since any representation of
the key range on a computer will always be finite). Notably, rational or real numbers may be used as
keys, too.
\\This observation considerably extends the scope of application of the special case where function
$key$ matches the identity function. In counting sort, this option is viable only if the objects to
be sorted are themselves integers, whereas in the generalized algorithm it is viable whenever they
are elements of any linear order, which also happens if they are rational or real numbers.

\item
\emph{Recursion needs to be introduced, since any bucket containing more than one object is in turn
required to be sorted.}
\\In fact, nothing prevents multiple objects from falling in the same bucket, and while this happens
sorting is not accomplished. Therefore, the generalized algorithm must provide for recursive rounds,
where each round splits any bucket containing multiple objects into finer-grained buckets containing
fewer objects. Recursion will then go on until every bucket contains at most one object, viz. until
there remains no counter larger than one.

\end{itemize}

Of course, the fewer recursive rounds are required to complete sorting, the more the algorithm will
be efficient, whence the following, fundamental question: how to minimize the number of the rounds?
That is to say, how to maximize the probability that, as a result of the execution of a round, there
be at most one object in each bucket, so that no more rounds be required?

The intuitive answer is: first, by making the buckets equiprobable -- or at least, by making their
probabilities as much uniform as possible --, and second, by increasing the number of the buckets as
much as possible. Providing pen-and-paper proofs of both of these statements, and showing how they
can be enforced, is the purpose of the following sections.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Buckets' probability -- Proof"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{SEC1}

Suppose that $k$ objects be split randomly among $n$ equiprobable buckets, where $k \leq n$. This
operation is equivalent to selecting at random a sequence of $k$ buckets, possibly with repetitions,
so that the first object be placed into the first bucket of the sequence, the second object into the
second bucket, and so on. Thus, the probability $P$ that each bucket will contain at most one object
-- which will be called \emph{event E} in what follows -- is equal to the probability of selecting a
sequence without repetitions among all the possible sequences of $k$ buckets formed with the $n$
given ones.

Since buckets are assumed to be equiprobable, so are all such sequences. Hence, $P$ is equal to the
ratio of the number of the sequences without repetitions to the number of all sequences, namely:

\begin{equation}
\label{EQ1}
P=\frac{n!}{(n-k)!n^k}
\end{equation}

In the special case where $k = n$, this equation takes the following, simpler form:

\begin{equation}
\label{EQ2}
P=\frac{n!}{n^n}
\end{equation}

Now, suppose that the $n$ buckets be no longer equiprobable, viz. that they no longer have the same,
uniform probability $1/n$, rather having arbitrary, nonuniform probabilities $p_1$, ..., $p_n$. The
equation for probability $P$ applying to this case can be obtained through an iterative procedure,
as follows.

Let $i$ be an index in the range 1 to $n$ such that $p_i$ is larger than $1/n$. After swapping index
$i$ for 1, let $x_1$ be the increment in probability $p_1$ with respect to $1/n$, so that $p_1 =
a_0/n + x_1$ with $a_0 = 1$ and $0 &lt; x_1 \leq a_0(n-1)/n$ (as $p_1 = 1$ for $x_1 = a_0(n-1)/n$).
Then, let $P_1$ be the probability of event $E$ in case the first bucket has probability $p_1$ and
all the other $n-1$ buckets have the same, uniform probability $q_1 = a_0/n - x_1/(n-1)$.

If $k &lt; n$, event $E$ occurs just in case either all $k$ objects fall in as many distinct buckets
with probability $q_1$, or $k - 1$ objects do so whereas the remaining object falls in the bucket
with probability $p_1$. As these events, say $E_A$ and $E_B$, are incompatible, $P_1$ matches the
sum of their respective probabilities.

Since all the possible choices of $k$ distinct buckets are mutually incompatible, while those of the
buckets containing any two distinct objects are mutually independent, the probability of event $E_A$
is equal to the product of the following factors:

\begin{itemize}

\item
The number of the sequences without repetitions of $k$ buckets formed with the $n-1$ ones with
probability $q_1$, i.e. $(n-1)!/(n-1-k)! = (n-k)(n-1)!/(n-k)!$.

\item
The probability of any such sequence, i.e. $q_1^k$.

\end{itemize}

By virtue of similar considerations, the probability of event $E_B$ turns out to match the product
of the following factors:

\begin{itemize}

\item
The number of the sequences without repetitions of $k - 1$ buckets formed with the $n-1$ ones with
probability $q_1$, i.e. $(n-1)!/(n-\bcancel{1}-k+\bcancel{1})! = (n-1)!/(n-k)!$.

\item
The probability of any such sequence, i.e. $q_1^{k-1}$.

\item
The number of the possible choices of the object falling in the first bucket, i.e. $k$.

\item
The probability of the first bucket, i.e. $p_1$.

\end{itemize}

Therefore, $P_1$ is provided by the following equation:

\begin{equation}
\label{EQ3}
\begin{split}
P_1&amp;=\frac{(n-k)(n-1)!}{(n-k)!}\left(\frac{a_0}{n} - \frac{x_1}{n-1}\right)^k\\
&amp;\quad+k\frac{(n-1)!}{(n-k)!}\left(\frac{a_0}{n} - \frac{x_1}{n-1}\right)^{k-1}
\left(\frac{a_0}{n} + x_1\right)
\end{split}
\end{equation}

The correctness of this equation is confirmed by the fact that its right-hand side matches that of
equation \eqref{EQ1} for $x_1 = 0$, since $P_1$ must degenerate to $P$ in this case. In fact, being
$a_0 = 1$, it results:

\begin{align*}
&amp;\frac{(n-k)(n-1)!}{(n-k)!}\left(\frac{a_0}{n} - 0\right)^k
+k\frac{(n-1)!}{(n-k)!}\left(\frac{a_0}{n} - 0\right)^{k-1}\left(\frac{a_0}{n} + 0\right)\\
&amp;\quad=(n-\bcancel{k}+\bcancel{k})\frac{(n-1)!}{(n-k)!}\left(\frac{a_0}{n}\right)^k\\
&amp;\quad=\frac{n!}{(n-k)!n^k}
\end{align*}

If $k = n$, event $E_A$ is impossible, as there is no way to accommodate $n$ objects within $n-1$
buckets without repetitions. Thus, $P_1$ is given by the following equation, derived by deleting the
first addend and replacing $k$ with $n$ in the right-hand side of equation \eqref{EQ3}:

\begin{equation}
\label{EQ4}
P_1=n!\left(\frac{a_0}{n} - \frac{x_1}{n-1}\right)^{n-1}\left(\frac{a_0}{n} + x_1\right)
\end{equation}

Likewise, the right-hand side of this equation matches that of equation \eqref{EQ2} for $x_1 = 0$,
which confirms its correctness.

The conclusions reached so far can be given a concise form, suitable for generalization, through the
following definitions, where $i$ and $j$ are any two natural numbers such that $0 &lt; k-j \leq n-i$
and $a_i$ is some assigned real number:

\begin{align*}
A_{i,j}&amp;\equiv\frac{(n-i)!}{(n-i-k+j)!}\left(\frac{a_i}{n-i}\right)^{k-j}\\
F_{i,j}&amp;\equiv(k-j+1)A_{i,j}p_i\\
G_{i,j}&amp;\equiv A_{i,j-1}+F_{i,j}
\end{align*}

Then, denoting the value of $P$ in the uniform probability case with $P_0$, and $a_0(n-1)/n - x_1$
with $a_1$, so that $q_1 = a_1/(n-1)$, equations \eqref{EQ1}, \eqref{EQ3}, and \eqref{EQ4} can be
rewritten as follows:

\begin{align}
\label{EQ5}
P_0&amp;=A_{0,0}\\
\label{EQ6}
P_1&amp;=
\begin{cases}
G_{1,1}=A_{1,0}+kA_{1,1}p_1&amp;\quad\text{if $k &lt; n$,}\\
F_{1,1}=kA_{1,1}p_1&amp;\quad\text{if $k = n$.}
\end{cases}
\end{align}

Even more than for their conciseness, these equations are significant insofar as they show that the
right-hand side of equation \eqref{EQ6} can be obtained from the one of equation \eqref{EQ5} by
replacing $A_{0,0}$ with either $G_{1,1}$ or $F_{1,1}$, depending on whether $k &lt; n$ or $k = n$.

If $p_i$ matches $q_1$ for any $i$ in the range 2 to $n$, $P = P_1$, thus $P$ is given by equation
\eqref{EQ6}. Otherwise, the procedure that has led to equation \eqref{EQ6} can be applied again. For
some index $i$ in the range 2 to $n$ such that $p_i$ is larger than $q_1$, swap $i$ for 2, and let
$x_2 = p_2 - a_1/(n-1)$, $a_2 = a_1(n-2)/(n-1) - x_2$, with $0 &lt; x_2 \leq a_1(n-2)/(n-1)$. Moreover,
let $P_2$ be the probability of event $E$ if the first two buckets have probabilities $p_1$, $p_2$
and the other $n-2$ buckets have the same probability $q_2 = a_2/(n-2)$.

Then, reasoning as before, it turns out that the equation for $P_2$ can be obtained from equation
\eqref{EQ6} by replacing:

\begin{itemize}

\item
$A_{1,0}$ with $G_{2,1}$ or $F_{2,1}$, depending on whether $k &lt; n-1$ or $k = n-1$, and

\item
$A_{1,1}$ with $G_{2,2}$ or $F_{2,2}$, depending on whether $k-1 &lt; n-1$, i.e. $k &lt; n$, or $k-1 =
n-1$, i.e. $k = n$.

\end{itemize}

As a result, $P_2$ is provided by the following equation:

\begin{equation}
\label{EQ7}
P_2=
\begin{cases}
G_{2,1}+kG_{2,2}p_1=A_{2,0}+kA_{2,1}p_2+k[A_{2,1}+(k-1)A_{2,2}p_2]p_1\\
\quad\text{if $k &lt; n-1$,}\\
F_{2,1}+kG_{2,2}p_1=kA_{2,1}p_2+k[A_{2,1}+(k-1)A_{2,2}p_2]p_1\\
\quad\text{if $k = n-1$,}\\
kF_{2,2}p_1=k(k-1)A_{2,2}p_2p_1\\
\quad\text{if $k = n$.}
\end{cases}
\end{equation}

Since the iterative procedure used to derive equations \eqref{EQ6} and \eqref{EQ7} can be further
applied as many times as required, it follows that for any nonuniform probability distribution
$p_1$, ..., $p_n$, the equation for $P$ can be obtained from equation \eqref{EQ5} with $n-1$ steps
at most, where each step consists of replacing terms of the form $A_{i,j}$ with terms of either form
$G_{i+1,j+1}$ or $F_{i+1,j+1}$, depending on whether $k-j &lt; n-i$ or $k-j = n-i$.

Let us re-use letters $n$, $k$ in lieu of $n-i$ and $k-j$, and use letters $a$, $x$ as aliases for
$a_i$ and $x_{i+1}$. Then, any aforesaid replacement is equivalent to the insertion of either of the
following expressions, regarded as images of as many functions $G$, $F$ of real variable $x$:

\begin{align}
\nonumber
G(x)&amp;=\frac{(n-k)(n-1)!}{(n-k)!}\left(\frac{a}{n} - \frac{x}{n-1}\right)^k\\
\label{EQ8}
&amp;\quad+k\frac{(n-1)!}{(n-k)!}\left(\frac{a}{n} - \frac{x}{n-1}\right)^{k-1}
\left(\frac{a}{n} + x\right)
&amp;&amp; \text{for $k &lt; n$,}\\
\label{EQ9}
F(x)&amp;=n!\left(\frac{a}{n} - \frac{x}{n-1}\right)^{n-1}\left(\frac{a}{n} + x\right)
&amp;&amp; \text{for $k = n$}
\end{align}

in place of the following expression:

\begin{equation}
\label{EQ10}
\frac{n!}{(n-k)!}\left(\frac{a}{n}\right)^k=
\begin{cases}
G(0)&amp;\quad\text{if $k &lt; n$,}\\
F(0)&amp;\quad\text{if $k = n$.}
\end{cases}
\end{equation}

Equation \eqref{EQ10} can be obtained from equations \eqref{EQ8} and \eqref{EQ9} in the same way as
equations \eqref{EQ3} and \eqref{EQ4} have previously been shown to match equations \eqref{EQ1} and
\eqref{EQ2} for $x_1 = 0$.

Since every such replacement takes place within a sum of nonnegative terms, $P$ can be proven to be
increasingly less than $P_0$ for increasingly nonuniform probability distributions -- which implies
that the probability of event $E$ is maximum in case of equiprobable buckets -- by proving that
functions $G$ and $F$ are strictly decreasing in $[0, b]$, where $b = a(n-1)/n$.

The slopes of the segments joining points $(0, G(0))$, $(b, G(b))$ and $(0, F(0))$, $(b, F(b))$ are:

\begin{align*}
\frac{G(b)-G(0)}{b-0}&amp;=\frac{0-\dfrac{n!}{(n-k)!}\left(\dfrac{a}{n}\right)^k}{b}&lt;0\text{,}\\
\frac{F(b)-F(0)}{b-0}&amp;=\frac{0-n!\left(\dfrac{a}{n}\right)^n}{b}&lt;0\text{.}
\end{align*}

Therefore, by Lagrange's mean value theorem, there exist $c, d \in (0, b)$ such that $G'(c) &lt; 0$ and
$F'(d) &lt; 0$. On the other hand, it is:

\begin{align*}
G'(x)&amp;=-k\frac{(n-1)!}{(n-k)!}\frac{n-k}{n-1}\left(\frac{a}{n}-\frac{x}{n-1}\right)^{k-1}\\
&amp;\quad-k\frac{(n-1)!}{(n-k)!}\frac{k-1}{n-1}\left(\frac{a}{n}-\frac{x}{n-1}\right)^{k-2}
\left(\frac{a}{n}+x\right)\\
&amp;\quad+k\frac{(n-1)!}{(n-k)!}\left(\frac{a}{n}-\frac{x}{n-1}\right)^{k-1}\text{,}\\
F'(x)&amp;=-n!\left(\frac{a}{n}-\frac{x}{n-1}\right)^{n-2}
\left(\frac{a}{n}+x\right)
+n!\left(\frac{a}{n}-\frac{x}{n-1}\right)^{n-1}\text{.}
\end{align*}

Thus, solving equations $G'(x) = 0$ and $F'(x) = 0$ for $x \neq b$, viz. for $a/n - x/(n-1) \neq 0$,
it results:

\begin{align*}
&amp;G'(x)=0\\
&amp;\quad\Rightarrow\bcancel{k\frac{(n-1)!}{(n-k)!}\left(\frac{a}{n}-\frac{x}{n-1}\right)^{k-2}}
\biggl[\frac{k-n}{n-1}\left(\frac{a}{n}-\frac{x}{n-1}\right)\\
&amp;\quad\quad\quad+\frac{1-k}{n-1}\left(\frac{a}{n}+x\right)+\frac{a}{n}-\frac{x}{n-1}\biggr]=0\\
&amp;\quad\Rightarrow\frac{1}{\bcancel{n(n-1)^2}}\bigl\{(k-n)[(n-1)a-nx]+(1-k)[(n-1)a+n(n-1)x]\\
&amp;\quad\quad\quad+(n-1)^2a-n(n-1)x\bigr\}=0\\
&amp;\quad\Rightarrow\bcancel{k(n-1)a}-knx-n(n-1)a+n^2x+(n-1)a+\bcancel{n(n-1)x}\\
&amp;\quad\quad\quad-\bcancel{k(n-1)a}-kn(n-1)x+(n-1)^2a-\bcancel{n(n-1)x}=0\\
&amp;\quad\Rightarrow-\bcancel{knx}-\bcancel{n^2a}+\bcancel{na}+n^2x+\bcancel{na}-\bcancel{a}
-kn^2x+\bcancel{knx}+\bcancel{n^2a}-\bcancel{2na}+\bcancel{a}=0\\
&amp;\quad\Rightarrow\bcancel{n^2(1-k)}x=0\\
&amp;\quad\Rightarrow x=0\text{,}
\end{align*}

\begin{align*}
&amp;F'(x)=0\\
&amp;\quad\Rightarrow\bcancel{n!\left(\frac{a}{n}-\frac{x}{n-1}\right)^{n-2}}
\left(-\bcancel{\frac{a}{n}}-x+\bcancel{\frac{a}{n}}-\frac{x}{n-1}\right)=0\\
&amp;\quad\Rightarrow\bcancel{\frac{n}{1-n}}x=0\\
&amp;\quad\Rightarrow x=0\text{.}
\end{align*}

Hence, there is no $x \in (0, b)$ such that $G'(x) = 0$ or $F'(x) = 0$. Moreover, if there existed
$y, z \in (0, b)$ such that $G'(y) &gt; 0$ or $F'(z) &gt; 0$, by Bolzano's theorem there would also exist
$u, v$ in the open intervals with endpoints $c, y$ and $d, z$, both included in $(0, b)$, such that
$G'(u) = 0$ or $F'(v) = 0$, which is not the case. Therefore, $G'(x)$ and $F'(x)$ are negative for
any $x \in (0, b)$, so that functions $G$ and $F$ are strictly decreasing in $[0, b]$, Q.E.D..
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Buckets' probability -- Implementation"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{SEC2}

Given $n &gt; 1$ buckets, numbered with indices 0 to $n - 1$, and a finite set $A$ of objects having
minimum key $mi$ and maximum key $ma$, let $E(k)$, $I(mi,ma)$ be the following events, defined as
subsets of the whole range $R$ of function $key$, with $k$ varying over $R$:

\begin{align*}
E(k)&amp;\equiv\{k'\in R.\;k'\leq k\}\\
I(mi,ma)&amp;\equiv\{k'\in R.\;mi\leq k'\leq ma\}
\end{align*}

Furthermore, define functions $r$, $f$ as follows:

\begin{align*}
r(k,n,mi,ma)&amp;\equiv (n-1)\cdot P(E(k)\;|\;I(mi,ma))\\
f(k,n,mi,ma)&amp;\equiv floor(r(k,n,mi,ma))
\end{align*}

where $P(E(k)\;|\;I(mi,ma))$ denotes the conditional probability of event $E(k)$, viz. for a key not
to be larger than $k$, given event $I(mi,ma)$, viz. if the key is comprised between $mi$ and $ma$.

Then, the buckets' probabilities can be made as much uniform as possible by placing each object $x
\in A$ into the bucket whose index matches the following value:

\begin{equation*}
index(key,x,n,mi,ma)\equiv f(key(x),n,mi,ma)
\end{equation*}

For example, given $n = 5$ buckets, suppose that the image of set $A$ under function $key$ consists
of keys $k_1 = mi$, $k_2$, ..., $k_9 = ma$, where the conditional probabilities for a key comprised
between $k_1$ and $k_9$ to match each of these keys have the following values:

\begin{align*}
P_1&amp;=0.05,\\
P_2&amp;=0.05,\\
P_3&amp;=0.15,\\
P_4&amp;=0.075,\\
P_5&amp;=0.2,\\
P_6&amp;=0.025,\\
P_7&amp;=0.1,\\
P_8&amp;=0.25,\\
P_9&amp;=0.1
\end{align*}

Evidently, there is no way of partitioning set $\{k_1, ..., k_9\}$ into five equiprobable subsets
comprised of contiguous keys. However, it results:

\begin{equation*}
floor\left(4\cdot\sum_{i=1}^{n}P_i\right)=
\begin{cases}
0&amp;\quad\text{for $n = 1, 2$,}\\
1&amp;\quad\text{for $n = 3, 4$,}\\
2&amp;\quad\text{for $n = 5, 6, 7$,}\\
3&amp;\quad\text{for $n = 8$,}\\
4&amp;\quad\text{for $n = 9$.}
\end{cases}
\end{equation*}

Hence, in spite of the highly nonuniform distribution of the keys' probabilities -- key $k_8$'s
probability is 10 times that of key $k_6$ --, function $index$ manages all the same to split the
objects in $A$ so as to make the buckets' probabilities more uniform -- with the maximum one being
about 3 times the minimum one --, as follows:

\begin{itemize}

\item
Bucket 0 has probability 0.1, as it collects the objects with keys $k_1$, $k_2$.

\item
Bucket 1 has probability 0.225, as it collects the objects with keys $k_3$, $k_4$.

\item
Bucket 2 has probability 0.325, as it collects the objects with keys $k_5$, $k_6$, $k_7$.

\item
Bucket 3 has probability 0.25, as it collects the objects with key $k_8$.

\item
Bucket 4 has probability 0.1, as it collects the objects with key $k_9$.

\end{itemize}

Remarkably, function $index$ makes the buckets' probabilities exactly or almost uniform -- meaning
that the maximum one is at most twice the minimum nonzero one, possibly except for the last bucket
alone -- in the following most common, even though special, cases:

\begin{enumerate}

\item
$I(mi,ma)$ is a finite set of equiprobable keys.

\item
$I(mi,ma)$ is a closed interval of real numbers, i.e. $I(mi,ma) = [mi,ma] \subset \mathbb{R}$, with
$P(\{mi\}) = 0$, and function $r$ is continuous for $k \in [mi,ma]$.

\end{enumerate}

In case 1, let $m$ be the cardinality of $I(mi,ma)$. It is $m &gt; 0$ since $mi \in I(mi,ma)$, so that
each key in $I(mi,ma)$ has probability $1/m$.

If $m \leq n - 1$, then $(n - 1)/m \geq 1$, thus $f$ is nonzero and strictly increasing for $k \in
I(mi,ma)$. Thus, in this subcase function $index$ fills exactly $m$ buckets, one for each single key
in $I(mi,ma)$, whereas the remaining $n - m$ buckets, particularly the first one, are left unused.
Therefore, every used bucket has probability $1/m$.

If $m &gt; n - 1$ and $m$ is divisible by $n - 1$, let $q &gt; 1$ be the quotient of the division, so that
$m = q(n - 1)$. Dividing both sides of this equation by $m(n - 1)$, it turns out that $1/(n - 1) =
q/m$, and then $1/(n - 1) - 1/m = (q - 1)/m$. Hence, $f$ matches zero for the first $q - 1$ keys in
$I(mi,ma)$, increases by one for each of the $n - 2$ subsequent groups of $q$ contiguous keys, and
reaches value $n - 1$ in correspondence with the last key. Indeed, $q - 1 + q(n - 2) + 1 = q +
q(n - 2) = q(n - 1) = m$.

Consequently, in this subcase function $index$ places the objects mapped to the first $q - 1$ keys
into the first bucket -- which then has probability $(q - 1)/m$ --, the objects mapped to the $i$-th
subsequent group of $q$ keys, where $1 \leq i \leq n - 2$, into the bucket with index $i$ -- which
then has probability $q/m$ -- and the objects mapped to the last key into the last bucket -- which
then has probability $1/m$ --. Since $2(q - 1)/m = 2q/m - 2/m \geq 2q/m - q/m = q/m$, the maximum
probability is at most twice the minimum one, excluding the last bucket if $q &gt; 2$.

If $m &gt; n - 1$ and $m$ is not divisible by $n - 1$, let $q$, $r$ be the quotient and the remainder
of the division, where $q &gt; 0$ and $n - 1 &gt; r &gt; 0$. For any $i &gt; 0$, it is:

\begin{align}
\nonumber
&amp;m=q(n-1)+r\\
\nonumber
&amp;\quad\Rightarrow\frac{\bcancel{m}}{\bcancel{m}(n-1)}=
\frac{q\bcancel{(n-1)}}{m\bcancel{(n-1)}}+\frac{r}{m(n-1)}\\
\nonumber
&amp;\quad\Rightarrow\frac{i}{n-1}=\frac{iq}{m}+i\frac{r}{m(n-1)}\\
\label{EQ11}
&amp;\quad\Rightarrow\frac{iq}{m}=\frac{i}{n-1}-\left(i\frac{r}{n-1}\right)\frac{1}{m}\\
\label{EQ12}
&amp;\quad\Rightarrow\frac{iq+1}{m}=\frac{i}{n-1}+\left(1-i\frac{r}{n-1}\right)\frac{1}{m}
\end{align}

Both equations \eqref{EQ11} and \eqref{EQ12} have something significant to say for $i = 1$.

Equation \eqref{EQ11} takes the following form:

\begin{equation*}
\frac{q}{m}=\frac{1}{n-1}-\left(\frac{r}{n-1}\right)\frac{1}{m}
\end{equation*}

where $r/(n - 1) &gt; 0$, so that $q/m &lt; 1/(n - 1)$. This implies that, if $k$ is the first key in
$I(mi,ma)$ for which $f$ matches any given value, the subsequent $q - 1$ keys are never sufficient
to increase $f$ by one. Thus, function $index$ fills every bucket but the last one -- which collects
the objects mapped to the last key only -- with the objects mapped to $1 + q - 1 = q$ keys at least.

For its part, equation \eqref{EQ12} takes the following form:

\begin{equation*}
\frac{q+1}{m}=\frac{1}{n-1}+\left(1-\frac{r}{n-1}\right)\frac{1}{m}
\end{equation*}

where $1 - r/(n - 1) &gt; 0$, so that $(q + 1)/m &gt; 1/(n - 1)$. Therefore, the $q$ keys following any
aforesaid key $k$ are always sufficient to increase $f$ by one. Hence, function $index$ fills every
bucket with the objects mapped to $1 + q = q + 1$ keys at most. A further consequence is that $f$
changes from zero to one for $k$ matching the $(q + 1)$-th key in $I(mi,ma)$, which entails that the
first bucket collects the objects mapped to exactly the first $q$ keys.

Which is the first $i_1$, if any, such that the bucket with index $i_1$ collects the objects mapped
to $q + 1$, rather than $q$, keys? Such bucket, if any, is preceded by $i_1$ buckets (as indices are
zero-based), whose total probability is $i_1q/m$ (as each of those buckets accommodates a group of
$q$ keys). So, $i_1$ is the least index, if any, such that $0 &lt; i_1 &lt; n - 1$ and $[(i_1 + 1)q + 1]/m
&lt; (i_1 + 1)/(n - 1)$. Rewriting the latter inequality using equation \eqref{EQ12}, it results:

\begin{align*}
&amp;\bcancel{\frac{i_1+1}{n-1}}+\left[1-(i_1+1)\frac{r}{n-1}\right]\frac{1}{m}&lt;
\bcancel{\frac{i_1+1}{n-1}}\\
&amp;\quad\Rightarrow\left[1-(i_1+1)\frac{r}{n-1}\right]\bcancel{\frac{1}{m}}&lt;0\\
&amp;\quad\Rightarrow(i_1+1)\frac{r}{n-1}&gt;1\\
&amp;\quad\Rightarrow i_1&gt;\frac{n-1}{r}-1
\end{align*}

where $(n - 1)/r - 1 &gt; 0$ since $r &lt; n - 1$. Hence, index $i_1$ there exists just in case:

\begin{align*}
&amp;\frac{n-1}{r}-1&lt;n-2\\
&amp;\quad\Rightarrow\frac{\bcancel{n-1}}{r}&lt;\bcancel{n-1}\\
&amp;\quad\Rightarrow r&gt;1
\end{align*}

Likewise, let $i_2$ be the next index, if any, such that the bucket with index $i_2$ accommodates a
group of $q + 1$ keys. Such bucket, if any, is preceded by $i_2 - 1$ buckets accommodating $q$ keys
and one bucket accommodating $q + 1$ keys, whose total probability is $(i_2q + 1)/m$. Thus, $i_2$ is
the least index, if any, such that $i_1 &lt; i_2 &lt; n - 1$ and $[(i_2 + 1)q + 2]/m &lt; (i_2 + 1)/(n - 1)$.
Adding term $1/m$ to both sides of equation \eqref{EQ12}, the latter inequality can be rewritten as
follows:

\begin{align*}
&amp;\bcancel{\frac{i_2+1}{n-1}}+\left[2-(i_2+1)\frac{r}{n-1}\right]\frac{1}{m}&lt;
\bcancel{\frac{i_2+1}{n-1}}\\
&amp;\quad\Rightarrow\left[2-(i_2+1)\frac{r}{n-1}\right]\bcancel{\frac{1}{m}}&lt;0\\
&amp;\quad\Rightarrow(i_2+1)\frac{r}{n-1}&gt;2\\
&amp;\quad\Rightarrow i_2&gt;\frac{2(n-1)}{r}-1
\end{align*}

where $2(n - 1)/r - 1 &gt; [(n - 1)/r - 1] + 1 \geq i_1$. Hence, index $i_2$ there exists just in case:

\begin{align*}
&amp;\frac{2(n-1)}{r}-1&lt;n-2\\
&amp;\quad\Rightarrow\frac{2\bcancel{(n-1)}}{r}&lt;\bcancel{n-1}\\
&amp;\quad\Rightarrow r&gt;2
\end{align*}

To sum up, in this subcase function $index$ turns out to work as follows:

\begin{itemize}

\item
The $r - 1$ buckets whose indices $i_j$ match the least solutions of inequalities $i_j &gt; j(n - 1)/r
- 1$, for $1 \leq j \leq r - 1$, accommodate a group of $q + 1$ contiguous keys each, so that each
one has probability $(q + 1)/m$.

\item
The other $n - 1 - (r - 1) = n - r$ buckets excluding the last one, particularly the first bucket,
accommodate a group of $q$ contiguous keys each, so that each one has probability $q/m$.

\item
The last bucket accommodates the last key alone, so that its probability is $1/m$.

\end{itemize}

Indeed, $(q + 1)(r - 1) + q(n - r) + 1 = \bcancel{qr} - q + r - \bcancel{1} + qn - \bcancel{qr} +
\bcancel{1} = q(n - 1) + r = m$. Furthermore, being $2q/m \geq (q + 1)/m$, the maximum value among
buckets' probabilities is at most twice the minimum one, excluding the last bucket if $q &gt; 2$.

Two further observations can be made concerning case 1. First, if $m &gt; n - 1$, then the larger $q$
gets, the more efficient it becomes to use the buckets' number $n$ itself instead of $n - 1$ within
function $r$, placing the objects with index $n$, viz. mapped to the last key, into the bucket with
index $n - 1$. In fact, this ensures that all the buckets have almost uniform probabilities rather
than leaving a bucket, the last one, with a small, or even negligible, probability.

Second, if keys are integers and $I(mi,ma)$ includes all the integers comprised between $mi$ and
$ma$, it is $m = ma - mi + 1$, whereas the cardinality of set $E(k) \cap I(mi,ma)$ is $k - mi + 1$
for any $k \in I(mi,ma)$. Therefore, it results:

\begin{equation*}
r(k,n,mi,ma)=(n-1)\frac{k - mi + 1}{ma - mi + 1},
\end{equation*}

so that function $r$ resembles the approximate rank function $R$ described in \cite{R3}.

In case 2, let $Z$ be the set of the integers $i$ such that $0 \leq i \leq n-1$. As $r(k,n,mi,ma)$
matches 0 for $k = mi$ and $n-1$ for $k = ma$, by the intermediate value theorem, for each $i \in Z$
there exists a least $k_i \in [mi,ma]$ such that $r(k_i,n,mi,ma) = i$, where $k_0 = mi$. Then, let
$B_i = [k_i, k_{i+1})$ for each $i \in Z - \{n-1\}$ and $B_{n-1} = [k_{n-1}, ma]$.

For any $i \in Z - \{n-1\}$, $k \in B_i$, it is $r(k,n,mi,ma) \neq i+1$, since otherwise there would
exist some $k &lt; k_{i+1}$ in $[mi,ma]$ such that $r(k,n,mi,ma) = i+1$. On the other hand, being $k &lt;
k_{i+1}$, it is $r(k,n,mi,ma) \leq i+1$, since function $r$ is increasing with respect to variable
$k$. Hence, it turns out that $r(k,n,mi,ma) &lt; i+1$. Moreover, the monotonicity of $r$ also implies
that $r(k,n,mi,ma) \geq i$. Therefore, it is $f(k,n,mi,ma) = i$, so that for any $i \in Z$, function
$index$ fills the bucket with index $i$ with the objects mapped to the keys in $B_i$.

Consequently, for each $i \in Z - \{n-1\}$, the probability of the bucket with index $i$ is:

\begin{align*}
&amp;P(B_i\;|\;I(mi,ma))\\
&amp;\quad=\frac{P(B_i\cap I(mi,ma))}{P(I(mi,ma))}\\
&amp;\quad=\frac{P((k_i,k_{i+1}]\cap I(mi,ma))}{P(I(mi,ma))}\\
&amp;\quad=\frac{P(E(k_{i+1})\cap I(mi,ma))-P(E(k_i)\cap I(mi,ma))}{P(I(mi,ma))}\\
&amp;\quad=\frac{P(E(k_{i+1})\cap I(mi,ma))}{P(I(mi,ma))}-\frac{P(E(k_i)\cap I(mi,ma))}{P(I(mi,ma))}\\
&amp;\quad=P(E(k_{i+1})\;|\;I(mi,ma))-P(E(k_i)\;|\;I(mi,ma))\\
&amp;\quad=\frac{(n-1)\cdot P(E(k_{i+1})\;|\;I(mi,ma))-(n-1)\cdot P(E(k_i)\;|\;I(mi,ma))}{n-1}\\
&amp;\quad=\frac{r(k_{i+1},n,mi,ma)-r(k_i,n,mi,ma)}{n-1}\\
&amp;\quad=\frac{\bcancel{i}+1-\bcancel{i}}{n-1}\\
&amp;\quad=\frac{1}{n-1}
\end{align*}

Observe that the computation uses:

\begin{itemize}

\item
The definition of conditional probability.

\item
The fact that events $B_i$ and $(k_i, k_{i+1}]$ differ by singletons $\{k_i\}$ and $\{k_{i+1}\}$,
whose probability is zero.
\\Indeed, it is $P(\{k_0\}) = P(\{mi\}) = 0$ by hypothesis, whereas for any $k \in (mi,ma]$, it is
$P(\{k\}) = 0$ due to the continuity of function $r$, and then of function $P(E(k) \cap I(mi,ma))$,
in point $k$. In fact, for any $k' \in (mi,k)$ it is $E(k') \cap I(mi,ma) = [mi,k'] \subset [mi,k)$,
so that $P(E(k') \cap I(mi,ma)) \leq P([mi,k))$. However, it is also $E(k) \cap I(mi,ma) = [mi,k] =
[mi,k) \cup \{k\}$, so that $P(E(k) \cap I(mi,ma)) = P([mi,k)) + P(\{k\})$. Thus, if $P(\{k\}) &gt; 0$,
then $P(E(k) \cap I(mi,ma)) &gt; P([mi,k))$, in contradiction with the assumption that:

\begin{equation*}
\lim_{k'\to k^-}P(E(k') \cap I(mi,ma))=P(E(k) \cap I(mi,ma))
\end{equation*}

\item
The fact that event $E(k_{i+1}) \cap I(mi,ma)$ is equal to the union of the disjoint events $E(k_i)
\cap I(mi,ma)$ and $(k_i, k_{i+1}] \cap I(mi,ma)$, so that the probability of the former event is
equal to the sum of the probabilities of the latter ones.

\end{itemize}

As a result, all the buckets but the last one are equiprobable, whereas the last one has probability
zero. Thus, in this case it is again more efficient to replace $n - 1$ with $n$ within function $r$,
assigning the objects with index $n$, viz. mapped to the keys falling in $B_n$, to the bucket with
index $n - 1$, which ensures that all the buckets have uniform probabilities.

If function $r$ is linear for $k \in [mi,ma]$, viz. if interval $[mi,ma]$ is endowed with a constant
probability density, then the function's graph (with factor $n - 1$ replaced by $n$) is the straight
line passing through points $(mi,0)$ and $(ma,n)$. Therefore, it results:

\begin{equation*}
r(k,n,mi,ma)=n\frac{k - mi}{ma - mi},
\end{equation*}

so that function $r$ matches the approximate rank function $R$ described in \cite{R3}.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Buckets' number -- Proof"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{SEC3}

Given $n$ equiprobable buckets and $k$ objects to be partitioned randomly among such buckets, where
$1 &lt; k \leq n$, the probability $P_{n,k}$ that each bucket will contain at most one object is given
by equation \eqref{EQ1}, namely:

\begin{equation*}
P_{n,k}=\frac{n!}{(n-k)!n^k}
\end{equation*}

Thus, it is:

\begin{align*}
&amp;P_{n+1,k}-P_{n,k}\\
&amp;\quad=\frac{(n+1)!}{(n-k+1)(n-k)!(n+1)^k}-\frac{n!}{(n-k)!n^k}\\
&amp;\quad=\frac{(n+1)!n^k-n!(n-k+1)(n+1)^k}{(n-k+1)(n-k)!n^k(n+1)^k}
\end{align*}

Using the binomial theorem and Pascal's rule, the numerator of the fraction in the right-hand side
of this equation can be expressed as follows:

\begin{align*}
&amp;(n+1)!n^k-(n-k+1)n!(n+1)^k\\
&amp;\quad=n!(n+1)n^k+n!k(n+1)^k-n!n(n+1)^k-n!(n+1)^k\\
&amp;\quad=n!n^{k+1}+n!n^k\\
&amp;\quad\quad+n!k\left[n^k+\binom{k}{1}n^{k-1}+\binom{k}{2}n^{k-2}+...
+\binom{k}{k-1}n+\binom{k}{k}\right]\\
&amp;\quad\quad-n!n\left[n^k+\binom{k}{1}n^{k-1}+\binom{k}{2}n^{k-2}+...
+\binom{k}{k-1}n+\binom{k}{k}\right]\\
&amp;\quad\quad-n!\left[n^k+\binom{k}{1}n^{k-1}+\binom{k}{2}n^{k-2}+...
+\binom{k}{k-1}n+\binom{k}{k}\right]\\
&amp;\quad=\bcancel{n!n^{k+1}}+\bcancel{n!n^k}+\bcancel{n!kn^k}\\
&amp;\quad\quad+n!k\binom{k}{1}n^{k-1}+n!k\binom{k}{2}n^{k-2}+...
+n!k\binom{k}{k-1}n+n!k\\
&amp;\quad\quad-\bcancel{n!n^{k+1}}-\bcancel{n!kn^k}-n!\binom{k}{2}n^{k-1}-...
-n!\binom{k}{k-1}n^2-n!\binom{k}{k}n\\
&amp;\quad\quad-\bcancel{n!n^k}-n!\binom{k}{1}n^{k-1}-n!\binom{k}{2}n^{k-2}-...
-n!\binom{k}{k-1}n-n!\\
&amp;\quad=n!(k-1)+n!n^{k-1}\left[k\binom{k}{1}-\binom{k}{1}-\binom{k}{2}\right]+...\\
&amp;\quad\quad+n!n\left[k\binom{k}{k-1}-\binom{k}{k-1}-\binom{k}{k}\right]\\
&amp;\quad=n!(k-1)+n!\cdot\sum_{i=1}^{k-1}
n^{k-i}\left\{k\binom{k}{i}-\left[\binom{k}{i}+\binom{k}{i+1}\right]\right\}\\
&amp;\quad=n!(k-1)+n!\cdot\sum_{i=1}^{k-1}
n^{k-i}\left[k\binom{k}{i}-\binom{k+1}{i+1}\right]\\
&amp;\quad=n!(k-1)+n!\cdot\sum_{i=1}^{k-1}
n^{k-i}\left[\frac{kk!}{i!(k-i)!}-\frac{(k+1)!}{(i+1)i!(k-i)!}\right]\\
&amp;\quad=n!(k-1)+n!\cdot\sum_{i=1}^{k-1}
n^{k-i}k!\frac{(i+1)k-(k+1)}{(i+1)i!(k-i)!}\\
&amp;\quad=n!(k-1)+n!\cdot\sum_{i=1}^{k-1}
n^{k-i}k!\frac{ik-1}{(i+1)i!(k-i)!}&gt;0
\end{align*}

Therefore, for any fixed $k &gt; 1$, sequence $(P_{n,k})_{n \geq k}$ is strictly increasing, viz. the
larger $n$ is, such is also the probability that each of the $n$ equiprobable buckets will contain
at most one of the $k$ given objects.

Moreover, it is $P_{n,k} = [n(n-1)(n-2)(n-3)...(n-k+1)]/n^k &lt; n^k/n^k = 1$, as the product enclosed
within the square brackets comprises $k$ factors, one equal to $n$ and the other ones less than $n$.

On the other hand, it turns out that:

\begin{align*}
&amp;n(n-1)(n-2)(n-3)...(n-k+1)\\
&amp;\quad=n^2[(n-2)(n-3)...(n-k+1)]-n[(n-2)(n-3)...(n-k+1)]\\
&amp;\quad\geq n^2[(n-2)(n-3)...(n-k+1)]-n\cdot n^{k-2}\\
&amp;\quad=n[n(n-2)(n-3)...(n-k+1)]-n^{k-1}\\
&amp;\quad=n\cdot n^2[(n-3)...(n-k+1)]-n\cdot 2n[(n-3)...(n-k+1)]-n^{k-1}\\
&amp;\quad\geq n^3[(n-3)...(n-k+1)]-2n^2\cdot n^{k-3}-n^{k-1}\\
&amp;\quad=n^2[n(n-3)...(n-k+1)]-(1+2)n^{k-1}\;...
\end{align*}

Hence, applying the same line of reasoning until the product within the square brackets disappears,
it results:

\begin{align*}
&amp;n(n-1)(n-2)(n-3)...(n-k+1)\\
&amp;\quad\geq n^k-[1+2+...+(k-1)]n^{k-1}\\
&amp;\quad=n^k-\frac{k(k-1)}{2}n^{k-1},
\end{align*}

so that:

\begin{equation*}
P_{n,k}=\frac{n(n-1)(n-2)(n-3)...(n-k+1)}{n^k}\geq 1-\frac{k(k-1)}{2n}
\end{equation*}

Therefore, for any fixed $k &gt; 1$, the terms of sequence $(P_{n,k})_{n \geq k}$ are comprised between
the corresponding terms of sequence $(1 - k(k-1)/2n)_{n \geq k}$ and constant sequence $(1)_{n \geq
k}$. Since both of these sequences converge to 1, by the squeeze theorem it is:

\begin{equation*}
\lim_{n\to\infty}P_{n,k}=1,
\end{equation*}

viz. the larger $n$ is, the closer to 1 is the probability that each of the $n$ equiprobable buckets
will contain at most one of the $k$ given objects.

As a result, the probability of placing at most one object into each bucket in any algorithm's round
is maximized by increasing the number of the buckets as much as possible, Q.E.D..
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Buckets' number -- Implementation"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\label{SEC4}

Let $n$ be the number of the objects to be sorted, and $p$ the upper bound on the counters' number
-- and then on the buckets' number as well, since there must be exactly one counter per bucket --.
This means that before the round begins, the objects to be split are located in $m$ buckets $B_1$,
..., $B_m$, where $0 &lt; m \leq p$, respectively containing $n_1$, ..., $n_m$ objects, where $n_i &gt; 0$
for each $i$ from 1 to $m$ and $n_1 + ... + n_m = n$.

Moreover, let $c$ be the number of the objects known to be the sole elements of their buckets, viz.
to require no partition into finer-grained buckets, at the beginning of a given algorithm's round.
Then, the number of the objects requiring to be split into finer-grained buckets in that round is
$n - c$, whereas the number of the available buckets is $p - c$, since $c$ counters must be left to
store as many 1s, one for each singleton bucket.

How to compute $c$? At first glance, the answer seems trivial: by counting, among the counters input
(either by the algorithm's caller or by the previous round) to the round under consideration, those
that match 1. However, this value would not take into account the fact that, for each non-singleton
bucket, the algorithm must find the leftmost occurrence of the minimum key, as well as the rightmost
occurrence of the maximum key, and place the corresponding objects into two new singleton buckets,
which shall be the first and the last finer-grained bucket, respectively.

The most fundamental reason for this is that, as a result of the partition of such a bucket, nothing
prevents all its objects from falling in the same finer-grained bucket -- particularly, this happens
whenever all its objects have the same key --, in which case the algorithm does not terminate unless
some object is removed from the bucket prior to the partition, so as to reduce its size. Just as
clearly, the algorithm must know where to place the finer-grained buckets containing the removed
objects with respect to the finer-grained buckets resulting from the partition. This is exactly what
is ensured by removing objects with minimum or maximum keys, whereas selecting the leftmost or the
rightmost ones, respectively, preserves the algorithm's stability.

Actually, the algorithm's termination requires the removal of at least one object per non-singleton
bucket, so the removal of one object only, either with minimum or maximum key, would be sufficient.
Nonetheless, the leftmost minimum and the rightmost maximum can be searched via a single loop, and
finding both of them enables to pass them as inputs to the function $index$ described in section
\ref{SEC2}, or to whatever other function used to split buckets into finer-grained ones. Moreover,
non-singleton buckets whose objects all have the same key can be detected as those whose minimum and
maximum keys are equal. This allows to optimize the algorithm by preventing it from unnecessarily
applying multiple recursive rounds to any such bucket; it shall rather be left as is, just replacing
its counter with as many 1s as its size to indicate that it is already sorted.

Therefore, as the round begins, the objects already known to be placed in singleton buckets are one
for each bucket whose counter matches 1, and two for each bucket whose counter is larger than 1. As
a result, $c$ shall be computed as follows. First, initialize $c$ to zero. Then, for each $i$ from 1
to $m$, increase $c$ by one if $n_i = 1$, by two otherwise.

Conversely, for any such $i$, the number $N_i$ of the objects contained in bucket $B_i$ having to be
partitioned into finer-grained buckets is 0 if $n_i = 1$, $n_i - 2$ otherwise, so that $N_1 + ... +
N_m = n - c$. According to the findings of section \ref{SEC3}, the number $N'_i$ of the resulting
finer-grained buckets should be maximized, and the most efficient way to do this is to render $N'_i$
proportional to $N_i$, since otherwise, viz. if some buckets were preferred to some other ones, the
unprivileged buckets would form as many bottlenecks.

This can be accomplished by means of the following procedure. First, initialize integers $R$ and $U$
to 0. Then, for each $i$ from 1 to $m$, check whether $N_i \leq 1$:

\begin{itemize}

\item
If so, set $N'_i$ to $N_i$.
\\In fact, no finer-grained bucket is necessary if there are no objects to be split, while a single
finer-grained bucket is sufficient for a lonely object.

\item
Otherwise, perform the integer division of $N_i \cdot (p - c) + R$ by $n - c$, and set integer $Q$
to the resulting quotient and $R$ to the resulting remainder. Then, if the minimum and maximum keys
occurring in bucket $B_i$ are equal, increase $U$ by $Q - N_i$, otherwise set $N'_i$ to $U + Q$ and
reset $U$ to 0.
\\In fact, as observed above, if its minimum and maximum keys are equal, bucket $B_i$ can be split
into $n_i = N_i + 2$ singleton buckets. Hence, the difference $Q - N_i$ between the number of the
available finer-grained buckets, i.e. $Q + 2$ (where 2 is the number of the buckets containing the
leftmost minimum and the rightmost maximum), and the number of those being used, i.e. $N_i + 2$, can
be added to the total number $U$ of the available finer-grained buckets still unused in the current
round. Such buckets can then be utilized as soon as a bucket $B_j$ with $N_j &gt; 1$ whose minimum and
maximum keys do not match is encountered next, in addition to those already reserved for $B_j$.

\end{itemize}

Of course, for any $i$ from 1 to $m$ such that $N_i &gt; 1$, it is $N_i \leq Q$ -- viz. the number of
the objects in $B_i$ to be split is not larger than that of the finer-grained buckets where they are
to be placed even if $U = 0$, so that the probability of placing at most one object into each bucket
is nonzero -- just in case $n - c \leq p - c$, i.e. $n \leq p$. Indeed, it will be formally proven
that for $n \leq p$, this procedure is successful in maximizing the buckets' number in each round
never exceeding the upper bound $p$.
›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">"Generalized counting sort (GCsort)"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The conclusions of the efficiency analysis performed so far, put together, result in the following
\emph{generalized counting sort (GCsort)} algorithm.

Let $xs$ be the input array containing $n$ objects to be sorted, and $ns$ an array of $p$ integers,
where $0 &lt; p$ and $n \leq p$. Moreover, let $xs'$ and $ns'$ be two further arrays of the same type
and size of $xs$ and $ns$, respectively, and let $i$, $i'$, and $j$ be as many integers.

Then, GCsort works as follows (assuming arrays to be zero-based):

\begin{enumerate}

\item
Initialize the first element of $ns$ to $n$ and any other element to 0.

\item
Check whether $ns$ contains any element larger than 1.
\\If not, terminate the algorithm and output $xs$ as the resulting sorted array.

\item
Initialize $i$, $i'$, and $j$ to 0.

\item
Check whether $ns[i] = 1$ or $ns[i] &gt; 1$:

  \begin{enumerate}

  \item
  In the former case, set $xs'[j]$ to $xs[j]$ and $ns'[i']$ to 1.
  \\Then, increase $i'$ and $j$ by 1.

  \item
  In the latter case, partition the bucket comprised of objects $xs[j]$ to $xs[j+ns[i]-1]$ into
  finer-grained buckets according to section \ref{SEC4}, storing the resulting $n'$ buckets in
  $xs'[j]$ to $xs'[j+ns[i]-1]$ and their sizes in $ns'[i']$ to $ns'[i'+n'-1]$.
  \\Then, increase $i'$ by $n'$ and $j$ by $ns[i]$.

  \end{enumerate}

\item
Increase $i$ by 1, and then check whether $i &lt; p$.
\\If so, go back to step 4.
\\Otherwise, perform the following operations:

  \begin{enumerate}

  \item
  If $i' &lt; p$, set integers $ns'[i']$ to $ns'[p-1]$ to 0.

  \item
  Swap addresses $xs$ and $xs'$, as well as addresses $ns$ and $ns'$.

  \item
  Go back to step 2.

  \end{enumerate}

\end{enumerate}

Since the algorithm is tail-recursive, the memory space required for its execution matches the one
required for a single recursive round, which is $O(n) + O(p)$.

The best-case running time can be computed easily. The running time taken by step 1 is equal to $p$.
Moreover, the partition of a bucket into finer-grained ones is performed by determining their sizes,
computing the cumulative sum of such sizes, and rearranging the bucket's objects according to the
resulting offsets. All these operations only involve sequential, non-nested loops, which iterate
through either the objects or the finer-grained counters pertaining to the processed bucket alone.
Hence, the running time taken by a single recursive round is $O(n) + O(p)$, so that in the best case
where at most one round is executed after step 1, the running time taken by the algorithm is $O(n) +
O(p)$, too.

The asymptotic worst-case running time can be computed as follows. Let $t_{n,p}$ be the worst-case
running time taken by a single round. As $t_{n,p}$ is $O(n) + O(p)$, there exist three real numbers
$a &gt; 0$, $b &gt; 0$, and $c$ such that $t_{n,p} \leq an + bp + c$. Moreover, let $U_{n,p}$ be the set
of the $p$-tuples of natural numbers such that the sum of their elements matches $n$, and $max(u)$
the maximum element of a given $u \in U_{n,p}$. Finally, let $T_{n,p,u}$ be the worst-case running
time taken by the algorithm if it starts from step 2, viz. skipping step 1, using as initial content
of array $ns$ the $p$-tuple $u \in U_{n,p}$.

Then, it can be proven by induction on $max(u)$ that:

\begin{equation}
\label{EQ13}
T_{n,p,u}\leq
\begin{cases}
a\dfrac{max(u)}{2}n+\left[b\dfrac{max(u)}{2}+1\right]p+c\dfrac{max(u)}{2}\\
\quad\text{if $max(u)$ is even,}\\
\\
a\dfrac{max(u)-1}{2}n+\left[b\dfrac{max(u)-1}{2}+1\right]p+c\dfrac{max(u)-1}{2}\\
\quad\text{if $max(u)$ is odd}
\end{cases}
\end{equation}

In fact, if $max(u) = 0$, the initial $p$-tuple $u$ matches the all-zero one. Hence, the algorithm
executes step 2 just once and then immediately terminates. Therefore, the running time is $p$, which
matches the right-hand side of inequality \eqref{EQ13} for $max(u) = 0$.

If $max(u) = 1$, $u$ contains no element larger than 1. Thus, again, the algorithm terminates just
after the first execution of step 2. As a result, the running time is still $p$, which matches the
right-hand side of inequality \eqref{EQ13} for $max(u) = 1$.

If $max(u) = 2$, $u$ contains some element larger than 1, so that one round is executed, taking time
$t_{n,p}$ in the worst case. Once this round is over, array $ns$ will contain a $p$-tuple $u' \in
U_{n,p}$ such that $max(u') = 1$. Hence, step 2 is executed again, taking time $p$, and then the
algorithm terminates. As a result, it is:

\begin{equation*}
T_{n,p,u}\leq an+bp+c+p=an+(b+1)p+c,
\end{equation*}

which matches the right-hand side of inequality \eqref{EQ13} for $max(u) = 2$.

Finally, if $max(u) &gt; 2$, $u$ has some element larger than 1, so one round is executed, taking time
$t_{n,p}$ in the worst case. Once this round is over, array $ns$ will contain a $p$-tuple $u' \in
U_{n,p}$ such that $max(u') \leq max(u) - 2$, because of the removal of the leftmost minimum and the
rightmost maximum from any non-singleton bucket. By the induction hypothesis, the worst-case time
$T_{n,p,u'}$ taken by the algorithm from this point onward complies with inequality \eqref{EQ13},
whose right-hand side is maximum if such is $max(u')$, viz. if $max(u') = max(u) - 2$.

As a result, if $max(u)$ is even, it is:

\begin{align*}
&amp;T_{n,p,u}\leq an+bp+c\\
&amp;\quad\quad+a\frac{max(u)-2}{2}n+\left[b\frac{max(u)-2}{2}+1\right]p+c\frac{max(u)-2}{2}\\
&amp;\quad=a\frac{max(u)}{2}n+\left[b\frac{max(u)}{2}+1\right]p+c\frac{max(u)}{2},
\end{align*}

which matches the right-hand side of inequality \eqref{EQ13} for an even $max(u)$.

Similarly, if $max(u)$ is odd, it is:

\begin{align*}
&amp;T_{n,p,u}\leq an+bp+c\\
&amp;\quad\quad+a\frac{max(u)-3}{2}n+\left[b\frac{max(u)-3}{2}+1\right]p+c\frac{max(u)-3}{2}\\
&amp;\quad=a\frac{max(u)-1}{2}n+\left[b\frac{max(u)-1}{2}+1\right]p+c\frac{max(u)-1}{2},
\end{align*}

which matches the right-hand side of inequality \eqref{EQ13} for an odd $max(u)$.

With this, the proof of inequality \eqref{EQ13} is complete. Now, let $T_{n,p}$ be the worst-case
time taken by the algorithm executed in full. Step 1 is executed first, taking time $p$. Then, array
$ns$ contains a $p$-tuple $u$ such that $max(u) = n$, and by definition, the worst-case time taken
by the algorithm from this point onward is $T_{n,p,u}$. Therefore, applying inequality \eqref{EQ13},
it turns out that:

\begin{align*}
&amp;T_{n,p}=p+T_{n,p,u}\\
&amp;\quad\leq
\begin{cases}
a\dfrac{n^2}{2}+\left(b\dfrac{n}{2}+2\right)p+c\dfrac{n}{2}
&amp;\quad\text{if $n$ is even,}\\
\\
a\dfrac{n^2-n}{2}+\left(b\dfrac{n-1}{2}+2\right)p+c\dfrac{n-1}{2}
&amp;\quad\text{if $n$ is odd}
\end{cases}
\end{align*}

As a result, the asymptotic worst-case running time taken by the algorithm is $O(n^2) + O(np)$.
›</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Formal definitions"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
Here below, a formal definition of GCsort is provided, which will later enable to formally prove the
correctness of the algorithm. Henceforth, the main points of the formal definitions and proofs are
commented. For further information, see Isabelle documentation, particularly \cite{R5}, \cite{R6},
\cite{R7}, and \cite{R8}.

The following formalization of GCsort does not define any specific function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to be used
to split buckets into finer-grained ones. It rather defines only the type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index_sign</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> of such
functions, matching the signature of the function $index$ described in section \ref{SEC2}, along
with three predicates that whatever chosen <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> function is required to satisfy for GCsort
to work correctly:

\begin{itemize}

\item
Predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index_less</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> requires function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to map any object within a given bucket
to an index less than the number of the associated finer-grained buckets (\emph{less than} instead
of \emph{not larger than} since type <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span> list"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is zero-based).

\item
Predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index_mono</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> requires function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to be monotonic with respect to the
keys of the objects within a given bucket.

\item
Predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index_same</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> requires function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to map any two distinct objects within
a given bucket that have the same key to the same index (premise \emph{distinct} is added to enable
this predicate to be used by the simplifier).

\end{itemize}

\null
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">index_less</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">index_less</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">x</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">mi</span><span class="main">..</span><span class="bound">ma</span><span class="main">}</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span> <span class="main">⟶</span>
    <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span> <span class="main">&lt;</span> <span class="bound">n</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">index_mono</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">index_mono</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span><span class="main">.</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">y</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound">mi</span><span class="main">..</span><span class="bound">ma</span><span class="main">}</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">y</span> <span class="main">⟶</span>
    <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">y</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">index_same</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> bool"</span></span>
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">index_same</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound">x</span> <span class="bound">y</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">mi</span><span class="main">..</span><span class="bound">ma</span><span class="main">}</span> <span class="main">⟶</span> <span class="bound">x</span> <span class="main">≠</span> <span class="bound">y</span> <span class="main">⟶</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">y</span> <span class="main">⟶</span>
    <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">y</span> <span class="bound">n</span> <span class="bound">mi</span> <span class="bound">ma</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">bn_count</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">bn_comp</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> count, respectively, the objects known to be placed
in singleton buckets in a given round, and the finer-grained buckets available to partition a given
non-singleton bucket, according to section \ref{SEC4}.

\null
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bn_count</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bn_count</span> <span class="main">[]</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bn_count</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="free">bn_count</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bn_count</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">+</span> <span class="free">bn_count</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bn_comp</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bn_comp</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bn_comp</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bn_valid</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bn_valid</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">&lt;..</span><span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bn_valid</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span> True"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">mini</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">maxi</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> return the indices of the leftmost minimum and the rightmost
maximum within a given non-singleton bucket.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span> <span class="entity">mini</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">mini</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">mini</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="main">(</span>nonexhaustive<span class="main">)</span> <span class="entity">maxi</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">maxi</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">m</span> <span class="main">=</span> <span class="free">maxi</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="main">[]</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">m</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> Suc <span class="bound">m</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">enum</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> counts the objects contained in each finer-grained bucket reserved for the
partition of a given non-singleton bucket.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">enum</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span>
  nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">enum</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">enum</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span><span class="main">;</span>
     <span class="bound">ns</span> <span class="main">=</span> <span class="free">enum</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span>
   <span class="keyword1">in</span> <span class="bound">ns</span><span class="main">[</span><span class="bound">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="bound">ns</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">offs</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> computes the cumulative sum of the resulting finer-grained buckets' sizes so
as to generate the associated offsets' list.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">offs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">[]</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">offs</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">#</span> <span class="free">offs</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">fill</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> fills the finer-grained buckets with their respective objects.

\null
›</span></span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">fill</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span>
  nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> option list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">fill</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">=</span> replicate <span class="free"><span class="bound"><span class="entity">n</span></span></span> None"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">fill</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">i</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span><span class="main">;</span>
     <span class="bound">ys</span> <span class="main">=</span> <span class="free">fill</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">[</span><span class="bound">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span>
   <span class="keyword1">in</span> <span class="bound">ys</span><span class="main">[</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> <span class="bound">i</span> <span class="main">:=</span> Some <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Then, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">round</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> formalizes a single GCsort's recursive round.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">round_suc_suc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">round_suc_suc</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">≡</span>
  <span class="keyword1">let</span> <span class="bound">nmi</span> <span class="main">=</span> mini <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">;</span> <span class="bound">nma</span> <span class="main">=</span> maxi <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span><span class="main">;</span>
    <span class="bound">xmi</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">!</span> <span class="bound">nmi</span><span class="main">;</span> <span class="bound">xma</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">!</span> <span class="bound">nma</span><span class="main">;</span> <span class="bound">mi</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">xmi</span><span class="main">;</span> <span class="bound">ma</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">xma</span>
  <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">mi</span> <span class="main">=</span> <span class="bound">ma</span>
    <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">,</span> replicate <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ws</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">k</span> <span class="main">=</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">of</span> Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">;</span>
        <span class="bound">zs</span> <span class="main">=</span> nths <span class="free"><span class="bound"><span class="entity">ws</span></span></span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="bound">nmi</span><span class="main">,</span> <span class="bound">nma</span><span class="main">}</span><span class="main">)</span><span class="main">;</span> <span class="bound">ms</span> <span class="main">=</span> enum <span class="bound">zs</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">k</span> <span class="bound">mi</span> <span class="bound">ma</span>
      <span class="keyword1">in</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">n'</span></span></span> <span class="main">-</span> <span class="bound">k</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="bound">ms</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="main">0</span><span class="main">]</span><span class="main">,</span>
        <span class="bound">xmi</span> <span class="main">#</span> map the <span class="main">(</span>fill <span class="bound">zs</span> <span class="main">(</span>offs <span class="bound">ms</span> <span class="main">0</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">mi</span> <span class="bound">ma</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="bound">xma</span><span class="main">]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">round</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span>
  nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">ns'</span><span class="main">,</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> tl <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="bound">ns'</span><span class="main">,</span> hd <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">#</span> <span class="bound">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">let</span> <span class="bound">ws</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">;</span> <span class="main">(</span><span class="bound">n'</span><span class="main">,</span> <span class="bound">r'</span><span class="main">)</span> <span class="main">=</span> bn_comp <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">;</span>
     <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="bound">ms'</span><span class="main">,</span> <span class="bound">ws'</span><span class="main">)</span> <span class="main">=</span> round_suc_suc <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">ws</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="bound">n'</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">;</span>
     <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">ns'</span><span class="main">,</span> <span class="bound">xs'</span><span class="main">)</span> <span class="main">=</span> <span class="free">round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="bound">r'</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
   <span class="keyword1">in</span> <span class="main">(</span><span class="bound">u'</span><span class="main">,</span> <span class="bound">ms'</span> <span class="main">@</span> <span class="bound">ns'</span><span class="main">,</span> <span class="bound">ws'</span> <span class="main">@</span> <span class="bound">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Finally, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_aux</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> formalizes GCsort. Since the algorithm is tail-recursive, this
function complies with the requirements for an auxiliary tail-recursive function applying to step 1
of the proof method described in \cite{R4} -- henceforth briefly referred to as the \emph{proof
method} --. This feature will later enable to formally prove the algorithm's correctness properties
by means of such method.

\null
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">gcsort_round</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span>
  nat <span class="main">⇒</span> nat list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gcsort_round</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span>
  round <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> bn_count <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">-</span> bn_count <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="main">0</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">gcsort_aux</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span>
  nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gcsort_aux</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> find <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> None
  <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">gcsort_aux</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>gcsort_round <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

First of all, even before accomplishing step 2 of the proof method, it is necessary to prove that
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_aux<span class="antiquote"><span class="antiquote">}</span></span></span></span> always terminates by showing that the maximum bucket's size decreases
in each recursive round.

\null
›</span></span>

<span class="keyword1" id="Algorithm-add_zeros"><span class="command">lemma</span></span> add_zeros<span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">(</span><span class="free">m</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">(</span>replicate <span class="free">n</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-add_suc"><span class="command">lemma</span></span> add_suc<span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">(</span>Suc <span class="free">m</span><span class="main">)</span> <span class="free">ns</span> <span class="main">=</span> Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="free">m</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-add_update"><span class="command">lemma</span></span> add_update<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="free">m</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_suc <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Algorithm-add_le"><span class="command">lemma</span></span> add_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> le_add1<span class="main">)</span>

<span class="keyword1" id="Algorithm-add_mono"><span class="command">lemma</span></span> add_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">m</span> <span class="main">::</span> nat<span class="main">)</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">⟹</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="free">ns</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="free">n</span> <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-add_max"><span class="command">lemma</span></span> add_max <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="free">ns</span><span class="main">)</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">(</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">)</span> <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> impCE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> bspec<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> order_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> add_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-enum_length"><span class="command">lemma</span></span> enum_length<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Algorithm-enum_add_le"><span class="command">lemma</span></span> enum_add_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def add_zeros<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>enum <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">≤</span> length <span class="skolem">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">_</span> <span class="main">_</span> <span class="var">?ns</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span><span class="var">?ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="var">?ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="var">?ns</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_update<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-enum_max_le"><span class="command">lemma</span></span> enum_max_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> Max <span class="main">(</span>set <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> length <span class="free">xs</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> Max <span class="main">(</span>set <span class="var">?ns</span><span class="main">)</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> add_max <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ns</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> enum_add_le <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">index</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enum_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-mini_less"><span class="command">lemma</span></span> mini_less<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> mini <span class="free">xs</span> <span class="free">key</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Algorithm-maxi_less"><span class="command">lemma</span></span> maxi_less<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> maxi <span class="free">xs</span> <span class="free">key</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Algorithm-mini_lb"><span class="command">lemma</span></span> mini_lb<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> mini <span class="free">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-maxi_ub"><span class="command">lemma</span></span> maxi_ub<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">key</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-mini_maxi_neq"><span class="command">lemma</span></span> mini_maxi_neq <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟶</span> mini <span class="free">xs</span> <span class="free">key</span> <span class="main">≠</span> maxi <span class="free">xs</span> <span class="free">key</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> maxi <span class="skolem">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> mini <span class="skolem">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> maxi <span class="skolem">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> mini <span class="skolem">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"mini <span class="skolem">xs</span> <span class="free">key</span> <span class="main">&lt;</span> length <span class="skolem">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mini_less<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs</span> <span class="main">!</span> mini <span class="skolem">xs</span> <span class="free">key</span> <span class="main">∈</span> set <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> mini <span class="skolem">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> maxi <span class="skolem">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> maxi_ub<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-mini_maxi_nths"><span class="command">lemma</span></span> mini_maxi_nths<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="main">(</span>nths <span class="free">xs</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span>mini <span class="free">xs</span> <span class="free">key</span><span class="main">,</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> length <span class="free">xs</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_nths <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> allI<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_Suc_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> mini <span class="free">xs</span> <span class="free">key</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{..&lt;</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>mini <span class="free">xs</span> <span class="free">key</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span>maxi <span class="free">xs</span> <span class="free">key</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> mini <span class="free">xs</span> <span class="free">key</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">≠</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Diff_singleton_if<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mini_maxi_neq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_less <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span> maxi_less <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span> A <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-mini_maxi_nths_le"><span class="command">lemma</span></span> mini_maxi_nths_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="main">⟹</span> length <span class="main">(</span>nths <span class="free">xs</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span>mini <span class="free">xs</span> <span class="free">key</span><span class="main">,</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Algorithm-round_nil"><span class="command">lemma</span></span> round_nil<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> set <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="Algorithm-round_max_eq"><span class="command">lemma</span></span> round_max_eq <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span>
    Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>
 prod.split <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> FalseE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span>
    Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">u'</span> <span class="skolem">ns'</span> <span class="skolem">xs'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">⟶</span> Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> set <span class="skolem">ns</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> set <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">ns</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-round_max_less"><span class="command">lemma</span></span> round_max_less <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>
 prod.split <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ballI<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
    Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">0</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">u'</span> <span class="skolem">ns'</span> <span class="skolem">xs'</span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
      Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
    Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">ns'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">n'</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span> <span class="skolem">u'</span> <span class="skolem">ns'</span> <span class="skolem">xs'</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">n</span> <span class="bound">n'</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r'</span> <span class="bound">v</span><span class="main">.</span> round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="bound">r'</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">n'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span>
    <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> bn_comp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> bn_comp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span>
    <span class="bound">d</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">⟹</span>
      <span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
        Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?t</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"bn_comp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
    Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ms'</span> <span class="main">∪</span> set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">&lt;</span>
    Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Max_less_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule_tac</span> UnE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mini <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxi <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nmi</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xmi</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">n</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">n</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">n</span> <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">n'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nths <span class="var">?ws</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="var">?zs</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?k</span> <span class="var">?mi</span> <span class="var">?ma</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">∨</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="var">?ms</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="var">?ms</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Max <span class="main">(</span>set <span class="var">?ms</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="var">?ms</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> length_pos_if_in_set<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="var">?ms</span><span class="main">)</span> <span class="main">≤</span> length <span class="var">?zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enum_max_le<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> length <span class="var">?zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?zs</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mini_maxi_nths_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">ns'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ns'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> length_pos_if_in_set<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?t</span> <span class="skolem">r'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">n</span> <span class="main">∈</span> set <span class="skolem">ns</span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_nil<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> E <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> set <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="var">?t</span> <span class="skolem">r'</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> round_max_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> Max <span class="main">(</span>set <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> Max <span class="main">(</span>insert <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="quoted">gcsort_aux</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">index</span><span class="main">,</span> <span class="bound">key</span><span class="main">,</span> <span class="bound">p</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span><span class="main">.</span> Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="bound">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_None_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">i</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcsort_round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">ns</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> set <span class="skolem">ns</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> length_pos_if_in_set<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i</span> <span class="main">∈</span> set <span class="skolem">ns</span><span class="main">.</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Max_gr_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> round_max_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="main"><span class="main"><span class="main">0</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ns</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">xs</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>set <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> Max <span class="main">(</span>set <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Now steps 2, 3, and 4 of the proof method, which are independent of the properties to be proven, can
be accomplished. Particularly, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> constitutes the complete formal definition of
GCsort, as it puts the algorithm's inputs and outputs into their expected form.

Observe that the conditional expression contained in the definition of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_aux<span class="antiquote"><span class="antiquote">}</span></span></span></span>
need not be reflected in the definition of inductive set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_set</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as just one alternative
gives rise to a recursive call, viz. as its only purpose is to ensure the function's termination.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gcsort_in</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gcsort_in</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gcsort_out</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gcsort_out</span> <span class="main">≡</span> snd <span class="main">∘</span> snd"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">gcsort</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span>
  <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">gcsort</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> gcsort_out <span class="main">(</span>gcsort_aux <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>gcsort_in <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">inductive_set</span></span> <span class="entity">gcsort_set</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> index_sign <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span>
  nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span>nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list<span class="main">)</span> set"</span></span>
<span class="keyword2"><span class="keyword">for</span></span> <span class="entity">index</span> <span class="entity">key</span> <span class="entity">p</span> <span class="entity">t</span> <span class="keyword2"><span class="keyword">where</span></span>
R0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> <span class="free">gcsort_set</span> <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span>"</span></span> <span class="main">|</span>
R1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">∈</span> <span class="free">gcsort_set</span> <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span> <span class="main">⟹</span>
  gcsort_round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∈</span> <span class="free">gcsort_set</span> <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span>"</span></span>

<span class="keyword1" id="Algorithm-gcsort_subset"><span class="command">lemma</span></span> gcsort_subset<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t'</span> <span class="main">∈</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t'</span> <span class="main">⊆</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subsetI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> gcsort_set.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R1<span class="main">)</span>

<span class="keyword1" id="Algorithm-gcsort_aux_set"><span class="command">lemma</span></span> gcsort_aux_set<span class="main">:</span>
 <span class="quoted"><span class="quoted">"gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span> <span class="main">∈</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gcsort_aux.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> R0<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"gcsort_round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">ns</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"gcsort_aux <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="var">?t</span> <span class="main">∈</span> gcsort_set <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="var">?t</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">∈</span> gcsort_set <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R0<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">∈</span> gcsort_set <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"gcsort_set <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="var">?t</span> <span class="main">⊆</span> gcsort_set <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_subset<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"gcsort_aux <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="var">?t</span>
    <span class="main">∈</span> gcsort_set <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Proof of a preliminary invariant"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
This section is dedicated to the proof of the invariance of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">add_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, defined here
below, over inductive set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_set<span class="antiquote"><span class="antiquote">}</span></span></span></span>. This invariant will later be used to prove GCsort's
correctness properties.

Another predicate, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">bn_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, is also defined, using predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bn_valid<span class="antiquote"><span class="antiquote">}</span></span></span></span> defined above.

\null
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bn_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bn_inv</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">n</span> <span class="keyword1">of</span> Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span> bn_valid <span class="bound">m</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> True<span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">add_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">add_inv</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Algorithm-gcsort_add_input"><span class="command">lemma</span></span> gcsort_add_input<span class="main">:</span>
 <span class="quoted"><span class="quoted">"add_inv <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Algorithm-add_base"><span class="command">lemma</span></span> add_base<span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">(</span><span class="free">k</span> <span class="main">+</span> <span class="free">m</span><span class="main">)</span> <span class="free">ns</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="free">ns</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">m</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-add_base_zero"><span class="command">lemma</span></span> add_base_zero<span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="free">k</span> <span class="free">ns</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span> <span class="main">+</span> <span class="main">(</span><span class="free">k</span> <span class="main">::</span> nat<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> add_base <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ns</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-bn_count_le"><span class="command">lemma</span></span> bn_count_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"bn_count <span class="free">ns</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bn_count.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_base_zero<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below is the proof of the main property of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bn_inv<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which states that if the
objects' number is not larger than the counters' upper bound, then, as long as there are buckets to
be split, the arguments $p$ and $q$ passed by function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> round<span class="antiquote"><span class="antiquote">}</span></span></span></span> to function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> bn_comp<span class="antiquote"><span class="antiquote">}</span></span></span></span>
are such that $0 &lt; q \leq p$.

\null
›</span></span>

<span class="keyword1" id="Algorithm-bn_inv_intro"><span class="command">lemma</span></span> bn_inv_intro <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">⟶</span>
    bn_inv <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> <span class="free">ns</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">ns</span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ns</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span>
      bn_valid <span class="bound">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> <span class="skolem">n</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span>
      bn_valid <span class="bound">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">ns</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span>
      bn_valid <span class="bound">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>
        <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> allI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"bn_valid <span class="main">_</span> <span class="var">?p</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> bn_valid.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">m</span></span><span class="main"><span class="main">,</span></span> <span class="var"><span class="var">?p</span></span><span class="main"><span class="main">,</span></span> <span class="var"><span class="var">?q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bn_count_le<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="skolem">ns</span> <span class="main">=</span>
        foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span>bn_count <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span>bn_count <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="skolem">ns</span> <span class="main">≤</span>
        <span class="free">p</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="main">(</span>bn_count <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n'</span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">∈</span> set <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">n'</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> True <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">m</span><span class="main">)</span> <span class="main">⇒</span>
      bn_valid <span class="bound">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n'</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>
      <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"bn_valid <span class="main">_</span> <span class="var">?p</span> <span class="var">?q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bn_valid.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">m</span></span><span class="main"><span class="main">,</span></span> <span class="var"><span class="var">?p</span></span><span class="main"><span class="main">,</span></span> <span class="var"><span class="var">?q</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">p'</span> <span class="skolem">q'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">&lt;</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="free">p</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">-</span> bn_count <span class="main">(</span><span class="skolem">n</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">q'</span> <span class="main">∧</span> <span class="skolem">q'</span> <span class="main">≤</span> <span class="skolem">p'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bn_count.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span> <span class="main"><span class="main"><span class="main">#</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">ns</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, the invariance of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> add_inv<span class="antiquote"><span class="antiquote">}</span></span></span></span> over inductive set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_set<span class="antiquote"><span class="antiquote">}</span></span></span></span>
is then proven as lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_add_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It holds under the conditions that the objects'
number is not larger than the counters' upper bound and function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> satisfies predicate
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> index_less<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and states that, if the counters' sum initially matches the objects' number,
this is still true after any recursive round.

\null
›</span></span>

<span class="keyword1" id="Algorithm-bn_comp_fst_ge"><span class="command">lemma</span></span> bn_comp_fst_ge <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"bn_valid <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟶</span> <span class="free">n</span> <span class="main">≤</span> fst <span class="main">(</span>bn_comp <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bn_comp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> mult_Suc<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">r</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">q</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">div</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">≤</span> <span class="skolem">p</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono2<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="keyword1">div</span> <span class="skolem">q</span> <span class="main">≤</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> div_le_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">r</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-bn_comp_fst_nonzero"><span class="command">lemma</span></span> bn_comp_fst_nonzero<span class="main">:</span>
 <span class="quoted"><span class="quoted">"bn_valid <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">&lt;</span> fst <span class="main">(</span>bn_comp <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> bn_comp_fst_ge <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> r <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">r</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-bn_comp_snd_less"><span class="command">lemma</span></span> bn_comp_snd_less<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="main">⟹</span> snd <span class="main">(</span>bn_comp <span class="free">n</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> bn_comp.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-add_replicate"><span class="command">lemma</span></span> add_replicate<span class="main">:</span>
 <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="free">k</span> <span class="main">(</span>replicate <span class="free">m</span> <span class="free">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span> <span class="main">+</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Algorithm-fill_length"><span class="command">lemma</span></span> fill_length<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="main">(</span>fill <span class="free">xs</span> <span class="free">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>

<span class="keyword1" id="Algorithm-enum_add"><span class="command">lemma</span></span> enum_add <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def add_zeros<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="main">(</span>enum <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">&lt;</span> length <span class="var">?ns</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span><span class="var">?ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="var">?ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_update<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ns</span> <span class="main">=</span> length <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span><span class="var">?ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="var">?ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-round_add_inv"><span class="command">lemma</span></span> round_add_inv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span> <span class="main">⟶</span> bn_inv <span class="free">p</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟶</span> add_inv <span class="free">n</span> <span class="free">t</span> <span class="main">⟶</span>
    add_inv <span class="free">n</span> <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span>
 <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ssubst <span class="main"><span class="main">[</span></span><span class="operator">OF</span> add_base_zero<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_suc<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">ns'</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n'</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">⟶</span>
    foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> length <span class="skolem">xs'</span> <span class="main">=</span> <span class="bound">n'</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">⟶</span>
    foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">∧</span> length <span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span> Suc <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">ns</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span> <span class="skolem">ns'</span> <span class="skolem">n</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r'</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">m</span> <span class="skolem">m'</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="skolem">index</span> <span class="skolem">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">n'</span><span class="main">.</span>
    <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span>
    <span class="bound">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">=</span> <span class="skolem">ms'</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">⟹</span>
      foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">⟶</span>
        foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> length <span class="skolem">xs'</span> <span class="main">=</span> <span class="bound">n'</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="skolem">m</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∧</span> length <span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> A <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">+</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ms'</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span>
    length <span class="skolem">ws'</span> <span class="main">+</span> length <span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>
   if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">#</span> Suc <span class="main">0</span> <span class="main">#</span> replicate <span class="skolem">m</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ms'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms'</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">#</span> Suc <span class="main">0</span> <span class="main">#</span> replicate <span class="skolem">m</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ms'</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_replicate<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">+</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ms'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">=</span> <span class="skolem">ws'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> <span class="var">?ws</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">+</span> length <span class="skolem">xs'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mini <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxi <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nmi</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xmi</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nths <span class="var">?ws</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="var">?zs</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?k</span> <span class="var">?mi</span> <span class="var">?ma</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">#</span> <span class="var">?ms</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="main">0</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ms'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ms'</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="var">?ms</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="main">0</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
     <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">#</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">ws'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ws'</span> <span class="main">=</span> <span class="var">?xmi</span> <span class="main">#</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span>
      <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">m</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> 0
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?ms</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">+</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span>
        Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> length <span class="skolem">xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> Suc
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> fst <span class="main">(</span>bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bn_comp_fst_nonzero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">=</span> length <span class="var">?zs</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enum_add <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C H<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>
         <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?ws</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?zs</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span> <span class="main">+</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∧</span>
        Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> length <span class="skolem">xs'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-gcsort_add_inv"><span class="command">lemma</span></span> gcsort_add_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t'</span> <span class="main">∈</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span><span class="main">;</span> add_inv <span class="free">n</span> <span class="free">t</span><span class="main">;</span> <span class="free">n</span> <span class="main">≤</span> <span class="free">p</span><span class="main">⟧</span> <span class="main">⟹</span>
    add_inv <span class="free">n</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gcsort_set.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> round_add_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>
 bn_inv.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bn_inv_intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">"Proof of counters' optimization"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
In this section, it is formally proven that the number of the counters (and then of the buckets as
well) used in each recursive round is maximized never exceeding the fixed upper bound.

This property is formalized by theorem <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">round_len</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which holds under the condition that the
objects' number is not larger than the counters' upper bound and states what follows:

\begin{itemize}

\item
While there is some bucket with size larger than two, the sum of the number of the used counters and
the number of the unused ones -- viz. those, if any, left unused due to the presence of some bucket
with size larger than two and equal minimum and maximum keys (cf. section \ref{SEC4}) -- matches the
counters' upper bound.
\\In addition to ensuring the upper bound's enforcement, this implies that the number of the used
counters matches the upper bound unless there is some aforesaid bucket not followed by any other
bucket with size larger than two and distinct minimum and maximum keys.

\item
Once there is no bucket with size larger than two -- in which case a round is executed just in case
there is some bucket with size two --, the number of the used counters matches the objects' number.
\\In fact, the algorithm immediately terminates after such a round since every resulting bucket has
size one, so that increasing the number of the used counters does not matter in this case.

\end{itemize}

\null
›</span></span>

<span class="keyword1" id="Algorithm-round_len_less"><span class="command">lemma</span></span> round_len_less <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"bn_inv <span class="free">p</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟶</span> <span class="free">r</span> <span class="main">&lt;</span> <span class="free">q</span> <span class="main">⟶</span>
  <span class="main">(</span><span class="free">r</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="free">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span>
    <span class="main">(</span>fst <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span> <span class="main">+</span>
      length <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span> <span class="main">=</span>
    <span class="main">(</span>fst <span class="free">t</span> <span class="main">+</span> bn_count <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">q</span> <span class="main">+</span>
      <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="free">p</span> <span class="main">+</span> <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def
 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 add_suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">n'</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span> <span class="skolem">u'</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_comp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bn_count_le<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span>
    <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span>
    <span class="bound">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">=</span> <span class="skolem">ms'</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">⟹</span>
      <span class="skolem">r'</span> <span class="main">&lt;</span> <span class="skolem">q</span> <span class="main">⟶</span> <span class="main">(</span><span class="skolem">r'</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">=</span>
        <span class="main">(</span><span class="skolem">v</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">r'</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>bn_comp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bn_comp_snd_less<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">r'</span> <span class="main">&lt;</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r</span> <span class="main">+</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span>
    bn_count <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">r'</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">q</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> trans <span class="main"><span class="main">[</span></span><span class="operator">OF</span> _ E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> bn_comp.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">n</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">p</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">q</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib diff_mult_distrib mod_add_left_eq<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> arg_cong2 <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> f <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(mod)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono1<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">-</span> bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">p</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">*</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">v</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> B <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> <span class="main">(</span>length <span class="skolem">ms'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> bn_count <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">+</span>
      <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p</span> <span class="main">+</span> <span class="skolem">r</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bn_comp.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="skolem"><span class="skolem">n</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">p</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">q</span></span><span class="main"><span class="main">,</span></span> <span class="skolem"><span class="skolem">r</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def enum_length <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="skolem">p'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
     <span class="quoted"><span class="quoted">"<span class="skolem">r</span> <span class="main">=</span> <span class="skolem">r'</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> fst <span class="main">(</span>bn_comp <span class="skolem">n</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bn_comp_fst_ge<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">*</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r'</span><span class="main">)</span> <span class="keyword1">div</span> <span class="skolem">q'</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> <span class="var">?a</span> <span class="keyword1">div</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">≤</span> <span class="var">?a</span> <span class="keyword1">div</span> <span class="skolem">q'</span> <span class="main">*</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono1<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">div</span> <span class="skolem">q'</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span>
        <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">mod</span> <span class="skolem">q'</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">+</span>
        <span class="var">?a</span> <span class="keyword1">div</span> <span class="skolem">q'</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">mod</span> <span class="skolem">q'</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="var">?d</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib diff_mult_distrib<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">≤</span> <span class="var">?a</span> <span class="keyword1">div</span> <span class="skolem">q'</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">mod</span> <span class="skolem">q'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q'</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">*</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">≤</span> <span class="var">?a</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span>
       <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span>bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span>
          <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">-</span> bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> <span class="var">?b</span> <span class="main">+</span> <span class="var">?b</span> <span class="main">=</span>
        <span class="var">?a</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span>bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span>
          <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">-</span> bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?e</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span>
      <span class="main">(</span><span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">+</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib diff_mult_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">=</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">p'</span> <span class="skolem">q'</span> <span class="skolem">r'</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">=</span> bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span>
      <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">p'</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">*</span> <span class="skolem">p'</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">r'</span><span class="main">)</span> <span class="keyword1">mod</span> <span class="skolem">q'</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">+</span> <span class="main">_</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">mod</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">div</span> <span class="skolem">q'</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">+</span> <span class="var">?a</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="var">?d</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u'</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> <span class="var">?a</span> <span class="keyword1">div</span> <span class="skolem">q'</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?e</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">*</span> <span class="skolem">p'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono1<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u</span> <span class="main">+</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">q'</span> <span class="main">+</span>
      <span class="main">(</span><span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">-</span> bn_count <span class="skolem">ns</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">p'</span> <span class="main">+</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?f</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_mult_distrib diff_mult_distrib<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?e</span> <span class="main">=</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Algorithm-round_len_eq"><span class="command">lemma</span></span> round_len_eq <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"bn_count <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span>
    length <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def
 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> all_simps<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
 add_suc<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_base_zero<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">n</span> <span class="skolem">ns</span> <span class="skolem">n'</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">r'</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">n</span> <span class="skolem">n'</span> <span class="skolem">u</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_count <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span><span class="main">.</span>
    <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">n'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span>
    <span class="bound">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">=</span> <span class="skolem">ms'</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">⟹</span>
      bn_count <span class="skolem">ns</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">⟶</span> length <span class="skolem">ns'</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bn_comp.cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">(</span></span></span><span class="skolem"><span class="skolem"><span class="skolem">n</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">p</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">q</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">r</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">insert</span> bn_count_le <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">ns</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="skolem">ns</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ns'</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ms'</span> <span class="main">+</span> length <span class="skolem">ns'</span> <span class="main">=</span>
    Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> disjE <span class="main"><span class="main">[</span></span><span class="operator">OF</span> C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span>
     <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def enum_length <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">theorem</span></span> round_len<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> bn_count <span class="free">ns</span> <span class="main">&lt;</span> length <span class="free">xs</span>
    <span class="keyword1">then</span> fst <span class="main">(</span>gcsort_round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">ns</span> <span class="free">xs</span><span class="main">)</span> <span class="main">+</span>
      length <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>gcsort_round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">ns</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">p</span>
    <span class="keyword1">else</span> length <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>gcsort_round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">ns</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">if</span> <span class="main">_</span> <span class="keyword1">then</span> fst <span class="var">?t</span> <span class="main">+</span> <span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="keyword1">else</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_count <span class="free">ns</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"bn_inv <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="free">ns</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> bn_inv_intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span>fst <span class="var">?t</span> <span class="main">+</span> length <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">=</span>
    bn_count <span class="free">ns</span> <span class="main">*</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">+</span>
      <span class="main">(</span><span class="free">p</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> bn_count <span class="free">ns</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">*</span> <span class="var">?b</span> <span class="main">=</span> <span class="var">?c</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> round_len_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="free">ns</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="free">ns</span> <span class="main">*</span> <span class="var">?b</span> <span class="main">≤</span> <span class="free">p</span> <span class="main">*</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_le_mono1<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?c</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="var">?b</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> diff_mult_distrib<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">*</span> <span class="var">?b</span> <span class="main">=</span> <span class="free">p</span> <span class="main">*</span> <span class="var">?b</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?a</span> <span class="main">=</span> <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> bn_count <span class="free">ns</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_count <span class="free">ns</span> <span class="main">≤</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bn_count_le<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fst <span class="main">(</span>snd <span class="var">?t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> round_len_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Conservation">
<div class="head">
<h1>Theory Conservation</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Efficient Generalization of Counting Sort for Large, possibly Infinite Key Ranges
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Proof of objects' conservation"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Conservation
  <span class="keyword2"><span class="keyword">imports</span></span> 
    <a href="#Algorithm">Algorithm</a> 
    <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Library/Multiset.html">HOL-Library.Multiset</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In this section, it is formally proven that GCsort \emph{conserves objects}, viz. that the objects'
list returned by function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort<span class="antiquote"><span class="antiquote">}</span></span></span></span> contains as many occurrences of any given object as the
input objects' list.

Here below, steps 5, 6, and 7 of the proof method are accomplished. Particularly, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">count_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is the predicate that will be shown to be invariant over inductive set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_set<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">count_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> nat<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">count_inv</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Conservation-gcsort_count_input"><span class="command">lemma</span></span> gcsort_count_input<span class="main">:</span>
 <span class="quoted"><span class="quoted">"count_inv <span class="main">(</span>count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Conservation-gcsort_count_intro"><span class="command">lemma</span></span> gcsort_count_intro<span class="main">:</span>
 <span class="quoted"><span class="quoted">"count_inv <span class="free">f</span> <span class="free">t</span> <span class="main">⟹</span> count <span class="main">(</span>mset <span class="main">(</span>gcsort_out <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">f</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The main task to be accomplished to prove that GCsort conserves objects is to prove that so does
function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span> in case its input offsets' list is computed via the composition of functions
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> enum<span class="antiquote"><span class="antiquote">}</span></span></span></span>, as happens within function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> round<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

To achieve this result, a multi-step strategy will be adopted. The first step, addressed here below,
opens with the definition of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">offs_pred</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, satisfied by an offsets' list $ns$ and an
objects' list $xs$ just in case each bucket delimited by $ns$ is sufficiently large to accommodate
the corresponding objects in $xs$. Then, lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">offs_pred_cons</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> shows that this predicate, if
satisfied initially, keeps being true if each object in $xs$ is consumed as happens within function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span>, viz. increasing the corresponding offset in $ns$ by one.

\null
›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">offs_num</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs_num</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  length <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">offs_set_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs_set_next</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">k</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">offs_set_prev</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs_set_prev</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  <span class="main">{</span><span class="bound">k</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">∧</span> <span class="bound">k</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">k</span><span class="main">}</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">offs_next</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs_next</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  <span class="keyword1">if</span> offs_set_next <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">{}</span>
  <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> Min <span class="main">(</span>offs_set_next <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">offs_none</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs_none</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">j</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> <span class="bound">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">j</span><span class="main">..&lt;</span>
      offs_next <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">j</span><span class="main">}</span><span class="main">)</span> <span class="main">∨</span>
  offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> offs_next <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">0</span> <span class="main">∨</span>
  <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">0</span> <span class="main">∧</span>
    <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> <span class="main">0</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">offs_pred</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> index_sign <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">offs_pred</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="main">≡</span>
  <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> offs_num <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">i</span> <span class="main">≤</span>
    offs_next <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="free"><span class="bound"><span class="entity">ub</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="free"><span class="bound"><span class="entity">index</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="free"><span class="bound"><span class="entity">mi</span></span></span> <span class="free"><span class="bound"><span class="entity">ma</span></span></span> <span class="bound">i</span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">!</span> <span class="bound">i</span>"</span></span>

<span class="keyword1" id="Conservation-offs_num_cons"><span class="command">lemma</span></span> offs_num_cons<span class="main">:</span>
 <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span> <span class="keyword1">then</span> Suc <span class="keyword1">else</span> id<span class="main">)</span> <span class="main">(</span>offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_def<span class="main">)</span>

<span class="keyword1" id="Conservation-offs_next_prev"><span class="command">lemma</span></span> offs_next_prev<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">∧</span>
    offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
    Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">∧</span>
    offs_set_prev <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
    Max <span class="main">(</span>offs_set_prev <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">=</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Max_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">k</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">from</span></span> E <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
      <span class="keyword3"><span class="command">assume</span></span>
       <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">j</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
       <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> Max <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_next_cons_eq"><span class="command">lemma</span></span> offs_next_cons_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span> <span class="main">∨</span>
      Max <span class="main">(</span>offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span> <span class="main">≠</span> <span class="free">j</span> <span class="main">⟹</span>
    offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
      offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∨</span> <span class="var">?Q</span> <span class="main">⟹</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> disj_imp<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> Max <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span> <span class="main">⟶</span> <span class="var">?Q</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> Max <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> Max <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
    <span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> Min <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">≤</span> Max <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
    <span class="free">ns</span> <span class="main">!</span> Min <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?C</span> <span class="main">≤</span> Min <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?C</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?C</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?C</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">≤</span> Min <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">=</span> Min <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">!</span> Min <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> Min <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> False <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span> <span class="main">!</span> Min <span class="var">?B</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">!</span> Min <span class="var">?B</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_next_cons_neq"><span class="command">lemma</span></span> offs_next_cons_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>
     <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>
     <span class="keyword1">else</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>
     if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">∧</span> <span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
    Min <span class="var">?A</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_next_prev<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
    Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nth_list_update_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
    offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>
   if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">≤</span> Max <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> B <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nth_list_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>
      <span class="main">∈</span> offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_ub_aux"><span class="command">lemma</span></span> offs_pred_ub_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">.</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">⟶</span>
      <span class="free">ns</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> strict_inc_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> allI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">drule</span> le_less_Suc_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ns</span> <span class="main">=</span> Suc <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">=</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_next_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">ub</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> offs_num <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">.</span> Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">k</span> <span class="main">⟶</span>
      <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">k</span> <span class="main">⟶</span>
      <span class="free">ns</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">k</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">ub</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_ub"><span class="command">lemma</span></span> offs_pred_ub<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">;</span>
   <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> offs_pred_ub_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Conservation-offs_pred_asc_aux"><span class="command">lemma</span></span> offs_pred_asc_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span>
    <span class="main">∀</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">⟶</span>
      <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">⟶</span>
      <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">k</span> <span class="main">⟶</span>
      <span class="free">ns</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="bound">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> strict_inc_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_pred_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span> <span class="bound">k</span><span class="main">.</span> <span class="bound">k</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟶</span> Suc <span class="skolem">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟶</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">k</span> <span class="main">⟶</span>
      <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">⟶</span>
      <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">k</span> <span class="main">⟶</span>
      <span class="free">ns</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="bound">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">n</span></span> <span class="main">&gt;</span> <span class="skolem">j</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟶</span>
      offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">∨</span> Min <span class="var">?A</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">≤</span> Min <span class="var">?A</span> <span class="main">⟶</span> Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟶</span>
        <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="free">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_asc"><span class="command">lemma</span></span> offs_pred_asc<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span><span class="main">;</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">;</span>
   <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">;</span>
   <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> offs_pred_asc_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> less_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> order_refl<span class="main">)</span>

<span class="keyword1" id="Conservation-offs_pred_next"><span class="command">lemma</span></span> offs_pred_next<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_pred_ub<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>
    <span class="main">∈</span> offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
    <span class="free">ns</span> <span class="main">!</span> Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">ns</span> <span class="main">!</span> Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_next_cons_less"><span class="command">lemma</span></span> offs_pred_next_cons_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">&lt;</span>
    offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">∧</span>
    offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
    Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_next_prev<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>
    <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>
    <span class="keyword1">else</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_next_cons_neq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_next_cons"><span class="command">lemma</span></span> offs_pred_next_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">≤</span>
    offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≤</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">∧</span>
    Max <span class="main">(</span>offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∨</span> <span class="main">¬</span> <span class="var">?P</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next_cons_less <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?P</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="var">?M</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_cons_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B C D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_cons"><span class="command">lemma</span></span> offs_pred_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_pred <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_pred_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">.</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">≤</span>
      offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">j</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="bound">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
    offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">-</span> <span class="var">?ns'</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
      offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
      offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
       offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
      offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">-</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
      offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
      offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
       offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
      offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">-</span> <span class="free">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The next step consists of proving, as done in lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">fill_count_item</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in what follows, that if
certain conditions hold, particularly if offsets' list $ns$ and objects' list $xs$ satisfy predicate
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs_pred<span class="antiquote"><span class="antiquote">}</span></span></span></span>, then function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span> conserves objects if called using $xs$ and $ns$ as
its input arguments.

This lemma is proven by induction on $xs$. Hence, lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] offs_pred_cons<span class="antiquote"><span class="antiquote">}</span></span></span></span>, proven in
the previous step, is used to remove the antecedent containing predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs_pred<span class="antiquote"><span class="antiquote">}</span></span></span></span> from the
induction hypothesis, which has the form of an implication.

\null
›</span></span>

<span class="keyword1" id="Conservation-offs_next_zero"><span class="command">lemma</span></span> offs_next_zero<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    offs_set_next <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
   not_less<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∨</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> offs_set_prev <span class="free">ns</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_next_zero_cons_eq"><span class="command">lemma</span></span> offs_next_zero_cons_eq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> Min <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">=</span> Min <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Min <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> offs_set_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>
    <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons A <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?C</span> <span class="main">=</span> Min <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Min <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span>
     <span class="main">(</span><span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_next_zero_cons_neq"><span class="command">lemma</span></span> offs_next_zero_cons_neq<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>
     <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>
     <span class="keyword1">else</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="var">?ns'</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span>
     if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="var">?ns'</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_cons_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_zero_cons_less"><span class="command">lemma</span></span> offs_pred_zero_cons_less<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">&lt;</span>
    offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"Min <span class="main">(</span>offs_set_next <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> Min_eq_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">=</span> <span class="free">ns</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>
    <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>
    <span class="keyword1">else</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_next_zero_cons_neq<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">split</span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_pred_zero_cons"><span class="command">lemma</span></span> offs_pred_zero_cons<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">≤</span>
    offs_next <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">≤</span> <span class="var">?N</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?M</span> <span class="main">&lt;</span> <span class="var">?N</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_zero_cons_less <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?N</span> <span class="main">=</span> <span class="var">?M</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_next_zero_cons_eq <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B D<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-replicate_count"><span class="command">lemma</span></span> replicate_count<span class="main">:</span>
 <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>replicate <span class="free">n</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Conservation-fill_none"><span class="command">lemma</span></span> fill_none <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
    offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    offs_none <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟶</span>
      fill <span class="free">xs</span> <span class="free">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def offs_num_def offs_next_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">[</span><span class="var">?i'</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_none <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_pred <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ns</span><span class="main">.</span> <span class="bound">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> offs_pred <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    offs_none <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟶</span>
    fill <span class="skolem">xs</span> <span class="bound">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟶</span>
      fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">insert</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_all
   <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> case_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> subst_all<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>5<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">ns</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_not not_gr0<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">∧</span>
        <span class="var">?ns'</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span>
        <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">⟶</span>
          fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
        offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?j'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"Max <span class="main">(</span>offs_set_prev <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j'</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">∧</span>
        <span class="var">?ns'</span> <span class="main">!</span> <span class="var">?j'</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span>
        <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">⟶</span>
          fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?j'</span> <span class="main">∈</span> offs_set_prev <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?j'</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">∧</span> <span class="var">?j'</span> <span class="main">&lt;</span> <span class="skolem">j</span> <span class="main">∧</span>
        <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> offs_num_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?j'</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>
        <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> <span class="var">?j'</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nth_list_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> <span class="var">?j'</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span><span class="skolem">ns</span><span class="main">[</span><span class="skolem">j</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">=</span>
       <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>
        <span class="keyword1">then</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span>
        <span class="keyword1">else</span> offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_cons_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span> <span class="main">=</span>
        offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?j'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">⟶</span>
          fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
        K<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        L<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">=</span>
        offs_set_prev <span class="var">?ns'</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="var">?ns'</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
        offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">=</span>
        offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_next_cons_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword2"><span class="keyword">and</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">≠</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less le_less<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">∈</span> offs_set_next <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?i'</span> <span class="main">∨</span> Min <span class="var">?A</span> <span class="main">=</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>
          <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">∧</span>
        <span class="var">?ns'</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="main">∧</span>
        <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">⟶</span>
          fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span> <span class="main">≤</span>
        offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">∈</span> offs_set_next <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?i'</span> <span class="main">∨</span> Min <span class="var">?A</span> <span class="main">=</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>
          <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">⟶</span>
          fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">≤</span>
        offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_zero_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="main">(</span><span class="skolem">ns</span><span class="main">[</span><span class="main">0</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="var">?ns'</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⟶</span>
        fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="var">?ns'</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span> <span class="main">∧</span>
        <span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">⟶</span>
          fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
        offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_cons_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span> <span class="main">&lt;</span> offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">≠</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> B G E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
         offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="var">?ns'</span> <span class="main">!</span> <span class="main">0</span> <span class="main">⟶</span>
        fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="var">?ns'</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-fill_index_none"><span class="command">lemma</span></span> fill_index_none <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="free">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span> <span class="main">⟹</span>
    fill <span class="free">xs</span> <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="main">(</span><span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">:=</span>
      Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span>
        <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> fill <span class="main">_</span> <span class="var">?ns'</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">!</span> <span class="main">(</span><span class="main">_</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_none<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> offs_pred_cons<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">cases</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span>
    <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>
    <span class="keyword1">else</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_zero_cons_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> offs_pred_next <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_prev <span class="free">ns</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> offs_num_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">split</span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span>
    <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span>
    <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">=</span>
   <span class="main">(</span><span class="keyword1">if</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span>
    <span class="keyword1">then</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>
    <span class="keyword1">else</span> offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_cons_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> offs_pred_next <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">=</span>
    offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_next_cons_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> offs_pred_next <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-fill_count_item"><span class="command">lemma</span></span> fill_count_item <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
    offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    length <span class="free">xs</span> <span class="main">≤</span> <span class="free">ub</span> <span class="main">⟶</span>
      count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="free">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
      count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> the None <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ub</span> <span class="main">-</span> length <span class="free">xs</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replicate_count<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def map_update <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> count_add_mset mset_map <span class="quasi_keyword">split</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_mset_add_single<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> count_single count_union<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ns</span><span class="main">.</span> <span class="bound">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> offs_pred <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="skolem">xs</span> <span class="bound">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> the None <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ub</span> <span class="main">-</span> length <span class="skolem">xs</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_pred <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> the None <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ub</span> <span class="main">-</span> length <span class="skolem">xs</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span>
    <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_pred_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span><span class="main">(</span>map the <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span>
    <span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> <span class="skolem">y</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span>
    <span class="main">(</span><span class="keyword1">if</span> the None <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ub</span> <span class="main">-</span> length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> mset_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_mset_add_single<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span>
   <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> count_diff count_single count_union<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nth_map<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">subst</span> add.assoc<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> add.commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add.assoc <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">subst</span> add_right_cancel<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_index_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ _ F<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> the None <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ub</span> <span class="main">-</span> length <span class="skolem">xs</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">-</span>
      <span class="main">(</span><span class="keyword1">if</span> the <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
      count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> the None <span class="main">=</span> <span class="free">x</span> <span class="keyword1">then</span> <span class="free">ub</span> <span class="main">-</span> length <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Finally, lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">offs_enum_pred</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> here below proves that, if $ns$ is the offsets' list obtained
by applying the composition of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> enum<span class="antiquote"><span class="antiquote">}</span></span></span></span> to objects' list $xs$, then
predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs_pred<span class="antiquote"><span class="antiquote">}</span></span></span></span> is satisfied by $ns$ and $xs$.

This result is in turn used, together with lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] fill_count_item<span class="antiquote"><span class="antiquote">}</span></span></span></span>, to prove lemma
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">fill_offs_enum_count_item</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which states that function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span> conserves objects if its
input offsets' list is computed via the composition of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> enum<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1" id="Conservation-enum_offs_num"><span class="command">lemma</span></span> enum_offs_num<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span> enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def offs_num_cons<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">subst</span> nth_list_update_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>

<span class="keyword1" id="Conservation-offs_length"><span class="command">lemma</span></span> offs_length<span class="main">:</span>
 <span class="quoted"><span class="quoted">"length <span class="main">(</span>offs <span class="free">ns</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> length <span class="free">ns</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Conservation-offs_add"><span class="command">lemma</span></span> offs_add <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟶</span> offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">k</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ns</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Conservation-offs_mono_aux"><span class="command">lemma</span></span> offs_mono_aux<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span> offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">(</span><span class="free">j</span> <span class="main">-</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_add take_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_le<span class="main">)</span>

<span class="keyword1" id="Conservation-offs_mono"><span class="command">lemma</span></span> offs_mono<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span> offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> offs_mono_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Conservation-offs_update"><span class="command">lemma</span></span> offs_update<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span>
    offs <span class="main">(</span><span class="free">ns</span><span class="main">[</span><span class="free">i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">j</span> <span class="main">≤</span> <span class="free">i</span> <span class="keyword1">then</span> id <span class="keyword1">else</span> Suc<span class="main">)</span> <span class="main">(</span>offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_add not_le take_update_swap<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nth_take <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">assumption</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Conservation-offs_equal_suc"><span class="command">lemma</span></span> offs_equal_suc<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> Suc <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ns</span> <span class="main">@</span> <span class="main">[</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">m</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> take_Suc_conv_app_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> Suc <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_equal"><span class="command">lemma</span></span> offs_equal <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">ns</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">erule</span> strict_inc_induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> offs_equal_suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">ns</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> Suc <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_equal_suc<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="free">m</span> <span class="main">!</span> <span class="free">j</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_enum_last"><span class="command">lemma</span></span> offs_enum_last <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">+</span>
    offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"last <span class="var">?ns</span> <span class="main">=</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> last_conv_nth<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> length_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     enum_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> enum_offs_num<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">k</span> <span class="main">(</span>take <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="var">?ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">k</span> <span class="main">(</span>butlast <span class="var">?ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> butlast_conv_take enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">+</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>
    <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">k</span> <span class="main">(</span>butlast <span class="var">?ns</span> <span class="main">@</span> <span class="main">[</span>last <span class="var">?ns</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="free">k</span> <span class="var">?ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> append_butlast_last_id<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> length_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ns</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> add_base_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> enum_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_enum_ub"><span class="command">lemma</span></span> offs_enum_ub <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">+</span>
    offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_last<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_enum_next_ge"><span class="command">lemma</span></span> offs_enum_next_ge <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span> <span class="main">⟹</span>
    offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span>
        <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> offs <span class="var">?ns</span> <span class="main">_</span> <span class="main">!</span> <span class="main">_</span> <span class="main">≤</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> offs_enum_ub <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> Min <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> length <span class="var">?ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_mono<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_enum_zero_aux"><span class="command">lemma</span></span> offs_enum_zero_aux <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>index_less <span class="free">index</span> <span class="free">key</span><span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">;</span>
   offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span><span class="main">⟧</span> <span class="main">⟹</span>
     offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_enum_last <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> key <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> mi <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span></span></span> <span class="keyword2"><span class="keyword"><span class="quasi_keyword"><span class="quasi_keyword">and</span></span></span></span> ma <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span></span></span><span class="main"><span class="main">,</span></span>
 <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>

<span class="keyword1" id="Conservation-offs_enum_zero"><span class="command">lemma</span></span> offs_enum_zero <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span>
    offs_next <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span>
      <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_zero_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> offs_equal<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length le_less<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule_tac</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> enum_offs_num<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
       offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> enum_offs_num<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_zero_aux<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_equal<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length<span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Min <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?ns</span> <span class="main">!</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> enum_offs_num<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
       offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> enum_offs_num<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_enum_next_cons"><span class="command">lemma</span></span> offs_enum_next_cons <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="keyword1">then</span> <span class="main">(≤)</span> <span class="keyword1">else</span> <span class="main">(&lt;)</span><span class="main">)</span>
    <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>
      <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>
    <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="main">(</span><span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">[</span><span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">:=</span>
      Suc <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span>
      <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="var">?i'</span> <span class="keyword1">then</span> <span class="main">_</span> <span class="keyword1">else</span> <span class="main">_</span><span class="main">)</span>
    <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>
    <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="main">_</span><span class="main">)</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def not_less <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> FalseE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>4<span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>4<span class="main">-</span>5<span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> C <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">≠</span> <span class="var">?i'</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∉</span> <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length
     offs_length offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> D <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">=</span> <span class="var">?i'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Min_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> eq_refl<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> F<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> F<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span> <span class="main">=</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule</span> FalseE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> exE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span> <span class="main">≤</span> offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A'</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span> <span class="main">=</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≥</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> offs_enum_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A'</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> Min <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> Min <span class="var">?A'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length E<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A'</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">∈</span> <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">≤</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> Min <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Min <span class="var">?A'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A'</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> Min <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length D<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length D<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">&lt;</span> offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-offs_enum_pred"><span class="command">lemma</span></span> offs_enum_pred <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    offs_pred <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span>
      <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_pred_def offs_num_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def offs_pred_def offs_length enum_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> allE<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> mp<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="skolem">i</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span><span class="main">[</span><span class="var">?i'</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="var">?ns</span> <span class="main">!</span> <span class="var">?i'</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">-</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?i'</span> <span class="keyword1">then</span> <span class="main">(≤)</span> <span class="keyword1">else</span> <span class="main">(&lt;)</span><span class="main">)</span>
    <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span><span class="main">)</span>
    <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_enum_next_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span>
    offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">-</span>
      offs <span class="var">?ns'</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> offs_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length C<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> linorder_cases <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?i'</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="var">?i'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">-</span>
        offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> <span class="var">?i'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs_num <span class="free">n</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span><span class="main">)</span> <span class="main">≤</span>
      Suc <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span> <span class="main">-</span>
        offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="var">?i'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">from</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span>
      Suc <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span><span class="main">)</span> <span class="main">-</span>
        offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Suc_diff_le <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> offs_enum_next_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs_num <span class="free">n</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span><span class="main">)</span> <span class="main">≤</span>
      Suc <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span><span class="main">)</span> <span class="main">-</span>
        offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span><span class="main">)</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs_num <span class="free">n</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span><span class="main">)</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span> <span class="main">-</span>
        offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">≤</span>
      offs_next <span class="main">(</span>offs <span class="var">?ns'</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">(</span>length <span class="skolem">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">i</span> <span class="main">-</span>
        Suc <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-fill_offs_enum_count_item"><span class="command">lemma</span></span> fill_offs_enum_count_item <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>index_less <span class="free">index</span> <span class="free">key</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
    count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
      <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fill_count_item<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
 offs_length enum_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> offs_enum_pred <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">index</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Using lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] fill_offs_enum_count_item<span class="antiquote"><span class="antiquote">}</span></span></span></span>, step 9 of the proof method can now be dealt
with. It is accomplished by proving lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_count_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which states that the number of
the occurrences of whatever object in the objects' list is still the same after any recursive round.

\null
›</span></span>

<span class="keyword1" id="Conservation-nths_count"><span class="command">lemma</span></span> nths_count<span class="main">:</span>
 <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∉</span> <span class="free">A</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">v</span> <span class="skolem">xs</span> <span class="skolem">A</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span> <span class="main">∧</span> Suc <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="skolem">xs</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">v</span><span class="main">.</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">v</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> <span class="var">?C</span> <span class="bound">v</span> <span class="main">=</span> <span class="var">?C</span> <span class="bound">v</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∪</span> <span class="var">?C</span> <span class="bound">v</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> Suc <span class="bound">j</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> Int_Un_distrib <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> card <span class="main">(</span><span class="var">?C</span> <span class="bound">v</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?C</span> <span class="bound">v</span> <span class="main">∩</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span> <span class="main">+</span> card <span class="main">(</span><span class="var">?C</span> <span class="bound">v</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> Suc <span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> card_Un_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">v</span><span class="main">.</span> card <span class="var">?B</span> <span class="main">=</span> card <span class="main">(</span><span class="var">?C</span> <span class="bound">v</span> <span class="main">∩</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="main">∃</span><span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">=</span> Suc <span class="bound">j</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> bij_betw_same_card <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">Suc</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟶</span> Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="var">?B</span><span class="main">)</span> <span class="main">=</span>
        Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?C</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">v</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="var">?B</span> <span class="main">=</span>
        count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?C</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">0</span> <span class="main">∉</span> <span class="skolem">A</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="skolem">v</span> <span class="main">=</span> <span class="free">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="var">?B</span> <span class="main">=</span>
        Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?C</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">v</span> <span class="main">≠</span> <span class="free">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="var">?B</span> <span class="main">=</span>
        count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="main">(</span><span class="var">?C</span> <span class="skolem">v</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?B</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_mset length_filter_conv_card<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> card_mono<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span> <span class="main">-</span> card <span class="var">?B</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="free">x</span><span class="main">)</span> <span class="main">-</span> card <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Suc_diff_le <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-round_count_inv"><span class="command">lemma</span></span> round_count_inv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span> <span class="main">⟶</span> bn_inv <span class="free">p</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟶</span> add_inv <span class="free">n</span> <span class="free">t</span> <span class="main">⟶</span> count_inv <span class="free">f</span> <span class="free">t</span> <span class="main">⟶</span>
    count_inv <span class="free">f</span> <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> simp_thms<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">n</span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">f</span><span class="main">.</span> bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
      count_inv <span class="bound">f</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> count_inv <span class="bound">f</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"count_inv <span class="skolem">f</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="skolem">f</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> disj_imp <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">x</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">f</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> length <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">f</span><span class="main">.</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">⟶</span> Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">y</span> <span class="main">≠</span> <span class="bound">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">f</span><span class="main">(</span><span class="skolem">y</span> <span class="main">:=</span> <span class="skolem">f</span> <span class="skolem">y</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="bound">x</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> <span class="main">_</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">x</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> spec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">⟶</span> Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">x</span> <span class="main">⟶</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> spec <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">y</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">m</span> <span class="skolem">ns</span> <span class="skolem">n</span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m'</span><span class="main">.</span> round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">m</span> <span class="bound">m'</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r'</span> <span class="bound">v</span><span class="main">.</span> round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="bound">r'</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="skolem">index</span> <span class="skolem">key</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">i</span> <span class="bound">n</span> <span class="bound">f</span><span class="main">.</span>
      <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">⟹</span>
        bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span>
          count_inv <span class="bound">f</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span> count_inv <span class="bound">f</span> <span class="main">(</span><span class="var">?t</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"count_inv <span class="skolem">f</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="skolem">f</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m'</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span> <span class="skolem">xs'</span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span>
      B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">m'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">i</span> <span class="bound">n'</span> <span class="bound">f</span><span class="main">.</span>
      <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">h</span> <span class="main">=</span> <span class="skolem">ms'</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">⟹</span>
        foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">⟶</span>
          <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">xs</span><span class="main">)</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">+</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> append_take_drop_id <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main"><span class="main">(</span></span></span>Suc <span class="skolem"><span class="skolem"><span class="skolem">m</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> mset_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> B <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="skolem">ws'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">+</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> count_add_mset mset_map
     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> add_mset_add_single<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span>
     <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> count_single count_union<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mini <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxi <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nmi</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nma</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xmi</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xma</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nths <span class="var">?ws</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="var">?zs</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?k</span> <span class="var">?mi</span> <span class="var">?ma</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="bound">i</span> <span class="main">=</span> <span class="var">?nmi</span> <span class="main">∨</span> <span class="bound">i</span> <span class="main">=</span> <span class="var">?nma</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?ws</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?ws</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">≤</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> count_mset length_filter_conv_card<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> card_mono<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>
        <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?xma</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">+</span> <span class="main">(</span><span class="keyword1">if</span> <span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">x</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span>
        count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?zs</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?zs</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> card <span class="var">?A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nths_count<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> card <span class="var">?A</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">from</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp_all</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">insert</span> mini_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> maxi_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> mini_maxi_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> maxi_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mini_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∉</span> set <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> bn_comp_fst_nonzero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> C<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span>
          <span class="main">(</span>length <span class="var">?zs</span><span class="main">)</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?zs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_count_item <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span>
           <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule_tac</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> G <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths nths_count<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span>
             <span class="operator">insert</span> mini_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> maxi_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?A</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> card_insert_disjoint<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">rule_tac</span> mini_maxi_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> card <span class="var">?A</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> maxi_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> card <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> mini_less <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws</span></span></span></span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> card <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">≠</span> <span class="skolem">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">-</span> card <span class="var">?A</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?ws</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_simp</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Conservation-gcsort_count_inv"><span class="command">lemma</span></span> gcsort_count_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"add_inv <span class="free">n</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t'</span> <span class="main">∈</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span><span class="main">;</span> count_inv <span class="free">f</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
    count_inv <span class="free">f</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gcsort_set.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> gcsort_add_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ B C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> round_count_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bn_inv.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bn_inv_intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The only remaining task is to address step 10 of the proof method, which is done by proving theorem
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_count</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It holds under the conditions that the objects' number is not larger than the
counters' upper bound and function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> satisfies predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> index_less<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and states
that for any object, function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort<span class="antiquote"><span class="antiquote">}</span></span></span></span> leaves unchanged the number of its occurrences within
the input objects' list.

\null
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gcsort_count<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>gcsort <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="main">(</span>count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_count_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_add_input<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule</span> gcsort_aux_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_count_input<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>gcsort_out <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span>
    <span class="main">(</span>count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span><span class="main">)</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_count_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> gcsort_in <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_in_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sorting">
<div class="head">
<h1>Theory Sorting</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Efficient Generalization of Counting Sort for Large, possibly Infinite Key Ranges
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Proof of objects' sorting"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sorting
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Conservation">Conservation</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In this section, it is formally proven that GCsort actually sorts objects.

Here below, steps 5, 6, and 7 of the proof method are accomplished. Predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">sort_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is
satisfied just in case, for any bucket delimited by the input counters' list $ns$, the keys of the
corresponding objects within the input objects' list $xs$ are not larger than those of the objects,
if any, to the right of that bucket. The underlying idea is that this predicate:

\begin{itemize}

\item
is trivially satisfied by the output of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_in<span class="antiquote"><span class="antiquote">}</span></span></span></span>, which places all objects into a
single bucket, and

\item
implies that $xs$ is sorted if every bucket delimited by $ns$ has size one, as happens when function
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_aux<span class="antiquote"><span class="antiquote">}</span></span></span></span> terminates.

\end{itemize}

\null
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sort_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">sort_inv</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="free"><span class="bound"><span class="entity">ns</span></span></span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span>length <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">}</span><span class="main">.</span>
    <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Sorting-gcsort_sort_input"><span class="command">lemma</span></span> gcsort_sort_input<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sort_inv <span class="free">key</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sorting-offs_nth"><span class="command">lemma</span></span> offs_nth<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span> <span class="free">ns</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">.</span> offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> B C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">no_asm_use</span><span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span> <span class="skolem">ms</span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">#</span> <span class="skolem">ms</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">.</span> offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">n</span> <span class="main">∈</span> set <span class="free">ns</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> find_None_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">∧</span> offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> exI <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_add<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">∨</span> Max <span class="var">?A</span> <span class="main">=</span> length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">∨</span> <span class="var">?Q</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_add<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span><span class="main">)</span> <span class="free">ns</span> <span class="main">=</span> take <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="free">ns</span> <span class="main">@</span> <span class="main">[</span><span class="free">ns</span> <span class="main">!</span> Max <span class="var">?A</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">=</span>
      offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">+</span> <span class="free">ns</span> <span class="main">!</span> Max <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">∈</span> set <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">≠</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> Max <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">ns</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span> <span class="main">&lt;</span> length <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="free">ns</span> <span class="main">=</span>
      take <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">ns</span> <span class="main">@</span> <span class="main">[</span><span class="free">ns</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="free">ns</span> <span class="main">=</span>
      foldl <span class="main">(+)</span> <span class="main">0</span> <span class="main">(</span>take <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="free">ns</span> <span class="main">@</span> <span class="main">[</span><span class="free">ns</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">+</span> <span class="free">ns</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">ns</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> G <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ns</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">ns</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">≤</span> Suc <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-gcsort_sort_intro"><span class="command">lemma</span></span> gcsort_sort_intro<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>sort_inv <span class="free">key</span> <span class="free">t</span><span class="main">;</span> add_inv <span class="free">n</span> <span class="free">t</span><span class="main">;</span> find <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="free">t</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None<span class="main">⟧</span> <span class="main">⟹</span>
    sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span>gcsort_out <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_iff_nth_mono_less gcsort_out_def<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">j</span> <span class="skolem">k</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span> <span class="skolem">ns</span> <span class="main">=</span> None"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ns</span><span class="main">.</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">∧</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ns</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span>
    <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">⟶</span> <span class="skolem">j</span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⟶</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">⟶</span>
    <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="skolem">k</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

As lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] gcsort_sort_intro<span class="antiquote"><span class="antiquote">}</span></span></span></span> comprises an additional assumption concerning the form of
the fixed points of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_aux<span class="antiquote"><span class="antiquote">}</span></span></span></span>, step 8 of the proof method is necessary this time
to prove that such assumption is satisfied.

\null
›</span></span>

<span class="keyword1" id="Sorting-gcsort_sort_form"><span class="command">lemma</span></span> gcsort_sort_form<span class="main">:</span>
 <span class="quoted"><span class="quoted">"find <span class="main">(</span><span class="main">λ</span><span class="bound">n</span><span class="main">.</span> Suc <span class="main">0</span> <span class="main">&lt;</span> <span class="bound">n</span><span class="main">)</span> <span class="main">(</span>fst <span class="main">(</span>snd <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> gcsort_aux.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

Here below, step 9 of the proof method is accomplished.

In the most significant case of the proof by recursion induction of lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">round_sort_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>,
namely that of a bucket $B$ with size larger than two and distinct minimum and maximum keys, the
following line of reasoning is adopted. Let $x$ be an object contained in a finer-grained bucket
$B'$ resulting from $B$'s partition, and $y$ an object to the right of $B'$. Then:

\begin{itemize}

\item
If $y$ is contained in some other finer-grained bucket resulting from $B$'s partition, inequality
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">key</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">key</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds because predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sort_inv<span class="antiquote"><span class="antiquote">}</span></span></span></span> is satisfied by a counters' list
generated by function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> enum<span class="antiquote"><span class="antiquote">}</span></span></span></span> and an objects' list generated by function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span> in case
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span>'s input offsets' list is computed via the composition of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs<span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> enum<span class="antiquote"><span class="antiquote">}</span></span></span></span>, as happens within function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> round<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
\\This is proven beforehand in lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">fill_sort_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\item
Otherwise, inequality <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">key</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">≤</span></span> <span class="free"><span class="free">key</span></span> <span class="free"><span class="free">y</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> holds as well because object $x$ was contained in $B$
by lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] fill_offs_enum_count_item<span class="antiquote"><span class="antiquote">}</span></span></span></span>, object $y$ occurred to the right of $B$ by lemma
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">thm</span></span> [source] round_count_inv<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and by hypothesis, the key of any object in $B$ was not larger than
that of any object to the right of $B$.

\end{itemize}

Using lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">round_sort_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, the invariance of predicate <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sort_inv<span class="antiquote"><span class="antiquote">}</span></span></span></span> over inductive set
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_set<span class="antiquote"><span class="antiquote">}</span></span></span></span> is then proven in lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_sort_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1" id="Sorting-mini_maxi_keys_le"><span class="command">lemma</span></span> mini_maxi_keys_le<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟹</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> mini <span class="free">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">≤</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">frule</span> mini_lb<span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> maxi_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> order_trans<span class="main">)</span>

<span class="keyword1" id="Sorting-mini_maxi_keys_eq"><span class="command">lemma</span></span> mini_maxi_keys_eq <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> mini <span class="free">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">=</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">xs</span> <span class="main">⟶</span>
    <span class="free">key</span> <span class="free">x</span> <span class="main">=</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main">-</span>4<span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">frule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>3<span class="main"><span class="improper">]</span></span> mini_maxi_keys_le <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> key <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Sorting-offs_suc"><span class="command">lemma</span></span> offs_suc<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span> offs <span class="free">ns</span> <span class="main">(</span>Suc <span class="free">k</span><span class="main">)</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> Suc <span class="main">(</span>offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_add add_suc<span class="main">)</span>

<span class="keyword1" id="Sorting-offs_base_zero"><span class="command">lemma</span></span> offs_base_zero<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟹</span> offs <span class="free">ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> offs <span class="free">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Sorting-offs_append"><span class="command">lemma</span></span> offs_append<span class="main">:</span>
 <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="free">ms</span> <span class="main">@</span> <span class="free">ns</span><span class="main">)</span> <span class="free">k</span> <span class="main">=</span> offs <span class="free">ms</span> <span class="free">k</span> <span class="main">@</span> offs <span class="free">ns</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="free">k</span> <span class="free">ms</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">ms</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>

<span class="keyword1" id="Sorting-offs_enum_next_le"><span class="command">lemma</span></span> offs_enum_next_le <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span>
    <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span> offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="main">_</span> <span class="main">!</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span> <span class="main">&lt;</span>
    offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span>
    offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">∧</span>
      <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">∈</span> offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
      offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span> <span class="main">&lt;</span>
    offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
      offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="free">k</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span>
    offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="free">k</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="free">k</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-offs_pred_ub_less"><span class="command">lemma</span></span> offs_pred_ub_less<span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">;</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span><span class="main">;</span>
   <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">⟧</span> <span class="main">⟹</span>
     <span class="free">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule</span> offs_pred_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Sorting-fill_count_none"><span class="command">lemma</span></span> fill_count_none <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
    offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    length <span class="free">xs</span> <span class="main">≤</span> <span class="free">ub</span> <span class="main">⟶</span>
      count <span class="main">(</span>mset <span class="main">(</span>fill <span class="free">xs</span> <span class="free">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span> None <span class="main">=</span> <span class="free">ub</span> <span class="main">-</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> A
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> replicate_count Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> mset_update<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule_tac</span> offs_pred_ub_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def offs_num_cons <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span>
 not_None_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> conj_commute<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rotate_tac</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> contrapos_np<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> fill_index_none<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ns</span><span class="main">.</span> <span class="bound">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> offs_pred <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    count <span class="main">(</span>mset <span class="main">(</span>fill <span class="skolem">xs</span> <span class="bound">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span> None <span class="main">=</span> <span class="free">ub</span> <span class="main">-</span> length <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"offs_pred <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_pred <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span> None <span class="main">-</span>
    Suc <span class="main">0</span> <span class="main">=</span> <span class="free">ub</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">xs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-fill_offs_enum_count_none"><span class="command">lemma</span></span> fill_offs_enum_count_none <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="main">⟦</span>index_less <span class="free">index</span> <span class="free">key</span><span class="main">;</span> <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">;</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span><span class="main">⟧</span> <span class="main">⟹</span>
    count <span class="main">(</span>mset <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
      <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span> None <span class="main">=</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> fill_count_none<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
 offs_length enum_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> offs_enum_pred <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">index</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Sorting-fill_index"><span class="command">lemma</span></span> fill_index <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ns</span> <span class="main">⟶</span>
    <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟶</span>
    <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span><span class="free">ns</span> <span class="main">!</span> <span class="free">i</span><span class="main">..&lt;</span>offs_next <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">}</span> <span class="main">⟶</span>
    fill <span class="free">xs</span> <span class="free">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟶</span>
      <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="free">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">[</span><span class="var">?i'</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">ns</span><span class="main">.</span>
    offs_pred <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    <span class="free">i</span> <span class="main">&lt;</span> length <span class="bound">ns</span> <span class="main">⟶</span>
    <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="bound">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟶</span>
    <span class="bound">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">∧</span> <span class="free">j</span> <span class="main">&lt;</span> offs_next <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟶</span>
    fill <span class="skolem">xs</span> <span class="bound">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟶</span>
      <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="main">(</span>length <span class="bound">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ns</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">ns</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">:=</span> Some <span class="skolem">y</span><span class="main">]</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
  <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i'</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_ub <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> nth_list_update_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span>
   <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span>
      M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> neqE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span>
         <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M <span class="keyword2"><span class="keyword">and</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="skolem">ns</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="var">?i</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> le_less<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="var">?i</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>
          <span class="main">(</span>Min <span class="var">?A</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> O <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_asc <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≠</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?ns'</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> D <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_pred <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="var">?ns'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="var">?ns'</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">=</span> Suc <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="var">?i'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="free">i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> disjI1<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> exI
         <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">have</span></span>
       <span class="quoted"><span class="quoted">"fill <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="skolem">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> disjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">≤</span>
      offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_next_cons <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-fill_offs_enum_index"><span class="command">lemma</span></span> fill_offs_enum_index <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span> <span class="main">⟹</span>
  <span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
  <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span> <span class="main">⟹</span>
  <span class="free">j</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="free">i</span><span class="main">..&lt;</span>
    offs_next <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>
      <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="free">i</span><span class="main">}</span> <span class="main">⟹</span>
  fill <span class="free">xs</span> <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>
    <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="free">j</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span>
    <span class="free">index</span> <span class="free">key</span> <span class="free">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">insert</span> fill_index <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">index</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"offs <span class="main"><span class="main"><span class="main">(</span></span></span>enum <span class="free"><span class="free"><span class="free">xs</span></span></span> <span class="free"><span class="free"><span class="free">index</span></span></span> <span class="free"><span class="free"><span class="free">key</span></span></span> <span class="free"><span class="free"><span class="free">n</span></span></span> <span class="free"><span class="free"><span class="free">mi</span></span></span> <span class="free"><span class="free"><span class="free">ma</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span> <span class="main"><span class="main"><span class="main">0</span></span></span>"</span></span></span></span>
 <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">xs</span></span></span>"</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">j</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> offs_enum_pred <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">index</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">key</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">n</span></span></span></span></span></span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>

<span class="keyword1" id="Sorting-fill_sort_inv"><span class="command">lemma</span></span> fill_sort_inv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_mono <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="free">key</span> <span class="main">(</span><span class="free">u</span><span class="main">,</span> enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">,</span>
    map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
      <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="main">_</span> <span class="main">(</span><span class="main">_</span><span class="main">,</span> <span class="var">?ns</span><span class="main">,</span> <span class="main">_</span><span class="main">)</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length fill_length<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> conjE<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> <span class="var">?ns</span> <span class="main">!</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">j</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?C</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">∧</span> offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="free">n</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">i</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="free">xs</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">m</span>
      <span class="main">∈</span> set <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nth_mem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"None <span class="main">∈</span> set <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
     <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span> None <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_count_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">zs</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">#</span> <span class="skolem">zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">z</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?ns</span> <span class="main">!</span> <span class="free">index</span> <span class="free">key</span> <span class="skolem">z</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nth_list_update_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
     enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">z</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> Min <span class="var">?A</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> offs_equal<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
   enum_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> Min <span class="var">?A</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?ns</span> <span class="main">!</span> <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">≤</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">m</span> <span class="bound">ms</span><span class="main">.</span> <span class="var">?ns</span> <span class="main">=</span> <span class="bound">m</span> <span class="main">#</span> <span class="bound">ms</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ns</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> enum_length<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ms</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns</span> <span class="main">=</span> <span class="skolem">m</span> <span class="main">#</span> <span class="skolem">ms</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> Min <span class="var">?A</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?A</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> enum_offs_num <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>
    <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?B</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?B</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?Z</span> <span class="main">∈</span> <span class="var">?Z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> Min <span class="var">?Z</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?Z</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?Z</span> <span class="main">≤</span> Max <span class="var">?B</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    L<span class="main">:</span> <span class="quoted"><span class="quoted">"fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> Max <span class="var">?B</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_index <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?C</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>
    <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?C</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?C</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Z</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?Z</span> <span class="main">∈</span> <span class="var">?Z</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> Min <span class="var">?Z</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?Z</span> <span class="main">∈</span> <span class="var">?C</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_length enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?Z</span> <span class="main">≤</span> Max <span class="var">?C</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    P<span class="main">:</span> <span class="quoted"><span class="quoted">"fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> Max <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_index <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">≤</span> Max <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">&lt;</span> Max <span class="var">?C</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">=</span> Max <span class="var">?C</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">&lt;</span> offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span>
      <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?B</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> Max <span class="var">?B</span> <span class="main">&lt;</span> offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> K <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?B</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule_tac</span> contrapos_pp<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> not_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> not_less<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">erule_tac</span> offs_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_next <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">+</span> <span class="main">0</span><span class="main">)</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?B</span><span class="main">)</span> <span class="main">≤</span>
      offs <span class="var">?ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_enum_next_le <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">&lt;</span> <span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M <span class="keyword2"><span class="keyword">and</span></span> Q <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span>
    <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_count_item <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span>
    <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span>
    <span class="main">∈</span> set <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span>
    <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span>
    <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="free">xs</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_count_item <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span>
    <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span>
    <span class="main">∈</span> set <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span>
    <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> P <span class="keyword2"><span class="keyword">and</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="free">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">⟶</span> <span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">≤</span> <span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> C <span class="keyword2"><span class="keyword">and</span></span> T <span class="keyword2"><span class="keyword">and</span></span> V <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_mono_def<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> contrapos_pp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> R<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
    <span class="free">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="var">?ns</span> <span class="main">0</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-round_sort_inv"><span class="command">lemma</span></span> round_sort_inv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span> <span class="main">⟶</span> index_mono <span class="free">index</span> <span class="free">key</span> <span class="main">⟶</span> bn_inv <span class="free">p</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟶</span>
    add_inv <span class="free">n</span> <span class="free">t</span> <span class="main">⟶</span> sort_inv <span class="free">key</span> <span class="free">t</span> <span class="main">⟶</span> sort_inv <span class="free">key</span> <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> simp_thms<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">n</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
    sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> sort_inv <span class="skolem">key</span> <span class="var">?t</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
    sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> sort_inv <span class="skolem">key</span> <span class="var">?t</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">n</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="skolem">index</span> <span class="skolem">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
      sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> sort_inv <span class="skolem">key</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_suc<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">u'</span> <span class="skolem">ns'</span> <span class="skolem">xs'</span>
    <span class="keyword3"><span class="command">assume</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> A'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns'</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="bound">i'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nat.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> B'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">ns'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> A' <span class="keyword2"><span class="keyword">and</span></span> B' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_suc<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns'</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B' <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_suc<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k'</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">=</span> Suc <span class="bound">k'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nat.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">xs'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n</span> <span class="main">∧</span> length <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">n</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ns</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span><span class="bound">n</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ns'</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="bound">n</span> <span class="main">⟶</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?R</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">from</span></span> I <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_inv <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span>
        <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">ys</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> round_count_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="skolem">ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span> <span class="main">∈</span> set <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">m</span></span> <span class="main">&lt;</span> length <span class="skolem">ys</span><span class="main">.</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="bound">m</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> length <span class="skolem">ys</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">!</span> <span class="skolem">m</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="main">0</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> D <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="main">0</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_suc<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="skolem">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span><span class="bound">k</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword2"><span class="keyword">and</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ys</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="skolem">m</span> <span class="main">-</span> Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">j'</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> length <span class="skolem">ns'</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">m</span> <span class="skolem">ns</span> <span class="skolem">n</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m'</span><span class="main">.</span> round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">m</span> <span class="bound">m'</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r'</span> <span class="bound">v</span><span class="main">.</span> round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="bound">r'</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="skolem">index</span> <span class="skolem">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_mono <span class="skolem">index</span> <span class="skolem">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">n</span><span class="main">.</span>
      <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">f</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">g</span><span class="main">,</span> <span class="bound">h</span><span class="main">)</span> <span class="main">=</span> <span class="bound">f</span> <span class="main">⟹</span>
        bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span>
          sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span> sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="var">?t</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">with</span></span> C <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m'</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span> <span class="skolem">u'</span> <span class="skolem">ns'</span> <span class="skolem">xs'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mini <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxi <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nmi</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xmi</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">m'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nths <span class="var">?ws</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="var">?zs</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?k</span> <span class="var">?mi</span> <span class="var">?ma</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n'</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">n'</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ns</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span><span class="bound">n'</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> length <span class="skolem">ns'</span><span class="main">.</span>
      <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">m'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">u'</span><span class="main">,</span> <span class="skolem">ns'</span><span class="main">,</span> <span class="skolem">xs'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      H<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      I<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ms'</span> <span class="main">+</span> length <span class="skolem">ns'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> offs <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      M<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="skolem">ws'</span> <span class="main">+</span> length <span class="skolem">xs'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?ws</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> D <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">ws'</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def fill_length <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> Q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="main">⟹</span>
      the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> bn_comp_fst_nonzero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span>
        <span class="skolem">index</span> <span class="skolem">key</span> <span class="main">(</span>length <span class="var">?zs</span><span class="main">)</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?zs</span><span class="main">)</span> <span class="var">?x</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_count_item <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span>
         <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule_tac</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span>
        <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?x</span> <span class="main">=</span> count <span class="main">(</span>mset <span class="var">?zs</span><span class="main">)</span> <span class="var">?x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="main">(</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span>
        <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="var">?x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> R <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> set <span class="var">?zs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> in_set_nthsD<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> R<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">⟹</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">⟹</span>
      <span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_inv <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count_inv <span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> <span class="bound">x</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="skolem">r'</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> round_count_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> S<span class="main">:</span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
        count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">m</span> <span class="main">+</span> length <span class="skolem">xs'</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> count <span class="main">(</span>mset <span class="skolem">xs'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">p</span></span> <span class="main">&lt;</span> length <span class="var">?ys</span><span class="main">.</span> <span class="var">?ys</span> <span class="main">!</span> <span class="bound">p</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span>
        T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> length <span class="var">?ys</span> <span class="main">∧</span> <span class="var">?ys</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span> <span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">0</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="main">0</span><span class="main">.</span>
         <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
           <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword2"><span class="keyword">and</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">0</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> offs_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span> <span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> I <span class="keyword2"><span class="keyword">and</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword2"><span class="keyword">and</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">f</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">n'</span><span class="main">.</span>
      <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">f</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">g</span> <span class="main">=</span> <span class="skolem">ms'</span> <span class="main">∧</span> <span class="bound">h</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">⟹</span>
        <span class="var">?P</span> <span class="bound">n'</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="bound">n'</span> <span class="main">⟶</span> <span class="var">?R</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?R</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?Q</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">subst</span> <span class="main"><span class="main">(</span></span>1 2<span class="main"><span class="main">)</span></span> append_take_drop_id <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"Suc <span class="main"><span class="main">(</span></span>Suc <span class="skolem"><span class="skolem">m</span></span><span class="main"><span class="main">)</span></span>"</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> nth_append O<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">k</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">.</span>
         <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span><span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="skolem">ns</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> Suc <span class="skolem">i</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
           <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">xs</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">⟶</span>
        <span class="main">(</span><span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> offs_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
         <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> offs_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">+</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">..&lt;</span><span class="skolem">n</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs</span> <span class="main">!</span> <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">k</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="var"><span class="quoted"><span class="var">?R</span></span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="skolem">ws'</span> <span class="main">@</span> <span class="skolem">xs'</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append not_less P<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>3<span class="main"><span class="improper">]</span></span> FalseE<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span>
        S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        T<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> D <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="skolem">ws'</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">ws'</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span>
       <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?mi</span> <span class="main">=</span> <span class="var">?ma</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> S <span class="keyword2"><span class="keyword">and</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="skolem">j</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> U <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ma</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mini_maxi_keys_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> length <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> T <span class="keyword2"><span class="keyword">and</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="skolem">k</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> nth_mem<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> U <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">=</span> <span class="var">?ma</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mini_maxi_keys_eq<span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ms'</span> <span class="main">=</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="var">?ms</span> <span class="main">@</span> <span class="main">[</span>Suc <span class="main">0</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="main">(</span><span class="var">?ms</span> <span class="main">@</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i'</span><span class="main">.</span> <span class="skolem">i</span> <span class="main">=</span> Suc <span class="bound">i'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nat.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> Suc <span class="skolem">i'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">(</span><span class="var">?k</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> K <span class="keyword2"><span class="keyword">and</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> Suc <span class="main">(</span><span class="var">?k</span> <span class="main">+</span> length <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>offs <span class="main">(</span><span class="var">?ms</span> <span class="main">@</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> V <span class="keyword2"><span class="keyword">and</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length offs_suc<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span> <span class="main">#</span> offs <span class="main">(</span><span class="var">?ms</span> <span class="main">@</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> M <span class="keyword2"><span class="keyword">and</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>offs <span class="main">(</span><span class="var">?ms</span> <span class="main">@</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> W <span class="keyword2"><span class="keyword">and</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length offs_suc<span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">k'</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">=</span> Suc <span class="bound">k'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nat.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k'</span></span> <span class="keyword2"><span class="keyword">where</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">=</span> Suc <span class="skolem">k'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> AA<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="var">?ms</span> <span class="main">@</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> AB<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Y <span class="keyword2"><span class="keyword">and</span></span> AA <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> Z <span class="keyword3"><span class="command">show</span></span>
         <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="var">?xmi</span> <span class="main">#</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span> <span class="main">@</span>
            <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="main">(</span><span class="var">?xmi</span> <span class="main">#</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span> <span class="main">@</span>
            <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">m</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append
         not_less fill_length<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>2<span class="main"><span class="improper">]</span></span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>1<span class="main">-</span>4<span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>5<span class="main"><span class="improper">]</span></span> FalseE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Q<span class="main">)</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mi</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mini_lb<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> T <span class="keyword2"><span class="keyword">and</span></span> Z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mi</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="main">[</span><span class="var">?xma</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> mini_maxi_keys_le<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> nth_mem <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="main"><span class="quoted"><span class="main"><span class="quoted"><span class="main">0</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
             <span class="operator">subst</span> O<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="var">?ms</span><span class="main">,</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span>
            <span class="main">(</span>length <span class="var">?zs</span><span class="main">)</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> fill_sort_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>
             <span class="main">(</span><span class="main">(</span><span class="operator">rule</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="skolem">key</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="var">?ms</span><span class="main">,</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span>
            <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">i</span></span> <span class="main">&lt;</span> <span class="var">?k</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="bound">i</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length fill_length<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> AC<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> AD<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="var">?ms</span> <span class="main">@</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> AA <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> AE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> contrapos_pp <span class="main"><span class="main">[</span></span><span class="operator">OF</span> AD<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less offs_append
           nth_append offs_length enum_length<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> AC <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> bn_comp_fst_nonzero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F<span class="main"><span class="keyword3">,</span></span>
               <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">=</span> length <span class="var">?zs</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enum_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span>
               <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule_tac</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
            <span class="keyword1"><span class="command">with</span></span> X <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">#</span>
              offs <span class="skolem">ns'</span> <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i'</span> <span class="main">-</span> <span class="var">?k</span><span class="main">)</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">-</span> <span class="var">?k</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> offs_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">with</span></span> Y <span class="keyword2"><span class="keyword">and</span></span> AE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_append nth_append offs_length enum_length<span class="main">)</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span><span class="main">.</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> AA <span class="keyword2"><span class="keyword">and</span></span> AE <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_append nth_append offs_length enum_length<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="var">?ms</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">m</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> AC <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
           <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
            <span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">k'</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
            <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Q<span class="main">)</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">k'</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> T <span class="keyword2"><span class="keyword">and</span></span> Z <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?x</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="main">[</span><span class="var">?xma</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k'</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> maxi_ub<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> Z <span class="keyword2"><span class="keyword">and</span></span> AB <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span>
        S<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        T<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">from</span></span> D <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="skolem">ws'</span> <span class="main">!</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span>
       <span class="operator">rule_tac</span> R <span class="main"><span class="main">[</span></span><span class="operator">OF</span> S T<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">case_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="skolem">m</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
       <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append not_less fill_length<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">&lt;</span> length <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> mini_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?mi</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> <span class="skolem">m</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span> <span class="main">∈</span> set <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> Q<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">p</span></span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">.</span> <span class="var">?ws</span> <span class="main">!</span> <span class="bound">p</span> <span class="main">=</span>
          the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> O <span class="keyword2"><span class="keyword">and</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> in_set_conv_nth<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">p</span></span> <span class="keyword2"><span class="keyword">where</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∧</span> <span class="var">?ws</span> <span class="main">!</span> <span class="skolem">p</span> <span class="main">=</span>
          the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="var">?ws</span> <span class="main">!</span> <span class="skolem">p</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> R<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span>the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span> <span class="main">!</span> <span class="skolem">j'</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> V <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j'</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">j'</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="main">[</span><span class="var">?xma</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j'</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">&lt;</span> length <span class="var">?ws</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> maxi_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ma</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> R<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> <span class="skolem">j</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span>
        S<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
        T<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> U<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">ns'</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_inv <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_inv <span class="main">(</span><span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="var">?t</span> <span class="skolem">r'</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> round_add_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs'</span> <span class="main">=</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs'</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">xs'</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> T <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> V<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span> <span class="main">&lt;</span> length <span class="skolem">ns'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">hence</span></span> W<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span><span class="main">.</span>
        <span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="var">?R</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> D <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> X<span class="main">:</span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ms'</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def add_replicate add_suc
       <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?k</span> <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="var">?ms</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_length<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> bn_comp_fst_nonzero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> G<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> F<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
        <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">=</span> length <span class="var">?zs</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> enum_add<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span>
           <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule_tac</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(+)</span> <span class="main">0</span> <span class="var">?ms</span> <span class="main">=</span> <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ms'</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> length <span class="skolem">ms'</span>"</span></span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">ms'</span> <span class="main">&lt;</span> length <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span>
          offs <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">ms'</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_mono<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> U <span class="keyword2"><span class="keyword">and</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_append nth_append offs_length<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">cases</span> <span class="quoted"><span class="skolem">ns'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">≤</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
          <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">hence</span></span> Y<span class="main">:</span> <span class="quoted"><span class="quoted">"offs <span class="main">(</span><span class="skolem">ms'</span> <span class="main">@</span> <span class="skolem">ns'</span><span class="main">)</span> <span class="main">0</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span>
        Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> X <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_append nth_append offs_length<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">subst</span> offs_base_zero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> V<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> S <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">&lt;</span> offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span> <span class="main">∈</span> <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span><span class="main">.</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> W <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M <span class="keyword2"><span class="keyword">and</span></span> Y <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="skolem">xs'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword2"><span class="keyword">and</span></span> U <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">∈</span>
        <span class="main">{</span>offs <span class="skolem">ns'</span> <span class="main">0</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">-</span> length <span class="skolem">ms'</span><span class="main">)</span><span class="main">..&lt;</span>length <span class="skolem">xs'</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> Z <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span>
        <span class="skolem">key</span> <span class="main">(</span><span class="skolem">xs'</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">k</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sorting-gcsort_sort_inv"><span class="command">lemma</span></span> gcsort_sort_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_mono <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"add_inv <span class="free">n</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t'</span> <span class="main">∈</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span><span class="main">;</span> sort_inv <span class="free">key</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
    sort_inv <span class="free">key</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gcsort_set.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> gcsort_add_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> round_sort_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bn_inv.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bn_inv_intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> D<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The only remaining task is to address step 10 of the proof method, which is done by proving theorem
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_sorted</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It holds under the conditions that the objects' number is not larger than the
counters' upper bound and function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> satisfies both predicates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> index_less<span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> index_mono<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and states that function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort<span class="antiquote"><span class="antiquote">}</span></span></span></span> is successful in sorting the input
objects' list.

\null
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gcsort_sorted<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_mono <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span>gcsort <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sort_inv <span class="free">key</span> <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_sort_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B _ C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_add_input<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule</span> gcsort_aux_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_sort_input<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"add_inv <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_add_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ _ C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule</span> gcsort_aux_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_add_input<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sorted <span class="main">(</span>map <span class="free">key</span> <span class="main">(</span>gcsort_out <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_sort_intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_sort_form<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> gcsort_in <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_in_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Stability">
<div class="head">
<h1>Theory Stability</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       An Efficient Generalization of Counting Sort for Large, possibly Infinite Key Ranges
    Author:      Pasquale Noce
                 Software Engineer at HID Global, Italy
                 pasquale dot noce dot lavoro at gmail dot com
                 pasquale dot noce at hidglobal dot com
*)</span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">"Proof of algorithm's stability"</span></span>

<span class="keyword1"><span class="command">theory</span></span> Stability
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="#Sorting">Sorting</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In this section, it is formally proven that GCsort is \emph{stable}, viz. that the sublist of the
output of function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort<span class="antiquote"><span class="antiquote">}</span></span></span></span> built by picking out the objects having a given key matches the
sublist of the input objects' list built in the same way.

Here below, steps 5, 6, and 7 of the proof method are accomplished. Particularly, <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">stab_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>
is the predicate that will be shown to be invariant over inductive set <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort_set<span class="antiquote"><span class="antiquote">}</span></span></span></span>.

\null
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">stab_inv</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'a</span> list<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">×</span> nat list <span class="main">×</span> <span class="tfree">'a</span> list <span class="main">⇒</span>
  bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">stab_inv</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ns</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">key</span></span></span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="Stability-gcsort_stab_input"><span class="command">lemma</span></span> gcsort_stab_input<span class="main">:</span>
 <span class="quoted"><span class="quoted">"stab_inv <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span><span class="main">)</span> <span class="free">key</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Stability-gcsort_stab_intro"><span class="command">lemma</span></span> gcsort_stab_intro<span class="main">:</span>
 <span class="quoted"><span class="quoted">"stab_inv <span class="free">f</span> <span class="free">key</span> <span class="free">t</span> <span class="main">⟹</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>gcsort_out <span class="free">t</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="free">f</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_out_def<span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

In what follows, step 9 of the proof method is accomplished.

First, lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">fill_offs_enum_stable</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> proves that function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fill<span class="antiquote"><span class="antiquote">}</span></span></span></span>, if its input offsets'
list is computed via the composition of functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> offs<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> enum<span class="antiquote"><span class="antiquote">}</span></span></span></span>, does not modify
the sublist of its input objects' list formed by the objects having a given key. Moreover, lemmas
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">mini_stable</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">maxi_stable</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> prove that the extraction of the leftmost minimum and
the rightmost maximum from an objects' list through functions <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mini<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> maxi<span class="antiquote"><span class="antiquote">}</span></span></span></span> is
endowed with the same property.

These lemmas are then used to prove lemma <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_stab_inv</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, which states that the sublist of
the objects having a given key within the objects' list is still the same after any recursive round.

\null
›</span></span>

<span class="keyword1" id="Stability-fill_stable"><span class="command">lemma</span></span> fill_stable <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_same <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span><span class="main">)</span> <span class="main">⟶</span>
    <span class="free">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span>
    offs_pred <span class="free">ns</span> <span class="free">ub</span> <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
      map the <span class="main">[</span><span class="bound">w</span><span class="main">←</span>fill <span class="free">xs</span> <span class="free">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">.</span> <span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
        <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ns</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">w</span><span class="main">←</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">key</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">w</span><span class="main">←</span><span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">key</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ns</span><span class="main">.</span> <span class="bound">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> offs_pred <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    map the <span class="main">[</span><span class="bound">w</span><span class="main">←</span>fill <span class="skolem">xs</span> <span class="bound">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">.</span>
      <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">key</span> <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"map the <span class="var">?ws</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_pred_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span>
    L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> nth_list_update_eq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="var">?ws'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_filter_conv_card card_gt_0_iff<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">ns</span></span></span> <span class="main"><span class="main"><span class="main">!</span></span></span> <span class="var"><span class="var"><span class="var">?i</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w</span> <span class="bound">ws</span><span class="main">.</span> <span class="var">?ws'</span> <span class="main">=</span> <span class="bound">w</span> <span class="main">#</span> <span class="bound">ws</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ws'</span></span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">w</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ws</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws'</span> <span class="main">=</span> <span class="skolem">w</span> <span class="main">#</span> <span class="skolem">ws</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span> <span class="bound">y</span><span class="main">.</span>
    <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="skolem">w</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="bound">us</span><span class="main">.</span> <span class="main">∀</span><span class="bound">y</span><span class="main">.</span> <span class="bound">u</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">⟶</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">≠</span> <span class="free">key</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">∧</span>
    <span class="skolem">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">∧</span>
    <span class="skolem">ws</span> <span class="main">=</span> <span class="main">[</span><span class="bound">w</span><span class="main">←</span><span class="bound">vs</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">key</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span> <span class="bound">y</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">us</span> <span class="bound">vs</span> <span class="bound">y</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq_Cons_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">us</span> <span class="skolem">vs</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?A</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span> <span class="main">∧</span> <span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="bound">i</span> <span class="main">∧</span>
    <span class="skolem">ns</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">≤</span> length <span class="skolem">us</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> neqE<span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_gr0<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      P<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_less<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="main">0</span> <span class="main">≤</span> length <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> F <span class="keyword2"><span class="keyword">and</span></span> P <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> <span class="var">?ns'</span> <span class="main">!</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      N<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      O<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      P<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> K <span class="keyword2"><span class="keyword">and</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> offs_next <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_less offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"offs_set_next <span class="var">?ns'</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">0</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">_</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> Min <span class="var">?B</span> <span class="main">≤</span> length <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?B</span> <span class="main">≤</span> length <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">=</span> <span class="var">?i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> O <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"offs_none <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_none_def<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="var">?A</span> <span class="main">≠</span> <span class="var">?i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> notI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="main">(</span>length <span class="var">?ns'</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> Max <span class="var">?A</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_index <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ I<span class="main"><span class="main">,</span></span> <span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> j <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"length <span class="skolem"><span class="skolem">us</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> not_less not_le offs_next_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">ub</span> <span class="main">≤</span> length <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> N <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">ub</span> <span class="main">&lt;</span> <span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">with</span></span> K <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?B</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"offs_set_next <span class="var">?ns'</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">(</span>Max <span class="var">?A</span><span class="main">)</span>"</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ns'</span> <span class="main">!</span> Min <span class="var">?B</span> <span class="main">≤</span> length <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> Min <span class="var">?B</span> <span class="main">≤</span> length <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">=</span> <span class="var">?i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?B</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> P<span class="main">:</span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?B</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Min_in<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">∈</span> <span class="var">?A</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"Min <span class="var">?B</span> <span class="main">≤</span> Max <span class="var">?A</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> Max_ge<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
        <span class="keyword1"><span class="command">using</span></span> P <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> length <span class="skolem">us</span> <span class="main">=</span>
        <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> length <span class="skolem">us</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> length <span class="skolem">us</span> <span class="main">=</span> Some <span class="skolem">y</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">y</span> <span class="main">(</span>length <span class="var">?ns'</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="var">?i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>
       index_same_def<span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> O <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">=</span>
      <span class="skolem">us</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> L <span class="keyword2"><span class="keyword">and</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> N<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">us</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span>
    take <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">@</span>
    fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">#</span>
    drop <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?ds</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> id_take_nth_drop<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_index_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> O<span class="main">:</span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">@</span> None <span class="main">#</span> <span class="var">?ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
    <span class="var">?ts</span> <span class="main">@</span> Some <span class="skolem">x</span> <span class="main">#</span> <span class="var">?ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> upd_conv_take_nth_drop<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
    <span class="skolem">us</span> <span class="main">@</span> Some <span class="skolem">x</span> <span class="main">#</span> <span class="var">?ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> N <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws'</span> <span class="main">=</span> Some <span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span><span class="bound">w</span><span class="main">←</span><span class="var">?ds</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">key</span> <span class="skolem">x</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> Some <span class="skolem">x</span> <span class="main">#</span> <span class="var">?ws</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> M <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> O<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"map the <span class="var">?ws'</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">#</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">xs</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">ns</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?i</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="free">index</span> <span class="free">key</span> <span class="skolem">x</span> <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ns'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span><span class="main">[</span><span class="var">?i</span> <span class="main">:=</span> Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">w</span><span class="main">←</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">w</span><span class="main">←</span><span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span><span class="main">.</span>
    <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="skolem">xs</span><span class="main">.</span> <span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    G<span class="main">:</span> <span class="quoted"><span class="quoted">"offs_pred <span class="skolem">ns</span> <span class="free">ub</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">k</span> <span class="main">≠</span> <span class="free">key</span> <span class="skolem">x</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?i</span> <span class="main">&lt;</span> length <span class="skolem">ns</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> index_less_def<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ns</span><span class="main">.</span> <span class="bound">ns</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> offs_pred <span class="bound">ns</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">⟶</span>
    map the <span class="main">[</span><span class="bound">w</span><span class="main">←</span>fill <span class="skolem">xs</span> <span class="bound">ns</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">.</span>
      <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"offs_pred <span class="var">?ns'</span> <span class="free">ub</span> <span class="skolem">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> offs_pred_cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"map the <span class="var">?ws</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">+</span> offs_num <span class="main">(</span>length <span class="skolem">ns</span><span class="main">)</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">#</span> <span class="skolem">xs</span><span class="main">)</span> <span class="free">index</span> <span class="free">key</span> <span class="free">mi</span> <span class="free">ma</span> <span class="var">?i</span> <span class="main">≤</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> G <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> offs_pred_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">&lt;</span> <span class="free">ub</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> offs_num_cons<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span>
    take <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">@</span>
    fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">#</span>
    drop <span class="main">(</span>Suc <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?ds</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> id_take_nth_drop<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">!</span> <span class="main">(</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span><span class="main">)</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword2"><span class="keyword">and</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_index_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
     <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">@</span> None <span class="main">#</span> <span class="var">?ds</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>fill <span class="skolem">xs</span> <span class="var">?ns'</span> <span class="free">index</span> <span class="free">key</span> <span class="free">ub</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">[</span><span class="skolem">ns</span> <span class="main">!</span> <span class="var">?i</span> <span class="main">:=</span> Some <span class="skolem">x</span><span class="main">]</span> <span class="main">=</span>
    <span class="var">?ts</span> <span class="main">@</span> Some <span class="skolem">x</span> <span class="main">#</span> <span class="var">?ds</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> upd_conv_take_nth_drop<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">=</span> <span class="main">[</span><span class="bound">w</span><span class="main">←</span><span class="var">?ts</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">@</span>
    <span class="main">[</span><span class="bound">w</span><span class="main">←</span><span class="var">?ds</span><span class="main">.</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> <span class="bound">w</span> <span class="main">=</span> Some <span class="bound">y</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> L<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ws'</span> <span class="main">=</span> <span class="var">?ws</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map the <span class="var">?ws'</span> <span class="main">=</span> <span class="main">[</span><span class="bound">y</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> J <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-fill_offs_enum_stable"><span class="command">lemma</span></span> fill_offs_enum_stable <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_same <span class="free">index</span> <span class="free">key</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∈</span> <span class="main">{</span><span class="free">mi</span><span class="main">..</span><span class="free">ma</span><span class="main">}</span> <span class="main">⟹</span>
    <span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span> <span class="main">⟹</span>
      <span class="main">[</span><span class="bound">x</span><span class="main">←</span>map the <span class="main">(</span>fill <span class="free">xs</span> <span class="main">(</span>offs <span class="main">(</span>enum <span class="free">xs</span> <span class="free">index</span> <span class="free">key</span> <span class="free">n</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span> <span class="main">0</span><span class="main">)</span>
        <span class="free">index</span> <span class="free">key</span> <span class="main">(</span>length <span class="free">xs</span><span class="main">)</span> <span class="free">mi</span> <span class="free">ma</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">k</span> <span class="main">=</span> <span class="free">key</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
  <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">[</span><span class="main"><span class="bound">_</span></span><span class="main">←</span>map the <span class="var">?ys</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">=</span> <span class="main">_</span>"</span></span>
   <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">⟹</span> <span class="main">_</span> <span class="main">⟹</span> <span class="main">[</span><span class="main"><span class="bound">_</span></span><span class="main">←</span>map the <span class="main">(</span>fill <span class="main">_</span> <span class="var">?ns</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span><span class="main">)</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> fill_stable <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">,</span></span> <span class="operator">OF</span> A B<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">xs</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">mi</span></span></span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">ma</span></span></span></span> <span class="var"><span class="quoted"><span class="var"><span class="quoted"><span class="var">?ns</span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> offs_length enum_length<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> offs_enum_pred <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_map<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq_nths fill_length<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">mi</span> <span class="main">≤</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">≤</span> <span class="free">ma</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">key</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?ys</span> <span class="main">!</span> <span class="bound">i</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?A</span> <span class="main">=</span> <span class="var">?B</span>"</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> exE<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">erule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span>
    <span class="keyword3"><span class="command">assume</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span>the <span class="main">(</span><span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="bound">x</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">∈</span> set <span class="var">?ys</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> nth_mem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"None <span class="main">∈</span> set <span class="var">?ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"count <span class="main">(</span>mset <span class="var">?ys</span><span class="main">)</span> None <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_count_none <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">from</span></span> this <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="var">?ys</span> <span class="main">!</span> <span class="skolem">i</span> <span class="main">=</span> Some <span class="bound">x</span> <span class="main">∧</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"map the <span class="main">(</span>nths <span class="var">?ys</span> <span class="var">?A</span><span class="main">)</span> <span class="main">=</span> map the <span class="main">(</span>nths <span class="var">?ys</span> <span class="var">?B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-mini_first"><span class="command">lemma</span></span> mini_first <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">&lt;</span> mini <span class="free">xs</span> <span class="free">key</span> <span class="main">⟶</span>
    <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> mini <span class="free">xs</span> <span class="free">key</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> not_le nth_Cons <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>

<span class="keyword1" id="Stability-maxi_last"><span class="command">lemma</span></span> maxi_last <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span> <span class="main">⟶</span> maxi <span class="free">xs</span> <span class="free">key</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟶</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟶</span>
    <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> maxi <span class="free">xs</span> <span class="free">key</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="operator">rule</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> le_less_trans<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> maxi_ub<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> nth_mem<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1" id="Stability-nths_range"><span class="command">lemma</span></span> nths_range<span class="main">:</span>
 <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">A</span> <span class="main">=</span> nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span>length <span class="free">xs</span><span class="main">}</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">A</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">A</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">A</span><span class="main">.</span> nths <span class="skolem">xs</span> <span class="bound">A</span> <span class="main">=</span> nths <span class="skolem">xs</span> <span class="main">(</span><span class="bound">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nths <span class="skolem">xs</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> nths <span class="skolem">xs</span> <span class="main">(</span><span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{..&lt;</span>length <span class="skolem">xs</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span>
   <span class="quoted"><span class="quoted">"nths <span class="skolem">xs</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">A</span><span class="main">}</span> <span class="main">=</span> nths <span class="skolem">xs</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">A</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">&lt;</span> length <span class="skolem">xs</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-filter_nths_diff"><span class="command">lemma</span></span> filter_nths_diff<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">P</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">∈</span> <span class="free">A</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> take <span class="free">i</span> <span class="free">xs</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?ts</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?ds</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> id_take_nth_drop<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">A</span> <span class="main">=</span> nths <span class="var">?ts</span> <span class="free">A</span> <span class="main">@</span> nths <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?ds</span><span class="main">)</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> length <span class="var">?ts</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?ts</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">A</span> <span class="main">=</span> nths <span class="var">?ts</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span>
    nths <span class="var">?ds</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> Suc <span class="bound">j</span> <span class="main">+</span> <span class="free">i</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?vs</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?ws</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nths_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> nths <span class="var">?ts</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span>
    nths <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">#</span> <span class="var">?ds</span><span class="main">)</span> <span class="main">{</span><span class="bound">j</span><span class="main">.</span> <span class="bound">j</span> <span class="main">+</span> length <span class="var">?ts</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> C<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_append<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="free">i</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="free">i</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="var">?vs</span> <span class="main">@</span> <span class="var">?ws</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nths_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-mini_stable"><span class="command">lemma</span></span> mini_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"mini <span class="free">xs</span> <span class="free">key</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="var">?nmi</span><span class="main">]</span> <span class="main">@</span> nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="var">?xmi</span><span class="main">]</span> <span class="main">@</span> <span class="main">_</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> filter_nths_diff<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> mini_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="var">?xmi</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> mini_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_filter_conv_card card_gt_0_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> exI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">←</span></span></span><span class="free"><span class="free"><span class="free">xs</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">key</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">k</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="bound">us</span><span class="main">.</span> <span class="free">key</span> <span class="bound">u</span> <span class="main">≠</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">key</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">vs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">us</span> <span class="bound">vs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq_Cons_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">us</span> <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">=</span> <span class="var">?nmi</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> neqE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> <span class="var">?nmi</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> A <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="var">?xmi</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> length <span class="skolem">us</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mini_first<span class="main">)</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">&lt;</span> length <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">!</span> <span class="var">?nmi</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">!</span> length <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">A</span> <span class="main">=</span> nths <span class="skolem">us</span> <span class="free">A</span> <span class="main">@</span> nths <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="var">?nmi</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nths <span class="skolem">us</span> <span class="free">A</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> nths <span class="skolem">vs</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">+</span> <span class="var">?nmi</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="main">_</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="var">?ws</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">drule_tac</span> in_set_nthsD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> nths <span class="skolem">us</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span>
    nths <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="var">?nmi</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nths <span class="skolem">us</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="var">?ws</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">drule_tac</span> in_set_nthsD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xmi</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword2"><span class="keyword">and</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-maxi_stable"><span class="command">lemma</span></span> maxi_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"maxi <span class="free">xs</span> <span class="free">key</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
      <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">∈</span> <span class="main">_</span>"</span></span><span class="main">)</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">xs</span> <span class="main">!</span> <span class="var">?nma</span><span class="main">]</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">_</span> <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">.</span> <span class="main">_</span><span class="main">]</span> <span class="main">=</span> <span class="main">_</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> filter_nths_diff<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span>2<span class="main"><span class="improper">]</span></span> maxi_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> A<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="var">?xma</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> maxi_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> length <span class="main">[</span><span class="bound">x</span><span class="main">←</span>rev <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> length_filter_conv_card card_gt_0_iff<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule_tac</span> exI <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"length <span class="free"><span class="free"><span class="free">xs</span></span></span> <span class="main"><span class="main"><span class="main">-</span></span></span> Suc <span class="var"><span class="var"><span class="var">?nma</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">y</span> <span class="bound">ys</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span>rev <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="bound">y</span> <span class="main">#</span> <span class="bound">ys</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> list.exhaust <span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">[</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">←</span></span></span>rev <span class="free"><span class="free"><span class="free">xs</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="free"><span class="free"><span class="free">key</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="free"><span class="free"><span class="free">k</span></span></span><span class="main"><span class="main"><span class="main">]</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>rev <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> rev <span class="free">xs</span> <span class="main">=</span> <span class="bound">us</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">u</span> <span class="main">∈</span> set <span class="bound">us</span><span class="main">.</span> <span class="free">key</span> <span class="bound">u</span> <span class="main">≠</span> <span class="free">k</span><span class="main">)</span> <span class="main">∧</span> <span class="free">key</span> <span class="skolem">y</span> <span class="main">=</span> <span class="free">k</span> <span class="main">∧</span> <span class="skolem">ys</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="bound">vs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">us</span> <span class="bound">vs</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">us</span> <span class="bound">vs</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_eq_Cons_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">us</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> E<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="skolem">us</span> <span class="skolem">vs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">hence</span></span> F<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">=</span> rev <span class="skolem">vs</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span> rev <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_swap<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> G<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">=</span> length <span class="free">xs</span> <span class="main">-</span> Suc <span class="var">?nma</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> neqE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">-</span> Suc <span class="var">?nma</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span><span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> Suc <span class="main">(</span>length <span class="skolem">us</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="var">?xma</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> maxi_last <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">us</span> <span class="main">&lt;</span> length <span class="free">xs</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span>rev <span class="free">xs</span> <span class="main">!</span> length <span class="skolem">us</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">key</span> <span class="var">?xma</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">key</span> <span class="main">(</span>rev <span class="free">xs</span> <span class="main">!</span> length <span class="skolem">us</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">-</span> Suc <span class="var">?nma</span> <span class="main">&lt;</span> length <span class="skolem">us</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> Suc <span class="var">?nma</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">us</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> Suc <span class="var">?nma</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">!</span> <span class="main">(</span>length <span class="free">xs</span> <span class="main">-</span> Suc <span class="var">?nma</span><span class="main">)</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">∈</span> set <span class="skolem">us</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="quoted">False</span>
      <span class="keyword1"><span class="command">using</span></span> C <span class="keyword2"><span class="keyword">and</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rev <span class="free">xs</span> <span class="main">!</span> length <span class="skolem">us</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?xma</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rev_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">=</span> length <span class="skolem">us</span> <span class="main">+</span> Suc <span class="var">?nma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> D <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> <span class="var">?nma</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="free">A</span> <span class="main">=</span> nths <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span> <span class="free">A</span> <span class="main">@</span> nths <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> rev <span class="skolem">us</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="var">?nma</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_append<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> nths <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="skolem">y</span> <span class="main">#</span>
    nths <span class="main">(</span>rev <span class="skolem">us</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">+</span> <span class="var">?nma</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">@</span> <span class="main">_</span> <span class="main">#</span> <span class="main">_</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> B <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nths_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">y</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">drule_tac</span> in_set_nthsD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> nths <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span>
    nths <span class="main">(</span><span class="skolem">y</span> <span class="main">#</span> rev <span class="skolem">us</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> <span class="bound">i</span> <span class="main">+</span> <span class="var">?nma</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_append<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> nths <span class="main">(</span>rev <span class="skolem">vs</span><span class="main">)</span> <span class="main">(</span><span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span>
    nths <span class="main">(</span>rev <span class="skolem">us</span><span class="main">)</span> <span class="main">{</span><span class="bound">i</span><span class="main">.</span> Suc <span class="bound">i</span> <span class="main">+</span> <span class="var">?nma</span> <span class="main">∈</span> <span class="free">A</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nths_Cons<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nths_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?nma</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span> <span class="main">∩</span> <span class="main">{..&lt;</span><span class="var">?nma</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> E <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> filter_empty_conv<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> ballI<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">drule_tac</span> in_set_nthsD<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="main">(</span><span class="free">A</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="free">xs</span> <span class="free">A</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> H <span class="keyword2"><span class="keyword">and</span></span> J <span class="keyword2"><span class="keyword">and</span></span> K <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-round_stab_inv"><span class="command">lemma</span></span> round_stab_inv <span class="main">[</span><span class="operator">rule_format</span><span class="main">]</span><span class="main">:</span>
 <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span> <span class="main">⟶</span> index_same <span class="free">index</span> <span class="free">key</span> <span class="main">⟶</span> bn_inv <span class="free">p</span> <span class="free">q</span> <span class="free">t</span> <span class="main">⟶</span>
    add_inv <span class="free">n</span> <span class="free">t</span> <span class="main">⟶</span> stab_inv <span class="free">f</span> <span class="free">key</span> <span class="free">t</span> <span class="main">⟶</span> stab_inv <span class="free">f</span> <span class="free">key</span> <span class="main">(</span>round <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">q</span> <span class="free">r</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">index</span></span> <span class="quoted"><span class="free">key</span></span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="free">q</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">f</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> round.induct<span class="main"><span class="keyword3">,</span></span>
 <span class="main">(</span><span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> simp_thms<span class="main">)</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">ns</span> <span class="skolem">xs</span> <span class="skolem">n</span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">f</span><span class="main">.</span> bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span>
      stab_inv <span class="bound">f</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> tl <span class="skolem">xs</span><span class="main">)</span> <span class="main">⟶</span> stab_inv <span class="bound">f</span> <span class="skolem">key</span> <span class="var">?t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"stab_inv <span class="skolem">f</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"stab_inv <span class="skolem">f</span> <span class="skolem">key</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">0</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="skolem">xs</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add_suc<span class="main"><span class="keyword3">,</span></span> <span class="operator">arith</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> conjE<span class="main"><span class="keyword3">,</span></span>
   <span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k</span> <span class="skolem">y</span> <span class="skolem">ys</span> <span class="skolem">xs'</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f'</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span><span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span> <span class="main">:=</span> tl <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n'</span> <span class="bound">f'</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> length <span class="skolem">ys</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="main">=</span> <span class="bound">f'</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">⟶</span> <span class="main">(</span><span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="main">=</span> <span class="bound">f'</span> <span class="bound">k'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">ys</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">k'</span><span class="main">)</span> <span class="main">⟶</span>
      <span class="main">(</span><span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">k'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> A<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">key</span> <span class="skolem">y</span> <span class="main">=</span> <span class="bound">k'</span>
      <span class="keyword1">then</span> <span class="skolem">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k'</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> B<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">key</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> spec <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="skolem"><span class="skolem"><span class="skolem">key</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">y</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">k'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule_tac</span> allI<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">k'</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">k'</span> <span class="main">≠</span> <span class="skolem">key</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k'</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> A <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">drule_tac</span> spec <span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x <span class="main"><span class="main"><span class="main">=</span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">k'</span></span></span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k'</span><span class="main">]</span> <span class="main">=</span> <span class="var">?f'</span> <span class="bound">k'</span>"</span></span> <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="skolem">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span> <span class="main">∧</span>
      <span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">k</span> <span class="main">⟶</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> conjI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> <span class="main"><span class="improper">[</span></span><span class="main"><span class="main">!</span></span><span class="main"><span class="improper">]</span></span> impI<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="skolem">y</span> <span class="main">=</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"tl <span class="main">(</span><span class="skolem">f</span> <span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">key</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">(</span><span class="skolem">key</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">key</span> <span class="skolem">y</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> B <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> hd_Cons_tl <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span><span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">#</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="skolem">y</span> <span class="main">≠</span> <span class="skolem">k</span>"</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> C <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">index</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="skolem">u</span> <span class="skolem">m</span> <span class="skolem">ns</span> <span class="skolem">n</span> <span class="skolem">f</span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="skolem">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> list"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ws</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ys</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"drop <span class="main">(</span>Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="skolem">xs</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?r</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">m'</span><span class="main">.</span> round_suc_suc <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?ws</span> <span class="skolem">m</span> <span class="bound">m'</span> <span class="skolem">u</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">r'</span> <span class="bound">v</span><span class="main">.</span> round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="bound">r'</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="skolem">index</span> <span class="skolem">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_same <span class="skolem">index</span> <span class="skolem">key</span>"</span></span>
  <span class="keyword3"><span class="command">assume</span></span>
   <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">i</span> <span class="bound">n</span> <span class="bound">f</span><span class="main">.</span>
      <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span> <span class="bound">c</span><span class="main">)</span> <span class="main">=</span> bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">⟹</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="bound">g</span><span class="main">)</span> <span class="main">=</span> <span class="var">?r</span> <span class="bound">b</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">h</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">g</span> <span class="main">⟹</span>
        bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span> add_inv <span class="bound">n</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span>
          stab_inv <span class="bound">f</span> <span class="skolem">key</span> <span class="main">(</span><span class="bound">e</span><span class="main">,</span> <span class="skolem">ns</span><span class="main">,</span> <span class="var">?ys</span><span class="main">)</span> <span class="main">⟶</span> stab_inv <span class="bound">f</span> <span class="skolem">key</span> <span class="main">(</span><span class="var">?t</span> <span class="bound">c</span> <span class="bound">e</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"bn_inv <span class="skolem">p</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"add_inv <span class="skolem">n</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
   <span class="quoted"><span class="quoted">"stab_inv <span class="skolem">f</span> <span class="skolem">key</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"stab_inv <span class="skolem">f</span> <span class="skolem">key</span> <span class="main">(</span>round <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">(</span><span class="skolem">u</span><span class="main">,</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">ns</span><span class="main">,</span> <span class="skolem">xs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> <span class="main">[</span><span class="main">[</span><span class="operator">simproc</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> defined_all<span class="main">]</span><span class="main">]</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> allI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> impI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span><span class="main"><span class="keyword3">?</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
   <span class="main">(</span><span class="operator">erule_tac</span> conjE<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> add_base_zero<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">m'</span> <span class="skolem">r'</span> <span class="skolem">v</span> <span class="skolem">ms'</span> <span class="skolem">ws'</span> <span class="skolem">xs'</span> <span class="skolem">k</span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?f</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?P</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?Q</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">f</span><span class="main">.</span> <span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span> <span class="main">=</span> <span class="bound">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span>
      C<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?r</span> <span class="skolem">m'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      D<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_comp <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span> <span class="skolem">r</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      E<span class="main">:</span> <span class="quoted"><span class="quoted">"bn_valid <span class="skolem">m</span> <span class="skolem">p</span> <span class="skolem">q</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      F<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>Suc <span class="main">(</span>foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
      G<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="skolem">xs</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">ws</span> <span class="bound">a</span> <span class="bound">b</span> <span class="bound">c</span> <span class="bound">d</span> <span class="bound">e</span> <span class="bound">g</span> <span class="bound">h</span> <span class="bound">i</span> <span class="bound">n'</span> <span class="bound">f</span><span class="main">.</span>
      <span class="bound">ws</span> <span class="main">=</span> <span class="var">?ws</span> <span class="main">⟹</span> <span class="bound">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">r'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">b</span> <span class="main">=</span> <span class="skolem">m'</span> <span class="main">∧</span> <span class="bound">c</span> <span class="main">=</span> <span class="skolem">r'</span> <span class="main">⟹</span>
      <span class="bound">d</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">v</span><span class="main">,</span> <span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">e</span> <span class="main">=</span> <span class="skolem">v</span> <span class="main">∧</span> <span class="bound">g</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ms'</span><span class="main">,</span> <span class="skolem">ws'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">h</span> <span class="main">=</span> <span class="skolem">ms'</span> <span class="main">∧</span> <span class="bound">i</span> <span class="main">=</span> <span class="skolem">ws'</span> <span class="main">⟹</span>
        foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">∧</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">=</span> <span class="bound">n'</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="bound">f</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="bound">f</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> foldl <span class="main">(+)</span> <span class="main">0</span> <span class="skolem">ns</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">-</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span> <span class="main">⟶</span> <span class="var">?P</span> <span class="bound">f</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="bound">f</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">f</span><span class="main">.</span> <span class="var">?P</span> <span class="bound">f</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="bound">f</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> F <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?P</span> <span class="var">?f</span> <span class="main">⟶</span> <span class="var">?Q</span> <span class="var">?f</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="bound">k</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span> <span class="main">@</span> <span class="var">?ys</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">k</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> filter_append<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> C <span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">ws'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="skolem">xs'</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="skolem">f</span> <span class="skolem">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> round_suc_suc_def Let_def <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> filter.simps
     <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_split_asm<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"mini <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?nma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"maxi <span class="var">?ws</span> <span class="skolem">key</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xmi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nmi</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?xma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?ws</span> <span class="main">!</span> <span class="var">?nma</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mi</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xmi</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ma</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">key</span> <span class="var">?xma</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?k</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> <span class="skolem">m</span> <span class="keyword1">of</span> <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">0</span> <span class="main">⇒</span> <span class="skolem">m</span> <span class="main">|</span> Suc <span class="main">(</span>Suc <span class="bound">i</span><span class="main">)</span> <span class="main">⇒</span> <span class="skolem">u</span> <span class="main">+</span> <span class="skolem">m'</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?zs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"nths <span class="var">?ws</span> <span class="main">(</span><span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">,</span> <span class="var">?nma</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ms</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"enum <span class="var">?zs</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="var">?k</span> <span class="var">?mi</span> <span class="var">?ma</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> H<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="var">?ws</span> <span class="main">=</span> Suc <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> F <span class="keyword2"><span class="keyword">and</span></span> G <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">hence</span></span> I<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">≠</span> <span class="var">?nma</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> mini_maxi_neq<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">(</span><span class="main">(</span><span class="main">[</span><span class="var">?xmi</span><span class="main">]</span> <span class="main">@</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">)</span>
        <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">)</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">&lt;</span> length <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> mini_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nmi</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">&lt;</span> length <span class="var">?ws</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> maxi_less<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> K<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?nma</span> <span class="main">&lt;</span> Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{..&lt;</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> I <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="main">(</span><span class="operator">subst</span> card_Diff_singleton<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main"><span class="keyword3">,</span></span>
           <span class="operator">subst</span> card_lessThan<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{..&lt;</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> fill_length<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> M<span class="main">:</span> <span class="quoted"><span class="quoted">"map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span> <span class="main">=</span>
          nths <span class="var">?ws</span> <span class="main">(</span><span class="main">{..&lt;</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> L<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> M<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="var">?xmi</span><span class="main">]</span> <span class="main">@</span> nths <span class="var">?ws</span> <span class="main">(</span><span class="main">{..&lt;</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span><span class="main">.</span>
            <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> mini_stable<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv
           <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I J<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="var">?ws</span> <span class="main">(</span><span class="main">{..&lt;</span>Suc <span class="main">(</span>Suc <span class="main">0</span><span class="main">)</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">.</span>
              <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> maxi_stable<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv
               <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> K<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> True<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="var">?k</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule_tac</span> bn_comp_fst_nonzero <span class="main"><span class="main">[</span></span><span class="operator">OF</span> E<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> <span class="main"><span class="main">(</span></span><span class="quasi_keyword">asm</span><span class="main"><span class="main">)</span></span> D<span class="main"><span class="keyword3">,</span></span>
           <span class="operator">simp</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> nat.split<span class="main">)</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="main">(</span>length <span class="var">?zs</span><span class="main">)</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">.</span>
          <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?zs</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">key</span> <span class="bound">x</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule_tac</span> fill_offs_enum_stable <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule_tac</span> conjI<span class="main"><span class="keyword3">,</span></span>
           <span class="main">(</span><span class="main">(</span><span class="operator">rule_tac</span> mini_lb <span class="main"><span class="keyword3">|</span></span> <span class="operator">rule_tac</span> maxi_ub<span class="main">)</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">erule_tac</span> in_set_nthsD<span class="main">)</span><span class="main"><span class="keyword3">+</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?zs</span><span class="main">.</span> <span class="skolem">k</span> <span class="main">=</span> <span class="skolem">key</span> <span class="bound">x</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?zs</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> filter_cong<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">blast</span><span class="main">)</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span>
          J<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span><span class="main">.</span>
            <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?zs</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> H <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mini_maxi_nths<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> filter_append J<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> Compl_eq_Diff_UNIV<span class="main"><span class="keyword3">,</span></span>
         <span class="operator">subst</span> Diff_insert<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="var">?xmi</span><span class="main">]</span> <span class="main">@</span> nths <span class="var">?ws</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="var">?nmi</span><span class="main">}</span><span class="main">)</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>
            <span class="main">@</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">subst</span> mini_stable<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv
           <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> I<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> filter_append <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>nths <span class="var">?ws</span> <span class="main">(</span>UNIV <span class="main">-</span> <span class="main">{</span><span class="var">?nma</span><span class="main">}</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span>
              <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> maxi_stable<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> length_greater_0_conv
               <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> nths_range<span class="main"><span class="keyword3">,</span></span> <span class="operator">subst</span> H<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?xmi</span> <span class="main">#</span> map the <span class="main">(</span>fill <span class="var">?zs</span> <span class="main">(</span>offs <span class="var">?ms</span> <span class="main">0</span><span class="main">)</span> <span class="skolem">index</span> <span class="skolem">key</span> <span class="skolem">m</span> <span class="var">?mi</span> <span class="var">?ma</span><span class="main">)</span> <span class="main">@</span>
        <span class="main">[</span><span class="var">?xma</span><span class="main">]</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="var">?ws</span><span class="main">.</span> <span class="skolem">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="skolem">k</span><span class="main">]</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Stability-gcsort_stab_inv"><span class="command">lemma</span></span> gcsort_stab_inv<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_same <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"add_inv <span class="free">n</span> <span class="free">t</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    D<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">t'</span> <span class="main">∈</span> gcsort_set <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">t</span><span class="main">;</span> stab_inv <span class="free">f</span> <span class="free">key</span> <span class="free">t</span><span class="main">⟧</span> <span class="main">⟹</span>
    stab_inv <span class="free">f</span> <span class="free">key</span> <span class="free">t'</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">erule</span> gcsort_set.induct<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">drule</span> gcsort_add_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A _ C D<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span>
 <span class="operator">rule</span> round_stab_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp_all</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> bn_inv.simps<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> conjE<span class="main"><span class="keyword3">,</span></span>
 <span class="operator">frule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> subst<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> bn_inv_intro<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> D<span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span><span class="main">)</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
\null

The only remaining task is to address step 10 of the proof method, which is done by proving theorem
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">gcsort_stable</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. It holds under the conditions that the objects' number is not larger than the
counters' upper bound and function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">text</span></span> <span class="raw_text"><span class="raw_text">index</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> satisfies both predicates <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> index_less<span class="antiquote"><span class="antiquote">}</span></span></span></span> and
<span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> index_same<span class="antiquote"><span class="antiquote">}</span></span></span></span>, and states that function <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> gcsort<span class="antiquote"><span class="antiquote">}</span></span></span></span> leaves unchanged the sublist of the
objects having a given key within the input objects' list.

\null
›</span></span>

<span class="keyword1"><span class="command">theorem</span></span> gcsort_stable<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span>
    A<span class="main">:</span> <span class="quoted"><span class="quoted">"index_less <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    B<span class="main">:</span> <span class="quoted"><span class="quoted">"index_same <span class="free">index</span> <span class="free">key</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    C<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">xs</span> <span class="main">≤</span> <span class="free">p</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>gcsort <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?t</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">0</span><span class="main">,</span> <span class="main">[</span>length <span class="free">xs</span><span class="main">]</span><span class="main">,</span> <span class="free">xs</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"stab_inv <span class="main">(</span><span class="main">λ</span><span class="bound">k</span><span class="main">.</span> <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="bound">k</span><span class="main">]</span><span class="main">)</span> <span class="free">key</span> <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_stab_inv <span class="main"><span class="main">[</span></span><span class="operator">OF</span> A B _ C<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_add_input<span class="main"><span class="keyword3">,</span></span>
     <span class="operator">rule</span> gcsort_aux_set<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> gcsort_stab_input<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="bound">x</span><span class="main">←</span>gcsort_out <span class="main">(</span>gcsort_aux <span class="free">index</span> <span class="free">key</span> <span class="free">p</span> <span class="var">?t</span><span class="main">)</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span> <span class="main">=</span>
    <span class="main">[</span><span class="bound">x</span><span class="main">←</span><span class="free">xs</span><span class="main">.</span> <span class="free">key</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">k</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> gcsort_stab_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?t</span> <span class="main">=</span> gcsort_in <span class="free">xs</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_in_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> gcsort_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>