<div id="Sqrt_Babylonian_Auxiliary">
<div class="head">
<h1>Theory Sqrt_Babylonian_Auxiliary</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Computing Square Roots using the Babylonian Method
    Author:      René Thiemann       &lt;rene.thiemann@uibk.ac.at&gt;
    Maintainer:  René Thiemann
    License:     LGPL
*)</span>

<span class="comment1">(*
Copyright 2009-2014 René Thiemann

This file is part of IsaFoR/CeTA.

IsaFoR/CeTA is free software: you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later
version.

IsaFoR/CeTA is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with IsaFoR/CeTA. If not, see &lt;http://www.gnu.org/licenses/&gt;.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Auxiliary lemmas which might be moved into the Isabelle distribution.›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Sqrt_Babylonian_Auxiliary
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="../../HOL/HOL/Complex_Main.html">Complex_Main</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-mod_div_equality_int"><span class="command">lemma</span></span> mod_div_equality_int<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">::</span> int<span class="main">)</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-div_is_floor_divide_rat"><span class="command">lemma</span></span> div_is_floor_divide_rat<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⌊</span>rat_of_int <span class="free">n</span> <span class="main">/</span> rat_of_int <span class="free">y</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> Fract_of_int_quotient<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> floor_Fract <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-div_is_floor_divide_real"><span class="command">lemma</span></span> div_is_floor_divide_real<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">y</span> <span class="main">=</span> <span class="main">⌊</span>real_of_int <span class="free">n</span> <span class="main">/</span> of_int <span class="free">y</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> div_is_floor_divide_rat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Ratreal_def of_rat_divide of_rat_of_int_eq real_floor_code<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-floor_div_pos_int"><span class="command">lemma</span></span> floor_div_pos_int<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> floor_ceiling"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">r</span> <span class="main">/</span> of_int <span class="free">n</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span> <span class="keyword1">div</span> <span class="free">n</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?r</span>"</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?of_int</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int <span class="main">::</span> int <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rhs</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span> <span class="keyword1">div</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?of_int</span> <span class="free">n</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span> <span class="keyword1">mod</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="var">?of_int</span> <span class="skolem">m</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"floor <span class="free">r</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> dm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rhs</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span> <span class="main">=</span> <span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> rhs_def m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> mn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> m0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n m_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> <span class="free">r</span> <span class="main">-</span> <span class="var">?of_int</span> <span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> e0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_self eq_iff floor_diff_of_int zero_le_floor<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> e1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">&lt;</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e_def 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> diff_self dual_order.refl floor_diff_of_int floor_le_zero<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="var">?of_int</span> <span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> e_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">r</span><span class="main">⌋</span> <span class="main">=</span> <span class="skolem">rhs</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> dm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">=</span> <span class="var">?of_int</span> <span class="main">(</span><span class="skolem">rhs</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">e</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">=</span> <span class="var">?of_int</span> <span class="main">(</span><span class="skolem">rhs</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">+</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?of_int</span> <span class="main">(</span><span class="skolem">rhs</span> <span class="main">*</span> <span class="free">n</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">=</span> <span class="var">?of_int</span> <span class="skolem">rhs</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">r</span> <span class="main">/</span> <span class="var">?of_int</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?of_int</span> <span class="skolem">m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?of_int</span> <span class="free">n</span> <span class="main">+</span> <span class="var">?of_int</span> <span class="skolem">rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="skolem">rhs</span> <span class="main">+</span> floor <span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> * <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"floor <span class="main">(</span><span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span><span class="main">)</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> floor_unique<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?of_int</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> e0 m0 n 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_increasing2 divide_nonneg_pos of_int_0 of_int_0_le_iff of_int_0_less_iff<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">&lt;</span> <span class="var">?of_int</span> <span class="main">0</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp_all</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="var">?thesis</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span><span class="main">)</span> <span class="main">/</span> <span class="var">?n</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> mult_right_mono<span class="main">[</span><span class="operator">OF</span> this n'<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="skolem">e</span> <span class="main">+</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n'<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> <span class="var">?n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> mn 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_1 of_int_diff of_int_le_iff zle_diff1_eq<span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">≤</span> <span class="skolem">e</span> <span class="main">+</span> <span class="var">?n</span> <span class="main">-</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> e1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> rhs_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-floor_div_neg_int"><span class="command">lemma</span></span> floor_div_neg_int<span class="main">:</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> floor_ceiling"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">r</span> <span class="main">/</span> of_int <span class="free">n</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌈</span><span class="free">r</span><span class="main">⌉</span> <span class="keyword1">div</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> n'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="free">r</span> <span class="main">/</span> of_int <span class="free">n</span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span> <span class="main">-</span> <span class="free">r</span> <span class="main">/</span> of_int <span class="main">(</span><span class="main">-</span> <span class="free">n</span><span class="main">)</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> floor_of_int floor_zero less_int_code<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> minus_divide_left minus_minus nonzero_minus_divide_right of_int_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⌊</span> <span class="main">-</span> <span class="free">r</span> <span class="main">⌋</span> <span class="keyword1">div</span> <span class="main">(</span><span class="main">-</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> floor_div_pos_int<span class="main"><span class="main">[</span></span><span class="operator">OF</span> n'<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">⌈</span> <span class="free">r</span> <span class="main">⌉</span> <span class="keyword1">div</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> ceiling_def div_minus_right<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-divide_less_floor1"><span class="command">lemma</span></span> divide_less_floor1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">/</span> <span class="free">y</span> <span class="main">&lt;</span> of_int <span class="main">(</span>floor <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="free">y</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> floor_less_iff less_add_one of_int_1 of_int_add<span class="main">)</span>

<span class="keyword1"><span class="command">context</span></span> linordered_idom
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-sgn_int_pow_if"><span class="command">lemma</span></span> sgn_int_pow_if <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"sgn <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">p</span> <span class="keyword1">then</span> <span class="main">1</span> <span class="keyword1">else</span> sgn <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">if</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> that <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">p</span></span><span class="main">)</span> <span class="operator">simp_all</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-compare_pow_le_iff"><span class="command">lemma</span></span> compare_pow_le_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">≤</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> eq_iff linear power_eq_imp_eq_base power_mono<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-compare_pow_less_iff"><span class="command">lemma</span></span> compare_pow_less_iff<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">::</span> <span class="tfree">'a</span><span class="main">)</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="free">y</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="free">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_less_imp_less_base power_strict_mono<span class="main">)</span>
    
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-quotient_of_int"><span class="command">lemma</span></span> quotient_of_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>of_int <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rat.of_int_def quotient_of_int<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-quotient_of_nat"><span class="command">lemma</span></span> quotient_of_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>of_nat <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>int <span class="free">i</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Rat.of_int_def Rat.quotient_of_int of_int_of_nat_eq<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-square_lesseq_square"><span class="command">lemma</span></span> square_lesseq_square<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_field<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">≤</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_mono mult_strict_mono' not_less<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-square_less_square"><span class="command">lemma</span></span> square_less_square<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="bound">x</span> <span class="main">::</span> <span class="tfree">'a</span> <span class="main">::</span> linordered_field<span class="main">)</span> <span class="main">⟹</span> <span class="main">0</span> <span class="main">≤</span> <span class="bound">y</span> <span class="main">⟹</span> <span class="main">(</span><span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">y</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> mult_mono mult_strict_mono' not_less<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-sqrt_sqrt"><span class="command">lemma</span></span> sqrt_sqrt<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> sqrt <span class="free">x</span> <span class="main">*</span> sqrt <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> real_sqrt_pow2 power2_eq_square<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian_Auxiliary-abs_lesseq_square"><span class="command">lemma</span></span> abs_lesseq_square<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="main">(</span><span class="free">x</span> <span class="main">::</span> real<span class="main">)</span> <span class="main">≤</span> abs <span class="free">y</span> <span class="main">⟷</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">≤</span> <span class="free">y</span> <span class="main">*</span> <span class="free">y</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> square_lesseq_square<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">y</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Log_Impl">
<div class="head">
<h1>Theory Log_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Computing Square Roots using the Babylonian Method
    Author:      René Thiemann       &lt;rene.thiemann@uibk.ac.at&gt;
    Maintainer:  René Thiemann
    License:     LGPL
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹A Fast Logarithm Algorithm›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Log_Impl
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Sqrt_Babylonian_Auxiliary.html">Sqrt_Babylonian_Auxiliary</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We implement the discrete logarithm function in a manner similar to
  a repeated squaring exponentiation algorithm.›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to prove termination of the algorithm without intermediate checks 
  we need to ensure that we only use proper bases, 
  i.e., values of at least 2. This will be encoded into a separate type.›</span></span>

<span class="keyword1"><span class="command">typedef</span></span> proper_base <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">x</span> <span class="main">::</span> int<span class="main">.</span> <span class="bound">x</span> <span class="main">≥</span> <span class="numeral">2</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">setup_lifting</span></span> type_definition_proper_base

<span class="keyword1"><span class="command">lift_definition</span></span> get_base <span class="main">::</span> <span class="quoted"><span class="quoted">"proper_base <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> square_base <span class="main">::</span> <span class="quoted"><span class="quoted">"proper_base <span class="main">⇒</span> proper_base"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> <span class="bound">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="main">::</span> <span class="quoted">int</span>
  <span class="keyword3"><span class="command">assume</span></span> i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">i</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">*</span> <span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">i</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> i i<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> i<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">2</span> <span class="main">≤</span> <span class="skolem">i</span> <span class="main">*</span> <span class="skolem">i</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lift_definition</span></span> into_base <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> proper_base"</span></span> <span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">x</span> <span class="main">≥</span> <span class="numeral">2</span> <span class="keyword1">then</span> <span class="bound">x</span> <span class="keyword1">else</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Log_Impl-square_base"><span class="command">lemma</span></span> square_base<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="main">(</span>square_base <span class="free">b</span><span class="main">)</span> <span class="main">=</span> get_base <span class="free">b</span> <span class="main">*</span> get_base <span class="free">b</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Log_Impl-get_base_2"><span class="command">lemma</span></span> get_base_2<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="free">b</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">transfer</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="Log_Impl-b_less_square_base_b"><span class="command">lemma</span></span> b_less_square_base_b<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="free">b</span> <span class="main">&lt;</span> get_base <span class="main">(</span>square_base <span class="free">b</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> square_base <span class="keyword1"><span class="command">using</span></span> get_base_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Log_Impl-b_less_div_base_b"><span class="command">lemma</span></span> b_less_div_base_b<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> xb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="free">x</span> <span class="main">&lt;</span> get_base <span class="free">b</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="keyword1">div</span> get_base <span class="free">b</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> get_base_2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="free">b</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">with</span></span> xb <span class="keyword1"><span class="command">have</span></span> x2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">with</span></span> b int_div_less_self<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>get_base <span class="free">b</span><span class="main">)</span>"</span></span><span class="main">]</span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now state the main algorithm.›</span></span>
    
<span class="keyword1"><span class="command">function</span></span> <span class="entity">log_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"proper_base <span class="main">⇒</span> int <span class="main">⇒</span> nat <span class="main">×</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">log_main</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> get_base <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span><span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span>
    <span class="keyword1">case</span> <span class="free">log_main</span> <span class="main">(</span>square_base <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> 
      <span class="main">(</span><span class="bound">z</span><span class="main">,</span> <span class="bound">bz</span><span class="main">)</span> <span class="main">⇒</span> 
    <span class="keyword1">let</span> <span class="bound">l</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="bound">z</span><span class="main">;</span> <span class="bound">bz1</span> <span class="main">=</span> <span class="bound">bz</span> <span class="main">*</span> get_base <span class="free"><span class="bound"><span class="entity">b</span></span></span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="bound">bz1</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span><span class="bound">bz</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Suc <span class="bound">l</span><span class="main">,</span><span class="bound">bz1</span><span class="main">)</span><span class="main">)</span>"</span></span> 
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">termination</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="quoted"><span class="quoted">"measure <span class="main">(</span><span class="main">λ</span> <span class="main">(</span><span class="bound">b</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> nat <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">x</span> <span class="main">-</span> get_base <span class="bound">b</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span>
  <span class="operator">insert</span> b_less_square_base_b<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>   

<span class="keyword1" id="Log_Impl-log_main"><span class="command">lemma</span></span> log_main<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> log_main <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">by</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">by</span> <span class="main">=</span> <span class="main">(</span>get_base <span class="free">b</span><span class="main">)</span><span class="main">^</span><span class="free">y</span> <span class="main">∧</span> <span class="main">(</span>get_base <span class="free">b</span><span class="main">)</span><span class="main">^</span><span class="free">y</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">(</span>get_base <span class="free">b</span><span class="main">)</span><span class="main">^</span><span class="main">(</span>Suc <span class="free">y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="quoted">"<span class="free">by</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> log_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">b</span> <span class="skolem">x</span> <span class="skolem">y</span> <span class="quoted">"<span class="skolem">by</span>"</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> x <span class="main">=</span> 1<span class="main">(</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> y <span class="main">=</span> 1<span class="main">(</span>3<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?b</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"get_base <span class="skolem">b</span>"</span></span> 
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> x y <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">bz</span></span> <span class="keyword2"><span class="keyword">where</span></span> zz<span class="main">:</span> <span class="quoted"><span class="quoted">"log_main <span class="main">(</span>square_base <span class="skolem">b</span><span class="main">)</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="skolem">bz</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"log_main <span class="main">(</span>square_base <span class="skolem">b</span><span class="main">)</span> <span class="skolem">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="main">(</span>square_base <span class="skolem">b</span><span class="main">)</span> <span class="main">^</span> <span class="skolem">k</span> <span class="main">=</span> <span class="var">?b</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">k</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">k</span> <span class="keyword1"><span class="command">unfolding</span></span> square_base
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power_mult semiring_normalization_rules<span class="main"><span class="main">(</span></span>29<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> IH<span class="main">[</span><span class="operator">OF</span> False x zz<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> 
    <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="var">?b</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> Suc <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> bz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bz</span> <span class="main">=</span> get_base <span class="skolem">b</span> <span class="main">^</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> y<span class="main">[</span><span class="operator">unfolded</span> log_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span> <span class="quoted"><span class="skolem">x</span></span><span class="main"><span class="main">]</span></span> Let_def zz split<span class="main">]</span> bz False
    <span class="keyword1"><span class="command">have</span></span> yy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">bz</span> <span class="main">*</span> <span class="var">?b</span> <span class="keyword1">then</span> <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">,</span> <span class="skolem">bz</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span>Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span><span class="main">,</span> <span class="skolem">bz</span> <span class="main">*</span> <span class="var">?b</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">by</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">bz</span> <span class="main">*</span> <span class="var">?b</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">with</span></span> yy <span class="keyword1"><span class="command">have</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">by</span> <span class="main">=</span> <span class="skolem">bz</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> True z<span class="main">(</span>1<span class="main">)</span> bz <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> yz <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> yy <span class="keyword1"><span class="command">have</span></span> yz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">by</span> <span class="main">=</span> <span class="var">?b</span> <span class="main">*</span> <span class="skolem">bz</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?b</span> <span class="main">^</span> Suc <span class="main">(</span><span class="numeral">2</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">)</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bz <span class="dynamic"><span class="dynamic">ac_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">with</span></span> z<span class="main">(</span>2<span class="main">)</span> bz <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> yz <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We then derive the floor- and ceiling-log functions.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">log_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">log_floor</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> fst <span class="main">(</span>log_main <span class="main">(</span>into_base <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span> 

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">log_ceiling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">log_ceiling</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> log_main <span class="main">(</span>into_base <span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span>
     <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">by</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="bound">by</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> Suc <span class="bound">y</span><span class="main">)</span>"</span></span> 

<span class="keyword1" id="Log_Impl-log_floor_sound"><span class="command">lemma</span></span> log_floor_sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"log_floor <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">^</span><span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>Suc <span class="free">y</span><span class="main">)</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="main">(</span>into_base <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="skolem"><span class="skolem">bb</span></span> <span class="keyword2"><span class="keyword">where</span></span> log<span class="main">:</span> <span class="quoted"><span class="quoted">"log_main <span class="main">(</span>into_base <span class="free">b</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yy</span><span class="main">,</span><span class="skolem">bb</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"log_main <span class="main">(</span>into_base <span class="free">b</span><span class="main">)</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> log_main<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> log<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> log_floor_def log<span class="main">]</span> id
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">^</span><span class="free">y</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span>Suc <span class="free">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Log_Impl-log_ceiling_sound"><span class="command">lemma</span></span> log_ceiling_sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"log_ceiling <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span>  
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">^</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> 
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"get_base <span class="main">(</span>into_base <span class="free">b</span><span class="main">)</span> <span class="main">=</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">transfer</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="skolem"><span class="skolem">bb</span></span> <span class="keyword2"><span class="keyword">where</span></span> log<span class="main">:</span> <span class="quoted"><span class="quoted">"log_main <span class="main">(</span>into_base <span class="free">b</span><span class="main">)</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yy</span><span class="main">,</span><span class="skolem">bb</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"log_main <span class="main">(</span>into_base <span class="free">b</span><span class="main">)</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> log_main<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> log<span class="main">,</span> <span class="operator">unfolded</span> id<span class="main">]</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> log_ceiling_def log split<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> bnd<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">^</span> <span class="skolem">yy</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="free">b</span> <span class="main">^</span> Suc <span class="skolem">yy</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span>
    y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">^</span> <span class="skolem">yy</span> <span class="keyword1">then</span> <span class="skolem">yy</span> <span class="keyword1">else</span> Suc <span class="skolem">yy</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">^</span><span class="free">y</span> <span class="main">∧</span> <span class="main">(</span><span class="free">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">b</span> <span class="main">^</span> <span class="skolem">yy</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> y bnd assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">yy</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">with</span></span> y bnd <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="free">b</span><span class="main">^</span><span class="free">y</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">b</span><span class="main">^</span><span class="main">(</span><span class="free">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally, we connect it to the <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> log<span class="antiquote"><span class="antiquote">}</span></span></span></span> function working on real numbers.›</span></span>

<span class="keyword1" id="Log_Impl-log_floor"><span class="command">lemma</span></span> log_floor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log_floor <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⌊</span>log <span class="free">b</span> <span class="free">x</span><span class="main">⌋</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"log_floor <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> log_floor_sound<span class="main">[</span><span class="operator">OF</span> assms y<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> b x <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> real_of_int <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="main">(</span><span class="free">b</span> <span class="main">^</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="free">x</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> real_of_int <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="main">(</span><span class="free">b</span> <span class="main">^</span> Suc <span class="skolem">y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> y
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> floor_unique<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>int <span class="skolem">y</span><span class="main">)</span> <span class="main">≤</span> log <span class="main">(</span>real_of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">x</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> log_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> of_int_le_iff<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> log_pow_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"log <span class="main">(</span>real_of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">x</span><span class="main">)</span> <span class="main">&lt;</span> real_of_int <span class="main">(</span>int <span class="skolem">y</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> main<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> log_less_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> **<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> of_int_less_iff<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> log_pow_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">y</span>"</span></span><span class="main">]</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>
    
<span class="keyword1" id="Log_Impl-log_ceiling"><span class="command">lemma</span></span> log_ceiling<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">&gt;</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"log_ceiling <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="main">⌈</span>log <span class="free">b</span> <span class="free">x</span><span class="main">⌉</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"log_ceiling <span class="free">b</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> main <span class="main">=</span> log_ceiling_sound<span class="main">[</span><span class="operator">OF</span> assms y<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> b x <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> real_of_int <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="main">(</span><span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="free">x</span>"</span></span> 
    <span class="keyword2"><span class="keyword">and</span></span> **<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">&lt;</span> real_of_int <span class="free">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="free">x</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="main">(</span><span class="free">b</span> <span class="main">^</span> <span class="skolem">y</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> y
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sym<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> ceiling_unique<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"log <span class="main">(</span>real_of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">x</span><span class="main">)</span> <span class="main">≤</span> real_of_int <span class="main">(</span>int <span class="skolem">y</span><span class="main">)</span>"</span></span> 
      <span class="keyword1"><span class="command">using</span></span> main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> log_le_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> **<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> of_int_le_iff<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> log_pow_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="skolem">y</span></span><span class="main">]</span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>int <span class="skolem">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> log <span class="main">(</span>real_of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">x</span><span class="main">)</span>"</span></span> 
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> 
        <span class="keyword1"><span class="command">using</span></span> main<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> log_less_cancel_iff<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> of_int_less_iff<span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> log_pow_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">b</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">-</span> <span class="main">1</span>"</span></span><span class="main">]</span> b x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>int <span class="skolem">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">=</span> log <span class="free">b</span> <span class="main">(</span><span class="main">1</span><span class="main">/</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> True b 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_divide<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> log <span class="free">b</span> <span class="main">1</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_less_cancel_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> b<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> log <span class="free">b</span> <span class="free">x</span>"</span></span> 
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">subst</span> log_le_cancel_iff<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> b x<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span> 
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>int <span class="skolem">y</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span> <span class="main">&lt;</span> log <span class="main">(</span>real_of_int <span class="free">b</span><span class="main">)</span> <span class="main">(</span>real_of_int <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="NthRoot_Impl">
<div class="head">
<h1>Theory NthRoot_Impl</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Computing Square Roots using the Babylonian Method
    Author:      René Thiemann       &lt;rene.thiemann@uibk.ac.at&gt;
    Maintainer:  René Thiemann
    License:     LGPL
*)</span>

<span class="comment1">(*
Copyright 2009-2014 René Thiemann

This file is part of IsaFoR/CeTA.

IsaFoR/CeTA is free software: you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later
version.

IsaFoR/CeTA is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with IsaFoR/CeTA. If not, see &lt;http://www.gnu.org/licenses/&gt;.
*)</span>
<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executable algorithms for $p$-th roots›</span></span>

<span class="keyword1"><span class="command">theory</span></span> NthRoot_Impl
<span class="keyword2"><span class="keyword">imports</span></span>
  <a href="Log_Impl.html">Log_Impl</a>
  <a href="../Cauchy/CauchysMeanTheorem.html">Cauchy.CauchysMeanTheorem</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We implemented algorithms to decide $\sqrt[p]{n} \in \rats$ and to compute $\lfloor \sqrt[p]{n} \rfloor$.
To this end, we use a variant of Newton iteration which works with integer division instead of floating
point or rational division. To get suitable starting values for the Newton iteration, we also implemented
a function to approximate logarithms.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Logarithm›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For computing the $p$-th root of a number $n$, we must choose a starting value
  in the iteration. Here, we use <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">^</span></span> <span class="main"><span class="main">(</span></span>nat <span class="main"><span class="main">⌈</span></span>of_int <span class="main"><span class="main">⌈</span></span>log <span class="numeral"><span class="numeral">2</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">⌉</span></span> <span class="main"><span class="main">/</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">⌉</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We use a partial efficient algorithm, which does not terminate on
  corner-cases, like $b = 0$ or $p = 1$, and invoke it properly afterwards.
  Then there is a second algorithm which terminates on these corner-cases by additional
  guards and on which we can perform induction.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Computing the $p$-th root of an integer number›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the logarithm, we can define an executable version of the
  intended  starting value. Its main property is the inequality
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(</span></span><span class="free"><span class="free">start_value</span></span> <span class="free"><span class="free">x</span></span> <span class="free"><span class="free">p</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">^</span></span> <span class="free"><span class="free">p</span></span> <span class="main"><span class="main">≥</span></span> <span class="free"><span class="free">x</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, i.e., the start value is larger
  than the p-th root. This property is essential, since our algorithm will abort
  as soon as we fall below the p-th root.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">start_value</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">start_value</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="main">(</span>nat <span class="main">⌈</span>of_nat <span class="main">(</span>log_ceiling <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="main">/</span> rat_of_nat <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">⌉</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NthRoot_Impl-start_value_main"><span class="command">lemma</span></span> start_value_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>start_value <span class="free">x</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">p</span> <span class="main">∧</span> start_value <span class="free">x</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_value_def True <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> x <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">l2x</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2x</span> <span class="main">=</span> <span class="main">⌈</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">⌉</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">pow</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pow</span> <span class="main">=</span> nat <span class="main">⌈</span>rat_of_int <span class="skolem">l2x</span> <span class="main">/</span> of_nat <span class="free">p</span><span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="free">x</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> root_powr_inverse<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">powr</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> powr_log_cancel<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> powr_powr<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> log <span class="numeral">2</span> <span class="free">x</span> <span class="main">/</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="main">(</span>log <span class="numeral">2</span> <span class="free">x</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> lp<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> l2pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l2x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> l2x_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">/</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">l2x</span> <span class="main">/</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x p <span class="keyword1"><span class="command">unfolding</span></span> l2x_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> divide_right_mono le_of_int_ceiling of_nat_0_le_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">⌈</span><span class="skolem">l2x</span> <span class="main">/</span> <span class="main">(</span><span class="free">p</span> <span class="main">::</span> real<span class="main">)</span><span class="main">⌉</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ceiling_correct<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l2x</span> <span class="main">/</span> real <span class="free">p</span> <span class="main">=</span> <span class="skolem">l2x</span> <span class="main">/</span> real_of_rat <span class="main">(</span>of_nat <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_rat_of_nat_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">l2x</span> <span class="main">=</span> real_of_rat <span class="main">(</span>of_int <span class="skolem">l2x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_rat_of_int_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_rat <span class="main">(</span>of_int <span class="skolem">l2x</span><span class="main">)</span> <span class="main">/</span> real_of_rat <span class="main">(</span>of_nat <span class="free">p</span><span class="main">)</span> <span class="main">=</span> real_of_rat <span class="main">(</span>rat_of_int <span class="skolem">l2x</span> <span class="main">/</span> of_nat <span class="free">p</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_rat_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span>real_of_rat <span class="main">(</span>rat_of_int <span class="skolem">l2x</span> <span class="main">/</span> rat_of_nat <span class="free">p</span><span class="main">)</span><span class="main">⌉</span> <span class="main">=</span> <span class="main">⌈</span>rat_of_int <span class="skolem">l2x</span> <span class="main">/</span> of_nat <span class="free">p</span><span class="main">⌉</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌈</span>rat_of_int <span class="skolem">l2x</span> <span class="main">/</span> of_nat <span class="free">p</span><span class="main">⌉</span> <span class="main">≤</span> real <span class="skolem">pow</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pow_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"log <span class="numeral">2</span> <span class="free">x</span> <span class="main">/</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">pow</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> powr_mono<span class="main">[</span><span class="operator">OF</span> le<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">,</span> <span class="operator">folded</span> r<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="free">x</span> <span class="main">≤</span> <span class="numeral">2</span> <span class="keyword1">powr</span> <span class="skolem">pow</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">^</span> <span class="skolem">pow</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> powr_realpow<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">^</span> <span class="skolem">pow</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">pow</span> <span class="main">=</span> <span class="main">(</span>nat <span class="main">⌈</span>of_int <span class="main">(</span>log_ceiling <span class="numeral">2</span> <span class="free">x</span><span class="main">)</span> <span class="main">/</span> rat_of_nat <span class="free">p</span><span class="main">⌉</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> pow_def l2x_def <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">(</span><span class="numeral">2</span> <span class="main">::</span> int<span class="main">)</span> <span class="main">^</span> <span class="main">…</span> <span class="main">)</span> <span class="main">=</span> start_value <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> start_value_def  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="free">x</span> <span class="main">≤</span> start_value <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> root <span class="free">p</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> start_value <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> less<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> start_value <span class="free">x</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> power_mono<span class="main">[</span><span class="operator">OF</span> less<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> of_int <span class="main">(</span>start_value <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> start_value <span class="free">x</span> <span class="free">p</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p x <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>start_value <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
  <span class="keyword1"><span class="command">with</span></span> start <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-start_value"><span class="command">lemma</span></span> start_value<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>start_value <span class="free">x</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"start_value <span class="free">x</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> start_value_main<span class="main">[</span><span class="operator">OF</span> x p<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We now define the Newton iteration to compute the $p$-th root. We are working on the integers,
  where every <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">(/)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is replaced by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1"><span class="keyword1">(div)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. We are proving several things within
  a locale which ensures that $p &gt; 0$, and where $pm = p - 1$.
›</span></span>

<span class="keyword1"><span class="command">locale</span></span> fixed_root <span class="main">=</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">p</span> <span class="free">pm</span> <span class="main">::</span> <span class="quoted">nat</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> Suc <span class="free">pm</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">root_newton_int_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">×</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_newton_int_main</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span>False<span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">root_newton_int_main</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">^</span> <span class="free">pm</span><span class="main">)</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹For the executable algorithm we omit the guard and use a let-construction›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">root_int_main'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">×</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">root_int_main'</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">ipm</span></span></span> <span class="free"><span class="bound"><span class="entity">ip</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">xpm</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">^</span><span class="free"><span class="bound"><span class="entity">pm</span></span></span><span class="main">;</span> <span class="bound">xp</span> <span class="main">=</span> <span class="bound">xpm</span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">xp</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="bound">xp</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="free">root_int_main'</span> <span class="free"><span class="bound"><span class="entity">pm</span></span></span> <span class="free"><span class="bound"><span class="entity">ipm</span></span></span> <span class="free"><span class="bound"><span class="entity">ip</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="keyword1">div</span> <span class="bound">xpm</span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">ipm</span></span></span><span class="main">)</span> <span class="keyword1">div</span> <span class="free"><span class="bound"><span class="entity">ip</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In the following algorithm, we
  start the iteration.
  It will compute <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌊</span></span>root <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">n</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and a boolean to indicate whether the root is exact.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_int_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">×</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_int_main</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="main">1</span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span> <span class="keyword1">else</span>
     <span class="keyword1">let</span> <span class="bound">pm</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span>
       <span class="keyword1">in</span> root_int_main' <span class="bound">pm</span> <span class="main">(</span>int <span class="bound">pm</span><span class="main">)</span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="main">(</span>start_value <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once we have proven soundness of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fixed_root.root_newton_int_main<span class="antiquote"><span class="antiquote">}</span></span></span></span> and equivalence
  to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> root_int_main<span class="antiquote"><span class="antiquote">}</span></span></span></span>, it
  is easy to assemble the following algorithm which computes all roots for arbitrary integers.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int <span class="main">⇒</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_int</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="keyword1">else</span>
      <span class="keyword1">let</span> <span class="bound">e</span> <span class="main">=</span> even <span class="free"><span class="bound"><span class="entity">p</span></span></span><span class="main">;</span> <span class="bound">s</span> <span class="main">=</span> sgn <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">;</span> <span class="bound">x'</span> <span class="main">=</span> abs <span class="free"><span class="bound"><span class="entity">x</span></span></span>
      <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> <span class="bound">e</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">case</span> root_int_main <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">x'</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span>True<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">e</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span><span class="main">-</span><span class="bound">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="bound">s</span> <span class="main">*</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We start with proving termination of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> fixed_root.root_newton_int_main<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1"><span class="command">context</span></span> fixed_root
<span class="keyword2"><span class="keyword">begin</span></span>
<span class="keyword1" id="NthRoot_Impl-iteration_mono_eq"><span class="command">lemma</span></span> iteration_mono_eq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span> <span class="bound">n</span><span class="main">.</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> <span class="bound">n</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> xn<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-p0"><span class="command">lemma</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following property is the essential property for
  proving termination of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> "root_newton_int_main"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>
<span class="keyword1" id="NthRoot_Impl-iteration_mono_less"><span class="command">lemma</span></span> iteration_mono_less<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span> <span class="main">&lt;</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> xn <span class="keyword1"><span class="command">have</span></span> xn_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> xn x n <span class="keyword1"><span class="command">have</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> not_le p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> xp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> x n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">*</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> minus_mod_eq_div_mult <span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> mod_int_pos_iff not_less power_le_zero_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> xn <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x x0 <span class="keyword1"><span class="command">unfolding</span></span> xp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sx</span> <span class="main">≤</span> <span class="main">(</span><span class="free">x</span><span class="main">^</span><span class="free">p</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> zdiv_mono1<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> le p0<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> xp<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">p</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xp <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> int <span class="free">p</span> <span class="keyword1">div</span> int <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sx</span> <span class="main">≤</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sx</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> int <span class="free">p</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> int <span class="free">p</span> <span class="main">≤</span> <span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="main">*</span> int <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> mod_div_equality_int <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span> <span class="main">≥</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> mult_right_mono<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">pm</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span> <span class="main">*</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span> <span class="main">≥</span> <span class="free">x</span><span class="main">^</span><span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> xp <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> div_mult_mod_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">pm</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span> <span class="main">*</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> ge<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">^</span><span class="free">p</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">-</span> <span class="free">n</span> <span class="keyword1">mod</span> <span class="free">x</span><span class="main">^</span><span class="free">pm</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> x n <span class="keyword1"><span class="command">have</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="keyword1">mod</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mod_int_pos_iff not_less power_le_zero_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> le ge
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="free">x</span><span class="main">^</span><span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> xn <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">with</span></span> le <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-iteration_mono_lesseq"><span class="command">lemma</span></span> iteration_mono_lesseq<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="free">n</span> <span class="main">::</span> int<span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="free">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">from</span></span> iteration_mono_eq<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">with</span></span> assms <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> iteration_mono_less<span class="main">[</span><span class="operator">OF</span> x n this<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">termination</span></span> <span class="comment1">(* of root_newton_int_main *)</span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?mm</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span>  <span class="bound">n</span> <span class="main">::</span> int<span class="main">.</span> nat <span class="bound">x</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span><span class="main">.</span> <span class="var">?mm</span> <span class="bound">x</span> <span class="bound">n</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"measures <span class="main">[</span><span class="var">?m1</span><span class="main">]</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">relation</span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">n</span> <span class="main">::</span> <span class="quoted">int</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> x_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> x x_n <span class="keyword1"><span class="command">have</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> iteration_mono_less<span class="main">[</span><span class="operator">OF</span> x_n x<span class="main">]</span> x0
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span><span class="main">,</span> <span class="skolem">x</span><span class="main">,</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">∈</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We next prove that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> root_int_main'<span class="antiquote"><span class="antiquote">}</span></span></span></span> is a correct implementation of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> root_newton_int_main<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
We additionally prove that the result is always positive, a lower bound, and that the returned boolean indicates
whether the result has a root or not. We prove all these results in one go, so that we can share the
inductive proof.
›</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">root_main'</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">root_main'</span> <span class="main">≡</span> root_int_main' <span class="free">pm</span> <span class="main">(</span>int <span class="free">pm</span><span class="main">)</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> root_main'_simps <span class="main">=</span> root_int_main'.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">pm</span></span> <span class="quoted"><span class="quoted">"int <span class="free">pm</span>"</span></span> <span class="quoted"><span class="quoted">"int <span class="free">p</span>"</span></span><span class="main">]</span>

<span class="keyword1" id="NthRoot_Impl-root_main'_newton_pos"><span class="command">lemma</span></span> root_main'_newton_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span>
  root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> root_newton_int_main <span class="free">x</span> <span class="free">n</span> <span class="main">∧</span> <span class="main">(</span>root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">y</span><span class="main">^</span><span class="free">p</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">^</span><span class="free">p</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> root_newton_int_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> pm_x<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">=</span> <span class="skolem">x</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> root_main'_simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> root_newton_int_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span> id if_False Let_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">n</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> 1<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> <span class="quoted"><span class="quoted">‹<span class="main">0</span> <span class="main">≤</span> <span class="skolem">n</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">x</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> int <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p <span class="dynamic"><span class="dynamic">algebra_simps</span></span> pos_imp_zdiv_nonneg_iff power_0_left<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d id pm_x
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> 1<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">OF</span> not False _ 1<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_main'"><span class="command">lemma</span></span> root_main'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> root_newton_int_main <span class="free">x</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_main'_newton_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="NthRoot_Impl-root_main'_pos"><span class="command">lemma</span></span> root_main'_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_main'_newton_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="NthRoot_Impl-root_main'_sound"><span class="command">lemma</span></span> root_main'_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_main'_newton_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In order to prove completeness of the algorithms, we provide sharp upper and lower bounds
  for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> root_main'<span class="antiquote"><span class="antiquote">}</span></span></span></span>. For the upper bounds, we use Cauchy's mean theorem where we added
  the non-strict variant to Porter's formalization of this theorem.›</span></span>

<span class="keyword1" id="NthRoot_Impl-root_main'_lower"><span class="command">lemma</span></span> root_main'_lower<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_main'_newton_pos <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

<span class="keyword1" id="NthRoot_Impl-root_newton_int_main_upper"><span class="command">lemma</span></span> root_newton_int_main_upper<span class="main">:</span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root_newton_int_main <span class="free">y</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> root_newton_int_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">y</span> <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">^</span> <span class="free">pm</span><span class="main">)</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> int <span class="free">pm</span><span class="main">)</span> <span class="keyword1">div</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">n</span> <span class="main">≥</span> <span class="main">0</span>›</span></span> <span class="keyword1"><span class="command">have</span></span> y'0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> y'_def p <span class="dynamic"><span class="dynamic">algebra_simps</span></span> pos_imp_zdiv_nonneg_iff power_0_left<span class="main">)</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?rt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root_newton_int_main"</span></span>
  <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>5<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rt</span> <span class="skolem">y</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> y0 n0 <span class="keyword1"><span class="command">have</span></span> not<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∨</span> <span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> rt <span class="main">=</span> rt<span class="main">[</span><span class="operator">unfolded</span> root_newton_int_main.simps<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">y</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main"><span class="main">]</span></span> not<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> if_False<span class="main">,</span> <span class="operator">folded</span> y'_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> y'_def<span class="main">,</span> <span class="operator">OF</span> not<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ _ y'0 n0<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> yyn <span class="main">=</span> this
    <span class="keyword1"><span class="command">with</span></span> rt <span class="keyword1"><span class="command">have</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?rt</span> <span class="skolem">y'</span> <span class="skolem">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≤</span> <span class="skolem">y'</span> <span class="main">^</span> <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main"><span class="main">[</span></span><span class="operator">OF</span> False True rt<span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> rt <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_newton_int_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">y'</span></span> <span class="quoted"><span class="skolem">n</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> n0 y'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> yyn <span class="keyword1"><span class="command">have</span></span> yyn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span><span class="main">^</span><span class="free">p</span> <span class="main">&gt;</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> yyn'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="skolem">y'</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">assume</span></span> pm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pm</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y'</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y'_def p pm <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">with</span></span> yyn' <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> p pm <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">hence</span></span> pm0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">pm</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
        <span class="keyword3"><span class="command">case</span></span> True
        <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> p
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> False y'0 zero_le_power<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">case</span></span> False <span class="keyword1"><span class="command">note</span></span> n00 <span class="main">=</span> this
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">y</span> <span class="main">::</span> real"</span></span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?n</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">n</span> <span class="main">::</span> real"</span></span>
        <span class="keyword1"><span class="command">from</span></span> yyn n0 <span class="keyword1"><span class="command">have</span></span> y00<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> y00 y0 <span class="keyword1"><span class="command">have</span></span> y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> n0 False <span class="keyword1"><span class="command">have</span></span> n0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">=</span> <span class="var">?y</span> <span class="main">*</span> of_int <span class="free">pm</span>"</span></span>
        <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">NY</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">=</span> <span class="var">?n</span> <span class="main">/</span> <span class="var">?y</span> <span class="main">^</span> <span class="free">pm</span>"</span></span>
        <span class="keyword1"><span class="command">note</span></span> pos_intro <span class="main">=</span> divide_nonneg_pos add_nonneg_nonneg mult_nonneg_nonneg
        <span class="keyword1"><span class="command">have</span></span> NY0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> NY_def <span class="keyword1"><span class="command">using</span></span> y0 n0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> NY_def zero_less_divide_iff zero_less_power<span class="main">)</span>
        <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?ls</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">#</span> replicate <span class="free">pm</span> <span class="var">?y</span>"</span></span>
        <span class="keyword1"><span class="command">have</span></span> prod<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∏:</span>replicate <span class="free">pm</span> <span class="var">?y</span> <span class="main">=</span> <span class="var">?y</span> <span class="main">^</span> <span class="free">pm</span> "</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">pm</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> sum<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∑:</span>replicate <span class="free">pm</span> <span class="var">?y</span> <span class="main">=</span> <span class="skolem">Y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">pm</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> pos_def <span class="keyword1"><span class="command">using</span></span> NY0 y0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="var">?n</span> <span class="main">=</span> gmean <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> gmean_def <span class="keyword1"><span class="command">using</span></span> y0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> p NY_def prod<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> mean <span class="var">?ls</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> CauchysMeanTheorem_Less<span class="main"><span class="main">[</span></span><span class="operator">OF</span> pos het_gt_0I<span class="main"><span class="main">]</span></span><span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">∈</span> set <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">from</span></span> pm0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">∈</span> set <span class="var">?ls</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">&lt;</span> <span class="var">?y</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
            <span class="keyword1"><span class="command">from</span></span> yyn <span class="keyword1"><span class="command">have</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> <span class="var">?y</span> <span class="main">^</span> Suc <span class="free">pm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_less_iff of_int_power<span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">&lt;</span> <span class="var">?y</span> <span class="main">^</span> Suc <span class="free">pm</span> <span class="main">/</span> <span class="var">?y</span> <span class="main">^</span> <span class="free">pm</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> NY_def
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide_strict_right_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> less<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> y0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> y0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">≠</span> <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> real <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mean_def sum p<span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="var">?n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> real <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">=</span> <span class="main">(</span>root <span class="free">p</span> <span class="var">?n</span><span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n0
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv p0 real_root_pow_pos<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> real <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_strict_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> *<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n0 p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> ineq1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> real <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">y</span> <span class="main">^</span> <span class="free">pm</span> <span class="main">+</span> <span class="skolem">y</span> <span class="main">*</span> int <span class="free">pm</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">S</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">=</span> <span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> Y0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y0 <span class="keyword1"><span class="command">unfolding</span></span> Y_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted">"1.prems"</span><span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> mult_nonneg_nonneg of_int_0_le_iff of_nat_0_le_iff<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> S0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> NY0 Y0 <span class="keyword1"><span class="command">unfolding</span></span> S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> p <span class="keyword1"><span class="command">have</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">/</span> <span class="var">?y</span> <span class="main">^</span> <span class="free">pm</span>  <span class="main">&lt;</span> of_int <span class="main">(</span>floor <span class="main">(</span><span class="var">?n</span> <span class="main">/</span> <span class="var">?y</span><span class="main">^</span><span class="free">pm</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> divide_less_floor1<span class="main">)</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"floor <span class="main">(</span><span class="var">?n</span> <span class="main">/</span> <span class="var">?y</span> <span class="main">^</span> <span class="free">pm</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">y</span><span class="main">^</span><span class="free">pm</span>"</span></span>
            <span class="keyword1"><span class="command">unfolding</span></span> div_is_floor_divide_real <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_power<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">NY</span> <span class="main">&lt;</span> of_int <span class="main">(</span><span class="skolem">n</span> <span class="keyword1">div</span> <span class="skolem">y</span> <span class="main">^</span> <span class="free">pm</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> NY_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> less<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">&lt;</span> of_int <span class="skolem">s</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def s_def S_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">{</span></span> <span class="comment1">(* by sledgehammer *)</span>
            <span class="keyword1"><span class="command">have</span></span> f1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> rat_of_int <span class="main">⌊</span>rat_of_nat <span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">⌋</span> <span class="main">=</span> rat_of_nat <span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> of_int_of_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> f2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">.</span> real_of_int <span class="main">⌊</span>rat_of_nat <span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span><span class="main">⌋</span> <span class="main">=</span> real <span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> of_int_of_nat_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">have</span></span> f3<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">.</span> <span class="main">⌊</span>rat_of_int <span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">/</span> rat_of_int <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⌋</span> <span class="main">=</span> <span class="main">⌊</span>real_of_int <span class="bound">x<span class="hidden">⇩</span><sub>0</sub></span> <span class="main">/</span> real_of_int <span class="bound">x<span class="hidden">⇩</span><sub>1</sub></span><span class="main">⌋</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> div_is_floor_divide_rat div_is_floor_divide_real <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> f4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">⌊</span>rat_of_nat <span class="free">p</span><span class="main">⌋</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">S</span><span class="main">⌋</span> <span class="main">≤</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> less floor_le_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span>rat_of_int <span class="main">⌊</span><span class="skolem">S</span><span class="main">⌋</span> <span class="main">/</span> rat_of_nat <span class="free">p</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">⌊</span>rat_of_int <span class="skolem">s</span> <span class="main">/</span> rat_of_nat <span class="free">p</span><span class="main">⌋</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f1 f3 f4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_is_floor_divide_real zdiv_mono1<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">S</span> <span class="main">/</span> real <span class="free">p</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">⌊</span>rat_of_int <span class="skolem">s</span> <span class="main">/</span> rat_of_nat <span class="free">p</span><span class="main">⌋</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f1 f2 f3 f4 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_is_floor_divide_real floor_div_pos_int<span class="main">)</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">/</span> real <span class="free">p</span> <span class="main">≤</span> real_of_int <span class="main">(</span><span class="skolem">s</span> <span class="keyword1">div</span> int <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> f1 f3 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> div_is_floor_divide_real floor_le_iff floor_of_nat less_eq_real_def<span class="main">)</span>
          <span class="keyword1"><span class="command">}</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">S</span> <span class="main">/</span> real <span class="free">p</span> <span class="main">≤</span> of_int<span class="main">(</span><span class="skolem">s</span> <span class="keyword1">div</span> <span class="free">p</span><span class="main">)</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">note</span></span> this<span class="main">[</span><span class="operator">unfolded</span> S_def s_def<span class="main">]</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">hence</span></span> ge<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">y'</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≥</span> <span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y'_def
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
        <span class="keyword1"><span class="command">have</span></span> pos1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> Y_def NY_def
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">intro</span> divide_nonneg_pos add_nonneg_nonneg mult_nonneg_nonneg<span class="main"><span class="keyword3">,</span></span>
          <span class="operator">insert</span> y0 n0 p0<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> pos2<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">y'</span> <span class="main">+</span> <span class="main">(</span><span class="main">1</span> <span class="main">::</span> rat<span class="main">)</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y'0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> ineq2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>of_int <span class="skolem">y'</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="main">(</span><span class="main">(</span><span class="skolem">NY</span> <span class="main">+</span> <span class="skolem">Y</span><span class="main">)</span> <span class="main">/</span> <span class="free">p</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_mono<span class="main"><span class="main">[</span></span><span class="operator">OF</span> ge pos1<span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> order.strict_trans2<span class="main">[</span><span class="operator">OF</span> ineq1 ineq2<span class="main">]</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?n</span> <span class="main">&lt;</span> of_int <span class="main">(</span><span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_1 of_int_add of_int_power<span class="main">)</span>
        <span class="keyword3"><span class="command">thus</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> of_int_less_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> rt <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">with</span></span> 1<span class="main">(</span>2<span class="main">)</span> True <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> n x <span class="keyword1"><span class="command">using</span></span> y0 <span class="keyword1"><span class="command">unfolding</span></span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> add_le_less_mono add_less_cancel_left lessI less_add_one add.right_neutral le_iff_add power_strict_mono<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_main'_upper"><span class="command">lemma</span></span> root_main'_upper<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≥</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> root_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_newton_int_main_upper<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">b</span></span><span class="main">]</span> root_main'<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we can prove all the nice properties of <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> root_int_main<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_main_all"><span class="command">lemma</span></span> root_int_main_all<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">n</span> <span class="main">∧</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="free">p</span><span class="main">)</span>
    <span class="main">∧</span> <span class="main">(</span><span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟶</span> <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟶</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> rm<span class="main">[</span><span class="operator">unfolded</span> root_int_main_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">=</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True y b <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> p_0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> rm<span class="main">[</span><span class="operator">unfolded</span> root_int_main_def this Let_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main' <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span>int <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>int <span class="free">p</span><span class="main">)</span> <span class="main">(</span>start_value <span class="free">n</span> <span class="free">p</span><span class="main">)</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> start_value<span class="main">[</span><span class="operator">OF</span> n p_0<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> start<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≤</span> <span class="main">(</span>start_value <span class="free">n</span> <span class="free">p</span><span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> start_value <span class="free">n</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> fixed_root <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> False<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> root_main'_pos<span class="main">[</span><span class="operator">OF</span> start<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n rm<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> root_main'_sound<span class="main">[</span><span class="operator">OF</span> start<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n rm<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> root_main'_lower<span class="main">[</span><span class="operator">OF</span> start<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> n rm<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">from</span></span> root_main'_upper<span class="main">[</span><span class="operator">OF</span> start n rm<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">assume</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> low up <span class="keyword1"><span class="command">have</span></span> low<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> up<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span><span class="main">+</span><span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> power_strict_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span><span class="main">,</span> <span class="operator">OF</span> _ x p_0<span class="main">]</span> low <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> power_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> y up <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
    <span class="keyword1"><span class="command">from</span></span> x y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="free">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> b n
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> b low up y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_main"><span class="command">lemma</span></span> root_int_main<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">^</span><span class="free">p</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">n</span> <span class="main">⟹</span> <span class="free">y</span> <span class="main">=</span> <span class="free">x</span> <span class="main">∧</span> <span class="free">b</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_main_all<span class="main">[</span><span class="operator">OF</span> n rm<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int"><span class="command">lemma</span></span> root_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>root_int <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span> <span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> root_int_def True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword2"><span class="keyword">and</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> root_int_def p if_False Let_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">using</span></span> p0 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="free">p</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">hence</span></span> left<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>root_int <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">{</span></span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
        <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
        <span class="keyword1"><span class="command">with</span></span> True <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">hence</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">presburger</span>
      <span class="keyword1"><span class="command">}</span></span>
      <span class="keyword1"><span class="command">with</span></span> left <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">with</span></span> x p <span class="keyword1"><span class="command">have</span></span> cond<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="free">p</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> rt<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> rm <span class="main">=</span> root_int_main<span class="main">[</span><span class="operator">OF</span> this rt<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?thesis</span> <span class="main">=</span>
        <span class="main">(</span>set <span class="main">(</span><span class="keyword1">case</span> root_int_main <span class="free">p</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> even <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="main">-</span> <span class="bound">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span>sgn <span class="free">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span> <span class="main">=</span>
        <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d cond <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> root_int_main <span class="free">p</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> True<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> even <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span> <span class="main">-</span> <span class="bound">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span>sgn <span class="free">x</span> <span class="main">*</span> <span class="bound">y</span><span class="main">]</span> <span class="main">|</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span> False<span class="main">)</span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span>
        <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> <span class="keyword1">if</span> even <span class="free">p</span> <span class="keyword1">then</span> <span class="main">[</span><span class="skolem">y</span><span class="main">,</span> <span class="main">-</span> <span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span>sgn <span class="free">x</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[]</span><span class="main">)</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?lhs</span>"</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> rt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="var">?lhs</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="main">(</span><span class="keyword2"><span class="keyword">is</span></span> <span class="quoted"><span class="quoted">"<span class="main">_</span> <span class="main">=</span> <span class="var">?rhs</span>"</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
          <span class="keyword3"><span class="command">assume</span></span> idx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>abs <span class="skolem">z</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> abs <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> power_abs<span class="main">)</span>
          <span class="keyword1"><span class="command">from</span></span> idx x p0 <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">y</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">¦</span><span class="skolem">z</span><span class="main">¦</span><span class="main">,</span> True<span class="main">)</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> rm<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p0 _ eq<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> abs <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="var">?lhs</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> z <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> idx<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">&lt;</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">moreover</span></span>
        <span class="keyword1"><span class="command">{</span></span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">z</span>
          <span class="keyword3"><span class="command">assume</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="var">?lhs</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
          <span class="keyword1"><span class="command">note</span></span> z <span class="main">=</span> z<span class="main">[</span><span class="operator">unfolded</span> b if_True<span class="main">]</span>
          <span class="keyword1"><span class="command">from</span></span> rm<span class="main">(</span>2<span class="main">)</span> b <span class="keyword1"><span class="command">have</span></span> yx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">from</span></span> rm<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
          <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span> <span class="main">∨</span> even <span class="free">p</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span>
            <span class="keyword3"><span class="command">assume</span></span> odd<span class="main">:</span> <span class="quoted"><span class="quoted">"odd <span class="free">p</span>"</span></span>
            <span class="keyword1"><span class="command">with</span></span> z <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> sgn <span class="free">x</span> <span class="main">*</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>sgn <span class="free">x</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sgn <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sgn <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">*</span> abs <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> yx <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sgn <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> sgn <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x odd <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sgn <span class="free">x</span> <span class="main">*</span> abs <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mult_sgn_abs<span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">next</span></span>
            <span class="keyword3"><span class="command">assume</span></span> even<span class="main">:</span> <span class="quoted"><span class="quoted">"even <span class="free">p</span> <span class="main">∧</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
            <span class="keyword1"><span class="command">from</span></span> z even <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">z</span> <span class="main">=</span> <span class="main">-</span><span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">with</span></span> yx x even <span class="keyword1"><span class="command">have</span></span> z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p0 <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">(</span>sgn <span class="skolem">z</span> <span class="main">*</span> abs <span class="skolem">z</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mult_sgn_abs<span class="main">)</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sgn <span class="skolem">z</span> <span class="main">*</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> id <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">(</span>sgn <span class="skolem">z</span><span class="main">)</span><span class="main">^</span><span class="free">p</span> <span class="main">*</span> <span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> power_mult_distrib  <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> sgn <span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span> <span class="main">*</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> yx <span class="keyword1"><span class="command">using</span></span> even <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
            <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sgn <span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> even z <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
            <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="var">?rhs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">}</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_pos"><span class="command">lemma</span></span> root_int_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> abs<span class="main">:</span> <span class="quoted"><span class="quoted">"abs <span class="free">x</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> ri <span class="main">=</span> ri<span class="main">[</span><span class="operator">unfolded</span> root_int_def Let_def abs<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> ri <span class="keyword1"><span class="command">have</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">p</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> ri <span class="main">=</span> ri<span class="main">[</span><span class="operator">unfolded</span> p if_False<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> ri <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">=</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="main">∧</span> even <span class="free">p</span><span class="main">)</span> <span class="main">=</span> False"</span></span> <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> ri <span class="main">=</span> ri<span class="main">[</span><span class="operator">unfolded</span> this if_False<span class="main">]</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> r<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y'</span><span class="main">,</span><span class="skolem">b'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">note</span></span> ri <span class="main">=</span> ri<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">y</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> even <span class="free">p</span> <span class="keyword1">then</span> <span class="skolem">y'</span> <span class="keyword1">else</span> sgn <span class="free">x</span> <span class="main">*</span> <span class="skolem">y'</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b'</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> root_int_main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x r<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> y'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">y'</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> y <span class="keyword1"><span class="command">using</span></span> x False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Floor and ceiling of roots›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Using the bounds for <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> root_int_main<span class="antiquote"><span class="antiquote">}</span></span></span></span> we can easily design
  algorithms which compute <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"floor <span class="main"><span class="main">(</span></span>root <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ceiling <span class="main"><span class="main">(</span></span>root <span class="free"><span class="free">p</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  To this end, we first develop algorithms for non-negative <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">x</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, and later on
  these are used for the general case.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">root_int_floor_pos</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> fst <span class="main">(</span>root_int_main <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">root_int_ceiling_pos</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> root_int_main <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_floor_pos_lower"><span class="command">lemma</span></span> root_int_floor_pos_lower<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_int_floor_pos <span class="free">p</span> <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_main<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> p0 <span class="keyword1"><span class="command">unfolding</span></span> root_int_floor_pos_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="NthRoot_Impl-root_int_floor_pos_pos"><span class="command">lemma</span></span> root_int_floor_pos_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_int_floor_pos <span class="free">p</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_int_floor_pos_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="NthRoot_Impl-root_int_floor_pos_upper"><span class="command">lemma</span></span> root_int_floor_pos_upper<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>root_int_floor_pos <span class="free">p</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_main<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> p0 <span class="keyword1"><span class="command">unfolding</span></span> root_int_floor_pos_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="NthRoot_Impl-root_int_floor_pos"><span class="command">lemma</span></span> root_int_floor_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_int_floor_pos <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> floor <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_int_floor_pos_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s1</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span>root_int_floor_pos <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s2</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> s1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_0_le_iff root_int_floor_pos_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> s2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s2</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_0_le_iff real_root_pos_pos_le<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> s1 <span class="keyword1"><span class="command">have</span></span> s11<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s2</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> of_int <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p of_int_0_le_iff real_root_pow_pos2<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> floor_unique<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s1</span> <span class="main">≤</span> <span class="var">?s2</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> compare_pow_le_iff<span class="main">[</span><span class="operator">OF</span> p s1 s2<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> id
      <span class="keyword1"><span class="command">using</span></span> root_int_floor_pos_lower<span class="main">[</span><span class="operator">OF</span> False x<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_le_iff of_int_power<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?s2</span> <span class="main">&lt;</span> <span class="var">?s1</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> compare_pow_less_iff<span class="main">[</span><span class="operator">OF</span> p s2 s11<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> id
      <span class="keyword1"><span class="command">using</span></span> root_int_floor_pos_upper<span class="main">[</span><span class="operator">OF</span> False x<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_add of_int_less_iff of_int_power of_int_1<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_ceiling_pos"><span class="command">lemma</span></span> root_int_ceiling_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_int_ceiling_pos <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> ceiling <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_int_ceiling_pos_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">hence</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">y</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> rm <span class="main">=</span> root_int_main<span class="main">[</span><span class="operator">OF</span> x s<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> rm <span class="main">=</span> rm<span class="main">(</span>1-2<span class="main">)</span> rm<span class="main">(</span>3-5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> p<span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> rm<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?s</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root_int_ceiling_pos <span class="free">p</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sx</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> root_int_ceiling_pos_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> s d <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> rm<span class="main">(</span>2<span class="main">)</span> True <span class="keyword1"><span class="command">have</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">unfolding</span></span> xy <span class="keyword1"><span class="command">using</span></span> y
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> p real_root_power_cancel<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?s</span> <span class="main">=</span> root_int_floor_pos <span class="free">p</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d root_int_floor_pos_def
      <span class="keyword1"><span class="command">using</span></span> s p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> rm<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">0</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> s <span class="keyword1"><span class="command">unfolding</span></span> root_int_main_def Let_def <span class="keyword1"><span class="command">using</span></span> p
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id root_int_floor_pos<span class="main">[</span><span class="operator">OF</span> x<span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ceiling_unique<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sx</span> <span class="main">≤</span> real_of_int <span class="main">(</span><span class="main">⌊</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_add real_of_int_floor_add_one_ge of_int_1<span class="main">)</span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?l</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">(</span><span class="main">⌊</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">⌋</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
      <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?m</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"real_of_int <span class="main">⌊</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">=</span> <span class="var">?m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="var">?sx</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≤</span> <span class="var">?sx</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> of_int_floor_le<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> neq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">≠</span> <span class="var">?sx</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">=</span> <span class="var">?sx</span>"</span></span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="var">?m</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="var">?sx</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> of_int <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x False
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> p real_root_ge_0_iff real_root_pow_pos2 root_int_floor_pos root_int_floor_pos_pos zero_le_floor zero_less_Suc<span class="main">)</span>
          <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> xs<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">⌊</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">⌋</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> floor_power floor_of_int<span class="main">)</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">⌋</span> <span class="main">∈</span> set <span class="main">(</span>root_int <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
          <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
          <span class="keyword1"><span class="command">with</span></span> s False <span class="quoted"><span class="quoted">‹<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>›</span></span> x x0 <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">unfolding</span></span> root_int_def
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> le neq <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">arith</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="var">?l</span> <span class="main">&lt;</span> <span class="var">?sx</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">root_int_floor</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> root_int_floor_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">-</span> root_int_ceiling_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">root_int_ceiling</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> root_int_ceiling_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="main">-</span> root_int_floor_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">-</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_floor"><span class="command">lemma</span></span> root_int_floor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_floor <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> floor <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> root_int_floor_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> root_int_floor_pos<span class="main">[</span><span class="operator">OF</span> True<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False root_int_ceiling_pos<span class="main">[</span><span class="operator">OF</span> this<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_root_minus ceiling_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_int_ceiling"><span class="command">lemma</span></span> root_int_ceiling<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_ceiling <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> ceiling <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> root_int_ceiling_def
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> root_int_ceiling_pos<span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="main">-</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> False root_int_floor_pos<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> d
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> real_root_minus floor_minus<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Downgrading algorithms to the naturals›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_nat_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_nat_floor</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_floor_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_nat_ceiling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_nat_ceiling</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_ceiling_pos <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span>int <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_nat</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> map nat <span class="main">(</span>take <span class="main">1</span> <span class="main">(</span>root_int <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1" id="NthRoot_Impl-root_nat_floor"><span class="command">lemma</span></span> root_nat_floor <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_nat_floor <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> floor <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>real <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_nat_floor_def <span class="keyword1"><span class="command">using</span></span> root_int_floor_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"int <span class="free">x</span>"</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="NthRoot_Impl-root_nat_floor_lower"><span class="command">lemma</span></span> root_nat_floor_lower<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root_nat_floor <span class="free">p</span> <span class="free">x</span> <span class="main">^</span> <span class="free">p</span> <span class="main">≤</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_floor_pos_lower<span class="main">[</span><span class="operator">OF</span> p0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> root_nat_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="NthRoot_Impl-root_nat_floor_upper"><span class="command">lemma</span></span> root_nat_floor_upper<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>root_nat_floor <span class="free">p</span> <span class="free">x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">^</span> <span class="free">p</span> <span class="main">&gt;</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_floor_pos_upper<span class="main">[</span><span class="operator">OF</span> p0<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> root_nat_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="NthRoot_Impl-root_nat_ceiling"><span class="command">lemma</span></span> root_nat_ceiling <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_nat_ceiling <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> ceiling <span class="main">(</span>root <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> root_nat_ceiling_def <span class="keyword1"><span class="command">using</span></span> root_int_ceiling_pos<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">p</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="NthRoot_Impl-root_nat"><span class="command">lemma</span></span> root_nat<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>root_nat <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>root_nat <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> y <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> root_nat_def<span class="main">]</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">yi</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="free">x</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> nat <span class="skolem">yi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> root_int_pos<span class="main">[</span><span class="operator">OF</span> _ ri<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">yi</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> root_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"int <span class="free">x</span>"</span></span><span class="main">]</span> p0 ri <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">nat</span><span class="main">]</span> yi <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"nat <span class="skolem">yi</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> nat_int nat_power_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> y <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">y</span>
    <span class="keyword3"><span class="command">assume</span></span> yx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"int <span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> int <span class="free">x</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_nat_power<span class="main">)</span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>root_int <span class="free">p</span> <span class="main">(</span>int <span class="free">x</span><span class="main">)</span><span class="main">)</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> root_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"int <span class="free">x</span>"</span></span><span class="main">]</span> p0
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">)</span></span> One_nat_def <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>›</span></span> empty_Collect_eq nat_power_eq_Suc_0_iff<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yi</span></span> <span class="skolem"><span class="skolem">ys</span></span> <span class="keyword2"><span class="keyword">where</span></span> ri<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="main">(</span>int <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">yi</span> <span class="main">#</span> <span class="skolem">ys</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="main">(</span>int <span class="free">x</span><span class="main">)</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> root_int_pos<span class="main">[</span><span class="operator">OF</span> _ this<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> yip<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> root_int<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">p</span></span> <span class="quoted"><span class="quoted">"int <span class="free">x</span>"</span></span><span class="main">,</span> <span class="operator">unfolded</span> ri<span class="main">]</span> p0 <span class="keyword1"><span class="command">have</span></span> yi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">yi</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> int <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> y <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"int <span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">yi</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted">nat</span><span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> nat <span class="skolem">yi</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹<span class="skolem">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span>›</span></span> nat_int nat_power_eq yi yip<span class="main">)</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">hence</span></span> p0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">yy</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> rm<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="free">p</span> <span class="main">(</span>int <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">yy</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
      <span class="keyword1"><span class="command">from</span></span> root_int_main<span class="main">(</span>5<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> _ rm p0 _ y<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">yy</span> <span class="main">=</span> int <span class="skolem">y</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> rm <span class="main">=</span> rm<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
      <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>root_nat <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> root_nat_def p root_int_def <span class="keyword1"><span class="command">using</span></span> p0 p yx
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">moreover</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">assume</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span>
      <span class="keyword1"><span class="command">with</span></span> p0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> y p <span class="keyword1"><span class="command">have</span></span> <span class="quoted">False</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> set <span class="main">(</span>root_nat <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Upgrading algorithms to the rationals›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The main observation to lift everything from the integers to the rationals is the fact, that one
  can reformulate $\frac{a}{b}^{1/p}$ as $\frac{(ab^{p-1})^{1/p}}b$.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_rat_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_rat_floor</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> quotient_of <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> root_int_floor <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span><span class="main">^</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">b</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_rat_ceiling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_rat_ceiling</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="main">-</span> <span class="main">(</span>root_rat_floor <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">(</span><span class="main">-</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">root_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> rat <span class="main">⇒</span> rat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">root_rat</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> quotient_of <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> concat
  <span class="main">(</span>map <span class="main">(</span><span class="main">λ</span> <span class="bound">rb</span><span class="main">.</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">ra</span><span class="main">.</span> of_int <span class="bound">ra</span> <span class="main">/</span> rat_of_int <span class="bound">rb</span><span class="main">)</span> <span class="main">(</span>root_int <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">a</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="main">1</span> <span class="main">(</span>root_int <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="bound">b</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>


<span class="keyword1" id="NthRoot_Impl-root_rat_reform"><span class="command">lemma</span></span> root_rat_reform<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>real_of_rat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> root <span class="free">p</span> <span class="main">(</span>of_int <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> of_int <span class="free">b</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">from</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> real_of_int <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>real_of_rat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> root <span class="free">p</span> <span class="main">(</span><span class="free">a</span> <span class="main">/</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_rat_divide of_rat_of_int_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">/</span> <span class="free">b</span> <span class="main">=</span> <span class="free">a</span> <span class="main">*</span> real_of_int <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">/</span> of_int <span class="free">b</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">p</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">…</span> <span class="main">=</span> root <span class="free">p</span> <span class="main">(</span><span class="free">a</span> <span class="main">*</span> real_of_int <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">/</span> root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">b</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> real_root_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"root <span class="free">p</span> <span class="main">(</span>of_int <span class="free">b</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">=</span> of_int <span class="free">b</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> False b
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> neq0_conv real_root_pow_pos real_root_power<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span> <span class="main">*</span> real_of_int <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> of_int <span class="main">(</span><span class="free">a</span> <span class="main">*</span> <span class="free">b</span> <span class="main">^</span> <span class="main">(</span><span class="free">p</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_mult of_int_power<span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="NthRoot_Impl-root_rat_floor"><span class="command">lemma</span></span> root_rat_floor <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_rat_floor <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> floor <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>of_rat <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> root_rat_floor_def q split root_int_floor
    <span class="keyword1"><span class="command">unfolding</span></span> root_rat_reform<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span> floor_div_pos_int<span class="main">[</span><span class="operator">OF</span> b<span class="main">]</span> <span class="keyword1"><span class="command">..</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="NthRoot_Impl-root_rat_ceiling"><span class="command">lemma</span></span> root_rat_ceiling <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"root_rat_ceiling <span class="free">p</span> <span class="free">x</span> <span class="main">=</span> ceiling <span class="main">(</span>root <span class="free">p</span> <span class="main">(</span>of_rat <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span>
    root_rat_ceiling_def
    ceiling_def
    real_root_minus
    root_rat_floor
    of_rat_minus
    <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1" id="NthRoot_Impl-root_rat"><span class="command">lemma</span></span> root_rat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> p<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">≠</span> <span class="main">0</span> <span class="main">∨</span> <span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>root_rat <span class="free">p</span> <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">p</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">note</span></span> p <span class="main">=</span> this
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> x <span class="main">=</span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> q<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> quotient_of_denom_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> q<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> d <span class="main">=</span> root_rat_def q split set_concat set_map
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span>root_rat <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">note</span></span> mem <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> d<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> mem <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rb</span></span> <span class="skolem"><span class="skolem">xs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rb<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="skolem">b</span> <span class="main">=</span> Cons <span class="skolem">rb</span> <span class="skolem">xs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> mem <span class="main">=</span> mem<span class="main">[</span><span class="operator">unfolded</span> this<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> mem <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ra</span></span> <span class="keyword2"><span class="keyword">where</span></span> ra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ra</span> <span class="main">∈</span> set <span class="main">(</span>root_int <span class="free">p</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> of_int <span class="skolem">ra</span> <span class="main">/</span> of_int <span class="skolem">rb</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="skolem">a</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> rb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">∈</span> set <span class="main">(</span>root_int <span class="free">p</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> ra p <span class="keyword1"><span class="command">have</span></span> rb<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">rb</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ra<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">ra</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> q x ra rb
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> power_divide<span class="main">)</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">moreover</span></span>
  <span class="keyword1"><span class="command">{</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">hence</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> of_int <span class="skolem">a</span> <span class="main">/</span> of_int <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> eq<span class="main">:</span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">q</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> of_int <span class="skolem">a</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> b <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> quo<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="skolem">q</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
    <span class="keyword1"><span class="command">note</span></span> qzn <span class="main">=</span> quotient_of_div<span class="main">[</span><span class="operator">OF</span> quo<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> quotient_of_denom_pos<span class="main">[</span><span class="operator">OF</span> quo<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">from</span></span> eq<span class="main">[</span><span class="operator">unfolded</span> qzn<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="skolem">b</span> <span class="main">*</span> of_int <span class="skolem">z</span><span class="main">^</span><span class="free">p</span> <span class="main">/</span> of_int <span class="skolem">n</span><span class="main">^</span><span class="free">p</span> <span class="main">=</span> of_int <span class="skolem">a</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> power_divide <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> arg_cong<span class="main">[</span><span class="operator">OF</span> this<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span> <span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">*</span> of_int <span class="skolem">n</span><span class="main">^</span><span class="free">p</span>"</span></span><span class="main">]</span> n <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="skolem">b</span> <span class="main">*</span> of_int <span class="skolem">z</span><span class="main">^</span><span class="free">p</span> <span class="main">=</span> of_int <span class="skolem">a</span> <span class="main">*</span> of_int <span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="skolem">b</span> <span class="main">*</span> of_int <span class="skolem">z</span><span class="main">^</span><span class="free">p</span> <span class="main">=</span> rat_of_int <span class="main">(</span><span class="skolem">b</span> <span class="main">*</span> <span class="skolem">z</span><span class="main">^</span><span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_int_mult of_int_power <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"of_int <span class="skolem">a</span> <span class="main">*</span> rat_of_int <span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> of_int <span class="main">(</span><span class="skolem">a</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> of_int_mult of_int_power <span class="keyword1"><span class="command">..</span></span>
    <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">*</span> <span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">b</span> <span class="main">*</span> <span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
    <span class="keyword1"><span class="command">from</span></span> quotient_of_coprime<span class="main">[</span><span class="operator">OF</span> quo<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> cop<span class="main">:</span> <span class="quoted"><span class="quoted">"coprime <span class="main">(</span><span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span> <span class="main">(</span><span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> coprime_crossproduct_int<span class="main">[</span><span class="operator">OF</span> quotient_of_coprime<span class="main"><span class="main">[</span></span><span class="operator">OF</span> q<span class="main"><span class="main">]</span></span> this<span class="main">]</span> arg_cong<span class="main">[</span><span class="operator">OF</span> id<span class="main">,</span> <span class="operator">of</span> <span class="quoted">abs</span><span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span><span class="main">¦</span> <span class="main">=</span> <span class="main">¦</span><span class="skolem">b</span><span class="main">¦</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span> abs_mult<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> n b <span class="keyword1"><span class="command">have</span></span> bnp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> rn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> set <span class="main">(</span>root_int <span class="free">p</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rb</span></span> <span class="skolem"><span class="skolem">rs</span></span> <span class="keyword2"><span class="keyword">where</span></span> rb<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="skolem">b</span> <span class="main">=</span> Cons <span class="skolem">rb</span> <span class="skolem">rs</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int <span class="free">p</span> <span class="skolem">b</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> id<span class="main">[</span><span class="operator">folded</span> bnp<span class="main">]</span> b <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="skolem">z</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">hence</span></span> a<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> set <span class="main">(</span>root_int <span class="free">p</span> <span class="skolem">a</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> p <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> root_int_pos<span class="main">[</span><span class="operator">OF</span> _ rb<span class="main">]</span> b <span class="keyword1"><span class="command">have</span></span> rb0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> root_int<span class="main">[</span><span class="operator">OF</span> disjI1<span class="main"><span class="main">[</span></span><span class="operator">OF</span> p<span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">b</span></span><span class="main">]</span> rb <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> bnp <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">^</span> <span class="free">p</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">^</span> <span class="free">p</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rb</span> <span class="main">=</span> <span class="skolem">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> power_eq_imp_eq_base<span class="main"><span class="main">[</span></span><span class="operator">OF</span> id<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> n rb0 p<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> rb <span class="keyword1"><span class="command">have</span></span> b<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">∈</span> set <span class="main">(</span>take <span class="main">1</span> <span class="main">(</span>root_int <span class="free">p</span> <span class="skolem">b</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> set <span class="main">(</span>root_rat <span class="free">p</span> <span class="free">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> d qzn <span class="keyword1"><span class="command">using</span></span> b a <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">}</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> p <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≠</span> <span class="main">1</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">a</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> True root_rat_def q split root_int_def <span class="keyword1"><span class="command">using</span></span> x
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="Sqrt_Babylonian">
<div class="head">
<h1>Theory Sqrt_Babylonian</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Computing Square Roots using the Babylonian Method
    Author:      René Thiemann       &lt;rene.thiemann@uibk.ac.at&gt;
    Maintainer:  René Thiemann
    License:     LGPL
*)</span>

<span class="comment1">(*
Copyright 2009-2014 René Thiemann

This file is part of IsaFoR/CeTA.

IsaFoR/CeTA is free software: you can redistribute it and/or modify it under the
terms of the GNU Lesser General Public License as published by the Free Software
Foundation, either version 3 of the License, or (at your option) any later
version.

IsaFoR/CeTA is distributed in the hope that it will be useful, but WITHOUT ANY
WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License along
with IsaFoR/CeTA. If not, see &lt;http://www.gnu.org/licenses/&gt;.
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Sqrt_Babylonian
<span class="keyword2"><span class="keyword">imports</span></span> 
  <a href="Sqrt_Babylonian_Auxiliary.html">Sqrt_Babylonian_Auxiliary</a>
  <a href="NthRoot_Impl.html">NthRoot_Impl</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Executable algorithms for square roots›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory provides executable algorithms for computing square-roots of numbers which
  are all based on the Babylonian method (which is also known as Heron's method or Newton's method).
  
  For integers / naturals / rationals precise algorithms are given, i.e., here $sqrt\ x$ delivers
  a list of all integers / naturals / rationals $y$ where $y^2 = x$. 
  To this end, the Babylonian method has been adapted by using integer-divisions.

  In addition to the precise algorithms, we also provide approximation algorithms. One works for 
  arbitrary linear ordered fields, where some number $y$ is computed such that
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"abs<span class="main"><span class="main">(</span></span><span class="free"><span class="free">y</span></span><span class="main"><span class="main">^</span></span><span class="numeral"><span class="numeral">2</span></span> <span class="main"><span class="main">-</span></span> <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span> <span class="main"><span class="main">&lt;</span></span> <span class="free"><span class="free">ε</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>. Moreover, for the naturals, integers, and rationals we provide algorithms to compute
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"floor <span class="main"><span class="main">(</span></span>sqrt <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"ceiling <span class="main"><span class="main">(</span></span>sqrt <span class="free"><span class="free">x</span></span><span class="main"><span class="main">)</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> which are all based
  on the underlying algorithm that is used to compute the precise square-roots on integers, if these 
  exist.

  The major motivation for developing the precise algorithms was given by \ceta{} \cite{CeTA},
  a tool for certifiying termination proofs. Here, non-linear equations of the form
  $(a_1x_1 + \dots a_nx_n)^2 = p$ had to be solved over the integers, where $p$ is a concrete polynomial.
  For example, for the equation $(ax + by)^2 = 4x^2 - 12xy + 9y^2$ one easily figures out that
  $a^2 = 4, b^2 = 9$, and $ab = -6$, which results in a possible solution $a = \sqrt 4 = 2, b = - \sqrt 9 = -3$.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Babylonian method›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
The Babylonian method for computing $\sqrt n$ iteratively computes 
\[
x_{i+1} = \frac{\frac n{x_i} + x_i}2
\]
until $x_i^2 \approx n$. Note that if $x_0^2 \geq n$, then for all $i$ we have both
$x_i^2 \geq n$ and $x_i \geq x_{i+1}$. 
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹The Babylonian method using integer division›</span></span>
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  First, the algorithm is developed for the non-negative integers.
  Here, the division operation $\frac xy$ is replaced by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="keyword1"><span class="keyword1">div</span></span> <span class="free"><span class="free">y</span></span> <span class="main"><span class="main">=</span></span> <span class="main"><span class="main">⌊</span></span>of_int <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">/</span></span> of_int <span class="free"><span class="free">y</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>.
  Note that replacing <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌊</span></span>of_int <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">/</span></span> of_int <span class="free"><span class="free">y</span></span><span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌈</span></span>of_int <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">/</span></span> of_int <span class="free"><span class="free">y</span></span><span class="main"><span class="main">⌉</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> would lead to non-termination
  in the following algorithm.

  We explicititly develop the algorithm on the integers and not on the naturals, as the calculations
  on the integers have been much easier. For example, $y - x + x = y$ on the integers, which would require
  the side-condition $y \geq x$ for the naturals. These conditions will make the reasoning much more tedious---as
  we have experienced in an earlier state of this development where everything was based on naturals.

  Since the elements
  $x_0, x_1, x_2,\dots$ are monotone decreasing, in the main algorithm we abort as soon as $x_i^2 \leq n$.›</span></span>


<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\textbf{Since in the meantime, all of these algorithms have been generalized to arbitrary
  $p$-th roots in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="NthRoot_Impl.html"></a><a href="NthRoot_Impl.html">Sqrt_Babylonian.NthRoot_Impl</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>, we just instantiate the general algorithms by $p = 2$ and then provide 
  specialized code equations which are more efficient than the general purpose algorithms.}›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_int_main'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">⇒</span> int <span class="main">×</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_int_main'</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">=</span> root_int_main' <span class="main">1</span> <span class="main">1</span> <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_main'_code"><span class="command">lemma</span></span> sqrt_int_main'_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_main' <span class="free">x</span> <span class="free">n</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">x2</span> <span class="main">=</span> <span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="keyword1">in</span> <span class="keyword1">if</span> <span class="bound">x2</span> <span class="main">≤</span> <span class="free">n</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="bound">x2</span> <span class="main">=</span> <span class="free">n</span><span class="main">)</span>
    <span class="keyword1">else</span> sqrt_int_main' <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="keyword1">div</span> <span class="free">x</span> <span class="main">+</span> <span class="free">x</span><span class="main">)</span> <span class="keyword1">div</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_main'.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="main">1</span></span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> Let_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_int_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int <span class="main">×</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_int_main</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_main <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_main_code"><span class="command">lemma</span></span> sqrt_int_main_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_main <span class="free">x</span> <span class="main">=</span> sqrt_int_main' <span class="main">(</span>start_value <span class="free">x</span> <span class="numeral">2</span><span class="main">)</span> <span class="free">x</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_int_main_def Let_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_int</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"int <span class="main">⇒</span> int list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_int</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_code"><span class="command">lemma</span></span> sqrt_int_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[]</span> <span class="keyword1">else</span> <span class="keyword1">case</span> sqrt_int_main <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span>True<span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">y</span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">[</span><span class="main">0</span><span class="main">]</span> <span class="keyword1">else</span> <span class="main">[</span><span class="bound">y</span><span class="main">,</span><span class="main">-</span><span class="bound">y</span><span class="main">]</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">interpret</span></span> fixed_root <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="main">1</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"root_int_main <span class="numeral">2</span> <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span><span class="skolem">y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> sqrt_int_def root_int_def Let_def
    <span class="keyword1"><span class="command">using</span></span> root_int_main<span class="main">[</span><span class="operator">OF</span> _ res<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> res
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int"><span class="command">lemma</span></span> sqrt_int<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sqrt_int <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_int_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>


<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_pos"><span class="command">lemma</span></span> sqrt_int_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> res<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int <span class="free">x</span> <span class="main">=</span> Cons <span class="free">s</span> <span class="free">ms</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">note</span></span> res <span class="main">=</span> res<span class="main">[</span><span class="operator">unfolded</span> sqrt_int_code Let_def<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">from</span></span> res <span class="keyword1"><span class="command">have</span></span> x0<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ss</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> call<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_main <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ss</span><span class="main">,</span><span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">from</span></span> res<span class="main">[</span><span class="operator">unfolded</span> call<span class="main">]</span> x0 <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="free">s</span>"</span></span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">b</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">ss</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> root_int_main<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x0 call<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> this sqrt_int_main_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">.</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_int_floor_pos</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_floor_pos <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_floor_pos_code"><span class="command">lemma</span></span> sqrt_int_floor_pos_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_floor_pos <span class="free">x</span> <span class="main">=</span> fst <span class="main">(</span>sqrt_int_main <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_int_floor_pos_def<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_floor_pos"><span class="command">lemma</span></span> sqrt_int_floor_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sqrt_int_floor_pos <span class="free">x</span> <span class="main">=</span> <span class="main">⌊</span> sqrt <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_floor_pos<span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_int_ceiling_pos</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_ceiling_pos <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_ceiling_pos_code"><span class="command">lemma</span></span> sqrt_int_ceiling_pos_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_ceiling_pos <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> sqrt_int_main <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">y</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">b</span> <span class="keyword1">then</span> <span class="bound">y</span> <span class="keyword1">else</span> <span class="bound">y</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> root_int_ceiling_pos_def<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_ceiling_pos"><span class="command">lemma</span></span> sqrt_int_ceiling_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sqrt_int_ceiling_pos <span class="free">x</span> <span class="main">=</span> <span class="main">⌈</span> sqrt <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> root_int_ceiling_pos<span class="main">[</span><span class="operator">OF</span> x<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_int_floor</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_floor <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_floor_code"><span class="command">lemma</span></span> sqrt_int_floor_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_floor <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> sqrt_int_floor_pos <span class="free">x</span> <span class="keyword1">else</span> <span class="main">-</span> sqrt_int_ceiling_pos <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_int_floor_def root_int_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_floor"><span class="command">lemma</span></span> sqrt_int_floor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_floor <span class="free">x</span> <span class="main">=</span> <span class="main">⌊</span> sqrt <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_int_floor_def sqrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_int_ceiling</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_int_ceiling <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_ceiling_code"><span class="command">lemma</span></span> sqrt_int_ceiling_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_ceiling <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">x</span> <span class="main">≥</span> <span class="main">0</span> <span class="keyword1">then</span> sqrt_int_ceiling_pos <span class="free">x</span> <span class="keyword1">else</span> <span class="main">-</span> sqrt_int_floor_pos <span class="main">(</span><span class="main">-</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_int_ceiling_def root_int_ceiling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_ceiling"><span class="command">lemma</span></span> sqrt_int_ceiling<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int_ceiling <span class="free">x</span> <span class="main">=</span> <span class="main">⌈</span> sqrt <span class="main">(</span>of_int <span class="free">x</span><span class="main">)</span> <span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_int_ceiling_def sqrt_def<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_int_ceiling_bound"><span class="command">lemma</span></span> sqrt_int_ceiling_bound<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="free">x</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">≤</span> <span class="main">(</span>sqrt_int_ceiling <span class="free">x</span><span class="main">)</span><span class="main">^</span><span class="numeral">2</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_int_ceiling <span class="keyword1"><span class="command">using</span></span> le_of_int_ceiling sqrt_le_D
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_power_le_of_int_cancel_iff<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Square roots for the naturals›</span></span>


<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_nat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> nat list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_nat</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_nat <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>
 
<span class="keyword1" id="Sqrt_Babylonian-sqrt_nat_code"><span class="command">lemma</span></span> sqrt_nat_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_nat <span class="free">x</span> <span class="main">≡</span> map nat <span class="main">(</span>take <span class="main">1</span> <span class="main">(</span>sqrt_int <span class="main">(</span>int <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_nat_def root_nat_def sqrt_int_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_nat"><span class="command">lemma</span></span> sqrt_nat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sqrt_nat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> 
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_nat_def <span class="keyword1"><span class="command">using</span></span> root_nat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_nat_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_nat_floor</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_nat_floor <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_nat_floor_code"><span class="command">lemma</span></span> sqrt_nat_floor_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_nat_floor <span class="free">x</span> <span class="main">=</span> sqrt_int_floor_pos <span class="main">(</span>int <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_nat_floor_def root_nat_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_nat_floor"><span class="command">lemma</span></span> sqrt_nat_floor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_nat_floor <span class="free">x</span> <span class="main">=</span> <span class="main">⌊</span> sqrt <span class="main">(</span>real <span class="free">x</span><span class="main">)</span> <span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_nat_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_nat_ceiling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_nat_ceiling</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_nat_ceiling <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_nat_ceiling_code"><span class="command">lemma</span></span> sqrt_nat_ceiling_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_nat_ceiling <span class="free">x</span> <span class="main">=</span> sqrt_int_ceiling_pos <span class="main">(</span>int <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_nat_ceiling_def root_nat_ceiling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_nat_ceiling"><span class="command">lemma</span></span> sqrt_nat_ceiling<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_nat_ceiling <span class="free">x</span> <span class="main">=</span> <span class="main">⌈</span> sqrt <span class="main">(</span>real <span class="free">x</span><span class="main">)</span> <span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_nat_ceiling_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Square roots for the rationals›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_rat</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> rat list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_rat</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_rat <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat_code"><span class="command">lemma</span></span> sqrt_rat_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_rat <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> quotient_of <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">z</span><span class="main">,</span><span class="bound">n</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> sqrt_int <span class="bound">n</span> <span class="keyword1">of</span> 
    <span class="main">[]</span> <span class="main">⇒</span> <span class="main">[]</span> 
  <span class="main">|</span> <span class="bound">sn</span> <span class="main">#</span> <span class="bound">xs</span> <span class="main">⇒</span> map <span class="main">(</span><span class="main">λ</span> <span class="bound">sz</span><span class="main">.</span> of_int <span class="bound">sz</span> <span class="main">/</span> of_int <span class="bound">sn</span><span class="main">)</span> <span class="main">(</span>sqrt_int <span class="bound">z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_rat_def root_rat_def q split sqrt_int_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"root_int <span class="numeral">2</span> <span class="skolem">n</span>"</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat"><span class="command">lemma</span></span> sqrt_rat<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sqrt_rat <span class="free">x</span><span class="main">)</span> <span class="main">=</span> <span class="main">{</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_rat_def <span class="keyword1"><span class="command">using</span></span> root_rat<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="numeral">2</span></span> <span class="quoted"><span class="free">x</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> power2_eq_square<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat_pos"><span class="command">lemma</span></span> sqrt_rat_pos<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_rat <span class="free">x</span> <span class="main">=</span> Cons <span class="free">s</span> <span class="free">ms</span>"</span></span> 
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">≥</span> <span class="main">0</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> q<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">z</span><span class="main">,</span><span class="skolem">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">note</span></span> sqrt <span class="main">=</span> sqrt<span class="main">[</span><span class="operator">unfolded</span> sqrt_rat_code q<span class="main">,</span> <span class="operator">simplified</span><span class="main">]</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sz</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sqrt_int <span class="skolem">z</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sn</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sqrt_int <span class="skolem">n</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> q <span class="keyword1"><span class="command">have</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> quotient_of_denom_pos<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sqrt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sz</span></span> <span class="skolem"><span class="skolem">mz</span></span> <span class="keyword2"><span class="keyword">where</span></span> sz<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sz</span> <span class="main">=</span> <span class="skolem">sz</span> <span class="main">#</span> <span class="skolem">mz</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?sn</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sqrt <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">sn</span></span> <span class="skolem"><span class="skolem">mn</span></span> <span class="keyword2"><span class="keyword">where</span></span> sn<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?sn</span> <span class="main">=</span> <span class="skolem">sn</span> <span class="main">#</span> <span class="skolem">mn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="var"><span class="quoted"><span class="var">?sn</span></span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> sqrt_int_pos<span class="main">[</span><span class="operator">OF</span> sz<span class="main">]</span> sqrt_int_pos<span class="main">[</span><span class="operator">OF</span> sn<span class="main">]</span> <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">sz</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">≤</span> <span class="skolem">sn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> sqrt sz sn <span class="keyword1"><span class="command">have</span></span> s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">s</span> <span class="main">=</span> of_int <span class="skolem">sz</span> <span class="main">/</span> of_int <span class="skolem">sn</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> s <span class="keyword1"><span class="command">using</span></span> pos
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> of_int_0_le_iff zero_le_divide_iff<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_rat_floor</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_rat_floor</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_rat_floor <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat_floor_code"><span class="command">lemma</span></span> sqrt_rat_floor_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_rat_floor <span class="free">x</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> quotient_of <span class="free">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">a</span><span class="main">,</span><span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> sqrt_int_floor <span class="main">(</span><span class="bound">a</span> <span class="main">*</span> <span class="bound">b</span><span class="main">)</span> <span class="keyword1">div</span> <span class="bound">b</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_rat_floor_def root_rat_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat_floor"><span class="command">lemma</span></span> sqrt_rat_floor<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_rat_floor <span class="free">x</span> <span class="main">=</span> <span class="main">⌊</span> sqrt <span class="main">(</span>of_rat <span class="free">x</span><span class="main">)</span> <span class="main">⌋</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_rat_floor_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_rat_ceiling</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"rat <span class="main">⇒</span> int"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_rat_ceiling</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> root_rat_ceiling <span class="numeral">2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span>"</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat_ceiling_code"><span class="command">lemma</span></span> sqrt_rat_ceiling_code<span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_rat_ceiling <span class="free">x</span> <span class="main">=</span> <span class="main">-</span> <span class="main">(</span>sqrt_rat_floor <span class="main">(</span><span class="main">-</span><span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_rat_ceiling_def sqrt_rat_floor_def root_rat_ceiling_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_rat_ceiling"><span class="command">lemma</span></span> sqrt_rat_ceiling<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_rat_ceiling <span class="free">x</span> <span class="main">=</span> <span class="main">⌈</span> sqrt <span class="main">(</span>of_rat <span class="free">x</span><span class="main">)</span> <span class="main">⌉</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> sqrt_rat_ceiling_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sqrt_def<span class="main">)</span>

<span class="keyword1" id="Sqrt_Babylonian-sqr_rat_of_int"><span class="command">lemma</span></span> sqr_rat_of_int<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">=</span> rat_of_int <span class="free">i</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span> <span class="bound">j</span> <span class="main">::</span> int<span class="main">.</span> <span class="bound">j</span> <span class="main">*</span> <span class="bound">j</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> mem<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>sqrt_rat <span class="main">(</span>rat_of_int <span class="free">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rat_of_int <span class="free">i</span> <span class="main">≥</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> zero_le_square<span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> *<span class="main">:</span> <span class="quoted"><span class="quoted">"quotient_of <span class="main">(</span>rat_of_int <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span><span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> quotient_of_int<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_int <span class="main">1</span> <span class="main">=</span> <span class="main">[</span><span class="main">1</span><span class="main">,</span><span class="main">-</span><span class="main">1</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">code_simp</span>
  <span class="keyword1"><span class="command">from</span></span> mem sqrt_rat_code * split 1 
  <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> rat_of_int <span class="main">`</span> <span class="main">{</span><span class="bound">y</span><span class="main">.</span> <span class="bound">y</span> <span class="main">*</span> <span class="bound">y</span> <span class="main">=</span> <span class="free">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Approximating square roots›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  The difference to the previous algorithms is that now we abort, once the distance is below
  $\epsilon$.  
  Moreover, here we use standard division and not integer division.
  This part is not yet generalized by <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">theory</span></span> <a href="NthRoot_Impl.html"></a><a href="NthRoot_Impl.html">Sqrt_Babylonian.NthRoot_Impl</a><span class="antiquote"><span class="antiquote">}</span></span></span></span>.

  We first provide the executable version without guard <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="free">x</span></span> <span class="main"><span class="main">&gt;</span></span> <span class="main"><span class="main">0</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> as partial function,
  and afterwards prove termination and soundness for a similar algorithm that is defined within the upcoming
locale.
›</span></span>

<span class="keyword1"><span class="command">partial_function</span></span> <span class="main">(</span>tailrec<span class="main">)</span> <span class="entity">sqrt_approx_main_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> linordered_field <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="main">[</span><span class="operator">code</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">sqrt_approx_main_impl</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free">sqrt_approx_main_impl</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> 
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We setup a locale where we ensure that we have standard assumptions: positive $\epsilon$ and
  positive $n$. We require sort <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">floor_ceiling</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span>, since <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"<span class="main"><span class="main">⌊</span></span> <span class="free"><span class="free">x</span></span> <span class="main"><span class="main">⌋</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is used for the termination
  argument.›</span></span>
<span class="keyword1"><span class="command">locale</span></span> sqrt_approximation <span class="main">=</span> 
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ε</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linordered_field<span class="main">,</span>floor_ceiling<span class="main">}</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> <span class="free">n</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> ε <span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">function</span></span> <span class="entity">sqrt_approx_main</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span> 
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_approx_main</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">*</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">-</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">ε</span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">else</span> <span class="free">sqrt_approx_main</span> 
    <span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">+</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">pat_completeness</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Termination essentially is a proof of convergence. Here, one complication is the fact
  that the limit is not always defined. E.g., if <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">"<span class="tfree"><span class="tfree">'a</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> is <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="quoted">rat</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> then there is no
  square root of 2. Therefore, the error-rate $\frac x{\sqrt n} - 1$ is not expressible. 
  Instead we use the expression $\frac{x^2}n - 1$ as error-rate which
  does not require any square-root operation.›</span></span>
<span class="keyword1"><span class="command">termination</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">er</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">/</span> <span class="free">n</span> <span class="main">-</span> <span class="main">1</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">=</span> <span class="numeral">2</span> <span class="main">*</span> <span class="free">n</span> <span class="main">/</span> <span class="free">ε</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">m</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">x</span> <span class="main">=</span> nat <span class="main">⌊</span> <span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">⌋</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">x</span>
  <span class="keyword1"><span class="command">have</span></span> c<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def <span class="keyword1"><span class="command">using</span></span> n ε <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">(</span>measures <span class="main">[</span><span class="skolem">m</span><span class="main">]</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> 
    <span class="keyword3"><span class="command">assume</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xe<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">ε</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>    
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span><span class="main">,</span><span class="skolem">x</span><span class="main">)</span> <span class="main">∈</span> measures <span class="main">[</span><span class="skolem">m</span><span class="main">]</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> y_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> measures_less<span class="main">)</span>
      <span class="keyword1"><span class="command">from</span></span> n <span class="keyword1"><span class="command">have</span></span> inv_n<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">1</span> <span class="main">/</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> xe <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">n</span> <span class="main">≥</span> <span class="free">ε</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">from</span></span> this<span class="main">[</span><span class="operator">unfolded</span> mult_le_cancel_left_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> inv_n<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="free">ε</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> erxen<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="free">ε</span> <span class="main">/</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> er_def <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> en<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">/</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> ne<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">/</span> <span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> ε n <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> en erxen <span class="keyword1"><span class="command">have</span></span> erx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">have</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">x</span> <span class="main">*</span> <span class="numeral">4</span> <span class="main">+</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">er</span> <span class="skolem">x</span> <span class="main">*</span> <span class="numeral">4</span><span class="main">)</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> erx
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> add_pos_nonneg<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="main">(</span><span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">-</span> <span class="numeral">2</span>  <span class="main">+</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">/</span> <span class="free">n</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> er_def y_def <span class="keyword1"><span class="command">using</span></span> x n
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> er_def <span class="keyword1"><span class="command">using</span></span> x n
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">y</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">*</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="main">(</span><span class="main">1</span> <span class="main">+</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> erx erx pos
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> erx <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> er_y_x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">y</span> <span class="main">≤</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="numeral">4</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">linarith</span>
      <span class="keyword1"><span class="command">from</span></span> erxen <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> c_def mult_le_cancel_left_pos<span class="main">[</span><span class="operator">OF</span> ne<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="skolem">er</span> <span class="skolem">x</span>"</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        <span class="keyword1"><span class="command">using</span></span> n ε <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">hence</span></span> pos<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">⌋</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">⌋</span> <span class="main">≥</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">m</span> <span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">m</span> <span class="skolem">x</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> m_def nat_mono_iff<span class="main">[</span><span class="operator">OF</span> pos<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>      
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">y</span><span class="main">⌋</span> <span class="main">≤</span> <span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="main">(</span><span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="numeral">4</span><span class="main">)</span><span class="main">⌋</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> floor_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">unfold</span> mult_le_cancel_left_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> c<span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> er_y_x<span class="main">)</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">&lt;</span> <span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span> <span class="main">/</span> <span class="numeral">4</span> <span class="main">+</span> <span class="main">1</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> <span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">⌋</span>"</span></span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> floor_mono<span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> pos<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">finally</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">y</span><span class="main">⌋</span> <span class="main">&lt;</span> <span class="main">⌊</span><span class="skolem">c</span> <span class="main">*</span> <span class="skolem">er</span> <span class="skolem">x</span><span class="main">⌋</span>"</span></span> <span class="keyword1"><span class="command">.</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Once termination is proven, it is easy to show equivalence of 
  <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sqrt_approx_main_impl<span class="antiquote"><span class="antiquote">}</span></span></span></span> and <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> sqrt_approx_main<span class="antiquote"><span class="antiquote">}</span></span></span></span>.›</span></span>
<span class="keyword1" id="Sqrt_Babylonian-sqrt_approx_main_impl"><span class="command">lemma</span></span> sqrt_approx_main_impl<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span> <span class="main">⟹</span> sqrt_approx_main_impl <span class="free">ε</span> <span class="free">n</span> <span class="free">x</span> <span class="main">=</span> sqrt_approx_main <span class="free">x</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sqrt_approx_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">hence</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">hence</span></span> nx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">0</span> <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> n <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pos_add_strict<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> simps <span class="main">=</span> sqrt_approx_main_impl.simps<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span> sqrt_approx_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> 
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">ε</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">using</span></span> x <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x False nx<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> simps <span class="keyword1"><span class="command">using</span></span> x False <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Also soundness is not complicated.›</span></span>

<span class="keyword1" id="Sqrt_Babylonian-sqrt_approx_main_sound"><span class="command">lemma</span></span> sqrt_approx_main_sound<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> xx<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">*</span> <span class="free">x</span> <span class="main">&gt;</span> <span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sqrt_approx_main <span class="free">x</span> <span class="main">*</span> sqrt_approx_main <span class="free">x</span> <span class="main">&gt;</span> <span class="free">n</span> <span class="main">∧</span> sqrt_approx_main <span class="free">x</span> <span class="main">*</span> sqrt_approx_main <span class="free">x</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">ε</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> sqrt_approx_main.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>1 <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> 1 <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span>  <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span><span class="main">)</span> <span class="main">=</span> True"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> simp <span class="main">=</span> sqrt_approx_main.simps<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">,</span> <span class="operator">unfolded</span> x if_True<span class="main">]</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="free">ε</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simp <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?y</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">/</span> <span class="skolem">x</span> <span class="main">+</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">/</span> <span class="numeral">2</span>"</span></span>
    <span class="keyword1"><span class="command">from</span></span> False simp <span class="keyword1"><span class="command">have</span></span> simp<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_approx_main <span class="skolem">x</span> <span class="main">=</span> sqrt_approx_main <span class="var">?y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">from</span></span> n x <span class="keyword1"><span class="command">have</span></span> y<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?y</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> pos_add_strict<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> IH <span class="main">=</span> 1<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> False y<span class="main">]</span>
    <span class="keyword1"><span class="command">from</span></span> x <span class="keyword1"><span class="command">have</span></span> x4<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> mult_sign_intros<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> simp
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> IH<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span> <span class="main">&lt;</span> <span class="var">?y</span> <span class="main">*</span> <span class="var">?y</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> mult_less_cancel_left_pos<span class="main">[</span><span class="operator">OF</span> x4<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">n</span></span><span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="var">?y</span> <span class="main">*</span> <span class="var">?y</span><span class="main">)</span> <span class="main">=</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">n</span> <span class="main">+</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">-</span> <span class="free">n</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">from</span></span> mult_pos_pos<span class="main">[</span><span class="operator">OF</span> this this<span class="main">]</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="numeral">4</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="free">n</span> <span class="main">&lt;</span> <span class="numeral">4</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="skolem">x</span> <span class="main">*</span> <span class="main">(</span><span class="var">?y</span> <span class="main">*</span> <span class="var">?y</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> id 
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>   

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It remains to assemble everything into one algorithm.›</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sqrt_approx</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">::</span> <span class="main">{</span>linordered_field<span class="main">,</span>floor_ceiling<span class="main">}</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sqrt_approx</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≡</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="main">&gt;</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">=</span> <span class="main">0</span> <span class="keyword1">then</span> <span class="main">0</span> <span class="keyword1">else</span> <span class="keyword1">let</span> <span class="bound">xpos</span> <span class="main">=</span> abs <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">in</span> sqrt_approx_main_impl <span class="free"><span class="bound"><span class="entity">ε</span></span></span> <span class="bound">xpos</span> <span class="main">(</span><span class="bound">xpos</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">0</span>"</span></span>


<span class="keyword1" id="Sqrt_Babylonian-sqrt_approx"><span class="command">lemma</span></span> sqrt_approx<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> ε<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">ε</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">¦</span>sqrt_approx <span class="free">ε</span> <span class="free">x</span> <span class="main">*</span> sqrt_approx <span class="free">ε</span> <span class="free">x</span> <span class="main">-</span> <span class="main">¦</span><span class="free">x</span><span class="main">¦</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="free">ε</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="main">0</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">with</span></span> ε <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> sqrt_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">¦</span><span class="free">x</span><span class="main">¦</span>"</span></span> 
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sqrti</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sqrt_approx_main_impl <span class="free">ε</span> <span class="var">?x</span> <span class="main">(</span><span class="var">?x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?sqrt</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"sqrt_approximation.sqrt_approx_main <span class="free">ε</span> <span class="var">?x</span> <span class="main">(</span><span class="var">?x</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sqrt</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sqrt</span> <span class="main">=</span> <span class="var">?sqrt</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> False <span class="keyword1"><span class="command">have</span></span> x<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?x</span> <span class="main">+</span> <span class="main">1</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> sqrt_approximation <span class="quoted"><span class="free">ε</span></span> <span class="var"><span class="quoted"><span class="var">?x</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">unfold_locales</span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x ε<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> False ε <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sqrt_approx <span class="free">ε</span> <span class="free">x</span> <span class="main">=</span> <span class="var">?sqrti</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sqrt_approx_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">also</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="var">?sqrti</span> <span class="main">=</span> <span class="var">?sqrt</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sqrt_approx_main_impl<span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span><span class="main">)</span>
  <span class="keyword1"><span class="command">finally</span></span> <span class="keyword1"><span class="command">have</span></span> id<span class="main">:</span> <span class="quoted"><span class="quoted">"sqrt_approx <span class="free">ε</span> <span class="free">x</span> <span class="main">=</span> <span class="skolem">sqrt</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sqrt_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> sqrt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">sqrt</span> <span class="main">*</span> <span class="skolem">sqrt</span> <span class="main">&gt;</span> <span class="var">?x</span> <span class="main">∧</span> <span class="skolem">sqrt</span> <span class="main">*</span> <span class="skolem">sqrt</span> <span class="main">-</span> <span class="var">?x</span> <span class="main">&lt;</span> <span class="free">ε</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> sqrt_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> sqrt_approx_main_sound<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">insert</span> x mult_pos_pos<span class="main"><span class="main">[</span></span><span class="operator">OF</span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> x<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">,</span></span> <span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> <span class="dynamic"><span class="dynamic">field_simps</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> id <span class="keyword1"><span class="command">using</span></span> sqrt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Some tests›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Testing executabity and show that sqrt 2 is irrational›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">::</span> rat<span class="main">.</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">2</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sqrt_rat <span class="numeral">2</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Testing speed›</span></span>
<span class="keyword1"><span class="command">lemma</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="main">(</span><span class="main">∃</span> <span class="bound">i</span> <span class="main">::</span> int<span class="main">.</span> <span class="bound">i</span> <span class="main">*</span> <span class="bound">i</span> <span class="main">=</span> <span class="numeral">1234567890123456789012345678901234567890</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>sqrt_int <span class="numeral">1234567890123456789012345678901234567890</span><span class="main">)</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">eval</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The following test›</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">let</span> <span class="bound">ε</span> <span class="main">=</span> <span class="main">1</span> <span class="main">/</span> <span class="numeral">100000000</span> <span class="main">::</span> rat<span class="main">;</span> <span class="bound">s</span> <span class="main">=</span> sqrt_approx <span class="bound">ε</span> <span class="numeral">2</span> <span class="keyword1">in</span> <span class="main">(</span><span class="bound">s</span><span class="main">,</span> <span class="bound">s</span> <span class="main">*</span> <span class="bound">s</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">,</span> <span class="main">¦</span><span class="bound">s</span> <span class="main">*</span> <span class="bound">s</span> <span class="main">-</span> <span class="numeral">2</span><span class="main">¦</span> <span class="main">&lt;</span> <span class="bound">ε</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹results in (1.4142135623731116, 4.738200762148612e-14, True).›</span></span>
 
<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>