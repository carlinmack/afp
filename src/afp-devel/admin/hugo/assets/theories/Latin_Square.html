<div id="Latin_Square">
<div class="head">
<h1>Theory Latin_Square</h1>
</div>
<pre class="source"><span class="comment1">(*  Title:       Latin Squares
    Author:      Alexander Bentkamp &lt;bentkamp at gmail.com&gt;, 2015
    Maintainer:  Alexander Bentkamp &lt;bentkamp at gmail.com&gt;
*)</span>

<span class="keyword1"><span class="command">theory</span></span> Latin_Square
<span class="keyword2"><span class="keyword">imports</span></span> <a href="../Marriage/Marriage.html">Marriage.Marriage</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
  This theory is about Latin Squares. A Latin Square is a $n \times n$ table filled with
  integers from 1 to n where each number appears exactly once in each row and each column.

  As described in "Das Buch der Beweise" a nice way to describe these squares by a $3 \times n$ matrix.
  Each column of this matrix contains the index of the row r, the index of the column c and the
  number in the cell (r,c). This $3 \times n$ matrix is called orthogonal array ("Zeilenmatrix").

  I thought about different ways to formalize this orthogonal array, and came up with this:
  As the order of the columns in the array does not matter at all and no column can be a
  duplicate of another column, the orthogonal array is in fact a set of 3-tuples. Another
  advantage of formalizing it as a set is that it can easily model partially filled squares.
  For these 3-tuples I decided against 3-lists and against $nat \times nat \times nat$
  (which is really $(nat \times nat) \times nat$) in favor of
  a function from a type with three elements to nat.

  Additionally I use the numbers $0$ to $n-1$ instead of $1$ to $n$ for indexing the rows and columns as
  well as for filling the cells.
›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> latin_type <span class="main">=</span> Row <span class="main">|</span> Col <span class="main">|</span> Num

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹latin\_type is of sort enum, needed for "value" command›</span></span>
<span class="keyword1"><span class="command">instantiation</span></span> latin_type <span class="main">::</span> <span class="quoted">enum</span>
<span class="keyword2"><span class="keyword">begin</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_latin_type</span></span> <span class="main">==</span> <span class="main">[</span>Row<span class="main">,</span> Col<span class="main">,</span> Num<span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_all_latin_type</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">::</span> latin_type <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span> Row <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Col <span class="main">∧</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> Num<span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free"><span class="class_parameter">enum_ex_latin_type</span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">P</span></span></span><span class="main">::</span> latin_type <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">x</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">P</span></span></span> <span class="bound">x</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">instance</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> enum_latin_type_def enum_all_latin_type_def enum_ex_latin_type_def<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">case_tac</span> <span class="quoted"><span class="improper">x</span></span><span class="main"><span class="keyword3">,</span></span><span class="operator">auto</span><span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> latin_type.exhaust<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>


<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹Given a latin\_type t, you might want to reference the other two.
   These are "next t" and "next (next t)":›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">next</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">of</span> Row <span class="main">⇒</span> Col <span class="main">|</span> Col <span class="main">⇒</span> Num <span class="main">|</span> Num <span class="main">⇒</span> Row<span class="main">)</span>"</span></span>

<span class="keyword1" id="Latin_Square-all_types_next_eqiv"><span class="command">lemma</span></span> all_types_next_eqiv<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="main">(</span>next <span class="bound">t</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="free">P</span> <span class="bound">t</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
   <span class="keyword1"><span class="command">using</span></span> next_def latin_type.case latin_type.exhaust <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹We call a column of the orthogonal array a latin\_entry:›</span></span>
<span class="keyword1"><span class="command">type_synonym</span></span> latin_entry <span class="main">=</span> <span class="quoted"><span class="quoted">"latin_type <span class="main">⇒</span> nat"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹This function removes one element of the 3-tupel and returns the other two as a pair:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">without</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"latin_type <span class="main">⇒</span> latin_entry <span class="main">⇒</span> nat <span class="main">×</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">without</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="main">(</span><span class="bound">e</span> <span class="main">(</span>next <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">,</span> <span class="bound">e</span> <span class="main">(</span>next <span class="main">(</span>next <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"without Row <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="numeral">2</span><span class="main">)</span>"</span></span> <span class="comment1">― ‹returns (1,2)›</span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">row_col</span> <span class="main">≡</span> without Num"</span></span> <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹returns row and column of a latin\_entry as a pair.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">col_num</span> <span class="main">≡</span> without Row"</span></span> <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹returns column and number of a latin\_entry as a pair.›</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">num_row</span> <span class="main">≡</span> without Col"</span></span> <span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹returns number and row of a latin\_entry as a pair.›</span></span>

<span class="keyword1"><span class="command">text</span></span><span class="quoted"><span class="plain_text">‹A partial latin square is a square that contains each number at most once in each row and each
   column, but not all cells have to be filled. Equivalently we can say that any two rows of the
   orthogonal array contain each pair of two numbers at most once. This can be expressed using the
   inj\_on predicate:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">partial_latin_square</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"latin_entry set <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">partial_latin_square</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> inj_on <span class="main">(</span>without <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span> <span class="comment1">― ‹numbers are unique in each column (t=Row), numbers are unique in each row (t=Col), rows-column combinations are specified unambiguously (t=Num)›</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">e</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="comment1">― ‹all numbers, column indices and row indices are &lt;n›</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="main">{</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>
<span class="main">}</span> <span class="numeral">2</span>"</span></span> <span class="comment1">― ‹True›</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="main">{</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>
<span class="main">}</span> <span class="numeral">2</span>"</span></span> <span class="comment1">― ‹False, because 1 appears twice in column 0›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Looking at the orthogonal array a latin square is given iff any two rows of the
   orthogonal array contain each pair of two numbers at exactly once:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">latin_square</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"latin_entry set <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">latin_square</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> bij_betw <span class="main">(</span>without <span class="bound">t</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="comment1">(* numbers exactly once in each column (t=Row), numbers exactly once in each row (t=Col), rows-column combinations are specified exactly once (t=Num) *)</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"latin_square <span class="main">{</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>
<span class="main">}</span> <span class="numeral">2</span>"</span></span> <span class="comment1">― ‹True›</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"latin_square <span class="main">{</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>
<span class="main">}</span> <span class="numeral">2</span>"</span></span> <span class="comment1">― ‹False, because 0 appears twice in Col 1 and twice in Row 1›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A latin rectangle is a partial latin square in which the first m rows are filled and the following
   rows are empty:›</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="entity">latin_rect</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"latin_entry set <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">latin_rect</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span>
  partial_latin_square <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="main">∧</span>
  bij_betw row_col <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">)</span> <span class="main">∧</span>
  bij_betw num_row <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">m</span></span></span><span class="main">}</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="main">{</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span>
<span class="main">}</span> <span class="main">1</span> <span class="numeral">2</span>"</span></span> <span class="comment1">― ‹True›</span>

<span class="keyword1"><span class="command">value</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="main">{</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">0</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">0</span><span class="main">)</span><span class="main">,</span>  <span class="main">(</span><span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="keyword1">case</span> <span class="bound">t</span> <span class="keyword1">of</span> Row <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Col <span class="main">⇒</span> <span class="main">1</span> <span class="main">|</span> Num <span class="main">⇒</span> <span class="main">1</span><span class="main">)</span>
<span class="main">}</span> <span class="main">1</span> <span class="numeral">2</span>"</span></span> <span class="comment1">― ‹False›</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹There is another equivalent description of latin rectangles, which is easier to prove:›</span></span>
<span class="keyword1" id="Latin_Square-latin_rect_iff"><span class="command">lemma</span></span> latin_rect_iff<span class="main">:</span>
<span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span><span class="main">*</span><span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">m</span><span class="main">)</span> <span class="main">⟷</span> latin_rect <span class="free">s</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> prems<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">m</span><span class="main">)</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> bij1<span class="main">:</span><span class="quoted"><span class="quoted">"bij_betw row_col <span class="free">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on row_col <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> row_col <span class="main">`</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"row_col <span class="main">`</span> <span class="free">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>row_col <span class="main">`</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems card_image<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹inj_on row_col <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">=</span> row_col <span class="main">`</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_subset_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"row_col <span class="main">`</span> <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> bij2<span class="main">:</span><span class="quoted"><span class="quoted">"bij_betw num_row <span class="free">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on num_row <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> num_row <span class="main">`</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span><span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"num_row <span class="main">`</span> <span class="free">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span>num_row <span class="main">`</span> <span class="free">s</span><span class="main">)</span> <span class="main">=</span> card <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prems card_image<span class="main">[</span><span class="operator">OF</span> <span class="quoted"><span class="quoted">‹inj_on num_row <span class="free">s</span>›</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">=</span> num_row <span class="main">`</span> <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_subset_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"num_row <span class="main">`</span> <span class="free">s</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">unfolding</span></span> bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">from</span></span> prems bij1 bij2 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="free">s</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> prems<span class="main">:</span><span class="quoted"><span class="quoted">"latin_rect <span class="free">s</span> <span class="free">m</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="free">s</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_def prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">s</span> <span class="main">=</span> <span class="free">m</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw row_col <span class="free">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_def prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bij_betw_same_card<span class="main">[</span><span class="operator">of</span> <span class="quoted">row_col</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_def prems <span class="keyword1"><span class="command">using</span></span> atLeast0LessThan bij_betwE <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">n</span> <span class="main">∧</span> partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="free">m</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹A square is a latin square iff it is a partial latin square with all $n^2$ cells filled:›</span></span>
<span class="keyword1" id="Latin_Square-partial_latin_square_full"><span class="command">lemma</span></span> partial_latin_square_full<span class="main">:</span>
<span class="quoted"><span class="quoted">"partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span><span class="main">*</span><span class="free">n</span> <span class="main">⟷</span> latin_square <span class="free">s</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> prem<span class="main">:</span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">(</span>without <span class="bound">t</span><span class="main">)</span> <span class="main">`</span> <span class="free">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t</span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>without <span class="skolem">t</span><span class="main">)</span> <span class="main">`</span> <span class="free">s</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> partial_latin_square_def next_def atLeast0LessThan prem <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="free">n</span> <span class="main">⟹</span> latin_square <span class="free">s</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> latin_square_def <span class="keyword1"><span class="command">using</span></span> partial_latin_square_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_def card_atLeastLessThan card_cartesian_product card_image card_subset_eq diff_zero finite_SigmaI finite_atLeastLessThan<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">assume</span></span> prem<span class="main">:</span><span class="quoted"><span class="quoted">"latin_square <span class="free">s</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw row_col <span class="free">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="free">s</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="main">(</span>without <span class="bound">t</span><span class="main">)</span> <span class="bound">e</span> <span class="main">∈</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prem latin_square_def bij_betwE <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">e</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_square_def all_types_next_eqiv<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span><span class="main">]</span> bij_betwE <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∀</span><span class="bound">t</span><span class="main">.</span> inj_on <span class="main">(</span>without <span class="bound">t</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> prem bij_betw_def latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">from</span></span> 1 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="free">s</span> <span class="free">n</span> <span class="main">∧</span> card <span class="free">s</span> <span class="main">=</span> <span class="free">n</span><span class="main">*</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>  bij_betw_same_card<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Now we prove Lemma 1 from chapter 27 in "Das Buch der Beweise". But first some lemmas, that prove
   very intuitive facts:›</span></span>

<span class="keyword1" id="Latin_Square-bij_restrict"><span class="command">lemma</span></span> bij_restrict<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="free">A</span> <span class="free">B</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">a</span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span> <span class="main">⟷</span> <span class="free">Q</span> <span class="main">(</span><span class="free">f</span> <span class="bound">a</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"bij_betw <span class="free">f</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> inj<span class="main">:</span> <span class="quoted"><span class="quoted">"inj_on <span class="free">f</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inj_onD inj_onI mem_Collect_eq<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> surj1<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span> bij_betwE <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> surj2<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">b</span></span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">}</span> <span class="main">⊆</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">b</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">a</span> <span class="main">=</span> <span class="skolem">b</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span><span class="main">∈</span><span class="free">A</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> bij_betw_inv_into_right bij_betwE bij_betw_inv_into mem_Collect_eq <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">a</span></span><span class="main">∈</span><span class="free">A</span><span class="main">.</span> <span class="free">P</span> <span class="bound">a</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">b</span> <span class="main">∈</span> <span class="main">{</span><span class="bound"><span class="bound">b</span></span> <span class="main">∈</span> <span class="free">B</span><span class="main">.</span> <span class="free">Q</span> <span class="bound">b</span><span class="main">}</span>›</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">with</span></span> inj surj1 surj2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> bij_betw_imageI <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1" id="Latin_Square-cartesian_product_margin1"><span class="command">lemma</span></span> cartesian_product_margin1<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">a</span><span class="main">∈</span><span class="free">A</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="free">A</span><span class="main">×</span><span class="free">B</span><span class="main">.</span> fst <span class="bound">p</span> <span class="main">=</span> <span class="free">a</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="free">a</span><span class="main">}</span><span class="main">×</span><span class="free">B</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> SigmaI assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1" id="Latin_Square-cartesian_product_margin2"><span class="command">lemma</span></span> cartesian_product_margin2<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span><span class="main">∈</span><span class="free">B</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">p</span></span><span class="main">∈</span><span class="free">A</span><span class="main">×</span><span class="free">B</span><span class="main">.</span> snd <span class="bound">p</span> <span class="main">=</span> <span class="free">b</span><span class="main">}</span> <span class="main">=</span> <span class="free">A</span><span class="main">×</span><span class="main">{</span><span class="free">b</span><span class="main">}</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> SigmaI assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The union of sets containing at most k elements each cannot contain more elements than
   the number of sets times k:›</span></span>
<span class="keyword1" id="Latin_Square-limited_family_union"><span class="command">lemma</span></span> limited_family_union<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">B</span> <span class="main">⟹</span> <span class="main">∀</span><span class="bound">P</span><span class="main">∈</span><span class="free">B</span><span class="main">.</span> card <span class="bound">P</span> <span class="main">≤</span> <span class="free">k</span> <span class="main">⟹</span> card <span class="main">(</span><span class="main">⋃</span><span class="free">B</span><span class="main">)</span> <span class="main">≤</span> card <span class="free">B</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">B</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> empty
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">P</span> <span class="skolem">B</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>insert <span class="skolem">P</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">P</span> <span class="main">+</span> card <span class="main">(</span><span class="main">⋃</span><span class="skolem">B</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_le<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="main">(</span>insert <span class="skolem">P</span> <span class="skolem">B</span><span class="main">)</span><span class="main">)</span> <span class="main">≤</span> card <span class="skolem">P</span> <span class="main">+</span> card <span class="skolem">B</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹If f hits each element at most k times, the domain of f can only be k times bigger than the
   image of f:›</span></span>
<span class="keyword1" id="Latin_Square-limited_preimages"><span class="command">lemma</span></span> limited_preimages<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="free">f</span> <span class="main">`</span> <span class="free">D</span><span class="main">.</span> card <span class="main">(</span><span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">D</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="free">D</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">D</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span> "</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?preimages</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">∩</span><span class="free">D</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">D</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">D</span> <span class="main">=</span> <span class="main">⋃</span><span class="var">?preimages</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="var">?preimages</span><span class="main">)</span> <span class="main">≤</span> card <span class="var">?preimages</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> limited_family_union<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="var">?preimages</span>"</span></span> <span class="quoted"><span class="free">k</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?preimages</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">D</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_image_le<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="main">`</span> <span class="free">D</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span><span class="main">∩</span><span class="free">D</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="var">?preimages</span><span class="main">)</span> <span class="main">≤</span> card <span class="main">(</span><span class="free">f</span> <span class="main">`</span> <span class="free">D</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="free">D</span> <span class="main">=</span> <span class="main">⋃</span><span class="var">?preimages</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Let $A_1, \dots, A_n$ be sets with $k&gt;0$ elements each. Any element is only contained in at most $k$ of
   these sets. Then there are more different elements in total than sets $A_i$:›</span></span>
<span class="keyword1" id="Latin_Square-union_limited_replicates"><span class="command">lemma</span></span> union_limited_replicates<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"finite <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> finite <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">k</span><span class="main">&gt;</span><span class="main">0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> card <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span> <span class="main">≥</span> card <span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?pairs</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> card_pairs<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="var">?pairs</span> <span class="main">=</span> card <span class="free">I</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">I</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span>finite_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> empty
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_eq_0_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>insert <span class="skolem">i0</span> <span class="skolem">I</span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">i</span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">i</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">∈</span> <span class="skolem">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span><span class="main">∈</span><span class="free">A</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> insert <span class="skolem">i0</span> <span class="skolem">I</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> insert <span class="skolem">i0</span> <span class="skolem">I</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card  <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="skolem">I</span><span class="main">.</span> <span class="skolem">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> insert <span class="skolem">i0</span> <span class="skolem">I</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">i</span></span> <span class="main">∈</span> <span class="skolem">I</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span><span class="main">]</span> le_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> card_S<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> card <span class="skolem">I</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> card_B<span class="main">:</span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">i0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="skolem">i0</span><span class="main">}</span> <span class="main">=</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> insert <span class="skolem">i0</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">i0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="skolem">i0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">∩</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">i0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="skolem">i0</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert rev_finite_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">I</span> <span class="main">×</span> <span class="main">⋃</span><span class="main">(</span><span class="free">A</span> <span class="main">`</span> <span class="skolem">I</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">i0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="skolem">i0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> insert card_B card.infinite neq0_conv <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> insert <span class="skolem">i0</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">+</span> card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">=</span><span class="skolem">i0</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="skolem">i0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_Un_disjoint<span class="main">)</span>
    <span class="keyword1"><span class="command">with</span></span> card_S card_B <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> insert <span class="skolem">i0</span> <span class="skolem">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">(</span>card <span class="skolem">I</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> insert <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">f</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="skolem">ix</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="skolem">ix</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span> <span class="main">⇒</span> <span class="bound">x</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="skolem">ix</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>

  <span class="keyword1"><span class="command">have</span></span> preimages_le_k<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="var">?pairs</span><span class="main">.</span> card <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="main">-`</span> <span class="main">{</span><span class="bound">x</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?pairs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x0</span> <span class="keyword3"><span class="command">assume</span></span> x0_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x0</span> <span class="main">∈</span> <span class="skolem">f</span> <span class="main">`</span> <span class="var">?pairs</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">f</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">x0</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?pairs</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">x0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">x0</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">x0</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹finite <span class="free">I</span>›</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="skolem">x0</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">x0</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Pair_inject inj_onI<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">i</span><span class="main">.</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="skolem">x0</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">x0</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span><span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span><span class="main">∈</span><span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span> <span class="main">∧</span> <span class="bound">x</span><span class="main">=</span><span class="skolem">x0</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">x0</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?pairs</span><span class="main">)</span> <span class="main">=</span> card  <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">x0</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

    <span class="keyword1"><span class="command">have</span></span><span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">i0</span><span class="main">.</span> <span class="skolem">x0</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i0</span> <span class="main">∧</span> <span class="bound">i0</span><span class="main">∈</span><span class="free">I</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> x0_def f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">i</span></span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="skolem">x0</span><span class="main">∈</span><span class="free">A</span> <span class="bound">i</span><span class="main">}</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">with</span></span> 1 <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="skolem">f</span> <span class="main">-`</span> <span class="main">{</span><span class="skolem">x0</span><span class="main">}</span><span class="main">)</span> <span class="main">∩</span> <span class="var">?pairs</span><span class="main">)</span> <span class="main">≤</span> <span class="free">k</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="var">?pairs</span> <span class="main">≤</span> card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?pairs</span><span class="main">)</span> <span class="main">*</span> <span class="free">k</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">x</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">∈</span> <span class="free">I</span> <span class="main">∧</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="bound">i</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms card_pairs not_finite_existsD <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> limited_preimages<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">f</span></span> <span class="var"><span class="quoted"><span class="var">?pairs</span></span></span> <span class="quoted"><span class="free">k</span></span><span class="main">,</span> <span class="operator">OF</span> preimages_le_k<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="free">I</span>  <span class="main">≤</span> card <span class="main">(</span><span class="skolem">f</span> <span class="main">`</span> <span class="var">?pairs</span><span class="main">)</span> "</span></span> <span class="keyword1"><span class="command">using</span></span> card_pairs assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">f</span> <span class="main">`</span> <span class="var">?pairs</span> <span class="main">=</span> <span class="main">(</span><span class="main">⋃</span><span class="bound">i</span><span class="main">∈</span><span class="free">I</span><span class="main">.</span> <span class="main">(</span><span class="free">A</span> <span class="bound">i</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="main">[</span><span class="operator">abs_def</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> f_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In a $m \times n$ latin rectangle each number appears in m columns:›</span></span>
<span class="keyword1" id="Latin_Square-latin_rect_card_col"><span class="command">lemma</span></span> latin_rect_card_col<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="free">s</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="free">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"bij_betw num_row <span class="free">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> fst <span class="main">(</span>num_row <span class="bound">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw num_row <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_restrict<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> cartesian_product_margin1<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">e</span> Col <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on col_num <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms latin_rect_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> partial_latin_square_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on col_num <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inj_onD inj_onI mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> Col<span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">using</span></span> without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> Col<span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">e</span> Col <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹In a $m \times n$ latin rectangle each column contains m numbers:›</span></span>
<span class="keyword1" id="Latin_Square-latin_rect_card_num"><span class="command">lemma</span></span> latin_rect_card_num<span class="main">:</span>
<span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="free">s</span> <span class="free">m</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">x</span><span class="main">&lt;</span><span class="free">n</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">e</span> Num<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="free">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">e</span></span> <span class="main">∈</span> <span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> 1<span class="main">:</span><span class="quoted"><span class="quoted">"bij_betw row_col <span class="free">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> 2<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span> <span class="main">⟷</span> snd <span class="main">(</span>row_col <span class="bound">e</span><span class="main">)</span> <span class="main">=</span> <span class="free">x</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw row_col <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span><span class="main">×</span><span class="main">{</span><span class="free">x</span><span class="main">}</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> bij_restrict<span class="main">[</span><span class="operator">OF</span> 1 2<span class="main">]</span> cartesian_product_margin2<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">" <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">m</span><span class="main">}</span>"</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_cartesian_product <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> card <span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on col_num <span class="free">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> assms latin_rect_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">m</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> partial_latin_square_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on col_num <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> inj_onD inj_onI mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> Num<span class="main">)</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def <span class="keyword1"><span class="command">using</span></span> without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> Num<span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">e</span></span><span class="main">∈</span><span class="free">s</span><span class="main">.</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span> <span class="main">=</span> <span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="free">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="free">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> subset_antisym<span class="main">)</span> <span class="operator">blast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_image <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹Finally we prove lemma 1 chapter 27 of "Das Buch der Beweise":›</span></span>
<span class="keyword1"><span class="command">theorem</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="free">s</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="free">m</span><span class="main">)</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">m</span><span class="main">≤</span><span class="free">n</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="free">s</span><span class="main">⊆</span><span class="bound">s'</span> <span class="main">∧</span> latin_square <span class="bound">s'</span> <span class="free">n</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span><span class="quoted"><span class="free">s</span></span><span class="main">)</span> <span class="comment1">― ‹induction over the number of empty rows›</span>
  <span class="keyword3"><span class="command">case</span></span> 0
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"bij_betw row_col <span class="skolem">s</span> <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">×</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">s</span> <span class="main">=</span> <span class="free">n</span><span class="main">*</span><span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span>bij_betw_same_card<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">using</span></span> partial_latin_square_full 0 latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">m</span><span class="main">)</span>

  <span class="comment1">― ‹We use the Hall theorem on the sets $A_j$ of numbers that do not occur in column $j$:›</span>
  <span class="keyword1"><span class="command">let</span></span> <span class="var"><span class="quoted"><span class="var">?not_in_column</span></span></span> <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="bound">j</span><span class="main">}</span>"</span></span>

  <span class="comment1">― ‹Proof of the hall condition:›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">J</span></span><span class="main">⊆</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> card <span class="bound">J</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span><span class="main">∈</span><span class="bound">J</span><span class="main">.</span> <span class="var">?not_in_column</span> <span class="bound">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> allI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">J</span> <span class="keyword3"><span class="command">assume</span></span> J_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">J</span><span class="main">⊆</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">J</span><span class="main">.</span> card <span class="main">(</span><span class="var">?not_in_column</span> <span class="bound">j</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j</span> <span class="keyword3"><span class="command">assume</span></span> j_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="skolem">j</span><span class="main">∈</span><span class="skolem">J</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="skolem">j</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> atLeastLessThan_iff Suc latin_rect_def partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="var">?not_in_column</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> card <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> card <span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∈</span> <span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> card_Diff_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">e</span> Num <span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Col <span class="main">=</span> <span class="skolem">j</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card<span class="main">(</span><span class="var">?not_in_column</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_card_num J_def j_def Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j0</span><span class="main">∈</span><span class="skolem">J</span><span class="main">.</span> <span class="main">∀</span><span class="bound">x</span><span class="main">∈</span><span class="var">?not_in_column</span> <span class="bound">j0</span><span class="main">.</span> card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">J</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="bound">j</span><span class="main">}</span> <span class="main">≤</span> Suc <span class="skolem">m</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> ballI<span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j0</span> <span class="skolem">x</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j0</span> <span class="main">∈</span> <span class="skolem">J</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="skolem">j0</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> Suc <span class="skolem">m</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span> <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_card_col <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="skolem">j0</span>›</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span><span class="main">⊆</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_def partial_latin_square_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command"><span class="improper">then</span></span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> card_Diff_subset<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">using</span></span> Suc.prems <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">J</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="bound">j</span><span class="main">}</span> <span class="main">⊆</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span> <span class="main">-</span> <span class="main">{</span><span class="bound">e</span> Col<span class="main">|</span><span class="bound">e</span><span class="main">.</span> <span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span> <span class="main">∧</span> <span class="bound">e</span> Num <span class="main">=</span> <span class="skolem">x</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Diff_mono J_def <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">x</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="skolem">j0</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">{</span><span class="bound"><span class="bound">j</span></span> <span class="main">∈</span> <span class="skolem">J</span><span class="main">.</span> <span class="skolem">x</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="bound">j</span><span class="main">}</span> <span class="main">≤</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> card_mono finite_Diff finite_atLeastLessThan<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">J</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> J_def finite_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">J</span> <span class="main">≤</span> card <span class="main">(</span><span class="main">⋃</span><span class="bound">j</span><span class="main">∈</span><span class="skolem">J</span><span class="main">.</span> <span class="var">?not_in_column</span> <span class="bound">j</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> union_limited_replicates<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">J</span></span> <span class="var"><span class="quoted"><span class="var">?not_in_column</span></span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">m</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹The Hall theorem gives us a system of distinct representatives, which we can use to fill the next row:›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">R</span></span> <span class="keyword2"><span class="keyword">where</span></span> R_def<span class="main">:</span><span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">j</span><span class="main">∈</span><span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">.</span> <span class="skolem">R</span> <span class="bound">j</span> <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="bound">j</span> <span class="main">∧</span> inj_on <span class="skolem">R</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> marriage_HV<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="var">?not_in_column</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>

  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">new_row</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">new_row</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> rec_latin_type <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="bound">j</span> <span class="main">(</span><span class="skolem">R</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> <span class="skolem">s</span> <span class="main">∪</span> <span class="skolem">new_row</span>"</span></span>

  <span class="comment1">― ‹s' is now a latin rect with one more row:›</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"latin_rect <span class="skolem">s'</span> <span class="main">(</span><span class="free">n</span><span class="main">-</span><span class="skolem">m</span><span class="main">)</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="comment1">― ‹We prove all four criteria specified in the lemma latinrectiff:›</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="skolem">m</span> <span class="main">≤</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="skolem">s'</span> <span class="free">n</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>without Col<span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"num_row <span class="skolem">e1</span> <span class="main">=</span> num_row <span class="skolem">e2</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row"</span></span> <span class="keyword1"><span class="command">using</span></span> without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> without_def <span class="quoted"><span class="quoted">‹num_row <span class="skolem">e1</span> <span class="main">=</span> num_row <span class="skolem">e2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">new_row</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">new_row</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">R</span> <span class="main">(</span><span class="skolem">e1</span> Col<span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> Num <span class="main">=</span> <span class="skolem">R</span> <span class="main">(</span><span class="skolem">e2</span> Col<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="main">(</span><span class="skolem">e1</span> Col<span class="main">)</span> <span class="main">=</span> <span class="skolem">R</span> <span class="main">(</span><span class="skolem">e2</span> Col<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Col <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> Col <span class="main">&lt;</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">new_row</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">new_row</span>›</span></span> new_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col"</span></span> <span class="keyword1"><span class="command">using</span></span> R_def inj_on_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>mono_tags<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> atLeast0LessThan lessThan_iff<span class="main">)</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">∈</span><span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span><span class="main">∈</span><span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_def bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹num_row <span class="skolem">e1</span> <span class="main">=</span> num_row <span class="skolem">e2</span>›</span></span> inj_onD<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">=</span><span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_type.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">e1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e2</span> <span class="bound">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>without Row<span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"col_num <span class="skolem">e1</span> <span class="main">=</span> col_num <span class="skolem">e2</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num"</span></span> <span class="keyword1"><span class="command">using</span></span> without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> Num <span class="main">∈</span> <span class="var">?not_in_column</span> <span class="main">(</span><span class="skolem">e2</span> Col<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> R_def new_row_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num›</span></span> <span class="keyword1"><span class="command">using</span></span> s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>›</span></span>  s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">∈</span><span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> Num <span class="main">∉</span> <span class="var">?not_in_column</span> <span class="main">(</span><span class="skolem">e2</span> Col<span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span><span class="main">∈</span><span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on col_num <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc.prems latin_rect_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> partial_latin_square_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹col_num <span class="skolem">e1</span> <span class="main">=</span> col_num <span class="skolem">e2</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s</span>›</span></span> inj_onD<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">=</span><span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_type.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">e1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e2</span> <span class="bound">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span>without Num<span class="main">)</span> <span class="skolem">s'</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e1</span> <span class="skolem">e2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"row_col <span class="skolem">e1</span> <span class="main">=</span> row_col <span class="skolem">e2</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col"</span></span> <span class="keyword1"><span class="command">using</span></span> without_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> without_def <span class="quoted"><span class="quoted">‹row_col <span class="skolem">e1</span> <span class="main">=</span> row_col <span class="skolem">e2</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Col <span class="main">=</span> <span class="skolem">e2</span> Col›</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> <span class="main">∈</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span> <span class="main">∈</span> <span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span> Row <span class="main">=</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Row <span class="main">≠</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">∈</span><span class="skolem">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e2</span><span class="main">∈</span><span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e2</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> <span class="quoted"><span class="quoted">‹<span class="skolem">e1</span> Row <span class="main">=</span> <span class="skolem">e2</span> Row›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span> Num <span class="main">=</span> <span class="skolem">e2</span> Num"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_def bij_betw_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> <span class="quoted"><span class="quoted">‹row_col <span class="skolem">e1</span> <span class="main">=</span> row_col <span class="skolem">e2</span>›</span></span> inj_onD<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e1</span><span class="main">=</span><span class="skolem">e2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_type.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> <span class="skolem">e1</span> <span class="bound">t</span> <span class="main">=</span> <span class="skolem">e2</span> <span class="bound">t</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="skolem">s'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">t</span><span class="main">.</span> <span class="bound">e</span> <span class="bound">t</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> allI<span class="main">)</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span> <span class="skolem">t</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">∈</span><span class="skolem">s'</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="skolem">t</span> <span class="main">&lt;</span> <span class="free">n</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span><span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">∈</span><span class="skolem">new_row</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">t</span></span><span class="main">)</span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">next</span></span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">∉</span><span class="skolem">new_row</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> latin_rect_def partial_latin_square_def Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"partial_latin_square <span class="skolem">s'</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> partial_latin_square_def <span class="keyword1"><span class="command">using</span></span> latin_type.induct<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">t</span><span class="main">.</span> inj_on <span class="main">(</span>without <span class="bound">t</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">s'</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> card_s<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="skolem">s</span> <span class="main">=</span> <span class="free">n</span> <span class="main">*</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_iff Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> card_new_row<span class="main">:</span><span class="quoted"><span class="quoted">"card <span class="skolem">new_row</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> new_row_def
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"inj_on <span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> rec_latin_type <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="bound">j</span> <span class="main">(</span><span class="skolem">R</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="keyword1"><span class="command">unfolding</span></span> inj_on_def
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> impI<span class="main">)</span>
          <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">j1</span> <span class="skolem">j2</span> <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j2</span> <span class="main">∈</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"rec_latin_type <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">j1</span> <span class="main">(</span><span class="skolem">R</span> <span class="skolem">j1</span><span class="main">)</span> <span class="main">=</span> rec_latin_type <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="skolem">j2</span> <span class="main">(</span><span class="skolem">R</span> <span class="skolem">j2</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span>  <span class="quoted"><span class="quoted">"<span class="skolem">j1</span> <span class="main">=</span> <span class="skolem">j2</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> latin_type.rec<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">j1</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">R</span> <span class="skolem">j1</span>"</span></span><span class="main">]</span> latin_type.rec<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j2</span></span> <span class="main">_</span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"card <span class="main">(</span><span class="main">(</span><span class="main">λ</span><span class="bound">j</span><span class="main">.</span> rec_latin_type <span class="main">(</span><span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span><span class="main">)</span> <span class="bound">j</span> <span class="main">(</span><span class="skolem">R</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="main">0</span><span class="main">..&lt;</span><span class="free">n</span><span class="main">}</span><span class="main">)</span> <span class="main">=</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> card_image<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">∩</span> <span class="skolem">new_row</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="skolem">s</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_iff <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span> <span class="main">∈</span> <span class="skolem">new_row</span><span class="main">.</span> <span class="bound">e</span> <span class="main">∉</span> <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">s</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc latin_rect_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> bij_betw_finite finite_SigmaI finite_atLeastLessThan<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">new_row</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> new_row_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"card <span class="skolem">s'</span> <span class="main">=</span> card <span class="skolem">s</span> <span class="main">+</span> card <span class="skolem">new_row</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s'_def card_Un_disjoint <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">with</span></span> card_s card_new_row <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Suc_diff_Suc Suc_le_lessD add.commute mult_Suc_right<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">e</span><span class="main">∈</span><span class="skolem">s'</span><span class="main">.</span> <span class="bound">e</span> Row <span class="main">&lt;</span> <span class="main">(</span><span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ballI<span class="main"><span class="keyword3">;</span></span> <span class="operator">cases</span><span class="main">)</span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">∈</span><span class="skolem">new_row</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc new_row_def R_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">e</span>
      <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">∈</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span><span class="main">∉</span><span class="skolem">new_row</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> Suc <span class="skolem">m</span>"</span></span>  <span class="keyword1"><span class="command">using</span></span> latin_rect_iff Suc  s'_def <span class="quoted"><span class="quoted">‹<span class="skolem">e</span><span class="main">∈</span><span class="skolem">s'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> Row <span class="main">&lt;</span> <span class="free">n</span> <span class="main">-</span> <span class="skolem">m</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span> <span class="keyword1"><span class="command">using</span></span> latin_rect_iff<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="free">n</span><span class="main">-</span><span class="skolem">m</span>"</span></span> <span class="quoted"><span class="free">n</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>

  <span class="comment1">― ‹Finally we use the induction hypothesis:›</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">⊆</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"latin_square <span class="skolem">s''</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">⊆</span> <span class="skolem">s''</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> s'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> <span class="skolem">s</span> <span class="main">⊆</span> <span class="bound">s'</span> <span class="main">∧</span> latin_square <span class="bound">s'</span> <span class="free">n</span>"</span></span> <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹latin_square <span class="skolem">s''</span> <span class="free">n</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>