<div id="Prio_Map_Specs">
<div class="head">
<h1>Theory Prio_Map_Specs</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Priority Map Specifications›</span></span>

<span class="keyword1"><span class="command">theory</span></span> Prio_Map_Specs
<span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Map_Specs.html">HOL-Data_Structures.Map_Specs</a>"</span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="comment1">(*&lt;*)</span>
<span class="comment1">(** TODO/FIXME:
  Duplicated from List_Ins_Del.
  We cannot import this theory, as it has name clashed with AList_Upd_Del!
*)</span>
<span class="keyword1" id="Prio_Map_Specs-sorted_Cons_iff"><span class="command">lemma</span></span> sorted_Cons_iff<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted<span class="main">(</span><span class="free">x</span> <span class="main">#</span> <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">y</span> <span class="main">∈</span> set <span class="free">xs</span><span class="main">.</span> <span class="free">x</span> <span class="main">&lt;</span> <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> sorted <span class="free">xs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sorted_wrt_Cons<span class="main">)</span>

<span class="comment1">(** TODO: Belongs into AList_Upd_Del *)</span>
<span class="keyword1" id="Prio_Map_Specs-sorted_map_of_Some_eq"><span class="command">lemma</span></span> sorted_map_of_Some_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"sorted1 <span class="free">xs</span> <span class="main">⟹</span> map_of <span class="free">xs</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">v</span><span class="main">)</span><span class="main">∈</span>set <span class="free">xs</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">k</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_Cons_iff<span class="main">)</span>

<span class="comment1">(*&gt;*)</span>
  
<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Abstract Data Type›</span></span>
  
<span class="keyword1"><span class="command">locale</span></span> PrioMap <span class="main">=</span> Map <span class="keyword2"><span class="keyword">where</span></span> lookup <span class="main">=</span> <span class="quoted"><span class="free">lookup</span></span> 
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder option"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">getmin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'m</span> <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> map_is_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">is_empty</span> <span class="free">m</span> <span class="main">⟷</span> <span class="free">lookup</span> <span class="free">m</span> <span class="main">=</span> Map.empty"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> map_getmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">getmin</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">invar</span> <span class="free">m</span> <span class="main">⟹</span> <span class="free">lookup</span> <span class="free">m</span> <span class="main">≠</span> Map.empty 
  <span class="main">⟹</span> <span class="free">lookup</span> <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">p</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">p'</span><span class="main">∈</span>ran <span class="main">(</span><span class="free">lookup</span> <span class="free">m</span><span class="main">)</span><span class="main">.</span> <span class="free">p</span><span class="main">≤</span><span class="bound">p'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">lemmas</span></span> prio_map_specs <span class="main">=</span> map_specs map_is_empty 

<span class="keyword1" id="Prio_Map_Specs-map_getminE"><span class="command">lemma</span></span> map_getminE<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">getmin</span> <span class="free">m</span> <span class="main">=</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span><span class="free">p</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">invar</span> <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free">m</span> <span class="main">≠</span> Map.empty"</span></span> 
  <span class="keyword2"><span class="keyword">obtains</span></span> <span class="quoted"><span class="quoted">"<span class="free">lookup</span> <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">p</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">k'</span> <span class="bound">p'</span><span class="main">.</span> <span class="free">lookup</span> <span class="free">m</span> <span class="bound">k'</span> <span class="main">=</span> Some <span class="bound">p'</span> <span class="main">⟶</span> <span class="free">p</span><span class="main">≤</span><span class="bound">p'</span>"</span></span>  
<span class="keyword1"><span class="command">using</span></span> map_getmin<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ran_def<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">is_min2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">::</span>linorder<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">_</span><span class="main">×</span><span class="tfree">'a</span><span class="main">)</span> set <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">is_min2</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">.</span> snd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> snd <span class="bound">y</span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Inorder-Based Specification›</span></span>  
  
<span class="keyword1"><span class="command">locale</span></span> PrioMap_by_Ordered <span class="main">=</span> Map_by_Ordered 
  <span class="keyword2"><span class="keyword">where</span></span> lookup<span class="main">=</span><span class="quoted"><span class="free">lookup</span></span> <span class="keyword2"><span class="keyword">for</span></span> <span class="free">lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder option"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">is_empty</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">getmin</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'a</span><span class="main">×</span><span class="tfree">'b</span>"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inorder_isempty'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">inv</span> <span class="free">t</span><span class="main">;</span> sorted1 <span class="main">(</span><span class="free">inorder</span> <span class="free">t</span><span class="main">)</span><span class="main">⟧</span> 
      <span class="main">⟹</span> <span class="free">is_empty</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">inorder</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inorder_getmin'<span class="main">:</span> 
      <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">inv</span> <span class="free">t</span><span class="main">;</span> sorted1 <span class="main">(</span><span class="free">inorder</span> <span class="free">t</span><span class="main">)</span><span class="main">;</span> <span class="free">inorder</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">getmin</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">⟧</span> 
        <span class="main">⟹</span> is_min2 <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="free">inorder</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1" id="Prio_Map_Specs-inorder_isempty"><span class="command">lemma</span></span> 
  inorder_isempty<span class="main">:</span> <span class="quoted"><span class="quoted">"invar <span class="free">t</span> <span class="main">⟹</span> <span class="free">is_empty</span> <span class="free">t</span> <span class="main">⟷</span> <span class="free">inorder</span> <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> inorder_getmin<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>invar <span class="free">t</span><span class="main">;</span> <span class="free">inorder</span> <span class="free">t</span> <span class="main">≠</span> <span class="main">[]</span><span class="main">;</span> <span class="free">getmin</span> <span class="free">t</span> <span class="main">=</span> <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span><span class="main">⟧</span> 
        <span class="main">⟹</span> is_min2 <span class="main">(</span><span class="free">a</span><span class="main">,</span><span class="free">b</span><span class="main">)</span> <span class="main">(</span>set <span class="main">(</span><span class="free">inorder</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> invar_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inorder_isempty' inorder_getmin'<span class="main">)</span> 

<span class="keyword1" id="Prio_Map_Specs-inorder_lookup_empty_iff"><span class="command">lemma</span></span> inorder_lookup_empty_iff<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"invar <span class="free">m</span> <span class="main">⟹</span> <span class="free">lookup</span> <span class="free">m</span> <span class="main">=</span> Map.empty <span class="main">⟷</span> <span class="free">inorder</span> <span class="free">m</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_lookup<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invar_def<span class="main">)</span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> map_of.elims option.discI<span class="main">)</span>

<span class="keyword1" id="Prio_Map_Specs-inorder_lookup_ran_eq"><span class="command">lemma</span></span> inorder_lookup_ran_eq<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span><span class="free">inv</span> <span class="free">m</span><span class="main">;</span> sorted1 <span class="main">(</span><span class="free">inorder</span> <span class="free">m</span><span class="main">)</span><span class="main">⟧</span> <span class="main">⟹</span> ran <span class="main">(</span><span class="free">lookup</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> snd <span class="main">`</span> set <span class="main">(</span><span class="free">inorder</span> <span class="free">m</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> inorder_lookup<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">m</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> ran_def
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sorted_map_of_Some_eq<span class="main">)</span>

<span class="keyword1"><span class="command">sublocale</span></span> PrioMap <span class="quoted"><span class="free">empty</span></span> <span class="quoted"><span class="free">update</span></span> <span class="quoted"><span class="free">delete</span></span> <span class="quoted">invar</span> <span class="quoted"><span class="free">lookup</span></span> <span class="quoted"><span class="free">is_empty</span></span> <span class="quoted"><span class="free">getmin</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inorder_isempty inorder_lookup_empty_iff<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inorder_getmin<span class="main">)</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def sorted_map_of_Some_eq invar_def inorder_lookup<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> inorder_getmin<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def sorted_map_of_Some_eq inorder_lookup_ran_eq 
                   eq_Min_iff invar_def inorder_lookup<span class="main">)</span> <span class="main"><span class="keyword3">[</span></span><span class="main"><span class="keyword3">]</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span>
  </pre>
</div><div id="PST_General">
<div class="head">
<h1>Theory PST_General</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹General Priority Search Trees›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PST_General
<span class="keyword2"><span class="keyword">imports</span></span> 
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Tree2.html">HOL-Data_Structures.Tree2</a>"</span>
  <a href="#Prio_Map_Specs">Prio_Map_Specs</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹\noindent
  We show how to implement priority maps
  by augmented binary search trees. That is, the basic data structure is some 
  arbitrary binary search tree, e.g.\ a red-black tree, implementing the map 
  from <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'a</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">typ</span></span> <span class="quoted"><span class="tfree"><span class="quoted"><span class="tfree">'b</span></span></span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> by storing pairs <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(k,p)›</span></span></span></span> in each node. At this
  point we need to assume that the keys are also linearly ordered. To 
  implement <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>getmin›</span></span></span></span> efficiently we annotate/augment each node with another pair
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(k',p')›</span></span></span></span>, the intended result of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>getmin›</span></span></span></span> when applied to that subtree. The 
  specification of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>getmin›</span></span></span></span> tells us that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(k',p')›</span></span></span></span> must be in that subtree and
  that <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p'›</span></span></span></span> is the minimal priority in that subtree. Thus the annotation can be 
  computed by passing the <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(k',p')›</span></span></span></span> with the minimal <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>p'›</span></span></span></span> up the tree. We will 
  now make this more precise for balanced binary trees in general.
  
  We assume that our trees are either leaves of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">Leaf</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> or nodes 
  of the form <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Node <span class="free"><span class="free">l</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">kp</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> where <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>l›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>r›</span></span></span></span> are subtrees, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>kp›</span></span></span></span> is 
  the contents of the node (a key-priority pair) and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>b›</span></span></span></span> is some additional 
  balance information (e.g.\ colour, height, size, \dots). Augmented nodes are 
  of the form <span class="antiquoted"><span class="antiquoted"><span class="operator"><span class="operator"><span class="hidden">\&lt;^</span><span class="control">term</span><span class="hidden">&gt;</span></span></span><span class="quoted"><span class="quoted">‹Node <span class="free"><span class="free">l</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">kp</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">b</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">kp'</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>›</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> pstree <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'k</span><span class="main">×</span><span class="tfree">'p</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">×</span> <span class="tfree">'p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> tree"</span></span>
 
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹ 
  The following invariant states that a node annotation is actually a minimal 
  key-priority pair for the node's subtree.
›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invpst</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">,</span><span class="tfree">'c</span><span class="main">)</span> pstree <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">invpst</span> Leaf <span class="main">=</span> True"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">invpst</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mkp</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free">invpst</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">invpst</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>
    <span class="main">∧</span> is_min2 <span class="free"><span class="bound"><span class="entity">mkp</span></span></span> <span class="main">(</span>set <span class="main">(</span>inorder <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">@</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> inorder <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹The implementation of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>getmin›</span></span></span></span> is trivial:›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pst_getmin</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">pst_getmin</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>"</span></span>

<span class="keyword1" id="PST_General-pst_getmin_ismin"><span class="command">lemma</span></span> pst_getmin_ismin<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"invpst <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">≠</span>Leaf <span class="main">⟹</span> is_min2 <span class="main">(</span>pst_getmin <span class="free">t</span><span class="main">)</span> <span class="main">(</span>set_tree <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pst_getmin.cases<span class="main">)</span> <span class="operator">auto</span>

  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹  
  It remains to upgrade the existing map operations to work with augmented nodes.
  Therefore we now show how to transform any function definition on un-augmented 
  trees into one on trees augmented with <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>(k',p')›</span></span></span></span> pairs. A defining equation
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f pats = e›</span></span></span></span> for the original type of nodes is transformed into an equation
  <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f pats' = e'›</span></span></span></span> on the augmented type of nodes as follows:
  <span class="antiquoted"><span class="antiquoted">▪</span></span> Every pattern <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Node <span class="free"><span class="free">l</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">kp</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pats›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e›</span></span></span></span> is replaced by
    <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Node <span class="free"><span class="free">l</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">kp</span></span><span class="main"><span class="main">,</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">b</span></span><span class="main"><span class="main">,</span></span><span class="free"><span class="free">DUMMY</span></span><span class="main"><span class="main">)</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> to obtain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>pats'›</span></span></span></span> and <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span>.
  <span class="antiquoted"><span class="antiquoted">▪</span></span> To obtain <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e'›</span></span></span></span>, every expression <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">term</span></span> <span class="quoted"><span class="quoted">"Node <span class="free"><span class="free">l</span></span> <span class="main"><span class="main">(</span></span><span class="free"><span class="free">kp</span></span><span class="main"><span class="main">,</span></span> <span class="free"><span class="free">b</span></span><span class="main"><span class="main">)</span></span> <span class="free"><span class="free">r</span></span>"</span></span><span class="antiquote"><span class="antiquote">}</span></span></span></span> in <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>e<span class="hidden">⇩</span><sub>2</sub>›</span></span></span></span> is 
    replaced by <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>mkNode l kp b r›</span></span></span></span> where:
›</span></span>
  
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">min2</span> <span class="main">≡</span> <span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span><span class="bound">p'</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">if</span> <span class="bound">p</span><span class="main">≤</span><span class="bound">p'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span><span class="bound">p</span><span class="main">)</span> <span class="keyword1">else</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span><span class="bound">p'</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">min_kp</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> <span class="keyword1">case</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">of</span>
  <span class="main">(</span>Leaf<span class="main">,</span>Leaf<span class="main">)</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span>
<span class="main">|</span> <span class="main">(</span>Leaf<span class="main">,</span>Node <span class="main"><span class="bound">_</span></span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">kpr</span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> min2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">kpr</span>
<span class="main">|</span> <span class="main">(</span>Node <span class="main"><span class="bound">_</span></span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">kpl</span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span>Leaf<span class="main">)</span> <span class="main">⇒</span> min2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">kpl</span>
<span class="main">|</span> <span class="main">(</span>Node <span class="main"><span class="bound">_</span></span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">kpl</span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">,</span>Node <span class="main"><span class="bound">_</span></span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound">_</span></span><span class="main">,</span><span class="bound">kpr</span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound">_</span></span><span class="main">)</span> <span class="main">⇒</span> min2 <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>min2 <span class="bound">kpl</span> <span class="bound">kpr</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">mkNode</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span>min_kp <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹  
  Note that this transformation does not affect the asymptotic complexity 
  of <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>f›</span></span></span></span>. Therefore the priority search tree operations have the same complexity 
  as the underlying search tree operations, i.e.\ typically logarithmic 
  (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>update›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>delete›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>lookup›</span></span></span></span>) and constant time (<span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>empty›</span></span></span></span>, <span class="antiquoted"><span class="raw_text"><span class="antiquoted"><span class="raw_text"><span class="operator"><span class="operator">‹</span></span>is_empty›</span></span></span></span>).
›</span></span>

<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹It is straightforward to show that <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">const</span></span> mkNode<span class="antiquote"><span class="antiquote">}</span></span></span></span> preserves the invariant:›</span></span> 
  
<span class="keyword1" id="PST_General-is_min2_Empty"><span class="command">lemma</span></span> is_min2_Empty<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>is_min2 <span class="free">x</span> <span class="main">{}</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def<span class="main">)</span>

<span class="keyword1" id="PST_General-is_min2_singleton"><span class="command">lemma</span></span> is_min2_singleton<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"is_min2 <span class="free">a</span> <span class="main">{</span><span class="free">b</span><span class="main">}</span> <span class="main">⟷</span> <span class="free">b</span><span class="main">=</span><span class="free">a</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def<span class="main">)</span>

<span class="keyword1" id="PST_General-is_min2_insert"><span class="command">lemma</span></span> is_min2_insert<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_min2 <span class="free">x</span> <span class="main">(</span>insert <span class="free">y</span> <span class="free">ys</span><span class="main">)</span> 
  <span class="main">⟷</span> <span class="main">(</span><span class="free">y</span><span class="main">=</span><span class="free">x</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="free">ys</span><span class="main">.</span> snd <span class="free">x</span> <span class="main">≤</span> snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>snd <span class="free">x</span> <span class="main">≤</span> snd <span class="free">y</span> <span class="main">∧</span> is_min2 <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def<span class="main">)</span>

<span class="keyword1" id="PST_General-is_min2_union"><span class="command">lemma</span></span> is_min2_union<span class="main">:</span>
  <span class="quoted"><span class="quoted">"is_min2 <span class="free">x</span> <span class="main">(</span><span class="free">ys</span> <span class="main">∪</span> <span class="free">zs</span><span class="main">)</span> 
  <span class="main">⟷</span> <span class="main">(</span>is_min2 <span class="free">x</span> <span class="free">ys</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound">z</span><span class="main">∈</span><span class="free">zs</span><span class="main">.</span> snd <span class="free">x</span> <span class="main">≤</span> snd <span class="bound">z</span><span class="main">)</span><span class="main">)</span> 
    <span class="main">∨</span> <span class="main">(</span><span class="main">(</span><span class="main">∀</span><span class="bound">y</span><span class="main">∈</span><span class="free">ys</span><span class="main">.</span> snd <span class="free">x</span> <span class="main">≤</span> snd <span class="bound">y</span><span class="main">)</span> <span class="main">∧</span> is_min2 <span class="free">x</span> <span class="free">zs</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def<span class="main">)</span>

<span class="keyword1" id="PST_General-is_min2_min2_insI"><span class="command">lemma</span></span> is_min2_min2_insI<span class="main">:</span> <span class="quoted"><span class="quoted">"is_min2 <span class="free">y</span> <span class="free">ys</span> <span class="main">⟹</span> is_min2 <span class="main">(</span>min2 <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span>insert <span class="free">x</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def min2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1" id="PST_General-is_min2_mergeI"><span class="command">lemma</span></span> is_min2_mergeI<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"is_min2 <span class="free">x</span> <span class="free">xs</span> <span class="main">⟹</span> is_min2 <span class="free">y</span> <span class="free">ys</span> <span class="main">⟹</span> is_min2 <span class="main">(</span>min2 <span class="free">x</span> <span class="free">y</span><span class="main">)</span> <span class="main">(</span><span class="free">xs</span> <span class="main">∪</span> <span class="free">ys</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> is_min2_def min2_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.split<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> invpst_mkNode<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="main">(</span>mkNode <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> invpst <span class="free">l</span> <span class="main">∧</span> invpst <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">l</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> invpst.cases<span class="main"><span class="keyword3">;</span></span> 
       <span class="operator">cases</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> invpst.cases<span class="main"><span class="keyword3">;</span></span> 
       <span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkNode_def min_kp_def<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">using</span></span> is_min2_min2_insI <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
 <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> is_min2_min2_insI <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> insert_commute<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">smt</span> Un_insert_left Un_insert_right is_min2_mergeI is_min2_min2_insI 
                sup_assoc<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div><div id="PST_RBT">
<div class="head">
<h1>Theory PST_RBT</h1>
</div>
<pre class="source"><span class="keyword1"><span class="command">section</span></span> <span class="quoted"><span class="plain_text">‹Priority Search Trees on top of RBTs›</span></span>

<span class="keyword1"><span class="command">theory</span></span> PST_RBT
<span class="keyword2"><span class="keyword">imports</span></span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Cmp.html">HOL-Data_Structures.Cmp</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Isin2.html">HOL-Data_Structures.Isin2</a>"</span>
  <span class="quoted">"<a href="https://www.cl.cam.ac.uk/research/hvg/Isabelle/dist/library/HOL/HOL-Data_Structures/Lookup2.html">HOL-Data_Structures.Lookup2</a>"</span>
  <a href="#PST_General">PST_General</a>
<span class="keyword2"><span class="keyword">begin</span></span>
  
<span class="keyword1"><span class="command">text</span></span> <span class="quoted"><span class="plain_text">‹
We obtain a priority search map based on red-black trees via the 
general priority search tree augmentation.

This theory has been derived from the standard Isabelle implementation of red 
black trees in <span class="antiquoted"><span class="antiquoted"><span class="antiquote"><span class="antiquote">@{</span></span><span class="operator"><span class="operator">session</span></span> "HOL-Data_Structures"<span class="antiquote"><span class="antiquote">}</span></span></span></span>.
›</span></span>

<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Definitions›</span></span>

<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹The Code›</span></span>

<span class="keyword1"><span class="command">datatype</span></span> tcolor <span class="main">=</span> Red <span class="main">|</span> Black

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">(</span><span class="tfree">'k</span><span class="main">×</span><span class="tfree">'p</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span>tcolor <span class="main">×</span> <span class="main">(</span><span class="tfree">'k</span> <span class="main">×</span> <span class="tfree">'p</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> tree"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">R</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">R</span> <span class="free"><span class="bound"><span class="entity">mkp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Red<span class="main">,</span><span class="free"><span class="bound"><span class="entity">mkp</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="entity">B</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">B</span> <span class="free"><span class="bound"><span class="entity">mkp</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≡</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> Black<span class="main">,</span><span class="free"><span class="bound"><span class="entity">mkp</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mkR</span> <span class="main">≡</span> mkNode Red"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">mkB</span> <span class="main">≡</span> mkNode Black"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baliL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="tfree">'k</span><span class="main">×</span><span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">baliL</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span> <span class="main">=</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baliL</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span> <span class="main">=</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">baliL</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baliR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="tfree">'k</span><span class="main">×</span><span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth"</span></span> 
  <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">baliR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baliR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a2</span></span></span> <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">a3</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baliR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">paint</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"tcolor <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">paint</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mkp</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">mkp</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baldL</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">×</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">=</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">=</span> baliR <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> 
  <span class="main">=</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">bl</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>baliR <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="main">(</span>paint Red <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baldL</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">baldR</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="tfree">'k</span> <span class="main">×</span> <span class="tfree">'p</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">=</span> baliL <span class="main">(</span>mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span> 
  <span class="main">=</span> mkR <span class="main">(</span>baliL <span class="main">(</span>paint Red <span class="free"><span class="bound"><span class="entity">t1</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">z</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">baldR</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="main">=</span> mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth 
    <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> Leaf <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> Leaf <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="keyword1">of</span>
     R <span class="main"><span class="bound">_</span></span> <span class="bound">u2</span> <span class="bound">b</span> <span class="bound">u3</span> <span class="main">⇒</span> <span class="main">(</span>mkR <span class="main">(</span>mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">u2</span><span class="main">)</span> <span class="bound">b</span> <span class="main">(</span>mkR <span class="bound">u3</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span>
     <span class="bound">t23</span> <span class="main">⇒</span> mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>mkR <span class="bound">t23</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> <span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="keyword1">of</span>
     R <span class="main"><span class="bound">_</span></span> <span class="bound">t2'</span> <span class="bound">b</span> <span class="bound">t3'</span> <span class="main">⇒</span> mkR <span class="main">(</span>mkB <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="bound">t2'</span><span class="main">)</span> <span class="bound">b</span> <span class="main">(</span>mkB <span class="bound">t3'</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span> <span class="main">|</span>
     <span class="bound">t23</span> <span class="main">⇒</span> baldL <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span>mkB <span class="bound">t23</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">t4</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span> <span class="main">=</span> mkR <span class="main">(</span><span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">combine</span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span> <span class="main">=</span> mkR <span class="free"><span class="bound"><span class="entity">t1</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free">combine</span> <span class="free"><span class="bound"><span class="entity">t2</span></span></span> <span class="free"><span class="bound"><span class="entity">t3</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">color</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> tcolor"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">color</span> Leaf <span class="main">=</span> Black"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">color</span> <span class="main">(</span>Node <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="main">(</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">upd</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rbth"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> Leaf <span class="main">=</span> mkR Leaf <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>B <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span>
  LT <span class="main">⇒</span> baliL <span class="main">(</span><span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
  GT <span class="main">⇒</span> baliR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">|</span>
  EQ <span class="main">⇒</span> mkB <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">(</span>R <span class="main"><span class="bound"><span class="entity">_</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span>
  LT <span class="main">⇒</span> mkR <span class="main">(</span><span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
  GT <span class="main">⇒</span> mkR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">upd</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">|</span>
  EQ <span class="main">⇒</span> mkR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">y</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="tfree">'b</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rbth"</span></span> 
<span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">update</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> paint Black <span class="main">(</span>upd <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">fun</span></span> <span class="entity">del</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span>rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span>rbth"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> Leaf <span class="main">=</span> Leaf"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> cmp <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="keyword1">of</span>
     LT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">≠</span> Leaf <span class="main">∧</span> color <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Black
           <span class="keyword1">then</span> baldL <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="keyword1">else</span> mkR <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">|</span>
     GT <span class="main">⇒</span> <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">≠</span> Leaf<span class="main">∧</span> color <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Black
           <span class="keyword1">then</span> baldR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="keyword1">else</span> mkR <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span><span class="free"><span class="bound"><span class="entity">b</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free">del</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">|</span>
  EQ <span class="main">⇒</span> combine <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">delete</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span><span class="main">::</span>linorder <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span><span class="tfree">'b</span><span class="main">)</span> rbth"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">delete</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> paint Black <span class="main">(</span>del <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Invariants›</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">bheight</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">bheight</span> Leaf <span class="main">=</span> <span class="main">0</span>"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">bheight</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Black <span class="keyword1">then</span> <span class="free">bheight</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="keyword1">else</span> <span class="free">bheight</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invc</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">invc</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span><span class="main">,</span><span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">(</span><span class="free">invc</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">invc</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">=</span> Red <span class="main">⟶</span> color <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> Black <span class="main">∧</span> color <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> Black<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invc2</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> bool"</span></span> <span class="comment1">― ‹Weaker version›</span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invc2</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">invc2</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">a</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>invc <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> invc <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">invh</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">)</span> rbth <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">invh</span> Leaf <span class="main">=</span> True"</span></span> <span class="main">|</span>
<span class="quoted"><span class="quoted">"<span class="free">invh</span> <span class="main">(</span>Node <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">,</span> <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="free">invh</span> <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">∧</span> <span class="free">invh</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">∧</span> bheight <span class="free"><span class="bound"><span class="entity">l</span></span></span> <span class="main">=</span> bheight <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">rbt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'k</span><span class="main">,</span><span class="tfree">'p</span><span class="main">::</span>linorder<span class="main">)</span> rbth <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
<span class="quoted"><span class="quoted">"<span class="free">rbt</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span>invc <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> invh <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> invpst <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">∧</span> color <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Black<span class="main">)</span>"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Functional Correctness›</span></span>

<span class="keyword1" id="PST_RBT-inorder_paint"><span class="command">lemma</span></span> inorder_paint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PST_RBT-inorder_mkNode"><span class="command">lemma</span></span> inorder_mkNode<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder <span class="main">(</span>mkNode <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mkNode_def<span class="main">)</span>


<span class="keyword1" id="PST_RBT-inorder_baliL"><span class="command">lemma</span></span> inorder_baliL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>

<span class="keyword1" id="PST_RBT-inorder_baliR"><span class="command">lemma</span></span> inorder_baliR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>


<span class="keyword1" id="PST_RBT-inorder_baldL"><span class="command">lemma</span></span> inorder_baldL<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-inorder_baldR"><span class="command">lemma</span></span> inorder_baldR<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> <span class="free">a</span> <span class="main">#</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-inorder_combine"><span class="command">lemma</span></span> inorder_combine<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"inorder<span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> inorder <span class="free">l</span> <span class="main">@</span> inorder <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> combine.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.split tcolor.split<span class="main">)</span>

<span class="keyword1" id="PST_RBT-inorder_upd"><span class="command">lemma</span></span> inorder_upd<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>upd <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> upd_list <span class="free">x</span> <span class="free">y</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upd.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> upd_list_simps<span class="main">)</span>

<span class="keyword1" id="PST_RBT-inorder_update"><span class="command">lemma</span></span> inorder_update<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>update <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> upd_list <span class="free">x</span> <span class="free">y</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_def inorder_upd<span class="main">)</span>

<span class="keyword1" id="PST_RBT-inorder_del"><span class="command">lemma</span></span> inorder_del<span class="main">:</span>
 <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span>  inorder<span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> del_list_simps<span class="main">)</span>

<span class="keyword1" id="PST_RBT-inorder_delete"><span class="command">lemma</span></span> inorder_delete<span class="main">:</span>
  <span class="quoted"><span class="quoted">"sorted1<span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span> <span class="main">⟹</span> inorder<span class="main">(</span>delete <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> del_list <span class="free">x</span> <span class="main">(</span>inorder <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> delete_def inorder_del<span class="main">)</span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Invariant Preservation›</span></span>

<span class="keyword1" id="PST_RBT-color_paint_Black"><span class="command">lemma</span></span> color_paint_Black<span class="main">:</span> <span class="quoted"><span class="quoted">"color <span class="main">(</span>paint Black <span class="free">t</span><span class="main">)</span> <span class="main">=</span> Black"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">theorem</span></span> rbt_Leaf<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt Leaf"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rbt_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invc2I"><span class="command">lemma</span></span> invc2I<span class="main">:</span> <span class="quoted"><span class="quoted">"invc <span class="free">t</span> <span class="main">⟹</span> invc2 <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> invc.cases<span class="main">)</span> <span class="operator">simp</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1" id="PST_RBT-paint_invc2"><span class="command">lemma</span></span> paint_invc2<span class="main">:</span> <span class="quoted"><span class="quoted">"invc2 <span class="free">t</span> <span class="main">⟹</span> invc2 <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invc_paint_Black"><span class="command">lemma</span></span> invc_paint_Black<span class="main">:</span> <span class="quoted"><span class="quoted">"invc2 <span class="free">t</span> <span class="main">⟹</span> invc <span class="main">(</span>paint Black <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invh_paint"><span class="command">lemma</span></span> invh_paint<span class="main">:</span> <span class="quoted"><span class="quoted">"invh <span class="free">t</span> <span class="main">⟹</span> invh <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invc_mkRB"><span class="command">lemma</span></span> invc_mkRB<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"invc <span class="main">(</span>mkR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> invc <span class="free">l</span> <span class="main">∧</span> invc <span class="free">r</span> <span class="main">∧</span> color <span class="free">l</span> <span class="main">=</span> Black <span class="main">∧</span> color <span class="free">r</span> <span class="main">=</span> Black"</span></span>
  <span class="quoted"><span class="quoted">"invc <span class="main">(</span>mkB <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> invc <span class="free">l</span> <span class="main">∧</span> invc <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-color_mkNode"><span class="command">lemma</span></span> color_mkNode<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"color <span class="main">(</span>mkNode <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> <span class="free">c</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkNode_def<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Update›</span></span>

<span class="keyword1" id="PST_RBT-invc_baliL"><span class="command">lemma</span></span> invc_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>invc2 <span class="free">l</span><span class="main">;</span> invc <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> invc <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invc_baliR"><span class="command">lemma</span></span> invc_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span>invc <span class="free">l</span><span class="main">;</span> invc2 <span class="free">r</span><span class="main">⟧</span> <span class="main">⟹</span> invc <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-bheight_mkRB"><span class="command">lemma</span></span> bheight_mkRB<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"bheight <span class="main">(</span>mkR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>"</span></span>
  <span class="quoted"><span class="quoted">"bheight <span class="main">(</span>mkB <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-bheight_baliL"><span class="command">lemma</span></span> bheight_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟹</span> bheight <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-bheight_baliR"><span class="command">lemma</span></span> bheight_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟹</span> bheight <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>bheight <span class="free">l</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invh_mkNode"><span class="command">lemma</span></span> invh_mkNode<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span>
  <span class="quoted"><span class="quoted">"invh <span class="main">(</span>mkNode <span class="free">c</span> <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">⟷</span> invh <span class="free">l</span> <span class="main">∧</span> invh <span class="free">r</span> <span class="main">∧</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invh_baliL"><span class="command">lemma</span></span> invh_baliL<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invh <span class="free">l</span><span class="main">;</span> invh <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> invh <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invh_baliR"><span class="command">lemma</span></span> invh_baliR<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invh <span class="free">l</span><span class="main">;</span> invh <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> invh <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.induct<span class="main">)</span> <span class="operator">auto</span>


<span class="keyword1" id="PST_RBT-invc_upd"><span class="command">lemma</span></span> invc_upd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invc <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"color <span class="free">t</span> <span class="main">=</span> Black <span class="main">⟹</span> invc <span class="main">(</span>upd <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"invc2 <span class="main">(</span>upd <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upd.induct<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invc_baliL invc_baliR invc2I mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invh_upd"><span class="command">lemma</span></span> invh_upd<span class="main">:</span> <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invh <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"invh <span class="main">(</span>upd <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"bheight <span class="main">(</span>upd <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upd.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invh_baliL invh_baliR bheight_baliL bheight_baliR<span class="main">)</span>


<span class="keyword1" id="PST_RBT-invpst_paint"><span class="command">lemma</span></span> invpst_paint<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="main">(</span>paint <span class="free">c</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> invpst <span class="free">t</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">c</span><span class="main">,</span><span class="free">t</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> paint.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invpst_baliR"><span class="command">lemma</span></span> invpst_baliR<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">l</span> <span class="main">⟹</span> invpst <span class="free">r</span> <span class="main">⟹</span> invpst <span class="main">(</span>baliR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliR.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invpst_baliL"><span class="command">lemma</span></span> invpst_baliL<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">l</span> <span class="main">⟹</span> invpst <span class="free">r</span> <span class="main">⟹</span> invpst <span class="main">(</span>baliL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baliL.cases<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invpst_upd"><span class="command">lemma</span></span> invpst_upd<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">t</span> <span class="main">⟹</span> invpst <span class="main">(</span>upd <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">y</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> upd.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invpst_baliR invpst_baliL<span class="main">)</span>


<span class="keyword1"><span class="command">theorem</span></span> rbt_update<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t</span> <span class="main">⟹</span> rbt <span class="main">(</span>update <span class="free">x</span> <span class="free">y</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invc_upd<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> invh_upd<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> color_paint_Black invc_paint_Black 
  invh_paint rbt_def update_def invpst_upd<span class="main">)</span>


<span class="keyword1"><span class="command">subsubsection</span></span> <span class="quoted"><span class="plain_text">‹Delete›</span></span>

<span class="keyword1" id="PST_RBT-bheight_paint_Red"><span class="command">lemma</span></span> bheight_paint_Red<span class="main">:</span>
  <span class="quoted"><span class="quoted">"color <span class="free">t</span> <span class="main">=</span> Black <span class="main">⟹</span> bheight <span class="main">(</span>paint Red <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">t</span> <span class="main">-</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invh_baldL_invc"><span class="command">lemma</span></span> invh_baldL_invc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invh <span class="free">l</span><span class="main">;</span>  invh <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> bheight <span class="free">r</span><span class="main">;</span>  invc <span class="free">r</span> <span class="main">⟧</span>
   <span class="main">⟹</span> invh <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invh_baliR invh_paint bheight_baliR bheight_paint_Red<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invh_baldL_Black"><span class="command">lemma</span></span> invh_baldL_Black<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invh <span class="free">l</span><span class="main">;</span>  invh <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">+</span> <span class="main">1</span> <span class="main">=</span> bheight <span class="free">r</span><span class="main">;</span>  color <span class="free">r</span> <span class="main">=</span> Black <span class="main">⟧</span>
   <span class="main">⟹</span> invh <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invh_baliR bheight_baliR<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invc_baldL"><span class="command">lemma</span></span> invc_baldL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>invc2 <span class="free">l</span><span class="main">;</span> invc <span class="free">r</span><span class="main">;</span> color <span class="free">r</span> <span class="main">=</span> Black<span class="main">⟧</span> <span class="main">⟹</span> invc <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invc_baliR invc2I mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invc2_baldL"><span class="command">lemma</span></span> invc2_baldL<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invc2 <span class="free">l</span><span class="main">;</span> invc <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span> invc2 <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.induct<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invc_baliR paint_invc2 invc2I mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invh_baldR_invc"><span class="command">lemma</span></span> invh_baldR_invc<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invh <span class="free">l</span><span class="main">;</span>  invh <span class="free">r</span><span class="main">;</span>  bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">+</span> <span class="main">1</span><span class="main">;</span>  invc <span class="free">l</span> <span class="main">⟧</span>
  <span class="main">⟹</span> invh <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invh_baliL bheight_baliL invh_paint bheight_paint_Red<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invc_baldR"><span class="command">lemma</span></span> invc_baldR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span>invc <span class="free">a</span><span class="main">;</span> invc2 <span class="free">b</span><span class="main">;</span> color <span class="free">a</span> <span class="main">=</span> Black<span class="main">⟧</span> <span class="main">⟹</span> invc <span class="main">(</span>baldR <span class="free">a</span> <span class="free">x</span> <span class="free">b</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">b</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invc_baliL mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invc2_baldR"><span class="command">lemma</span></span> invc2_baldR<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invc <span class="free">l</span><span class="main">;</span> invc2 <span class="free">r</span> <span class="main">⟧</span> <span class="main">⟹</span>invc2 <span class="main">(</span>baldR <span class="free">l</span> <span class="free">x</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.induct<span class="main">)</span> 
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invc_baliL paint_invc2 invc2I mkNode_def<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invh_combine"><span class="command">lemma</span></span> invh_combine<span class="main">:</span>
  <span class="quoted"><span class="quoted">"<span class="main">⟦</span> invh <span class="free">l</span><span class="main">;</span> invh <span class="free">r</span><span class="main">;</span> bheight <span class="free">l</span> <span class="main">=</span> bheight <span class="free">r</span> <span class="main">⟧</span>
  <span class="main">⟹</span> invh <span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> bheight <span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> combine.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invh_baldL_Black <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits tcolor.splits<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invc_combine"><span class="command">lemma</span></span> invc_combine<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"invc <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"invc <span class="free">r</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"color <span class="free">l</span> <span class="main">=</span> Black <span class="main">⟹</span> color <span class="free">r</span> <span class="main">=</span> Black <span class="main">⟹</span> invc <span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
         <span class="quoted"><span class="quoted">"invc2 <span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> combine.induct<span class="main">)</span>
   <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invc_baldL invc2I mkNode_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits tcolor.splits<span class="main">)</span>

<span class="keyword1" id="PST_RBT-neq_LeafD"><span class="command">lemma</span></span> neq_LeafD<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≠</span> Leaf <span class="main">⟹</span> <span class="main">∃</span><span class="bound">l</span> <span class="bound">x</span> <span class="bound">c</span> <span class="bound">r</span><span class="main">.</span> <span class="free">t</span> <span class="main">=</span> Node <span class="bound">l</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span><span class="bound">c</span><span class="main">)</span> <span class="bound">r</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-del_invc_invh"><span class="command">lemma</span></span> del_invc_invh<span class="main">:</span> <span class="quoted"><span class="quoted">"invh <span class="free">t</span> <span class="main">⟹</span> invc <span class="free">t</span> <span class="main">⟹</span> invh <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">∧</span>
   <span class="main">(</span>color <span class="free">t</span> <span class="main">=</span> Red <span class="main">∧</span> bheight <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">t</span> <span class="main">∧</span> invc <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">∨</span>
    color <span class="free">t</span> <span class="main">=</span> Black <span class="main">∧</span> bheight <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span> <span class="main">=</span> bheight <span class="free">t</span> <span class="main">-</span> <span class="main">1</span> <span class="main">∧</span> invc2 <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
<span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">x</span> _ <span class="skolem">y</span> _ <span class="skolem">c</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span> <span class="main">∨</span> <span class="skolem">x</span> <span class="main">&gt;</span> <span class="skolem">y</span>"</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">thus</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span> <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">elim</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">simp_all</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> invh_combine invc_combine<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">&lt;</span> <span class="skolem">y</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invh_baldL_invc invc_baldL invc2_baldL mkNode_def 
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> neq_LeafD<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">&lt;</span> <span class="skolem">x</span>"</span></span>
    <span class="keyword1"><span class="command">with</span></span> 2 <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">c</span></span><span class="main">)</span>
        <span class="main">(</span><span class="operator">auto</span> 
          <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invh_baldR_invc invc_baldR invc2_baldR mkNode_def 
          <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> neq_LeafD<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1" id="PST_RBT-invpst_baldR"><span class="command">lemma</span></span> invpst_baldR<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">l</span> <span class="main">⟹</span> invpst <span class="free">r</span> <span class="main">⟹</span> invpst <span class="main">(</span>baldR <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldR.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invpst_baliL<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invpst_baldL"><span class="command">lemma</span></span> invpst_baldL<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">l</span> <span class="main">⟹</span> invpst <span class="free">r</span> <span class="main">⟹</span> invpst <span class="main">(</span>baldL <span class="free">l</span> <span class="free">a</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">l</span><span class="main">,</span><span class="free">a</span><span class="main">,</span><span class="free">r</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> baldL.cases<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invpst_baliR<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invpst_combine"><span class="command">lemma</span></span> invpst_combine<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">l</span> <span class="main">⟹</span> invpst <span class="free">r</span> <span class="main">⟹</span> invpst <span class="main">(</span>combine <span class="free">l</span> <span class="free">r</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">l</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> combine.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> tree.splits tcolor.splits <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invpst_baldR invpst_baldL<span class="main">)</span>

<span class="keyword1" id="PST_RBT-invpst_del"><span class="command">lemma</span></span> invpst_del<span class="main">:</span> <span class="quoted"><span class="quoted">"invpst <span class="free">t</span> <span class="main">⟹</span> invpst <span class="main">(</span>del <span class="free">x</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span><span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">x</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> del.induct<span class="main">)</span>
  <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invpst_baldR invpst_baldL invpst_combine<span class="main">)</span>

<span class="keyword1"><span class="command">theorem</span></span> rbt_delete<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt <span class="free">t</span> <span class="main">⟹</span> rbt <span class="main">(</span>delete <span class="free">k</span> <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">clarsimp</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> delete_def rbt_def<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">frule</span> <span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> del_invc_invh<span class="main"><span class="main">[</span></span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> x<span class="main"><span class="main"><span class="main">=</span></span></span><span class="quoted"><span class="free"><span class="quoted"><span class="free">k</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> invc_paint_Black invh_paint color_paint_Black invpst_del<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1" id="PST_RBT-rbt_getmin_ismin"><span class="command">lemma</span></span> rbt_getmin_ismin<span class="main">:</span> 
  <span class="quoted"><span class="quoted">"rbt <span class="free">t</span> <span class="main">⟹</span> <span class="free">t</span><span class="main">≠</span>Leaf <span class="main">⟹</span> is_min2 <span class="main">(</span>pst_getmin <span class="free">t</span><span class="main">)</span> <span class="main">(</span>set_tree <span class="free">t</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">unfolding</span></span> rbt_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> pst_getmin_ismin<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">rbt_is_empty</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">≡</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> Leaf"</span></span>

<span class="keyword1" id="PST_RBT-rbt_is_empty"><span class="command">lemma</span></span> rbt_is_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"rbt_is_empty <span class="free">t</span> <span class="main">⟷</span> inorder <span class="free">t</span> <span class="main">=</span> <span class="main">[]</span>"</span></span>
<span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">t</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rbt_is_empty_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">empty</span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="free">empty</span> <span class="main">=</span> Leaf"</span></span>


<span class="keyword1"><span class="command">subsection</span></span> <span class="quoted"><span class="plain_text">‹Overall Correctness›</span></span>

<span class="keyword1"><span class="command">interpretation</span></span> PM<span class="main">:</span> PrioMap_by_Ordered
<span class="keyword2"><span class="keyword">where</span></span> empty <span class="main">=</span> <span class="quoted">empty</span> <span class="keyword2"><span class="keyword">and</span></span> lookup <span class="main">=</span> <span class="quoted">lookup</span> <span class="keyword2"><span class="keyword">and</span></span> update <span class="main">=</span> <span class="quoted">update</span> <span class="keyword2"><span class="keyword">and</span></span> delete <span class="main">=</span> <span class="quoted">delete</span>
<span class="keyword2"><span class="keyword">and</span></span> inorder <span class="main">=</span> <span class="quoted">inorder</span> <span class="keyword2"><span class="keyword">and</span></span> inv <span class="main">=</span> <span class="quoted"><span class="quoted">"rbt"</span></span> <span class="keyword2"><span class="keyword">and</span></span> is_empty <span class="main">=</span> <span class="quoted">rbt_is_empty</span> 
<span class="keyword2"><span class="keyword">and</span></span> getmin <span class="main">=</span> <span class="quoted">pst_getmin</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">standard</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> lookup_map_of inorder_update inorder_delete rbt_update 
                  rbt_delete rbt_Leaf rbt_is_empty empty_def 
            <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> rbt_getmin_ismin<span class="main">)</span>
<span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword2"><span class="keyword">end</span></span>
</pre>
</div>